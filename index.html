<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="nothing is anything">
<meta property="og:type" content="website">
<meta property="og:title" content="_010001SUTANG_">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="_010001SUTANG_">
<meta property="og:description" content="nothing is anything">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Su Tang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>_010001SUTANG_</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">_010001SUTANG_</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">To ancient evenings and distant music.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Su Tang</p>
  <div class="site-description" itemprop="description">nothing is anything</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/26/Datawhale%20AI%E7%A7%8B%E8%AE%AD%E8%90%A5-AI%E5%8A%A9%E6%95%99%E5%88%9B%E6%96%B0%E8%B5%9B%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/26/Datawhale%20AI%E7%A7%8B%E8%AE%AD%E8%90%A5-AI%E5%8A%A9%E6%95%99%E5%88%9B%E6%96%B0%E8%B5%9B%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" class="post-title-link" itemprop="url">AI助教创新赛学习心得</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-10-26 21:21:45 / Modified: 23:26:49" itemprop="dateCreated datePublished" datetime="2025-10-26T21:21:45+08:00">2025-10-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在完成 Task02 的学习后，我对“AI 辅助开发”这一范式有了更系统、更深入的理解。如果说 Task01 是一次“初尝甜头”的技术体验，那么 Task02 则是一场从“会用”到“用好”的思维跃迁。它让我意识到，真正决定一个 AI 应用成败的，并非模型本身有多强大，而是我们作为开发者能否精准地将用户需求转化为可执行的工程指令，并在产品、技术和交互之间建立高效的协同闭环。</p>
<hr>
<h3 id="一、角色转变：从“编码者”到“总工程师-产品经理”"><a href="#一、角色转变：从“编码者”到“总工程师-产品经理”" class="headerlink" title="一、角色转变：从“编码者”到“总工程师 + 产品经理”"></a>一、角色转变：从“编码者”到“总工程师 + 产品经理”</h3><p>过去，我习惯于将编程视为一种“精确控制”的过程——每一行代码都必须亲手敲下，每一个逻辑分支都必须严密推演。但在 AI 辅助开发的语境下，这种角色正在发生根本性转变：我不再是代码的“书写者”，而是需求的“定义者”、架构的“引导者”和体验的“把关人”。</p>
<p>正如教程中反复强调的：“我们是自己项目的总工程师和产品经理，AI 是我们的编程助理。” 这句话看似简单，实则蕴含了对开发范式的重新定义。AI 能力的边界固然重要，但更关键的是我们能否清晰表达意图、拆解任务、验证结果，并在迭代中不断逼近用户的真实痛点。</p>
<p>这一认知转变，正是 Task02 的核心知识点之一：<strong>AI 辅助开发的本质不是“替你做”，而是“帮你更快做对”</strong>。开发者需要具备产品视角（理解用户是谁、解决什么问题、如何衡量价值）与技术视角（理解数据流、技术栈、交互逻辑）的双重能力，才能有效引导 AI 完成高质量输出。</p>
<hr>
<h3 id="二、“三层积木”模型：构建轻量而完整的-AI-应用骨架"><a href="#二、“三层积木”模型：构建轻量而完整的-AI-应用骨架" class="headerlink" title="二、“三层积木”模型：构建轻量而完整的 AI 应用骨架"></a>二、“三层积木”模型：构建轻量而完整的 AI 应用骨架</h3><p>在实践中，我深刻体会到教程提出的“三层积木”模型的实用性——**界面层（HTML&#x2F;CSS）、功能层（JavaScript）、AI 连接层（Prompt + 模型调用）**共同构成了一个轻量但完整的 AI 应用骨架。</p>
<p>以我正在开发的乡土文化教育像素风文字冒险游戏为例：</p>
<ul>
<li><strong>界面层</strong>决定了乡村儿童是否愿意点开这个应用——按钮是否够大、色彩是否鲜明、交互是否直观；</li>
<li><strong>功能层</strong>负责将用户的输入（如“我想了解稻田”）转化为结构化请求，并调用 API 获取结果；</li>
<li><strong>AI 连接层</strong>则通过精心设计的 Prompt 和模型调用，生成融合语文、历史、地理知识的互动故事。</li>
</ul>
<p>这三层环环相扣，任何一层的薄弱都会导致整体体验的崩塌。例如，即便 AI 生成的内容再精彩，如果按钮太小、文字太密，乡村教师或学生可能根本无法顺利操作；反之，若 Prompt 设计模糊，AI 输出的内容就可能泛化、偏离教学目标，甚至产生幻觉。</p>
<hr>
<h3 id="三、Prompt-即-PRD：结构化需求表达决定工程效率"><a href="#三、Prompt-即-PRD：结构化需求表达决定工程效率" class="headerlink" title="三、Prompt 即 PRD：结构化需求表达决定工程效率"></a>三、Prompt 即 PRD：结构化需求表达决定工程效率</h3><p>Task02 中关于“Prompt 即 PRD”的观点尤其令我共鸣。过去我常把 Prompt 视为技术参数，但现在我更愿意将其看作产品需求文档的延伸。</p>
<p>一个优秀的 Prompt 应包含四个关键要素：</p>
<ul>
<li><strong>角色设定</strong>（如“你是一位熟悉江南水乡文化的乡村教师”）；</li>
<li><strong>任务目标</strong>（“围绕稻田、祠堂、龙舟生成跨学科故事”）；</li>
<li><strong>约束条件</strong>（“包含一道选择题，选项格式为 A&#x2F;B&#x2F;C&#x2F;D”）；</li>
<li><strong>输出规范</strong>（“用 JSON 格式返回题目和解析”）。</li>
</ul>
<p>这种结构化表达不仅提升了 AI 输出的稳定性，也大幅降低了前端解析的复杂度。在一次实践中，我发现 AI 生成的选择题无法被 JavaScript 正确解析，排查后发现问题并非出在代码逻辑，而是 Prompt 未明确要求结构化输出。当我将 Prompt 补充为“请严格按照以下 JSON Schema 输出……”后，问题迎刃而解。这让我深刻体会到：<strong>在 AI 开发中，需求描述的质量直接决定了工程实现的效率</strong>。</p>
<hr>
<h3 id="四、组合式创新：灵活调用多模型能力构建端到端流程"><a href="#四、组合式创新：灵活调用多模型能力构建端到端流程" class="headerlink" title="四、组合式创新：灵活调用多模型能力构建端到端流程"></a>四、组合式创新：灵活调用多模型能力构建端到端流程</h3><p>此外，教程中关于“模型选型”和“功能扩展”的案例也启发了我对技术灵活性的思考。例如，当我尝试用文生图模型生成“江南水乡”插图时，发现中文 Prompt 的效果远不如英文。于是，我采纳了教程建议，在调用图像生成模型前，<strong>先通过大语言模型将中文描述翻译为英文</strong>，再传给 Flux.1-Krea-dev 模型。</p>
<p>这一微小调整显著提升了图像的准确性与细节表现力。这背后反映的是一种“组合式创新”思维：我们不必受限于单一模型的能力边界，而是可以像搭积木一样，将多个 AI 能力（语言理解、翻译、图像生成）串联起来，构建更强大的端到端流程。这也呼应了教程中强调的“AI 功能 &#x3D; 业务规则 + AI 模型效果 + 数据流”这一公式。</p>
<hr>
<h3 id="五、体验驱动的优化：从“能用”到“爱用”"><a href="#五、体验驱动的优化：从“能用”到“爱用”" class="headerlink" title="五、体验驱动的优化：从“能用”到“爱用”"></a>五、体验驱动的优化：从“能用”到“爱用”</h3><p>更重要的是，Task02 让我重新审视了“优化”的本质。优化不是堆砌功能，而是围绕核心价值不断打磨体验。</p>
<p>我的游戏项目最初只支持静态故事生成，但在学习了“功能 → 操作 → 执行 → 输出”的结构化描述方法后，我尝试加入“答题反馈”和“积分激励”机制：当学生答对题目，AI 不仅给出解析，还会生成一句个性化的鼓励语（如“你对端午习俗的理解真到位！”），并触发像素风的金币动画。这种微小的正向反馈，极大提升了学习的沉浸感与成就感。</p>
<p>而这一切的实现，并不需要复杂的后端架构，仅通过前端 JavaScript 与大模型 API 的巧妙配合即可完成。这再次印证了教程中的观点：<strong>最终应用的效果 &#x3D; 交互体验 × AI 能力 × 功能广度</strong>。三者缺一不可。</p>
<hr>
<h3 id="六、人机协同的代码维护：审查、清理与迭代"><a href="#六、人机协同的代码维护：审查、清理与迭代" class="headerlink" title="六、人机协同的代码维护：审查、清理与迭代"></a>六、人机协同的代码维护：审查、清理与迭代</h3><p>当然，我也清醒地认识到 AI 辅助开发的局限。AI 生成的代码往往冗长、重复，甚至包含不必要的 try-catch 块。因此，定期进行代码审查和清理变得尤为重要。</p>
<p>我开始尝试使用 Qoder IDE 的行间对话功能，在特定代码段落旁直接提问：“这段逻辑能否简化？”、“是否存在内存泄漏风险？”，AI 会基于上下文给出重构建议。这种“人机协同”的代码维护方式，既保留了 AI 的创造力，又确保了工程的健壮性。这也呼应了教程中强调的“质量保障”原则：<strong>永远不要完全信任 AI 生成的代码，应将其视为有才华但需指导的初级开发者输出</strong>。</p>
<hr>
<p>总的来说，Task02 不仅教会我如何“用 AI 写代码”，更教会我如何“用产品思维驾驭 AI”。它让我明白，未来的开发者核心竞争力，将不再是语法熟练度，而是<strong>需求洞察力、系统架构力与人机协作力</strong>。</p>
<p>在接下来的开发中，我会继续以“总工程师 + 产品经理”的融合思维，推动我的乡土教育游戏从“能用”走向“好用”，最终实现“爱用”——让 AI 真正成为连接乡土文化与现代教育的桥梁，而非仅仅是一个炫技的工具。这不仅是技术的胜利，更是产品思维与人文关怀的融合。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/24/Agent-camel%E6%A1%86%E6%9E%B6%E7%BB%83%E4%B9%A0%EF%BC%884%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/24/Agent-camel%E6%A1%86%E6%9E%B6%E7%BB%83%E4%B9%A0%EF%BC%884%EF%BC%89/" class="post-title-link" itemprop="url">Agent-camel框架练习（4）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-24 21:40:59" itemprop="dateCreated datePublished" datetime="2025-07-24T21:40:59+08:00">2025-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-25 20:32:20" itemprop="dateModified" datetime="2025-07-25T20:32:20+08:00">2025-07-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E4%B8%BB%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">自主练习</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<h2 id="Task1"><a href="#Task1" class="headerlink" title="Task1"></a>Task1</h2><h3 id="通过调用API或本地部署reranker模型来快速将rerank模块集成到RAG应用中"><a href="#通过调用API或本地部署reranker模型来快速将rerank模块集成到RAG应用中" class="headerlink" title="通过调用API或本地部署reranker模型来快速将rerank模块集成到RAG应用中"></a>通过调用API或本地部署reranker模型来快速将rerank模块集成到RAG应用中</h3><p><a target="_blank" rel="noopener" href="https://github.com/camel-ai/camel/blob/master/camel/retrievers/cohere_rerank_retriever.py">https://github.com/camel-ai/camel/blob/master/camel/retrievers/cohere_rerank_retriever.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">精简版Reranker系统：在CAMEL框架下集成模拟的外部Reranker模型</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该脚本旨在清晰地展示如何将一个独立的Reranker模块（通过模拟外部API或本地部署模型）</span></span><br><span class="line"><span class="string">集成到RAG应用中，以实现文档重排。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入CAMEL框架核心模块</span></span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> VectorRetriever</span><br><span class="line"><span class="keyword">from</span> camel.storages.vectordb_storages <span class="keyword">import</span> QdrantStorage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入环境变量模块</span></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MinimalRerankerSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    精简版Reranker系统类</span></span><br><span class="line"><span class="string">    包含知识库设置、模拟的外部Reranker和答案生成的核心功能</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化精简版Reranker系统</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            api_key: ModelScope API密钥</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.api_key = api_key</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化嵌入模型 (用于向量检索，Reranker本身不直接使用)</span></span><br><span class="line">        <span class="variable language_">self</span>.embedding_model = SentenceTransformerEncoder(</span><br><span class="line">            model_name=<span class="string">&#x27;intfloat/e5-large-v2&#x27;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化向量存储 (用于演示文档检索，以便Reranker有文档可重排)</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_storage = QdrantStorage(</span><br><span class="line">            vector_dim=<span class="variable language_">self</span>.embedding_model.get_output_dim(),</span><br><span class="line">            collection=<span class="string">&quot;minimal_reranker_collection&quot;</span>,</span><br><span class="line">            path=<span class="string">&quot;storage_minimal_reranker&quot;</span>,</span><br><span class="line">            collection_name=<span class="string">&quot;精简重排知识库&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化向量检索器</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_retriever = VectorRetriever(</span><br><span class="line">            embedding_model=<span class="variable language_">self</span>.embedding_model,</span><br><span class="line">            storage=<span class="variable language_">self</span>.vector_storage</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化LLM模型 (仅用于答案生成)</span></span><br><span class="line">        <span class="variable language_">self</span>.model = ModelFactory.create(</span><br><span class="line">            model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">            model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">            url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">            api_key=<span class="variable language_">self</span>.api_key</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化RAG答案生成代理</span></span><br><span class="line">        <span class="variable language_">self</span>._init_agents()</span><br><span class="line">        <span class="variable language_">self</span>.knowledge_base_ready = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_agents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化RAG答案生成代理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># RAG回答生成代理</span></span><br><span class="line">        rag_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个帮助回答问题的助手。</span></span><br><span class="line"><span class="string">        我会给你原始查询和检索到的上下文信息。</span></span><br><span class="line"><span class="string">        请根据检索到的上下文回答原始查询。</span></span><br><span class="line"><span class="string">        如果上下文信息不足以回答问题，请说&quot;根据提供的信息，我无法完全回答这个问题&quot;。</span></span><br><span class="line"><span class="string">        请确保回答准确、完整且有条理。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.rag_agent = ChatAgent(</span><br><span class="line">            system_message=rag_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_knowledge_base</span>(<span class="params">self, pdf_url: <span class="built_in">str</span> = <span class="literal">None</span>, pdf_path: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        设置知识库，用于提供待重排的文档</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            pdf_url: PDF文件的URL</span></span><br><span class="line"><span class="string">            pdf_path: 本地PDF文件路径</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        os.makedirs(<span class="string">&#x27;local_data&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pdf_url:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在下载PDF文件...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = requests.get(pdf_url, timeout=<span class="number">30</span>)</span><br><span class="line">                response.raise_for_status()</span><br><span class="line">                pdf_path = <span class="string">&#x27;local_data/knowledge_base.pdf&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(pdf_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                    file.write(response.content)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ PDF文件已下载到: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;PDF下载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pdf_path:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pdf_path):</span><br><span class="line">                <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;PDF文件不存在: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在处理PDF文件并建立向量数据库...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.vector_retriever.process(content=pdf_path)</span><br><span class="line">                <span class="variable language_">self</span>.knowledge_base_ready = <span class="literal">True</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;知识库设置完成！&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;知识库设置失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;必须提供 pdf_url 或 pdf_path 参数&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_documents</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        从知识库中检索初步文档</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k: 返回的文档数量</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            初步检索到的文档列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.knowledge_base_ready:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;知识库未准备好，无法检索文档。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;正在初步检索文档 (Top-<span class="subst">&#123;top_k&#125;</span>)...&quot;</span>)</span><br><span class="line">        retrieved_docs = <span class="variable language_">self</span>.vector_retriever.query(query=query, top_k=top_k)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✓ 初步检索到 <span class="subst">&#123;<span class="built_in">len</span>(retrieved_docs)&#125;</span> 个文档。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> retrieved_docs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_external_rerank</span>(<span class="params">self, query: <span class="built_in">str</span>, documents: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        模拟外部Reranker模型对文档进行重排。</span></span><br><span class="line"><span class="string">        此函数模拟了调用外部API或本地部署的Reranker模型。</span></span><br><span class="line"><span class="string">        这里使用简单的关键词匹配作为模拟的重排逻辑。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            documents: 待重排的文档列表，每个文档字典包含 &#x27;text&#x27; 键</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            根据模拟的外部Reranker重排后的文档列表，每个文档会添加 &#x27;relevance_score&#x27; 字段。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> documents:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;没有文档可供重排，跳过外部Reranker。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在使用模拟的外部Reranker进行文档重排...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将查询分割成关键词（这里简单地按空格分割，实际Reranker会进行更复杂的处理）</span></span><br><span class="line">        query_keywords = <span class="built_in">set</span>(query.lower().split())</span><br><span class="line"></span><br><span class="line">        scored_documents = []</span><br><span class="line">        <span class="keyword">for</span> doc <span class="keyword">in</span> documents:</span><br><span class="line">            doc_text_lower = doc[<span class="string">&#x27;text&#x27;</span>].lower()</span><br><span class="line">            <span class="comment"># 模拟计算相关性分数：文档中包含的查询关键词越多，分数越高</span></span><br><span class="line">            relevance_score = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> keyword <span class="keyword">in</span> query_keywords <span class="keyword">if</span> keyword <span class="keyword">in</span> doc_text_lower)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 也可以添加一些随机性来模拟真实模型的复杂性</span></span><br><span class="line">            <span class="comment"># import random</span></span><br><span class="line">            <span class="comment"># relevance_score += random.uniform(0, 0.1) </span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将分数添加到文档字典中</span></span><br><span class="line">            doc_with_score = doc.copy()</span><br><span class="line">            doc_with_score[<span class="string">&#x27;relevance_score&#x27;</span>] = relevance_score</span><br><span class="line">            scored_documents.append(doc_with_score)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据相关性分数降序排序</span></span><br><span class="line">        reranked_documents = <span class="built_in">sorted</span>(scored_documents, key=<span class="keyword">lambda</span> x: x.get(<span class="string">&#x27;relevance_score&#x27;</span>, <span class="number">0</span>), reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✓ 模拟外部Reranker重排完成。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> reranked_documents</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_answer</span>(<span class="params">self, query: <span class="built_in">str</span>, retrieved_docs: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于检索到的文档生成答案</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            retrieved_docs: 检索到的文档列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            生成的答案</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> retrieved_docs:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;根据提供的信息，我无法完全回答这个问题。&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建上下文</span></span><br><span class="line">        context = <span class="string">&quot;\n\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建提示</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        原始查询: <span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        检索到的上下文信息:</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请根据上述上下文信息回答原始查询。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n正在生成答案...&quot;</span>)</span><br><span class="line">        response = <span class="variable language_">self</span>.rag_agent.step(prompt)</span><br><span class="line">        answer = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✓ 答案生成完成。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_reranker_pipeline</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k_initial: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        运行重排器管道：初步检索 -&gt; 外部Reranker重排 -&gt; 答案生成</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k_initial: 初步检索的文档数量</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            包含初步文档、重排文档和最终答案的字典</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;开始运行Reranker管道，查询: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤1: 初步检索文档</span></span><br><span class="line">        initial_retrieved_docs = <span class="variable language_">self</span>.retrieve_documents(query, top_k_initial)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤2: 外部Reranker重排文档</span></span><br><span class="line">        reranked_docs = <span class="variable language_">self</span>.perform_external_rerank(query, initial_retrieved_docs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤3: 基于重排后的文档生成答案</span></span><br><span class="line">        final_answer = <span class="variable language_">self</span>.generate_answer(query, reranked_docs)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Reranker管道执行完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: query,</span><br><span class="line">            <span class="string">&quot;initial_retrieved_docs&quot;</span>: initial_retrieved_docs,</span><br><span class="line">            <span class="string">&quot;reranked_docs&quot;</span>: reranked_docs,</span><br><span class="line">            <span class="string">&quot;final_answer&quot;</span>: final_answer</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数：演示精简版Reranker系统的使用&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载环境变量</span></span><br><span class="line">    load_dotenv()</span><br><span class="line">    api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> api_key:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;错误：请设置MODELSCOPE_SDK_TOKEN环境变量&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请在.env文件中添加 MODELSCOPE_SDK_TOKEN=你的API密钥&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化Reranker系统</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;正在初始化Reranker系统...&quot;</span>)</span><br><span class="line">    reranker_system = MinimalRerankerSystem(api_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;系统初始化完成！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置知识库 (使用CAMEL论文作为示例)</span></span><br><span class="line">    pdf_url = <span class="string">&quot;https://arxiv.org/pdf/2303.17760.pdf&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n正在设置知识库（使用默认CAMEL论文: <span class="subst">&#123;pdf_url&#125;</span>）...&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        reranker_system.setup_knowledge_base(pdf_url=pdf_url)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;知识库设置失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 运行交互式会话</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        query = <span class="built_in">input</span>(<span class="string">&quot;\n请输入您的查询（输入&#x27;quit&#x27;退出）: &quot;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> query.lower() <span class="keyword">in</span> [<span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;退出&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;感谢使用！再见！&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> query:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;查询不能为空，请重新输入。&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            results = reranker_system.run_reranker_pipeline(query, top_k_initial=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- 原始检索结果 (Top 5) ---&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> results[<span class="string">&#x27;initial_retrieved_docs&#x27;</span>]:</span><br><span class="line">                <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(results[<span class="string">&#x27;initial_retrieved_docs&#x27;</span>]):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;doc[<span class="string">&#x27;text&#x27;</span>][:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;无原始检索文档。&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- 外部Reranker重排后的结果 ---&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> results[<span class="string">&#x27;reranked_docs&#x27;</span>]:</span><br><span class="line">                <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(results[<span class="string">&#x27;reranked_docs&#x27;</span>]):</span><br><span class="line">                    <span class="comment"># 显示模拟的相关性分数</span></span><br><span class="line">                    score_info = <span class="string">f&quot; (相关性分数: <span class="subst">&#123;doc.get(<span class="string">&#x27;relevance_score&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>):<span class="number">.2</span>f&#125;</span>)&quot;</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span><span class="subst">&#123;score_info&#125;</span>: <span class="subst">&#123;doc[<span class="string">&#x27;text&#x27;</span>][:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;无重排文档。&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- 最终答案 ---&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(results[<span class="string">&#x27;final_answer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc() <span class="comment"># 打印详细错误信息</span></span><br><span class="line">            continue_choice = <span class="built_in">input</span>(<span class="string">&quot;是否继续？(y/n): &quot;</span>).strip().lower()</span><br><span class="line">            <span class="keyword">if</span> continue_choice != <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们可以运行看一下重排效果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/Reranker_lite.py  </span><br><span class="line">正在初始化Reranker系统...</span><br><span class="line">W0724 23:07:45.865000 37864 site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported in Windows or MacOs.   </span><br><span class="line">系统初始化完成！</span><br><span class="line"></span><br><span class="line">正在设置知识库（使用默认CAMEL论文: https://arxiv.org/pdf/2303.17760.pdf）...     </span><br><span class="line">正在下载PDF文件...</span><br><span class="line">✓ PDF文件已下载到: local_data/knowledge_base.pdf</span><br><span class="line">正在处理PDF文件并建立向量数据库...</span><br><span class="line">知识库设置完成！</span><br><span class="line"></span><br><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）: camel是什么？      </span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">开始运行Reranker管道，查询: camel是什么？</span><br><span class="line">============================================================</span><br><span class="line">正在初步检索文档 (Top-5)...</span><br><span class="line">✓ 初步检索到 5 个文档。</span><br><span class="line">正在使用模拟的外部Reranker进行文档重排...</span><br><span class="line">✓ 模拟外部Reranker重排完成。</span><br><span class="line"></span><br><span class="line">正在生成答案...</span><br><span class="line">✓ 答案生成完成。</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">Reranker管道执行完成！</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">--- 原始检索结果 (Top 5) ---</span><br><span class="line">文档 1: 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 2: 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 3: me instructions and necessary inputs until you think the task is completed. When the task is completed, you must only reply with a single word &lt;CAMEL_...       </span><br><span class="line">文档 4: me instructions and necessary inputs until you think the task is completed. When the task is completed, you must only reply with a single word &lt;CAMEL_...       </span><br><span class="line">文档 5: Human Evaluation Guideline</span><br><span class="line"></span><br><span class="line">Thank you for participating in our task evaluation! We are comparing the performance of ChatGPT and a method called CAMEL ...</span><br><span class="line"></span><br><span class="line">--- 外部Reranker重排后的结果 ---</span><br><span class="line">文档 1 (相关性分数: 0.00): 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 2 (相关性分数: 0.00): 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 3 (相关性分数: 0.00): me instructions and necessary inputs until you think the task is completed. When the task is completed, you must only reply with a single word &lt;CAMEL_...</span><br><span class="line">文档 4 (相关性分数: 0.00): me instructions and necessary inputs until you think the task is completed. When the task is completed, you must only reply with a single word &lt;CAMEL_...</span><br><span class="line">文档 5 (相关性分数: 0.00): Human Evaluation Guideline</span><br><span class="line"></span><br><span class="line">Thank you for participating in our task evaluation! We are comparing the performance of ChatGPT and a method called CAMEL ...</span><br><span class="line"></span><br><span class="line">--- 最终答案 ---</span><br><span class="line">根据提供的信息，CAMEL（Communicative Agents for “Mind” Exploration of Large Language Model Society）是一种用于探索大型语言模型社会“心智”的交流代理系统。这个项目由沙特阿拉伯国王科技大学（KAUST）的研究人员开发，旨在通过交流代理来研究和理解大型语言模型之 间的互动和社会动态。更多详情可以参考该项目的官方网站：https://www.camel-ai.org。    </span><br><span class="line"></span><br><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）: quit</span><br><span class="line">感谢使用！再见！</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Task2"><a href="#Task2" class="headerlink" title="Task2"></a>Task2</h2><h3 id="使用大语言模型和简单的提示词工程在CAMEL框架下实现一个ReRanker，达成重排的效果（灵感来自CAMEL-Shanghai-Hackathon韬子哥QAQ）"><a href="#使用大语言模型和简单的提示词工程在CAMEL框架下实现一个ReRanker，达成重排的效果（灵感来自CAMEL-Shanghai-Hackathon韬子哥QAQ）" class="headerlink" title="使用大语言模型和简单的提示词工程在CAMEL框架下实现一个ReRanker，达成重排的效果（灵感来自CAMEL Shanghai Hackathon韬子哥QAQ）"></a>使用大语言模型和简单的提示词工程在CAMEL框架下实现一个ReRanker，达成重排的效果（灵感来自CAMEL Shanghai Hackathon韬子哥QAQ）</h3><p><a target="_blank" rel="noopener" href="https://github.com/fengju0213/NavigatorAI/blob/main/2Travel_information_generation.py">https://github.com/fengju0213/NavigatorAI/blob/main/2Travel_information_generation.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">LLM ReRanker：在CAMEL框架下实现基于大语言模型的文档重排</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该脚本旨在清晰地展示如何使用CAMEL框架和简单的提示词工程实现文档重排。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入CAMEL框架核心模块</span></span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> VectorRetriever</span><br><span class="line"><span class="keyword">from</span> camel.storages.vectordb_storages <span class="keyword">import</span> QdrantStorage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入环境变量模块</span></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MinimalLLMReranker</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    LLM ReRanker系统类</span></span><br><span class="line"><span class="string">    仅包含知识库设置、LLM ReRanker和答案生成的核心功能</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化LLM ReRanker系统</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            api_key: ModelScope API密钥</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.api_key = api_key</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化嵌入模型 (用于向量检索，ReRanker本身不直接使用)</span></span><br><span class="line">        <span class="variable language_">self</span>.embedding_model = SentenceTransformerEncoder(</span><br><span class="line">            model_name=<span class="string">&#x27;intfloat/e5-large-v2&#x27;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化向量存储 (用于演示文档检索，以便ReRanker有文档可重排)</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_storage = QdrantStorage(</span><br><span class="line">            vector_dim=<span class="variable language_">self</span>.embedding_model.get_output_dim(),</span><br><span class="line">            collection=<span class="string">&quot;minimal_reranker_collection&quot;</span>,</span><br><span class="line">            path=<span class="string">&quot;storage_minimal_reranker&quot;</span>,</span><br><span class="line">            collection_name=<span class="string">&quot;精简重排知识库&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化向量检索器</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_retriever = VectorRetriever(</span><br><span class="line">            embedding_model=<span class="variable language_">self</span>.embedding_model,</span><br><span class="line">            storage=<span class="variable language_">self</span>.vector_storage</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化LLM模型 (用于ReRanker和答案生成)</span></span><br><span class="line">        <span class="variable language_">self</span>.model = ModelFactory.create(</span><br><span class="line">            model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">            model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">            url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">            api_key=<span class="variable language_">self</span>.api_key</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化LLM ReRanker代理和RAG答案生成代理</span></span><br><span class="line">        <span class="variable language_">self</span>._init_agents()</span><br><span class="line">        <span class="variable language_">self</span>.knowledge_base_ready = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_agents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化LLM ReRanker代理和RAG答案生成代理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># LLM ReRanker 代理</span></span><br><span class="line">        <span class="comment"># 提示词工程：明确要求输出格式为逗号分隔的数字序列，不含额外文字</span></span><br><span class="line">        reranker_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个文档重排助手。你的任务是根据用户查询，对提供的文档列表进行相关性排序。</span></span><br><span class="line"><span class="string">        你会接收一个用户查询和多个文档，每个文档都有一个编号。</span></span><br><span class="line"><span class="string">        请你根据文档与查询的深层相关性，从最相关到最不相关，输出文档的编号序列。</span></span><br><span class="line"><span class="string">        输出格式必须是逗号分隔的数字，例如：1, 3, 2, 4。</span></span><br><span class="line"><span class="string">        不要包含任何其他文字或解释。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.reranker_agent = ChatAgent(</span><br><span class="line">            system_message=reranker_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># RAG回答生成代理</span></span><br><span class="line">        rag_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个帮助回答问题的助手。</span></span><br><span class="line"><span class="string">        我会给你原始查询和检索到的上下文信息。</span></span><br><span class="line"><span class="string">        请根据检索到的上下文回答原始查询。</span></span><br><span class="line"><span class="string">        如果上下文信息不足以回答问题，请说&quot;根据提供的信息，我无法完全回答这个问题&quot;。</span></span><br><span class="line"><span class="string">        请确保回答准确、完整且有条理。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.rag_agent = ChatAgent(</span><br><span class="line">            system_message=rag_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_knowledge_base</span>(<span class="params">self, pdf_url: <span class="built_in">str</span> = <span class="literal">None</span>, pdf_path: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        设置知识库，用于提供待重排的文档</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            pdf_url: PDF文件的URL</span></span><br><span class="line"><span class="string">            pdf_path: 本地PDF文件路径</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        os.makedirs(<span class="string">&#x27;local_data&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pdf_url:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在下载PDF文件...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = requests.get(pdf_url, timeout=<span class="number">30</span>)</span><br><span class="line">                response.raise_for_status()</span><br><span class="line">                pdf_path = <span class="string">&#x27;local_data/knowledge_base.pdf&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(pdf_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                    file.write(response.content)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ PDF文件已下载到: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;PDF下载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pdf_path:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pdf_path):</span><br><span class="line">                <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;PDF文件不存在: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在处理PDF文件并建立向量数据库...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.vector_retriever.process(content=pdf_path)</span><br><span class="line">                <span class="variable language_">self</span>.knowledge_base_ready = <span class="literal">True</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;知识库设置完成！&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;知识库设置失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;必须提供 pdf_url 或 pdf_path 参数&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_documents</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        从知识库中检索初步文档</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k: 返回的文档数量</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            初步检索到的文档列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.knowledge_base_ready:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;知识库未准备好，无法检索文档。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;正在初步检索文档 (Top-<span class="subst">&#123;top_k&#125;</span>)...&quot;</span>)</span><br><span class="line">        retrieved_docs = <span class="variable language_">self</span>.vector_retriever.query(query=query, top_k=top_k)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✓ 初步检索到 <span class="subst">&#123;<span class="built_in">len</span>(retrieved_docs)&#125;</span> 个文档。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> retrieved_docs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rerank_documents</span>(<span class="params">self, query: <span class="built_in">str</span>, documents: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用LLM对文档进行重排</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            documents: 待重排的文档列表，每个文档字典包含 &#x27;text&#x27; 键</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            根据LLM重排后的文档列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> documents:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;没有文档可供重排，跳过LLM重排。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在使用LLM进行文档重排...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建发送给LLM的提示</span></span><br><span class="line">        prompt_parts = [<span class="string">f&quot;用户查询: <span class="subst">&#123;query&#125;</span>\n\n以下是需要重排的文档列表：&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents):</span><br><span class="line">            <span class="comment"># 限制文档内容长度，避免超出LLM上下文窗口</span></span><br><span class="line">            truncated_text = doc[<span class="string">&#x27;text&#x27;</span>][:<span class="number">500</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(doc[<span class="string">&#x27;text&#x27;</span>]) &gt; <span class="number">500</span> <span class="keyword">else</span> doc[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line">            prompt_parts.append(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>:\n<span class="subst">&#123;truncated_text&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        prompt_parts.append(<span class="string">&quot;\n请根据文档与查询的相关性，从最相关到最不相关，输出文档的编号序列。输出格式必须是逗号分隔的数字，例如：1, 3, 2, 4。不要包含任何其他文字或解释。&quot;</span>)</span><br><span class="line">        rerank_prompt = <span class="string">&quot;\n&quot;</span>.join(prompt_parts)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = <span class="variable language_">self</span>.reranker_agent.step(rerank_prompt)</span><br><span class="line">            reranked_order_str = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 解析LLM的输出，获取排序后的文档索引</span></span><br><span class="line">            <span class="comment"># 使用正则表达式匹配数字和逗号，确保只提取数字序列</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(<span class="string">r&#x27;^\s*(\d+(?:\s*,\s*\d+)*)\s*$&#x27;</span>, reranked_order_str)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                ordered_indices = [<span class="built_in">int</span>(idx.strip()) - <span class="number">1</span> <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="keyword">match</span>.group(<span class="number">1</span>).split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 过滤掉无效的索引（超出文档列表范围的）</span></span><br><span class="line">                valid_ordered_indices = [idx <span class="keyword">for</span> idx <span class="keyword">in</span> ordered_indices <span class="keyword">if</span> <span class="number">0</span> &lt;= idx &lt; <span class="built_in">len</span>(documents)]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 根据LLM返回的顺序重排文档</span></span><br><span class="line">                reranked_documents = [documents[i] <span class="keyword">for</span> i <span class="keyword">in</span> valid_ordered_indices]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 如果LLM返回的文档数量少于原始文档数量，将未被LLM排序的文档按原顺序追加到末尾</span></span><br><span class="line">                original_indices = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(documents)))</span><br><span class="line">                llm_sorted_indices = <span class="built_in">set</span>(valid_ordered_indices)</span><br><span class="line">                remaining_indices = <span class="built_in">sorted</span>(<span class="built_in">list</span>(original_indices - llm_sorted_indices))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> idx <span class="keyword">in</span> remaining_indices:</span><br><span class="line">                    reranked_documents.append(documents[idx])</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ LLM重排完成。新顺序: <span class="subst">&#123;[idx + <span class="number">1</span> <span class="keyword">for</span> idx <span class="keyword">in</span> valid_ordered_indices]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> reranked_documents</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;LLM重排输出格式不正确，无法解析。原始输出: &#x27;<span class="subst">&#123;reranked_order_str&#125;</span>&#x27;。将返回原始文档顺序。&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> documents <span class="comment"># 返回原始文档顺序</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;LLM重排失败: <span class="subst">&#123;e&#125;</span>。将返回原始文档顺序。&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> documents <span class="comment"># 发生错误时返回原始文档顺序</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_answer</span>(<span class="params">self, query: <span class="built_in">str</span>, retrieved_docs: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于检索到的文档生成答案</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            retrieved_docs: 检索到的文档列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            生成的答案</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> retrieved_docs:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;根据提供的信息，我无法完全回答这个问题。&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建上下文</span></span><br><span class="line">        context = <span class="string">&quot;\n\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建提示</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        原始查询: <span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        检索到的上下文信息:</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请根据上述上下文信息回答原始查询。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n正在生成答案...&quot;</span>)</span><br><span class="line">        response = <span class="variable language_">self</span>.rag_agent.step(prompt)</span><br><span class="line">        answer = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✓ 答案生成完成。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_reranker_pipeline</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k_initial: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        运行重排器管道：初步检索 -&gt; LLM重排 -&gt; 答案生成</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k_initial: 初步检索的文档数量</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            包含初步文档、重排文档和最终答案的字典</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;开始运行LLM重排管道，查询: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤1: 初步检索文档</span></span><br><span class="line">        initial_retrieved_docs = <span class="variable language_">self</span>.retrieve_documents(query, top_k_initial)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤2: LLM重排文档</span></span><br><span class="line">        reranked_docs = <span class="variable language_">self</span>.rerank_documents(query, initial_retrieved_docs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤3: 基于重排后的文档生成答案</span></span><br><span class="line">        final_answer = <span class="variable language_">self</span>.generate_answer(query, reranked_docs)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;LLM重排管道执行完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: query,</span><br><span class="line">            <span class="string">&quot;initial_retrieved_docs&quot;</span>: initial_retrieved_docs,</span><br><span class="line">            <span class="string">&quot;reranked_docs&quot;</span>: reranked_docs,</span><br><span class="line">            <span class="string">&quot;final_answer&quot;</span>: final_answer</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数：演示精简版LLM ReRanker系统的使用&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载环境变量</span></span><br><span class="line">    load_dotenv()</span><br><span class="line">    api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> api_key:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;错误：请设置MODELSCOPE_SDK_TOKEN环境变量&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请在.env文件中添加 MODELSCOPE_SDK_TOKEN=你的API密钥&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化LLM ReRanker系统</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;正在初始化LLM ReRanker系统...&quot;</span>)</span><br><span class="line">    reranker_system = MinimalLLMReranker(api_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;系统初始化完成！&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置知识库 (使用CAMEL论文作为示例)</span></span><br><span class="line">    pdf_url = <span class="string">&quot;https://arxiv.org/pdf/2303.17760.pdf&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n正在设置知识库（使用默认CAMEL论文: <span class="subst">&#123;pdf_url&#125;</span>）...&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        reranker_system.setup_knowledge_base(pdf_url=pdf_url)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;知识库设置失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 运行交互式会话</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        query = <span class="built_in">input</span>(<span class="string">&quot;\n请输入您的查询（输入&#x27;quit&#x27;退出）: &quot;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> query.lower() <span class="keyword">in</span> [<span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;退出&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;感谢使用！再见！&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> query:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;查询不能为空，请重新输入。&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            results = reranker_system.run_reranker_pipeline(query, top_k_initial=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- 原始检索结果 (Top 5) ---&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> results[<span class="string">&#x27;initial_retrieved_docs&#x27;</span>]:</span><br><span class="line">                <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(results[<span class="string">&#x27;initial_retrieved_docs&#x27;</span>]):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;doc[<span class="string">&#x27;text&#x27;</span>][:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;无原始检索文档。&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- LLM重排后的结果 ---&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> results[<span class="string">&#x27;reranked_docs&#x27;</span>]:</span><br><span class="line">                <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(results[<span class="string">&#x27;reranked_docs&#x27;</span>]):</span><br><span class="line">                    <span class="comment"># 尝试获取RRF分数或相似度，如果存在的话</span></span><br><span class="line">                    score_info = <span class="string">f&quot; (RRF分数: <span class="subst">&#123;doc[<span class="string">&#x27;rrf_score&#x27;</span>]:<span class="number">.4</span>f&#125;</span>)&quot;</span> <span class="keyword">if</span> <span class="string">&#x27;rrf_score&#x27;</span> <span class="keyword">in</span> doc <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">                    score_info = <span class="string">f&quot; (相似度: <span class="subst">&#123;doc[<span class="string">&#x27;similarity&#x27;</span>]:<span class="number">.4</span>f&#125;</span>)&quot;</span> <span class="keyword">if</span> <span class="string">&#x27;similarity&#x27;</span> <span class="keyword">in</span> doc <span class="keyword">else</span> score_info</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span><span class="subst">&#123;score_info&#125;</span>: <span class="subst">&#123;doc[<span class="string">&#x27;text&#x27;</span>][:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;无重排文档。&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n--- 最终答案 ---&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(results[<span class="string">&#x27;final_answer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc() <span class="comment"># 打印详细错误信息</span></span><br><span class="line">            continue_choice = <span class="built_in">input</span>(<span class="string">&quot;是否继续？(y/n): &quot;</span>).strip().lower()</span><br><span class="line">            <span class="keyword">if</span> continue_choice != <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行效果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; python Reranker_simple.py</span><br><span class="line">正在初始化LLM ReRanker系统...</span><br><span class="line">W0724 21:56:33.691000 38432 site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported in Windows or MacOs.   </span><br><span class="line">系统初始化完成！</span><br><span class="line"></span><br><span class="line">正在设置知识库（使用默认CAMEL论文: https://arxiv.org/pdf/2303.17760.pdf）...        </span><br><span class="line">正在下载PDF文件...</span><br><span class="line">✓ PDF文件已下载到: local_data/knowledge_base.pdf</span><br><span class="line">正在处理PDF文件并建立向量数据库...</span><br><span class="line">知识库设置完成！</span><br><span class="line"></span><br><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）:</span><br></pre></td></tr></table></figure>
<p>此时我们可以输入我们想要检索的内容，因为测试的PDF文件仍为CAMEL论文官方线上文件，所以我们直接问与CAMEL相关的：“camel是什么？对于我AI学习有什么帮助？”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）:camel是什么？对于我AI学习有什么帮助？</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">开始运行LLM重排管道，查询: camel是什么？对于我AI学习有什么帮助？</span><br><span class="line">============================================================</span><br><span class="line">正在初步检索文档 (Top-5)...</span><br><span class="line">✓ 初步检索到 5 个文档。</span><br><span class="line">正在使用LLM进行文档重排...</span><br><span class="line">✓ LLM重排完成。新顺序: [5, 3, 4, 2, 1]</span><br><span class="line"></span><br><span class="line">正在生成答案...</span><br><span class="line">✓ 答案生成完成。</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">LLM重排管道执行完成！</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">--- 原始检索结果 (Top 5) ---</span><br><span class="line">文档 1: Human Evaluation Guideline</span><br><span class="line"></span><br><span class="line">Thank you for participating in our task evaluation! We are comparing the performance of ChatGPT and a method called CAMEL ...</span><br><span class="line">文档 2: Objective: Your task is to compare two messages, one generated by CAMEL and the other by ChatGPT. These messages will be displayed anonymously on your...       </span><br><span class="line">文档 3: 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 4: Feedback: We highly value your feedback. If you have any suggestions, concerns, or encounter any technical issues during the evaluation, please feel f...       </span><br><span class="line">文档 5: agent is asked to draw all the Camelidae species. It first reasons about what animals are included in the Camelidae family and then generates and save...       </span><br><span class="line"></span><br><span class="line">--- LLM重排后的结果 ---</span><br><span class="line">文档 1: agent is asked to draw all the Camelidae species. It first reasons about what animals are included in the Camelidae family and then generates and save...       </span><br><span class="line">文档 2: 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 3: Feedback: We highly value your feedback. If you have any suggestions, concerns, or encounter any technical issues during the evaluation, please feel f...       </span><br><span class="line">文档 4: Objective: Your task is to compare two messages, one generated by CAMEL and the other by ChatGPT. These messages will be displayed anonymously on your...       </span><br><span class="line">文档 5: Human Evaluation Guideline</span><br><span class="line"></span><br><span class="line">Thank you for participating in our task evaluation! We are comparing the performance of ChatGPT and a method called CAMEL ...</span><br><span class="line"></span><br><span class="line">--- 最终答案 ---</span><br><span class="line">根据提供的信息，&quot;camel&quot;在这里有两个不同的含义：</span><br><span class="line"></span><br><span class="line">1. **生物学上的驼科（Camelidae）**：这是指一类哺乳动物，包括骆驼、羊驼等。然而，这个定义与您的AI学习没有直接关系。</span><br><span class="line"></span><br><span class="line">2. **CAMEL项目**：这是一个名为“Communicative Agents for ‘Mind’ Exploration of Large Language Model Society”的研究项目，由沙特阿拉伯阿卜杜拉国王科技大学（KAUST）的研究人员开发。CAMEL项目的目的是通过创建交互式代理来探索大型语言模型的社会“心智”。这些代理 可以生成图像、进行任务比较和评估，并通过用户反馈不断改进。</span><br><span class="line"></span><br><span class="line">### 对于AI学习的帮助：</span><br><span class="line">- **理解大型语言模型**：CAMEL项目可以帮助你更好地理解大型语言模型的工作原理和能力。 </span><br><span class="line">- **实践应用**：通过参与CAMEL项目，你可以实际操作和评估不同AI系统的性能，从而提升你 的实践技能。</span><br><span class="line">- **研究贡献**：你的反馈和参与可以为AI研究提供有价值的数据，推动AI技术的发展。      </span><br><span class="line"></span><br><span class="line">如果你对生物学上的驼科更感兴趣，建议查阅相关的生物学资料。如果你对AI学习更感兴趣，可以进一步了解CAMEL项目并参与其中。</span><br><span class="line"></span><br><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）:</span><br></pre></td></tr></table></figure>
<p>此时第一轮检索生成已经完成，代理自动进入第二个问题查询。我们继续输入我们的问题：“camel具备哪些特性？”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）:camel具备哪些特性？            </span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">开始运行LLM重排管道，查询: camel具备哪些特性？</span><br><span class="line">============================================================</span><br><span class="line">正在初步检索文档 (Top-5)...</span><br><span class="line">✓ 初步检索到 5 个文档。</span><br><span class="line">正在使用LLM进行文档重排...</span><br><span class="line">✓ LLM重排完成。新顺序: [1, 2, 3, 4, 5]</span><br><span class="line"></span><br><span class="line">正在生成答案...</span><br><span class="line">✓ 答案生成完成。</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">LLM重排管道执行完成！</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">--- 原始检索结果 (Top 5) ---</span><br><span class="line">文档 1: 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 2: me instructions and necessary inputs until you think the task is completed. When the task is completed, you must only reply with a single word &lt;CAMEL_...       </span><br><span class="line">文档 3: Human Evaluation Guideline</span><br><span class="line"></span><br><span class="line">Thank you for participating in our task evaluation! We are comparing the performance of ChatGPT and a method called CAMEL ...</span><br><span class="line">文档 4: Objective: Your task is to compare two messages, one generated by CAMEL and the other by ChatGPT. These messages will be displayed anonymously on your...       </span><br><span class="line">文档 5: Feedback: We highly value your feedback. If you have any suggestions, concerns, or encounter any technical issues during the evaluation, please feel f...       </span><br><span class="line"></span><br><span class="line">--- LLM重排后的结果 ---</span><br><span class="line">文档 1: 3 2 0 2</span><br><span class="line"></span><br><span class="line">v o N 2</span><br><span class="line"></span><br><span class="line">] I</span><br><span class="line"></span><br><span class="line">A . s c [</span><br><span class="line"></span><br><span class="line">2 v 0 6 7 7 1 . 3 0 3 2 : v i X r a</span><br><span class="line"></span><br><span class="line">CAMEL: Communicative Agents for “Mind” Exploration of Large Language Model Soci...  </span><br><span class="line">文档 2: me instructions and necessary inputs until you think the task is completed. When the task is completed, you must only reply with a single word &lt;CAMEL_...       </span><br><span class="line">文档 3: Human Evaluation Guideline</span><br><span class="line"></span><br><span class="line">Thank you for participating in our task evaluation! We are comparing the performance of ChatGPT and a method called CAMEL ...</span><br><span class="line">文档 4: Objective: Your task is to compare two messages, one generated by CAMEL and the other by ChatGPT. These messages will be displayed anonymously on your...       </span><br><span class="line">文档 5: Feedback: We highly value your feedback. If you have any suggestions, concerns, or encounter any technical issues during the evaluation, please feel f...       </span><br><span class="line"></span><br><span class="line">--- 最终答案 ---</span><br><span class="line">根据提供的上下文信息，CAMEL（Communicative Agents for “Mind” Exploration of Large Language Model Society）具备以下特性：</span><br><span class="line"></span><br><span class="line">1. **交互式代理**：CAMEL项目使用交互式代理来生成和处理任务，这些代理可以模拟人类的对话和思维过程。</span><br><span class="line">2. **任务完成**：CAMEL代理能够接收任务指令，并在任务完成后回复特定的确认词 `&lt;CAMEL_TASK_DONE&gt;`。</span><br><span class="line">3. **性能评估**：CAMEL项目包括对不同AI系统（如ChatGPT和CAMEL自身）的性能评估，通过用户反馈和投票来比较它们的表现。</span><br><span class="line">4. **用户参与**：CAMEL项目鼓励用户参与任务评估，提供反馈和建议，以帮助改进AI系统的性能。</span><br><span class="line">5. **生成内容**：CAMEL框架可以生成各种内容，包括文本、图像等，用于任务完成和评估。  </span><br><span class="line">6. **社会“心智”探索**：CAMEL项目旨在通过代理之间的互动来探索大型语言模型的社会“心智”，即这些模型如何理解和处理社会互动和复杂任务。</span><br><span class="line"></span><br><span class="line">这些特性使得CAMEL项目在AI研究和应用中具有重要的意义，特别是在理解和发展更高级的交互 式AI系统方面。</span><br><span class="line"></span><br><span class="line">请输入您的查询（输入&#x27;quit&#x27;退出）: quit</span><br><span class="line">感谢使用！再见！</span><br></pre></td></tr></table></figure>

<p>此时我们可以看到两轮问答输出的排序效果：</p>
<p><strong>第一次查询：“camel是什么？对于我AI学习有什么帮助？”</strong></p>
<p>正在初步检索文档 (Top-5)…<br>✓ 初步检索到 5 个文档。<br>正在使用LLM进行文档重排…<br>✓ LLM重排完成。新顺序: [5, 3, 4, 2, 1]</p>
<ul>
<li><strong>原始检索结果：</strong> 文档3（“CAMEL: Communicative Agents for ‘Mind’ Exploration of Large Language Model Soci…”）是关于CAMEL项目的核心文档，但是代理将其排在第三位。而文档5（“agent is asked to draw all the Camelidae species…”）是关于生物学上的“驼科”的，与AI学习的相关性较低，故排在第五位。</li>
<li><strong>LLM重排后的结果：</strong> LLM将文档5（驼科）重排到了第一位，而将文档3（CAMEL项目）重排到了第二位。这表明LLM在这次重排中将生物学含义的“camel”置于了更高的优先级，尽管我们查询的后半部分明确指向了AI学习。</li>
<li><strong>最终答案：</strong> 尽管重排结果将次相关文档排在了前面，但最终答案依然能够正确识别“camel”的两种含义（生物学和CAMEL项目），并详细解释了CAMEL项目对AI学习的帮助，这说明RAG的生成部分能够有效地利用所有检索到的上下文，即使文档顺序不完全理想。</li>
</ul>
<p><strong>第二次查询：“camel具备哪些特性？”</strong></p>
<ul>
<li><strong>原始检索结果：</strong> 文档1（“CAMEL: Communicative Agents for ‘Mind’ Exploration of Large Language Model Soci…”）是关于CAMEL项目核心的文档，排在第一位。</li>
<li><strong>LLM重排后的结果：</strong> LLM的重排顺序是<code>[1, 2, 3, 4, 5]</code>，与原始检索结果的顺序完全一致。这表明LLM认为原始检索器提供的文档顺序已经足够优化，或者它没有找到更优的重排方式。</li>
<li><strong>最终答案：</strong> 最终答案详细列举了CAMEL项目的各项特性，这得益于原始检索结果中相关性高的文档（文档1）已经位于靠前的位置。</li>
</ul>
<p>因此可见**LLM ReRanker能够根据查询对文档进行重新排序。**在第一个查询中，它改变了文档顺序，但并非总是将最相关的文档（从人类角度看）排在首位，可能受到文档内容中“camel”多义性的影响。在第二个查询中，它维持了原始顺序。这表明LLM重排器在某些情况下可以优化文档顺序，但在处理多义性查询时可能需要更精细的提示词工程或结合其他信号来确保最高相关性的文档始终排在最前面。然而，即使重排结果并非完美，<strong>RAG的生成能力依然能够从提供的上下文中提取信息并给出较为全面的答案。</strong></p>
<h3 id="关于Task1和Task2的区别思考：这两个任务都涉及在RAG应用中集成重排（ReRanker）模块，但它们在实现方式和所依赖的技术栈上存在显著区别："><a href="#关于Task1和Task2的区别思考：这两个任务都涉及在RAG应用中集成重排（ReRanker）模块，但它们在实现方式和所依赖的技术栈上存在显著区别：" class="headerlink" title="关于Task1和Task2的区别思考：这两个任务都涉及在RAG应用中集成重排（ReRanker）模块，但它们在实现方式和所依赖的技术栈上存在显著区别："></a>关于Task1和Task2的区别思考：这两个任务都涉及在RAG应用中集成重排（ReRanker）模块，但它们在实现方式和所依赖的技术栈上存在显著区别：</h3><h4 id="Task-1：基于API调用或本地部署的预训练Reranker模型集成"><a href="#Task-1：基于API调用或本地部署的预训练Reranker模型集成" class="headerlink" title="Task 1：基于API调用或本地部署的预训练Reranker模型集成"></a>Task 1：基于API调用或本地部署的预训练Reranker模型集成</h4><ul>
<li><strong>实现方式：</strong> 这个任务侧重于利用<strong>外部的、专门训练过的重排模型或服务</strong>。<ul>
<li><strong>API 调用：</strong> 像Cohere ReRank这样的服务，提供了一个API接口，您可以将查询和文档列表发送给它，它会返回重排后的文档。这种方式通常开箱即用，性能经过优化。</li>
<li><strong>本地部署Reranker模型：</strong> 指的是下载并运行一个已经预训练好的重排模型（例如基于BERT、RoBERTa等架构的跨编码器模型），在本地环境中进行文档重排。</li>
</ul>
</li>
<li><strong>特点：</strong><ul>
<li><strong>效率高、性能优越：</strong> 这些模型通常是专门为重排任务训练的，能够捕捉文档和查询之间的细微相关性，性能通常比通用大模型在重排上的表现更稳定和高效。</li>
<li><strong>开箱即用：</strong> 集成过程通常是调用SDK或API，相对简单快捷。</li>
<li><strong>资源消耗：</strong> 如果是本地部署，需要一定的计算资源；如果调用API，则涉及外部服务费用。</li>
</ul>
</li>
<li><strong>参考链接分析：</strong> <code>https://github.com/camel-ai/camel/blob/master/camel/retrievers/cohere_rerank_retriever.py</code> 指向CAMEL框架中一个与Cohere ReRank服务集成的检索器。这明确表示Task 1是关于使用<strong>外部的、专业的重排服务</strong>。</li>
</ul>
<h4 id="Task-2：基于大语言模型和提示词工程实现Reranker"><a href="#Task-2：基于大语言模型和提示词工程实现Reranker" class="headerlink" title="Task 2：基于大语言模型和提示词工程实现Reranker"></a>Task 2：基于大语言模型和提示词工程实现Reranker</h4><ul>
<li><strong>实现方式：</strong> 这个任务的核心是利用<strong>通用大语言模型的零样本或少样本能力，通过精巧的提示词（Prompt Engineering）来“引导”LLM执行重排任务</strong>。<ul>
<li>您需要设计一个提示词，告诉LLM它是一个“重排助手”，提供查询和待重排的文档列表，并要求LLM输出重排后的文档顺序或评分。</li>
<li>重排的逻辑完全由LLM的推理能力和您的提示词设计决定。</li>
</ul>
</li>
<li><strong>特点：</strong><ul>
<li><strong>灵活性高：</strong> 可以根据具体需求，通过修改提示词来调整重排逻辑，适用于各种自定义场景。</li>
<li><strong>不依赖特定Reranker模型：</strong> 只要有通用大语言模型（如Qwen、ChatGPT等）即可实现，无需额外部署专门的重排模型。</li>
<li><strong>性能波动：</strong> 重排效果高度依赖于LLM的理解能力和提示词的质量，可能不如专门训练的Reranker模型稳定和极致。</li>
<li><strong>资源消耗：</strong> 调用LLM的API通常会有成本，且LLM的推理速度可能比专门的Reranker慢。</li>
</ul>
</li>
<li><strong>参考链接分析：</strong> <code>https://github.com/fengju0213/NavigatorAI/blob/main/2Travel_information_generation.py</code> 以及您之前让我优化过的代码，都是通过在CAMEL框架中使用 <code>ChatAgent</code>（即一个LLM代理）并结合自定义的系统消息和用户消息来模拟重排过程的。这明确表示Task 2是关于<strong>通过提示词工程将LLM作为重排器使用</strong>。</li>
</ul>
<h3 id="核心区别总结："><a href="#核心区别总结：" class="headerlink" title="核心区别总结："></a>核心区别总结：</h3><table>
<thead>
<tr>
<th>特征</th>
<th>Task 1：API&#x2F;本地部署Reranker模型</th>
<th>Task 2：LLM + 提示词工程实现Reranker</th>
</tr>
</thead>
<tbody><tr>
<td><strong>重排核心</strong></td>
<td>专门训练的重排模型&#x2F;服务</td>
<td>通用大语言模型 (LLM) 的推理能力</td>
</tr>
<tr>
<td><strong>实现方式</strong></td>
<td>调用成熟的API或SDK，或部署现有模型</td>
<td>设计提示词，引导LLM进行重排</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>通常更稳定、高效，针对重排任务优化</td>
<td>依赖LLM能力和提示词质量，可能波动较大</td>
</tr>
<tr>
<td><strong>灵活性</strong></td>
<td>较低，重排逻辑固定在模型中</td>
<td>较高，可通过调整提示词灵活定制重排逻辑</td>
</tr>
<tr>
<td><strong>资源</strong></td>
<td>可能需要GPU（本地）或API费用（云服务）</td>
<td>调用LLM的API费用，LLM本身运行资源</td>
</tr>
<tr>
<td><strong>开发难度</strong></td>
<td>相对较低，多为配置和集成</td>
<td>需要精通提示词工程，调试LLM行为</td>
</tr>
</tbody></table>
<h2 id="Task3"><a href="#Task3" class="headerlink" title="Task3"></a>Task3</h2><h3 id="导出本教程文档作为一个PDF文件，尝试搭建一个具有多模态检索能力的RAG应用来帮助其他学习者回答问题。"><a href="#导出本教程文档作为一个PDF文件，尝试搭建一个具有多模态检索能力的RAG应用来帮助其他学习者回答问题。" class="headerlink" title="导出本教程文档作为一个PDF文件，尝试搭建一个具有多模态检索能力的RAG应用来帮助其他学习者回答问题。"></a>导出本教程文档作为一个PDF文件，尝试搭建一个具有多模态检索能力的RAG应用来帮助其他学习者回答问题。</h3><p>由于我没有找到很好的将本教程文档转化为一个线上可直接数据向量化的方法，但经过运行确认确实可以将线上的PDF文档本地下载初始化数据库。<br>因此我们演示时暂时采用本地下载好的本教程PDF文档作为演示案例。</p>
<p>我们先来说明一下整个系统的具体实现：</p>
<h4 id="交互式多模态RAG系统"><a href="#交互式多模态RAG系统" class="headerlink" title="交互式多模态RAG系统"></a>交互式多模态RAG系统</h4><h5 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h5><p>这是一个基于CAMEL框架的交互式多模态RAG（检索增强生成）系统，集成了PDF文档处理、网页爬取、知识图谱构建和多种检索模式。系统支持文本、图像、表格等多模态内容的智能检索和分析。</p>
<h5 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h5><h6 id="多模态内容处理"><a href="#多模态内容处理" class="headerlink" title="多模态内容处理"></a>多模态内容处理</h6><ul>
<li><strong>PDF文档解析</strong>：支持在线PDF和本地PDF文件加载</li>
<li><strong>多模态元素提取</strong>：自动识别和处理文本、图像、表格内容</li>
<li><strong>智能内容分类</strong>：按内容类型进行分类存储和检索</li>
</ul>
<h6 id="多种检索模式"><a href="#多种检索模式" class="headerlink" title="多种检索模式"></a>多种检索模式</h6><ol>
<li><strong>快速检索</strong>：基础向量检索，快速获取相关文档</li>
<li><strong>深度检索</strong>：查询重写 + HyDE + RRF融合的高级检索</li>
<li><strong>主题检索</strong>：PDF文档 + 网页爬取的综合检索</li>
</ol>
<h6 id="AI智能分析"><a href="#AI智能分析" class="headerlink" title="AI智能分析"></a>AI智能分析</h6><ul>
<li><strong>CAMEL框架集成</strong>：使用CAMEL ModelFactory进行模型管理</li>
<li><strong>查询重写</strong>：智能优化用户查询以提高检索效果</li>
<li><strong>HyDE增强</strong>：假设文档生成技术提升检索精度</li>
<li><strong>RRF融合</strong>：多路检索结果的智能融合排序</li>
</ul>
<h6 id="网页研究系统"><a href="#网页研究系统" class="headerlink" title="网页研究系统"></a>网页研究系统</h6><ul>
<li><strong>智能网页爬取</strong>：基于主题的网页内容抓取</li>
<li><strong>知识图谱构建</strong>：自动构建主题相关的知识图谱</li>
<li><strong>多源信息融合</strong>：PDF文档与网页信息的智能整合</li>
</ul>
<h6 id="交互式体验"><a href="#交互式体验" class="headerlink" title="交互式体验"></a>交互式体验</h6><ul>
<li><strong>实时对话界面</strong>：支持连续问答和上下文理解</li>
<li><strong>结果可视化</strong>：详细的检索结果展示和分析</li>
<li><strong>报告生成</strong>：自动生成研究报告和结果保存</li>
</ul>
<h5 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">交互式多模态RAG系统</span><br><span class="line">├── 核心组件</span><br><span class="line">│   ├── SimpleLLMInterface (CAMEL模型接口)</span><br><span class="line">│   ├── SimpleEmbeddingModel (嵌入模型)</span><br><span class="line">│   ├── SimpleVectorRetriever (向量检索器)</span><br><span class="line">│   └── SimpleRAGSystem (RAG核心系统)</span><br><span class="line">├── 检索模式</span><br><span class="line">│   ├── 快速检索 (基础向量检索)</span><br><span class="line">│   ├── 深度检索 (重写+HyDE+RRF)</span><br><span class="line">│   └── 主题检索 (PDF+网页爬取)</span><br><span class="line">├── 网页研究系统</span><br><span class="line">│   ├── UniversalResearchSystem (通用研究系统)</span><br><span class="line">│   ├── InteractiveResearchSystem (交互式研究)</span><br><span class="line">│   └── EnhancedInteractiveResearchSystem (增强版)</span><br><span class="line">└── 交互界面</span><br><span class="line">    ├── 知识库管理</span><br><span class="line">    ├── 查询处理</span><br><span class="line">    └── 结果展示</span><br></pre></td></tr></table></figure>
<h5 id="核心框架"><a href="#核心框架" class="headerlink" title="核心框架"></a>核心框架</h5><ul>
<li><strong>CAMEL</strong>: AI智能体框架，提供模型管理和工具集成</li>
<li><strong>LangChain</strong>: 大语言模型应用开发框架</li>
<li><strong>Sentence Transformers</strong>: 文本嵌入和语义检索</li>
</ul>
<h5 id="文档处理"><a href="#文档处理" class="headerlink" title="文档处理"></a>文档处理</h5><ul>
<li><strong>PyPDF</strong>: PDF文档解析和文本提取</li>
<li><strong>Unstructured</strong>: 多模态文档元素识别和处理</li>
<li><strong>BeautifulSoup</strong>: HTML内容解析和清理</li>
</ul>
<h5 id="检索和存储"><a href="#检索和存储" class="headerlink" title="检索和存储"></a>检索和存储</h5><ul>
<li><strong>Scikit-learn</strong>: 向量相似度计算和机器学习</li>
<li><strong>NumPy</strong>: 数值计算和向量操作</li>
<li><strong>Neo4j</strong>: 知识图谱存储和查询（可选）</li>
</ul>
<h5 id="网页爬取"><a href="#网页爬取" class="headerlink" title="网页爬取"></a>网页爬取</h5><ul>
<li><strong>Requests</strong>: HTTP请求和网页内容获取</li>
<li><strong>Firecrawl</strong>: 智能网页内容抓取</li>
<li><strong>SearchToolkit</strong>: 网页搜索和信息检索</li>
</ul>
<h4 id="基本使用流程"><a href="#基本使用流程" class="headerlink" title="基本使用流程"></a>基本使用流程</h4><ol>
<li><p><strong>选择PDF来源</strong></p>
<ul>
<li>在线PDF（输入URL）</li>
<li>本地PDF（输入文件路径）</li>
<li>默认示例PDF（CAMEL论文）</li>
</ul>
</li>
<li><p><strong>选择检索模式</strong></p>
<ul>
<li>快速检索：适合简单问答</li>
<li>深度检索：适合复杂分析</li>
<li>主题检索：适合综合研究</li>
</ul>
</li>
<li><p><strong>输入查询问题</strong></p>
<ul>
<li>支持中英文查询</li>
<li>支持复杂的多步骤问题</li>
<li>支持上下文相关的连续对话</li>
</ul>
</li>
<li><p><strong>查看结果</strong></p>
<ul>
<li>检索到的相关文档</li>
<li>AI生成的详细答案</li>
<li>可选的结果保存功能</li>
</ul>
</li>
</ol>
<h5 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h5><h6 id="网页研究模式"><a href="#网页研究模式" class="headerlink" title="网页研究模式"></a>网页研究模式</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动增强版研究系统</span></span><br><span class="line">python RAG_WEB_TOPIC_Enhanced.py</span><br></pre></td></tr></table></figure>

<h6 id="自定义检索参数"><a href="#自定义检索参数" class="headerlink" title="自定义检索参数"></a>自定义检索参数</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在代码中调整检索参数</span></span><br><span class="line">results = rag_system.enhanced_query(</span><br><span class="line">    original_query=query,</span><br><span class="line">    use_rewriting=<span class="literal">True</span>,      <span class="comment"># 启用查询重写</span></span><br><span class="line">    use_hyde=<span class="literal">True</span>,           <span class="comment"># 启用HyDE增强</span></span><br><span class="line">    use_rrf=<span class="literal">True</span>,            <span class="comment"># 启用RRF融合</span></span><br><span class="line">    top_k=<span class="number">5</span>,                 <span class="comment"># 返回文档数量</span></span><br><span class="line">    multimodal_preference=[<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;image&#x27;</span>, <span class="string">&#x27;table&#x27;</span>]  <span class="comment"># 多模态偏好</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="检索模式"><a href="#检索模式" class="headerlink" title="检索模式"></a>检索模式</h5><h6 id="快速检索"><a href="#快速检索" class="headerlink" title="快速检索"></a>快速检索</h6><ul>
<li><strong>用途</strong>：基础问答和快速信息查找</li>
<li><strong>特点</strong>：速度快，资源消耗低</li>
<li><strong>适用场景</strong>：简单事实查询，概念解释</li>
</ul>
<h6 id="深度检索"><a href="#深度检索" class="headerlink" title="深度检索"></a>深度检索</h6><ul>
<li><strong>用途</strong>：复杂分析和深度研究</li>
<li><strong>特点</strong>：多步骤处理，结果精确</li>
<li><strong>适用场景</strong>：学术研究，技术分析</li>
</ul>
<h6 id="主题检索"><a href="#主题检索" class="headerlink" title="主题检索"></a>主题检索</h6><ul>
<li><strong>用途</strong>：综合信息收集和跨源研究</li>
<li><strong>特点</strong>：结合PDF和网页信息</li>
<li><strong>适用场景</strong>：市场调研，趋势分析</li>
</ul>
<p>接下来我们来看看具体的实现代码：</p>
<h4 id="实现代码："><a href="#实现代码：" class="headerlink" title="实现代码："></a>实现代码：</h4><h5 id="实现代码主要分为3个部分："><a href="#实现代码主要分为3个部分：" class="headerlink" title="实现代码主要分为3个部分："></a>实现代码主要分为3个部分：</h5><p><strong>主代码</strong>：【Interactive_Multimodal_RAG.py】集成“快速检索”+“深度检索”的多模态RAG应用<br><strong>分支代码</strong>：【RAG_WEB_TOPIC_Enhanced.py + RAG_WEB_TOPIC.py】集成“主题”检索的Web 抓取 + 知识图谱构建的综合RAG应用</p>
<p>说明：RAG_WEB_TOPIC_Enhanced.py 系统基于 RAG_WEB_TOPIC.py 改进开发，在使用运行RAG_WEB_TOPIC_Enhanced.py 的时候会同时运行 RAG_WEB_TOPIC.py 中的一些基础依赖和配置。</p>
<p><strong>主代码</strong>：【Interactive_Multimodal_RAG.py】</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">交互式多模态RAG系统</span></span><br><span class="line"><span class="string">支持PDF上传、多种检索模式和网页爬取功能</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在文件顶部添加CAMEL相关导入</span></span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"></span><br><span class="line"><span class="comment"># PDF处理</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> pypdf <span class="keyword">import</span> PdfReader</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;缺少pypdf库，请运行: pip install pypdf&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> unstructured.partition.auto <span class="keyword">import</span> partition</span><br><span class="line">    <span class="keyword">from</span> unstructured.documents.elements <span class="keyword">import</span> Text, Image, Table</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;缺少unstructured库，请运行: pip install unstructured&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌入模型</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line">    EMBEDDING_AVAILABLE = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;缺少sentence-transformers库&quot;</span>)</span><br><span class="line">    EMBEDDING_AVAILABLE = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入网页研究系统</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> RAG_WEB_TOPIC_Enhanced <span class="keyword">import</span> EnhancedInteractiveResearchSystem</span><br><span class="line">    WEB_RESEARCH_AVAILABLE = <span class="literal">True</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Web research system available&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Web research system not available&quot;</span>)</span><br><span class="line">    WEB_RESEARCH_AVAILABLE = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleLLMInterface</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;LLM接口 - 使用CAMEL ModelFactory&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_key: <span class="built_in">str</span>, model_name: <span class="built_in">str</span> = <span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>, use_camel: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> api_key:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;API key is required&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.api_key = api_key</span><br><span class="line">        <span class="variable language_">self</span>.model_name = model_name</span><br><span class="line">        <span class="variable language_">self</span>.use_camel = use_camel</span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> use_camel:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 使用CAMEL ModelFactory初始化模型</span></span><br><span class="line">                <span class="variable language_">self</span>.model = ModelFactory.create(</span><br><span class="line">                    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">                    model_type=model_name,</span><br><span class="line">                    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">                    api_key=api_key</span><br><span class="line">                )</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;CAMEL LLM initialized: <span class="subst">&#123;model_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;API key: <span class="subst">&#123;api_key[:<span class="number">10</span>]&#125;</span>...<span class="subst">&#123;api_key[-<span class="number">4</span>:]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;CAMEL initialization failed, using fallback: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.model = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Direct API LLM initialized: <span class="subst">&#123;model_name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;API key: <span class="subst">&#123;api_key[:<span class="number">10</span>]&#125;</span>...<span class="subst">&#123;api_key[-<span class="number">4</span>:]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, prompt: <span class="built_in">str</span>, max_tokens: <span class="built_in">int</span> = <span class="number">500</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成文本回答 - 使用CAMEL模型或直接API调用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 如果CAMEL模型可用，尝试使用</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.model <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Generating response with CAMEL model...&quot;</span>)</span><br><span class="line">                <span class="comment"># 使用CAMEL模型生成回答</span></span><br><span class="line">                <span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 创建用户消息</span></span><br><span class="line">                user_message = BaseMessage.make_user_message(</span><br><span class="line">                    role_name=<span class="string">&quot;user&quot;</span>,</span><br><span class="line">                    content=prompt</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 调用模型生成回答</span></span><br><span class="line">                response = <span class="variable language_">self</span>.model.run([user_message])</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 修复：正确处理CAMEL模型的响应</span></span><br><span class="line">                <span class="keyword">if</span> response:</span><br><span class="line">                    <span class="comment"># 如果响应是BaseMessage对象</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">hasattr</span>(response, <span class="string">&#x27;content&#x27;</span>):</span><br><span class="line">                        <span class="keyword">return</span> response.content</span><br><span class="line">                    <span class="comment"># 如果响应是列表，取第一个元素</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(response, <span class="built_in">list</span>) <span class="keyword">and</span> <span class="built_in">len</span>(response) &gt; <span class="number">0</span>:</span><br><span class="line">                        first_response = response[<span class="number">0</span>]</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">hasattr</span>(first_response, <span class="string">&#x27;content&#x27;</span>):</span><br><span class="line">                            <span class="keyword">return</span> first_response.content</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">return</span> <span class="built_in">str</span>(first_response)</span><br><span class="line">                    <span class="comment"># 如果响应是字符串</span></span><br><span class="line">                    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(response, <span class="built_in">str</span>):</span><br><span class="line">                        <span class="keyword">return</span> response</span><br><span class="line">                    <span class="comment"># 其他情况转换为字符串</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="built_in">str</span>(response)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">&quot;No response generated from CAMEL model&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;CAMEL generation failed, using fallback: <span class="subst">&#123;<span class="built_in">str</span>(e)[:<span class="number">100</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="comment"># 降级到直接API调用</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._fallback_generate(prompt, max_tokens)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 直接使用API调用</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Generating response with direct API call...&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._fallback_generate(prompt, max_tokens)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_fallback_generate</span>(<span class="params">self, prompt: <span class="built_in">str</span>, max_tokens: <span class="built_in">int</span> = <span class="number">500</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;降级方案：直接API调用 - 增加重试机制和超时处理&quot;&quot;&quot;</span></span><br><span class="line">        max_retries = <span class="number">3</span></span><br><span class="line">        timeout_seconds = <span class="number">60</span>  <span class="comment"># 增加超时时间</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(max_retries):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">import</span> requests</span><br><span class="line">                </span><br><span class="line">                headers = &#123;</span><br><span class="line">                    <span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;self.api_key&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                data = &#123;</span><br><span class="line">                    <span class="string">&quot;model&quot;</span>: <span class="variable language_">self</span>.model_name,</span><br><span class="line">                    <span class="string">&quot;messages&quot;</span>: [&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;],</span><br><span class="line">                    <span class="string">&quot;max_tokens&quot;</span>: max_tokens,</span><br><span class="line">                    <span class="string">&quot;temperature&quot;</span>: <span class="number">0.7</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;API调用 <span class="subst">&#123;attempt + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;max_retries&#125;</span>...&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                response = requests.post(</span><br><span class="line">                    <span class="string">&quot;https://api-inference.modelscope.cn/v1/chat/completions&quot;</span>,</span><br><span class="line">                    headers=headers,</span><br><span class="line">                    json=data,</span><br><span class="line">                    timeout=timeout_seconds</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                    result = response.json()</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;choices&#x27;</span> <span class="keyword">in</span> result <span class="keyword">and</span> <span class="built_in">len</span>(result[<span class="string">&#x27;choices&#x27;</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">                        content = result[<span class="string">&#x27;choices&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;√ API调用成功&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> content</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">raise</span> Exception(<span class="string">f&quot;API响应格式错误: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">f&quot;API调用失败 (状态码: <span class="subst">&#123;response.status_code&#125;</span>): <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;API调用超时 (尝试 <span class="subst">&#123;attempt + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;max_retries&#125;</span>)&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> attempt == max_retries - <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">f&quot;抱歉，由于网络超时，无法生成回答。请稍后重试。&quot;</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> requests.exceptions.ConnectionError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;网络连接错误 (尝试 <span class="subst">&#123;attempt + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;max_retries&#125;</span>)&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> attempt == max_retries - <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">f&quot;抱歉，网络连接失败，无法生成回答。请检查网络连接。&quot;</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;API调用失败 (尝试 <span class="subst">&#123;attempt + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;max_retries&#125;</span>): <span class="subst">&#123;<span class="built_in">str</span>(e)[:<span class="number">100</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> attempt == max_retries - <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">f&quot;生成答案时出现错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;抱歉，多次尝试后仍无法生成回答，请稍后重试。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleEmbeddingModel</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;简化的嵌入模型&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_name: <span class="built_in">str</span> = <span class="string">&#x27;intfloat/e5-large-v2&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> EMBEDDING_AVAILABLE:</span><br><span class="line">            <span class="keyword">raise</span> ImportError(<span class="string">&quot;sentence-transformers not available&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.model = SentenceTransformer(model_name)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;√ Embedding model loaded: <span class="subst">&#123;model_name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to load embedding model: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self, texts: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;文本编码&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.model.encode(texts, convert_to_numpy=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Encoding failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> np.array([])</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleVectorRetriever</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;简化的向量检索器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, embedding_model: SimpleEmbeddingModel</span>):</span><br><span class="line">        <span class="variable language_">self</span>.embedding_model = embedding_model</span><br><span class="line">        <span class="variable language_">self</span>.documents = []</span><br><span class="line">        <span class="variable language_">self</span>.doc_metadata = []</span><br><span class="line">        <span class="variable language_">self</span>.document_ids = []</span><br><span class="line">        <span class="variable language_">self</span>.doc_embeddings = <span class="literal">None</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;√ Simple vector retriever initialized&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_documents</span>(<span class="params">self, texts: <span class="type">List</span>[<span class="built_in">str</span>], metadata: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加文档&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> texts:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 生成文档ID</span></span><br><span class="line">            new_ids = [<span class="string">f&quot;doc_<span class="subst">&#123;<span class="built_in">len</span>(self.documents) + i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(texts))]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 存储文档</span></span><br><span class="line">            <span class="variable language_">self</span>.documents.extend(texts)</span><br><span class="line">            <span class="variable language_">self</span>.doc_metadata.extend(metadata)</span><br><span class="line">            <span class="variable language_">self</span>.document_ids.extend(new_ids)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算嵌入</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Computing embeddings for <span class="subst">&#123;<span class="built_in">len</span>(texts)&#125;</span> documents...&quot;</span>)</span><br><span class="line">            new_embeddings = <span class="variable language_">self</span>.embedding_model.encode(texts)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.doc_embeddings <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.doc_embeddings = new_embeddings</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.doc_embeddings = np.vstack([<span class="variable language_">self</span>.doc_embeddings, new_embeddings])</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Added <span class="subst">&#123;<span class="built_in">len</span>(texts)&#125;</span> documents to retriever&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Error adding documents: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self, query_text: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">5</span>, filter_type: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检索相关文档&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.documents <span class="keyword">or</span> <span class="variable language_">self</span>.doc_embeddings <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;No documents in retriever&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 计算查询嵌入</span></span><br><span class="line">            query_embedding = <span class="variable language_">self</span>.embedding_model.encode([query_text])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算相似度</span></span><br><span class="line">            similarities = cosine_similarity(query_embedding, <span class="variable language_">self</span>.doc_embeddings)[<span class="number">0</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取top_k结果</span></span><br><span class="line">            top_indices = np.argsort(similarities)[::-<span class="number">1</span>][:top_k * <span class="number">2</span>]</span><br><span class="line">            </span><br><span class="line">            results = []</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> top_indices:</span><br><span class="line">                <span class="keyword">if</span> idx &gt;= <span class="built_in">len</span>(<span class="variable language_">self</span>.documents):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">                doc_type = <span class="variable language_">self</span>.doc_metadata[idx].get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> filter_type <span class="keyword">and</span> doc_type != filter_type:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                results.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;text&#x27;</span>: <span class="variable language_">self</span>.documents[idx],</span><br><span class="line">                    <span class="string">&#x27;similarity&#x27;</span>: <span class="built_in">float</span>(similarities[idx]),</span><br><span class="line">                    <span class="string">&#x27;metadata&#x27;</span>: <span class="variable language_">self</span>.doc_metadata[idx],</span><br><span class="line">                    <span class="string">&#x27;id&#x27;</span>: <span class="variable language_">self</span>.document_ids[idx]</span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt;= top_k:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Retrieved <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> documents&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Query failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleRAGSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;简化的RAG系统 - 集成CAMEL ModelFactory&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_key: <span class="built_in">str</span>, model_name: <span class="built_in">str</span> = <span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>, use_camel: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> api_key:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;错误：API key required&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> use_camel:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Initializing Simple RAG System with CAMEL...&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Initializing Simple RAG System with direct API...&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 使用LLM接口（CAMEL或直接API）</span></span><br><span class="line">            <span class="variable language_">self</span>.llm = SimpleLLMInterface(api_key=api_key, model_name=model_name, use_camel=use_camel)</span><br><span class="line">            <span class="comment"># 保持原有的嵌入模型和检索器</span></span><br><span class="line">            <span class="variable language_">self</span>.embedding_model = SimpleEmbeddingModel()</span><br><span class="line">            <span class="variable language_">self</span>.vector_retriever = SimpleVectorRetriever(<span class="variable language_">self</span>.embedding_model)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.knowledge_base_initialized = <span class="literal">False</span></span><br><span class="line">            <span class="variable language_">self</span>.multimodal_content_store = &#123;&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;√ Simple RAG System initialized successfully!&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误：Initialization failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_knowledge_base</span>(<span class="params">self, pdf_url: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, pdf_path: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置知识库&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> pdf_url:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;↓ Loading PDF from URL: <span class="subst">&#123;pdf_url&#125;</span>&quot;</span>)</span><br><span class="line">                response = requests.get(pdf_url, timeout=<span class="number">30</span>)</span><br><span class="line">                response.raise_for_status()</span><br><span class="line">                pdf_bytes = response.content</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;√ PDF downloaded (<span class="subst">&#123;<span class="built_in">len</span>(pdf_bytes)&#125;</span> bytes)&quot;</span>)</span><br><span class="line">                pdf_file = io.BytesIO(pdf_bytes)</span><br><span class="line">                elements = partition(file=pdf_file)</span><br><span class="line">            <span class="keyword">elif</span> pdf_path:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Loading PDF from: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pdf_path):</span><br><span class="line">                    <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;错误：PDF not found: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">                elements = partition(filename=pdf_path)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;√ PDF loaded successfully&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;错误：Either pdf_url or pdf_path required&quot;</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误：PDF loading error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理文档元素</span></span><br><span class="line">        texts_to_embed = []</span><br><span class="line">        metadata_to_embed = []</span><br><span class="line">        multimodal_id_counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> elements:</span><br><span class="line">            element_text = <span class="built_in">str</span>(element).strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> element_text <span class="keyword">or</span> <span class="built_in">len</span>(element_text) &lt; <span class="number">10</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            multimodal_id = <span class="string">f&quot;multimodal_<span class="subst">&#123;multimodal_id_counter&#125;</span>&quot;</span></span><br><span class="line">            multimodal_id_counter += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(element, Text):</span><br><span class="line">                texts_to_embed.append(element_text)</span><br><span class="line">                metadata_to_embed.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;pdf&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;multimodal_id&#x27;</span>: multimodal_id</span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(element, Image):</span><br><span class="line">                <span class="comment"># 图像处理</span></span><br><span class="line">                image_description = <span class="string">f&quot;图像内容: <span class="subst">&#123;element_text&#125;</span>&quot;</span></span><br><span class="line">                texts_to_embed.append(image_description)</span><br><span class="line">                metadata_to_embed.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;image&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;pdf&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;multimodal_id&#x27;</span>: multimodal_id</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="variable language_">self</span>.multimodal_content_store[multimodal_id] = &#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;image&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;data&#x27;</span>: element_text</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(element, Table):</span><br><span class="line">                <span class="comment"># 表格处理</span></span><br><span class="line">                table_description = <span class="string">f&quot;表格内容: <span class="subst">&#123;element_text&#125;</span>&quot;</span></span><br><span class="line">                texts_to_embed.append(table_description)</span><br><span class="line">                metadata_to_embed.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;table&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;pdf&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;multimodal_id&#x27;</span>: multimodal_id</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="variable language_">self</span>.multimodal_content_store[multimodal_id] = &#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;table&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;data&#x27;</span>: element_text</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 其他类型作为文本处理</span></span><br><span class="line">                texts_to_embed.append(element_text)</span><br><span class="line">                metadata_to_embed.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;pdf&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;multimodal_id&#x27;</span>: multimodal_id</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> texts_to_embed:</span><br><span class="line">            <span class="variable language_">self</span>.vector_retriever.add_documents(texts_to_embed, metadata_to_embed)</span><br><span class="line">            <span class="variable language_">self</span>.knowledge_base_initialized = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            text_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> meta <span class="keyword">in</span> metadata_to_embed <span class="keyword">if</span> meta.get(<span class="string">&#x27;type&#x27;</span>) == <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">            image_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> meta <span class="keyword">in</span> metadata_to_embed <span class="keyword">if</span> meta.get(<span class="string">&#x27;type&#x27;</span>) == <span class="string">&#x27;image&#x27;</span>)</span><br><span class="line">            table_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> meta <span class="keyword">in</span> metadata_to_embed <span class="keyword">if</span> meta.get(<span class="string">&#x27;type&#x27;</span>) == <span class="string">&#x27;table&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;√ Knowledge base setup complete: <span class="subst">&#123;<span class="built_in">len</span>(texts_to_embed)&#125;</span> elements&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot; Content: <span class="subst">&#123;text_count&#125;</span> text, <span class="subst">&#123;image_count&#125;</span> images, <span class="subst">&#123;table_count&#125;</span> tables&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;No content extracted from PDF&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_available_retrieval_methods</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取可用的检索方法&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&quot;Vector&quot;</span>, <span class="string">&quot;Enhanced&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_query_rewriting</span>(<span class="params">self, original_query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查询重写 - 使用CAMEL模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;请重写以下查询，使其更适合文档检索和信息提取：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">原始查询：<span class="subst">&#123;original_query&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">重写要求：</span></span><br><span class="line"><span class="string">1. 保持查询的核心意图</span></span><br><span class="line"><span class="string">2. 使用更具体和明确的词汇</span></span><br><span class="line"><span class="string">3. 适合向量检索和语义匹配</span></span><br><span class="line"><span class="string">4. 只返回重写后的查询，不要其他解释</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">重写后的查询：&quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            rewritten_query = <span class="variable language_">self</span>.llm.generate(prompt, max_tokens=<span class="number">100</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 清理返回结果，只保留重写的查询</span></span><br><span class="line">            <span class="keyword">if</span> rewritten_query <span class="keyword">and</span> <span class="keyword">not</span> rewritten_query.startswith(<span class="string">&quot;抱歉&quot;</span>) <span class="keyword">and</span> <span class="keyword">not</span> rewritten_query.startswith(<span class="string">&quot;生成答案时出现错误&quot;</span>):</span><br><span class="line">                <span class="comment"># 提取实际的重写查询</span></span><br><span class="line">                lines = rewritten_query.strip().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                    line = line.strip()</span><br><span class="line">                    <span class="keyword">if</span> line <span class="keyword">and</span> <span class="keyword">not</span> line.startswith(<span class="string">&#x27;重写后的查询&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> line.startswith(<span class="string">&#x27;原始查询&#x27;</span>):</span><br><span class="line">                        rewritten_query = line</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Query rewritten: <span class="subst">&#123;original_query&#125;</span> -&gt; <span class="subst">&#123;rewritten_query[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> rewritten_query.strip()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;警告：Query rewriting failed, using original query&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> original_query</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;警告：Query rewriting failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> original_query</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_hyde_generation</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;HyDE假设文档生成 - 使用CAMEL模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;基于以下查询，生成一个假设性的文档片段，该片段可能包含查询的答案：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">查询：<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">要求：</span></span><br><span class="line"><span class="string">1. 生成一个200-300字的文档片段</span></span><br><span class="line"><span class="string">2. 内容应该直接回答查询问题</span></span><br><span class="line"><span class="string">3. 使用专业和准确的语言</span></span><br><span class="line"><span class="string">4. 包含相关的技术细节和概念</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">假设文档：&quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            hyde_doc = <span class="variable language_">self</span>.llm.generate(prompt, max_tokens=<span class="number">300</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> hyde_doc <span class="keyword">and</span> <span class="keyword">not</span> hyde_doc.startswith(<span class="string">&quot;抱歉&quot;</span>) <span class="keyword">and</span> <span class="keyword">not</span> hyde_doc.startswith(<span class="string">&quot;生成答案时出现错误&quot;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;📝 HyDE document generated: <span class="subst">&#123;<span class="built_in">len</span>(hyde_doc)&#125;</span> characters&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> hyde_doc.strip()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;警告：HyDE generation failed, using original query&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> query</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;警告：HyDE generation failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> query</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_rrf_fusion</span>(<span class="params">self, all_results: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Dict</span>]], k: <span class="built_in">int</span> = <span class="number">60</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;RRF融合多个检索结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            doc_scores = &#123;&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> results <span class="keyword">in</span> all_results:</span><br><span class="line">                <span class="keyword">for</span> rank, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(results):</span><br><span class="line">                    doc_id = doc.get(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> doc_id:</span><br><span class="line">                        rrf_score = <span class="number">1.0</span> / (k + rank + <span class="number">1</span>)</span><br><span class="line">                        <span class="keyword">if</span> doc_id <span class="keyword">in</span> doc_scores:</span><br><span class="line">                            doc_scores[doc_id][<span class="string">&#x27;score&#x27;</span>] += rrf_score</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            doc_scores[doc_id] = &#123;</span><br><span class="line">                                <span class="string">&#x27;doc&#x27;</span>: doc,</span><br><span class="line">                                <span class="string">&#x27;score&#x27;</span>: rrf_score</span><br><span class="line">                            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 按分数排序</span></span><br><span class="line">            sorted_docs = <span class="built_in">sorted</span>(doc_scores.values(), key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;score&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 为文档添加RRF分数</span></span><br><span class="line">            final_docs = []</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> sorted_docs:</span><br><span class="line">                doc = item[<span class="string">&#x27;doc&#x27;</span>].copy()</span><br><span class="line">                doc[<span class="string">&#x27;rrf_score&#x27;</span>] = item[<span class="string">&#x27;score&#x27;</span>]</span><br><span class="line">                final_docs.append(doc)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> final_docs</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;警告：RRF fusion failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> all_results[<span class="number">0</span>] <span class="keyword">if</span> all_results <span class="keyword">else</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enhanced_query</span>(<span class="params">self, original_query: <span class="built_in">str</span>, use_rewriting: <span class="built_in">bool</span> = <span class="literal">True</span>, use_hyde: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">                      use_rrf: <span class="built_in">bool</span> = <span class="literal">True</span>, top_k: <span class="built_in">int</span> = <span class="number">5</span>, rrf_k: <span class="built_in">int</span> = <span class="number">60</span>,</span></span><br><span class="line"><span class="params">                      multimodal_preference: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">str</span>]] = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行增强型RAG查询&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.knowledge_base_initialized:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Knowledge base not initialized&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据参数确定检索类型</span></span><br><span class="line">        <span class="keyword">if</span> use_rewriting <span class="keyword">and</span> use_hyde <span class="keyword">and</span> use_rrf:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n执行深度检索...&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;开始执行深度RAG查询&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n执行检索...&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line">        query_for_retrieval = original_query</span><br><span class="line">        rewritten_query = <span class="literal">None</span></span><br><span class="line">        hyde_doc = <span class="literal">None</span></span><br><span class="line">        retrieval_method = <span class="string">&quot;Vector&quot;</span></span><br><span class="line">        all_retrieved_results = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤1: 查询重写</span></span><br><span class="line">        <span class="keyword">if</span> use_rewriting:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n步骤1: 查询重写&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;原始查询: <span class="subst">&#123;original_query&#125;</span>&quot;</span>)</span><br><span class="line">            rewritten_query = <span class="variable language_">self</span>._query_rewriting(original_query)</span><br><span class="line">            query_for_retrieval = rewritten_query</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;重写查询: <span class="subst">&#123;rewritten_query&#125;</span>&quot;</span>)</span><br><span class="line">            retrieval_method += <span class="string">&quot;+Rewriting&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤2: 文档检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n步骤2: 文档检索&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="keyword">if</span> use_hyde <span class="keyword">and</span> use_rrf:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用HyDE+RRF组合方法进行检索...&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用RRF算法进行混合检索（HyDE增强向量检索）...&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用基础向量检索...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># HyDE生成</span></span><br><span class="line">        <span class="keyword">if</span> use_hyde:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;执行HyDE增强向量检索...&quot;</span>)</span><br><span class="line">            hyde_doc = <span class="variable language_">self</span>._hyde_generation(query_for_retrieval)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;生成的假设文档:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(hyde_doc)</span><br><span class="line">            retrieval_method += <span class="string">&quot;+HyDE&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 多模态检索</span></span><br><span class="line">        text_results = <span class="variable language_">self</span>.vector_retriever.query(query_for_retrieval, top_k=top_k, filter_type=<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">        all_retrieved_results.append(text_results)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✓ HyDE向量检索完成，获得 <span class="subst">&#123;<span class="built_in">len</span>(text_results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> multimodal_preference:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;image&#x27;</span> <span class="keyword">in</span> multimodal_preference:</span><br><span class="line">                image_results = <span class="variable language_">self</span>.vector_retriever.query(query_for_retrieval, top_k=top_k, filter_type=<span class="string">&#x27;image&#x27;</span>)</span><br><span class="line">                all_retrieved_results.append(image_results)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 图像检索完成，获得 <span class="subst">&#123;<span class="built_in">len</span>(image_results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line">                retrieval_method += <span class="string">&quot;+Image&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;table&#x27;</span> <span class="keyword">in</span> multimodal_preference:</span><br><span class="line">                table_results = <span class="variable language_">self</span>.vector_retriever.query(query_for_retrieval, top_k=top_k, filter_type=<span class="string">&#x27;table&#x27;</span>)</span><br><span class="line">                all_retrieved_results.append(table_results)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 表格检索完成，获得 <span class="subst">&#123;<span class="built_in">len</span>(table_results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line">                retrieval_method += <span class="string">&quot;+Table&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hyde_doc:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;执行BM25检索（使用原始查询）...&quot;</span>)</span><br><span class="line">            hyde_results = <span class="variable language_">self</span>.vector_retriever.query(hyde_doc, top_k=top_k)</span><br><span class="line">            all_retrieved_results.append(hyde_results)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✓ BM25检索成功，获得 <span class="subst">&#123;<span class="built_in">len</span>(hyde_results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># RRF融合</span></span><br><span class="line">        <span class="keyword">if</span> use_rrf <span class="keyword">and</span> <span class="built_in">len</span>(all_retrieved_results) &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用RRF算法融合检索结果...&quot;</span>)</span><br><span class="line">            final_retrieved_docs = <span class="variable language_">self</span>._rrf_fusion(all_retrieved_results, k=rrf_k)</span><br><span class="line">            retrieval_method += <span class="string">&quot;+RRF&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 统计唯一文档数量</span></span><br><span class="line">            unique_doc_ids = <span class="built_in">set</span>()</span><br><span class="line">            <span class="keyword">for</span> res_list <span class="keyword">in</span> all_retrieved_results:</span><br><span class="line">                <span class="keyword">for</span> doc <span class="keyword">in</span> res_list:</span><br><span class="line">                    unique_doc_ids.add(doc.get(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;RRF融合完成，共处理 <span class="subst">&#123;<span class="built_in">len</span>(unique_doc_ids)&#125;</span> 个唯一文档，返回前 <span class="subst">&#123;top_k&#125;</span> 个结果&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;HyDE+RRF检索完成，返回 <span class="subst">&#123;<span class="built_in">len</span>(final_retrieved_docs)&#125;</span> 个文档&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            unique_docs = &#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> res_list <span class="keyword">in</span> all_retrieved_results:</span><br><span class="line">                <span class="keyword">for</span> doc <span class="keyword">in</span> res_list:</span><br><span class="line">                    <span class="keyword">if</span> doc.get(<span class="string">&#x27;id&#x27;</span>) <span class="keyword">not</span> <span class="keyword">in</span> unique_docs:</span><br><span class="line">                        unique_docs[doc.get(<span class="string">&#x27;id&#x27;</span>)] = doc</span><br><span class="line">            final_retrieved_docs = <span class="built_in">list</span>(unique_docs.values())</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档合并完成，返回 <span class="subst">&#123;<span class="built_in">len</span>(final_retrieved_docs)&#125;</span> 个文档&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 限制最终文档数量</span></span><br><span class="line">        final_retrieved_docs = final_retrieved_docs[:top_k]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 显示检索到的文档预览</span></span><br><span class="line">        <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(final_retrieved_docs, <span class="number">1</span>):</span><br><span class="line">            similarity = doc.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">            rrf_score = <span class="built_in">getattr</span>(doc, <span class="string">&#x27;rrf_score&#x27;</span>, similarity)  <span class="comment"># 如果有RRF分数则使用，否则使用相似度</span></span><br><span class="line">            text_preview = doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)[:<span class="number">200</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) &gt; <span class="number">200</span> <span class="keyword">else</span> doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i&#125;</span> (RRF分数: <span class="subst">&#123;rrf_score:<span class="number">.4</span>f&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;text_preview&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 步骤3: 答案生成</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;步骤3: 答案生成&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建上下文</span></span><br><span class="line">        context_texts = []</span><br><span class="line">        <span class="keyword">for</span> doc <span class="keyword">in</span> final_retrieved_docs:</span><br><span class="line">            context_texts.append(doc[<span class="string">&#x27;text&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 生成最终答案</span></span><br><span class="line">        separator = <span class="string">&#x27;\n---\n&#x27;</span></span><br><span class="line">        context_str = separator.join(context_texts)</span><br><span class="line">        </span><br><span class="line">        prompt_for_llm = <span class="string">f&quot;&quot;&quot;你是一个专业的文档分析助手。请基于以下PDF文档内容回答用户问题。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">文档内容：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;context_str&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">用户问题：<span class="subst">&#123;original_query&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">回答要求：</span></span><br><span class="line"><span class="string">1. 仔细阅读并理解文档内容</span></span><br><span class="line"><span class="string">2. 基于文档内容提供准确、详细的答案</span></span><br><span class="line"><span class="string">3. 如果文档中没有相关信息，请明确说明</span></span><br><span class="line"><span class="string">4. 使用清晰的结构组织答案</span></span><br><span class="line"><span class="string">5. 引用具体的文档内容支持你的回答</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请提供详细的答案：&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在生成最终答案...&quot;</span>)</span><br><span class="line">        final_answer = <span class="variable language_">self</span>.llm.generate(prompt_for_llm, max_tokens=<span class="number">800</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> final_answer <span class="keyword">and</span> <span class="keyword">not</span> final_answer.startswith(<span class="string">&quot;抱歉&quot;</span>) <span class="keyword">and</span> <span class="keyword">not</span> final_answer.startswith(<span class="string">&quot;生成答案时出现错误&quot;</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;√ 答案生成成功&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;最终答案:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(final_answer)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;警告：答案生成失败，提供基于检索文档的简化回答&quot;</span>)</span><br><span class="line">            <span class="comment"># 提供基于检索文档的简化回答</span></span><br><span class="line">            simple_answer = <span class="string">f&quot;基于检索到的文档内容，关于&#x27;<span class="subst">&#123;original_query&#125;</span>&#x27;的相关信息如下：\n\n&quot;</span></span><br><span class="line">            <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(final_retrieved_docs[:<span class="number">3</span>], <span class="number">1</span>):</span><br><span class="line">                simple_answer += <span class="string">f&quot;<span class="subst">&#123;i&#125;</span>. <span class="subst">&#123;doc[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n\n&quot;</span></span><br><span class="line">            final_answer = simple_answer</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;最终答案:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(final_answer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;original_query&#x27;</span>: original_query,</span><br><span class="line">            <span class="string">&#x27;rewritten_query&#x27;</span>: rewritten_query,</span><br><span class="line">            <span class="string">&#x27;hyde_doc&#x27;</span>: hyde_doc,</span><br><span class="line">            <span class="string">&#x27;retrieved_docs&#x27;</span>: final_retrieved_docs,</span><br><span class="line">            <span class="string">&#x27;final_answer&#x27;</span>: final_answer,</span><br><span class="line">            <span class="string">&#x27;retrieval_method&#x27;</span>: retrieval_method</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InteractiveMultimodalRAG</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;交互式多模态RAG系统 - 集成CAMEL ModelFactory&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.api_key = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.rag_system = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.web_research_system = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.knowledge_base_loaded = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.current_pdf_source = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize_system</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化系统 - 使用CAMEL ModelFactory&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;初始化交互式多模态RAG系统...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加载环境变量</span></span><br><span class="line">        load_dotenv()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取API密钥</span></span><br><span class="line">        <span class="variable language_">self</span>.api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.api_key:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误：错误：请设置MODELSCOPE_SDK_TOKEN环境变量&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;提示：在.env文件中添加 MODELSCOPE_SDK_TOKEN=your_api_key&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 使用集成CAMEL的简化RAG系统</span></span><br><span class="line">            <span class="variable language_">self</span>.rag_system = SimpleRAGSystem(api_key=<span class="variable language_">self</span>.api_key, model_name=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;√ 集成CAMEL的RAG系统初始化成功&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 初始化网页研究系统</span></span><br><span class="line">            <span class="keyword">if</span> WEB_RESEARCH_AVAILABLE:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="variable language_">self</span>.web_research_system = EnhancedInteractiveResearchSystem()</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;√ 网页研究系统初始化成功&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;！警告： 网页研究系统初始化失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="variable language_">self</span>.web_research_system = <span class="literal">None</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;！错误：系统初始化失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_pdf_knowledge_base</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载PDF知识库&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nPDF知识库设置&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;1. 在线PDF (输入URL)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;2. 本地PDF (输入文件路径)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;3. 使用默认示例PDF&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        choice = <span class="built_in">input</span>(<span class="string">&quot;\n请选择PDF来源 (1-3): &quot;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> choice == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                pdf_url = <span class="built_in">input</span>(<span class="string">&quot;请输入PDF的URL: &quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> pdf_url:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;错误：URL不能为空&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;↓ 正在加载在线PDF: <span class="subst">&#123;pdf_url&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.rag_system.setup_knowledge_base(pdf_url=pdf_url)</span><br><span class="line">                <span class="variable language_">self</span>.current_pdf_source = <span class="string">f&quot;在线PDF: <span class="subst">&#123;pdf_url&#125;</span>&quot;</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">elif</span> choice == <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                pdf_path = <span class="built_in">input</span>(<span class="string">&quot;请输入PDF文件路径: &quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> pdf_path:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;错误：文件路径不能为空&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pdf_path):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;错误：文件不存在: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;状态查询： 正在加载本地PDF: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.rag_system.setup_knowledge_base(pdf_path=pdf_path)</span><br><span class="line">                <span class="variable language_">self</span>.current_pdf_source = <span class="string">f&quot;本地PDF: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">elif</span> choice == <span class="string">&quot;3&quot;</span>:</span><br><span class="line">                pdf_url = <span class="string">&quot;https://arxiv.org/pdf/2303.17760.pdf&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;↓ 正在加载默认示例PDF: <span class="subst">&#123;pdf_url&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.rag_system.setup_knowledge_base(pdf_url=pdf_url)</span><br><span class="line">                <span class="variable language_">self</span>.current_pdf_source = <span class="string">f&quot;示例PDF: CAMEL论文&quot;</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误：无效选择&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.knowledge_base_loaded = <span class="literal">True</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;√ PDF知识库加载成功！&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误：PDF加载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_query</span>(<span class="params">self, query: <span class="built_in">str</span>, retrieval_mode: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行查询&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.knowledge_base_loaded:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;知识库未加载，请先加载PDF&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n执行查询: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;检索模式: <span class="subst">&#123;retrieval_mode&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> retrieval_mode == <span class="string">&quot;快速检索&quot;</span>:</span><br><span class="line">                <span class="comment"># 基础向量检索 - 直接检索生成答案</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.quick_retrieval(query)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">elif</span> retrieval_mode == <span class="string">&quot;深度检索&quot;</span>:</span><br><span class="line">                <span class="comment"># 完整增强检索</span></span><br><span class="line">                results = <span class="variable language_">self</span>.rag_system.enhanced_query(</span><br><span class="line">                    original_query=query,</span><br><span class="line">                    use_rewriting=<span class="literal">True</span>,</span><br><span class="line">                    use_hyde=<span class="literal">True</span>,</span><br><span class="line">                    use_rrf=<span class="literal">True</span>,</span><br><span class="line">                    top_k=<span class="number">5</span>,</span><br><span class="line">                    multimodal_preference=[<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;image&#x27;</span>, <span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">elif</span> retrieval_mode == <span class="string">&quot;主题检索&quot;</span>:</span><br><span class="line">                <span class="comment"># 网页爬取检索 - 使用真实的网页研究系统</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.topic_retrieval(query)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;未知检索模式: <span class="subst">&#123;retrieval_mode&#125;</span>&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;查询执行失败: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">quick_retrieval</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;快速检索 - 基础向量检索直接生成答案&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n执行快速检索...&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 直接进行向量检索</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在进行向量检索...&quot;</span>)</span><br><span class="line">            retrieved_docs = <span class="variable language_">self</span>.rag_system.vector_retriever.query(query, top_k=<span class="number">3</span>, filter_type=<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> retrieved_docs:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;未找到相关文档&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;√ 检索到 <span class="subst">&#123;<span class="built_in">len</span>(retrieved_docs)&#125;</span> 个相关文档&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 显示检索到的文档</span></span><br><span class="line">            <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(retrieved_docs, <span class="number">1</span>):</span><br><span class="line">                similarity = doc.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                text_preview = doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)[:<span class="number">150</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) &gt; <span class="number">150</span> <span class="keyword">else</span> doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i&#125;</span> (相似度: <span class="subst">&#123;similarity:<span class="number">.3</span>f&#125;</span>):&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;   <span class="subst">&#123;text_preview&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 构建简单的上下文</span></span><br><span class="line">            context_texts = [doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs]</span><br><span class="line">            context_str = <span class="string">&#x27;\n---\n&#x27;</span>.join(context_texts)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成答案</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在生成答案...&quot;</span>)</span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;基于以下文档内容回答问题：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">文档内容：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;context_str&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">问题：<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请提供简洁明确的答案：&quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            final_answer = <span class="variable language_">self</span>.rag_system.llm.generate(prompt, max_tokens=<span class="number">400</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;√ 快速检索完成&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;original_query&#x27;</span>: query,</span><br><span class="line">                <span class="string">&#x27;retrieved_docs&#x27;</span>: retrieved_docs,</span><br><span class="line">                <span class="string">&#x27;final_answer&#x27;</span>: final_answer,</span><br><span class="line">                <span class="string">&#x27;retrieval_method&#x27;</span>: <span class="string">&#x27;Quick Vector Retrieval&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;快速检索失败: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">topic_retrieval</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;主题检索 - 集成网页研究系统&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n执行网页检索...&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.web_research_system:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;警告：网页研究系统不可用，使用备用方案&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.perform_fallback_topic_search(query)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 使用网页研究系统进行搜索</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在进行网页研究...&quot;</span>)</span><br><span class="line">            web_content = <span class="string">&quot;&quot;</span></span><br><span class="line">            web_sources = []</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 检查可用的方法并调用正确的方法</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.web_research_system, <span class="string">&#x27;research_and_analyze&#x27;</span>):</span><br><span class="line">                    <span class="comment"># 使用正确的方法名</span></span><br><span class="line">                    research_result = <span class="variable language_">self</span>.web_research_system.research_and_analyze(query)</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(research_result, <span class="built_in">dict</span>):</span><br><span class="line">                        web_content = research_result.get(<span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                        web_sources = research_result.get(<span class="string">&#x27;sources&#x27;</span>, [])</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        web_content = <span class="built_in">str</span>(research_result)</span><br><span class="line">                        web_sources = [<span class="string">&quot;网页研究结果&quot;</span>]</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;√ 网页研究完成&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.web_research_system, <span class="string">&#x27;toolkit&#x27;</span>) <span class="keyword">and</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.web_research_system.toolkit, <span class="string">&#x27;search_web_for_topic&#x27;</span>):</span><br><span class="line">                    <span class="comment"># 使用工具包搜索</span></span><br><span class="line">                    search_result = <span class="variable language_">self</span>.web_research_system.toolkit.search_web_for_topic(query, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                    web_content = search_result</span><br><span class="line">                    web_sources = [<span class="string">&quot;网页搜索结果&quot;</span>]</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;√ 网页搜索完成&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.web_research_system, <span class="string">&#x27;run_interactive_session&#x27;</span>):</span><br><span class="line">                    <span class="comment"># 尝试使用交互式会话方法</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;警告：使用交互式研究系统，但无法直接调用&quot;</span>)</span><br><span class="line">                    web_content = <span class="string">f&quot;关于&#x27;<span class="subst">&#123;query&#125;</span>&#x27;的网页研究信息需要交互式操作&quot;</span></span><br><span class="line">                    web_sources = [<span class="string">&quot;交互式研究系统&quot;</span>]</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;警告：网页研究系统方法不可用&quot;</span>)</span><br><span class="line">                    web_content = <span class="string">f&quot;关于&#x27;<span class="subst">&#123;query&#125;</span>&#x27;的网页搜索信息暂时不可用&quot;</span></span><br><span class="line">                    web_sources = []</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;警告：网页搜索失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                web_content = <span class="string">f&quot;网页搜索遇到错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">                web_sources = []</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 同时进行PDF检索</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在检索PDF文档...&quot;</span>)</span><br><span class="line">            pdf_docs = <span class="variable language_">self</span>.rag_system.vector_retriever.query(query, top_k=<span class="number">3</span>, filter_type=<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 合并结果</span></span><br><span class="line">            combined_context = <span class="string">&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加PDF内容</span></span><br><span class="line">            <span class="keyword">if</span> pdf_docs:</span><br><span class="line">                pdf_context = <span class="string">&quot;\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> pdf_docs])</span><br><span class="line">                combined_context += <span class="string">f&quot;PDF文档内容：\n<span class="subst">&#123;pdf_context&#125;</span>\n\n&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;√ 检索到 <span class="subst">&#123;<span class="built_in">len</span>(pdf_docs)&#125;</span> 个PDF文档&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加网页内容</span></span><br><span class="line">            <span class="keyword">if</span> web_content <span class="keyword">and</span> web_content.strip() <span class="keyword">and</span> <span class="keyword">not</span> web_content.startswith(<span class="string">&quot;关于&quot;</span>) <span class="keyword">and</span> <span class="keyword">not</span> web_content.startswith(<span class="string">&quot;网页搜索遇到错误&quot;</span>):</span><br><span class="line">                combined_context += <span class="string">f&quot;网页搜索内容：\n<span class="subst">&#123;web_content&#125;</span>\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> combined_context.strip():</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;警告：未找到相关信息，使用备用方案&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.perform_fallback_topic_search(query)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成综合答案</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在生成综合答案...&quot;</span>)</span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;基于以下PDF文档和网页搜索的信息，回答问题：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;combined_context&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">问题：<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请提供综合性的详细答案：&quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            final_answer = <span class="variable language_">self</span>.rag_system.llm.generate(prompt, max_tokens=<span class="number">800</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;主题检索完成&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;original_query&#x27;</span>: query,</span><br><span class="line">                <span class="string">&#x27;pdf_docs&#x27;</span>: pdf_docs,</span><br><span class="line">                <span class="string">&#x27;web_sources&#x27;</span>: web_sources,</span><br><span class="line">                <span class="string">&#x27;final_answer&#x27;</span>: final_answer,</span><br><span class="line">                <span class="string">&#x27;retrieval_method&#x27;</span>: <span class="string">&#x27;PDF+Web Topic Retrieval&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;警告：主题检索失败，使用备用方案: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.perform_fallback_topic_search(query)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_web_research</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行网页研究&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在进行网页研究...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 模拟网页研究结果</span></span><br><span class="line">            web_content = <span class="string">f&quot;基于网页搜索的<span class="subst">&#123;query&#125;</span>相关信息：\n&quot;</span></span><br><span class="line">            web_content += <span class="string">&quot;- 网页来源1的相关内容\n&quot;</span></span><br><span class="line">            web_content += <span class="string">&quot;- 网页来源2的相关内容\n&quot;</span></span><br><span class="line">            web_content += <span class="string">&quot;- 网页来源3的相关内容&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;web_content&quot;</span>: web_content,</span><br><span class="line">                <span class="string">&quot;sources&quot;</span>: [<span class="string">&quot;网页来源1&quot;</span>, <span class="string">&quot;网页来源2&quot;</span>, <span class="string">&quot;网页来源3&quot;</span>],</span><br><span class="line">                <span class="string">&quot;method&quot;</span>: <span class="string">&quot;web_research&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;网页研究失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;网页研究失败: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_fallback_topic_search</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;备用主题搜索 - 仅使用PDF检索&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;执行备用主题搜索（仅PDF检索）...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 进行PDF检索</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在检索PDF文档...&quot;</span>)</span><br><span class="line">            pdf_docs = <span class="variable language_">self</span>.rag_system.vector_retriever.query(query, top_k=<span class="number">5</span>, filter_type=<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> pdf_docs:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;未找到相关PDF文档&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检索到 <span class="subst">&#123;<span class="built_in">len</span>(pdf_docs)&#125;</span> 个PDF文档&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 显示检索到的文档</span></span><br><span class="line">            <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(pdf_docs, <span class="number">1</span>):</span><br><span class="line">                similarity = doc.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                text_preview = doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)[:<span class="number">150</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) &gt; <span class="number">150</span> <span class="keyword">else</span> doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i&#125;</span> (相似度: <span class="subst">&#123;similarity:<span class="number">.3</span>f&#125;</span>):&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;   <span class="subst">&#123;text_preview&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 构建上下文</span></span><br><span class="line">            pdf_context = <span class="string">&quot;\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> pdf_docs])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成答案</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在生成答案...&quot;</span>)</span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;基于以下PDF文档内容回答问题：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PDF文档内容：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;pdf_context&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">问题：<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请提供详细的答案，特别关注CAMEL框架的特性和工具：&quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            final_answer = <span class="variable language_">self</span>.rag_system.llm.generate(prompt, max_tokens=<span class="number">800</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;√ 备用主题搜索完成&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;original_query&#x27;</span>: query,</span><br><span class="line">                <span class="string">&#x27;retrieved_docs&#x27;</span>: pdf_docs,</span><br><span class="line">                <span class="string">&#x27;final_answer&#x27;</span>: final_answer,</span><br><span class="line">                <span class="string">&#x27;retrieval_method&#x27;</span>: <span class="string">&#x27;Fallback PDF Topic Retrieval&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;备用主题搜索失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;备用主题搜索失败: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge_web_and_pdf_results</span>(<span class="params">self, web_results: <span class="type">Dict</span>, pdf_results: <span class="type">Dict</span>, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;合并网页和PDF检索结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 合并上下文</span></span><br><span class="line">            combined_context = <span class="string">&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加PDF内容</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;retrieved_docs&#x27;</span> <span class="keyword">in</span> pdf_results:</span><br><span class="line">                pdf_context = <span class="string">&quot;\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> pdf_results[<span class="string">&#x27;retrieved_docs&#x27;</span>]])</span><br><span class="line">                combined_context += <span class="string">f&quot;PDF文档内容：\n<span class="subst">&#123;pdf_context&#125;</span>\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加网页内容</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;web_content&#x27;</span> <span class="keyword">in</span> web_results:</span><br><span class="line">                combined_context += <span class="string">f&quot;网页搜索内容：\n<span class="subst">&#123;web_results[<span class="string">&#x27;web_content&#x27;</span>]&#125;</span>\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成综合答案</span></span><br><span class="line">            prompt = <span class="string">f&quot;基于以下PDF文档和网页搜索的信息，回答问题：\n\n<span class="subst">&#123;combined_context&#125;</span>\n\n问题：<span class="subst">&#123;query&#125;</span>\n\n请提供综合性的详细答案。&quot;</span></span><br><span class="line">            </span><br><span class="line">            final_answer = <span class="variable language_">self</span>.rag_system.llm.generate(prompt, max_tokens=<span class="number">800</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;original_query&#x27;</span>: query,</span><br><span class="line">                <span class="string">&#x27;pdf_docs&#x27;</span>: pdf_results.get(<span class="string">&#x27;retrieved_docs&#x27;</span>, []),</span><br><span class="line">                <span class="string">&#x27;web_sources&#x27;</span>: web_results.get(<span class="string">&#x27;sources&#x27;</span>, []),</span><br><span class="line">                <span class="string">&#x27;final_answer&#x27;</span>: final_answer,</span><br><span class="line">                <span class="string">&#x27;retrieval_method&#x27;</span>: <span class="string">&#x27;PDF+Web主题检索&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;结果合并失败: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_results</span>(<span class="params">self, results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示查询结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;error&#x27;</span> <span class="keyword">in</span> results:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: <span class="subst">&#123;results[<span class="string">&#x27;error&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">20</span> + <span class="string">&quot; 深度检索结果 &quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">20</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;原结始查询: <span class="subst">&#123;results.get(<span class="string">&#x27;original_query&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> results.get(<span class="string">&#x27;rewritten_query&#x27;</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;重写查询: <span class="subst">&#123;results[<span class="string">&#x27;rewritten_query&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;检索方法: <span class="subst">&#123;results.get(<span class="string">&#x27;retrieval_method&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显示检索到的文档</span></span><br><span class="line">        retrieved_docs = results.get(<span class="string">&#x27;retrieved_docs&#x27;</span>, [])</span><br><span class="line">        <span class="keyword">if</span> retrieved_docs:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n检索到的文档 (共<span class="subst">&#123;<span class="built_in">len</span>(retrieved_docs)&#125;</span>个):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">            <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(retrieved_docs, <span class="number">1</span>):</span><br><span class="line">                rrf_score = doc.get(<span class="string">&#x27;rrf_score&#x27;</span>, doc.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">                text_preview = doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)[:<span class="number">200</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) &gt; <span class="number">200</span> <span class="keyword">else</span> doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i&#125;</span>:&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;相关度分数: <span class="subst">&#123;rrf_score&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;内容预览: <span class="subst">&#123;text_preview&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显示最终答案</span></span><br><span class="line">        final_answer = results.get(<span class="string">&#x27;final_answer&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;💡 生成答案:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(final_answer)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 询问是否保存结果</span></span><br><span class="line">        save_choice = <span class="built_in">input</span>(<span class="string">&quot;\n询问：是否保存结果到文件？(y/n): &quot;</span>).strip().lower()</span><br><span class="line">        <span class="keyword">if</span> save_choice == <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">            <span class="variable language_">self</span>._save_results_to_file(results)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_save_results_to_file</span>(<span class="params">self, results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存结果到文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">            timestamp = datetime.now().strftime(<span class="string">&#x27;%Y%m%d_%H%M%S&#x27;</span>)</span><br><span class="line">            filename = <span class="string">f&quot;rag_query_result_<span class="subst">&#123;timestamp&#125;</span>.txt&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="string">&quot;=&quot;</span>*<span class="number">60</span> + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                f.write(<span class="string">&quot;RAG查询结果报告\n&quot;</span>)</span><br><span class="line">                f.write(<span class="string">&quot;=&quot;</span>*<span class="number">60</span> + <span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line">                f.write(<span class="string">f&quot;查询时间: <span class="subst">&#123;datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>\n&quot;</span>)</span><br><span class="line">                f.write(<span class="string">f&quot;原始查询: <span class="subst">&#123;results.get(<span class="string">&#x27;original_query&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>\n&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> results.get(<span class="string">&#x27;rewritten_query&#x27;</span>):</span><br><span class="line">                    f.write(<span class="string">f&quot;重写查询: <span class="subst">&#123;results[<span class="string">&#x27;rewritten_query&#x27;</span>]&#125;</span>\n&quot;</span>)</span><br><span class="line">                f.write(<span class="string">f&quot;检索方法: <span class="subst">&#123;results.get(<span class="string">&#x27;retrieval_method&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>\n\n&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 保存检索文档</span></span><br><span class="line">                retrieved_docs = results.get(<span class="string">&#x27;retrieved_docs&#x27;</span>, [])</span><br><span class="line">                <span class="keyword">if</span> retrieved_docs:</span><br><span class="line">                    f.write(<span class="string">f&quot;检索到的文档 (共<span class="subst">&#123;<span class="built_in">len</span>(retrieved_docs)&#125;</span>个):\n&quot;</span>)</span><br><span class="line">                    f.write(<span class="string">&quot;-&quot;</span> * <span class="number">40</span> + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(retrieved_docs, <span class="number">1</span>):</span><br><span class="line">                        rrf_score = doc.get(<span class="string">&#x27;rrf_score&#x27;</span>, doc.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">                        f.write(<span class="string">f&quot;\n文档 <span class="subst">&#123;i&#125;</span>:\n&quot;</span>)</span><br><span class="line">                        f.write(<span class="string">f&quot;相关度分数: <span class="subst">&#123;rrf_score&#125;</span>\n&quot;</span>)</span><br><span class="line">                        f.write(<span class="string">f&quot;内容: <span class="subst">&#123;doc.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>\n&quot;</span>)</span><br><span class="line">                        f.write(<span class="string">&quot;-&quot;</span> * <span class="number">40</span> + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 保存最终答案</span></span><br><span class="line">                f.write(<span class="string">f&quot;\n生成答案:\n&quot;</span>)</span><br><span class="line">                f.write(results.get(<span class="string">&#x27;final_answer&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>))</span><br><span class="line">                f.write(<span class="string">&quot;\n\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;√ 结果已保存到: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误：保存失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_interactive_session</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行交互式会话&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.initialize_system():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n交互式多模态RAG系统&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;功能特性:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- 支持在线/本地PDF加载&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- 三种检索模式&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- 网页爬取集成&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;- 多模态内容处理&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加载知识库</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.load_pdf_knowledge_base():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;知识库加载失败，退出系统&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n当前知识库: <span class="subst">&#123;self.current_pdf_source&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;🔧 可用检索方法: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(self.rag_system.get_available_retrieval_methods())&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;查询选项&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 获取用户查询</span></span><br><span class="line">                query = <span class="built_in">input</span>(<span class="string">&quot;请输入您的问题 (输入 &#x27;quit&#x27; 退出, &#x27;reload&#x27; 重新加载PDF): &quot;</span>).strip()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> query.lower() == <span class="string">&#x27;quit&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">elif</span> query.lower() == <span class="string">&#x27;reload&#x27;</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="variable language_">self</span>.load_pdf_knowledge_base():</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;√ 知识库已重新加载: <span class="subst">&#123;self.current_pdf_source&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> query:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;问题不能为空&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 选择检索模式</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;\n选择检索模式:&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;1. 快速检索 (基础向量检索)&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;2. 深度检索 (重写+HyDE+RRF)&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;3. 主题检索 (PDF+网页爬取)&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                mode_choice = <span class="built_in">input</span>(<span class="string">&quot;请选择模式 (1-3): &quot;</span>).strip()</span><br><span class="line">                </span><br><span class="line">                mode_map = &#123;</span><br><span class="line">                    <span class="string">&quot;1&quot;</span>: <span class="string">&quot;快速检索&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;2&quot;</span>: <span class="string">&quot;深度检索&quot;</span>, </span><br><span class="line">                    <span class="string">&quot;3&quot;</span>: <span class="string">&quot;主题检索&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                retrieval_mode = mode_map.get(mode_choice)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> retrieval_mode:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;无效选择，使用默认快速检索&quot;</span>)</span><br><span class="line">                    retrieval_mode = <span class="string">&quot;快速检索&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 执行查询</span></span><br><span class="line">                results = <span class="variable language_">self</span>.execute_query(query, retrieval_mode)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 显示结果</span></span><br><span class="line">                <span class="variable language_">self</span>.display_results(results)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 询问是否继续</span></span><br><span class="line">                continue_choice = <span class="built_in">input</span>(<span class="string">&quot;\n是否继续查询？(y/n): &quot;</span>).strip().lower()</span><br><span class="line">                <span class="keyword">if</span> continue_choice != <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;\n\n用户中断，退出系统&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;系统错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n感谢使用交互式多模态RAG系统！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        interactive_rag = InteractiveMultimodalRAG()</span><br><span class="line">        interactive_rag.run_interactive_session()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;系统启动失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>


<p><strong>分支代码1</strong>：【RAG_WEB_TOPIC_Enhanced.py】</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> agentops</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore, init</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> camel.loaders <span class="keyword">import</span> Firecrawl, UnstructuredIO</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> AutoRetriever</span><br><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> FunctionTool, SearchToolkit</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, StorageType</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.utils <span class="keyword">import</span> print_text_animated</span><br><span class="line"><span class="keyword">from</span> camel.storages <span class="keyword">import</span> Neo4jGraph</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> KnowledgeGraphAgent, ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入原始系统的所有类和配置</span></span><br><span class="line"><span class="keyword">from</span> RAG_WEB_TOPIC <span class="keyword">import</span> (</span><br><span class="line">    ResearchConfig, ConfigManager, UniversalResearchSystem, </span><br><span class="line">    InteractiveResearchSystem</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 colorama</span></span><br><span class="line">init(autoreset=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局会话数据记录</span></span><br><span class="line">research_session_data = &#123;</span><br><span class="line">    <span class="string">&#x27;start_time&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;end_time&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;topic&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;research_question&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;search_results&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;retrieval_results&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;knowledge_graphs&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;conversation_history&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;generated_files&#x27;</span>: [],</span><br><span class="line">    <span class="string">&#x27;system_stats&#x27;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnhancedInteractiveResearchSystem</span>(<span class="title class_ inherited__">InteractiveResearchSystem</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;增强版交互式研究系统 - 支持最终报告生成&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.session_data = research_session_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_search_result</span>(<span class="params">self, query: <span class="built_in">str</span>, results: <span class="type">Any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录搜索结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.session_data[<span class="string">&#x27;search_results&#x27;</span>].append(&#123;</span><br><span class="line">            <span class="string">&#x27;query&#x27;</span>: query,</span><br><span class="line">            <span class="string">&#x27;results&#x27;</span>: <span class="built_in">str</span>(results)[:<span class="number">1000</span>],  <span class="comment"># 限制长度</span></span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_retrieval_result</span>(<span class="params">self, urls: <span class="type">List</span>[<span class="built_in">str</span>], query: <span class="built_in">str</span>, results: <span class="type">Any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录检索结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.session_data[<span class="string">&#x27;retrieval_results&#x27;</span>].append(&#123;</span><br><span class="line">            <span class="string">&#x27;urls&#x27;</span>: urls,</span><br><span class="line">            <span class="string">&#x27;query&#x27;</span>: query,</span><br><span class="line">            <span class="string">&#x27;results&#x27;</span>: <span class="built_in">str</span>(results)[:<span class="number">1000</span>],  <span class="comment"># 限制长度</span></span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_knowledge_graph</span>(<span class="params">self, text_input: <span class="built_in">str</span>, topic: <span class="built_in">str</span>, result: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录知识图谱构建&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.session_data[<span class="string">&#x27;knowledge_graphs&#x27;</span>].append(&#123;</span><br><span class="line">            <span class="string">&#x27;input_text&#x27;</span>: text_input[:<span class="number">500</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(text_input) &gt; <span class="number">500</span> <span class="keyword">else</span> text_input,</span><br><span class="line">            <span class="string">&#x27;topic&#x27;</span>: topic,</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: result[:<span class="number">500</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(result) &gt; <span class="number">500</span> <span class="keyword">else</span> result,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_conversation</span>(<span class="params">self, role: <span class="built_in">str</span>, content: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录对话历史&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.session_data[<span class="string">&#x27;conversation_history&#x27;</span>].append(&#123;</span><br><span class="line">            <span class="string">&#x27;role&#x27;</span>: role,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>: content[:<span class="number">800</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(content) &gt; <span class="number">800</span> <span class="keyword">else</span> content,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_enhanced_research_tools</span>(<span class="params">self, topic: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[FunctionTool]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建增强版研究工具（带日志记录）&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">enhanced_retrieve_urls</span>(<span class="params">urls: <span class="type">List</span>[<span class="built_in">str</span>], query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.toolkit.retrieve_information_from_urls(urls, query)</span><br><span class="line">            <span class="variable language_">self</span>.log_retrieval_result(urls, query, result)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">enhanced_search_topic</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.toolkit.search_web_for_topic(query, topic)</span><br><span class="line">            <span class="variable language_">self</span>.log_search_result(query, result)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">enhanced_build_kg</span>(<span class="params">text_input: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.toolkit.build_knowledge_graph(text_input, topic)</span><br><span class="line">            <span class="variable language_">self</span>.log_knowledge_graph(text_input, topic, result)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            FunctionTool(enhanced_retrieve_urls),</span><br><span class="line">            FunctionTool(enhanced_search_topic),</span><br><span class="line">            FunctionTool(enhanced_build_kg),</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_final_research_report</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成最终研究报告&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.model:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;❌ AI模型未初始化，无法生成最终报告&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">&quot;📊 正在生成最终研究报告...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算统计数据</span></span><br><span class="line">        duration = <span class="string">&quot;未知&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;start_time&#x27;</span>] <span class="keyword">and</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;end_time&#x27;</span>]:</span><br><span class="line">            start = datetime.fromisoformat(<span class="variable language_">self</span>.session_data[<span class="string">&#x27;start_time&#x27;</span>])</span><br><span class="line">            end = datetime.fromisoformat(<span class="variable language_">self</span>.session_data[<span class="string">&#x27;end_time&#x27;</span>])</span><br><span class="line">            duration = <span class="built_in">str</span>(end - start)</span><br><span class="line">        </span><br><span class="line">        total_searches = <span class="built_in">len</span>(<span class="variable language_">self</span>.session_data[<span class="string">&#x27;search_results&#x27;</span>])</span><br><span class="line">        total_retrievals = <span class="built_in">len</span>(<span class="variable language_">self</span>.session_data[<span class="string">&#x27;retrieval_results&#x27;</span>])</span><br><span class="line">        total_kg = <span class="built_in">len</span>(<span class="variable language_">self</span>.session_data[<span class="string">&#x27;knowledge_graphs&#x27;</span>])</span><br><span class="line">        total_conversations = <span class="built_in">len</span>(<span class="variable language_">self</span>.session_data[<span class="string">&#x27;conversation_history&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 收集关键信息</span></span><br><span class="line">        search_summary = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;- <span class="subst">&#123;item[<span class="string">&#x27;query&#x27;</span>]&#125;</span>: <span class="subst">&#123;item[<span class="string">&#x27;results&#x27;</span>][:<span class="number">200</span>]&#125;</span>...&quot;</span> </span><br><span class="line">                                   <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;search_results&#x27;</span>][:<span class="number">5</span>]])</span><br><span class="line">        </span><br><span class="line">        retrieval_summary = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;- <span class="subst">&#123;item[<span class="string">&#x27;query&#x27;</span>]&#125;</span>: <span class="subst">&#123;item[<span class="string">&#x27;results&#x27;</span>][:<span class="number">200</span>]&#125;</span>...&quot;</span> </span><br><span class="line">                                      <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;retrieval_results&#x27;</span>][:<span class="number">5</span>]])</span><br><span class="line">        </span><br><span class="line">        conversation_summary = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;**<span class="subst">&#123;item[<span class="string">&#x27;role&#x27;</span>]&#125;</span>**: <span class="subst">&#123;item[<span class="string">&#x27;content&#x27;</span>][:<span class="number">300</span>]&#125;</span>...&quot;</span> </span><br><span class="line">                                         <span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;conversation_history&#x27;</span>][:<span class="number">10</span>]])</span><br><span class="line">        </span><br><span class="line">        report_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">基于以下研究系统的完整运行数据，生成一份详细的最终研究报告：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 研究基本信息：</span></span><br><span class="line"><span class="string">- 研究主题: <span class="subst">&#123;self.session_data[<span class="string">&#x27;topic&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">- 研究问题: <span class="subst">&#123;self.session_data[<span class="string">&#x27;research_question&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">- 研究时长: <span class="subst">&#123;duration&#125;</span></span></span><br><span class="line"><span class="string">- 开始时间: <span class="subst">&#123;self.session_data[<span class="string">&#x27;start_time&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">- 结束时间: <span class="subst">&#123;self.session_data[<span class="string">&#x27;end_time&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 系统运行统计：</span></span><br><span class="line"><span class="string">- 执行搜索次数: <span class="subst">&#123;total_searches&#125;</span></span></span><br><span class="line"><span class="string">- 执行检索次数: <span class="subst">&#123;total_retrievals&#125;</span></span></span><br><span class="line"><span class="string">- 生成知识图谱数量: <span class="subst">&#123;total_kg&#125;</span></span></span><br><span class="line"><span class="string">- 对话轮次: <span class="subst">&#123;total_conversations&#125;</span></span></span><br><span class="line"><span class="string">- 生成文件数量: <span class="subst">&#123;<span class="built_in">len</span>(self.session_data[<span class="string">&#x27;generated_files&#x27;</span>])&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 搜索结果摘要：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;search_summary&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 检索结果摘要：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;retrieval_summary&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 对话历史摘要：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;conversation_summary&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 生成的文件：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(self.session_data[<span class="string">&#x27;generated_files&#x27;</span>])&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请按以下结构生成最终研究报告：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># <span class="subst">&#123;self.session_data[<span class="string">&#x27;topic&#x27;</span>]&#125;</span> - 研究最终报告</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 1. 执行摘要</span></span><br><span class="line"><span class="string">- 研究目标和范围</span></span><br><span class="line"><span class="string">- 主要发现概述</span></span><br><span class="line"><span class="string">- 系统运行效果评估</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 2. 研究方法和过程</span></span><br><span class="line"><span class="string">- 数据收集方法</span></span><br><span class="line"><span class="string">- 检索和分析流程</span></span><br><span class="line"><span class="string">- 知识图谱构建过程</span></span><br><span class="line"><span class="string">- 技术工具使用情况</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 3. 详细研究结果</span></span><br><span class="line"><span class="string">- 核心发现和数据</span></span><br><span class="line"><span class="string">- 关键信息分析</span></span><br><span class="line"><span class="string">- 重要观点整理</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 4. 系统性能分析</span></span><br><span class="line"><span class="string">- RAG检索效果评估</span></span><br><span class="line"><span class="string">- 知识图谱构建质量</span></span><br><span class="line"><span class="string">- 对话系统表现</span></span><br><span class="line"><span class="string">- 数据处理效率</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 5. 结论和建议</span></span><br><span class="line"><span class="string">- 研究结论总结</span></span><br><span class="line"><span class="string">- 发现的问题和局限</span></span><br><span class="line"><span class="string">- 改进建议</span></span><br><span class="line"><span class="string">- 后续研究方向</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 6. 技术附录</span></span><br><span class="line"><span class="string">- 系统配置参数</span></span><br><span class="line"><span class="string">- 生成的文件清单</span></span><br><span class="line"><span class="string">- 数据来源统计</span></span><br><span class="line"><span class="string">- 运行日志摘要</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请确保报告内容详实、分析深入、结论客观，重点回答研究问题。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 创建报告生成智能体</span></span><br><span class="line">            report_agent = ChatAgent(</span><br><span class="line">                system_message=BaseMessage.make_assistant_message(</span><br><span class="line">                    role_name=<span class="string">&quot;研究报告专家&quot;</span>,</span><br><span class="line">                    content=<span class="string">&quot;你是一个专业的研究分析师和技术系统评估专家，擅长生成详细的研究报告和系统评估报告。&quot;</span></span><br><span class="line">                ),</span><br><span class="line">                model=<span class="variable language_">self</span>.model</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            user_msg = BaseMessage.make_user_message(</span><br><span class="line">                role_name=<span class="string">&quot;报告请求者&quot;</span>, </span><br><span class="line">                content=report_prompt</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            response = report_agent.step(user_msg)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 保存最终报告</span></span><br><span class="line">            timestamp = datetime.now().strftime(<span class="string">&#x27;%Y%m%d_%H%M%S&#x27;</span>)</span><br><span class="line">            topic_safe = <span class="string">&quot;&quot;</span>.join(c <span class="keyword">for</span> c <span class="keyword">in</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;topic&#x27;</span>] <span class="keyword">if</span> c.isalnum() <span class="keyword">or</span> c <span class="keyword">in</span> (<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)).rstrip()</span><br><span class="line">            topic_safe = topic_safe.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;_&#x27;</span>)[:<span class="number">50</span>]  <span class="comment"># 限制文件名长度</span></span><br><span class="line">            </span><br><span class="line">            report_filename = <span class="string">f&quot;final_research_report_<span class="subst">&#123;topic_safe&#125;</span>_<span class="subst">&#123;timestamp&#125;</span>.md&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(report_filename, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(response.msg.content)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.session_data[<span class="string">&#x27;generated_files&#x27;</span>].append(report_filename)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;✅ 最终报告已保存: <span class="subst">&#123;report_filename&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> response.msg.content</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_msg = <span class="string">f&quot;❌ 最终报告生成失败: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + error_msg)</span><br><span class="line">            <span class="keyword">return</span> error_msg</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_enhanced_interactive_research</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行增强版交互式研究（含最终报告）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.model <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.research_system:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;❌ 系统未正确初始化，无法运行&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;🚀 增强版通用AI研究系统（含最终报告）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">70</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 重置会话数据</span></span><br><span class="line">                <span class="variable language_">self</span>.session_data.update(&#123;</span><br><span class="line">                    <span class="string">&#x27;start_time&#x27;</span>: datetime.now().isoformat(),</span><br><span class="line">                    <span class="string">&#x27;end_time&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">&#x27;topic&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;research_question&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;search_results&#x27;</span>: [],</span><br><span class="line">                    <span class="string">&#x27;retrieval_results&#x27;</span>: [],</span><br><span class="line">                    <span class="string">&#x27;knowledge_graphs&#x27;</span>: [],</span><br><span class="line">                    <span class="string">&#x27;conversation_history&#x27;</span>: [],</span><br><span class="line">                    <span class="string">&#x27;generated_files&#x27;</span>: [],</span><br><span class="line">                    <span class="string">&#x27;system_stats&#x27;</span>: &#123;&#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 获取用户输入</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;\n请输入研究信息:&quot;</span>)</span><br><span class="line">                topic = <span class="built_in">input</span>(Fore.CYAN + <span class="string">&quot;研究主题: &quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> topic:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                research_question = <span class="built_in">input</span>(Fore.CYAN + <span class="string">&quot;具体问题: &quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> research_question:</span><br><span class="line">                    research_question = <span class="string">f&quot;关于<span class="subst">&#123;topic&#125;</span>的综合信息&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 记录研究信息</span></span><br><span class="line">                <span class="variable language_">self</span>.session_data[<span class="string">&#x27;topic&#x27;</span>] = topic</span><br><span class="line">                <span class="variable language_">self</span>.session_data[<span class="string">&#x27;research_question&#x27;</span>] = research_question</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;\n📋 开始研究:&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;   主题: <span class="subst">&#123;topic&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;   问题: <span class="subst">&#123;research_question&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">70</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 创建增强版研究工具和任务</span></span><br><span class="line">                tools = <span class="variable language_">self</span>.create_enhanced_research_tools(topic)</span><br><span class="line">                task_prompt = <span class="variable language_">self</span>.create_research_task(topic, research_question)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 创建角色扮演系统</span></span><br><span class="line">                role_play_session = RolePlaying(</span><br><span class="line">                    assistant_role_name=<span class="string">&quot;AI研究助理&quot;</span>,</span><br><span class="line">                    user_role_name=<span class="string">&quot;研究用户&quot;</span>,</span><br><span class="line">                    assistant_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">                        model=<span class="variable language_">self</span>.model,</span><br><span class="line">                        tools=tools,</span><br><span class="line">                    ),</span><br><span class="line">                    user_agent_kwargs=<span class="built_in">dict</span>(model=<span class="variable language_">self</span>.model),</span><br><span class="line">                    task_prompt=task_prompt,</span><br><span class="line">                    with_task_specify=<span class="literal">False</span>,</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 记录初始对话</span></span><br><span class="line">                <span class="variable language_">self</span>.log_conversation(<span class="string">&quot;系统&quot;</span>, <span class="string">f&quot;开始研究: <span class="subst">&#123;topic&#125;</span> - <span class="subst">&#123;research_question&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 执行研究</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;🤖 AI助理已准备就绪&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;👤 开始研究对话...&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                input_msg = role_play_session.init_chat()</span><br><span class="line">                chat_turn_limit = <span class="number">8</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(chat_turn_limit):</span><br><span class="line">                    <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">f&quot;\n--- 研究轮次 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> ---&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># 记录对话</span></span><br><span class="line">                        <span class="variable language_">self</span>.log_conversation(<span class="string">&quot;助理&quot;</span>, assistant_response.msg.content)</span><br><span class="line">                        <span class="variable language_">self</span>.log_conversation(<span class="string">&quot;用户&quot;</span>, user_response.msg.content)</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> assistant_response.terminated <span class="keyword">or</span> user_response.terminated:</span><br><span class="line">                            <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ 研究任务完成&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># 显示进度</span></span><br><span class="line">                        <span class="built_in">print</span>(Fore.CYAN + <span class="string">f&quot;🔄 助理: <span class="subst">&#123;assistant_response.msg.content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;🔄 用户: <span class="subst">&#123;user_response.msg.content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                        </span><br><span class="line">                        input_msg = assistant_response.msg</span><br><span class="line">                        time.sleep(<span class="number">1</span>)  <span class="comment"># 避免请求过快</span></span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;研究过程出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 记录结束时间</span></span><br><span class="line">                <span class="variable language_">self</span>.session_data[<span class="string">&#x27;end_time&#x27;</span>] = datetime.now().isoformat()</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">80</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ 角色扮演研究阶段完成&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;=&quot;</span>*<span class="number">80</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 生成最终报告</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;\n🎯 开始生成最终研究报告...&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">70</span>)</span><br><span class="line">                </span><br><span class="line">                final_report = <span class="variable language_">self</span>.generate_final_research_report()</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">100</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">&quot;📊 最终研究报告预览&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">&quot;=&quot;</span>*<span class="number">100</span>)</span><br><span class="line">                <span class="built_in">print</span>(final_report[:<span class="number">1000</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(final_report) &gt; <span class="number">1000</span> <span class="keyword">else</span> final_report)</span><br><span class="line">                <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">&quot;=&quot;</span>*<span class="number">100</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 显示生成的文件统计</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;\n📁 本次研究共生成 <span class="subst">&#123;<span class="built_in">len</span>(self.session_data[<span class="string">&#x27;generated_files&#x27;</span>])&#125;</span> 个文件:&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable language_">self</span>.session_data[<span class="string">&#x27;generated_files&#x27;</span>]:</span><br><span class="line">                    <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;   📄 <span class="subst">&#123;file&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 询问是否继续</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">70</span>)</span><br><span class="line">                continue_research = <span class="built_in">input</span>(Fore.CYAN + <span class="string">&quot;是否继续新的研究? (y/n): &quot;</span>).strip().lower()</span><br><span class="line">                <span class="keyword">if</span> continue_research != <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;\n用户中断研究&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;系统错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;\n👋 感谢使用增强版通用AI研究系统！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;🎯 增强版通用AI研究系统启动（含最终报告）&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        enhanced_system = EnhancedInteractiveResearchSystem()</span><br><span class="line">        enhanced_system.run_enhanced_interactive_research()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 系统启动失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;💡 请检查配置和依赖项&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<p><strong>分支代码2</strong>：【RAG_WEB_TOPIC.py】</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> agentops</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore, init</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> camel.loaders <span class="keyword">import</span> Firecrawl, UnstructuredIO</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> AutoRetriever</span><br><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> FunctionTool, SearchToolkit</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, StorageType</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.utils <span class="keyword">import</span> print_text_animated</span><br><span class="line"><span class="keyword">from</span> camel.storages <span class="keyword">import</span> Neo4jGraph</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> KnowledgeGraphAgent</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 colorama</span></span><br><span class="line">init(autoreset=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResearchConfig</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;研究系统配置类&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># API配置 - 直接配置所有必要密钥</span></span><br><span class="line">    agentops_api_key: <span class="built_in">str</span> = <span class="string">&quot;3e6edf79-2c28-400f-8433-cf4fa764444d&quot;</span></span><br><span class="line">    firecrawl_api_key: <span class="built_in">str</span> = <span class="string">&quot;fc-58764a3cc0184450b220d2dd1ca687c2&quot;</span></span><br><span class="line">    modelscope_api_key: <span class="built_in">str</span> = <span class="string">&quot;64af0689-2660-4285-99ff-270e4c7416a3&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Neo4j配置</span></span><br><span class="line">    neo4j_url: <span class="built_in">str</span> = <span class="string">&quot;bolt://localhost:7687&quot;</span></span><br><span class="line">    neo4j_username: <span class="built_in">str</span> = <span class="string">&quot;neo4j&quot;</span></span><br><span class="line">    neo4j_password: <span class="built_in">str</span> = <span class="string">&quot;tyy20060315&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模型配置</span></span><br><span class="line">    model_platform: <span class="built_in">str</span> = <span class="string">&quot;openai_compatible&quot;</span></span><br><span class="line">    model_name: <span class="built_in">str</span> = <span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span></span><br><span class="line">    model_url: <span class="built_in">str</span> = <span class="string">&quot;https://api-inference.modelscope.cn/v1/&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 存储配置</span></span><br><span class="line">    vector_storage_path: <span class="built_in">str</span> = <span class="string">&quot;research_data&quot;</span></span><br><span class="line">    storage_type: <span class="built_in">str</span> = <span class="string">&quot;qdrant&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 搜索配置</span></span><br><span class="line">    max_search_results: <span class="built_in">int</span> = <span class="number">10</span></span><br><span class="line">    max_urls_to_process: <span class="built_in">int</span> = <span class="number">5</span></span><br><span class="line">    similarity_threshold: <span class="built_in">float</span> = <span class="number">0.3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置管理器 - 安全地处理敏感信息&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_file: <span class="built_in">str</span> = <span class="string">&quot;config.json&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.config_file = Path(config_file)</span><br><span class="line">        <span class="variable language_">self</span>.config = ResearchConfig()</span><br><span class="line">        <span class="variable language_">self</span>._load_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从配置文件和环境变量加载配置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 直接使用配置的API密钥，如果环境变量存在则优先使用环境变量</span></span><br><span class="line">        <span class="variable language_">self</span>.config.agentops_api_key = os.getenv(<span class="string">&quot;AGENTOPS_API_KEY&quot;</span>, <span class="variable language_">self</span>.config.agentops_api_key)</span><br><span class="line">        <span class="variable language_">self</span>.config.firecrawl_api_key = os.getenv(<span class="string">&quot;FIRECRAWL_API_KEY&quot;</span>, <span class="variable language_">self</span>.config.firecrawl_api_key)</span><br><span class="line">        <span class="variable language_">self</span>.config.modelscope_api_key = os.getenv(<span class="string">&quot;MODELSCOPE_SDK_TOKEN&quot;</span>, <span class="variable language_">self</span>.config.modelscope_api_key)</span><br><span class="line">        <span class="variable language_">self</span>.config.neo4j_password = os.getenv(<span class="string">&quot;NEO4J_PASSWORD&quot;</span>, <span class="variable language_">self</span>.config.neo4j_password)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 设置环境变量以供其他组件使用</span></span><br><span class="line">        os.environ[<span class="string">&quot;AGENTOPS_API_KEY&quot;</span>] = <span class="variable language_">self</span>.config.agentops_api_key</span><br><span class="line">        os.environ[<span class="string">&quot;FIRECRAWL_API_KEY&quot;</span>] = <span class="variable language_">self</span>.config.firecrawl_api_key</span><br><span class="line">        os.environ[<span class="string">&quot;MODELSCOPE_SDK_TOKEN&quot;</span>] = <span class="variable language_">self</span>.config.modelscope_api_key</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从配置文件加载非敏感配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.config_file.exists():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.config_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    file_config = json.load(f)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 更新非敏感配置</span></span><br><span class="line">                <span class="keyword">for</span> key, value <span class="keyword">in</span> file_config.items():</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> key.endswith(<span class="string">&#x27;_key&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> key.endswith(<span class="string">&#x27;_password&#x27;</span>):</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.config, key):</span><br><span class="line">                            <span class="built_in">setattr</span>(<span class="variable language_">self</span>.config, key, value)</span><br><span class="line">                            </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.warning(<span class="string">f&quot;配置文件加载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_sample_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建示例配置文件&quot;&quot;&quot;</span></span><br><span class="line">        sample_config = &#123;</span><br><span class="line">            <span class="string">&quot;neo4j_url&quot;</span>: <span class="string">&quot;bolt://localhost:7687&quot;</span>,</span><br><span class="line">            <span class="string">&quot;neo4j_username&quot;</span>: <span class="string">&quot;neo4j&quot;</span>,</span><br><span class="line">            <span class="string">&quot;model_name&quot;</span>: <span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">            <span class="string">&quot;model_url&quot;</span>: <span class="string">&quot;https://api-inference.modelscope.cn/v1/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;vector_storage_path&quot;</span>: <span class="string">&quot;research_data&quot;</span>,</span><br><span class="line">            <span class="string">&quot;max_search_results&quot;</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="string">&quot;max_urls_to_process&quot;</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="string">&quot;similarity_threshold&quot;</span>: <span class="number">0.3</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.config_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(sample_config, f, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;已创建示例配置文件: <span class="subst">&#123;self.config_file&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_config_status</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示配置状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;\n🔧 系统配置状态:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># API密钥状态</span></span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">&quot;📋 API密钥配置:&quot;</span>)</span><br><span class="line">        api_keys = [</span><br><span class="line">            (<span class="string">&quot;AgentOps&quot;</span>, <span class="variable language_">self</span>.config.agentops_api_key),</span><br><span class="line">            (<span class="string">&quot;Firecrawl&quot;</span>, <span class="variable language_">self</span>.config.firecrawl_api_key),</span><br><span class="line">            (<span class="string">&quot;ModelScope&quot;</span>, <span class="variable language_">self</span>.config.modelscope_api_key),</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> name, key <span class="keyword">in</span> api_keys:</span><br><span class="line">            <span class="keyword">if</span> key:</span><br><span class="line">                masked_key = key[:<span class="number">8</span>] + <span class="string">&quot;...&quot;</span> + key[-<span class="number">4</span>:] <span class="keyword">if</span> <span class="built_in">len</span>(key) &gt; <span class="number">12</span> <span class="keyword">else</span> <span class="string">&quot;***&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;  ✅ <span class="subst">&#123;name&#125;</span>: <span class="subst">&#123;masked_key&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;  ❌ <span class="subst">&#123;name&#125;</span>: 未配置&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Neo4j配置状态</span></span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">&quot;\n🗄️ Neo4j配置:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;  URL: <span class="subst">&#123;self.config.neo4j_url&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;  用户名: <span class="subst">&#123;self.config.neo4j_username&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.config.neo4j_password:</span><br><span class="line">            <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;  ✅ 密码: <span class="subst">&#123;<span class="string">&#x27;*&#x27;</span> * <span class="built_in">len</span>(self.config.neo4j_password)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;  ❌ 密码: 未配置&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">50</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_api_connections</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试API连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;\n🔗 测试API连接:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试Firecrawl API</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.config.firecrawl_api_key:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">from</span> camel.loaders <span class="keyword">import</span> Firecrawl</span><br><span class="line">                firecrawl = Firecrawl()</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ Firecrawl API: 连接正常&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ Firecrawl API: <span class="subst">&#123;<span class="built_in">str</span>(e)[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试ModelScope API</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.config.modelscope_api_key:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                model = ModelFactory.create(</span><br><span class="line">                    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">                    model_type=<span class="variable language_">self</span>.config.model_name,</span><br><span class="line">                    url=<span class="variable language_">self</span>.config.model_url,</span><br><span class="line">                    api_key=<span class="variable language_">self</span>.config.modelscope_api_key</span><br><span class="line">                )</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ ModelScope API: 连接正常&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ ModelScope API: <span class="subst">&#123;<span class="built_in">str</span>(e)[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">40</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SearchEngine</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;统一的搜索引擎类&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: ResearchConfig</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.search_toolkit = SearchToolkit()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">duckduckgo_lite_search</span>(<span class="params">self, query: <span class="built_in">str</span>, max_results: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;使用DuckDuckGo Lite API进行搜索&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> max_results <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            max_results = <span class="variable language_">self</span>.config.max_search_results</span><br><span class="line">            </span><br><span class="line">        url = <span class="string">f&quot;https://lite.duckduckgo.com/lite/?q=<span class="subst">&#123;query.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;+&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url, headers=headers, timeout=<span class="number">10</span>)</span><br><span class="line">            resp.raise_for_status()</span><br><span class="line">            soup = BeautifulSoup(resp.text, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            results = []</span><br><span class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> soup.select(<span class="string">&quot;a[href*=&#x27;http&#x27;]&quot;</span>)[:max_results]:</span><br><span class="line">                href = link.get(<span class="string">&quot;href&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                text = link.get_text(strip=<span class="literal">True</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> href <span class="keyword">and</span> text <span class="keyword">and</span> <span class="built_in">len</span>(text) &gt; <span class="number">10</span>:</span><br><span class="line">                    results.append(&#123;</span><br><span class="line">                        <span class="string">&quot;title&quot;</span>: text[:<span class="number">100</span>],</span><br><span class="line">                        <span class="string">&quot;url&quot;</span>: href,</span><br><span class="line">                        <span class="string">&quot;snippet&quot;</span>: text[:<span class="number">200</span>]</span><br><span class="line">                    &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f&quot;DuckDuckGo Lite搜索失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_web</span>(<span class="params">self, query: <span class="built_in">str</span>, topic: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;通用网络搜索功能&quot;&quot;&quot;</span></span><br><span class="line">        search_query = <span class="string">f&quot;<span class="subst">&#123;query&#125;</span> <span class="subst">&#123;topic&#125;</span>&quot;</span>.strip()</span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;🔍 网络搜索: <span class="subst">&#123;search_query&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 首先尝试DuckDuckGo Lite搜索</span></span><br><span class="line">            <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;🔄 使用 DuckDuckGo Lite 搜索...&quot;</span>)</span><br><span class="line">            search_results = <span class="variable language_">self</span>.duckduckgo_lite_search(search_query)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> search_results:</span><br><span class="line">                formatted_results = <span class="string">f&quot;🔍 搜索查询: <span class="subst">&#123;search_query&#125;</span>\n\n&quot;</span></span><br><span class="line">                formatted_results += <span class="string">&quot;🌐 搜索结果:\n&quot;</span></span><br><span class="line">                formatted_results += <span class="string">&quot;=&quot;</span>*<span class="number">50</span> + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                </span><br><span class="line">                urls_found = []</span><br><span class="line">                <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(search_results, <span class="number">1</span>):</span><br><span class="line">                    title = result.get(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;无标题&#x27;</span>)</span><br><span class="line">                    url = result.get(<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;无链接&#x27;</span>)</span><br><span class="line">                    snippet = result.get(<span class="string">&#x27;snippet&#x27;</span>, <span class="string">&#x27;无描述&#x27;</span>)</span><br><span class="line">                    </span><br><span class="line">                    formatted_results += <span class="string">f&quot;<span class="subst">&#123;i&#125;</span>. 📰 <span class="subst">&#123;title&#125;</span>\n&quot;</span></span><br><span class="line">                    formatted_results += <span class="string">f&quot;   📝 <span class="subst">&#123;snippet&#125;</span>\n&quot;</span></span><br><span class="line">                    formatted_results += <span class="string">f&quot;   🔗 <span class="subst">&#123;url&#125;</span>\n\n&quot;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> url != <span class="string">&#x27;无链接&#x27;</span>:</span><br><span class="line">                        urls_found.append(url)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> urls_found:</span><br><span class="line">                    formatted_results += <span class="string">&quot;\n📎 发现的相关URL:\n&quot;</span></span><br><span class="line">                    <span class="keyword">for</span> url <span class="keyword">in</span> urls_found[:<span class="variable language_">self</span>.config.max_urls_to_process]:</span><br><span class="line">                        formatted_results += <span class="string">f&quot;- <span class="subst">&#123;url&#125;</span>\n&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;✅ 搜索完成，找到 <span class="subst">&#123;<span class="built_in">len</span>(search_results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> formatted_results</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">&quot;DuckDuckGo Lite 未返回结果&quot;</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;⚠️ 主搜索方法失败: <span class="subst">&#123;<span class="built_in">str</span>(e)[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 备用搜索方法</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">&quot;🔄 尝试备用搜索方法...&quot;</span>)</span><br><span class="line">                search_results = <span class="variable language_">self</span>.search_toolkit.search_duckduckgo(search_query)</span><br><span class="line">                </span><br><span class="line">                formatted_results = <span class="string">f&quot;🔍 搜索查询: <span class="subst">&#123;search_query&#125;</span>\n\n&quot;</span></span><br><span class="line">                formatted_results += <span class="string">&quot;🌐 搜索结果 (备用方法):\n&quot;</span></span><br><span class="line">                formatted_results += <span class="string">&quot;=&quot;</span>*<span class="number">50</span> + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(search_results, <span class="built_in">list</span>):</span><br><span class="line">                    <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(search_results[:<span class="variable language_">self</span>.config.max_search_results], <span class="number">1</span>):</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(result, <span class="built_in">dict</span>):</span><br><span class="line">                            title = result.get(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;无标题&#x27;</span>)</span><br><span class="line">                            snippet = result.get(<span class="string">&#x27;snippet&#x27;</span>, <span class="string">&#x27;无描述&#x27;</span>)</span><br><span class="line">                            link = result.get(<span class="string">&#x27;link&#x27;</span>, <span class="string">&#x27;无链接&#x27;</span>)</span><br><span class="line">                            formatted_results += <span class="string">f&quot;<span class="subst">&#123;i&#125;</span>. <span class="subst">&#123;title&#125;</span>\n   <span class="subst">&#123;snippet&#125;</span>\n   链接: <span class="subst">&#123;link&#125;</span>\n\n&quot;</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            formatted_results += <span class="string">f&quot;<span class="subst">&#123;i&#125;</span>. <span class="subst">&#123;<span class="built_in">str</span>(result)[:<span class="number">200</span>]&#125;</span>...\n\n&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> formatted_results</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> backup_e:</span><br><span class="line">                error_msg = <span class="string">f&quot;所有搜索方法都失败了: <span class="subst">&#123;<span class="built_in">str</span>(backup_e)[:<span class="number">100</span>]&#125;</span>...&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + error_msg)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">f&quot;搜索查询: <span class="subst">&#123;search_query&#125;</span>\n\n搜索服务暂时不可用，请稍后重试。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UniversalResearchSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;通用研究系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_manager: ConfigManager</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config_manager.config</span><br><span class="line">        <span class="variable language_">self</span>._init_components()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_components</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化系统组件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 基础组件</span></span><br><span class="line">        <span class="variable language_">self</span>.firecrawl = Firecrawl()</span><br><span class="line">        <span class="variable language_">self</span>.auto_retriever = AutoRetriever(</span><br><span class="line">            vector_storage_local_path=<span class="variable language_">self</span>.config.vector_storage_path,</span><br><span class="line">            storage_type=StorageType.QDRANT,</span><br><span class="line">            embedding_model=SentenceTransformerEncoder(),</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.search_engine = SearchEngine(<span class="variable language_">self</span>.config)</span><br><span class="line">        <span class="variable language_">self</span>.uio = UnstructuredIO()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 知识图谱组件</span></span><br><span class="line">        <span class="variable language_">self</span>.neo4j_graph = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.kg_agent = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._init_knowledge_graph()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_knowledge_graph</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化知识图谱组件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.config.neo4j_password:</span><br><span class="line">            <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;⚠️ Neo4j密码未配置，将使用文本格式知识图谱&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(Fore.BLUE + <span class="string">&quot;🔗 尝试连接Neo4j数据库...&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">import</span> neo4j</span><br><span class="line">            driver = neo4j.GraphDatabase.driver(</span><br><span class="line">                <span class="variable language_">self</span>.config.neo4j_url,</span><br><span class="line">                auth=(<span class="variable language_">self</span>.config.neo4j_username, <span class="variable language_">self</span>.config.neo4j_password)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 验证连接</span></span><br><span class="line">            <span class="keyword">with</span> driver.session() <span class="keyword">as</span> session:</span><br><span class="line">                result = session.run(<span class="string">&quot;RETURN 1 as test&quot;</span>)</span><br><span class="line">                test_value = result.single()[<span class="string">&quot;test&quot;</span>]</span><br><span class="line">                <span class="keyword">if</span> test_value == <span class="number">1</span>:</span><br><span class="line">                    <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ Neo4j连接测试成功&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            driver.close()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 初始化CAMEL的Neo4j组件</span></span><br><span class="line">            <span class="variable language_">self</span>.neo4j_graph = Neo4jGraph(</span><br><span class="line">                url=<span class="variable language_">self</span>.config.neo4j_url,</span><br><span class="line">                username=<span class="variable language_">self</span>.config.neo4j_username,</span><br><span class="line">                password=<span class="variable language_">self</span>.config.neo4j_password,</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 需要模型才能初始化KG Agent</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;model&#x27;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.model:</span><br><span class="line">                <span class="variable language_">self</span>.kg_agent = KnowledgeGraphAgent(model=<span class="variable language_">self</span>.model)</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ 知识图谱组件初始化成功&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;❌ neo4j驱动未安装，请运行: pip install neo4j&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ Neo4j连接失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;💡 将使用文本格式知识图谱&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResearchToolkit</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;研究工具包&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, research_system: UniversalResearchSystem</span>):</span><br><span class="line">        <span class="variable language_">self</span>.system = research_system</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_information_from_urls</span>(<span class="params">self, urls: <span class="type">List</span>[<span class="built_in">str</span>], query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从URL列表中检索相关信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;开始检索: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;数据源: <span class="subst">&#123;<span class="built_in">len</span>(urls)&#125;</span> 个URL&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        aggregated_content = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 限制处理的URL数量</span></span><br><span class="line">        urls_to_process = urls[:<span class="variable language_">self</span>.system.config.max_urls_to_process]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, url <span class="keyword">in</span> <span class="built_in">enumerate</span>(urls_to_process, <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(Fore.CYAN + <span class="string">f&quot;抓取 <span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(urls_to_process)&#125;</span>: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">                scraped_content = <span class="variable language_">self</span>.system.firecrawl.scrape(url)</span><br><span class="line">                aggregated_content += scraped_content[<span class="string">&quot;markdown&quot;</span>] + <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;成功抓取 <span class="subst">&#123;<span class="built_in">len</span>(scraped_content[<span class="string">&#x27;markdown&#x27;</span>])&#125;</span> 字符&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;抓取失败: <span class="subst">&#123;<span class="built_in">str</span>(e)[:<span class="number">100</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> aggregated_content.strip():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;所有 URL 都抓取失败，无法继续处理&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            retrieved_info = <span class="variable language_">self</span>.system.auto_retriever.run_vector_retriever(</span><br><span class="line">                query=query,</span><br><span class="line">                contents=aggregated_content,</span><br><span class="line">                top_k=<span class="number">5</span>,</span><br><span class="line">                similarity_threshold=<span class="variable language_">self</span>.system.config.similarity_threshold,</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            result = <span class="string">f&quot;检索查询: <span class="subst">&#123;retrieved_info[<span class="string">&#x27;Original Query&#x27;</span>]&#125;</span>\n\n&quot;</span></span><br><span class="line">            result += <span class="string">&quot;相关信息:\n&quot;</span></span><br><span class="line">            <span class="keyword">for</span> i, context <span class="keyword">in</span> <span class="built_in">enumerate</span>(retrieved_info[<span class="string">&#x27;Retrieved Context&#x27;</span>], <span class="number">1</span>):</span><br><span class="line">                result += <span class="string">f&quot;<span class="subst">&#123;i&#125;</span>. <span class="subst">&#123;context[:<span class="number">300</span>]&#125;</span>...\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;检索失败: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_web_for_topic</span>(<span class="params">self, query: <span class="built_in">str</span>, topic: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据主题搜索网络信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.system.search_engine.search_web(query, topic)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_knowledge_graph</span>(<span class="params">self, text_input: <span class="built_in">str</span>, topic: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;构建知识图谱&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.system.neo4j_graph <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.system.kg_agent:</span><br><span class="line">            <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;Neo4j未配置，创建文本格式知识图谱...&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            kg_result = <span class="string">f&quot;知识图谱（文本格式） - 主题: <span class="subst">&#123;topic&#125;</span>\n&quot;</span></span><br><span class="line">            kg_result += <span class="string">&quot;=&quot;</span>*<span class="number">50</span> + <span class="string">&quot;\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 简单的实体提取逻辑</span></span><br><span class="line">            lines = text_input.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            entities = []</span><br><span class="line">            relationships = []</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(line.strip()) &gt; <span class="number">10</span>:  <span class="comment"># 过滤短行</span></span><br><span class="line">                    words = line.split()</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(words) &gt; <span class="number">3</span>:  <span class="comment"># 寻找可能的实体</span></span><br><span class="line">                        <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(word) &gt; <span class="number">4</span> <span class="keyword">and</span> word.isalpha():</span><br><span class="line">                                entities.append(word)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 去重并限制数量</span></span><br><span class="line">            entities = <span class="built_in">list</span>(<span class="built_in">set</span>(entities))[:<span class="number">10</span>]</span><br><span class="line">            </span><br><span class="line">            kg_result += <span class="string">&quot;主要实体:\n&quot;</span></span><br><span class="line">            <span class="keyword">for</span> entity <span class="keyword">in</span> entities:</span><br><span class="line">                kg_result += <span class="string">f&quot;- <span class="subst">&#123;entity&#125;</span>\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            kg_result += <span class="string">f&quot;\n关系网络:\n&quot;</span></span><br><span class="line">            kg_result += <span class="string">f&quot;- 主题: <span class="subst">&#123;topic&#125;</span>\n&quot;</span></span><br><span class="line">            kg_result += <span class="string">f&quot;- 相关实体数量: <span class="subst">&#123;<span class="built_in">len</span>(entities)&#125;</span>\n&quot;</span></span><br><span class="line">            kg_result += <span class="string">f&quot;- 文本长度: <span class="subst">&#123;<span class="built_in">len</span>(text_input)&#125;</span> 字符\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> kg_result</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;开始构建知识图谱 - 主题: <span class="subst">&#123;topic&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            element_example = <span class="variable language_">self</span>.system.uio.create_element_from_text(</span><br><span class="line">                text=text_input,</span><br><span class="line">                element_id=<span class="string">f&quot;research_<span class="subst">&#123;topic&#125;</span>_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            graph_elements = <span class="variable language_">self</span>.system.kg_agent.run(element_example, parse_graph_elements=<span class="literal">True</span>)</span><br><span class="line">            <span class="variable language_">self</span>.system.neo4j_graph.add_graph_elements(graph_elements=[graph_elements])</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;知识图谱构建完成&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;知识图谱构建成功 - 主题: <span class="subst">&#123;topic&#125;</span>\n提取了图形元素: <span class="subst">&#123;<span class="built_in">str</span>(graph_elements)[:<span class="number">200</span>]&#125;</span>...&quot;</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_msg = <span class="string">f&quot;知识图谱构建失败: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + error_msg)</span><br><span class="line">            <span class="keyword">return</span> error_msg</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InteractiveResearchSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;交互式研究系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config_manager = ConfigManager()</span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.research_system = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.toolkit = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._init_system()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_system</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化系统&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 显示配置状态</span></span><br><span class="line">        <span class="variable language_">self</span>.config_manager.display_config_status()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试API连接</span></span><br><span class="line">        <span class="variable language_">self</span>.config_manager.test_api_connections()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查配置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._check_config():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化模型</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._init_model():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化研究系统</span></span><br><span class="line">        <span class="variable language_">self</span>.research_system = UniversalResearchSystem(<span class="variable language_">self</span>.config_manager)</span><br><span class="line">        <span class="variable language_">self</span>.research_system.model = <span class="variable language_">self</span>.model  <span class="comment"># 为知识图谱组件提供模型</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新初始化知识图谱（现在有模型了）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.research_system.neo4j_graph <span class="keyword">and</span> <span class="keyword">not</span> <span class="variable language_">self</span>.research_system.kg_agent:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.research_system.kg_agent = KnowledgeGraphAgent(model=<span class="variable language_">self</span>.model)</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ 知识图谱代理初始化成功&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;知识图谱代理初始化失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.toolkit = ResearchToolkit(<span class="variable language_">self</span>.research_system)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化AgentOps</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.config_manager.config.agentops_api_key:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                agentops.init(</span><br><span class="line">                    api_key=<span class="variable language_">self</span>.config_manager.config.agentops_api_key,</span><br><span class="line">                    default_tags=[<span class="string">&quot;Universal Research&quot;</span>, <span class="string">&quot;Interactive&quot;</span>]</span><br><span class="line">                )</span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ AgentOps初始化成功&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;AgentOps初始化失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_config</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查配置完整性&quot;&quot;&quot;</span></span><br><span class="line">        missing_configs = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.config_manager.config.modelscope_api_key:</span><br><span class="line">            missing_configs.append(<span class="string">&quot;MODELSCOPE_SDK_TOKEN&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> missing_configs:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;❌ 缺少必要的环境变量配置:&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> config <span class="keyword">in</span> missing_configs:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;   <span class="subst">&#123;config&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.config_manager.config_file.exists():</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">&quot;\n📝 创建示例配置文件...&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.config_manager.create_sample_config()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_model</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.model = ModelFactory.create(</span><br><span class="line">                model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">                model_type=<span class="variable language_">self</span>.config_manager.config.model_name,</span><br><span class="line">                url=<span class="variable language_">self</span>.config_manager.config.model_url,</span><br><span class="line">                api_key=<span class="variable language_">self</span>.config_manager.config.modelscope_api_key</span><br><span class="line">            )</span><br><span class="line">            <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;✅ 模型初始化成功: <span class="subst">&#123;self.config_manager.config.model_name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 模型初始化失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_research_tools</span>(<span class="params">self, topic: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[FunctionTool]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;为特定主题创建研究工具&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">retrieve_urls_for_topic</span>(<span class="params">urls: <span class="type">List</span>[<span class="built_in">str</span>], query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.toolkit.retrieve_information_from_urls(urls, query)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">search_topic_info</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.toolkit.search_web_for_topic(query, topic)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">build_topic_knowledge_graph</span>(<span class="params">text_input: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.toolkit.build_knowledge_graph(text_input, topic)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            FunctionTool(retrieve_urls_for_topic),</span><br><span class="line">            FunctionTool(search_topic_info),</span><br><span class="line">            FunctionTool(build_topic_knowledge_graph),</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_research_task</span>(<span class="params">self, topic: <span class="built_in">str</span>, research_question: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建研究任务提示&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">对&quot;<span class="subst">&#123;topic&#125;</span>&quot;进行全面研究，专门回答以下问题：&quot;<span class="subst">&#123;research_question&#125;</span>&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请按照以下步骤进行系统性研究：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. **信息搜索阶段**</span></span><br><span class="line"><span class="string">   - 使用搜索工具获取与&quot;<span class="subst">&#123;topic&#125;</span>&quot;和&quot;<span class="subst">&#123;research_question&#125;</span>&quot;相关的URL和基础信息</span></span><br><span class="line"><span class="string">   - 识别最相关和权威的信息源</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. **深度检索阶段**</span></span><br><span class="line"><span class="string">   - 使用检索工具从找到的URL中获取详细内容</span></span><br><span class="line"><span class="string">   - 重点关注能够回答研究问题的信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. **分析整理阶段**</span></span><br><span class="line"><span class="string">   - 系统分析所有收集到的信息</span></span><br><span class="line"><span class="string">   - 识别关键事实、数据和观点</span></span><br><span class="line"><span class="string">   - 评估信息的可靠性和相关性</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. **报告撰写阶段**</span></span><br><span class="line"><span class="string">   - 撰写一份全面的研究报告</span></span><br><span class="line"><span class="string">   - 确保报告直接回答了研究问题</span></span><br><span class="line"><span class="string">   - 提供具体的事实支撑和数据引用</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">5. **知识图谱构建阶段**</span></span><br><span class="line"><span class="string">   - 使用知识图谱工具为报告内容构建结构化的知识图谱</span></span><br><span class="line"><span class="string">   - 展示关键概念之间的关系</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">研究重点：</span></span><br><span class="line"><span class="string">- 主题: <span class="subst">&#123;topic&#125;</span></span></span><br><span class="line"><span class="string">- 核心问题: <span class="subst">&#123;research_question&#125;</span></span></span><br><span class="line"><span class="string">- 确保信息的准确性和时效性</span></span><br><span class="line"><span class="string">- 提供多角度的分析视角</span></span><br><span class="line"><span class="string">- 包含具体的案例和数据支撑</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请系统性地完成上述研究任务，提供高质量的研究成果。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_interactive_research</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行交互式研究&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.model <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.research_system:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;❌ 系统未正确初始化，无法运行&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;🚀 通用AI研究系统&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 获取用户输入</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;\n请输入研究信息:&quot;</span>)</span><br><span class="line">                topic = <span class="built_in">input</span>(Fore.CYAN + <span class="string">&quot;研究主题: &quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> topic:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                research_question = <span class="built_in">input</span>(Fore.CYAN + <span class="string">&quot;具体问题: &quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> research_question:</span><br><span class="line">                    research_question = <span class="string">f&quot;关于<span class="subst">&#123;topic&#125;</span>的综合信息&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;\n📋 开始研究:&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;   主题: <span class="subst">&#123;topic&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;   问题: <span class="subst">&#123;research_question&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 创建研究工具和任务</span></span><br><span class="line">                tools = <span class="variable language_">self</span>.create_research_tools(topic)</span><br><span class="line">                task_prompt = <span class="variable language_">self</span>.create_research_task(topic, research_question)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 创建角色扮演系统</span></span><br><span class="line">                role_play_session = RolePlaying(</span><br><span class="line">                    assistant_role_name=<span class="string">&quot;AI研究助理&quot;</span>,</span><br><span class="line">                    user_role_name=<span class="string">&quot;研究用户&quot;</span>,</span><br><span class="line">                    assistant_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">                        model=<span class="variable language_">self</span>.model,</span><br><span class="line">                        tools=tools,</span><br><span class="line">                    ),</span><br><span class="line">                    user_agent_kwargs=<span class="built_in">dict</span>(model=<span class="variable language_">self</span>.model),</span><br><span class="line">                    task_prompt=task_prompt,</span><br><span class="line">                    with_task_specify=<span class="literal">False</span>,</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 执行研究</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;🤖 AI助理: <span class="subst">&#123;role_play_session.assistant_sys_msg.content[:<span class="number">100</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;👤 用户: <span class="subst">&#123;role_play_session.user_sys_msg.content[:<span class="number">100</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                input_msg = role_play_session.init_chat()</span><br><span class="line">                chat_turn_limit = <span class="number">8</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(chat_turn_limit):</span><br><span class="line">                    <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">f&quot;\n--- 研究轮次 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> ---&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> assistant_response.terminated <span class="keyword">or</span> user_response.terminated:</span><br><span class="line">                            <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;✅ 研究任务完成&quot;</span>)</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># 显示进度</span></span><br><span class="line">                        <span class="built_in">print</span>(Fore.CYAN + <span class="string">f&quot;🔄 助理: <span class="subst">&#123;assistant_response.msg.content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;🔄 用户: <span class="subst">&#123;user_response.msg.content[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                        </span><br><span class="line">                        input_msg = assistant_response.msg</span><br><span class="line">                        time.sleep(<span class="number">1</span>)  <span class="comment"># 避免请求过快</span></span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;研究过程出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 询问是否继续</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">                continue_research = <span class="built_in">input</span>(Fore.CYAN + <span class="string">&quot;是否继续新的研究? (y/n): &quot;</span>).strip().lower()</span><br><span class="line">                <span class="keyword">if</span> continue_research != <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;\n用户中断研究&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;系统错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;\n👋 感谢使用通用AI研究系统！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(Fore.CYAN + <span class="string">&quot;🎯 通用AI研究系统启动&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">50</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        research_system = InteractiveResearchSystem()</span><br><span class="line">        research_system.run_interactive_research()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 系统启动失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;💡 请检查配置和依赖项&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h5 id="我们运行一下整个系统，分别测试一下各个检索功能的差异："><a href="#我们运行一下整个系统，分别测试一下各个检索功能的差异：" class="headerlink" title="我们运行一下整个系统，分别测试一下各个检索功能的差异："></a>我们运行一下整个系统，分别测试一下各个检索功能的差异：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">PS G:\Python-Camel-project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe g:/Python-Camel-project/Multimodal_RAG/Interactive_Multimodal_RAG.py</span><br><span class="line">W0725 14:45:52.142000 34656 site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported in Windows or MacOs.   </span><br><span class="line">Web research system available</span><br><span class="line">初始化交互式多模态RAG系统...</span><br><span class="line">Initializing Simple RAG System with CAMEL...</span><br><span class="line">CAMEL LLM initialized: Qwen/Qwen2.5-72B-Instruct</span><br><span class="line">API key: 64af0689-2...16a3</span><br><span class="line">√ Embedding model loaded: intfloat/e5-large-v2</span><br><span class="line">√ Simple vector retriever initialized</span><br><span class="line">√ Simple RAG System initialized successfully!</span><br><span class="line">√ 集成CAMEL的RAG系统初始化成功</span><br><span class="line"></span><br><span class="line">🔧 系统配置状态:</span><br><span class="line">==================================================</span><br><span class="line">📋 API密钥配置:</span><br><span class="line">  ✅ AgentOps: 3e6edf79...444d</span><br><span class="line">  ✅ Firecrawl: fc-58764...87c2</span><br><span class="line">  ✅ ModelScope: 64af0689...16a3</span><br><span class="line"></span><br><span class="line">🗄️ Neo4j配置:</span><br><span class="line">  URL: bolt://localhost:7687</span><br><span class="line">  用户名: neo4j</span><br><span class="line">  ✅ 密码: ***********</span><br><span class="line">==================================================</span><br><span class="line"></span><br><span class="line">🔗 测试API连接:</span><br><span class="line">========================================</span><br><span class="line">✅ Firecrawl API: 连接正常</span><br><span class="line">✅ ModelScope API: 连接正常</span><br><span class="line">========================================</span><br><span class="line">✅ 模型初始化成功: Qwen/Qwen2.5-72B-Instruct</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_linkup&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;searchResults&#x27;, &#x27;sourcedAnswer&#x27;, &#x27;structured&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;OneDay&#x27;, &#x27;OneWeek&#x27;, &#x27;OneMonth&#x27;, &#x27;OneYear&#x27;, &#x27;NoLimit&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;anyOf&#x27;: [&#123;&#x27;enum&#x27;: [&#x27;finance&#x27;, &#x27;law&#x27;, &#x27;medical&#x27;, &#x27;internet&#x27;, &#x27;tax&#x27;, &#x27;news_province&#x27;, &#x27;news_center&#x27;], &#x27;type&#x27;: &#x27;string&#x27;&#125;, &#123;&#x27;type&#x27;: &#x27;null&#x27;&#125;], &#x27;type&#x27;: [&#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">🔗 尝试连接Neo4j数据库...</span><br><span class="line">✅ Neo4j连接测试成功</span><br><span class="line">✅ 知识图谱代理初始化成功</span><br><span class="line">🖇 AgentOps:  WARNING: agentops is out of date. Please update with the command: &#x27;pip install --upgrade agentops&#x27;</span><br><span class="line">🖇 AgentOps: Session Replay: https://app.agentops.ai/drilldown?session_id=1daa3df4-89ba-4a7a-a1f9-991c342edb8b</span><br><span class="line">✅ AgentOps初始化成功</span><br><span class="line">√ 网页研究系统初始化成功</span><br><span class="line"></span><br><span class="line">交互式多模态RAG系统</span><br><span class="line">============================================================</span><br><span class="line">功能特性:</span><br><span class="line">- 支持在线/本地PDF加载</span><br><span class="line">- 三种检索模式</span><br><span class="line">- 网页爬取集成</span><br><span class="line">- 多模态内容处理</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">PDF知识库设置</span><br><span class="line">==================================================</span><br><span class="line">1. 在线PDF (输入URL)</span><br><span class="line">2. 本地PDF (输入文件路径)</span><br><span class="line">3. 使用默认示例PDF</span><br><span class="line"></span><br><span class="line">请选择PDF来源 (1-3): 2</span><br><span class="line">请输入PDF文件路径: G:\Program for work\Other\CamelAgent.pdf  </span><br><span class="line">状态查询： 正在加载本地PDF: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">Loading PDF from: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">√ PDF loaded successfully</span><br><span class="line">Computing embeddings for 1839 documents...</span><br><span class="line">Added 1839 documents to retriever</span><br><span class="line">√ Knowledge base setup complete: 1839 elements</span><br><span class="line"> Content: 1839 text, 0 images, 0 tables</span><br><span class="line">√ PDF知识库加载成功！</span><br><span class="line"></span><br><span class="line">当前知识库: 本地PDF: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">🔧 可用检索方法: Vector, Enhanced</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">查询选项</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>
<h5 id="我们可以看到系统启动成功，本地PDF文件也成功加载了，现在我们先进行快速检索的演示"><a href="#我们可以看到系统启动成功，本地PDF文件也成功加载了，现在我们先进行快速检索的演示" class="headerlink" title="我们可以看到系统启动成功，本地PDF文件也成功加载了，现在我们先进行快速检索的演示:"></a>我们可以看到系统启动成功，本地PDF文件也成功加载了，现在我们先进行快速检索的演示:</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">请输入您的问题 (输入 &#x27;quit&#x27; 退出, &#x27;reload&#x27; 重新加载PDF): camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line"></span><br><span class="line">选择检索模式:</span><br><span class="line">1. 快速检索 (基础向量检索)</span><br><span class="line">2. 深度检索 (重写+HyDE+RRF)</span><br><span class="line">3. 主题检索 (PDF+网页爬取)</span><br><span class="line">请选择模式 (1-3): 1</span><br><span class="line"></span><br><span class="line">执行查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">检索模式: 快速检索</span><br><span class="line"></span><br><span class="line">执行快速检索...</span><br><span class="line">========================================</span><br><span class="line">正在进行向量检索...</span><br><span class="line">Retrieved 3 documents</span><br><span class="line">√ 检索到 3 个相关文档</span><br><span class="line">文档 1 (相似度: 0.910):</span><br><span class="line">   结语 恭喜您！在阅读到这里时，您已经掌握了 CAMEL-AI 应用开发框架的基础知识，并能够利 用 Agent 实例在您的代码逻辑中执行复杂的任务。此外，您还可以尝试将 Agent 实例整合 到更复杂的工作流中，或实现 Agent 实例之间的协同工作。</span><br><span class="line"></span><br><span class="line">文档 2 (相似度: 0.910):</span><br><span class="line">   为什么选择 CAMEL Multi-Agent？ 选择 CAMEL Multi-Agent 框架，你将获得以下优势：   </span><br><span class="line"></span><br><span class="line">文档 3 (相似度: 0.902):</span><br><span class="line">   Model 是 Agent 的大脑，负责处理所有输入和输出数据。通过有效调用不同的模型，智能  体可以根据任务需求执行文本分析、图像识别和复杂推理等操作。CAMEL 提供了一系列标      </span><br><span class="line"></span><br><span class="line">正在生成答案...</span><br><span class="line">Generating response with CAMEL model...</span><br><span class="line">CAMEL generation failed, using fallback: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">API调用 1/3...</span><br><span class="line">√ API调用成功</span><br><span class="line">√ 快速检索完成</span><br><span class="line"></span><br><span class="line">==================== 快速检索结果 ====================</span><br><span class="line">原结始查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">检索方法: Quick Vector Retrieval</span><br><span class="line"></span><br><span class="line">检索到的文档 (共3个):</span><br><span class="line"></span><br><span class="line">文档 1:</span><br><span class="line">相关度分数: 0.9104779362678528</span><br><span class="line">内容预览: 结语 恭喜您！在阅读到这里时，您已经掌握了 CAMEL-AI 应用开发框架的基础知识 ，并能够利 用 Agent 实例在您的代码逻辑中执行复杂的任务。此外，您还可以尝试将 Agent  实例整合 到更复杂的工作流中，或实现 Agent 实例之间的协同工作。</span><br><span class="line"></span><br><span class="line">文档 2:</span><br><span class="line">相关度分数: 0.9104548692703247</span><br><span class="line">内容预览: 为什么选择 CAMEL Multi-Agent？ 选择 CAMEL Multi-Agent 框架，你将获得以下优势：</span><br><span class="line"></span><br><span class="line">文档 3:</span><br><span class="line">相关度分数: 0.9016962051391602</span><br><span class="line">内容预览: Model 是 Agent 的大脑，负责处理所有输入和输出数据。通过有效调用不同的模型 ，智能 体可以根据任务需求执行文本分析、图像识别和复杂推理等操作。CAMEL 提供了一系列 标</span><br><span class="line"></span><br><span class="line">💡 生成答案:</span><br><span class="line">CAMEL Agent框架的特性包括：</span><br><span class="line"></span><br><span class="line">1. **多智能体协作**：支持多个Agent实例之间的协同工作，以完成更复杂的任务。</span><br><span class="line">2. **灵活的任务处理能力**：通过Model（智能体的大脑）处理所有输入和输出数据，能够根据任务需求执行多种操作。</span><br><span class="line"></span><br><span class="line">可以调用的工具包括：</span><br><span class="line"></span><br><span class="line">- **文本分析**：处理和理解文本数据。</span><br><span class="line">- **图像识别**：识别和分析图像内容。</span><br><span class="line">- **复杂推理**：进行复杂的逻辑推理和决策。</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">询问：是否保存结果到文件？(y/n): n</span><br><span class="line"></span><br><span class="line">是否继续查询？(y/n): y</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">查询选项</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>
<h5 id="接着我们测试深度检索的效果"><a href="#接着我们测试深度检索的效果" class="headerlink" title="接着我们测试深度检索的效果"></a>接着我们测试深度检索的效果</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">请输入您的问题 (输入 &#x27;quit&#x27; 退出, &#x27;reload&#x27; 重新加载PDF): camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line"></span><br><span class="line">选择检索模式:</span><br><span class="line">1. 快速检索 (基础向量检索)</span><br><span class="line">2. 深度检索 (重写+HyDE+RRF)</span><br><span class="line">3. 主题检索 (PDF+网页爬取)</span><br><span class="line">请选择模式 (1-3): 2</span><br><span class="line"></span><br><span class="line">执行查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">检索模式: 深度检索</span><br><span class="line"></span><br><span class="line">执行深度检索...</span><br><span class="line">============================================================</span><br><span class="line">开始执行深度RAG查询</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">步骤1: 查询重写</span><br><span class="line">------------------------------</span><br><span class="line">原始查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">Generating response with CAMEL model...</span><br><span class="line">CAMEL generation failed, using fallback: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">API调用 1/3...</span><br><span class="line">√ API调用成功</span><br><span class="line">Query rewritten: camel agent框架具备有什么特性？可以调用哪些工具？ -&gt; Camel Agent框 架的具体特性和可调用的工具有哪些？...</span><br><span class="line">重写查询: Camel Agent框架的具体特性和可调用的工具有哪些？</span><br><span class="line"></span><br><span class="line">步骤2: 文档检索</span><br><span class="line">------------------------------</span><br><span class="line">使用HyDE+RRF组合方法进行检索...</span><br><span class="line">使用RRF算法进行混合检索（HyDE增强向量检索）...</span><br><span class="line">执行HyDE增强向量检索...</span><br><span class="line">Generating response with CAMEL model...</span><br><span class="line">CAMEL generation failed, using fallback: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">API调用 1/3...</span><br><span class="line">√ API调用成功</span><br><span class="line">📝 HyDE document generated: 633 characters</span><br><span class="line">生成的假设文档:</span><br><span class="line">在分布式计算领域，Camel Agent框架因其灵活性和强大的扩展性而受到广泛关注。该框架设计 用于支持复杂环境下的任务调度与资源管理，尤其适用于异构系统中。Camel Agent框架的核心 特性包括但不限于：</span><br><span class="line"></span><br><span class="line">1. **模块化架构**：Camel Agent采用高度模块化的架构设计，允许开发者根据具体需求灵活选择和组合不同的组件。这种设计不仅简化了开发流程，还极大地提高了系统的可维护性和可扩展性。</span><br><span class="line"></span><br><span class="line">2. **丰富的插件支持**：框架内置了多种插件，涵盖了从数据处理到通信协议转换等多个方面 。例如，提供了RESTful API、AMQP (Advanced Message Queuing Protocol) 等多种消息传递机制的支持，以及对JSON、XML等数据格式的解析能力。此外，Camel Agent还支持自定义插件的开发，以满足特定应用场景的需求。</span><br><span class="line"></span><br><span class="line">3. **强大的路由与转换功能**：利用Apache Camel的核心优势，Camel Agent能够实现复杂的消息路由和转换逻辑。通过定义EIPs (Enterprise Integration Patterns)，可以轻松构建高效的数据流处理管道，支持同步/异步调用、错误处理及重试机制等高级特性。</span><br><span class="line"></span><br><span class="line">4. **动态配置与热更新**：Camel Agent支持运行时动态调整配置参数，无需重启服务即可生效，极大提升了运维效率。同时，它也具备热部署能力，允许在不停机的情况下更新应用逻辑或添加新功能</span><br><span class="line">Retrieved 5 documents</span><br><span class="line">✓ HyDE向量检索完成，获得 5 个结果</span><br><span class="line">Retrieved 0 documents</span><br><span class="line">✓ 图像检索完成，获得 0 个结果</span><br><span class="line">Retrieved 0 documents</span><br><span class="line">✓ 表格检索完成，获得 0 个结果</span><br><span class="line">执行BM25检索（使用原始查询）...</span><br><span class="line">Retrieved 5 documents</span><br><span class="line">✓ BM25检索成功，获得 5 个结果</span><br><span class="line">使用RRF算法融合检索结果...</span><br><span class="line">RRF融合完成，共处理 10 个唯一文档，返回前 5 个结果</span><br><span class="line">HyDE+RRF检索完成，返回 10 个文档</span><br><span class="line">文档 1 (RRF分数: 0.9160):</span><br><span class="line">结语 恭喜您！在阅读到这里时，您已经掌握了 CAMEL-AI 应用开发框架的基础知识，并能够利 用 Agent 实例在您的代码逻辑中执行复杂的任务。此外，您还可以尝试将 Agent 实例整合 到 更复杂的工作流中，或实现 Agent 实例之间的协同工作。</span><br><span class="line"></span><br><span class="line">文档 2 (RRF分数: 0.9094):</span><br><span class="line">想象一下，如果没有统一的语言和行为规范，来自不同公司或者基于不同技术背景开发的 AI Agent 就很难顺畅地合作。这会限制 AI Agent 网络的扩展，最终也会限制它们解决更复杂 现实 问题的能力。这种情况有点像互联网早期，各个计算机系统互不兼容，连接非常受限， 导致整 个网络发展缓慢。 一个统一的通信协议不仅仅能解决眼前的互操作问题，更有可能 催生出一个由无数智能体连接而成的巨大网络。在这个网络...</span><br><span class="line"></span><br><span class="line">文档 3 (RRF分数: 0.9136):</span><br><span class="line">评审者 Agent 的 评审标准。如果</span><br><span class="line"></span><br><span class="line">文档 4 (RRF分数: 0.9050):</span><br><span class="line">除了能把工具包转换成 MCP 服务器外，CAMEL 框架还支持一个更强大的功能：把整个 CAMEL 代理（Agent）本身也作为 MCP 服务器发布出去。这意味着，一个你精心配置好的 CAMEL 代理—— 它可能拥有特定的 AI 模型、独特的系统指令（system message），甚至内 置了一些其他的工 具——现在可以作为一个独立的服务运行。然后，任何支持 MCP 协议的 客户端（比如像 Anth...</span><br><span class="line"></span><br><span class="line">文档 5 (RRF分数: 0.9120):</span><br><span class="line">Model 是 Agent 的大脑，负责处理所有输入和输出数据。通过有效调用不同的模型，智能 体可以根据任务需求执行文本分析、图像识别和复杂推理等操作。CAMEL 提供了一系列标</span><br><span class="line"></span><br><span class="line">步骤3: 答案生成</span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line">正在生成最终答案...</span><br><span class="line">Generating response with CAMEL model...</span><br><span class="line">CAMEL generation failed, using fallback: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">API调用 1/3...</span><br><span class="line">√ API调用成功</span><br><span class="line">√ 答案生成成功</span><br><span class="line">最终答案:</span><br><span class="line">### CAMEL Agent框架的特性及可调用工具</span><br><span class="line"></span><br><span class="line">#### 特性</span><br><span class="line"></span><br><span class="line">1. **标准化协议支持**：</span><br><span class="line">   - CAMEL Agent框架支持多种标准化协议，特别是模型上下文协议（MCP）、Agent间协议（A2A）和Agent网络协议（ANP）。这些协议确保了不同AI Agent之间的互操作性和高效协作（文档 内容：“这些协议为解决 AI Agent 在理解上下文、使用工具和相互协作方面的难题提供了有效 的思路。”）。</span><br><span class="line"></span><br><span class="line">2. **高度可扩展性**：</span><br><span class="line">   - CAMEL框架允许开发者将自定义的工具和服务转换成MCP服务，使得这些工具和服务可以被 其他支持MCP协议的客户端识别和使用（文档内容：“除了能把工具包转换成 MCP 服务器外，CAMEL 框架还支持一个更强大的功能：把整个 CAMEL 代理（Agent）本身也作为 MCP 服务器发布出去。”）。</span><br><span class="line"></span><br><span class="line">3. **复杂的多代理交互**：</span><br><span class="line">   - CAMEL框架内置了多代理角色扮演（RolePlaying）模块和“工作组”（Workforce）模块，这些模块可以实现多个代理之间的协同工作，形成复杂的交互场景（文档内容：“其内部一些更复 杂的模块，比如用于实现多代理角色扮演（RolePlaying）的模块，或者用于组织多个代理协同 工作的‘工作组’（Workforce）模块，也计划或者正在被实现为 MCP 服务器。”）。</span><br><span class="line"></span><br><span class="line">4. **代码即提示（Code-as-Prompt）**：</span><br><span class="line">   - CAMEL框架强调编写既清晰易懂又可被AI代理准确理解的代码，这一设计理念有助于提高集成的质量和稳定性（文档内容：“CAMEL 框架中有一个核心的设计哲学叫做‘代码即提示’（Code-as-Prompt）。它强调编写既清晰易懂（对人类开发者而言）又能被 AI 代理准确理解的代码。”）。</span><br><span class="line"></span><br><span class="line">#### 可调用的工具</span><br><span class="line"></span><br><span class="line">1. **文本分析工具**：</span><br><span class="line">   - CAMEL Agent框架支持调用文本分析工具，这些工具可以帮助Agent执行文本分类、情感分 析、关键词提取等任务（文档内容：“通过有效调用不同的模型，智能体可以根据任务需求执行 文本分析、图像识别和复杂推理等操作。”）。</span><br><span class="line"></span><br><span class="line">2. **图像识别工具**：</span><br><span class="line">   - 框架内的Agent可以调用图像识别工具，用于图像分类、目标检测、图像生成等任务。    </span><br><span class="line"></span><br><span class="line">3. **复杂推理工具**：</span><br><span class="line">   - 支持调用复杂推理工具，这些工具可以帮助Agent解决需要多步推理的问题，例如决策树、逻辑推理等。</span><br><span class="line"></span><br><span class="line">4. **自定义工具和服务**：</span><br><span class="line">   - 开发者可以将自己开发的工具和服务转换成MCP服务，这些服务可以被其他支持MCP协议的 客户端调用，从而实现更广泛的应用（文档内容：“这意味着，一个你精心配置好的 CAMEL 代理——它可能拥有特定的 AI 模型、独特的系统指令（system message），甚至内置了一些其他的工具——现在可以作为一个独立的服务运行。”）。</span><br><span class="line"></span><br><span class="line">通过上述特性和工具的支持，CAMEL Agent框架不仅能够实现单一Agent的强大功能，还能促进不同Agent之间的协同工作，形成一个高效的AI生态系统。</span><br><span class="line"></span><br><span class="line">==================== 深度检索结果 ====================</span><br><span class="line">原结始查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">重写查询: Camel Agent框架的具体特性和可调用的工具有哪些？</span><br><span class="line">检索方法: Vector+Rewriting+HyDE+Image+Table+RRF</span><br><span class="line"></span><br><span class="line">检索到的文档 (共5个):</span><br><span class="line"></span><br><span class="line">文档 1:</span><br><span class="line">相关度分数: 0.01639344262295082</span><br><span class="line">内容预览: 结语 恭喜您！在阅读到这里时，您已经掌握了 CAMEL-AI 应用开发框架的基础知识 ，并能够利 用 Agent 实例在您的代码逻辑中执行复杂的任务。此外，您还可以尝试将 Agent  实例整合 到更复杂的工作流中，或实现 Agent 实例之间的协同工作。</span><br><span class="line"></span><br><span class="line">文档 2:</span><br><span class="line">相关度分数: 0.01639344262295082</span><br><span class="line">内容预览: 想象一下，如果没有统一的语言和行为规范，来自不同公司或者基于不同技术背景开发的 AI Agent 就很难顺畅地合作。这会限制 AI Agent 网络的扩展，最终也会限制它们解决更复杂 现实问题的能力。这种情况有点像互联网早期，各个计算机系统互不兼容，连接非常受限 ， 导致整个网络发展缓慢。 一个统一的通信协议不仅仅能解决眼前的互操作问题，更有可能  催生出一个由无数智能体连接而成的巨大网络。在这个网络...</span><br><span class="line"></span><br><span class="line">文档 3:</span><br><span class="line">相关度分数: 0.016129032258064516</span><br><span class="line">内容预览: 评审者 Agent 的 评审标准。如果</span><br><span class="line"></span><br><span class="line">文档 4:</span><br><span class="line">相关度分数: 0.016129032258064516</span><br><span class="line">内容预览: 除了能把工具包转换成 MCP 服务器外，CAMEL 框架还支持一个更强大的功能：把整 个 CAMEL 代理（Agent）本身也作为 MCP 服务器发布出去。这意味着，一个你精心配置好的 CAMEL 代理——它可能拥有特定的 AI 模型、独特的系统指令（system message），甚至内 置了一 些其他的工具——现在可以作为一个独立的服务运行。然后，任何支持 MCP 协议的 客户端（比如像 Anth...</span><br><span class="line"></span><br><span class="line">文档 5:</span><br><span class="line">相关度分数: 0.015873015873015872</span><br><span class="line">内容预览: Model 是 Agent 的大脑，负责处理所有输入和输出数据。通过有效调用不同的模型 ，智能 体可以根据任务需求执行文本分析、图像识别和复杂推理等操作。CAMEL 提供了一系列 标</span><br><span class="line"></span><br><span class="line">💡 生成答案:</span><br><span class="line">### CAMEL Agent框架的特性及可调用工具</span><br><span class="line"></span><br><span class="line">#### 特性</span><br><span class="line"></span><br><span class="line">1. **标准化协议支持**：</span><br><span class="line">   - CAMEL Agent框架支持多种标准化协议，特别是模型上下文协议（MCP）、Agent间协议（A2A）和Agent网络协议（ANP）。这些协议确保了不同AI Agent之间的互操作性和高效协作（文档 内容：“这些协议为解决 AI Agent 在理解上下文、使用工具和相互协作方面的难题提供了有效 的思路。”）。</span><br><span class="line"></span><br><span class="line">2. **高度可扩展性**：</span><br><span class="line">   - CAMEL框架允许开发者将自定义的工具和服务转换成MCP服务，使得这些工具和服务可以被 其他支持MCP协议的客户端识别和使用（文档内容：“除了能把工具包转换成 MCP 服务器外，CAMEL 框架还支持一个更强大的功能：把整个 CAMEL 代理（Agent）本身也作为 MCP 服务器发布出去。”）。</span><br><span class="line"></span><br><span class="line">3. **复杂的多代理交互**：</span><br><span class="line">   - CAMEL框架内置了多代理角色扮演（RolePlaying）模块和“工作组”（Workforce）模块，这些模块可以实现多个代理之间的协同工作，形成复杂的交互场景（文档内容：“其内部一些更复 杂的模块，比如用于实现多代理角色扮演（RolePlaying）的模块，或者用于组织多个代理协同 工作的‘工作组’（Workforce）模块，也计划或者正在被实现为 MCP 服务器。”）。</span><br><span class="line"></span><br><span class="line">4. **代码即提示（Code-as-Prompt）**：</span><br><span class="line">   - CAMEL框架强调编写既清晰易懂又可被AI代理准确理解的代码，这一设计理念有助于提高集成的质量和稳定性（文档内容：“CAMEL 框架中有一个核心的设计哲学叫做‘代码即提示’（Code-as-Prompt）。它强调编写既清晰易懂（对人类开发者而言）又能被 AI 代理准确理解的代码。”）。</span><br><span class="line"></span><br><span class="line">#### 可调用的工具</span><br><span class="line"></span><br><span class="line">1. **文本分析工具**：</span><br><span class="line">   - CAMEL Agent框架支持调用文本分析工具，这些工具可以帮助Agent执行文本分类、情感分 析、关键词提取等任务（文档内容：“通过有效调用不同的模型，智能体可以根据任务需求执行 文本分析、图像识别和复杂推理等操作。”）。</span><br><span class="line"></span><br><span class="line">2. **图像识别工具**：</span><br><span class="line">   - 框架内的Agent可以调用图像识别工具，用于图像分类、目标检测、图像生成等任务。    </span><br><span class="line"></span><br><span class="line">3. **复杂推理工具**：</span><br><span class="line">   - 支持调用复杂推理工具，这些工具可以帮助Agent解决需要多步推理的问题，例如决策树、逻辑推理等。</span><br><span class="line"></span><br><span class="line">4. **自定义工具和服务**：</span><br><span class="line">   - 开发者可以将自己开发的工具和服务转换成MCP服务，这些服务可以被其他支持MCP协议的 客户端调用，从而实现更广泛的应用（文档内容：“这意味着，一个你精心配置好的 CAMEL 代理——它可能拥有特定的 AI 模型、独特的系统指令（system message），甚至内置了一些其他的工具——现在可以作为一个独立的服务运行。”）。</span><br><span class="line"></span><br><span class="line">通过上述特性和工具的支持，CAMEL Agent框架不仅能够实现单一Agent的强大功能，还能促进不同Agent之间的协同工作，形成一个高效的AI生态系统。</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">询问：是否保存结果到文件？(y/n): n</span><br><span class="line"></span><br><span class="line">是否继续查询？(y/n): y</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">查询选项</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>
<h5 id="最后我们来测试一下主题检索："><a href="#最后我们来测试一下主题检索：" class="headerlink" title="最后我们来测试一下主题检索："></a>最后我们来测试一下主题检索：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">请输入您的问题 (输入 &#x27;quit&#x27; 退出, &#x27;reload&#x27; 重新加载PDF): camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line"></span><br><span class="line">选择检索模式:</span><br><span class="line">1. 快速检索 (基础向量检索)</span><br><span class="line">2. 深度检索 (重写+HyDE+RRF)</span><br><span class="line">3. 主题检索 (PDF+网页爬取)</span><br><span class="line">请选择模式 (1-3): 3</span><br><span class="line"></span><br><span class="line">执行查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">检索模式: 主题检索</span><br><span class="line"></span><br><span class="line">执行网页检索...</span><br><span class="line">========================================</span><br><span class="line">正在进行网页研究...</span><br><span class="line">🔍 网络搜索: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">🔄 使用 DuckDuckGo Lite 搜索...</span><br><span class="line">✅ 搜索完成，找到 10 个结果</span><br><span class="line">√ 网页搜索完成</span><br><span class="line">正在检索PDF文档...</span><br><span class="line">Retrieved 3 documents</span><br><span class="line">√ 检索到 3 个PDF文档</span><br><span class="line">正在生成综合答案...</span><br><span class="line">Generating response with CAMEL model...</span><br><span class="line">CAMEL generation failed, using fallback: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">API调用 1/3...</span><br><span class="line">√ API调用成功</span><br><span class="line">主题检索完成</span><br><span class="line"></span><br><span class="line">==================== 深度检索结果 ====================</span><br><span class="line">原结始查询: camel agent框架具备有什么特性？可以调用哪些工具？</span><br><span class="line">检索方法: PDF+Web Topic Retrieval</span><br><span class="line">💡 生成答案:</span><br><span class="line">**CAMEL Agent框架的特性及其可调用的工具**</span><br><span class="line"></span><br><span class="line">### 特性</span><br><span class="line"></span><br><span class="line">1. **多智能体系统支持**：CAMEL Agent框架支持创建和管理多个智能体，这些智能体可以在同一个系统中协同工作，共同完成复杂的任务。每个智能体都可以根据其角色和任务进行配置，从而实现高度的灵活性和适应性。</span><br><span class="line"></span><br><span class="line">2. **模块化设计**：框架采用模块化设计，使得开发者可以轻松地添加或移除功能模块，如不 同的感知模块、决策模块等，以适应不同应用场景的需求。</span><br><span class="line"></span><br><span class="line">3. **强大的模型支持**：CAMEL Agent框架中的每个Agent都有一个“大脑”，即Model，它负责处理所有输入和输出的数据。通过调用不同的模型，智能体能够执行文本分析、图像识别、复杂推理等多种任务。</span><br><span class="line"></span><br><span class="line">4. **高效的任务调度与管理**：该框架提供了高效的任务调度机制，确保多个Agent之间可以有效地分配和执行任务，即使在资源有限的情况下也能保持良好的性能。</span><br><span class="line"></span><br><span class="line">5. **易于集成第三方服务**：CAMEL Agent框架设计时考虑到了与其他服务和技术栈的兼容性，允许开发者轻松集成外部API和服务，如云存储、数据库、消息队列等，进一步扩展应用的功能 。</span><br><span class="line"></span><br><span class="line">### 可调用的工具</span><br><span class="line"></span><br><span class="line">1. **自然语言处理（NLP）工具**：包括但不限于文本分类、情感分析、实体识别等功能，帮助智能体更好地理解和生成人类语言。</span><br><span class="line"></span><br><span class="line">2. **计算机视觉（CV）工具**：如图像分类、目标检测、人脸识别等，使智能体能够在视觉任 务中发挥重要作用。</span><br><span class="line"></span><br><span class="line">3. **机器学习/深度学习框架**：如TensorFlow、PyTorch等，为智能体提供了强大的算法支持 ，使其能够学习和改进自己的行为模式。</span><br><span class="line"></span><br><span class="line">4. **数据存储与处理工具**：例如MongoDB、MySQL等数据库管理系统，以及Hadoop、Spark等大数据处理平台，用于管理和分析大量数据。</span><br><span class="line"></span><br><span class="line">5. **通信协议与工具**：包括RESTful API、WebSocket等，确保智能体之间以及智能体与外部 世界之间的高效通信。</span><br><span class="line"></span><br><span class="line">6. **任务调度与管理工具**：如Celery、RabbitMQ等，帮助实现任务的异步处理和分布式计算 ，提高系统的响应速度和处理能力。</span><br><span class="line"></span><br><span class="line">综上所述，CAMEL Agent框架不仅具备强大的多智能体系统支持和模块化设计，还能够调用多种 先进的工具和技术，使其成为构建复杂智能应用的理想选择。</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">询问：是否保存结果到文件？(y/n): n</span><br><span class="line"></span><br><span class="line">是否继续查询？(y/n): y</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">查询选项</span><br><span class="line">============================================================</span><br><span class="line">请输入您的问题 (输入 &#x27;quit&#x27; 退出, &#x27;reload&#x27; 重新加载PDF):</span><br></pre></td></tr></table></figure>
<h5 id="基于以上运行结果，我们来总结一下功能实现效果"><a href="#基于以上运行结果，我们来总结一下功能实现效果" class="headerlink" title="基于以上运行结果，我们来总结一下功能实现效果"></a><strong>基于以上运行结果，我们来总结一下功能实现效果</strong></h5><p>我们可以看到，该交互式多模态RAG系统在功能实现和交互设计上表现良好，成功支持PDF知识库加载、三种检索模式和答案生成，答案质量随模式增强而提升。然而，CAMEL框架的稳定性问题、多模态支持的未充分利用、网页研究的模拟性以及性能和界面局限影响了整体效果。通过解决CAMEL兼容性、增强多模态和网页功能、优化性能和用户体验，系统可进一步提升实用性和适应稳定性，适用于更广泛的应用场景。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br></pre></td><td class="code"><pre><span class="line"> G:\Python-Camel-project\Interactive_Multi_RAG&gt; &amp; D:/Download/Python/py-3.11.9/python.exe g:/Python-Camel-project/Interactive_Multi_RAG/Enhanced_Interactive_Multimodal_RAG.py</span><br><span class="line">W0725 16:44:30.290000 32324 site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported in Windows or MacOs.   </span><br><span class="line">✓ 使用Rich增强界面</span><br><span class="line">╭────────────────────────────────── 🎯 系统启动 ───────────────────────────────────╮</span><br><span class="line">│                                                                                  │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│  🤖 交互式多模态RAG系统 v2.0                                                     │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│  ✨ 新功能特性:                                                                  │</span><br><span class="line">│  • 🔧 增强的CAMEL框架集成和稳定性改进                                            │</span><br><span class="line">│  • 🖼️ 改进的多模态支持 (图像OCR + 表格提取)                                       </span><br><span class="line">│</span><br><span class="line">│  • 🌐 真实网页研究和内容分析                                                     │</span><br><span class="line">│  • ⚡ 性能监控和优化                                                             │</span><br><span class="line">│  • 🎨 增强的用户界面体验                                                         │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│  🚀 支持的检索模式:                                                              │</span><br><span class="line">│  • 快速检索: 基础向量检索                                                        │</span><br><span class="line">│  • 深度检索: 查询重写 + HyDE + RRF融合                                           │</span><br><span class="line">│  • 主题检索: PDF + 网页内容综合分析                                              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│                                                                                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">🚀 正在初始化增强RAG系统...</span><br><span class="line">性能监控器初始化 (详细监控: 开启)</span><br><span class="line">🚀 初始化增强RAG系统...</span><br><span class="line">正在初始化CAMEL模型...</span><br><span class="line">CAMEL模型测试失败: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">⚠ CAMEL模型初始化成功但测试失败，将使用直接API调用</span><br><span class="line">✅ 嵌入模型加载成功</span><br><span class="line">✅ 增强向量检索器初始化完成</span><br><span class="line">✅ 增强文档管理器初始化完成</span><br><span class="line">📁 缓存目录: document_cache</span><br><span class="line">📋 支持格式: [&#x27;.pdf&#x27;, &#x27;.docx&#x27;, &#x27;.doc&#x27;, &#x27;.txt&#x27;, &#x27;.md&#x27;, &#x27;.csv&#x27;, &#x27;.xlsx&#x27;, &#x27;.xls&#x27;, &#x27;.pptx&#x27;, &#x27;.ppt&#x27;, &#x27;.json&#x27;, &#x27;.xml&#x27;, &#x27;.html&#x27;, &#x27;.rtf&#x27;]</span><br><span class="line">多模态处理器初始化:</span><br><span class="line">  图像OCR: ✓</span><br><span class="line">  表格处理: ✓</span><br><span class="line">  PyMuPDF: ✓</span><br><span class="line">网页研究系统初始化:</span><br><span class="line">  BeautifulSoup4: ✓</span><br><span class="line">  DuckDuckGo搜索: ✓</span><br><span class="line">✅ 增强RAG系统初始化完成!</span><br><span class="line">✅ 增强RAG系统初始化成功!</span><br><span class="line">                           🔧 系统状态</span><br><span class="line">┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 组件                 ┃ 状态            ┃ 详情                  ┃</span><br><span class="line">┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ LLM接口              │ ✅ 正常         │                       │</span><br><span class="line">│ 嵌入模型             │ ✅ 正常         │ intfloat/e5-large-v2  │</span><br><span class="line">│ 文档管理             │ ✅ 正常         │                       │</span><br><span class="line">│ 多模态处理           │ ✅ 正常         │ OCR: True, 表格: True │</span><br><span class="line">│ 网页研究             │ ✅ 正常         │                       │</span><br><span class="line">│ 知识库               │ ✅ 正常         │                       │</span><br><span class="line">│ 性能监控             │ ✅ 正常         │                       │</span><br><span class="line">└──────────────────────┴─────────────────┴───────────────────────┘</span><br><span class="line"></span><br><span class="line">📚 文档知识库设置</span><br><span class="line">┏━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 选项     ┃ 描述                        ┃</span><br><span class="line">┡━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1        │ 在线文档 (输入URL)          │</span><br><span class="line">│ 2        │ 本地文档 (输入文件路径)     │</span><br><span class="line">│ 3        │ 批量本地文档 (输入目录路径) │</span><br><span class="line">│ 4        │ 使用默认示例PDF             │</span><br><span class="line">└──────────┴─────────────────────────────┘</span><br><span class="line"></span><br><span class="line">请选择文档来源 [1/2/3/4] (4): 2</span><br><span class="line">请输入文档文件路径 (回车结束): G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">请输入文档文件路径 (回车结束): G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">请输入文档文件路径 (回车结束): </span><br><span class="line">⏳ 正在加载 2 个文档...</span><br><span class="line">⏱ 开始监控: setup_knowledge_base</span><br><span class="line">📚 正在设置知识库...</span><br><span class="line">文档数量: 2</span><br><span class="line">来源类型: path</span><br><span class="line"></span><br><span class="line">📄 处理文档: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">📄 处理文档: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">✅ 文档缓存已保存: 271 个块</span><br><span class="line">✅ 文档处理完成: 271 个块, 耗时 13.07s</span><br><span class="line">✅ 文档处理完成: 271 个块</span><br><span class="line"></span><br><span class="line">📄 处理文档: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">📄 处理文档: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">⚡ 使用缓存数据</span><br><span class="line">✅ 文档处理完成: 271 个块</span><br><span class="line"></span><br><span class="line">⏳ 正在构建向量索引...</span><br><span class="line">⏱ 开始监控: add_documents</span><br><span class="line">⏳ 正在计算 542 个文档的嵌入向量...</span><br><span class="line">✅ 成功添加 542 个文档到检索器</span><br><span class="line">✓ 操作完成: add (耗时: 343.83s, 内存: 794.0MB)</span><br><span class="line"></span><br><span class="line">✅ 知识库设置完成!</span><br><span class="line">处理文档数: 2</span><br><span class="line">总文档块数: 542</span><br><span class="line">内容统计: 文本(418) 图像(116) 表格(8) 其他(0)</span><br><span class="line">缓存统计: 1 个文档, 0.4MB</span><br><span class="line">✓ 操作完成: setup (耗时: 356.98s, 内存: 794.0MB)</span><br><span class="line">✅ 知识库设置完成!</span><br><span class="line"></span><br><span class="line">💭 请输入您的问题 (): 介绍camel中的rag使用   </span><br><span class="line"></span><br><span class="line">🔍 选择检索模式</span><br><span class="line">┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 模式         ┃ 描述              ┃ 特点                     ┃</span><br><span class="line">┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1. 快速检索  │ 基础向量检索      │ 速度快，适合简单查询     │</span><br><span class="line">│ 2. 深度检索  │ 查询重写+HyDE+RRF │ 准确度高，适合复杂查询   │</span><br><span class="line">│ 3. 主题检索  │ PDF+网页综合分析  │ 信息全面，适合研究性查询 │</span><br><span class="line">└──────────────┴───────────────────┴──────────────────────────┘</span><br><span class="line">请选择检索模式 [1/2/3] (1): 2</span><br><span class="line">⏳ 正在执行深度检索...</span><br><span class="line">⏱ 开始监控: enhanced_query_深度检索</span><br><span class="line"></span><br><span class="line">🔍 执行深度检索: 介绍camel中的rag使用</span><br><span class="line">============================================================</span><br><span class="line">🔬 执行深度检索...</span><br><span class="line">📝 步骤1: 查询重写</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">🧠 步骤2: HyDE假设文档生成</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">🔍 步骤3: 多路检索</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.20s, 内存: 569.7MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.19s, 内存: 571.0MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.95s, 内存: 584.7MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 0 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.12s, 内存: 581.9MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 0 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.14s, 内存: 581.7MB)</span><br><span class="line">🔀 步骤4: RRF结果融合</span><br><span class="line">💡 步骤5: 生成最终答案</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">✓ 操作完成: enhanced (耗时: 41.24s, 内存: 910.7MB)</span><br><span class="line"></span><br><span class="line">================================================================================    </span><br><span class="line">╭──────────────────────────────────── 查询信息 ────────────────────────────────────╮</span><br><span class="line">│ 🔍 查询: 介绍camel中的rag使用                                                    │</span><br><span class="line">│ 🔧 方法: 深度检索(重写+HyDE+RRF)                                                 │</span><br><span class="line">│ 📝 重写: 在Apache Camel中实现RAG（Retrieval-Augmented                            │</span><br><span class="line">│ Generation）的具体应用和配置方法                                                 │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">📄 检索到的文档 (共11个):</span><br><span class="line">╭───────────────────────────────────── 文档 1 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0474                                                               │</span><br><span class="line">│ 内容预览: DataWhale 和 CAMEL                                                     │</span><br><span class="line">│ 之间的关系是合作和知识共享。尽管它们生活在不同的环境中——                         │</span><br><span class="line">│ CAMEL 生活在沙漠，而 DataWhale 生活在海洋，但它们都发现了神秘的古代文物，分别是  │</span><br><span class="line">│ 古代石板和古老羊皮纸。通过一只信使鸟的帮助，它们了解到对方的发现并决定合作解开这 │</span><br><span class="line">│ 些文物的秘密。CAMEL 跨越沙漠来到海洋边缘，而 DataWhale 也游到岸边与 CAMEL 会     │</span><br><span class="line">│ 合。最终，它们共同努力...                                                        │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 2 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0320                                                               │</span><br><span class="line">│ 内容预览: DataWhale 和 CAMEL                                                     │</span><br><span class="line">│ 之间的关系是合作和知识共享。尽管它们生活在不同的环境中——                         │</span><br><span class="line">│ CAMEL 生活在沙漠，而 DataWhale 生活在海洋，但它们都发现了神秘的古代文物，分别是  │</span><br><span class="line">│ 古代石板和古老羊皮纸。通过一只信使鸟的帮助，它们了解到对方的发现并决定合作解开这 │</span><br><span class="line">│ 些文物的秘密。CAMEL 跨越沙漠来到海洋边缘，而 DataWhale 也游到岸边与 CAMEL 会     │</span><br><span class="line">│ 合。最终，它们共同努力...                                                        │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 3 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0310                                                               │</span><br><span class="line">│ 内容预览:     # 遍历文本检索结果                                                 │</span><br><span class="line">│     for rank, result in enumerate(text_results):                                 │</span><br><span class="line">│         text = result[&#x27;text&#x27;]                                                    │</span><br><span class="line">│         doc_scores = doc_scores.get(text, 0) + 1 / (rank + m)                    │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│     # 按融合分数排序并返回前k 个结果                                             │</span><br><span class="line">│     ...                                                                          │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 4 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0164                                                               │</span><br><span class="line">│ 内容预览:                                                                        │</span><br><span class="line">│ 观察到文案风格确实更加活泼，且红圈部分正确修改成了中南海和配图也十分吻合。       │</span><br><span class="line">│ 6. 搭配前端食用                                                                  │</span><br><span class="line">│ 综合案例中为了尽可能让大家直观的感受到基于CAMEL 框架的Agent 产品开发的乐趣，我   │</span><br><span class="line">│ 们还为大家准备了精美的前端，搭配之前的几个后端模块一起构成我们的NavigatorAI 旅游 │</span><br><span class="line">│                                                                                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 5 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0164                                                               │</span><br><span class="line">│ 内容预览:                                                                        │</span><br><span class="line">│ The CAMEL framework ( (https://github.com/camel-ai))                             │</span><br><span class="line">│ developed by the CAMEL-AI community is one of the earliest open-source           │</span><br><span class="line">│ multi-agent                                                                      │</span><br><span class="line">│ projects based on large languag...                                               │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 6 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0161                                                               │</span><br><span class="line">│ 内容预览:                                                                        │</span><br><span class="line">│ 观察到文案风格确实更加活泼，且红圈部分正确修改成了中南海和配图也十分吻合。       │</span><br><span class="line">│ 6. 搭配前端食用                                                                  │</span><br><span class="line">│ 综合案例中为了尽可能让大家直观的感受到基于CAMEL 框架的Agent 产品开发的乐趣，我   │</span><br><span class="line">│ 们还为大家准备了精美的前端，搭配之前的几个后端模块一起构成我们的NavigatorAI 旅游 │</span><br><span class="line">│                                                                                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 7 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0161                                                               │</span><br><span class="line">│ 内容预览:                                                                        │</span><br><span class="line">│ The CAMEL framework ( (https://github.com/camel-ai))                             │</span><br><span class="line">│ developed by the CAMEL-AI community is one of the earliest open-source           │</span><br><span class="line">│ multi-agent                                                                      │</span><br><span class="line">│ projects based on large languag...                                               │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 8 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0159                                                               │</span><br><span class="line">│ 内容预览:     # 遍历文本检索结果                                                 │</span><br><span class="line">│     for rank, result in enumerate(text_results):                                 │</span><br><span class="line">│         text = result[&#x27;text&#x27;]                                                    │</span><br><span class="line">│         doc_scores = doc_scores.get(text, 0) + 1 / (rank + m)                    │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│     # 按融合分数排序并返回前k 个结果                                             │</span><br><span class="line">│     ...                                                                          │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────── 文档 9 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0159                                                               │</span><br><span class="line">│ 内容预览:                                                                        │</span><br><span class="line">│ 此外，还有其他一些研究和项目也在探索如何利用LLMs 构建多智能体系统，比如通过模拟  │</span><br><span class="line">│ 社会动态、协作解决问题等。这些工作都在不同程度上推动了                           │</span><br><span class="line">│ 该领域的进步。                                                                   │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ 如果您有更具体的时间范围或其他标准来定义“第一个”，请提供更多信息，这样我可以尝试 │</span><br><span class="line">│ 给出更加准确的答案。&quot;                                                            │</span><br><span class="line">│ 之后我们将之前设定的memory 赋值给agent：                                         │</span><br><span class="line">│ # 将memory 赋值给agent                                                           │</span><br><span class="line">│ agent.memory...                                                                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭──────────────────────────────────── 文档 10 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0156                                                               │</span><br><span class="line">│ 内容预览:                                                                        │</span><br><span class="line">│ 此外，还有其他一些研究和项目也在探索如何利用LLMs 构建多智能体系统，比如通过模拟  │</span><br><span class="line">│ 社会动态、协作解决问题等。这些工作都在不同程度上推动了                           │</span><br><span class="line">│ 该领域的进步。                                                                   │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ 如果您有更具体的时间范围或其他标准来定义“第一个”，请提供更多信息，这样我可以尝试 │</span><br><span class="line">│ 给出更加准确的答案。&quot;                                                            │</span><br><span class="line">│ 之后我们将之前设定的memory 赋值给agent：                                         │</span><br><span class="line">│ # 将memory 赋值给agent                                                           │</span><br><span class="line">│ agent.memory...                                                                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭──────────────────────────────────── 文档 11 ─────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0154                                                               │</span><br><span class="line">│ 内容预览: # 创建或初始化向量存储（例如 QdrantStorage）                           │</span><br><span class="line">│ from camel.storages.vectordb_storages import QdrantStorage                       │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ vector_storage = QdrantStorage(                                                  │</span><br><span class="line">│     vector_dim=embedding_model.get_output_dim(),  # 嵌入向量的维度               │</span><br><span class="line">│     collecti...                                                                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭────────────────────────────────── 💡 生成答案 ───────────────────────────────────╮</span><br><span class="line">│ ### CAMEL 中的 RAG 使用介绍                                                      │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 1. RAG 基本概念                                                             │</span><br><span class="line">│ RAG（Retrieval-Augmented                                                         │</span><br><span class="line">│ Generation）是一种结合了信息检索和自然语言生成的技术。它通过先从大量文档中检索出 │</span><br><span class="line">│ 与查询相关的片段，再利用这些片段生成高质量的回答，从而提高生成内容的相关性和准确 │</span><br><span class="line">│ 性。在 CAMEL 框架中，RAG 技术被广泛应用于知识问答、客户服务等领域。              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 2. CAMEL 框架中的 RAG 组件                                                  │</span><br><span class="line">│ 根据文档内容，CAMEL 框架中的 RAG 技术涉及以下几个主要组件：                      │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ - **CAMEL**：一个强大的多代理框架，支持 Retrieval-Augmented Generation           │</span><br><span class="line">│ 和多代理角色扮演场景，允许执行复杂的 AI 驱动任务。                               │</span><br><span class="line">│ -                                                                                │</span><br><span class="line">│ **Firecrawl**：一个强大的网络抓取工具，可简化从各种网页中提取和清理内容的过程。  │</span><br><span class="line">│ - **Qdrant**：一种高效的向量存储系统，与 Camel 的 AutoRetriever                  │</span><br><span class="line">│ 一起使用，根据向量相似性存储和检索相关信息。                                     │</span><br><span class="line">│ - **BM25Retriever**：一种基于 BM25 算法的检索器，用于从文本中检索相关信息。      │</span><br><span class="line">│ - **SentenceTransformerEncoder**：用于生成文本的向量表示，以便进行向量检索。     │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 3. RAG 的具体实现步骤                                                       │</span><br><span class="line">│ 以下是使用 CAMEL 框架实现 RAG 的具体步骤：                                       │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ ##### 3.1 设置 API 密钥                                                          │</span><br><span class="line">│ 首先，需要设置所需的 API 密钥，例如 AgentOps 和 Firecrawl 的 API 密钥：          │</span><br><span class="line">│ ```python                                                                        │</span><br><span class="line">│ import os                                                                        │</span><br><span class="line">│ from getpass import getpass                                                      │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 输入 AgentOps API 密钥                                                         │</span><br><span class="line">│ agentops_api_key = getpass(&#x27;请输入您的 API 密钥: &#x27;)                              │</span><br><span class="line">│ os.environ[&quot;AGENTOPS_API_KEY&quot;] = agentops_api_key                                │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 输入 Firecrawl API 密钥                                                        │</span><br><span class="line">│ firecrawl_api_key = getpass(&#x27;Enter your API key: &#x27;)                              │</span><br><span class="line">│ os.environ[&quot;FIRECRAWL_API_KEY&quot;] = firecrawl_api_key                              │</span><br><span class="line">│ ```                                                                              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ ##### 3.2 使用 Firecrawl 抓取网页内容                                            │</span><br><span class="line">│ 使用 Firecrawl 从指定的 URL 抓取并清理内容：                                     │</span><br><span class="line">│ ```python                                                                        │</span><br><span class="line">│ from camel.loaders import Firecrawl                                              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ firecrawl = Firecrawl()                                                          │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 从指定的 URL 抓取并清理内容                                                    │</span><br><span class="line">│ response = firecrawl.scrape(url=&quot;https://www.camel-ai.org/&quot;)                     │</span><br><span class="line">│ ```                                                                              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ ##### 3.3 初始化检索器                                                           │</span><br><span class="line">│ 初始化向量检索器和 BM25 检索器：                                                 │</span><br><span class="line">│ ```python                                                                        │</span><br><span class="line">│ from camel.embeddings import SentenceTransformerEncoder                          │</span><br><span class="line">│ from camel.storage import QdrantStorage                                          │</span><br><span class="line">│ from camel.retrievers import VectorRetriever, BM25Retriever                      │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 初始化嵌入模型                                                                 │</span><br><span class="line">│ embedding_model = SentenceTransformerEncoder(model_name=&#x27;intfloat/e5-large-v2&#x27;)  │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 初始化向量存储                                                                 │</span><br><span class="line">│ vector_storage = QdrantStorage(                                                  │</span><br><span class="line">│     vector_dim=embedding_model.get_output_dim(),                                 │</span><br><span class="line">│     collection=&quot;demo_collection&quot;,                                                │</span><br><span class="line">│     path=&quot;storage_customized_run&quot;,                                               │</span><br><span class="line">│     collection_name=&quot;paper&quot;                                                      │</span><br><span class="line">│ )                                                                                │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 初始化向量检索器                                                               │</span><br><span class="line">│ vr = VectorRetriever(embedding_model=embedding_model, storage=vector_storage)    │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 初始化 BM25 检索器                                                             │</span><br><span class="line">│ bm25r = BM25Retriever()                                                          │</span><br><span class="line">│ ```                                                                              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ ##### 3.4 处理文档                                                               │</span><br><span class="line">│ 处理需要检索的文档内容：                                                         │</span><br><span class="line">│ ```python                                                                        │</span><br><span class="line">│ content_path = &quot;local_data/camel_paper.pdf&quot;                                      │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 处理向量检索器的文档                                                           │</span><br><span class="line">│ vr.process(content=content_path)                                                 │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ # 处理 BM25 检索器的文档                                                         │</span><br><span class="line">│ bm25r.process(content_input_path=content_path)                                   │</span><br><span class="line">│ ```                                                                              │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ ##### 3.5 执行查询                                                               │</span><br><span class="line">│ 执行查询并获取检索结果：                                                         │</span><br><span class="line">│ ```python                                                                        │</span><br><span class="line">│ query = &quot;CAMEL 是                                                                │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">================================================================================    </span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n</span><br><span class="line">🔄 是否继续查询? [y/n] (y): y</span><br><span class="line"></span><br><span class="line">💭 请输入您的问题 (): 科普camel架构的功能和特性</span><br><span class="line"></span><br><span class="line">🔍 选择检索模式</span><br><span class="line">┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 模式         ┃ 描述              ┃ 特点                     ┃</span><br><span class="line">┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1. 快速检索  │ 基础向量检索      │ 速度快，适合简单查询     │</span><br><span class="line">│ 2. 深度检索  │ 查询重写+HyDE+RRF │ 准确度高，适合复杂查询   │</span><br><span class="line">│ 3. 主题检索  │ PDF+网页综合分析  │ 信息全面，适合研究性查询 │</span><br><span class="line">└──────────────┴───────────────────┴──────────────────────────┘</span><br><span class="line">请选择检索模式 [1/2/3] (1): 3</span><br><span class="line">⏳ 正在执行主题检索...</span><br><span class="line">⏱ 开始监控: enhanced_query_主题检索</span><br><span class="line"></span><br><span class="line">🔍 执行主题检索: 科普camel架构的功能和特性</span><br><span class="line">============================================================</span><br><span class="line">🌐 执行主题检索...</span><br><span class="line">📄 步骤1: PDF文档检索</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.19s, 内存: 1275.8MB)</span><br><span class="line">🔍 步骤2: 网页研究</span><br><span class="line"></span><br><span class="line">开始网页研究: 科普camel架构的功能和特性</span><br><span class="line">==================================================</span><br><span class="line">使用DuckDuckGo搜索...</span><br><span class="line">⚠ DuckDuckGo搜索失败: https://duckduckgo.com/?q=%E7%A7%91%E6%99%AEcamel%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8A%9F%E8%83%BD%E5%92%8C%E7%89%B9%E6%80%A7 202 Ratelimit</span><br><span class="line">使用备用搜索方法...</span><br><span class="line">✓ 备用搜索完成，生成 3 个模拟结果</span><br><span class="line">✓ 找到 3 个搜索结果</span><br><span class="line">正在获取网页内容 1/3: 关于科普camel架构的功能和特性的学术资源...</span><br><span class="line">✓ 成功获取内容 (706字符)</span><br><span class="line">正在获取网页内容 2/3: 科普camel架构的功能和特性 - 维基百科...</span><br><span class="line">✓ 成功获取内容 (3003字符)</span><br><span class="line">正在获取网页内容 3/3: 科普camel架构的功能和特性技术文档...</span><br><span class="line">⚠ 网页内容获取失败 (https://docs.example.com): HTTPSConnectionPool(host=&#x27;docs.example.com&#x27;, port=443): Max retries exceeded with url: / (Caused by SSLError(SSLEOFError(8, &#x27;[SSL: UNEXPECTED_EOF_WHILE_READING] EOF occurred in violation of protocol (_ssl.c:1006)&#x27;)))</span><br><span class="line">⚠ 内容获取失败</span><br><span class="line">✓ 网页研究完成，分析了 2 个网页</span><br><span class="line">🧩 步骤3: 综合分析</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">✓ 操作完成: enhanced (耗时: 38.07s, 内存: 1307.3MB)</span><br><span class="line"></span><br><span class="line">================================================================================    </span><br><span class="line">╭──────────────────────────────────── 查询信息 ────────────────────────────────────╮</span><br><span class="line">│ 🔍 查询: 科普camel架构的功能和特性                                               │</span><br><span class="line">│ 🔧 方法: 主题检索(PDF+网页)                                                      │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭────────────────────────────────── 💡 生成答案 ───────────────────────────────────╮</span><br><span class="line">│ ### CAMEL 架构的功能和特性                                                       │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ **CAMEL（Customized Applications for Mobile network Enhanced Logic）**           │</span><br><span class="line">│ 是一种用于移动网络中实现定制化应用的逻辑框架。它允许运营商根据不同的业务需求，灵 │</span><br><span class="line">│ 活地提供增值服务，如预付费服务、智能网服务等。以下是结合PDF文档和网页信息对CAMEL │</span><br><span class="line">│ 架构功能和特性的详细介绍：                                                       │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 1. **灵活性和可扩展性**                                                     │</span><br><span class="line">│    - **灵活性**：CAMEL                                                           │</span><br><span class="line">│ 架构设计允许运营商根据市场和客户需求快速推出新的增值服务，无需对核心网络进行大规 │</span><br><span class="line">│ 模改造。                                                                         │</span><br><span class="line">│    - **可扩展性**：随着技术的发展和新业务的增加，CAMEL                           │</span><br><span class="line">│ 架构能够轻松扩展，支持更多的服务和应用。                                         │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 2. **智能网服务**                                                           │</span><br><span class="line">│    - **预付费服务**：CAMEL                                                       │</span><br><span class="line">│ 支持预付费用户的服务管理，包括账户充值、余额查询、计费等。                       │</span><br><span class="line">│    - **个性化服务**：运营商可以通过CAMEL 提供个性化的服务，如铃声下载、彩信等。  │</span><br><span class="line">│    - **位置服务**：CAMEL 可以支持基于用户位置的增值服务，如导航、天气预报等。    │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 3. **协作与知识共享**                                                       │</span><br><span class="line">│    - **跨领域合作**：CAMEL                                                       │</span><br><span class="line">│ 架构鼓励不同背景和技术领域的合作。例如，在PDF文档中提到的故事中，CAMEL（代表沙漠 │</span><br><span class="line">│ 中的骆驼）和DataWhale（代表海洋中的鲸鱼）通过合作解开了古老的符号之谜，找到了知  │</span><br><span class="line">│ 识的宝库。                                                                       │</span><br><span class="line">│    -                                                                             │</span><br><span class="line">│ **知识共享**：通过合作，不同实体可以共享知识和资源，推动整体发展。这不仅限于技术 │</span><br><span class="line">│ 领域，还包括文化、教育等多个方面。                                               │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 4. **技术实现**                                                             │</span><br><span class="line">│    - **Agent 技术**：CAMEL 架构利用Agent技术来实现智能化的服务。Agent            │</span><br><span class="line">│ 可以自主地执行任务，如搜索信息、处理请求等。                                     │</span><br><span class="line">│    - **前端与后端集成**：CAMEL                                                   │</span><br><span class="line">│ 架构不仅提供了强大的后端模块，还配备了精美的前端界面，使得用户能够直观地体验和使 │</span><br><span class="line">│ 用各种服务。例如，PDF文档中提到的“NavigatorAI                                    │</span><br><span class="line">│ 旅游”应用，就是一个典型的前后端集成示例。                                        │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 5. **可靠性和安全性**                                                       │</span><br><span class="line">│    - **可靠性**：CAMEL                                                           │</span><br><span class="line">│ 架构设计注重系统的稳定性和可靠性，确保服务的连续性和高质量。                     │</span><br><span class="line">│    - **安全性**：通过多种安全机制，CAMEL                                         │</span><br><span class="line">│ 架构保护用户数据和交易的安全，防止未经授权的访问和攻击。                         │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ #### 6. **创新与未来展望**                                                       │</span><br><span class="line">│    - **创新**：CAMEL 架构不断推动技术创新，探索新的应用场景和服务模式。          │</span><br><span class="line">│    - **未来展望**：随着5G和物联网技术的发展，CAMEL                               │</span><br><span class="line">│ 架构将进一步拓展其应用范围，支持更多智能化和个性化的服务。                       │</span><br><span class="line">│                                                                                  │</span><br><span class="line">│ ### 总结                                                                         │</span><br><span class="line">│ CAMEL                                                                            │</span><br><span class="line">│ 架构以其灵活性、可扩展性、智能网服务、协作与知识共享、技术实现、可靠性和安全性等 │</span><br><span class="line">│ 多方面的优势，成为移动网络增值服务的重要支撑。通过不断的技术创新和跨领域的合作， │</span><br><span class="line">│ CAMEL 架构将继续推动移动通信行业的发展，为用户提供更加丰富和便捷的服务。         │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">================================================================================</span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n</span><br><span class="line">🔄 是否继续查询? [y/n] (y): n</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">📊 最终性能报告</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">性能监控报告</span><br><span class="line">============================================================</span><br><span class="line">总操作数: 10</span><br><span class="line">整体成功率: 100.0%</span><br><span class="line">总耗时: 781.91秒</span><br><span class="line">平均耗时: 78.19秒</span><br><span class="line">平均内存使用: 797.1MB</span><br><span class="line"></span><br><span class="line">操作详情:</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">add:</span><br><span class="line">  调用次数: 1</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 343.83秒</span><br><span class="line">  平均内存: 794.0MB</span><br><span class="line"></span><br><span class="line">setup:</span><br><span class="line">  调用次数: 1</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 356.98秒</span><br><span class="line">  平均内存: 794.0MB</span><br><span class="line"></span><br><span class="line">vector:</span><br><span class="line">  调用次数: 6</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 0.30秒</span><br><span class="line">  平均内存: 694.1MB</span><br><span class="line"></span><br><span class="line">enhanced:</span><br><span class="line">  调用次数: 2</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 39.65秒</span><br><span class="line">  平均内存: 1109.0MB</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n</span><br><span class="line">✅ 感谢使用增强的交互式多模态RAG系统!</span><br><span class="line">PS G:\Python-Camel-project\Interactive_Multi_RAG&gt; </span><br><span class="line">fwd-i-search: _</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br></pre></td><td class="code"><pre><span class="line">PS G:\Python-Camel-project\Interactive_Multi_RAG&gt; &amp; D:/Download/Python/py-3.11.9/python.exe g:/Python-Camel-project/Interactive_Multi_RAG/Enhanced_Interactive_Multimodal_RAG.py</span><br><span class="line">W0725 20:04:54.071000 28968 site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported in Windows or MacOs.</span><br><span class="line">✓ 使用Rich增强界面</span><br><span class="line">╭─────────────────────────────────────────── 🎯 系统启动 ───────────────────────────────────────────╮</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│  🤖 交互式多模态RAG系统 v2.0                                                                      │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│  ✨ 新功能特性:                                                                                   │</span><br><span class="line">│  • 🔧 增强的CAMEL框架集成和稳定性改进                                                             │</span><br><span class="line">│  • 🖼️ 改进的多模态支持 (图像OCR + 表格提取)                                                        │</span><br><span class="line">│  • 🌐 真实网页研究和内容分析                                                                      │</span><br><span class="line"></span><br><span class="line">│  • ⚡ 性能监控和优化                                                                              │</span><br><span class="line">│  • 🎨 增强的用户界面体验                                                                          │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│  🚀 支持的检索模式:                                                                               │</span><br><span class="line">│  • 快速检索: 基础向量检索                                                                         │</span><br><span class="line">│  • 深度检索: 查询重写 + HyDE + RRF融合                                                            │</span><br><span class="line">│  • 主题检索: PDF + 网页内容综合分析                                                               │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">🚀 正在初始化增强RAG系统...</span><br><span class="line">性能监控器初始化 (详细监控: 开启)</span><br><span class="line">🚀 初始化增强RAG系统...</span><br><span class="line">正在初始化CAMEL模型...</span><br><span class="line">CAMEL模型测试失败: &#x27;BaseMessage&#x27; object has no attribute &#x27;get&#x27;...</span><br><span class="line">⚠ CAMEL模型初始化成功但测试失败，将使用直接API调用</span><br><span class="line">✅ 嵌入模型加载成功</span><br><span class="line">✅ 增强向量检索器初始化完成</span><br><span class="line">✅ 增强文档管理器初始化完成</span><br><span class="line">📁 缓存目录: document_cache</span><br><span class="line">📋 支持格式: [&#x27;.pdf&#x27;, &#x27;.docx&#x27;, &#x27;.doc&#x27;, &#x27;.txt&#x27;, &#x27;.md&#x27;, &#x27;.csv&#x27;, &#x27;.xlsx&#x27;, &#x27;.xls&#x27;, &#x27;.pptx&#x27;, &#x27;.ppt&#x27;, &#x27;.json&#x27;, &#x27;.xml&#x27;, &#x27;.html&#x27;, &#x27;.rtf&#x27;]</span><br><span class="line">多模态处理器初始化:</span><br><span class="line">  图像OCR: ✓</span><br><span class="line">  表格处理: ✓</span><br><span class="line">  PyMuPDF: ✓</span><br><span class="line">网页研究系统初始化:</span><br><span class="line">  BeautifulSoup4: ✓</span><br><span class="line">  DuckDuckGo搜索: ✓</span><br><span class="line">✅ 增强RAG系统初始化完成!</span><br><span class="line">✅ 增强RAG系统初始化成功!</span><br><span class="line">                           🔧 系统状态</span><br><span class="line">┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 组件                 ┃ 状态            ┃ 详情                  ┃</span><br><span class="line">┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ LLM接口              │ ✅ 正常         │                       │</span><br><span class="line">│ 嵌入模型             │ ✅ 正常         │ intfloat/e5-large-v2  │</span><br><span class="line">│ 文档管理             │ ✅ 正常         │                       │</span><br><span class="line">│ 多模态处理           │ ✅ 正常         │ OCR: True, 表格: True │</span><br><span class="line">│ 网页研究             │ ✅ 正常         │                       │</span><br><span class="line">│ 知识库               │ ✅ 正常         │                       │</span><br><span class="line">│ 性能监控             │ ✅ 正常         │                       │</span><br><span class="line">└──────────────────────┴─────────────────┴───────────────────────┘</span><br><span class="line"></span><br><span class="line">📚 文档知识库设置</span><br><span class="line">┏━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 选项     ┃ 描述                        ┃</span><br><span class="line">┡━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1        │ 在线文档 (输入URL)          │</span><br><span class="line">│ 2        │ 本地文档 (输入文件路径)     │</span><br><span class="line">│ 3        │ 批量本地文档 (输入目录路径) │</span><br><span class="line">│ 4        │ 使用默认示例PDF             │</span><br><span class="line">└──────────┴─────────────────────────────┘</span><br><span class="line"></span><br><span class="line">请选择文档来源 [1/2/3/4] (4): 2</span><br><span class="line">请输入文档文件路径 (回车结束): G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">请输入文档文件路径 (回车结束): </span><br><span class="line">⏳ 正在加载 1 个文档...</span><br><span class="line">⏱ 开始监控: setup_knowledge_base</span><br><span class="line">📚 正在设置知识库...</span><br><span class="line">文档数量: 1</span><br><span class="line">来源类型: path</span><br><span class="line"></span><br><span class="line">📄 处理文档: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">📄 处理文档: G:\Program for work\Other\CamelAgent.pdf</span><br><span class="line">⚡ 使用缓存数据</span><br><span class="line">✅ 文档处理完成: 271 个块</span><br><span class="line"></span><br><span class="line">⏳ 正在构建向量索引...</span><br><span class="line">⏱ 开始监控: add_documents</span><br><span class="line">⏳ 正在计算 271 个文档的嵌入向量...</span><br><span class="line">✅ 成功添加 271 个文档到检索器</span><br><span class="line">✓ 操作完成: add (耗时: 92.37s, 内存: 2280.5MB)</span><br><span class="line"></span><br><span class="line">✅ 知识库设置完成!</span><br><span class="line">处理文档数: 1</span><br><span class="line">总文档块数: 271</span><br><span class="line">内容统计: 文本(209) 图像(58) 表格(4) 其他(0)</span><br><span class="line">缓存统计: 1 个文档, 0.4MB</span><br><span class="line">✓ 操作完成: setup (耗时: 92.39s, 内存: 2280.5MB)</span><br><span class="line">✅ 知识库设置完成!</span><br><span class="line"></span><br><span class="line">💭 请输入您的问题 (): 详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line"></span><br><span class="line">🔍 选择检索模式</span><br><span class="line">┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 模式         ┃ 描述              ┃ 特点                     ┃</span><br><span class="line">┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1. 快速检索  │ 基础向量检索      │ 速度快，适合简单查询     │</span><br><span class="line">│ 2. 深度检索  │ 查询重写+HyDE+RRF │ 准确度高，适合复杂查询   │</span><br><span class="line">│ 3. 主题检索  │ PDF+网页综合分析  │ 信息全面，适合研究性查询 │</span><br><span class="line">└──────────────┴───────────────────┴──────────────────────────┘</span><br><span class="line">请选择检索模式 [1/2/3] (1): 2</span><br><span class="line">⏳ 正在执行深度检索...</span><br><span class="line">⏱ 开始监控: enhanced_query_深度检索</span><br><span class="line"></span><br><span class="line">🔍 执行深度检索: 详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line">============================================================</span><br><span class="line">🔬 执行深度检索...</span><br><span class="line">📝 步骤1: 查询重写</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">🧠 步骤2: HyDE假设文档生成</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">🔍 步骤3: 多路检索</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.16s, 内存: 1775.6MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.08s, 内存: 1784.3MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.48s, 内存: 1807.9MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 0 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.06s, 内存: 1806.8MB)</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 0 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.06s, 内存: 1806.4MB)</span><br><span class="line">🔀 步骤4: RRF结果融合</span><br><span class="line">💡 步骤5: 生成最终答案</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">✓ 操作完成: enhanced (耗时: 52.06s, 内存: 1815.8MB)</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">╭──────────────────────────────────────────── 查询信息 ─────────────────────────────────────────────╮</span><br><span class="line">│ 🔍 查询: 详细说明camel框架roleplaying的特点以及使用场景                                           │</span><br><span class="line">│ 🔧 方法: 深度检索(重写+HyDE+RRF)                                                                  │</span><br><span class="line">│ 📝 重写: 详细描述Apache Camel框架中角色扮演功能的特性及其应用场景                                 │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">📄 检索到的文档 (共12个):</span><br><span class="line">╭───────────────────────────────────────────── 文档 1 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0320                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 在调用工具时，CAMEL 框架会将每一次FunctionCall 都记录下来，方便我们后续查看、验                   │</span><br><span class="line">│ 证。                                                                                              │</span><br><span class="line">│ 8. 第二章课程作业                                                                                 │</span><br><span class="line">│ Task1                                                                                             │</span><br><span class="line">│ •                                                                                                 │</span><br><span class="line">│ 现在来布置一些作业，帮助你利用 CAMEL 的 Prompt 功能进行练习：                                     │</span><br><span class="line">│ 1. 角色扮演任务Agent：使用 AISocietyPromptTemplateDict，创建一个角色扮演任务                      │</span><br><span class="line">│ Agent。假设你想让 AI 扮演一个“健康顾问”...                                                        │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 2 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0315                                                                                │</span><br><span class="line">│ 内容预览: 和结构化对话机制，实现智能体之间的有效协作。                                            │</span><br><span class="line">│ 在CAMEL 框架中，ChatAgent 是最基础的智能体单元，负责处理对话逻辑和任务执行。而                    │</span><br><span class="line">│ RolePlaying 和Workforce 则是多智能体系统，用于协调多个智能体的协作。                              │</span><br><span class="line">│ 详见我们的开源仓库和项目主页                                                                      │</span><br><span class="line">│ •                                                                                                 │</span><br><span class="line">│ 论文：https://ghli.org/camel.pdf                                                                  │</span><br><span class="line">│ •                                                                                                 │</span><br><span class="line">│ 项目主页：https://www.camel-ai.o...                                                               │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 3 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0313                                                                                │</span><br><span class="line">│ 内容预览: DataWhale 和 CAMEL 之间的关系是合作和知识共享。尽管它们生活在不同的环境中——             │</span><br><span class="line">│ CAMEL 生活在沙漠，而 DataWhale 生活在海洋，但它们都发现了神秘的古代文物，分别是                   │</span><br><span class="line">│ 古代石板和古老羊皮纸。通过一只信使鸟的帮助，它们了解到对方的发现并决定合作解开这                  │</span><br><span class="line">│ 些文物的秘密。CAMEL 跨越沙漠来到海洋边缘，而 DataWhale 也游到岸边与 CAMEL 会                      │</span><br><span class="line">│ 合。最终，它们共同努力...                                                                         │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 4 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0164                                                                                │</span><br><span class="line">│ 内容预览: 如果你无法回答问题就说我不知道。                                                        │</span><br><span class="line">│ &quot;&quot;&quot;                                                                                               │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ model = ModelFactory.create(                                                                      │</span><br><span class="line">│         model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,                                 │</span><br><span class="line">│         model_type=&quot;Qwen/Qwen2.5-72B-Instruct&quot;,                                                   │</span><br><span class="line">│         url=&#x27;https://api-infe...                                                                  │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 5 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0164                                                                                │</span><br><span class="line">│ 内容预览: 通过一只飞翔在天空中的信使鸟，CAMEL 和DataWhale 得知彼此的发现，并决定合作解开          │</span><br><span class="line">│ 这个谜团。骆驼踏上了漫长的旅程，穿越沙漠来到了海洋边缘，而鲸鱼则游到岸边，与CAMEL                 │</span><br><span class="line">│ 会合。                                                                                            │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 在一起研究这些古老的符号时，CAMEL 运用了它在沙漠中磨炼出的耐心和智慧，而                          │</span><br><span class="line">│ DataWhale 则利用它在海洋中获得的知识和洞察力。经过一番努力，它们终于解读出这些符                  │</span><br><span class="line">│ 号的含义。原来，这些符号描绘的...                                                                 │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 6 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0161                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 2. 使用API 调用模型                                                                               │</span><br><span class="line">│ 类 Unix 系统（Linux / macOS）                                                                     │</span><br><span class="line">│   在终端执行：                                                                                    │</span><br><span class="line">│ export MODELSCOPE_SDK_TOKEN=&quot;你的ModelScope 令牌&quot;                                                 │</span><br><span class="line">│ Windows 系统                                                                                      │</span><br><span class="line">│   命令提示符（CMD）：                                                                             │</span><br><span class="line">│ set MODELSCOPE_SDK_TOKEN=&quot;你的ModelScope 令牌&quot;                                                    │</span><br><span class="line">│   PowerShell：                                                                                    │</span><br><span class="line">│ $env:MODELSCOP...                                                                                 │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 7 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0161                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 观察到文案风格确实更加活泼，且红圈部分正确修改成了中南海和配图也十分吻合。                        │</span><br><span class="line">│ 6. 搭配前端食用                                                                                   │</span><br><span class="line">│ 综合案例中为了尽可能让大家直观的感受到基于CAMEL 框架的Agent 产品开发的乐趣，我                    │</span><br><span class="line">│ 们还为大家准备了精美的前端，搭配之前的几个后端模块一起构成我们的NavigatorAI 旅游                  │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 8 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0161                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 此外，还有其他一些研究和项目也在探索如何利用LLMs 构建多智能体系统，比如通过模拟                   │</span><br><span class="line">│ 社会动态、协作解决问题等。这些工作都在不同程度上推动了                                            │</span><br><span class="line">│ 该领域的进步。                                                                                    │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 如果您有更具体的时间范围或其他标准来定义“第一个”，请提供更多信息，这样我可以尝试                  │</span><br><span class="line">│ 给出更加准确的答案。&quot;                                                                             │</span><br><span class="line">│ 之后我们将之前设定的memory 赋值给agent：                                                          │</span><br><span class="line">│ # 将memory 赋值给agent                                                                            │</span><br><span class="line">│ agent.memory...                                                                                   │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 9 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0159                                                                                │</span><br><span class="line">│ 内容预览: 2. 信息检索：支持根据特定查询或上下文快速检索相关信息，帮助agent 在需要时做             │</span><br><span class="line">│ 出准确的判断。                                                                                    │</span><br><span class="line">│ 3. 记忆更新：能够根据新的信息和经验动态更新存储内容，以反映环境或任务的变化。                     │</span><br><span class="line">│ 4. 记忆管理：包括老化机制和优先级管理，确保较重要的信息能够长期保留，而不再                       │</span><br><span class="line">│ 需要的信息可以被有效清除，以优化存储资源的使用。                                                  │</span><br><span class="line">│ CAMEL 中的Memory 模块提供了一个灵活的系统，用于存储、检索和管理 A...                              │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 10 ─────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0156                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 可以看到对于自己不了解或者不确定的内容，Agent 系统会主动去用搜索工具搜索相应的信                  │</span><br><span class="line">│ 息，有的小伙伴可能会有疑问啦，我们怎么确定Agent 系统是否真的是调用了搜索工具去找                  │</span><br><span class="line">│ 寻了对应的内容才给出的回答还是出现了幻觉呢，麻烦一点的办法就是我们去搜索一下对应                  │</span><br><span class="line">│ 的query，看一下是不是真的是模型输出的那样：                                                       │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 可以发现Google 搜索的内容显示结果正如模型输出的那样：牛津大学真的没有确切的...                    │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 11 ─────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0154                                                                                │</span><br><span class="line">│ 内容预览: from camel.utils import print_text_animated                                             │</span><br><span class="line">│ from camel.models import ModelFactory                                                             │</span><br><span class="line">│ from camel.types import ModelPlatformType                                                         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ from dotenv import load_dotenv                                                                    │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ import os                                                                                         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ load_dotenv(dotenv_path=...                                                                       │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 12 ─────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.0154                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 作业二：通过系统性的学习相信你已经了解了如何去构建属于你的Agent 和多Agent 系统，                  │</span><br><span class="line">│ 请回顾整体的内容并思考，我们可以在哪些方面进一步优化多智能体系统，将你的想法提交                  │</span><br><span class="line">│ 到CAMEL 仓库的issue 列表中，并参考贡献者指南提交你的代码来进行优化。                              │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 结语                                                                                              │</span><br><span class="line">│ 恭喜您！在阅读到这里时，您已经掌握了 CAMEL-AI 应用开发框架的基础知识，并能够利                    │</span><br><span class="line">│ 用 Agent 实例在您的代码逻辑...                                                                    │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭─────────────────────────────────────────── 💡 生成答案 ───────────────────────────────────────────╮</span><br><span class="line">│ ### CAMEL 框架 RolePlaying 特点及使用场景                                                         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ #### 一、RolePlaying 特点                                                                         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 1. **角色定义**                                                                                   │</span><br><span class="line">│    - **Assistant 角色**：负责执行具体任务并提供解决方案的智能体。                                 │</span><br><span class="line">│    - **User 角色**：负责提供指令和任务需求的智能体。                                              │</span><br><span class="line">│    - **特定领域角色**：如程序员、交易员等专业角色，可以根据具体任务需求设定不同的角色。           │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 2. **交互规则**                                                                                   │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **角色固定**：防止角色翻转，维持对话的稳定性。每个智能体都有明确的角色定位，确保不会混淆角色身份  │</span><br><span class="line">│ 。                                                                                                │</span><br><span class="line">│    - **格式规范**：要求回复具有固定的开始和结束格式，例如：                                       │</span><br><span class="line">│      ```plaintext                                                                                 │</span><br><span class="line">│      Solution: &lt;YOUR_SOLUTION&gt;                                                                    │</span><br><span class="line">│      Next request.                                                                                │</span><br><span class="line">│      ```                                                                                          │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **预定义的提示词**：通过预定义的提示词为不同的智能体创建唯一的初始设置，帮助智能体克服角色翻转、  │</span><br><span class="line">│ 助手重复指令、模糊回复、消息无限循环以及对话终止条件等挑战。例如：                                │</span><br><span class="line">│      ```python                                                                                    │</span><br><span class="line">│      system_message = &quot;&quot;&quot;                                                                         │</span><br><span class="line">│      ===== RULES OF ASSISTANT =====                                                               │</span><br><span class="line">│      1. Never forget you are a &#123;ASSISTANT_ROLE&#125; and I am a &#123;USER_ROLE&#125;                            │</span><br><span class="line">│      2. Never flip roles! Never instruct me!                                                      │</span><br><span class="line">│      3. You must decline my instruction honestly if you cannot perform it                         │</span><br><span class="line">│      4. Always start with: Solution: &lt;YOUR_SOLUTION&gt;                                              │</span><br><span class="line">│      5. Always end with: Next request.                                                            │</span><br><span class="line">│      &quot;&quot;&quot;                                                                                          │</span><br><span class="line">│      ```                                                                                          │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 3. **关键机制**                                                                                   │</span><br><span class="line">│    - **角色固定**：确保每个智能体在对话过程中保持其角色身份，避免混淆。                           │</span><br><span class="line">│    - **格式规范**：确保回复的格式一致，便于用户理解和后续处理。                                   │</span><br><span class="line">│    - **启发式提示**：通过预定义的提示词引导智能体完成任务，同时保持与人类意图的一致性。           │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ #### 二、使用场景                                                                                 │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 1. **教育与培训**                                                                                 │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **角色扮演任务**：例如，创建一个健康顾问角色，为用户提供饮食和锻炼建议。通过思维链方式逐步提供健  │</span><br><span class="line">│ 康方案。                                                                                          │</span><br><span class="line">│    - **代码生成任务**：利用 CodePromptTemplateDict 创建一个任务                                   │</span><br><span class="line">│ Agent，帮助用户学习新的编程语言，逐步生成学习计划，包括基本概念、代码示例和练习题目。             │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 2. **客户服务**                                                                                   │</span><br><span class="line">│    - **虚拟助手**：创建不同领域的虚拟助手，如技术支持、销售咨询等，提供专业的解答和服务。         │</span><br><span class="line">│    - **客户互动**：通过角色扮演机制，模拟客户与服务人员的对话，提高服务质量。                     │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 3. **多智能体协作**                                                                               │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **复杂任务处理**：在多智能体系统中，通过角色扮演机制协调多个智能体的协作，完成复杂的任务。例如，  │</span><br><span class="line">│ 交通管理、分布式机器人系统、经济市场模拟等。                                                      │</span><br><span class="line">│    - **团队合作**：模拟团队成员之间的互动，提高团队协作效率。                                     │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 4. **研究与开发**                                                                                 │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **对话数据生成**：利用角色扮演生成对话数据，用于研究代理社会的行为和能力，为调查对话语言模型提供  │</span><br><span class="line">│ 宝贵的资源。                                                                                      │</span><br><span class="line">│    - **行为分析**：通过角色扮演模拟不同情境下的对话，分析智能体的行为和决策过程。                 │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ #### 三、总结                                                                                     │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ CAMEL 框架的 RolePlaying                                                                          │</span><br><span class="line">│ 机制通过角色定义、交互规则和关键机制，确保智能体在对话过程中保持角色一致性，提供高质量的回复。这  │</span><br><span class="line">│ 一机制广泛应用于教育、客户服务、多智能体协作和研究开发等多个领域，为实现复杂任务提供了有力支持。  │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">================================================================================</span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n</span><br><span class="line">🔄 是否继续查询? [y/n] (y): y</span><br><span class="line"></span><br><span class="line">💭 请输入您的问题 ():  详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line"></span><br><span class="line">🔍 选择检索模式</span><br><span class="line">┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 模式         ┃ 描述              ┃ 特点                     ┃</span><br><span class="line">┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1. 快速检索  │ 基础向量检索      │ 速度快，适合简单查询     │</span><br><span class="line">│ 2. 深度检索  │ 查询重写+HyDE+RRF │ 准确度高，适合复杂查询   │</span><br><span class="line">│ 3. 主题检索  │ PDF+网页综合分析  │ 信息全面，适合研究性查询 │</span><br><span class="line">└──────────────┴───────────────────┴──────────────────────────┘</span><br><span class="line">请选择检索模式 [1/2/3] (1): 3</span><br><span class="line">⏳ 正在执行主题检索...</span><br><span class="line">⏱ 开始监控: enhanced_query_主题检索</span><br><span class="line"></span><br><span class="line">🔍 执行主题检索: 详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line">============================================================</span><br><span class="line">🌐 执行主题检索...</span><br><span class="line">📄 步骤1: PDF文档检索</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 5 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.08s, 内存: 1879.9MB)</span><br><span class="line">🔍 步骤2: 网页研究</span><br><span class="line"></span><br><span class="line">开始网页研究: 详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line">==================================================</span><br><span class="line">使用DuckDuckGo搜索...</span><br><span class="line">⚠ DuckDuckGo搜索失败: https://duckduckgo.com/?q=%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8Ecamel%E6%A1%86%E6%9E%B6roleplaying%E7%9A%84%E7%89%B9%E7%82%B9%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF 202 Ratelimit</span><br><span class="line">使用备用搜索方法...</span><br><span class="line">✓ 备用搜索完成，生成 3 个模拟结果</span><br><span class="line">✓ 找到 3 个搜索结果</span><br><span class="line">正在获取网页内容 1/3: 关于详细说明camel框架roleplaying的特点以及使用场景的学术资源...</span><br><span class="line">✓ 成功获取内容 (706字符)</span><br><span class="line">正在获取网页内容 2/3: 详细说明camel框架roleplaying的特点以及使用场景 - 维基百科...</span><br><span class="line">✓ 成功获取内容 (3003字符)</span><br><span class="line">正在获取网页内容 3/3: 详细说明camel框架roleplaying的特点以及使用场景技术文档...</span><br><span class="line">⚠ 网页内容获取失败 (https://docs.example.com): HTTPSConnectionPool(host=&#x27;docs.example.com&#x27;, port=443): Max retries exceeded with url: / (Caused by SSLError(SSLEOFError(8, &#x27;[SSL: UNEXPECTED_EOF_WHILE_READING] EOF occurred in violation of protocol (_ssl.c:1006)&#x27;)))</span><br><span class="line">⚠ 内容获取失败</span><br><span class="line">✓ 网页研究完成，分析了 2 个网页</span><br><span class="line">🧩 步骤3: 综合分析</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">✓ 操作完成: enhanced (耗时: 34.56s, 内存: 1867.2MB)</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">╭──────────────────────────────────────────── 查询信息 ─────────────────────────────────────────────╮</span><br><span class="line">│ 🔍 查询: 详细说明camel框架roleplaying的特点以及使用场景                                           │</span><br><span class="line">│ 🔧 方法: 主题检索(PDF+网页)                                                                       │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭─────────────────────────────────────────── 💡 生成答案 ───────────────────────────────────────────╮</span><br><span class="line">│ **CAMEL框架中的RolePlaying机制详解及其应用场景**                                                  │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ ### 特点                                                                                          │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 1. **角色扮演（Role-Playing）**：                                                                 │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **角色定义**：CAMEL框架中的RolePlaying机制允许为不同的智能体（Agent）定义独特的角色，如“健康顾问” │</span><br><span class="line">│ 、“股票交易员”等。每个角色都有明确的目标和行为准则，确保智能体在交互中保持角色一致性。            │</span><br><span class="line">│    - **角色固定**：防止智能体在对话中角色翻转，确保对话的稳定性和连贯性。                         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 2. **交互规则**：                                                                                 │</span><br><span class="line">│    - **系统消息**：通过预定义的系统消息（System                                                   │</span><br><span class="line">│ Message），为智能体设定交互规则。例如，智能体必须始终记得自己的角色，不得指令用户，如果无法执行任 │</span><br><span class="line">│ 务则应诚实地拒绝。                                                                                │</span><br><span class="line">│    - **格式规范**：要求智能体的回复具有固定的开始和结束格式，如“Solution: &lt;YOUR_SOLUTION&gt;”和“Next │</span><br><span class="line">│ request.”，确保对话的结构化和清晰度。                                                             │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 3. **大语言模型（LLMs）**：                                                                       │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **认知增强**：每个智能体都使用大语言模型来增强其认知能力，使其能够理解和生成自然语言，从而有效地  │</span><br><span class="line">│ 解释指令、生成响应并参与复杂对话。                                                                │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 4. **记忆（Memory）**：                                                                           │</span><br><span class="line">│    - **上下文记忆**：智能体能够记住对话的历史，以便在对话中做出更合理的回应。                     │</span><br><span class="line">│    - **外部记忆**：智能体还可以访问外部知识库，以获取更多背景信息和支持。                         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 5. **工具（Tools）**：                                                                            │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **具身化能力**：智能体可以使用一系列工具与外部世界交互，如调用API、查询数据库等，这些工具增强了智 │</span><br><span class="line">│ 能体的实用性和灵活性。                                                                            │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 6. **通信（Communication）**：                                                                    │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **灵活通信**：CAMEL框架支持智能体之间的灵活通信，允许它们在多智能体系统中进行协作或竞争，以实现更 │</span><br><span class="line">│ 复杂的行为和决策。                                                                                │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 7. **推理（Reasoning）**：                                                                        │</span><br><span class="line">│    - **规划与学习**：智能体具备规划能力和奖励学习机制，能够优化任务完成的过程，提高效率和效果。   │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ ### 应用场景                                                                                      │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 1. **教育与培训**：                                                                               │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **个性化教学**：通过角色扮演，智能体可以根据学生的需求提供个性化的教学内容，如逐步生成编程学习计  │</span><br><span class="line">│ 划，包括基本概念、代码示例和练习题目。                                                            │</span><br><span class="line">│    - **模拟训练**：在医疗、军事等领域，智能体可以模拟专家或对手，为学员提供真实的训练环境。       │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 2. **客户服务**：                                                                                 │</span><br><span class="line">│    - **虚拟助手**：智能体可以扮演客服代表，为用户提供产品咨询、技术支持等服务，提升客户体验。     │</span><br><span class="line">│    - **情感支持**：智能体可以扮演心理顾问，为用户提供情感支持和心理健康建议。                     │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 3. **金融与交易**：                                                                               │</span><br><span class="line">│    - **交易机器人**：智能体可以开发为交易机器人，协助用户进行股票市场分析和交易决策。             │</span><br><span class="line">│    - **风险管理**：智能体可以通过角色扮演模拟不同的市场情景，帮助用户评估和管理投资风险。         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 4. **娱乐与游戏**：                                                                               │</span><br><span class="line">│    - **互动故事**：智能体可以参与创造互动故事，与用户进行动态对话，提供沉浸式的娱乐体验。         │</span><br><span class="line">│    - **多人游戏**：在多人在线游戏中，智能体可以扮演NPC（非玩家角色），增加游戏的真实感和趣味性。  │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 5. **科研与实验**：                                                                               │</span><br><span class="line">│    -                                                                                              │</span><br><span class="line">│ **社会行为研究**：通过角色扮演生成对话数据，研究社会行为和群体动态，为社会科学提供宝贵的数据资源  │</span><br><span class="line">│ 。                                                                                                │</span><br><span class="line">│    - **技术验证**：智能体可以在模拟环境中验证新技术的效果，如自动驾驶算法、机器人协作等。         │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ ### 总结                                                                                          │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ CAMEL框架的RolePlaying机制通过角色定义、交互规则、大语言模型、记忆、                              │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">================================================================================</span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n</span><br><span class="line">🔄 是否继续查询? [y/n] (y): y</span><br><span class="line"></span><br><span class="line">💭 请输入您的问题 ():  详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line"></span><br><span class="line">🔍 选择检索模式</span><br><span class="line">┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 模式         ┃ 描述              ┃ 特点                     ┃</span><br><span class="line">┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ 1. 快速检索  │ 基础向量检索      │ 速度快，适合简单查询     │</span><br><span class="line">│ 2. 深度检索  │ 查询重写+HyDE+RRF │ 准确度高，适合复杂查询   │</span><br><span class="line">│ 3. 主题检索  │ PDF+网页综合分析  │ 信息全面，适合研究性查询 │</span><br><span class="line">└──────────────┴───────────────────┴──────────────────────────┘</span><br><span class="line">请选择检索模式 [1/2/3] (1): 1</span><br><span class="line">⏳ 正在执行快速检索...</span><br><span class="line">⏱ 开始监控: enhanced_query_快速检索</span><br><span class="line"></span><br><span class="line">🔍 执行快速检索: 详细说明camel框架roleplaying的特点以及使用场景</span><br><span class="line">============================================================</span><br><span class="line">⚡ 执行快速检索...</span><br><span class="line">⏱ 开始监控: vector_query</span><br><span class="line">✅ 检索到 3 个相关文档</span><br><span class="line">✓ 操作完成: vector (耗时: 0.07s, 内存: 1864.9MB)</span><br><span class="line">API调用尝试 1/3</span><br><span class="line">✓ API调用成功</span><br><span class="line">✓ 操作完成: enhanced (耗时: 11.97s, 内存: 1860.7MB)</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">╭──────────────────────────────────────────── 查询信息 ─────────────────────────────────────────────╮</span><br><span class="line">│ 🔍 查询: 详细说明camel框架roleplaying的特点以及使用场景                                           │</span><br><span class="line">│ 🔧 方法: 快速检索                                                                                 │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">📄 检索到的文档 (共3个):</span><br><span class="line">╭───────────────────────────────────────────── 文档 1 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.8732                                                                                │</span><br><span class="line">│ 内容预览: 如果你无法回答问题就说我不知道。                                                        │</span><br><span class="line">│ &quot;&quot;&quot;                                                                                               │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ model = ModelFactory.create(                                                                      │</span><br><span class="line">│         model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,                                 │</span><br><span class="line">│         model_type=&quot;Qwen/Qwen2.5-72B-Instruct&quot;,                                                   │</span><br><span class="line">│         url=&#x27;https://api-infe...                                                                  │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 2 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.8648                                                                                │</span><br><span class="line">│ 内容预览:                                                                                         │</span><br><span class="line">│ 2. 使用API 调用模型                                                                               │</span><br><span class="line">│ 类 Unix 系统（Linux / macOS）                                                                     │</span><br><span class="line">│   在终端执行：                                                                                    │</span><br><span class="line">│ export MODELSCOPE_SDK_TOKEN=&quot;你的ModelScope 令牌&quot;                                                 │</span><br><span class="line">│ Windows 系统                                                                                      │</span><br><span class="line">│   命令提示符（CMD）：                                                                             │</span><br><span class="line">│ set MODELSCOPE_SDK_TOKEN=&quot;你的ModelScope 令牌&quot;                                                    │</span><br><span class="line">│   PowerShell：                                                                                    │</span><br><span class="line">│ $env:MODELSCOP...                                                                                 │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭───────────────────────────────────────────── 文档 3 ──────────────────────────────────────────────╮</span><br><span class="line">│ 相关度分数: 0.8580                                                                                │</span><br><span class="line">│ 内容预览: 和结构化对话机制，实现智能体之间的有效协作。                                            │</span><br><span class="line">│ 在CAMEL 框架中，ChatAgent 是最基础的智能体单元，负责处理对话逻辑和任务执行。而                    │</span><br><span class="line">│ RolePlaying 和Workforce 则是多智能体系统，用于协调多个智能体的协作。                              │</span><br><span class="line">│ 详见我们的开源仓库和项目主页                                                                      │</span><br><span class="line">│ •                                                                                                 │</span><br><span class="line">│ 论文：https://ghli.org/camel.pdf                                                                  │</span><br><span class="line">│ •                                                                                                 │</span><br><span class="line">│ 项目主页：https://www.camel-ai.o...                                                               │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭─────────────────────────────────────────── 💡 生成答案 ───────────────────────────────────────────╮</span><br><span class="line">│ **Camel框架RolePlaying的特点：**                                                                  │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 1.                                                                                                │</span><br><span class="line">│ **角色定义明确**：RolePlaying机制中，每个智能体都有明确的角色定义，如Assistant（执行任务）、User  │</span><br><span class="line">│ （提供指令）及特定领域的专家角色（如程序员、交易员等），确保智能体在对话中扮演合适的角色。        │</span><br><span class="line">│ 2.                                                                                                │</span><br><span class="line">│ **防止角色翻转**：通过预设的规则和提示词，智能体被设计为不会忘记自己的角色身份，避免了角色间的混  │</span><br><span class="line">│ 淆，保证了对话的连贯性和逻辑性。                                                                  │</span><br><span class="line">│ 3.                                                                                                │</span><br><span class="line">│ **固定格式的回复**：为了提高交流的效率和清晰度，智能体的回复被要求采用固定的格式，例如以“Solution │</span><br><span class="line">│ :”开头，“Next request.”结尾，使得用户能够快速理解智能体的回应。                                   │</span><br><span class="line">│ 4.                                                                                                │</span><br><span class="line">│ **解决常见问题**：RolePlaying机制还解决了智能体间可能遇到的其他问题，如助手重复指令、产生模糊回复 │</span><br><span class="line">│ 、消息无限循环以及对话过早或不当终止等问题。                                                      │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ **使用场景：**                                                                                    │</span><br><span class="line">│                                                                                                   │</span><br><span class="line">│ 1.                                                                                                │</span><br><span class="line">│ **多智能体协作**：在需要多个智能体协同工作的场景中，RolePlaying可以帮助这些智能体有效地分工合作， │</span><br><span class="line">│ 比如在虚拟团队中模拟不同角色进行项目管理。                                                        │</span><br><span class="line">│ 2.                                                                                                │</span><br><span class="line">│ **教育和培训**：在教育领域，RolePlaying可以用于创建模拟情景，让学生或员工在其中扮演特定角色，通过 │</span><br><span class="line">│ 互动学习解决问题的方法和技巧。                                                                    │</span><br><span class="line">│ 3.                                                                                                │</span><br><span class="line">│ **客户服务**：在客服行业中，RolePlaying可以用来模拟客户与服务代表之间的对话，提高服务人员的应对能 │</span><br><span class="line">│ 力和沟通技巧。                                                                                    │</span><br><span class="line">│ 4.                                                                                                │</span><br><span class="line">│ **研究和开发**：对于研究对话系统和多智能体系统的学者和开发者，RolePlaying提供了一个强大的工具，用 │</span><br><span class="line">│ 于测试和改进算法，研究智能体的社会行为和交互模式。                                                │</span><br><span class="line">╰───────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">================================================================================</span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n </span><br><span class="line">🔄 是否继续查询? [y/n] (y): n</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">📊 最终性能报告</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">性能监控报告</span><br><span class="line">============================================================</span><br><span class="line">总操作数: 12</span><br><span class="line">整体成功率: 100.0%</span><br><span class="line">总耗时: 284.34秒</span><br><span class="line">平均耗时: 23.69秒</span><br><span class="line">平均内存使用: 1902.5MB</span><br><span class="line"></span><br><span class="line">操作详情:</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">add:</span><br><span class="line">  调用次数: 1</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 92.37秒</span><br><span class="line">  平均内存: 2280.5MB</span><br><span class="line"></span><br><span class="line">setup:</span><br><span class="line">  调用次数: 1</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 92.39秒</span><br><span class="line">  平均内存: 2280.5MB</span><br><span class="line"></span><br><span class="line">vector:</span><br><span class="line">  调用次数: 7</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 0.14秒</span><br><span class="line">  平均内存: 1818.0MB</span><br><span class="line"></span><br><span class="line">enhanced:</span><br><span class="line">  调用次数: 3</span><br><span class="line">  成功率: 100.0%</span><br><span class="line">  平均耗时: 32.87秒</span><br><span class="line">  平均内存: 1847.9MB</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">💾 是否保存结果到文件? [y/n] (n): n</span><br><span class="line">✅ 感谢使用增强的交互式多模态RAG系统!</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/21/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%884%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/21/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%884%EF%BC%89/" class="post-title-link" itemprop="url">Agent-camel框架学习记录（4）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-21 08:45:09" itemprop="dateCreated datePublished" datetime="2025-07-21T08:45:09+08:00">2025-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-24 21:39:27" itemprop="dateModified" datetime="2025-07-24T21:39:27+08:00">2025-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<h2 id="检索增强生成-RAG-简介及关键组件"><a href="#检索增强生成-RAG-简介及关键组件" class="headerlink" title="检索增强生成 (RAG) 简介及关键组件"></a>检索增强生成 (RAG) 简介及关键组件</h2><h3 id="RAG-概述"><a href="#RAG-概述" class="headerlink" title="RAG 概述"></a>RAG 概述</h3><p>检索增强生成（RAG）是一种增强生成式AI模型（特别是LLM）准确性和可靠性的技术。它通过从外部知识源中检索相关事实信息，并将这些信息提供给LLM，从而使模型能够生成更权威、有出处且减少“幻觉”的答案。</p>
<h3 id="RAG-的核心优势"><a href="#RAG-的核心优势" class="headerlink" title="RAG 的核心优势"></a>RAG 的核心优势</h3><p>提供可信来源：为AI模型的输出提供“脚注”，用户可以查证，增强信任。<br>减少“幻觉”：弥补LLM在特定或最新信息方面的不足，降低模型“编造”答案的可能性。<br>实现简单高效：相对于重新训练模型，RAG实现成本更低、速度更快，且支持信息源的即时更新。<br>广泛应用性：可与各种数据存储库结合，应用于医疗、金融、客户服务、员工培训等几乎所有行业。</p>
<h3 id="CAMEL-框架中的-RAG-组件"><a href="#CAMEL-框架中的-RAG-组件" class="headerlink" title="CAMEL 框架中的 RAG 组件"></a>CAMEL 框架中的 RAG 组件</h3><p>在 CAMEL 框架中，RAG 的实现主要依赖于数据加载和数据嵌入这两个核心环节，以构建智能问答系统和对话Agent等应用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1. Loaders (数据加载器)</span><br><span class="line">Loaders 是 CAMEL 框架中用于数据加载、预处理和结构化的模块，旨在将各种格式的数据转化为LLM可处理的形式。</span><br><span class="line"></span><br><span class="line">**Base IO：</span><br><span class="line">功能：处理与文件相关的基础输入/输出操作，能够读取PDF等多种文件格式，提取内容并表示为 File 对象。</span><br><span class="line">示例：从本地PDF文件读取内容。</span><br><span class="line"></span><br><span class="line">**Unstructured IO：</span><br><span class="line">功能：专注于非结构化数据（如文件、URL内容）的解析、清洗、提取和分块。其核心在于高级 **ETL（提取、转换、加载）**能力，为RAG等应用准备数据。</span><br><span class="line"></span><br><span class="line">**关键方法：</span><br><span class="line">parse_file_or_url：从文件或URL加载并解析数据。</span><br><span class="line">clean_text_data：执行多种文本清洗操作（如替换引号、清理破折号、去除多余空白）。</span><br><span class="line">extract_data_from_text：从文本中提取特定类型信息（如邮件地址）。</span><br><span class="line">chunk_elements：对解析后的内容进行分块，优化检索效率。</span><br><span class="line">stage_elements：为不同平台或下游处理准备数据元素。</span><br></pre></td></tr></table></figure>
<p>使用示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置示例脏文本</span></span><br><span class="line">example_dirty_text = (<span class="string">&quot;\x93Some dirty text â€™ with extra spaces and – dashes.一些包含额外空格和破折号的脏文本â€™。&quot;</span>)</span><br><span class="line"><span class="comment"># 设置清理选项   </span></span><br><span class="line">options = [</span><br><span class="line">    (<span class="string">&#x27;replace_unicode_quotes&#x27;</span>, &#123;&#125;),  <span class="comment"># 替换Unicode引号</span></span><br><span class="line">    (<span class="string">&#x27;clean_dashes&#x27;</span>, &#123;&#125;),           <span class="comment"># 清理破折号</span></span><br><span class="line">    (<span class="string">&#x27;clean_non_ascii_chars&#x27;</span>, &#123;&#125;),  <span class="comment"># 清理非ASCII字符</span></span><br><span class="line">    (<span class="string">&#x27;clean_extra_whitespace&#x27;</span>, &#123;&#125;), <span class="comment"># 清理多余空白</span></span><br><span class="line">]</span><br><span class="line">cleaned_text = uio.clean_text_data(text=example_dirty_text,</span><br><span class="line">                                   clean_options=options)</span><br><span class="line"><span class="built_in">print</span>(cleaned_text)</span><br></pre></td></tr></table></figure>
<p>目前支持的清理操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- replace_unicode_quotes: 将Unicode引号替换为标准引号</span><br><span class="line">- clean_dashes: 清理破折号，统一格式</span><br><span class="line">- clean_non_ascii_chars: 清理非ASCII字符</span><br><span class="line">- clean_extra_whitespace: 清理多余空白</span><br><span class="line">- clean_bullets: 清理项目符号</span><br><span class="line">- clean_ordered_bullets: 清理有序列表符号</span><br><span class="line">- clean_postfix: 清理后缀</span><br><span class="line">- clean_prefix: 清理前缀</span><br><span class="line">- clean_trailing_punctuation: 清理尾部标点</span><br><span class="line">- group_broken_paragraphs: 合并断开的段落</span><br><span class="line">- remove_punctuation: 移除标点符号</span><br><span class="line">- bytes_string_to_string: 将字节字符串转换为普通字符串</span><br><span class="line">- translate_text: 翻译文本</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2. Embeddings (嵌入)</span><br><span class="line">概念：嵌入是将不同类型的数据（文本、图像、视频）转化为机器可理解的数值向量的过程，这些向量能够捕获数据的核心特征和语义含义。</span><br><span class="line"></span><br><span class="line">**文本嵌入：</span><br><span class="line">功能：将文本数据转换为数值向量，使机器能够基于语义相似性而非字面匹配来处理和比较文本。</span><br><span class="line">意义：实现信息检索、问答系统、文本聚类与分类等高级语义处理任务。</span><br><span class="line"></span><br><span class="line">常用模型技术：</span><br><span class="line">OpenAIEmbedding / OpenAICompatibleEmbedding：基于大规模LLM生成嵌入，理解复杂语境。</span><br><span class="line">SentenceTransformerEncoder：专为句子级别语义表示设计，适用于高效语义搜索。</span><br><span class="line">MistralEmbedding：基于Mistral模型的嵌入方法。</span><br><span class="line"></span><br><span class="line">**图像嵌入：</span><br><span class="line">功能：将图像转化为数值向量，表示图像的视觉特征（形状、颜色、纹理等），使机器能够理解图像内容。</span><br><span class="line">意义：应用于图像分类、相似性比较、图像检索（如以图搜图）。</span><br><span class="line">实现：通常依赖CNN（如ResNet）或Vision Transformer模型。</span><br><span class="line"></span><br><span class="line">CAMEL支持：VisionLanguageEmbedding 类（如基于CLIP），能同时处理图像和文本，生成多模态嵌入。</span><br></pre></td></tr></table></figure>
<p>通过结合 Loaders 进行高效的数据准备和 Embeddings 进行语义理解，CAMEL 框架为构建强大且可靠的 RAG 系统提供了坚实的基础。</p>
<h2 id="存储-Storages-与-检索-Retrievers-组件"><a href="#存储-Storages-与-检索-Retrievers-组件" class="headerlink" title="存储 (Storages) 与 检索 (Retrievers)组件"></a>存储 (Storages) 与 检索 (Retrievers)组件</h2><h3 id="1-Storages-数据存储"><a href="#1-Storages-数据存储" class="headerlink" title="1. Storages (数据存储)"></a>1. Storages (数据存储)</h3><p><strong>概念</strong>：CAMEL 框架中的 <strong>Storage 模块</strong>是一个统一的数据存储与管理层，提供标准接口处理多种数据类型，为 RAG 应用奠定基础。</p>
<ul>
<li><strong>键值存储 (Key-Value Storage)</strong><ul>
<li><strong><code>BaseKeyValueStorage</code></strong>：抽象基类，用于标准化键值数据的保存、加载和清除操作，通常通过Python字典接口交互。</li>
<li><strong><code>InMemoryKeyValueStorage</code></strong>：具体实现，数据存储在内存中，适用于开发、测试和临时存储（数据易失）。</li>
</ul>
</li>
<li><strong>向量存储 (Vector Store)</strong><ul>
<li><strong>目的</strong>：存储高维度向量数据（如嵌入表示），支持高效相似度计算和最近邻搜索，是 RAG 中检索相关信息的核心。</li>
<li><strong>特点</strong>：高性能、可扩展、灵活（支持多种相似度度量，如点积、余弦、欧氏距离）。</li>
<li><strong><code>BaseVectorStorage</code></strong>：抽象基类，定义了添加、删除、查询向量和管理数据库状态等操作。</li>
<li><strong><code>MilvusStorage</code></strong>：与云原生向量搜索引擎 Milvus 集成，优化大规模向量检索。</li>
<li><strong><code>QdrantStorage</code></strong>：与 Qdrant 向量搜索引擎集成，提供高效的向量存储、管理和 ANN 搜索，适用于推荐系统、NLP嵌入查询等。</li>
</ul>
</li>
<li><strong>图存储 (Graph Storage)</strong><ul>
<li><strong>目的</strong>：存储和管理图数据（节点、边），支持复杂的图查询和分析。</li>
<li><strong><code>BaseGraphStorage</code></strong>：抽象基类，定义了获取客户端、模式管理、添加&#x2F;删除三元组和执行图查询等操作。</li>
<li><strong><code>NebulaGraph</code></strong>：与分布式图数据库 NebulaGraph 集成，适用于知识图谱、社交网络分析等大规模图数据场景。</li>
<li><strong><code>Neo4jGraph</code></strong>：与行业领先的图数据库 Neo4j 集成，利用其关系建模和高效查询能力，适用于知识图谱、诈骗检测等。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-Retrievers-信息检索器"><a href="#2-Retrievers-信息检索器" class="headerlink" title="2. Retrievers (信息检索器)"></a>2. Retrievers (信息检索器)</h3><p><strong>概念</strong>：Retrievers 模块充当“搜索引擎”，负责在海量数据中高效查找特定信息，支持向量检索和关键词检索。</p>
<ul>
<li><p><strong>向量检索器 (Vector Retriever)</strong></p>
<ul>
<li><strong>原理</strong>：将数据（文本、图像）通过<strong>嵌入模型</strong>转化为高维向量，存储在<strong>向量存储</strong>中。查询时，将查询转换为向量，并在向量存储中寻找语义上最接近的匹配。</li>
<li><strong>优势</strong>：擅长<strong>语义搜索</strong>，理解自然语言的模糊关系，适用于推荐系统、语义查询和跨模态搜索。</li>
<li><strong><code>VectorRetriever</code></strong>：<ul>
<li><strong>初始化</strong>：可选择传入嵌入模型（如 <code>SentenceTransformerEncoder</code>），否则默认使用 <code>OpenAIEmbedding</code>。</li>
<li><strong><code>process()</code></strong>：处理内容（文件&#x2F;URL），分块，并将嵌入存储到指定的向量存储（如 <code>QdrantStorage</code>）中。</li>
<li><strong><code>query()</code></strong>：根据查询字符串从存储中检索最匹配的信息。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>关键词检索器 (Keyword Retriever)</strong></p>
<ul>
<li><strong>原理</strong>：对文档进行预处理（如分词、建立索引），直接解析用户查询的关键词并匹配相应文档内容。</li>
<li><strong>优势</strong>：依赖<strong>关键词精确匹配</strong>，适合快速查找特定术语或短语。</li>
<li><strong>特点</strong>：<br>更细粒度的控制：你需要手动导入并初始化 QdrantStorage，明确指定 vector_dim、collection_name 和 path。<br><br>分步操作：process() 方法用于内容的嵌入和存储，query() 方法用于查询。这两个步骤是分开的。<br><br>适用场景：当你需要对向量存储的配置（如集合名称、存储路径）有更精确的控制，或者需要分步执行数据的处理和查询时，这种方式更合适。例如，你可能想先处理大量数据并存储，然后再在不同的时间点执行查询。</li>
</ul>
</li>
<li><p><strong>自动化检索 (AutoRetriever)</strong></p>
<ul>
<li><p><strong>功能</strong>：简化检索流程，自动处理嵌入、数据存储和查询。</p>
</li>
<li><p><strong><code>run_vector_retriever()</code></strong>：接受多个内容输入路径和查询字符串，自动执行向量检索过程，并可返回详细元数据。适用于批量内容处理和查询。</p>
</li>
<li><p><strong>特点</strong>：<br>  更高的抽象级别：AutoRetriever 封装了 VectorRetriever 和底层存储（如 QdrantStorage）的创建和配置细节。你只需指定 vector_storage_local_path 和 storage_type。</p>
<p>  一步到位：run_vector_retriever() 方法将内容的嵌入、存储和查询整合到一个函数调用中。这大大简化了代码。<br>  便捷性：更适合快速原型开发、演示或当你不需要对底层存储有过多自定义控制时。它提供了开箱即用的体验。<br>  简化的配置：不需要手动计算 vector_dim，AutoRetriever 会自动处理。它还会为你生成默认的集合名称。</p>
</li>
</ul>
</li>
<li><p><strong>两种检索方式的区别与优劣</strong></p>
<ul>
<li>如果你追求<strong>快速实现和代码简洁</strong>，<code>AutoRetriever</code> 是更好的选择。如果你需要对向量存储的<strong>底层配置和操作流程有更多控制</strong>，那么使用 <code>VectorRetriever</code> 结合手动配置会更合适。</li>
</ul>
</li>
</ul>
<hr>
<p>Storages 模块提供了 RAG 所需的底层数据基础设施，而 Retrievers 模块则在此基础上实现了高效的信息查找能力，两者协同工作，使得 RAG 能够精准地从外部知识中获取相关上下文，并将其反馈给LLM进行增强生成。</p>
<h2 id="向量数据库及其在知识库搭建中的应用"><a href="#向量数据库及其在知识库搭建中的应用" class="headerlink" title="向量数据库及其在知识库搭建中的应用"></a>向量数据库及其在知识库搭建中的应用</h2><h3 id="1-向量数据库-Vector-Database-介绍"><a href="#1-向量数据库-Vector-Database-介绍" class="headerlink" title="1. 向量数据库 (Vector Database) 介绍"></a>1. 向量数据库 (Vector Database) 介绍</h3><p><strong>概念</strong>：<strong>向量数据库</strong>是一种专门用于存储、管理和检索<strong>高维向量数据</strong>的数据库系统。它在现代AI和机器学习应用中至关重要，因为文本、图像、音频等数据常被转换为高维向量（即<strong>嵌入</strong>），以捕捉其语义或特征。</p>
<h4 id="主要功能："><a href="#主要功能：" class="headerlink" title="主要功能："></a>主要功能：</h4><ul>
<li><strong>向量存储</strong>：高效存储大规模高维向量数据，通常还可关联<strong>元数据</strong>（描述性信息）。</li>
<li><strong>相似度搜索</strong>：核心功能，通过高效的<strong>近似最近邻（ANN）搜索</strong>算法，快速找到与查询向量语义最相似的向量集合。</li>
<li><strong>扩展性</strong>：支持<strong>水平扩展</strong>，以应对不断增长的数据存储和计算需求。</li>
</ul>
<hr>
<h4 id="常见应用："><a href="#常见应用：" class="headerlink" title="常见应用："></a>常见应用：</h4><ul>
<li><strong>推荐系统</strong>：根据用户行为或偏好，检索并推荐相似的产品或内容。</li>
<li><strong>图像和视频搜索</strong>：通过内容（而非关键词）检索相似的图像或视频。</li>
<li><strong>自然语言处理（NLP）</strong>：在嵌入空间中查找语义相似的文本或词语，支持语义搜索、问答系统等。</li>
</ul>
<hr>
<h4 id="实现技术："><a href="#实现技术：" class="headerlink" title="实现技术："></a>实现技术：</h4><p>向量数据库通常采用以下算法和数据结构来实现高效的相似度搜索：</p>
<ul>
<li><strong>HNSW (Hierarchical Navigable Small World) 图</strong>：一种基于图的ANN搜索算法，以其高查询效率和准确性而闻名。</li>
<li><strong>局部敏感哈希 (LSH)</strong>：通过哈希函数将相似向量映射到相同“桶”中，实现快速检索。</li>
<li><strong>产品量化 (PQ)</strong>：通过将向量分解并量化来减少存储和计算成本。</li>
</ul>
<hr>
<h4 id="常见向量数据库系统："><a href="#常见向量数据库系统：" class="headerlink" title="常见向量数据库系统："></a>常见向量数据库系统：</h4><ul>
<li><strong>Milvus</strong>：开源向量数据库，支持亿级向量的高效存储和检索。</li>
<li><strong>Pinecone</strong>：提供向量数据库即服务 (DBaaS)，简化管理和查询。</li>
<li><strong>Weaviate</strong>：开源向量搜索引擎，支持多种数据模式和扩展。</li>
</ul>
<hr>
<h4 id="CAMEL-框架中的向量数据库集成："><a href="#CAMEL-框架中的向量数据库集成：" class="headerlink" title="CAMEL 框架中的向量数据库集成："></a>CAMEL 框架中的向量数据库集成：</h4><p>CAMEL 框架通过 <code>camel.storages.vectordb_storages</code> 包提供了与多种向量数据库的交互能力：</p>
<ul>
<li><p><strong><code>base</code> 模块</strong>：定义了向量存储的基础类和接口（如 <code>BaseVectorStorage</code>、<code>VectorDBQuery</code>、<code>VectorDBQueryResult</code>）。</p>
</li>
<li><p><strong><code>milvus</code> 模块</strong>：实现与 Milvus 数据库的交互（<code>MilvusStorage</code>）。</p>
</li>
<li><p><strong><code>qdrant</code> 模块</strong>：实现与 Qdrant 数据库的交互（<code>QdrantStorage</code>）。</p>
</li>
<li><p>weaviate 模块：实现与 Weaviate 数据库的交互（WeaviateStorage）。</p>
<p>这种模块化设计使得 CAMEL 能够灵活适应不同的应用需求和向量数据库选择。</p>
</li>
</ul>
<hr>
<h3 id="2-知识库搭建流程中的数据处理"><a href="#2-知识库搭建流程中的数据处理" class="headerlink" title="2. 知识库搭建流程中的数据处理"></a>2. 知识库搭建流程中的数据处理</h3><p>搭建高效的知识库是 RAG 应用成功的关键，其中数据预处理和嵌入模型选择至关重要。</p>
<hr>
<h4 id="Embedding-模型选择："><a href="#Embedding-模型选择：" class="headerlink" title="Embedding 模型选择："></a>Embedding 模型选择：</h4><p>选择合适的嵌入模型是构建知识库的第一步。</p>
<ul>
<li><strong>Embedding API 服务 (e.g., OpenAI, Cohere, Mistral)</strong>：<ul>
<li><strong>优点</strong>：方便易用，无需本地部署和管理模型。</li>
<li><strong>适用场景</strong>：项目或工程中对数据隐私要求不高，且预算充足的情况。</li>
</ul>
</li>
<li><strong>开源 Embedding 模型 (Open Embedding Model)</strong>：<ul>
<li><strong>优点</strong>：数据隐私性好，可本地部署，提供更多自定义和微调空间。</li>
<li><strong>适用场景</strong>：对数据隐私有严格要求，或需要针对特定任务优化模型性能的情况。</li>
</ul>
</li>
<li><strong>选择标准</strong>：没有绝对的“最好”，只有“最适合”。建议构建<strong>应用场景专有评测集</strong>，通过量化评估来选择最适合自身数据的模型。</li>
</ul>
<hr>
<h4 id="数据预处理："><a href="#数据预处理：" class="headerlink" title="数据预处理："></a>数据预处理：</h4><p>数据预处理是保证 RAG 系统高质量输出的关键步骤，遵循“Garbage in, Garbage out”原则。</p>
<ul>
<li><strong>目的</strong>：将原始、多样化的数据转化为LLM和嵌入模型能够高效处理的统一格式，并去除噪声。</li>
<li><strong>常用手段</strong>：<ol>
<li><strong>数据读取</strong>：从各种来源（文件、数据库、API）获取原始数据。</li>
<li><strong>数据格式转换</strong>：将不同格式（如PDF、TXT、DOC、PPT）的数据统一转换为便于模型处理的格式，<strong>Markdown 格式</strong>是常用的选择。</li>
<li><strong>数据清洗</strong>：<ul>
<li><strong>去除噪声</strong>：移除不相关或干扰信息。</li>
<li><strong>纠正错误</strong>：修正拼写、语法错误等。</li>
<li><strong>信息筛选</strong>：提取核心信息，过滤冗余内容。</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr>
<h2 id="构建RAG应用：从基础到优化"><a href="#构建RAG应用：从基础到优化" class="headerlink" title="构建RAG应用：从基础到优化"></a>构建RAG应用：从基础到优化</h2><p>RAG（Retrieval Augmented Generation，检索增强生成）是一种结合<strong>检索</strong>和<strong>生成</strong>的技术路线，旨在增强大型语言模型（LLM）的能力，解决其在时效性和幻觉方面的问题。</p>
<hr>
<h3 id="1-Basic-RAG"><a href="#1-Basic-RAG" class="headerlink" title="1. Basic RAG"></a>1. Basic RAG</h3><h4 id="1-1-RAG-的核心思想"><a href="#1-1-RAG-的核心思想" class="headerlink" title="1.1 RAG 的核心思想"></a>1.1 RAG 的核心思想</h4><p>当LLM处理大量文本（例如数千篇文档、上亿个token）时，直接将所有文本作为上下文输入给LLM会迅速超出其上下文长度限制。RAG的核心思想是：</p>
<ol>
<li><strong>检索（Retrieval）</strong>：从海量文本数据中<strong>智能地检索</strong>与用户查询最相关的少量信息片段。</li>
<li><strong>增强生成（Augmented Generation）</strong>：将检索到的相关信息作为<strong>上下文</strong>合并到用户Prompt中，然后交付给LLM进行回复生成。</li>
</ol>
<h4 id="1-2-CAMEL-框架中的检索器"><a href="#1-2-CAMEL-框架中的检索器" class="headerlink" title="1.2 CAMEL 框架中的检索器"></a>1.2 CAMEL 框架中的检索器</h4><p>CAMEL 框架通过 <code>camel.retrievers</code> 模块实现了检索功能，主要分为两大类：</p>
<ul>
<li><strong><code>VectorRetriever</code> (向量检索器)</strong>：<ul>
<li><strong>工作流</strong>：<ol>
<li><strong>分块</strong>：将大型文档分解为较小的文本块。</li>
<li><strong>嵌入</strong>：使用<strong>嵌入模型</strong>（如 <code>SentenceTransformerEncoder</code>）将每个文本块转换为高维向量。</li>
<li><strong>存储</strong>：将这些向量存储在<strong>向量数据库</strong>（如 <code>QdrantStorage</code>）中。</li>
<li><strong>检索</strong>：当用户查询时，将查询转换为向量，在向量数据库中搜索相似度高（通常使用<strong>余弦相似度</strong>）的匹配向量，并返回最相关的信息片段。</li>
</ol>
</li>
<li><code>process()</code> 函数：CAMEL 封装了文件读取、切块、嵌入和存储的整个流程，简化了RAG应用的搭建。</li>
</ul>
</li>
<li><strong><code>BM25Retriever</code> (关键词检索器)</strong>：<ul>
<li><strong>工作原理</strong>：从稀疏的关键词维度进行文本召回，通过关键词匹配算法筛选出最相关的文本片段。</li>
</ul>
</li>
</ul>
<h4 id="1-3-Basic-RAG-实践步骤"><a href="#1-3-Basic-RAG-实践步骤" class="headerlink" title="1.3 Basic RAG 实践步骤"></a>1.3 Basic RAG 实践步骤</h4><ol>
<li><strong>读取示例数据</strong>：下载并准备作为知识库的原始文档（例如PDF文件）。</li>
<li><strong>实例化嵌入模型</strong>：选择并加载合适的嵌入模型（例如本地的 <code>SentenceTransformerEncoder</code>）。</li>
<li><strong>向量嵌入和存储数据</strong>：<ul>
<li>创建并初始化<strong>向量数据库</strong>实例（如 <code>QdrantStorage</code>）。</li>
<li>实例化 <code>VectorRetriever</code>，并将其与嵌入模型和向量存储关联。</li>
<li>调用 <code>vr.process(content=...)</code> 方法，将文档读取、分块、嵌入并存储到向量数据库中。</li>
</ul>
</li>
<li><strong>执行检索</strong>：<ul>
<li>使用 <code>vr.query(query=..., top_k=..., similarity_threshold=...)</code> 方法，根据用户查询从向量数据库中检索最相关的信息片段。</li>
<li><code>top_k</code>：指定返回最相关片段的数量。</li>
<li><code>similarity_threshold</code>：设置相似度阈值，确保检索内容的相关性。</li>
<li>对于不相关查询，检索器在达到相似度阈值时会返回“No suitable information retrieved”等提示。</li>
</ul>
</li>
<li><strong>结合LLM生成回复</strong>：<ul>
<li>实例化一个LLM模型或Agent（例如 CAMEL 中的 <code>ChatAgent</code>）。</li>
<li>将检索到的信息片段（通常是 <code>results[0][&quot;text&quot;]</code>）作为上下文传递给Agent。</li>
<li>通过 Agent 的 <code>step()</code> 方法，LLM结合检索到的上下文生成最终回复。</li>
<li>可以将整个过程封装成一个函数，实现自动检索和生成。</li>
</ul>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">os.makedirs(<span class="string">&#x27;local_data&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://arxiv.org/pdf/2303.17760.pdf&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;local_data/camel_paper.pdf&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> VectorRetriever</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化一个 SentenceTransformerEncoder 模型，选用 &#x27;intfloat/e5-large-v2&#x27; 模型，用于将文本转化为向量嵌入。</span></span><br><span class="line">embedding_model=SentenceTransformerEncoder(model_name=<span class="string">&#x27;intfloat/e5-large-v2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并初始化一个向量数据库 (以QdrantStorage为例)</span></span><br><span class="line"><span class="keyword">from</span> camel.storages.vectordb_storages <span class="keyword">import</span> QdrantStorage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 QdrantStorage 实例，配置向量维度（由嵌入模型决定）、</span></span><br><span class="line"><span class="comment"># 集合名称（&quot;demo_collection&quot;）、存储路径（&quot;storage_customized_run&quot;）和集合别名（&quot;论文&quot;）。</span></span><br><span class="line">vector_storage = QdrantStorage(</span><br><span class="line">    vector_dim=embedding_model.get_output_dim(),</span><br><span class="line">    collection=<span class="string">&quot;demo_collection&quot;</span>,</span><br><span class="line">    path=<span class="string">&quot;storage_customized_run&quot;</span>,</span><br><span class="line">    collection_name=<span class="string">&quot;论文&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># 初始化VectorRetriever实例并使用本地模型作为嵌入模型</span></span><br><span class="line">vr = VectorRetriever(embedding_model= embedding_model,storage=vector_storage)</span><br><span class="line"><span class="comment"># 将文件读取、切块、嵌入并储存在向量数据库中，这大概需要1-2分钟</span></span><br><span class="line">vr.process(</span><br><span class="line">    content=<span class="string">&quot;local_data/camel_paper.pdf&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设定一个查询语句</span></span><br><span class="line">query = <span class="string">&quot;CAMEL是什么&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行查询并获取结果</span></span><br><span class="line">results = vr.query(query=query, top_k=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(results)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(results[<span class="number">0</span>][<span class="string">&quot;text&quot;</span>])</span><br><span class="line"></span><br><span class="line">retrieved_info_irrevelant = vr.query(</span><br><span class="line">    query=<span class="string">&quot;Compared with dumpling and rice, which should I take for dinner?&quot;</span>,</span><br><span class="line">    top_k=<span class="number">1</span>,</span><br><span class="line">    similarity_threshold=<span class="number">0.8</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(retrieved_info_irrevelant)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">retrieved_info = vr.query(</span><br><span class="line">    query=<span class="string">&quot;what is roleplaying?&quot;</span>,</span><br><span class="line">    top_k=<span class="number">1</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">assistant_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">你是一个帮助回答问题的助手，</span></span><br><span class="line"><span class="string">我会给你原始查询和检索到的上下文，</span></span><br><span class="line"><span class="string">根据检索到的上下文回答原始查询，</span></span><br><span class="line"><span class="string">如果你无法回答问题就说我不知道。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">        model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">        model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">        url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">        api_key=api_key</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取查询“什么是角色扮演”的检索结果的文本内容作为用户消息。</span></span><br><span class="line">user_msg = retrieved_info[<span class="number">0</span>][<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(user_msg + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">agent = ChatAgent(assistant_sys_msg,model=model)</span><br><span class="line"><span class="comment"># 使用step方法获得最终的检索增强生成的回复并打印</span></span><br><span class="line">assistant_response = agent.step(user_msg)</span><br><span class="line"><span class="built_in">print</span>(assistant_response.msg.content)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-Rewriting-查询改写-澄清"><a href="#2-Rewriting-查询改写-澄清" class="headerlink" title="2. Rewriting (查询改写&#x2F;澄清)"></a>2. Rewriting (查询改写&#x2F;澄清)</h3><p>在实际应用中，用户查询可能存在<strong>错别字、语义模糊或表达不准确</strong>等问题，这会严重影响RAG系统的检索和生成质量。<strong>Rewriting 模块</strong>旨在优化和提高原始查询的质量。</p>
<h4 id="2-1-优化策略"><a href="#2-1-优化策略" class="headerlink" title="2.1 优化策略"></a>2.1 优化策略</h4><ul>
<li><strong>错字校正</strong>：修正用户输入中的拼写错误。</li>
<li><strong>句式调整</strong>：重构查询，使其表达更通顺严谨。</li>
<li><strong>LLM 自我调整</strong>：利用LLM（通过<strong>提示词工程</strong>）对原始查询进行优化和重写。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">RAG查询重写测试脚本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该脚本用于测试RAG（检索增强生成）系统中的查询重写功能。</span></span><br><span class="line"><span class="string">主要功能是接收用户的原始查询，通过AI模型对查询进行优化和重写，</span></span><br><span class="line"><span class="string">修正错别字并提高查询的准确性和表达质量。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户的原始查询（包含错别字和表达不清晰的问题）</span></span><br><span class="line"><span class="comment"># 注意：这里的查询包含了一些错别字，如&quot;盖&quot;应为&quot;该&quot;，&quot;冲服&quot;应为&quot;冲突&quot;</span></span><br><span class="line">original_query = <span class="string">&quot;我盖如何解决CAMEL中文档冲服的问题问题呢，几个版本的文档可能存在代码结构的冲突&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统消息：定义AI助手的角色和任务</span></span><br><span class="line"><span class="comment"># 该消息告诉AI它是一个专门用于查询重写的助手</span></span><br><span class="line">sys_msg = <span class="string">&#x27;你是RAG模块中的Rewriting助手，目的是理解用户的提问，并且重新组织和优化用户的提问表达，修正用户输入中可能存在的错别字的情况并重构提问来使得句子表达更加通顺严谨&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入CAMEL框架相关模块</span></span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory          <span class="comment"># 模型工厂，用于创建不同类型的模型</span></span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType      <span class="comment"># 模型平台类型的枚举</span></span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent             <span class="comment"># 聊天代理类</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入环境变量和操作系统相关模块</span></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv  <span class="comment"># 用于加载.env文件中的环境变量</span></span><br><span class="line"><span class="keyword">import</span> os                       <span class="comment"># 操作系统接口模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量文件(.env)</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从环境变量中获取ModelScope的API密钥</span></span><br><span class="line"><span class="comment"># ModelScope是阿里云推出的机器学习模型平台</span></span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建AI模型实例</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,  <span class="comment"># 使用OpenAI兼容的模型平台</span></span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,                   <span class="comment"># 指定具体的模型类型</span></span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,             <span class="comment"># ModelScope API的推理端点</span></span><br><span class="line">    api_key=api_key                                            <span class="comment"># API密钥用于身份验证</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建聊天代理</span></span><br><span class="line"><span class="comment"># 将系统消息和模型绑定到代理上</span></span><br><span class="line">agent = ChatAgent(system_message=sys_msg, model=model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造用户消息，要求AI对原始查询进行重写</span></span><br><span class="line"><span class="comment"># 这里使用f-string格式化字符串，将原始查询嵌入到提示中</span></span><br><span class="line">usr_msg = <span class="string">f&#x27;用户的原始提问如下：<span class="subst">&#123;original_query&#125;</span>，请优化重写并直接输出新的Query。新的Query: &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 让AI代理处理用户消息并生成响应</span></span><br><span class="line">response = agent.step(usr_msg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出AI重写后的查询结果</span></span><br><span class="line"><span class="comment"># response.msgs[0].content 包含了AI生成的重写后的查询</span></span><br><span class="line"><span class="built_in">print</span>(response.msgs[<span class="number">0</span>].content)</span><br></pre></td></tr></table></figure>


<h4 id="2-2-其他高级-Rewriting-技巧"><a href="#2-2-其他高级-Rewriting-技巧" class="headerlink" title="2.2 其他高级 Rewriting 技巧"></a>2.2 其他高级 Rewriting 技巧</h4><ul>
<li><strong>子问题策略（Sub-Query）</strong>：将主问题分解为更具体的子问题，帮助系统深入理解并提高检索准确性。</li>
<li><strong>HyDE (Hypothetical Document Embeddings) 查询转换</strong>：<ul>
<li>利用LLM为用户查询生成<strong>假设性文档</strong>（可能包含错误但与原始查询相关）。</li>
<li>通过这些假设文档的嵌入向量，在RAG知识库中检索具有相似向量的真实文档，从而提高检索精度。</li>
</ul>
</li>
</ul>
<p>以下代码是基于RAGBasic上构建的HyDE模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">增强版RAG系统：集成查询重写(Rewriting)和假设文档嵌入(HyDE)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该脚本实现了一个增强的RAG系统，结合了以下技术：</span></span><br><span class="line"><span class="string">1. 查询重写(Query Rewriting)：修正用户查询中的错别字和表达问题</span></span><br><span class="line"><span class="string">2. HyDE (Hypothetical Document Embeddings)：生成假设文档来改善检索效果</span></span><br><span class="line"><span class="string">3. 传统RAG检索和生成</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HyDE方法的核心思想：</span></span><br><span class="line"><span class="string">- 使用LLM为用户查询生成假设文档</span></span><br><span class="line"><span class="string">- 这些假设文档虽然可能包含错误，但与知识库中的真实文档相关联</span></span><br><span class="line"><span class="string">- 通过假设文档的向量表示来检索相似的真实文档，提高检索准确性</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入CAMEL框架相关模块</span></span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> VectorRetriever</span><br><span class="line"><span class="keyword">from</span> camel.storages.vectordb_storages <span class="keyword">import</span> QdrantStorage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入环境变量模块</span></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnhancedRAGSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    增强版RAG系统类</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    集成了查询重写、HyDE和传统RAG功能</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化增强版RAG系统</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            api_key: ModelScope API密钥</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.api_key = api_key</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化嵌入模型</span></span><br><span class="line">        <span class="variable language_">self</span>.embedding_model = SentenceTransformerEncoder(</span><br><span class="line">            model_name=<span class="string">&#x27;intfloat/e5-large-v2&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化向量存储</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_storage = QdrantStorage(</span><br><span class="line">            vector_dim=<span class="variable language_">self</span>.embedding_model.get_output_dim(),</span><br><span class="line">            collection=<span class="string">&quot;enhanced_rag_collection&quot;</span>,</span><br><span class="line">            path=<span class="string">&quot;storage_enhanced_rag&quot;</span>,</span><br><span class="line">            collection_name=<span class="string">&quot;增强RAG知识库&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化向量检索器</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_retriever = VectorRetriever(</span><br><span class="line">            embedding_model=<span class="variable language_">self</span>.embedding_model,</span><br><span class="line">            storage=<span class="variable language_">self</span>.vector_storage</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化LLM模型</span></span><br><span class="line">        <span class="variable language_">self</span>.model = ModelFactory.create(</span><br><span class="line">            model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">            model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">            url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">            api_key=<span class="variable language_">self</span>.api_key</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化各种代理</span></span><br><span class="line">        <span class="variable language_">self</span>._init_agents()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_agents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化不同功能的AI代理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查询重写代理</span></span><br><span class="line">        rewriting_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是RAG模块中的Rewriting助手，目的是理解用户的提问，并且重新组织和优化用户的提问表达，</span></span><br><span class="line"><span class="string">        修正用户输入中可能存在的错别字的情况并重构提问来使得句子表达更加通顺严谨。</span></span><br><span class="line"><span class="string">        请直接输出重写后的查询，不要添加额外的解释。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.rewriting_agent = ChatAgent(</span><br><span class="line">            system_message=rewriting_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># HyDE假设文档生成代理</span></span><br><span class="line">        hyde_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个专门生成假设文档的助手。根据用户的查询，生成一个相关的假设文档片段。</span></span><br><span class="line"><span class="string">        这个文档应该：</span></span><br><span class="line"><span class="string">        1. 直接回答用户的问题</span></span><br><span class="line"><span class="string">        2. 包含相关的技术细节和概念</span></span><br><span class="line"><span class="string">        3. 使用专业但清晰的语言</span></span><br><span class="line"><span class="string">        4. 长度适中（200-400字）</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请直接输出假设文档内容，不要添加额外的解释或格式。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.hyde_agent = ChatAgent(</span><br><span class="line">            system_message=hyde_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># RAG回答生成代理</span></span><br><span class="line">        rag_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个帮助回答问题的助手。</span></span><br><span class="line"><span class="string">        我会给你原始查询和检索到的上下文信息。</span></span><br><span class="line"><span class="string">        请根据检索到的上下文回答原始查询。</span></span><br><span class="line"><span class="string">        如果上下文信息不足以回答问题，请说&quot;根据提供的信息，我无法完全回答这个问题&quot;。</span></span><br><span class="line"><span class="string">        请确保回答准确、完整且有条理。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.rag_agent = ChatAgent(</span><br><span class="line">            system_message=rag_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_knowledge_base</span>(<span class="params">self, pdf_url: <span class="built_in">str</span> = <span class="literal">None</span>, pdf_path: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        设置知识库</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            pdf_url: PDF文件的URL</span></span><br><span class="line"><span class="string">            pdf_path: 本地PDF文件路径</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 创建本地数据目录</span></span><br><span class="line">        os.makedirs(<span class="string">&#x27;local_data&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> pdf_url:</span><br><span class="line">            <span class="comment"># 下载PDF文件</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在下载PDF文件...&quot;</span>)</span><br><span class="line">            response = requests.get(pdf_url)</span><br><span class="line">            pdf_path = <span class="string">&#x27;local_data/knowledge_base.pdf&#x27;</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(pdf_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                file.write(response.content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;PDF文件已下载到: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> pdf_path:</span><br><span class="line">            <span class="comment"># 处理PDF文件并建立向量数据库</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在处理PDF文件并建立向量数据库...&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.vector_retriever.process(content=pdf_path)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;知识库设置完成！&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rewrite_query</span>(<span class="params">self, original_query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重写用户查询</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            original_query: 原始用户查询</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            重写后的查询</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        rewrite_prompt = <span class="string">f&quot;用户的原始提问如下：<span class="subst">&#123;original_query&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.rewriting_agent.step(rewrite_prompt)</span><br><span class="line">        rewritten_query = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;原始查询: <span class="subst">&#123;original_query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;重写查询: <span class="subst">&#123;rewritten_query&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> rewritten_query</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_hypothetical_document</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成假设文档 (HyDE方法)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            生成的假设文档</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        hyde_prompt = <span class="string">f&quot;请为以下查询生成一个相关的假设文档：<span class="subst">&#123;query&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.hyde_agent.step(hyde_prompt)</span><br><span class="line">        hypothetical_doc = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;生成的假设文档:\n<span class="subst">&#123;hypothetical_doc&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hypothetical_doc</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_with_hyde</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用HyDE方法进行检索</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k: 返回的文档数量</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            检索到的文档列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 生成假设文档</span></span><br><span class="line">        hypothetical_doc = <span class="variable language_">self</span>.generate_hypothetical_document(query)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用假设文档进行检索</span></span><br><span class="line">        hyde_results = <span class="variable language_">self</span>.vector_retriever.query(</span><br><span class="line">            query=hypothetical_doc,</span><br><span class="line">            top_k=top_k</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 同时使用原始查询进行检索作为对比</span></span><br><span class="line">        original_results = <span class="variable language_">self</span>.vector_retriever.query(</span><br><span class="line">            query=query,</span><br><span class="line">            top_k=top_k</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n=== HyDE检索结果 ===&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(hyde_results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> (相似度: <span class="subst">&#123;result.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;result[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;=== 原始查询检索结果 ===&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(original_results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> (相似度: <span class="subst">&#123;result.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;result[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hyde_results, original_results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_answer</span>(<span class="params">self, query: <span class="built_in">str</span>, retrieved_docs: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于检索到的文档生成答案</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            retrieved_docs: 检索到的文档列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            生成的答案</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 构建上下文</span></span><br><span class="line">        context = <span class="string">&quot;\n\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建提示</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        原始查询: <span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        检索到的上下文信息:</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请根据上述上下文信息回答原始查询。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.rag_agent.step(prompt)</span><br><span class="line">        answer = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enhanced_query</span>(<span class="params">self, original_query: <span class="built_in">str</span>, use_rewriting: <span class="built_in">bool</span> = <span class="literal">True</span>, </span></span><br><span class="line"><span class="params">                      use_hyde: <span class="built_in">bool</span> = <span class="literal">True</span>, top_k: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        执行增强版RAG查询</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            original_query: 原始用户查询</span></span><br><span class="line"><span class="string">            use_rewriting: 是否使用查询重写</span></span><br><span class="line"><span class="string">            use_hyde: 是否使用HyDE方法</span></span><br><span class="line"><span class="string">            top_k: 检索文档数量</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            包含各步骤结果的字典</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始执行增强版RAG查询&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        results = &#123;</span><br><span class="line">            <span class="string">&#x27;original_query&#x27;</span>: original_query,</span><br><span class="line">            <span class="string">&#x27;rewritten_query&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;hypothetical_document&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;retrieved_docs&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;final_answer&#x27;</span>: <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤1: 查询重写（可选）</span></span><br><span class="line">        <span class="keyword">if</span> use_rewriting:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n步骤1: 查询重写&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">            rewritten_query = <span class="variable language_">self</span>.rewrite_query(original_query)</span><br><span class="line">            results[<span class="string">&#x27;rewritten_query&#x27;</span>] = rewritten_query</span><br><span class="line">            query_to_use = rewritten_query</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            query_to_use = original_query</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤2: 文档检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n步骤2: 文档检索&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> use_hyde:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用HyDE方法进行检索...&quot;</span>)</span><br><span class="line">            hyde_results, original_results = <span class="variable language_">self</span>.retrieve_with_hyde(query_to_use, top_k)</span><br><span class="line">            results[<span class="string">&#x27;retrieved_docs&#x27;</span>] = hyde_results</span><br><span class="line">            results[<span class="string">&#x27;original_retrieval_docs&#x27;</span>] = original_results</span><br><span class="line">            retrieved_docs = hyde_results</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用传统方法进行检索...&quot;</span>)</span><br><span class="line">            retrieved_docs = <span class="variable language_">self</span>.vector_retriever.query(query=query_to_use, top_k=top_k)</span><br><span class="line">            results[<span class="string">&#x27;retrieved_docs&#x27;</span>] = retrieved_docs</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤3: 答案生成</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n步骤3: 答案生成&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        final_answer = <span class="variable language_">self</span>.generate_answer(query_to_use, retrieved_docs)</span><br><span class="line">        results[<span class="string">&#x27;final_answer&#x27;</span>] = final_answer</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n最终答案:\n<span class="subst">&#123;final_answer&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数：演示增强版RAG系统的使用&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载环境变量</span></span><br><span class="line">    load_dotenv()</span><br><span class="line">    api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> api_key:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;错误：请设置MODELSCOPE_SDK_TOKEN环境变量&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化增强版RAG系统</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;初始化增强版RAG系统...&quot;</span>)</span><br><span class="line">    rag_system = EnhancedRAGSystem(api_key)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置知识库（使用CAMEL论文）</span></span><br><span class="line">    pdf_url = <span class="string">&quot;https://arxiv.org/pdf/2303.17760.pdf&quot;</span></span><br><span class="line">    rag_system.setup_knowledge_base(pdf_url=pdf_url)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试查询（包含错别字）</span></span><br><span class="line">    test_queries = [</span><br><span class="line">        <span class="string">&quot;我盖如何解决CAMEL中文档冲服的问题问题呢，几个版本的文档可能存在代码结构的冲突&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CAMEL是什么东东？它有什么特点吗&quot;</span>,</span><br><span class="line">        <span class="string">&quot;角色扮演在CAMEL中是怎么实现的&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> query <span class="keyword">in</span> test_queries:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;测试查询: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行增强版RAG查询</span></span><br><span class="line">        results = rag_system.enhanced_query(</span><br><span class="line">            original_query=query,</span><br><span class="line">            use_rewriting=<span class="literal">True</span>,</span><br><span class="line">            use_hyde=<span class="literal">True</span>,</span><br><span class="line">            top_k=<span class="number">2</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<h3 id="3-Rerank-重排"><a href="#3-Rerank-重排" class="headerlink" title="3. Rerank (重排)"></a>3. Rerank (重排)</h3><p><strong>Rerank 模块</strong>用于对初步检索结果进行重新排序，以提高检索精确性和相关性，尤其在<strong>多路召回</strong>（结合向量相似度、关键词匹配、规则匹配等多种检索方式）场景中尤为重要。多路召回可能导致召回片段数量多且相关度参差不齐。</p>
<h4 id="3-1-重排步骤"><a href="#3-1-重排步骤" class="headerlink" title="3.1 重排步骤"></a>3.1 重排步骤</h4><ol>
<li><strong>初步检索</strong>：获取多路召回的初始文档片段。</li>
<li><strong>特征计算</strong>：评估每个文档片段与查询的相关性得分。</li>
<li><strong>重新排序</strong>：根据特征得分对文档片段进行排序。</li>
<li><strong>选择最佳结果</strong>：从重排后的结果中选取前 <code>TOP-K</code> 个作为最终最相关的片段，传递给LLM进行生成。</li>
</ol>
<h4 id="3-2-评估指标"><a href="#3-2-评估指标" class="headerlink" title="3.2 评估指标"></a>3.2 评估指标</h4><ul>
<li><strong>命中率 (Hit Rate)</strong>：在前 <code>k</code> 个检索文档中找到正确答案的查询比例，衡量系统在几次尝试中找到正确答案的频率。</li>
<li><strong>平均倒数排名 (MRR - Mean Reciprocal Rank)</strong>：评估系统准确性，根据排名最高的<strong>相关</strong>文档的倒数排名计算平均值（第一个相关文档排名为1，倒数排名为1；第二个为1&#x2F;2，以此类推）。MRR和Hit Rate越高，表示Rerank效果越好。</li>
</ul>
<h4 id="3-3-RRF-Reciprocal-Rank-Fusion-算法实践"><a href="#3-3-RRF-Reciprocal-Rank-Fusion-算法实践" class="headerlink" title="3.3 RRF (Reciprocal Rank Fusion) 算法实践"></a>3.3 RRF (Reciprocal Rank Fusion) 算法实践</h4><ul>
<li><strong>原理</strong>：一种融合多个不同相关性指标结果集的方法，仅依赖排名计算，不要求相关性分数相互关联。</li>
<li><strong>实现</strong>：通过遍历来自不同检索器（例如 <code>VectorRetriever</code> 和 <code>BM25Retriever</code>）的结果，计算每个文档的融合分数，然后按分数降序排序并返回前 <code>k</code> 个结果。</li>
</ul>
<p>实现RRF算法的系统：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">增强版RAG系统：集成查询重写(Rewriting)和假设文档嵌入(HyDE)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该脚本实现了一个增强的RAG系统，结合了以下技术：</span></span><br><span class="line"><span class="string">1. 查询重写(Query Rewriting)：修正用户查询中的错别字和表达问题</span></span><br><span class="line"><span class="string">2. HyDE (Hypothetical Document Embeddings)：生成假设文档来改善检索效果</span></span><br><span class="line"><span class="string">3. 传统RAG检索和生成</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">HyDE方法的核心思想：</span></span><br><span class="line"><span class="string">- 使用LLM为用户查询生成假设文档</span></span><br><span class="line"><span class="string">- 这些假设文档虽然可能包含错误，但与知识库中的真实文档相关联</span></span><br><span class="line"><span class="string">- 通过假设文档的向量表示来检索相似的真实文档，提高检索准确性</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入CAMEL框架相关模块</span></span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.retrievers <span class="keyword">import</span> VectorRetriever, BM25Retriever</span><br><span class="line"><span class="keyword">from</span> camel.storages.vectordb_storages <span class="keyword">import</span> QdrantStorage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入环境变量模块</span></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnhancedRAGSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    增强版RAG系统类</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    集成了查询重写、HyDE、ReRank(RRF算法)和传统RAG功能</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化增强版RAG系统</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            api_key: ModelScope API密钥</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.api_key = api_key</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化嵌入模型</span></span><br><span class="line">        <span class="variable language_">self</span>.embedding_model = SentenceTransformerEncoder(</span><br><span class="line">            model_name=<span class="string">&#x27;intfloat/e5-large-v2&#x27;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化向量存储</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_storage = QdrantStorage(</span><br><span class="line">            vector_dim=<span class="variable language_">self</span>.embedding_model.get_output_dim(),</span><br><span class="line">            collection=<span class="string">&quot;enhanced_rag_collection&quot;</span>,</span><br><span class="line">            path=<span class="string">&quot;storage_enhanced_rag&quot;</span>,</span><br><span class="line">            collection_name=<span class="string">&quot;增强RAG知识库&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化向量检索器</span></span><br><span class="line">        <span class="variable language_">self</span>.vector_retriever = VectorRetriever(</span><br><span class="line">            embedding_model=<span class="variable language_">self</span>.embedding_model,</span><br><span class="line">            storage=<span class="variable language_">self</span>.vector_storage</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化BM25检索器（用于ReRank）</span></span><br><span class="line">        <span class="variable language_">self</span>.bm25_retriever = BM25Retriever()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化LLM模型</span></span><br><span class="line">        <span class="variable language_">self</span>.model = ModelFactory.create(</span><br><span class="line">            model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">            model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">            url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">            api_key=<span class="variable language_">self</span>.api_key</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化各种代理</span></span><br><span class="line">        <span class="variable language_">self</span>._init_agents()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rrf</span>(<span class="params">self, vector_results: <span class="type">List</span>[<span class="type">Dict</span>], text_results: <span class="type">List</span>[<span class="type">Dict</span>], k: <span class="built_in">int</span> = <span class="number">10</span>, m: <span class="built_in">int</span> = <span class="number">60</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">tuple</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用RRF (Reciprocal Rank Fusion) 算法对两组检索结果进行重排序</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        RRF算法通过结合不同检索方法的排名来提高检索效果。</span></span><br><span class="line"><span class="string">        公式：RRF_score = Σ(1/(rank + m))，其中m是超参数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            vector_results: 向量召回的结果列表，每个元素是包含&#x27;text&#x27;的字典</span></span><br><span class="line"><span class="string">            text_results: 文本召回的结果列表，每个元素是包含&#x27;text&#x27;的字典</span></span><br><span class="line"><span class="string">            k: 排序后返回前k个结果</span></span><br><span class="line"><span class="string">            m: RRF算法的超参数，用于平滑排名分数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            重排序后的结果列表，每个元素是(文档内容, 融合分数)的元组</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        doc_scores = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理向量检索结果</span></span><br><span class="line">        <span class="comment"># 为每个文档分配基于排名的分数：1/(rank + m)</span></span><br><span class="line">        <span class="keyword">for</span> rank, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(vector_results):</span><br><span class="line">            text = result[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line">            doc_scores[text] = doc_scores.get(text, <span class="number">0</span>) + <span class="number">1</span> / (rank + m)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理文本检索结果</span></span><br><span class="line">        <span class="comment"># 累加来自不同检索方法的分数</span></span><br><span class="line">        <span class="keyword">for</span> rank, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(text_results):</span><br><span class="line">            text = result[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line">            doc_scores[text] = doc_scores.get(text, <span class="number">0</span>) + <span class="number">1</span> / (rank + m)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 按融合分数降序排序并返回前k个结果</span></span><br><span class="line">        sorted_results = <span class="built_in">sorted</span>(doc_scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[:k]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;RRF融合完成，共处理 <span class="subst">&#123;<span class="built_in">len</span>(doc_scores)&#125;</span> 个唯一文档，返回前 <span class="subst">&#123;<span class="built_in">len</span>(sorted_results)&#125;</span> 个结果&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sorted_results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_agents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化不同功能的AI代理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查询重写代理</span></span><br><span class="line">        rewriting_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是RAG模块中的Rewriting助手，目的是理解用户的提问，并且重新组织和优化用户的提问表达，</span></span><br><span class="line"><span class="string">        修正用户输入中可能存在的错别字的情况并重构提问来使得句子表达更加通顺严谨。</span></span><br><span class="line"><span class="string">        请直接输出重写后的查询，不要添加额外的解释。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.rewriting_agent = ChatAgent(</span><br><span class="line">            system_message=rewriting_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># HyDE假设文档生成代理</span></span><br><span class="line">        hyde_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个专门生成假设文档的助手。根据用户的查询，生成一个相关的假设文档片段。</span></span><br><span class="line"><span class="string">        这个文档应该：</span></span><br><span class="line"><span class="string">        1. 直接回答用户的问题</span></span><br><span class="line"><span class="string">        2. 包含相关的技术细节和概念</span></span><br><span class="line"><span class="string">        3. 使用专业但清晰的语言</span></span><br><span class="line"><span class="string">        4. 长度适中（200-400字）</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请直接输出假设文档内容，不要添加额外的解释或格式。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.hyde_agent = ChatAgent(</span><br><span class="line">            system_message=hyde_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># RAG回答生成代理</span></span><br><span class="line">        rag_sys_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个帮助回答问题的助手。</span></span><br><span class="line"><span class="string">        我会给你原始查询和检索到的上下文信息。</span></span><br><span class="line"><span class="string">        请根据检索到的上下文回答原始查询。</span></span><br><span class="line"><span class="string">        如果上下文信息不足以回答问题，请说&quot;根据提供的信息，我无法完全回答这个问题&quot;。</span></span><br><span class="line"><span class="string">        请确保回答准确、完整且有条理。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.rag_agent = ChatAgent(</span><br><span class="line">            system_message=rag_sys_msg,</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_knowledge_base</span>(<span class="params">self, pdf_url: <span class="built_in">str</span> = <span class="literal">None</span>, pdf_path: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        设置知识库，同时初始化向量检索器和BM25检索器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            pdf_url: PDF文件的URL</span></span><br><span class="line"><span class="string">            pdf_path: 本地PDF文件路径</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 创建本地数据目录</span></span><br><span class="line">        os.makedirs(<span class="string">&#x27;local_data&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pdf_url:</span><br><span class="line">            <span class="comment"># 下载PDF文件</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在下载PDF文件...&quot;</span>)</span><br><span class="line">            response = requests.get(pdf_url)</span><br><span class="line">            pdf_path = <span class="string">&#x27;local_data/knowledge_base.pdf&#x27;</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(pdf_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                file.write(response.content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;PDF文件已下载到: <span class="subst">&#123;pdf_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pdf_path:</span><br><span class="line">            <span class="comment"># 处理PDF文件并建立向量数据库</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在处理PDF文件并建立向量数据库...&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.vector_retriever.process(content=pdf_path)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 同时为BM25检索器处理文档</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;正在为BM25检索器处理文档...&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.bm25_retriever.process(content_input_path=pdf_path)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;知识库设置完成！（向量检索器 + BM25检索器）&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rewrite_query</span>(<span class="params">self, original_query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重写用户查询</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            original_query: 原始用户查询</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            重写后的查询</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        rewrite_prompt = <span class="string">f&quot;用户的原始提问如下：<span class="subst">&#123;original_query&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.rewriting_agent.step(rewrite_prompt)</span><br><span class="line">        rewritten_query = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;原始查询: <span class="subst">&#123;original_query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;重写查询: <span class="subst">&#123;rewritten_query&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> rewritten_query</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_hypothetical_document</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成假设文档 (HyDE方法)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            生成的假设文档</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        hyde_prompt = <span class="string">f&quot;请为以下查询生成一个相关的假设文档：<span class="subst">&#123;query&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.hyde_agent.step(hyde_prompt)</span><br><span class="line">        hypothetical_doc = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;生成的假设文档:\n<span class="subst">&#123;hypothetical_doc&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hypothetical_doc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_with_rrf</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">10</span>, rrf_k: <span class="built_in">int</span> = <span class="number">5</span>, m: <span class="built_in">int</span> = <span class="number">60</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用RRF算法结合向量检索和BM25检索的结果</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k: 每个检索器返回的文档数量</span></span><br><span class="line"><span class="string">            rrf_k: RRF融合后返回的文档数量</span></span><br><span class="line"><span class="string">            m: RRF算法的超参数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            RRF融合后的检索结果列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;使用RRF算法进行混合检索...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 向量检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;执行向量检索...&quot;</span>)</span><br><span class="line">        vector_results = <span class="variable language_">self</span>.vector_retriever.query(query=query, top_k=top_k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># BM25检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;执行BM25检索...&quot;</span>)</span><br><span class="line">        bm25_results = <span class="variable language_">self</span>.bm25_retriever.query(query=query, top_k=top_k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用RRF算法融合结果</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;使用RRF算法融合检索结果...&quot;</span>)</span><br><span class="line">        rrf_results = <span class="variable language_">self</span>.rrf(vector_results, bm25_results, k=rrf_k, m=m)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 转换RRF结果格式以保持与其他检索方法的一致性</span></span><br><span class="line">        formatted_results = []</span><br><span class="line">        <span class="keyword">for</span> text, score <span class="keyword">in</span> rrf_results:</span><br><span class="line">            formatted_results.append(&#123;</span><br><span class="line">                <span class="string">&#x27;text&#x27;</span>: text,</span><br><span class="line">                <span class="string">&#x27;rrf_score&#x27;</span>: score,</span><br><span class="line">                <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;RRF_fusion&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;RRF检索完成，返回 <span class="subst">&#123;<span class="built_in">len</span>(formatted_results)&#125;</span> 个文档&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(formatted_results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> (RRF分数: <span class="subst">&#123;result[<span class="string">&#x27;rrf_score&#x27;</span>]:<span class="number">.4</span>f&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;result[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> formatted_results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_with_hyde_and_rrf</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">10</span>, rrf_k: <span class="built_in">int</span> = <span class="number">5</span>, m: <span class="built_in">int</span> = <span class="number">60</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        结合HyDE和RRF的高级检索方法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k: 每个检索器返回的文档数量</span></span><br><span class="line"><span class="string">            rrf_k: RRF融合后返回的文档数量</span></span><br><span class="line"><span class="string">            m: RRF算法的超参数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            HyDE+RRF融合后的检索结果列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;使用HyDE+RRF组合方法进行检索...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 生成假设文档</span></span><br><span class="line">        hypothetical_doc = <span class="variable language_">self</span>.generate_hypothetical_document(query)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用假设文档进行向量检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;使用假设文档进行向量检索...&quot;</span>)</span><br><span class="line">        hyde_vector_results = <span class="variable language_">self</span>.vector_retriever.query(query=hypothetical_doc, top_k=top_k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用原始查询进行BM25检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;使用原始查询进行BM25检索...&quot;</span>)</span><br><span class="line">        bm25_results = <span class="variable language_">self</span>.bm25_retriever.query(query=query, top_k=top_k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用RRF算法融合HyDE向量检索和BM25检索的结果</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;使用RRF算法融合HyDE和BM25检索结果...&quot;</span>)</span><br><span class="line">        rrf_results = <span class="variable language_">self</span>.rrf(hyde_vector_results, bm25_results, k=rrf_k, m=m)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 转换结果格式</span></span><br><span class="line">        formatted_results = []</span><br><span class="line">        <span class="keyword">for</span> text, score <span class="keyword">in</span> rrf_results:</span><br><span class="line">            formatted_results.append(&#123;</span><br><span class="line">                <span class="string">&#x27;text&#x27;</span>: text,</span><br><span class="line">                <span class="string">&#x27;rrf_score&#x27;</span>: score,</span><br><span class="line">                <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;HyDE_RRF_fusion&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;HyDE+RRF检索完成，返回 <span class="subst">&#123;<span class="built_in">len</span>(formatted_results)&#125;</span> 个文档&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(formatted_results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> (RRF分数: <span class="subst">&#123;result[<span class="string">&#x27;rrf_score&#x27;</span>]:<span class="number">.4</span>f&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;result[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> formatted_results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_with_hyde</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用HyDE方法进行检索</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            top_k: 返回的文档数量</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            检索到的文档列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 生成假设文档</span></span><br><span class="line">        hypothetical_doc = <span class="variable language_">self</span>.generate_hypothetical_document(query)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用假设文档进行检索</span></span><br><span class="line">        hyde_results = <span class="variable language_">self</span>.vector_retriever.query(</span><br><span class="line">            query=hypothetical_doc,</span><br><span class="line">            top_k=top_k</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 同时使用原始查询进行检索作为对比</span></span><br><span class="line">        original_results = <span class="variable language_">self</span>.vector_retriever.query(</span><br><span class="line">            query=query,</span><br><span class="line">            top_k=top_k</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n=== HyDE检索结果 ===&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(hyde_results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> (相似度: <span class="subst">&#123;result.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;result[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;=== 原始查询检索结果 ===&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(original_results):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文档 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> (相似度: <span class="subst">&#123;result.get(<span class="string">&#x27;similarity&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>):&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;result[<span class="string">&#x27;text&#x27;</span>][:<span class="number">200</span>]&#125;</span>...\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hyde_results, original_results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_answer</span>(<span class="params">self, query: <span class="built_in">str</span>, retrieved_docs: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于检索到的文档生成答案</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: 用户查询</span></span><br><span class="line"><span class="string">            retrieved_docs: 检索到的文档列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            生成的答案</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 构建上下文</span></span><br><span class="line">        context = <span class="string">&quot;\n\n&quot;</span>.join([doc[<span class="string">&#x27;text&#x27;</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建提示</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        原始查询: <span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        检索到的上下文信息:</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请根据上述上下文信息回答原始查询。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.rag_agent.step(prompt)</span><br><span class="line">        answer = response.msgs[<span class="number">0</span>].content.strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enhanced_query</span>(<span class="params">self, original_query: <span class="built_in">str</span>, use_rewriting: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">                      use_hyde: <span class="built_in">bool</span> = <span class="literal">True</span>, use_rrf: <span class="built_in">bool</span> = <span class="literal">True</span>, top_k: <span class="built_in">int</span> = <span class="number">10</span>, rrf_k: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        执行增强版RAG查询</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            original_query: 原始用户查询</span></span><br><span class="line"><span class="string">            use_rewriting: 是否使用查询重写</span></span><br><span class="line"><span class="string">            use_hyde: 是否使用HyDE方法</span></span><br><span class="line"><span class="string">            use_rrf: 是否使用RRF重排序算法</span></span><br><span class="line"><span class="string">            top_k: 每个检索器返回的文档数量</span></span><br><span class="line"><span class="string">            rrf_k: RRF融合后返回的文档数量</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            包含各步骤结果的字典</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始执行增强版RAG查询&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        results = &#123;</span><br><span class="line">            <span class="string">&#x27;original_query&#x27;</span>: original_query,</span><br><span class="line">            <span class="string">&#x27;rewritten_query&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;hypothetical_document&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;retrieved_docs&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;final_answer&#x27;</span>: <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤1: 查询重写（可选）</span></span><br><span class="line">        <span class="keyword">if</span> use_rewriting:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n步骤1: 查询重写&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">            rewritten_query = <span class="variable language_">self</span>.rewrite_query(original_query)</span><br><span class="line">            results[<span class="string">&#x27;rewritten_query&#x27;</span>] = rewritten_query</span><br><span class="line">            query_to_use = rewritten_query</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            query_to_use = original_query</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤2: 文档检索</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n步骤2: 文档检索&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> use_rrf <span class="keyword">and</span> use_hyde:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用HyDE+RRF组合方法进行检索...&quot;</span>)</span><br><span class="line">            retrieved_docs = <span class="variable language_">self</span>.retrieve_with_hyde_and_rrf(query_to_use, top_k=top_k, rrf_k=rrf_k)</span><br><span class="line">            results[<span class="string">&#x27;retrieved_docs&#x27;</span>] = retrieved_docs</span><br><span class="line">            results[<span class="string">&#x27;retrieval_method&#x27;</span>] = <span class="string">&#x27;HyDE+RRF&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> use_rrf:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用RRF方法进行检索...&quot;</span>)</span><br><span class="line">            retrieved_docs = <span class="variable language_">self</span>.retrieve_with_rrf(query_to_use, top_k=top_k, rrf_k=rrf_k)</span><br><span class="line">            results[<span class="string">&#x27;retrieved_docs&#x27;</span>] = retrieved_docs</span><br><span class="line">            results[<span class="string">&#x27;retrieval_method&#x27;</span>] = <span class="string">&#x27;RRF&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> use_hyde:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用HyDE方法进行检索...&quot;</span>)</span><br><span class="line">            hyde_results, original_results = <span class="variable language_">self</span>.retrieve_with_hyde(query_to_use, top_k)</span><br><span class="line">            results[<span class="string">&#x27;retrieved_docs&#x27;</span>] = hyde_results</span><br><span class="line">            results[<span class="string">&#x27;original_retrieval_docs&#x27;</span>] = original_results</span><br><span class="line">            results[<span class="string">&#x27;retrieval_method&#x27;</span>] = <span class="string">&#x27;HyDE&#x27;</span></span><br><span class="line">            retrieved_docs = hyde_results</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;使用传统向量检索方法...&quot;</span>)</span><br><span class="line">            retrieved_docs = <span class="variable language_">self</span>.vector_retriever.query(query=query_to_use, top_k=top_k)</span><br><span class="line">            results[<span class="string">&#x27;retrieved_docs&#x27;</span>] = retrieved_docs</span><br><span class="line">            results[<span class="string">&#x27;retrieval_method&#x27;</span>] = <span class="string">&#x27;Traditional&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤3: 答案生成</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n步骤3: 答案生成&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        final_answer = <span class="variable language_">self</span>.generate_answer(query_to_use, retrieved_docs)</span><br><span class="line">        results[<span class="string">&#x27;final_answer&#x27;</span>] = final_answer</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n最终答案:\n<span class="subst">&#123;final_answer&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数：演示增强版RAG系统的使用&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载环境变量</span></span><br><span class="line">    load_dotenv()</span><br><span class="line">    api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> api_key:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;错误：请设置MODELSCOPE_SDK_TOKEN环境变量&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化增强版RAG系统</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;初始化增强版RAG系统...&quot;</span>)</span><br><span class="line">    rag_system = EnhancedRAGSystem(api_key)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置知识库（使用CAMEL论文）</span></span><br><span class="line">    pdf_url = <span class="string">&quot;https://arxiv.org/pdf/2303.17760.pdf&quot;</span></span><br><span class="line">    rag_system.setup_knowledge_base(pdf_url=pdf_url)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试查询（包含错别字）</span></span><br><span class="line">    test_queries = [</span><br><span class="line">        <span class="string">&quot;我盖如何解决CAMEL中文档冲服的问题问题呢，几个版本的文档可能存在代码结构的冲突&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CAMEL是什么东东？它有什么特点吗&quot;</span>,</span><br><span class="line">        <span class="string">&quot;角色扮演在CAMEL中是怎么实现的&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试不同的检索方法组合</span></span><br><span class="line">    test_methods = [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;传统RAG&quot;</span>, <span class="string">&quot;rewriting&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;hyde&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;rrf&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;查询重写+传统RAG&quot;</span>, <span class="string">&quot;rewriting&quot;</span>: <span class="literal">True</span>, <span class="string">&quot;hyde&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;rrf&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;HyDE增强RAG&quot;</span>, <span class="string">&quot;rewriting&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;hyde&quot;</span>: <span class="literal">True</span>, <span class="string">&quot;rrf&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;RRF重排序RAG&quot;</span>, <span class="string">&quot;rewriting&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;hyde&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;rrf&quot;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;完整增强RAG (Rewriting+HyDE+RRF)&quot;</span>, <span class="string">&quot;rewriting&quot;</span>: <span class="literal">True</span>, <span class="string">&quot;hyde&quot;</span>: <span class="literal">True</span>, <span class="string">&quot;rrf&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, query <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_queries):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">100</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;测试查询 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 只对第一个查询测试所有方法，其他查询使用完整增强方法</span></span><br><span class="line">        methods_to_test = test_methods <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">else</span> [test_methods[-<span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> method <span class="keyword">in</span> methods_to_test:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;<span class="string">&#x27;=&#x27;</span>*<span class="number">20</span>&#125;</span> <span class="subst">&#123;method[<span class="string">&#x27;name&#x27;</span>]&#125;</span> <span class="subst">&#123;<span class="string">&#x27;=&#x27;</span>*<span class="number">20</span>&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 执行增强版RAG查询</span></span><br><span class="line">            results = rag_system.enhanced_query(</span><br><span class="line">                original_query=query,</span><br><span class="line">                use_rewriting=method[<span class="string">&#x27;rewriting&#x27;</span>],</span><br><span class="line">                use_hyde=method[<span class="string">&#x27;hyde&#x27;</span>],</span><br><span class="line">                use_rrf=method[<span class="string">&#x27;rrf&#x27;</span>],</span><br><span class="line">                top_k=<span class="number">10</span>,</span><br><span class="line">                rrf_k=<span class="number">3</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;检索方法: <span class="subst">&#123;results.get(<span class="string">&#x27;retrieval_method&#x27;</span>, <span class="string">&#x27;Unknown&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>通过结合 <strong>Basic RAG</strong>，以及<strong>Rewriting</strong>和<strong>Rerank</strong>等优化模块，我们可以构建出更强大、更准确的RAG应用，从而显著提升LLM在特定知识领域的表现。</p>
<p>以下是对你提供的内容的<strong>系统性中文整理总结</strong>，涵盖了<strong>向量检索模块的评估与优化流程</strong>，包括 TF-IDF 与嵌入模型对比、评估指标定义、检索流程实现、优化方向等内容，适合撰写文档或教学材料使用。</p>
<hr>
<h2 id="向量检索模块评估与优化"><a href="#向量检索模块评估与优化" class="headerlink" title="向量检索模块评估与优化"></a>向量检索模块评估与优化</h2><h3 id="一、背景说明"><a href="#一、背景说明" class="headerlink" title="一、背景说明"></a>一、背景说明</h3><p>在构建基于向量检索（Vector Retrieval, VR）的智能问答系统时，评估检索质量成为关键一步。本实践以 CAMEL AI 框架为基础，通过标准问题及预期答案的方式，对检索器返回结果进行自动化评估，并尝试不同方法进行优化。</p>
<hr>
<h3 id="二、测试样例定义"><a href="#二、测试样例定义" class="headerlink" title="二、测试样例定义"></a>二、测试样例定义</h3><p>我们通过一组测试查询（test_queries）及预期标准答案（expected_answers）来建立基本评估集：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">test_queries = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;什么是CAMEL AI？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;expected_answers&quot;</span>: [<span class="string">&quot;CAMEL AI 是一个开源的、社区驱动的AI框架。&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;如何开始使用CAMEL AI？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;expected_answers&quot;</span>: [<span class="string">&quot;首先安装框架：`pip install camel-ai`，然后引入必要的模块。&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;CAMEL AI 的主要特点是什么？&quot;</span>,</span><br><span class="line">        <span class="string">&quot;expected_answers&quot;</span>: [<span class="string">&quot;模块化设计、易用性和扩展性。&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="三、评估指标设计"><a href="#三、评估指标设计" class="headerlink" title="三、评估指标设计"></a>三、评估指标设计</h3><p>系统定义了以下核心评估指标：</p>
<table>
<thead>
<tr>
<th>指标名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Precision（精确率）</strong></td>
<td>正确返回结果 &#x2F; 实际返回结果</td>
</tr>
<tr>
<td><strong>Recall（召回率）</strong></td>
<td>正确返回结果 &#x2F; 所有应返回的正确结果</td>
</tr>
<tr>
<td><strong>F1 分数</strong></td>
<td>精确率和召回率的调和平均</td>
</tr>
<tr>
<td><strong>平均相似度</strong></td>
<td>所有预期-实际配对之间的相似度均值</td>
</tr>
</tbody></table>
<p>其中，相似度计算方法有两种实现方式：</p>
<hr>
<h3 id="四、相似度计算方法"><a href="#四、相似度计算方法" class="headerlink" title="四、相似度计算方法"></a>四、相似度计算方法</h3><h4 id="方法1：TF-IDF-余弦相似度（初始方法）"><a href="#方法1：TF-IDF-余弦相似度（初始方法）" class="headerlink" title="方法1：TF-IDF + 余弦相似度（初始方法）"></a>方法1：TF-IDF + 余弦相似度（初始方法）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compute_similarity</span>(<span class="params">expected, retrieved</span>):</span><br><span class="line">    vectorizer = TfidfVectorizer()</span><br><span class="line">    tfidf = vectorizer.fit_transform([expected, retrieved])</span><br><span class="line">    similarity_matrix = cosine_similarity(tfidf, tfidf)</span><br><span class="line">    <span class="keyword">return</span> similarity_matrix[<span class="number">0</span>, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h4 id="方法2：Embedding-余弦相似度（改进方案）"><a href="#方法2：Embedding-余弦相似度（改进方案）" class="headerlink" title="方法2：Embedding + 余弦相似度（改进方案）"></a>方法2：Embedding + 余弦相似度（改进方案）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compute_similarity</span>(<span class="params">expected, retrieved</span>):</span><br><span class="line">    embeddings = embedding_model.embed_list([expected, retrieved])</span><br><span class="line">    <span class="keyword">return</span> cosine_similarity([embeddings[<span class="number">0</span>]], [embeddings[<span class="number">1</span>]])[<span class="number">0</span>][<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>优点</strong>：Embedding 模型具备更强的语义理解能力，能处理“车辆≈汽车”这类同义关系。</p>
</blockquote>
<hr>
<h3 id="五、整体评估流程"><a href="#五、整体评估流程" class="headerlink" title="五、整体评估流程"></a>五、整体评估流程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_retrieval</span>(<span class="params">query, expected_answers, threshold=<span class="number">0.5</span>, top_k=<span class="number">1</span></span>):</span><br><span class="line">    results = vr.query(query=query, top_k=top_k)</span><br><span class="line">    retrieved_texts = [result[<span class="string">&quot;text&quot;</span>] <span class="keyword">for</span> result <span class="keyword">in</span> results]</span><br><span class="line">    </span><br><span class="line">    precision = calculate_precision(retrieved_texts, expected_answers, threshold)</span><br><span class="line">    recall = calculate_recall(retrieved_texts, expected_answers, threshold)</span><br><span class="line">    f1 = calculate_f1(precision, recall)</span><br><span class="line"></span><br><span class="line">    similarities = [</span><br><span class="line">        compute_similarity(expected, retrieved)</span><br><span class="line">        <span class="keyword">for</span> expected, retrieved <span class="keyword">in</span> <span class="built_in">zip</span>(expected_answers, retrieved_texts)</span><br><span class="line">    ]</span><br><span class="line">    avg_similarity = np.mean(similarities) <span class="keyword">if</span> similarities <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;precision&quot;</span>: precision,</span><br><span class="line">        <span class="string">&quot;recall&quot;</span>: recall,</span><br><span class="line">        <span class="string">&quot;f1&quot;</span>: f1,</span><br><span class="line">        <span class="string">&quot;avg_similarity&quot;</span>: avg_similarity,</span><br><span class="line">        <span class="string">&quot;retrieved_texts&quot;</span>: retrieved_texts</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="六、优化路径探索"><a href="#六、优化路径探索" class="headerlink" title="六、优化路径探索"></a>六、优化路径探索</h3><h4 id="1-使用-Embedding-替代-TF-IDF"><a href="#1-使用-Embedding-替代-TF-IDF" class="headerlink" title="1. 使用 Embedding 替代 TF-IDF"></a>1. 使用 Embedding 替代 TF-IDF</h4><ul>
<li>提升语义对齐效果</li>
<li>平均相似度显著提高（如从 <code>0.36</code> 提升至 <code>0.91</code>）</li>
</ul>
<h4 id="2-调整文档切片粒度（chunking）"><a href="#2-调整文档切片粒度（chunking）" class="headerlink" title="2. 调整文档切片粒度（chunking）"></a>2. 调整文档切片粒度（chunking）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vr.process(</span><br><span class="line">    content=<span class="string">&quot;example_document.md&quot;</span>,</span><br><span class="line">    max_characters=<span class="number">100</span>,  <span class="comment"># 更小的切片单元</span></span><br><span class="line">    should_chunk=<span class="literal">True</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>优化检索粒度，避免一次性返回长段内容</li>
<li>实现更加针对性的文本匹配与评分</li>
</ul>
<h4 id="3-模型与参数优化方向"><a href="#3-模型与参数优化方向" class="headerlink" title="3. 模型与参数优化方向"></a>3. 模型与参数优化方向</h4><ul>
<li>嵌入模型：尝试不同的 encoder（如 BGE、MiniLM）</li>
<li>相似度度量：替换余弦相似度为欧几里得&#x2F;点积等</li>
<li>检索策略：TF-IDF + Embedding 混合策略</li>
</ul>
<hr>
<h3 id="七、生成模块评估建议（BLEU-ROUGE）"><a href="#七、生成模块评估建议（BLEU-ROUGE）" class="headerlink" title="七、生成模块评估建议（BLEU &#x2F; ROUGE）"></a>七、生成模块评估建议（BLEU &#x2F; ROUGE）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rouge_score <span class="keyword">import</span> rouge_scorer</span><br><span class="line"><span class="keyword">from</span> nltk.translate.bleu_score <span class="keyword">import</span> sentence_bleu</span><br><span class="line"><span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</span><br><span class="line"></span><br><span class="line">reference = <span class="string">&quot;RAG combines retrieval and generation for QA.&quot;</span></span><br><span class="line">generated = <span class="string">&quot;RAG integrates retrieval and generation for question answering.&quot;</span></span><br><span class="line"></span><br><span class="line">scorer = rouge_scorer.RougeScorer([<span class="string">&#x27;rouge1&#x27;</span>, <span class="string">&#x27;rougeL&#x27;</span>], use_stemmer=<span class="literal">True</span>)</span><br><span class="line">scores = scorer.score(reference, generated)</span><br><span class="line"></span><br><span class="line">reference_tokens = word_tokenize(reference)</span><br><span class="line">generated_tokens = word_tokenize(generated)</span><br><span class="line">bleu_score = sentence_bleu([reference_tokens], generated_tokens)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>输出示例：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ROUGE-1: 0.86</span><br><span class="line">ROUGE-L: 0.82</span><br><span class="line">BLEU Score: 0.71</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="八、结论"><a href="#八、结论" class="headerlink" title="八、结论"></a>八、结论</h3><p>本评估流程展示了向量检索系统从初步搭建 → 精度评估 → 嵌入优化 → 文档切片的<strong>迭代式优化路径</strong>，并为后续<strong>生成式问答系统</strong>提供了评估参考。</p>
<p><strong>后续可探索方向包括：</strong></p>
<ul>
<li>检索器多阶段混合策略（关键词初筛 + 嵌入复检）</li>
<li>基于用户反馈的自动优化（在线学习）</li>
<li>微调专用 Embedding 模型以适配垂类语义</li>
</ul>
<hr>
<p>当然可以！下面是针对你这个 Graph RAG 实战项目的详细<strong>任务分解（spec → task → controller）设计</strong>，适用于你当前使用的 CAMEL 框架 + Qwen2.5 模型 + Firecrawl 网页抓取 + Neo4j 图数据库 + 混合 RAG 推理的场景：</p>
<hr>
<h3 id="Graph-RAG-实战系统任务分解"><a href="#Graph-RAG-实战系统任务分解" class="headerlink" title="Graph RAG 实战系统任务分解"></a>Graph RAG 实战系统任务分解</h3><hr>
<h4 id="Spec（规范说明）"><a href="#Spec（规范说明）" class="headerlink" title="Spec（规范说明）"></a>Spec（规范说明）</h4><p>构建一个以知识图谱驱动的 Graph RAG 系统，实现从网页抓取 → 实体关系抽取 → 知识图谱构建 → 混合检索 → 回答生成的闭环流程，核心目标为<strong>提升复杂问题回答的准确性与可解释性</strong>。</p>
<ul>
<li>用户输入自然语言问题</li>
<li>系统自动进行相关网页抓取与处理</li>
<li>抽取结构化实体关系，写入 Neo4j 图谱</li>
<li>使用图谱结构 + 向量语义检索综合选取回答依据</li>
<li>调用 Qwen2.5 模型生成最终响应</li>
</ul>
<hr>
<h4 id="Task（模块拆解）"><a href="#Task（模块拆解）" class="headerlink" title="Task（模块拆解）"></a>Task（模块拆解）</h4><ol>
<li><strong>网页抓取模块（web_crawler）</strong><ul>
<li>使用 Firecrawl API 抓取用户问题相关的网页</li>
<li>输出结构化网页内容（标题、正文、链接等）</li>
</ul>
</li>
<li><strong>信息抽取模块（entity_relation_extractor）</strong><ul>
<li>对抓取的网页内容进行实体识别与关系抽取（NER + RE）</li>
<li>输出三元组（subject, relation, object）</li>
</ul>
</li>
<li><strong>图谱构建模块（graph_builder）</strong><ul>
<li>将三元组写入 Neo4j 数据库（防止重复写入）</li>
<li>实现节点合并、关系合并策略</li>
</ul>
</li>
<li><strong>混合检索模块（hybrid_retriever）</strong><ul>
<li>图谱检索：基于 Cypher 查询获取相关实体路径</li>
<li>向量检索：基于 CAMEL 的向量模块进行语义召回</li>
<li>融合策略：Rank&#x2F;Fuse&#x2F;Rerank 等融合两类召回</li>
</ul>
</li>
<li><strong>问答生成模块（graph_rag_qa）</strong><ul>
<li>将图谱结果 + 文档结果合并后作为上下文</li>
<li>使用 Qwen2.5 模型生成回答</li>
<li>支持来源追踪（source attribution）</li>
</ul>
</li>
<li><strong>LLM Agent 调度模块（camel_controller）</strong><ul>
<li>封装整个流程为 CAMEL Agent 的工具调用链</li>
<li>根据用户输入智能调度抓取 → 构图 → QA 全链路</li>
</ul>
</li>
</ol>
<hr>
<h4 id="Controller（模块控制逻辑）"><a href="#Controller（模块控制逻辑）" class="headerlink" title="Controller（模块控制逻辑）"></a>Controller（模块控制逻辑）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># controller.py 示例（简化伪码）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphRAGController</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.web_crawler = FirecrawlClient()</span><br><span class="line">        <span class="variable language_">self</span>.extractor = EntityRelationExtractor()</span><br><span class="line">        <span class="variable language_">self</span>.graph_db = Neo4jClient()</span><br><span class="line">        <span class="variable language_">self</span>.vector_search = VectorRetriever()</span><br><span class="line">        <span class="variable language_">self</span>.qa_model = QwenRAG()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_user_query</span>(<span class="params">self, user_input</span>):</span><br><span class="line">        <span class="comment"># Step 1: 网页抓取</span></span><br><span class="line">        docs = <span class="variable language_">self</span>.web_crawler.search_and_parse(user_input)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 2: 实体关系抽取</span></span><br><span class="line">        triples = <span class="variable language_">self</span>.extractor.extract_triples(docs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 3: 构建知识图谱</span></span><br><span class="line">        <span class="variable language_">self</span>.graph_db.add_triples(triples)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 4: 混合检索</span></span><br><span class="line">        graph_context = <span class="variable language_">self</span>.graph_db.query_relevant(user_input)</span><br><span class="line">        vector_context = <span class="variable language_">self</span>.vector_search.query(user_input)</span><br><span class="line">        context = <span class="variable language_">self</span>.merge_context(graph_context, vector_context)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 5: RAG 问答生成</span></span><br><span class="line">        answer = <span class="variable language_">self</span>.qa_model.generate_answer(user_input, context)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge_context</span>(<span class="params">self, graph_ctx, vector_ctx</span>):</span><br><span class="line">        <span class="comment"># 可定制融合策略，例如先rank再合并</span></span><br><span class="line">        <span class="keyword">return</span> graph_ctx + vector_ctx[:<span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><ul>
<li>引入 <strong>RAG-Fusion</strong> 或 <strong>ColBERT-RAG</strong> 提高融合性能</li>
<li>使用 LangGraph&#x2F;Flowise 等构建 DAG 状态机调度</li>
<li>多跳推理能力强化：通过图谱路径进行 reasoning chain 构建</li>
<li>可视化图谱展示：Neo4j Bloom &#x2F; D3.js 前端图谱可视化</li>
</ul>
<hr>
<h3 id="其它实践部分都在同章节的练习部分，请跳转Agent-camel框架练习（4）查看更为详细的实践步骤。"><a href="#其它实践部分都在同章节的练习部分，请跳转Agent-camel框架练习（4）查看更为详细的实践步骤。" class="headerlink" title="其它实践部分都在同章节的练习部分，请跳转Agent-camel框架练习（4）查看更为详细的实践步骤。"></a>其它实践部分都在同章节的练习部分，请跳转Agent-camel框架练习（4）查看更为详细的实践步骤。</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/18/%E8%81%AA%E6%98%8E%E5%AD%A6python%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97%EF%BC%883%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/18/%E8%81%AA%E6%98%8E%E5%AD%A6python%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97%EF%BC%883%EF%BC%89/" class="post-title-link" itemprop="url">【Python】 第三章学习心得</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-07-18 00:09:00 / Modified: 00:13:01" itemprop="dateCreated datePublished" datetime="2025-07-18T00:09:00+08:00">2025-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" itemprop="url" rel="index"><span itemprop="name">学习心得</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>《聪明办法学 Python（第2版）》第三章学习心得：变量与数据类型</p>
<p>通过对第三章“变量与数据类型”的学习，我对 Python 的基础数据结构和变量使用方法有了更加深入的理解，为今后的程序构建打下了坚实的基础。</p>
<hr>
<h3 id="变量的本质与命名规则"><a href="#变量的本质与命名规则" class="headerlink" title="变量的本质与命名规则"></a>变量的本质与命名规则</h3><p>在这一章中，变量不再只是“用来存东西的盒子”那么简单，而被赋予了更贴近 Python 精神的理解 —— <strong>名字指向对象（name → object）</strong>。</p>
<p>我学到的重要点包括：</p>
<ul>
<li>变量不需要声明类型，赋值即创建，例如：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">age = <span class="number">18</span></span><br><span class="line">name = <span class="string">&quot;Alice&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>命名规则简洁直观（小写字母、下划线分隔、不能以数字开头等），并且不建议使用保留字（如 <code>if</code>, <code>class</code>, <code>for</code> 等）。</li>
</ul>
<hr>
<h3 id="基本数据类型与类型转换"><a href="#基本数据类型与类型转换" class="headerlink" title="基本数据类型与类型转换"></a>基本数据类型与类型转换</h3><p>本章详尽介绍了几种常用的基本数据类型，包括：</p>
<ul>
<li>数值类型：<code>int</code>、<code>float</code></li>
<li>字符串类型：<code>str</code></li>
<li>布尔类型：<code>bool</code></li>
</ul>
<p>我特别记住了几个实用的函数：</p>
<ul>
<li><code>type()</code>：查看变量的类型</li>
<li><code>int()</code> &#x2F; <code>float()</code> &#x2F; <code>str()</code>：类型转换</li>
<li><code>bool()</code>：任何值都可以转换为布尔值（如非零即真，空字符串为假）</li>
</ul>
<p>示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">3.14</span>))       <span class="comment"># &lt;class &#x27;float&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">int</span>(<span class="string">&quot;42&quot;</span>))        <span class="comment"># 42</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="string">&quot;&quot;</span>))         <span class="comment"># False</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="运算符的使用与优先级"><a href="#运算符的使用与优先级" class="headerlink" title="运算符的使用与优先级"></a>运算符的使用与优先级</h3><p>这一部分复习并扩展了数学运算的知识，并引入了 Python 特有的运算符用法：</p>
<ul>
<li>算术运算符：<code>+ - * / // % **</code></li>
<li>比较运算符：<code>== != &gt; &lt; &gt;= &lt;=</code></li>
<li>逻辑运算符：<code>and or not</code></li>
</ul>
<p>我印象深刻的是：</p>
<ul>
<li><code>//</code> 是地板除法，结果向下取整</li>
<li><code>**</code> 是幂运算，如 <code>2 ** 3 == 8</code></li>
<li>字符串可以进行加法和乘法：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hi&quot;</span> * <span class="number">3</span>)   <span class="comment"># HiHiHi</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>还学到了 <strong>运算符优先级</strong>，类似数学中的“先乘除后加减”，使用括号可以明确顺序，增强代码可读性。</p>
<hr>
<h3 id="我的收获与思考"><a href="#我的收获与思考" class="headerlink" title="我的收获与思考"></a>我的收获与思考</h3><p>本章不仅教我如何使用变量与基本类型，更让我理解了 Python 语言“简洁但不简单”的设计理念：</p>
<ul>
<li>一切皆对象，变量只是对象的标签</li>
<li>不强制类型，但类型管理依然清晰</li>
<li>运算表达灵活，适合快速开发</li>
</ul>
<p>通过练习，我逐渐体会到了写 Python 代码时的“自然感”，就像是在“表达思路”，而不是“翻译成机器语言”。</p>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/17/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%883%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/17/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%883%EF%BC%89/" class="post-title-link" itemprop="url">Agent-camel框架学习记录（3）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-17 18:51:36" itemprop="dateCreated datePublished" datetime="2025-07-17T18:51:36+08:00">2025-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-20 23:33:37" itemprop="dateModified" datetime="2025-07-20T23:33:37+08:00">2025-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<h2 id="CAMEL-多智能体工作流系统概览"><a href="#CAMEL-多智能体工作流系统概览" class="headerlink" title="CAMEL 多智能体工作流系统概览"></a>CAMEL 多智能体工作流系统概览</h2><p>CAMEL是一个用于构建多智能体协作系统的框架，它通过角色扮演机制，让不同的AI智能体扮演特定角色，并协同完成复杂任务。其核心特点包括：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">任务分解：将复杂任务拆解为可管理的子任务。</span><br><span class="line">角色分工：为每个智能体分配专业角色。</span><br><span class="line">依赖管理：智能地处理任务之间的依赖关系。</span><br><span class="line">高效协作：智能体通过对话和合作共同达成目标。</span><br></pre></td></tr></table></figure>
<h3 id="RolePlaying：对话式协作"><a href="#RolePlaying：对话式协作" class="headerlink" title="RolePlaying：对话式协作"></a>RolePlaying：对话式协作</h3><p>RolePlaying 是 CAMEL 中实现多智能体协作的主要方式。它模拟人类对话和协作过程，通过 AI用户（发布指令并引导对话）和 AI助手（提供解决方案并执行指令）的多轮对话来完成任务。</p>
<h4 id="核心概念与参数"><a href="#核心概念与参数" class="headerlink" title="核心概念与参数"></a>核心概念与参数</h4><p>任务（Task）：由初始提示（task_prompt）启动，可由任务指定智能体（with_task_specify）进一步明确。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AI用户（User Agent）：由 user_role_name 定义角色名称。</span><br><span class="line">AI助手（Assistant Agent）：由 assistant_role_name 定义角色名称。</span><br><span class="line">评审者（Critic Agent）：可选，通过 critic_role_name 配置，可以是人类（&quot;human&quot;）或自动评审智能体，用于评估和优化任务完成情况（with_critic_in_the_loop）。</span><br></pre></td></tr></table></figure>
<h4 id="实践流程"><a href="#实践流程" class="headerlink" title="实践流程"></a>实践流程</h4><p>1.设置参数：导入模块，配置模型，并为任务、AI用户和AI助手设置角色名称及相关参数。<br>2.组建 AI-Society：使用 RolePlaying 类初始化多智能体社会。<br>3.解决任务：通过循环调用 society.step() 进行多轮对话，直至任务完成或达到终止条件。is_terminated() 函数可用于检查会话终止原因。</p>
<h3 id="Workforce：大规模团队协作"><a href="#Workforce：大规模团队协作" class="headerlink" title="Workforce：大规模团队协作"></a>Workforce：大规模团队协作</h3><p>Workforce 适用于更复杂的、需要多个智能体并行或串行协作的场景，如软件开发、内容生产和项目管理。它允许用户定义多个“工作节点”（Worker Nodes），每个节点可以是一个拥有特定能力和职责的 ChatAgent。</p>
<h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Workforce 实例：用于管理整个工作组，包含描述、协调智能体（coordinator_agent）和任务规划智能体（task_agent）等。</span><br><span class="line"></span><br><span class="line">工作节点（Worker Nodes）：由 ChatAgent 实例表示，每个节点拥有独特的系统消息（system_message）、模型配置和可选的工具集（tools），如搜索工具。</span><br><span class="line"></span><br><span class="line">任务（Task）：封装具体工作需求，包含 content（任务内容）、additional_info（附加信息）和 id（唯一标识）。</span><br></pre></td></tr></table></figure>
<h4 id="实践流程-1"><a href="#实践流程-1" class="headerlink" title="实践流程"></a>实践流程</h4><p>1.创建 Workforce 实例：初始化 Workforce 对象，并可配置其描述、协调器和任务代理模型。<br>2.定义 Worker：创建具有不同角色和能力的 ChatAgent 实例（例如：搜索助手、规划师、评审员）。<br>3.添加工作节点：使用 add_single_agent_worker() 方法将定义的 ChatAgent 添加到 Workforce 中，并为其提供精准的描述，以便协调器分配任务。<br>4.启动 Workforce 并处理任务：创建 Task 对象，然后调用 workforce.process_task(task) 启动任务处理流程，Workforce 将根据节点描述自动分发子任务并整合结果。</p>
<p>综上，CAMEL 提供了两种主要的多智能体协作模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RolePlaying：适用于双向对话和逐步协作的场景，通过 AI 用户和 AI 助手的互动来细化并完成任务。</span><br><span class="line"></span><br><span class="line">Workforce：适用于多角色、大规模团队协作的场景，通过协调智能体调度多个拥有特定能力的 ChatAgent 共同完成复杂任务，并可引入外部工具辅助。</span><br></pre></td></tr></table></figure>
<p>两种模式都强调通过明确的角色定义和系统消息来提升智能体的能力和协作效率。</p>
<h3 id="由于先前我们已经在之前的学习笔记以及练习中梳理过RolePlaying相关的内容以及演示，我们接下来主要演示Workforce场景的使用："><a href="#由于先前我们已经在之前的学习笔记以及练习中梳理过RolePlaying相关的内容以及演示，我们接下来主要演示Workforce场景的使用：" class="headerlink" title="由于先前我们已经在之前的学习笔记以及练习中梳理过RolePlaying相关的内容以及演示，我们接下来主要演示Workforce场景的使用："></a>由于先前我们已经在之前的学习笔记以及练习中梳理过RolePlaying相关的内容以及演示，我们接下来主要演示Workforce场景的使用：</h3><hr>
<p>下面我们将创建一个简单的 Workforce 示例，让不同的智能体共同完成一个任务，比如生成一份关于东京旅游的行程规划。我们将定义以下角色：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> 工作节点（Worker Agents）的定义</span><br><span class="line">在这个优化版本中，我们为每个智能体赋予了更明确、更专业的职责，并移除了对外部搜索工具的依赖，让它们专注于利用自身的“知识库”来提供信息和执行任务。</span><br><span class="line"></span><br><span class="line">东京旅游专家 (Researcher Agent)：</span><br><span class="line"></span><br><span class="line">角色定位：一位经验丰富的东京旅游专家。</span><br><span class="line"></span><br><span class="line">职责：利用其丰富的内置知识提供东京的景点、美食、交通和购物信息，不再进行网络搜索，以确保信息来源可控且避免速率限制。</span><br><span class="line"></span><br><span class="line">高级旅游规划师 (Planner Agent)：</span><br><span class="line"></span><br><span class="line">角色定位：专业的行程规划师。</span><br><span class="line"></span><br><span class="line">职责：根据“东京旅游专家”提供的信息和游客的详细需求，精心制定一份合理、详细且吸引人的3日东京旅游行程，注重时间、交通和体验平衡。</span><br><span class="line"></span><br><span class="line">资深旅行评论员 (Reviewer Agent)：</span><br><span class="line"></span><br><span class="line">角色定位：眼光独到的旅行评论员。</span><br><span class="line"></span><br><span class="line">职责：严格评估规划师制定的行程，从实用性、趣味性、性价比、潜在问题和文化体验等多个维度给出建设性反馈和优化建议。</span><br></pre></td></tr></table></figure>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>首先，确保你安装了必要的库并配置了API密钥。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, TaskType</span><br><span class="line"><span class="keyword">from</span> camel.societies.workforce <span class="keyword">import</span> Workforce</span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> camel.tasks <span class="keyword">import</span> Task</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建模型实例</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;🔧 正在创建优化版本的 Workforce...&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="定义工作节点-Worker-Agents"><a href="#定义工作节点-Worker-Agents" class="headerlink" title="定义工作节点 (Worker Agents)"></a>定义工作节点 (Worker Agents)</h4><p>我们将创建三个不同职责的 ChatAgent，每个 Agent 都有自己的系统消息和潜在的工具。<br> 工作节点（Worker Agents）的定义</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 研究员 Agent：负责信息搜索</span></span><br><span class="line">researcher_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;旅游信息研究员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;你是一个专业的旅游信息研究员，精通网络搜索。你的职责是准确、全面地收集指定目的地的景点、美食、交通和住宿信息，并提供给规划师。你会使用搜索工具来获取最新和最准确的数据。&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model,</span><br><span class="line">    tools=[SearchToolkit().search_duckduckgo] <span class="comment"># 赋予搜索能力</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 规划师 Agent：负责行程规划</span></span><br><span class="line">planner_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;高级旅游规划师&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;你是一位经验丰富的高级旅游规划师。你的职责是根据研究员提供的信息和用户的具体需求，制定一份合理、详细且富有吸引力的旅游行程。你需要考虑时间安排、交通便利性、景点特色和用户体验。&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 评审员 Agent：负责评估和优化</span></span><br><span class="line">reviewer_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;资深旅行评论员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;你是一位眼光独到的资深旅行评论员。你的职责是像真正的旅行者一样，从实用性、趣味性、性价比和潜在问题等角度，严格评审规划师提供的旅游行程，并提出建设性的改进意见，确保行程质量。&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;✅ 所有工作节点（研究员、规划师、评审员）已定义。&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>本部分代码可以采用Tools实时从网站调取最新的旅游相关信息，以提高研究院代理的推荐精准性并保持最新信息。<br>但是，由于存在“多个搜索任务同时执行，短时间内发送了太多请求，触发了DuckDuckGo 搜索速率限制”问题，最终导致研究员代理无法获取实时的东京旅游信息的问题。<br>因此我们进行了进一步的版本改进：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 定义工作节点 (不使用搜索工具，避免速率限制)</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 研究员 Agent：使用内置知识提供信息</span></span><br><span class="line">researcher_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;东京旅游专家&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一位资深的东京旅游专家，拥有丰富的东京旅游知识。你熟悉东京的热门景点、特色美食、交通方式和购物场所。</span></span><br><span class="line"><span class="string">        你的职责是基于你的专业知识，为游客提供准确、实用的东京旅游信息，包括：</span></span><br><span class="line"><span class="string">        - 融合现代与传统的热门景点</span></span><br><span class="line"><span class="string">        - 特色美食推荐和餐厅位置</span></span><br><span class="line"><span class="string">        - 便捷的交通方式和路线</span></span><br><span class="line"><span class="string">        - 适合购物的区域和商场</span></span><br><span class="line"><span class="string">        请提供详细、实用的建议，不需要进行网络搜索。&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 规划师 Agent：负责行程规划</span></span><br><span class="line">planner_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;高级旅游规划师&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一位经验丰富的高级旅游规划师，专门制定东京旅游行程。</span></span><br><span class="line"><span class="string">        你的职责是根据提供的信息和用户需求，制定合理、详细且富有吸引力的旅游行程。</span></span><br><span class="line"><span class="string">        你需要考虑：</span></span><br><span class="line"><span class="string">        - 时间安排的合理性</span></span><br><span class="line"><span class="string">        - 交通便利性和路线优化</span></span><br><span class="line"><span class="string">        - 景点的特色和游客体验</span></span><br><span class="line"><span class="string">        - 餐饮和购物的平衡安排</span></span><br><span class="line"><span class="string">        - 现代与传统文化的结合体验&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 评审员 Agent：负责评估和优化</span></span><br><span class="line">reviewer_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;资深旅行评论员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一位眼光独到的资深旅行评论员，专门评估旅游行程质量。</span></span><br><span class="line"><span class="string">        你的职责是从真正旅行者的角度，严格评审旅游行程，并提出建设性改进意见。</span></span><br><span class="line"><span class="string">        评估维度包括：</span></span><br><span class="line"><span class="string">        - 实用性：交通是否便利，时间安排是否合理</span></span><br><span class="line"><span class="string">        - 趣味性：景点是否有吸引力，体验是否丰富</span></span><br><span class="line"><span class="string">        - 性价比：费用预算是否合理</span></span><br><span class="line"><span class="string">        - 潜在问题：可能遇到的困难和解决方案</span></span><br><span class="line"><span class="string">        - 文化体验：是否能深入了解日本文化&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;✅ 所有工作节点已定义（无搜索工具依赖）&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>在这个优化版本中，我们为每个智能体赋予了更明确、更专业的职责，并移除了对外部搜索工具的依赖，让它们专注于利用自身的“知识库”来提供信息和执行任务。</p>
<p>Workforce 实例的创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 创建简化的 Workforce 实例</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建协调器 Agent</span></span><br><span class="line">coordinator_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;工作组协调员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;你是一个高效的工作组协调员，负责协调旅游规划团队的工作。你需要合理分配任务，确保工作流程顺畅，最终产出高质量的旅游行程规划。&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建任务代理 Agent</span></span><br><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> TaskPlanningToolkit</span><br><span class="line">task_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;任务规划专家&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;你是一个专业的任务规划专家，负责将复杂的旅游规划任务分解为具体的子任务。你擅长分析任务需求，识别关键步骤，并合理安排任务执行顺序。&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model,</span><br><span class="line">    tools=TaskPlanningToolkit().get_tools()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Workforce 实例（完整版本）</span></span><br><span class="line">travel_workforce = Workforce(</span><br><span class="line">    description=<span class="string">&quot;东京旅游行程规划与评估工作组&quot;</span>,</span><br><span class="line">    coordinator_agent=coordinator_agent,</span><br><span class="line">    task_agent=task_agent</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们创建了一个名为 travel_workforce 的 Workforce 实例，其描述为“东京旅游行程规划与评估工作组”，清晰地概括了整个团队的职能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">明确的协调器 (Coordinator Agent)：这次我们单独创建了一个 coordinator_agent，并为其分配了“工作组协调员”的角色，强调其负责任务分配和流程顺畅的核心职责。</span><br><span class="line"></span><br><span class="line">明确的任务代理 (Task Agent)：我们也单独创建了 task_agent，赋予其“任务规划专家”的角色，并为其配备了 TaskPlanningToolkit，使其更擅长将复杂任务分解为可执行的子任务。</span><br></pre></td></tr></table></figure>
<p>工作节点的添加：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加工作节点</span></span><br><span class="line">travel_workforce.add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;提供东京的景点、美食和交通专业知识&quot;</span>,</span><br><span class="line">    worker=researcher_agent</span><br><span class="line">).add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;制定详细的东京3日旅游行程&quot;</span>,</span><br><span class="line">    worker=planner_agent</span><br><span class="line">).add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;评估旅游行程并提出改进建议&quot;</span>,</span><br><span class="line">    worker=reviewer_agent</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;✅ Workforce 实例已创建并添加所有工作节点&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>使用 add_single_agent_worker() 方法，将前面定义的“东京旅游专家”、“高级旅游规划师”和“资深旅行评论员”作为独立的工人节点添加到 travel_workforce 中。每个节点都附带了简洁明了的职责描述，这是协调器进行任务分配的关键依据。</p>
<p>创建任务并启动 Workforce<br>最后，我们定义一个要交给 Workforce 处理的任务，并调用 process_task() 方法启动协作流程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 创建任务并启动</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">tokyo_task = Task(</span><br><span class="line">    content=<span class="string">&quot;请为一位首次访问东京的游客规划一份详细的3日旅游行程。行程应包含热门景点、特色美食体验，并考虑交通便利性。&quot;</span>,</span><br><span class="line">    additional_info=&#123;</span><br><span class="line">        <span class="string">&quot;游客偏好&quot;</span>: <span class="string">&quot;希望体验东京的现代与传统结合，对购物和美食有兴趣&quot;</span>,</span><br><span class="line">        <span class="string">&quot;当前日期&quot;</span>: <span class="string">&quot;2025年7月17日&quot;</span>,</span><br><span class="line">        <span class="string">&quot;旅行天数&quot;</span>: <span class="string">&quot;3天&quot;</span>,</span><br><span class="line">        <span class="string">&quot;游客类型&quot;</span>: <span class="string">&quot;首次访问东京的游客&quot;</span>,</span><br><span class="line">        <span class="string">&quot;特殊要求&quot;</span>: <span class="string">&quot;避免过于紧凑的行程，注重文化体验&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;tokyo_trip_plan_optimized&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n🚀 开始处理优化任务: &#x27;<span class="subst">&#123;tokyo_task.content[:<span class="number">50</span>]&#125;</span>...&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 处理任务</span></span><br><span class="line">    processed_task = travel_workforce.process_task(tokyo_task)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;📋 任务处理完成&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;任务ID: <span class="subst">&#123;processed_task.<span class="built_in">id</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n最终结果:\n<span class="subst">&#123;processed_task.result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n🎉 优化版 Workforce 演示成功！&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n❌ 任务处理出现错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;这可能是由于模型配置或网络问题导致的&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>让我们看看最终运行效果如何吧！：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/test_Workforce_optimized.py</span><br><span class="line">🔧 正在创建优化版本的 Workforce...</span><br><span class="line">✅ 所有工作节点已定义（无搜索工具依赖）</span><br><span class="line">✅ Workforce 实例已创建并添加所有工作节点</span><br><span class="line"></span><br><span class="line">🚀 开始处理优化任务: &#x27;请为一位首次访问东京的游客规划一份详细的3日旅游行程。行程应包含热门景点、特色美 食体验，并考虑交通便...&#x27;</span><br><span class="line">Worker node a6766c80-35c1-4049-a379-70e3f09aa193 (提供东京的景点、美食和交通专业知识) get task tokyo_trip_plan_optimized.0: 收集东京的热门景点、特色美食和交通信息。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node a6766c80-35c1-4049-a379-70e3f09aa193 (提供东京的景点、美食和交通专业知识):</span><br><span class="line"></span><br><span class="line">对于希望体验东京现代与传统结合的首次访问游客，以下是一些建议：</span><br><span class="line"></span><br><span class="line">**热门景点**:</span><br><span class="line">- **浅草寺**：作为东京最古老的寺庙，浅草寺是体验日本传统文化的绝佳地点。附近还有雷门和仲见世商店街，可以购买到各种手工艺品和小吃。</span><br><span class="line">- **明治神宫**：位于原宿，是一个供奉明治天皇及其妻子的地方。周围有大片森林，环境非常宁静。</span><br><span class="line">- **东京塔/晴空塔**：这两个观景塔都是俯瞰东京全景的好地方，尤其是夜景非常美丽。</span><br><span class="line">- **上野公园及博物馆区**：上野公园内有多个博物馆，如东京国立博物馆，非常适合喜欢艺术和历史的游客。    </span><br><span class="line"></span><br><span class="line">**特色美食**:</span><br><span class="line">- **寿司**：银座的‘すきやばし次郎’（Sukiyabashi Jiro）是世界著名的寿司店，但价格昂贵，可以尝试其他平价但同样美味的寿司店，如‘築地場外市場’（Tsukiji Outer Market）。</span><br><span class="line">- **拉面**：池袋的‘ラーメンストリート’（Ramen Street）汇集了多家拉面店，可以尝试点不同风味的拉面。    </span><br><span class="line">- **烤肉**：新宿的‘焼肉きんぐ’（Yakiniku King）提供自助式的烤肉，性价比高，适合家庭或朋友聚餐。       </span><br><span class="line"></span><br><span class="line">**交通信息**:</span><br><span class="line">- **地铁**：东京地铁网络发达，覆盖主要旅游景点。建议购买一日券或多日券以节省费用。</span><br><span class="line">- **巴士**：观光巴士线路连接了主要的旅游景点，车上有中文解说，适合外国游客。</span><br><span class="line">- **出租车**：虽然价格较高，但在不熟悉地铁系统时，可以考虑使用。</span><br><span class="line">- **步行**：部分景点之间距离较近，如浅草寺和上野公园，可以选择步行游览。</span><br><span class="line"></span><br><span class="line">以上建议希望能帮助您在东京度过一个愉快的文化体验之旅。</span><br><span class="line">======</span><br><span class="line">🎯 Task tokyo_trip_plan_optimized.0 completed successfully.</span><br><span class="line">Worker node d444ab33-281a-4184-9e5e-0e92cfc108f9 (制定详细的东京3日旅游行程) get task tokyo_trip_plan_optimized.1: 基于收集的信息，设计一个结合现代与传统元素、适合购物和美食体验的3日旅游行程。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node d444ab33-281a-4184-9e5e-0e92cfc108f9 (制定详细的东京3日旅游行程):</span><br><span class="line"></span><br><span class="line">### 东京3日游行程安排</span><br><span class="line"></span><br><span class="line">#### 第1天：浅草寺 - 仲见世商店街 - 上野公园及博物馆区</span><br><span class="line">- **上午**：</span><br><span class="line">  - 9:00 - 11:00：参观浅草寺，感受日本的传统宗教文化和建筑。</span><br><span class="line">  - 11:00 - 12:00：漫步仲见世商店街，品尝当地小吃，购买手工艺品。</span><br><span class="line">- **中午**：</span><br><span class="line">  - 12:00 - 13:00：在仲见世商店街附近的餐厅享用午餐，推荐尝试传统的日式料理。</span><br><span class="line">- **下午**：</span><br><span class="line">  - 13:30 - 16:00：前往上野公园，参观东京国立博物馆，了解日本的历史和艺术。</span><br><span class="line">  - 16:00 - 17:30：在上野公园内散步，欣赏自然美景。</span><br><span class="line">- **晚上**：</span><br><span class="line">  - 18:00 - 19:30：在上野站附近的居酒屋享用晚餐，体验日本的夜生活。</span><br><span class="line"></span><br><span class="line">#### 第2天：明治神宫 - 原宿 - 表参道 - 池袋拉面街</span><br><span class="line">- **上午**：</span><br><span class="line">  - 9:00 - 11:00：参观明治神宫，感受宁静的自然环境和传统神道教文化。</span><br><span class="line">- **中午**：</span><br><span class="line">  - 11:30 - 12:30：在原宿的竹下通品尝街头小吃，如章鱼烧和可丽饼。</span><br><span class="line">- **下午**：</span><br><span class="line">  - 13:00 - 15:00：游览表参道，享受时尚购物体验，参观高端品牌店和设计师精品店。</span><br><span class="line">  - 15:30 - 17:00：前往池袋拉面街，尝试不同风味的拉面。</span><br><span class="line">- **晚上**：</span><br><span class="line">  - 18:00 - 19:30：在池袋的居酒屋享用晚餐，体验当地的餐饮文化。</span><br><span class="line"></span><br><span class="line">#### 第3天：东京塔/晴空塔 - 银座 - 新宿烤肉</span><br><span class="line">- **上午**：</span><br><span class="line">  - 9:00 - 11:00：参观东京塔或晴空塔，俯瞰东京全景，欣赏美丽的城市风光。</span><br><span class="line">- **中午**：</span><br><span class="line">  - 11:30 - 12:30：在银座的築地場外市場享用寿司，品尝新鲜的海鲜。</span><br><span class="line">- **下午**：</span><br><span class="line">  - 13:00 - 15:00：在银座购物，购买高端奢侈品和时尚商品。</span><br><span class="line">  - 15:30 - 17:00：自由活动时间，可在银座继续探索或休息。</span><br><span class="line">- **晚上**：</span><br><span class="line">  - 18:00 - 19:30：在新宿的焼肉きんぐ享用自助烤肉，与家人或朋友共度美好时光。</span><br><span class="line"></span><br><span class="line">### 交通建议</span><br><span class="line">- **地铁**：建议购买三日券，方便快捷地到达各个景点。</span><br><span class="line">- **步行**：部分景点之间距离较近，如浅草寺和上野公园，可以选择步行游览。</span><br><span class="line">- **出租车**：在不熟悉地铁系统时，可以考虑使用出租车，尤其是在携带较多行李的情况下。</span><br><span class="line"></span><br><span class="line">希望这个行程能为您的东京之旅带来美好的回忆！祝您旅途愉快！</span><br><span class="line">======</span><br><span class="line">🎯 Task tokyo_trip_plan_optimized.1 completed successfully.</span><br><span class="line">Worker node ebcf8ea8-a047-434f-bb70-82ba9b0f8b92 (评估旅游行程并提出改进建议) get task tokyo_trip_plan_optimized.2: 评估设计的旅游行程，确保其满足游客的需求，包括避免过于紧凑的行程，注重文化体验。        </span><br><span class="line">======</span><br><span class="line">Reply from Worker node ebcf8ea8-a047-434f-bb70-82ba9b0f8b92 (评估旅游行程并提出改进建议):</span><br><span class="line"></span><br><span class="line">### 东京3日游行程评估报告</span><br><span class="line"></span><br><span class="line">#### 实用性</span><br><span class="line">- **交通**：行程中建议使用地铁三日券，这是非常实用的建议，因为东京地铁网络发达，覆盖主要旅游景点，可以节省时间和费用。</span><br><span class="line">- **时间安排**：整体时间安排较为合理，避免了过于紧凑的行程，每个景点都有足够的时间进行参观和体验。    </span><br><span class="line"></span><br><span class="line">#### 趣味性</span><br><span class="line">- **景点吸引力**：行程中包含了许多具有代表性的景点，如浅草寺、明治神宫、东京塔/晴空塔等，这些景点不仅 有历史文化价值，还能让游客感受到东京的现代都市魅力。</span><br><span class="line">- **体验丰富**：除了参观景点，还安排了购物、美食体验，如在仲见世商店街品尝小吃，在築地場外市場享用寿司，在池袋拉面街尝试不同风味的拉面，以及在新宿的焼肉きんぐ享用自助烤肉，这些都能让游客全方位体验东京的魅力。</span><br><span class="line"></span><br><span class="line">#### 性价比</span><br><span class="line">- **费用预算**：建议购买地铁三日券，这是一个经济实惠的选择。此外，行程中推荐了一些性价比高的美食地点，如築地場外市場和池袋拉面街，这有助于控制旅行成本。</span><br><span class="line"></span><br><span class="line">#### 潜在问题</span><br><span class="line">- **语言障碍**：对于不熟悉日语的外国游客，可能会在点餐和购物时遇到困难。建议提前下载翻译应用，或者选择有英文菜单和服务的餐厅。</span><br><span class="line">- **天气变化**：东京的天气多变，特别是在夏季，建议游客随身携带雨具，以防突然下雨。</span><br><span class="line"></span><br><span class="line">#### 文化体验</span><br><span class="line">- **深入体验**：行程中安排了多个具有文化特色的景点，如浅草寺、明治神宫和东京国立博物馆，这些地方可以让游客深入了解日本的历史和文化。</span><br><span class="line">- **互动体验**：建议在浅草寺和明治神宫增加一些互动环节，如参加祈福仪式或体验传统茶道，这样可以进一步增强文化体验。</span><br><span class="line"></span><br><span class="line">总体来说，这个行程设计得非常好，既兼顾了实用性，又提供了丰富的文化体验。希望这些建议能帮助游客更好地享受东京之旅。</span><br><span class="line">======</span><br><span class="line">🎯 Task tokyo_trip_plan_optimized.2 completed successfully.</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">📋 任务处理完成</span><br><span class="line">============================================================</span><br><span class="line">任务ID: tokyo_trip_plan_optimized</span><br><span class="line"></span><br><span class="line">🎉 Workforce 演示成功！ </span><br></pre></td></tr></table></figure>


<p>以及另一个版本的不同输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/test_Workforce_optimized.py</span><br><span class="line">🔧 正在创建优化版本的 Workforce...</span><br><span class="line">✅ 所有工作节点已定义（无搜索工具依赖）</span><br><span class="line">✅ Workforce 实例已创建并添加所有工作节点</span><br><span class="line"></span><br><span class="line">🚀 开始处理优化任务: &#x27;请为一位首次访问东京的游 客规划一份详细的3日旅游行程。行程应包含热门景点、特色美食体验，并考虑交通便...&#x27;</span><br><span class="line">Worker node 39687a9c-f0d1-4cd6-98d9-f71b751d4bde (提供东京的景点、美食和交通专业知识) get task tokyo_trip_plan_optimized.0: 研究东京的热门景 点、特色美食和交通方式，以满足游客对现代与传统 结合的体验需求。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node 39687a9c-f0d1-4cd6-98d9-f71b751d4bde (提供东京的景点、美食和交通专业知 识):</span><br><span class="line"></span><br><span class="line">为了满足您对东京现代与传统结合的体验需求，我为 您规划了为期三天的行程。第一天：上野公园和阿美 横丁，您可以在这里感受到浓厚的传统日本文化氛围 ，同时也能品尝到各种地道的日本小吃。第二天：浅 草寺和雷门，这是东京最古老的寺庙之一，旁边还有 许多传统手工艺品店，之后可以前往附近的东京晴空 塔，体验现代东京的壮观景象。第三天：原宿和表参 道，这里是东京时尚潮流的发源地，有许多独特的商 店和咖啡馆，非常适合购物和拍照。关于交通方式， 建议购买一日券或三日券乘坐地铁，这样既方便又经 济。如果您想体验更多当地生活，也可以选择租用自 行车。至于美食，推荐您尝试寿司、拉面和天妇罗， 这些都可以在上述提到的地方找到。希望这些建议能 帮助您度过一个愉快的东京之旅。</span><br><span class="line">======</span><br><span class="line">🎯 Task tokyo_trip_plan_optimized.0 completed successfully.</span><br><span class="line">Worker node d72e4f78-769b-406d-bacc-cc4b230711b5 (制定详细的东京3日旅游行程) get task tokyo_trip_plan_optimized.1: 基于研究结果，制定一个平衡的3日旅游行程，确保行程不过于紧凑，同时注重文化体验。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node d72e4f78-769b-406d-bacc-cc4b230711b5 (制定详细的东京3日旅游行程):      </span><br><span class="line"></span><br><span class="line">为了满足您对东京现代与传统结合的体验需求，我为 您规划了为期三天的平衡行程。第一天：上午参观上 野公园，感受浓厚的传统日本文化氛围，中午在阿美 横丁品尝各种地道的日本小吃；下午自由活动，可以 选择逛逛附近的博物馆或商店。第二天：上午游览浅 草寺和雷门，了解东京的历史文化；中午在附近品尝 传统的日式料理；下午前往东京晴空塔，体验现代东 京的壮观景象。第三天：全天探索原宿和表参道，这 里是东京时尚潮流的发源地，有许多独特的商店和咖 啡馆，非常适合购物和拍照。关于交通方式，建议购 买三日券乘坐地铁，这样既方便又经济。希望这些建 议能帮助您度过一个愉快的东京之旅。</span><br><span class="line">======</span><br><span class="line">🎯 Task tokyo_trip_plan_optimized.1 completed successfully.</span><br><span class="line">Worker node 3a796729-1774-43b5-b481-60504a509ded (评估旅游行程并提出改进建议) get task tokyo_trip_plan_optimized.2: 评估制定的旅游行程，提出 改进建议，确保行程符合游客的兴趣和特殊要求。   </span><br><span class="line">======</span><br><span class="line">Reply from Worker node 3a796729-1774-43b5-b481-60504a509ded (评估旅游行程并提出改进建议):     </span><br><span class="line"></span><br><span class="line">根据您的需求，我已经评估了这个3天的东京旅游行程。实用性方面，行程中的交通方式建议购买三日券乘 坐地铁，非常便利且经济，同时也提供了租用自行车 的建议，增加了旅行的灵活性。趣味性方面，行程包 含了多个具有代表性的景点，如上野公园、浅草寺、 东京晴空塔等，能够充分体验东京的传统与现代结合 的魅力。此外，还特别提到了购物和美食的地点，符 合您的兴趣。性价比方面，整体行程安排合理，没有 过多的重复和浪费时间的环节，费用预算也相对合理 。潜在问题方面，需要注意的是东京晴空塔可能需要 提前预订门票，以免现场排队时间过长。此外，原宿 和表参道的购物区可能会比较拥挤，建议避开高峰时 段。文化体验方面，行程中安排了多个能够深入了解 日本文化的景点，如上野公园、浅草寺等，能够满足 您对文化体验的需求。总体来说，这是一个很好的行 程，但建议在出行前再次确认所有景点的开放时间和 门票预订情况，以确保行程顺利进行。</span><br><span class="line">======</span><br><span class="line">🎯 Task tokyo_trip_plan_optimized.2 completed successfully.</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">📋 任务处理完成</span><br><span class="line">============================================================</span><br><span class="line">任务ID: tokyo_trip_plan_optimized</span><br><span class="line"></span><br><span class="line">🎉Workforce 演示成功！</span><br></pre></td></tr></table></figure>

<p>两个输出的版本在输出格式&#x2F;行程规划的具体方面均有不同，但是都遵循“旅行专家推荐→旅游规划师规划→资深评论员审评”的三大步骤，且输出都在预期范围之内。</p>
<p>后续我又研究了一下，并创建一个既能使用搜索工具，又能避免速率限制问题的解决方案：<br>确保自动在搜索请求之间添加延迟（5秒），以避免触发 DuckDuckGo 的速率限制<br>并进行了一些其它改进优化工作：</p>
<p>我们主要看搜索部分：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 自定义搜索工具类，添加速率限制控制</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RateLimitedSearchToolkit</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;带速率限制的搜索工具包&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, delay_seconds=<span class="number">3</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.search_toolkit = SearchToolkit()</span><br><span class="line">        <span class="variable language_">self</span>.delay_seconds = delay_seconds</span><br><span class="line">        <span class="variable language_">self</span>.last_search_time = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">safe_search_duckduckgo</span>(<span class="params">self, query: <span class="built_in">str</span>, max_results: <span class="built_in">int</span> = <span class="number">5</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;安全的搜索方法，包含速率限制&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        time_since_last = current_time - <span class="variable language_">self</span>.last_search_time</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> time_since_last &lt; <span class="variable language_">self</span>.delay_seconds:</span><br><span class="line">            sleep_time = <span class="variable language_">self</span>.delay_seconds - time_since_last</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot; 等待 <span class="subst">&#123;sleep_time:<span class="number">.1</span>f&#125;</span> 秒以避免速率限制...&quot;</span>)</span><br><span class="line">            time.sleep(sleep_time)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.search_toolkit.search_duckduckgo(query, max_results)</span><br><span class="line">            <span class="variable language_">self</span>.last_search_time = time.time()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot; 搜索成功: <span class="subst">&#123;query[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot; 搜索失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;搜索暂时不可用，请使用已有知识回答。错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建速率限制搜索工具实例</span></span><br><span class="line">safe_search = RateLimitedSearchToolkit(delay_seconds=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 定义工作节点（带安全搜索功能）</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 研究员 Agent：使用安全搜索工具</span></span><br><span class="line">researcher_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;东京旅游信息研究员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一个专业的东京旅游信息研究员。你的职责是：</span></span><br><span class="line"><span class="string">        1. 使用搜索工具获取最新的东京旅游信息</span></span><br><span class="line"><span class="string">        2. 如果搜索不可用，使用你的专业知识提供信息</span></span><br><span class="line"><span class="string">        3. 重点关注：热门景点、特色美食、交通方式、购物场所</span></span><br><span class="line"><span class="string">        4. 特别注意现代与传统结合的地方</span></span><br><span class="line"><span class="string">        5. 提供实用、准确的旅游建议</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        搜索策略：</span></span><br><span class="line"><span class="string">        - 使用简洁的关键词避免复杂查询</span></span><br><span class="line"><span class="string">        - 如果遇到速率限制，依靠专业知识回答</span></span><br><span class="line"><span class="string">        - 优先提供2025年最新信息&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model,</span><br><span class="line">    tools=[safe_search.safe_search_duckduckgo]  <span class="comment"># 使用安全搜索工具</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 规划师 Agent</span></span><br><span class="line">planner_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;高级旅游规划师&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一位经验丰富的东京旅游规划师。你的职责是：</span></span><br><span class="line"><span class="string">        1. 根据研究员提供的信息制定详细行程</span></span><br><span class="line"><span class="string">        2. 考虑交通便利性和时间安排</span></span><br><span class="line"><span class="string">        3. 平衡现代与传统文化体验</span></span><br><span class="line"><span class="string">        4. 安排合理的购物和美食时间</span></span><br><span class="line"><span class="string">        5. 确保行程适合首次访问东京的游客</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        规划原则：</span></span><br><span class="line"><span class="string">        - 每天不超过3-4个主要景点</span></span><br><span class="line"><span class="string">        - 合理安排休息时间</span></span><br><span class="line"><span class="string">        - 考虑地理位置的邻近性</span></span><br><span class="line"><span class="string">        - 包含详细的交通指南&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 评审员 Agent</span></span><br><span class="line">reviewer_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;资深旅行评论员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一位资深的旅行评论员。你的职责是：</span></span><br><span class="line"><span class="string">        1. 从实际旅行者角度评估行程</span></span><br><span class="line"><span class="string">        2. 识别潜在问题和改进空间</span></span><br><span class="line"><span class="string">        3. 提供具体的优化建议</span></span><br><span class="line"><span class="string">        4. 确保行程的实用性和趣味性</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        评估维度：</span></span><br><span class="line"><span class="string">        - 时间安排是否合理</span></span><br><span class="line"><span class="string">        - 交通是否便利</span></span><br><span class="line"><span class="string">        - 费用预算是否适中</span></span><br><span class="line"><span class="string">        - 文化体验是否丰富</span></span><br><span class="line"><span class="string">        - 是否适合目标游客群体&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要改变以上信息，那么让我们来再看看运行效果如何吧：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-<span class="number">3.11</span><span class="number">.9</span>/python.exe d:/Camel_Test_Project/CAMEL_Workforce_with_search.py</span><br><span class="line">🔧 正在创建带搜索功能的 Workforce...</span><br><span class="line">D:\Download\Python\py-<span class="number">3.11</span><span class="number">.9</span>\Lib\site-packages\camel\toolkits\function_tool.py:<span class="number">533</span>: UserWarning: Parameter description <span class="keyword">is</span> missing <span class="keyword">for</span> the function <span class="string">&#x27;search_linkup&#x27;</span>. The parameter definition <span class="keyword">is</span> &#123;<span class="string">&#x27;enum&#x27;</span>: [<span class="string">&#x27;searchResults&#x27;</span>, <span class="string">&#x27;sourcedAnswer&#x27;</span>, <span class="string">&#x27;structured&#x27;</span>], <span class="string">&#x27;type&#x27;</span>: [<span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;null&#x27;</span>]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-<span class="number">3.11</span><span class="number">.9</span>\Lib\site-packages\camel\toolkits\function_tool.py:<span class="number">533</span>: UserWarning: Parameter description <span class="keyword">is</span> missing <span class="keyword">for</span> the function <span class="string">&#x27;search_alibaba_tongxiao&#x27;</span>. The parameter definition <span class="keyword">is</span> &#123;<span class="string">&#x27;enum&#x27;</span>: [<span class="string">&#x27;OneDay&#x27;</span>, <span class="string">&#x27;OneWeek&#x27;</span>, <span class="string">&#x27;OneMonth&#x27;</span>, <span class="string">&#x27;OneYear&#x27;</span>, <span class="string">&#x27;NoLimit&#x27;</span>], <span class="string">&#x27;type&#x27;</span>: [<span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;null&#x27;</span>]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-<span class="number">3.11</span><span class="number">.9</span>\Lib\site-packages\camel\toolkits\function_tool.py:<span class="number">533</span>: UserWarning: Parameter description <span class="keyword">is</span> missing <span class="keyword">for</span> the function <span class="string">&#x27;search_alibaba_tongxiao&#x27;</span>. The parameter definition <span class="keyword">is</span> &#123;<span class="string">&#x27;anyOf&#x27;</span>: [&#123;<span class="string">&#x27;enum&#x27;</span>: [<span class="string">&#x27;finance&#x27;</span>, <span class="string">&#x27;law&#x27;</span>, <span class="string">&#x27;medical&#x27;</span>, <span class="string">&#x27;internet&#x27;</span>, <span class="string">&#x27;tax&#x27;</span>, <span class="string">&#x27;news_province&#x27;</span>, <span class="string">&#x27;news_center&#x27;</span>], <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;string&#x27;</span>&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;null&#x27;</span>&#125;], <span class="string">&#x27;type&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>]&#125;. This may affect the quality of tool calling.   </span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-<span class="number">3.11</span><span class="number">.9</span>\Lib\site-packages\camel\toolkits\function_tool.py:<span class="number">533</span>: UserWarning: Parameter description <span class="keyword">is</span> missing <span class="keyword">for</span> the function <span class="string">&#x27;safe_search_duckduckgo&#x27;</span>. The parameter definition <span class="keyword">is</span> &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;string&#x27;</span>&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-<span class="number">3.11</span><span class="number">.9</span>\Lib\site-packages\camel\toolkits\function_tool.py:<span class="number">533</span>: UserWarning: Parameter description <span class="keyword">is</span> missing <span class="keyword">for</span> the function <span class="string">&#x27;safe_search_duckduckgo&#x27;</span>. The parameter definition <span class="keyword">is</span> &#123;<span class="string">&#x27;type&#x27;</span>: [<span class="string">&#x27;integer&#x27;</span>, <span class="string">&#x27;null&#x27;</span>]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">✅ 所有工作节点已定义（包含安全搜索功能）</span><br><span class="line">✅ Workforce 实例已创建（包含搜索功能）</span><br><span class="line"></span><br><span class="line">🚀 开始处理带搜索功能的任务...</span><br><span class="line">任务: 请为一位首次访问东京的游客规划一份详细的<span class="number">3</span>日旅游行程。需要包含热门景点、特色美食体验，并考虑交通 便利性。请获取<span class="number">2025</span>年最新的旅游信息。...</span><br><span class="line"></span><br><span class="line">⏳ 正在协调多智能体工作...</span><br><span class="line">Worker node 1370eb13-4f2f-4a47-99f0-cbbbcd2fb50b (负责搜索和提供东京最新的旅游信息，包括景点、美食、交通等) get task tokyo_trip_plan_with_search<span class="number">.0</span>: Subtask <span class="number">1</span> (1370eb13-4f2f-4a47-99f0-cbbbcd2fb50b): 负责搜索和提供东京最新的旅游信息，包括景点、美食、交通等</span><br><span class="line">✅ 搜索成功: 东京 最新 旅游信息 热门景点 特色美食 交通方式 购物场所 <span class="number">2025.</span>..</span><br><span class="line">======</span><br><span class="line">Reply <span class="keyword">from</span> Worker node 1370eb13-4f2f-4a47-99f0-cbbbcd2fb50b (负责搜索和提供东京最新的旅游信息，包括景 点、美食、交通等):</span><br><span class="line"></span><br><span class="line">根据我的知识，以下是对您计划的东京之旅的一些建议，这些信息尽可能地反映了<span class="number">2025</span>年的最新情况，尽管我无法即时检索到最新数据，但这些推荐仍然具有时效性。</span><br><span class="line"></span><br><span class="line">**热门景点**</span><br><span class="line">- **浅草寺**：作为东京最古老的佛教寺庙，浅草寺不仅是一个重要的文化遗址，也是感受日本传统文化的好地方。从雷门进入，可以欣赏到传统的日式建筑和热闹的商店街。</span><br><span class="line">- **东京晴空塔**（Tokyo Skytree）：这座<span class="number">634</span>米高的电波塔不仅是东京的新地标，而且从塔顶可以俯瞰整个东京市区的景色。它很好地代表了东京的现代一面。</span><br><span class="line">- **明治神宫**：位于原宿附近的明治神宫是一个供奉明治天皇和昭宪皇后的神社。这里环境宁静，是体验日本传统宗教仪式的好去处。</span><br><span class="line">- **上野公园及周边**：上野公园是东京著名的赏樱地点，周围有许多博物馆，如东京国立博物馆，适合喜欢艺术和历史的游客。</span><br><span class="line"></span><br><span class="line">**特色美食**</span><br><span class="line">- **寿司**：在筑地市场或银座区尝试新鲜的寿司是许多游客的首选。虽然筑地市场已经迁移到了丰洲，但是该区域依然有许多优质的寿司店。</span><br><span class="line">- **拉面**：东京有很多不同风味的拉面店，比如一兰拉面、Ichiran等，提供了多种选择来满足不同的口味。     </span><br><span class="line">- **居酒屋**：体验日本的居酒屋文化，品尝各种小菜和日本酒，是一种非常地道的享受方式。</span><br><span class="line"></span><br><span class="line">**交通方式**</span><br><span class="line">- **地铁/电车**：东京的公共交通系统发达且准时，是游览城市最方便的方式。购买一日券或多日券可以节省费用 。</span><br><span class="line">- **出租车**：对于不熟悉路线或者携带大量行李的游客来说，乘坐出租车也是一种不错的选择，不过价格相对较高。</span><br><span class="line"></span><br><span class="line">**购物场所**</span><br><span class="line">- **涩谷<span class="number">109</span>**：这里是年轻人时尚潮流的中心，可以找到各种流行的服装品牌。</span><br><span class="line">- **银座**：银座区以其高端的购物环境著称，无论是国际奢侈品牌还是日本本土品牌，在这里都能找到。        </span><br><span class="line">- **秋叶原**：对于动漫迷和技术爱好者来说，秋叶原是必去之地，这里有众多的电器店和动漫周边产品店。      </span><br><span class="line"></span><br><span class="line">**现代与传统结合的地方**</span><br><span class="line">- **表参道**：这条街道不仅有高级时装店和设计感强烈的建筑，还保留了一些传统的日式茶馆和咖啡厅，体现了东京独特的城市风貌。</span><br><span class="line">- **六本木新城**：集美术馆、电影院、餐厅于一体的综合设施，周围还有美丽的绿地和公园，展现了东京现代都市生活的另一面。</span><br><span class="line"></span><br><span class="line">希望这些建议能帮助您规划一个轻松愉快的东京之旅！如果您有任何特定的需求或问题，欢迎随时向我咨询。      </span><br><span class="line">======</span><br><span class="line">Task tokyo_trip_plan_with_search<span class="number">.0</span> completed successfully.</span><br><span class="line">Worker node 9ba18c5a-012a-<span class="number">4200</span>-994d-fee79899706d (负责制定详细的东京<span class="number">3</span>日旅游行程规划) get task tokyo_trip_plan_with_search<span class="number">.1</span>: Subtask <span class="number">2</span> (9ba18c5a-012a-<span class="number">4200</span>-994d-fee79899706d): 根据收集到的信息，制定详细的 东京<span class="number">3</span>日旅游行程规划</span><br><span class="line">======</span><br><span class="line">Reply <span class="keyword">from</span> Worker node 9ba18c5a-012a-<span class="number">4200</span>-994d-fee79899706d (负责制定详细的东京<span class="number">3</span>日旅游行程规划):      </span><br><span class="line"></span><br><span class="line">根据您的需求，以下是为您精心规划的东京三日游行程，旨在平衡现代与传统文化体验，并确保您有足够的时间享受购物和美食。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 第一天：传统文化与美食探索</span></span><br><span class="line">- **上午**：</span><br><span class="line">  - **浅草寺**：从雷门进入，参观这座历史悠久的寺庙，体验日本的传统氛围。（建议停留<span class="number">1</span>-<span class="number">2</span>小时）</span><br><span class="line">  - **仲见世商店街**：在浅草寺附近逛逛，品尝一些传统的日本小吃，如章鱼烧、抹茶甜点等。（建议停留<span class="number">1</span>小时 ）</span><br><span class="line">- **中午**：</span><br><span class="line">  - 在浅草地区尝试一家寿司店，享用新鲜美味的寿司。（建议停留<span class="number">1</span>小时）</span><br><span class="line">- **下午**：</span><br><span class="line">  - **上野公园**：参观上野公园，欣赏美丽的自然风光，如果时间允许，可以参观东京国立博物馆，了解日本的历史和文化。（建议停留<span class="number">2</span>-<span class="number">3</span>小时）</span><br><span class="line">- **晚上**：</span><br><span class="line">  - **秋叶原**：前往秋叶原，体验日本的动漫文化和电子产品市场。这里有许多商店出售动漫周边产品和最新的电子产品。（建议停留<span class="number">2</span>小时）</span><br><span class="line">  - **居酒屋**：在秋叶原或上野附近找一家居酒屋，品尝日本的小菜和清酒，感受日本的夜生活。（建议停留<span class="number">1</span>-<span class="number">2</span> 小时）</span><br><span class="line"></span><br><span class="line"><span class="comment">### 第二天：现代都市体验</span></span><br><span class="line">- **上午**：</span><br><span class="line">  - **东京晴空塔**：前往东京晴空塔，乘坐电梯到达观景台，俯瞰东京市区的美景。（建议停留<span class="number">1</span>-<span class="number">2</span>小时）       </span><br><span class="line">- **中午**：</span><br><span class="line">  - 在晴空塔附近的餐厅享用午餐，尝试一些现代日本料理。（建议停留<span class="number">1</span>小时）</span><br><span class="line">- **下午**：</span><br><span class="line">  - **表参道**：前往表参道，参观时尚的商店和设计感强烈的建筑，体验东京的现代都市风貌。（建议停留<span class="number">2</span>-<span class="number">3</span>小 时）</span><br><span class="line">- **晚上**：</span><br><span class="line">  - **六本木新城**：前往六本木新城，参观美术馆、电影院和餐厅，享受东京的夜生活。（建议停留<span class="number">2</span>-<span class="number">3</span>小时）   </span><br><span class="line"></span><br><span class="line"><span class="comment">### 第三天：购物与休闲</span></span><br><span class="line">- **上午**：</span><br><span class="line">  - **涩谷<span class="number">109</span>**：前往涩谷<span class="number">109</span>，这里是年轻人的时尚潮流中心，可以找到各种流行的服装品牌。（建议停留<span class="number">1</span>-<span class="number">2</span>小 时）</span><br><span class="line">- **中午**：</span><br><span class="line">  - 在涩谷的餐馆享用午餐，尝试一些当地的特色美食。（建议停留<span class="number">1</span>小时）</span><br><span class="line">- **下午**：</span><br><span class="line">  - **明治神宫**：前往明治神宫，参观这个宁静的神社，体验日本的传统宗教仪式。（建议停留<span class="number">1</span>-<span class="number">2</span>小时）       </span><br><span class="line">- **晚上**：</span><br><span class="line">  - **银座**：前往银座，这里是高端购物的天堂，可以找到国际奢侈品牌和日本本土品牌。（建议停留<span class="number">2</span>-<span class="number">3</span>小时） </span><br><span class="line">  - **银座的高级餐厅**：在银座的高级餐厅享用晚餐，结束美好的东京之旅。（建议停留<span class="number">1</span>-<span class="number">2</span>小时）</span><br><span class="line"></span><br><span class="line"><span class="comment">### 交通指南</span></span><br><span class="line">- **地铁/电车**：东京的公共交通系统发达且准时，建议购买一日券或多日券以节省费用。使用Google Maps或Yahoo! Japan Map可以方便地查询路线和换乘信息。</span><br><span class="line">- **出租车**：对于不熟悉路线或者携带大量行李的游客，可以选择乘坐出租车，但价格相对较高。</span><br><span class="line"></span><br><span class="line">希望这份行程能帮助您度过一个愉快的东京之旅！如果有任何问题，请随时联系我。</span><br><span class="line">======</span><br><span class="line">Task tokyo_trip_plan_with_search<span class="number">.1</span> completed successfully.</span><br><span class="line">Worker node 1f0da1fb-fc98-4c70-9dc2-535058fa7990 (负责评估行程质量并提出优化建议) get task tokyo_trip_plan_with_search<span class="number">.2</span>: Subtask <span class="number">3</span> (1f0da1fb-fc98-4c70-9dc2-535058fa7990): 评估行程质量并提出优化建议      </span><br><span class="line">======</span><br><span class="line">Reply <span class="keyword">from</span> Worker node 1f0da1fb-fc98-4c70-9dc2-535058fa7990 (负责评估行程质量并提出优化建议):</span><br><span class="line"></span><br><span class="line">根据提供的行程规划，以下是对东京三日游行程的评估和优化建议：</span><br><span class="line"></span><br><span class="line"><span class="comment">### 评估</span></span><br><span class="line">- **时间安排是否合理**：整体时间安排较为合理，每个活动的时间分配适当，没有过于紧凑的情况。每天的活动量适中，游客可以在充分体验每个景点的同时，也有时间休息。</span><br><span class="line">- **交通是否便利**：东京的公共交通系统非常发达，行程中提到的地铁和电车是最便捷的交通方式。建议购买一日券或多日券，这样可以节省交通费用并减少购票时间。</span><br><span class="line">- **费用预算是否适中**：中等预算下，行程中的景点和活动选择较为合适。特别是免费或低成本的景点（如浅草寺、上野公园、明治神宫等），以及一些经济实惠的餐饮选择（如居酒屋、寿司店等），都符合中等预算的要求。    </span><br><span class="line">- **文化体验是否丰富**：行程涵盖了丰富的文化体验，既有传统的寺庙和神社（如浅草寺、明治神宫），也有现代的城市景观（如东京晴空塔、表参道）。此外，还包括了购物和美食体验，能够满足不同兴趣的游客。</span><br><span class="line">- **是否适合目标游客群体**：行程非常适合首次访问东京的游客，尤其是对购物和美食感兴趣的游客。行程中的景点和活动既展示了东京的传统文化，又体现了其现代都市风貌。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 优化建议</span></span><br><span class="line"><span class="number">1.</span> **增加休息时间**：虽然整体时间安排合理，但在每个活动之间可以适当增加一些自由时间，让游客可以根据自 己的节奏调整行程。</span><br><span class="line"><span class="number">2.</span> **提供具体交通信息**：建议在行程中提供具体的交通线路和换乘信息，特别是在转乘频繁的情况下，可以帮助 游客更高效地到达目的地。</span><br><span class="line"><span class="number">3.</span> **增加夜间活动选项**：虽然行程中已经包含了一些夜间活动（如居酒屋、六本木新城），但可以考虑增加更多 夜间活动选项，如夜游东京湾、观看歌舞伎表演等，以丰富夜生活体验。</span><br><span class="line"><span class="number">4.</span> **推荐经济实惠的住宿**：对于中等预算的游客，可以推荐一些经济实惠且位置便利的住宿选择，如胶囊旅馆、 商务酒店等。</span><br><span class="line"><span class="number">5.</span> **提供备用方案**：考虑到天气等因素可能影响某些户外活动，建议为每个主要活动提供一个备用方案，以确保 行程顺利进行。</span><br><span class="line"></span><br><span class="line">希望这些建议能帮助您进一步完善东京三日游的行程规划，确保游客有一个愉快的旅行体验。</span><br><span class="line">======</span><br><span class="line"> Task tokyo_trip_plan_with_search<span class="number">.2</span> completed successfully.</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line"> 任务处理完成 </span><br><span class="line">================================================================================</span><br><span class="line">任务ID: tokyo_trip_plan_with_search</span><br><span class="line"></span><br><span class="line">🎉Workforce 演示成功！</span><br><span class="line"></span><br><span class="line">提示：如果搜索遇到速率限制，系统会自动使用内置知识库</span><br></pre></td></tr></table></figure>

<p>我们可以看到，目前搜索工具正常调用并且收集网页端最新数据信息，以确保当前旅游规划是最符合当前时间的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/17/Agent-camel%E6%A1%86%E6%9E%B6%E7%BB%83%E4%B9%A0%EF%BC%883%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/17/Agent-camel%E6%A1%86%E6%9E%B6%E7%BB%83%E4%B9%A0%EF%BC%883%EF%BC%89/" class="post-title-link" itemprop="url">Agent-camel框架练习（3）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-17 18:47:58" itemprop="dateCreated datePublished" datetime="2025-07-17T18:47:58+08:00">2025-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-20 23:33:57" itemprop="dateModified" datetime="2025-07-20T23:33:57+08:00">2025-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E4%B8%BB%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">自主练习</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<h2 id="Task1"><a href="#Task1" class="headerlink" title="Task1"></a>Task1</h2><h3 id="给Workforce的简单实践部分新增一个agent，重新编排功能。"><a href="#给Workforce的简单实践部分新增一个agent，重新编排功能。" class="headerlink" title="给Workforce的简单实践部分新增一个agent，重新编排功能。"></a>给Workforce的简单实践部分新增一个agent，重新编排功能。</h3><p>我根据自己的兴趣爱好重新构建了一下Workforce案例（具体信息在同章节的学习记录中），该部分主要展示对agent的重新编排，以及最终的展现效果：<br>让我们先简单回顾下学习笔记中的主要agent角色组成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">东京旅游专家 (Researcher Agent)：</span><br><span class="line">角色定位：一位经验丰富的东京旅游专家。</span><br><span class="line">职责：利用其丰富的内置知识提供东京的景点、美食、交通和购物信息，不再进行网络搜索，以确保信息来源可控且避免速率限制。</span><br><span class="line"></span><br><span class="line">高级旅游规划师 (Planner Agent)：</span><br><span class="line">角色定位：专业的行程规划师。</span><br><span class="line">职责：根据“东京旅游专家”提供的信息和游客的详细需求，精心制定一份合理、详细且吸引人的3日东京旅游行程，注重时间、交通和体验平衡。</span><br><span class="line"></span><br><span class="line">资深旅行评论员 (Reviewer Agent)：</span><br><span class="line">角色定位：眼光独到的旅行评论员。</span><br><span class="line">职责：严格评估规划师制定的行程，从实用性、趣味性、性价比、潜在问题和文化体验等多个维度给出建设性反馈和优化建议。</span><br></pre></td></tr></table></figure>
<p>我主要在Workforce中添加了两个单独的Agent，分别为AI用户agent以及最终整合agent：</p>
<h4 id="1-AI用户agent"><a href="#1-AI用户agent" class="headerlink" title="1.AI用户agent"></a>1.AI用户agent</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">新增AI用户Agent </span><br><span class="line">ai_user_agent = ChatAgent(</span><br><span class="line">    system_message=&quot;AI智能用户代理，代表真实用户参与旅游规划过程&quot;</span><br><span class="line">)</span><br><span class="line">用户画像：</span><br><span class="line">-26岁软件工程师，首次访问东京</span><br><span class="line">-对动漫文化和科技产品很感兴趣</span><br><span class="line">-喜欢拍照分享到社交媒体</span><br><span class="line">-不喜欢太早起床，偏好10点后开始活动</span><br><span class="line">-预算中等，注重性价比和独特体验</span><br><span class="line"></span><br><span class="line">个性化需求示例：</span><br><span class="line">&quot;我希望能找到一些小众但很有特色的动漫主题咖啡店&quot;</span><br><span class="line">&quot;我不太喜欢太早起床，希望每天的行程从上午10点开始&quot;</span><br><span class="line">&quot;希望能安排一些适合拍照的网红打卡点，特别是现代建筑&quot;</span><br><span class="line">&quot;我想买一些日本独有的科技产品，但不要太贵的&quot;</span><br></pre></td></tr></table></figure>
<p>实现代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1.</span> AI用户Agent - 表达个性化需求</span><br><span class="line">ai_user_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;AI智能用户代理&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是一个智能的AI用户代理，代表真实用户参与旅游规划过程。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        用户画像（你需要扮演的角色）：</span></span><br><span class="line"><span class="string">        - 26岁的软件工程师，首次访问东京</span></span><br><span class="line"><span class="string">        - 对日本动漫文化和科技产品很感兴趣</span></span><br><span class="line"><span class="string">        - 喜欢拍照分享到社交媒体（Instagram风格）</span></span><br><span class="line"><span class="string">        - 不喜欢太早起床，偏好10点后开始活动</span></span><br><span class="line"><span class="string">        - 预算中等，注重性价比和独特体验</span></span><br><span class="line"><span class="string">        - 对传统文化有兴趣但不想走太多路</span></span><br><span class="line"><span class="string">        - 希望体验地道的日本生活方式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        你的任务：</span></span><br><span class="line"><span class="string">        1. 主动表达具体的个性化需求和偏好</span></span><br><span class="line"><span class="string">        2. 提出实际的限制条件和特殊要求</span></span><br><span class="line"><span class="string">        3. 对规划过程中的建议给出用户反馈</span></span><br><span class="line"><span class="string">        4. 确保最终行程符合你的个性化需求</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        个性化需求示例（你应该表达的内容）：</span></span><br><span class="line"><span class="string">        - &quot;我希望能找到一些小众但很有特色的动漫主题咖啡店&quot;</span></span><br><span class="line"><span class="string">        - &quot;我不太喜欢太早起床，希望每天的行程从上午10点开始&quot;</span></span><br><span class="line"><span class="string">        - &quot;我想体验一次传统的日式早餐，但希望是在酒店附近&quot;</span></span><br><span class="line"><span class="string">        - &quot;我对寺庙很感兴趣，但希望选择不需要爬太多台阶的&quot;</span></span><br><span class="line"><span class="string">        - &quot;希望能安排一些适合拍照的网红打卡点，特别是现代建筑&quot;</span></span><br><span class="line"><span class="string">        - &quot;我想买一些日本独有的科技产品，但不要太贵的&quot;</span></span><br><span class="line"><span class="string">        - &quot;希望能体验一次日本的温泉或者传统澡堂&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        表达方式：</span></span><br><span class="line"><span class="string">        - 用第一人称表达需求：&quot;我希望...&quot;、&quot;我不喜欢...&quot;</span></span><br><span class="line"><span class="string">        - 提供具体的偏好和限制条件</span></span><br><span class="line"><span class="string">        - 表达对某些活动的兴趣程度</span></span><br><span class="line"><span class="string">        - 提出实际的担忧和问题</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        输出格式：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ## 我的个性化旅游需求</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        ### 基本偏好</span></span><br><span class="line"><span class="string">        - [具体偏好1]</span></span><br><span class="line"><span class="string">        - [具体偏好2]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        ### 时间安排偏好</span></span><br><span class="line"><span class="string">        - [时间相关需求]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        ### 特殊兴趣</span></span><br><span class="line"><span class="string">        - [兴趣点1]</span></span><br><span class="line"><span class="string">        - [兴趣点2]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        ### 限制条件</span></span><br><span class="line"><span class="string">        - [限制1]</span></span><br><span class="line"><span class="string">        - [限制2]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        ### 期望体验</span></span><br><span class="line"><span class="string">        - [期望体验1]</span></span><br><span class="line"><span class="string">        - [期望体验2]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-最终整合agent"><a href="#2-最终整合agent" class="headerlink" title="2.最终整合agent"></a>2.最终整合agent</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">新增最终整合Agent </span><br><span class="line">final_integrator_agent = ChatAgent(</span><br><span class="line">    system_message=&quot;最终行程整合专员，整合所有信息生成标准化版本&quot;</span><br><span class="line">)</span><br><span class="line">核心功能：</span><br><span class="line">-采用统一的标准输出格式</span><br><span class="line">-整合所有专员的建议和信息</span><br><span class="line">-应用评审员的改进建议</span><br><span class="line">-提供完整的预算和实用信息</span><br></pre></td></tr></table></figure>
<p>实现代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">5.</span> 个性化最终整合专员</span><br><span class="line">personalized_integrator_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;个性化最终整合专员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是个性化最终整合专员。你的职责是整合所有信息，生成高度个性化的最终旅游行程。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        核心职责：</span></span><br><span class="line"><span class="string">        1. 整合AI用户的个性化需求</span></span><br><span class="line"><span class="string">        2. 采纳个性化规划师的行程安排</span></span><br><span class="line"><span class="string">        3. 应用个性化评审员的改进建议</span></span><br><span class="line"><span class="string">        4. 生成符合用户个性的标准化最终行程</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        个性化最终输出格式：</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">        # 个性化东京3日旅游行程 - 最终版本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ## 用户画像与需求</span></span><br><span class="line"><span class="string">        - 用户类型：[用户特征]</span></span><br><span class="line"><span class="string">        - 核心需求：[主要个性化需求]</span></span><br><span class="line"><span class="string">        - 特殊偏好：[用户偏好]</span></span><br><span class="line"><span class="string">        - 限制条件：[用户限制]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ## 个性化行程概览</span></span><br><span class="line"><span class="string">        - 设计理念：[个性化设计思路]</span></span><br><span class="line"><span class="string">        - 主要特色：[行程个性化亮点]</span></span><br><span class="line"><span class="string">        - 预算水平：[符合用户预算]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ## 详细个性化行程</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 第一天：[个性化主题]</span></span><br><span class="line"><span class="string">        **时间安排** (遵循用户10点后开始的偏好)</span></span><br><span class="line"><span class="string">        - 10:00-12:00 | [个性化景点选择]</span></span><br><span class="line"><span class="string">          - 选择理由：[为什么符合用户需求]</span></span><br><span class="line"><span class="string">          - 个性化体验：[独特体验点]</span></span><br><span class="line"><span class="string">          - 拍照建议：[满足用户拍照需求]</span></span><br><span class="line"><span class="string">          - 交通：[便利交通，减少步行]</span></span><br><span class="line"><span class="string">          - 预算：[符合用户预算]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        - 12:00-13:30 | 个性化午餐</span></span><br><span class="line"><span class="string">          - 推荐：[符合用户偏好的餐厅]</span></span><br><span class="line"><span class="string">          - 特色：[为什么推荐]</span></span><br><span class="line"><span class="string">          - 用户匹配：[如何满足用户需求]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        [继续其他时间段...]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ## 个性化实用信息</span></span><br><span class="line"><span class="string">        ### 用户专属建议</span></span><br><span class="line"><span class="string">        - 动漫文化体验：[具体建议]</span></span><br><span class="line"><span class="string">        - 科技产品购物：[购物指南]</span></span><br><span class="line"><span class="string">        - 拍照打卡攻略：[拍照建议]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 个性化预算参考</span></span><br><span class="line"><span class="string">        - 符合用户预算的费用分配</span></span><br><span class="line"><span class="string">        - 性价比最高的选择</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 用户专属贴心提醒</span></span><br><span class="line"><span class="string">        - [针对用户特点的提醒]</span></span><br><span class="line"><span class="string">        - [个性化注意事项]</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        整合要求：</span></span><br><span class="line"><span class="string">        - 必须体现高度的个性化</span></span><br><span class="line"><span class="string">        - 每个安排都要说明如何满足用户需求</span></span><br><span class="line"><span class="string">        - 确保最终行程的独特性和实用性&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="其它更改优化项："><a href="#其它更改优化项：" class="headerlink" title="其它更改优化项："></a>其它更改优化项：</h4><p>运行后我们发现 研究员 Agent部分直接生成了详细的时间日程表。<br>这与智能规划师Agent的工作内容相互重合，存在生成重复内容的可能性。<br>所以我们重新改进两部分Agent的提示模板，确保功能生成不重合：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. 个性化信息收集专员 - 根据AI用户需求收集信息</span></span><br><span class="line">personalized_info_collector_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;个性化信息收集专员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是个性化信息收集专员。你的职责是根据AI用户的具体需求，收集相关的旅游信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        核心职责：</span></span><br><span class="line"><span class="string">        1. 仔细分析AI用户提出的个性化需求</span></span><br><span class="line"><span class="string">        2. 针对用户的特殊兴趣收集相关信息</span></span><br><span class="line"><span class="string">        3. 搜索符合用户偏好的景点、餐厅、活动</span></span><br><span class="line"><span class="string">        4. 收集用户关心的实用信息（价格、时间、交通）</span></span><br><span class="line"><span class="string">        5. 特别关注用户的限制条件和特殊要求</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        收集重点（根据用户需求调整）：</span></span><br><span class="line"><span class="string">        - 动漫主题咖啡店和相关景点</span></span><br><span class="line"><span class="string">        - 适合拍照的现代建筑和网红打卡点</span></span><br><span class="line"><span class="string">        - 不需要早起的活动安排</span></span><br><span class="line"><span class="string">        - 交通便利、步行较少的景点</span></span><br><span class="line"><span class="string">        - 科技产品购物场所和价格信息</span></span><br><span class="line"><span class="string">        - 温泉或传统澡堂体验</span></span><br><span class="line"><span class="string">        - 地道的日式早餐推荐</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        输出格式：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        ## 个性化信息收集报告</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 针对用户兴趣的特色推荐</span></span><br><span class="line"><span class="string">        **动漫文化相关**</span></span><br><span class="line"><span class="string">        - [具体推荐1]</span></span><br><span class="line"><span class="string">        - [具体推荐2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **科技产品购物**</span></span><br><span class="line"><span class="string">        - [购物地点和价格信息]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **拍照打卡点**</span></span><br><span class="line"><span class="string">        - [网红景点推荐]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 符合用户限制条件的选择</span></span><br><span class="line"><span class="string">        **10点后开始的活动**</span></span><br><span class="line"><span class="string">        - [适合的景点和开放时间]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **步行较少的景点**</span></span><br><span class="line"><span class="string">        - [交通便利的推荐]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 实用信息</span></span><br><span class="line"><span class="string">        - 价格区间：[具体价格]</span></span><br><span class="line"><span class="string">        - 交通方式：[详细交通]</span></span><br><span class="line"><span class="string">        - 营业时间：[开放时间]</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **重要要求：</span></span><br><span class="line"><span class="string">        - 必须基于AI用户的具体需求收集信息</span></span><br><span class="line"><span class="string">        - 不要制定行程，只提供信息</span></span><br><span class="line"><span class="string">        - 重点关注用户的个性化偏好&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model,</span><br><span class="line">    tools=[safe_search.safe_search_duckduckgo]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 个性化行程规划师 - 整合用户需求制定行程</span></span><br><span class="line">personalized_planner_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;个性化行程规划师&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是个性化行程规划师。你的职责是根据AI用户的个性化需求和收集到的信息，制定高度个性化的旅游行程。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        核心职责：</span></span><br><span class="line"><span class="string">        1. 深度理解AI用户的个性化需求和偏好</span></span><br><span class="line"><span class="string">        2. 将用户需求与收集到的信息完美结合</span></span><br><span class="line"><span class="string">        3. 制定符合用户生活习惯的行程安排</span></span><br><span class="line"><span class="string">        4. 优先满足用户的特殊兴趣和要求</span></span><br><span class="line"><span class="string">        5. 考虑用户的限制条件和实际情况</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        个性化规划原则：</span></span><br><span class="line"><span class="string">        - 严格按照用户的时间偏好安排（10点后开始）</span></span><br><span class="line"><span class="string">        - 优先安排用户感兴趣的活动（动漫、科技、拍照）</span></span><br><span class="line"><span class="string">        - 考虑用户的体力限制（减少步行，选择交通便利地点）</span></span><br><span class="line"><span class="string">        - 平衡用户兴趣与传统文化体验</span></span><br><span class="line"><span class="string">        - 安排符合用户预算的活动</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        输出格式：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ## 个性化东京3日旅游行程</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 行程设计理念</span></span><br><span class="line"><span class="string">        - 基于用户需求：[用户主要需求]</span></span><br><span class="line"><span class="string">        - 个性化特色：[行程特色]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ### 第一天：[个性化主题]</span></span><br><span class="line"><span class="string">        **上午 (10:00-12:00)** - 考虑用户不喜欢早起</span></span><br><span class="line"><span class="string">        - 景点：[符合用户兴趣的景点]</span></span><br><span class="line"><span class="string">        - 个性化理由：[为什么选择这个景点]</span></span><br><span class="line"><span class="string">        - 交通：[便利的交通方式]</span></span><br><span class="line"><span class="string">        - 拍照建议：[适合拍照的角度/时间]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **中午 (12:00-13:30)**</span></span><br><span class="line"><span class="string">        - 用餐：[符合用户偏好的餐厅]</span></span><br><span class="line"><span class="string">        - 特色：[为什么推荐]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **下午 (13:30-17:00)**</span></span><br><span class="line"><span class="string">        - 活动：[个性化活动安排]</span></span><br><span class="line"><span class="string">        - 用户兴趣匹配：[如何满足用户需求]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **晚上 (17:00-21:00)**</span></span><br><span class="line"><span class="string">        - 安排：[晚间个性化活动]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        **个性化要求：</span></span><br><span class="line"><span class="string">        - 每个安排都要说明如何满足用户的个性化需求</span></span><br><span class="line"><span class="string">        - 严格遵守用户的限制条件</span></span><br><span class="line"><span class="string">        - 优先考虑用户的特殊兴趣&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>并且重新编排了各个工作节点的调用和协调工作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 创建个性化Workforce</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">coordinator_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;个性化工作组协调员&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;&quot;&quot;你是个性化工作组协调员，负责协调五个专业角色的工作：</span></span><br><span class="line"><span class="string">        1. AI用户代理 - 表达个性化需求和偏好</span></span><br><span class="line"><span class="string">        2. 个性化信息收集专员 - 根据用户需求收集相关信息</span></span><br><span class="line"><span class="string">        3. 个性化行程规划师 - 制定个性化行程安排</span></span><br><span class="line"><span class="string">        4. 个性化质量评审员 - 评估个性化程度和质量</span></span><br><span class="line"><span class="string">        5. 个性化最终整合专员 - 生成个性化最终版本</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        确保整个流程以用户的个性化需求为核心，每个环节都要体现个性化特色。&quot;&quot;&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> TaskPlanningToolkit</span><br><span class="line">task_agent = ChatAgent(</span><br><span class="line">    system_message=BaseMessage.make_assistant_message(</span><br><span class="line">        role_name=<span class="string">&quot;个性化任务规划专家&quot;</span>,</span><br><span class="line">        content=<span class="string">&quot;你负责将个性化旅游规划任务分解为五个明确的子任务，确保用户需求在每个环节都得到充分体现。&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    model=model,</span><br><span class="line">    tools=TaskPlanningToolkit().get_tools()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建个性化 Workforce</span></span><br><span class="line">travel_workforce = Workforce(</span><br><span class="line">    description=<span class="string">&quot;东京个性化旅游规划工作组（AI用户交互优化版）&quot;</span>,</span><br><span class="line">    coordinator_agent=coordinator_agent,</span><br><span class="line">    task_agent=task_agent</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照个性化工作流程顺序添加节点</span></span><br><span class="line">travel_workforce.add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;AI用户代理：表达个性化旅游需求、偏好和限制条件&quot;</span>,</span><br><span class="line">    worker=ai_user_agent</span><br><span class="line">).add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;个性化信息收集专员：根据AI用户的具体需求收集相关旅游信息&quot;</span>,</span><br><span class="line">    worker=personalized_info_collector_agent</span><br><span class="line">).add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;个性化行程规划师：整合用户需求制定高度个性化的旅游行程&quot;</span>,</span><br><span class="line">    worker=personalized_planner_agent</span><br><span class="line">).add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;个性化质量评审员：评估行程的个性化程度和用户需求满足度&quot;</span>,</span><br><span class="line">    worker=personalized_reviewer_agent</span><br><span class="line">).add_single_agent_worker(</span><br><span class="line">    <span class="string">&quot;个性化最终整合专员：生成符合用户个性的标准化最终行程&quot;</span>,</span><br><span class="line">    worker=personalized_integrator_agent</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;AI用户交互优化版 Workforce 实例已创建&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"><span class="comment"># 创建和处理个性化任务</span></span><br><span class="line"><span class="comment">#--------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ai_user_personalized_task = Task(</span><br><span class="line">    content=<span class="string">&quot;&quot;&quot;请为一位首次访问东京的用户规划一份高度个性化的3日旅游行程。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    个性化工作流程要求：</span></span><br><span class="line"><span class="string">    1. AI用户代理：表达具体的个性化需求和偏好</span></span><br><span class="line"><span class="string">    2. 个性化信息收集专员：根据用户需求收集相关信息</span></span><br><span class="line"><span class="string">    3. 个性化行程规划师：制定符合用户个性的行程安排</span></span><br><span class="line"><span class="string">    4. 个性化质量评审员：评估个性化程度并提出改进建议</span></span><br><span class="line"><span class="string">    5. 个性化最终整合专员：生成高度个性化的最终版本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    确保整个过程以用户的个性化需求为核心，每个环节都要体现个性化特色。&quot;&quot;&quot;</span>,</span><br><span class="line">    </span><br><span class="line">    additional_info=&#123;</span><br><span class="line">        <span class="string">&quot;用户基础信息&quot;</span>: <span class="string">&quot;26岁软件工程师，首次访问东京&quot;</span>,</span><br><span class="line">        <span class="string">&quot;核心特征&quot;</span>: <span class="string">&quot;对动漫文化和科技产品感兴趣，喜欢拍照分享&quot;</span>,</span><br><span class="line">        <span class="string">&quot;时间偏好&quot;</span>: <span class="string">&quot;不喜欢早起，偏好10点后开始活动&quot;</span>,</span><br><span class="line">        <span class="string">&quot;预算水平&quot;</span>: <span class="string">&quot;中等预算，注重性价比和独特体验&quot;</span>,</span><br><span class="line">        <span class="string">&quot;当前日期&quot;</span>: <span class="string">&quot;2025年7月17日&quot;</span>,</span><br><span class="line">        <span class="string">&quot;旅行天数&quot;</span>: <span class="string">&quot;3天&quot;</span>,</span><br><span class="line">        <span class="string">&quot;特殊要求&quot;</span>: <span class="string">&quot;高度个性化，AI用户深度参与&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;ai_user_personalized_tokyo_trip&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其它部分基本没有很大改动，我们直接看下运行效果吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/CAMEL_Workforce_with_AI_User_optimized.py</span><br><span class="line">🔧 正在创建AI用户交互优化版 Workforce...</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_linkup&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;searchResults&#x27;, &#x27;sourcedAnswer&#x27;, &#x27;structured&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;OneDay&#x27;, &#x27;OneWeek&#x27;, &#x27;OneMonth&#x27;, &#x27;OneYear&#x27;, &#x27;NoLimit&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;anyOf&#x27;: [&#123;&#x27;enum&#x27;: [&#x27;finance&#x27;, &#x27;law&#x27;, &#x27;medical&#x27;, &#x27;internet&#x27;, &#x27;tax&#x27;, &#x27;news_province&#x27;, &#x27;news_center&#x27;], &#x27;type&#x27;: &#x27;string&#x27;&#125;, &#123;&#x27;type&#x27;: &#x27;null&#x27;&#125;], &#x27;type&#x27;: [&#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:512: UserWarning: Function description is missing for </span><br><span class="line">                          safe_search_duckduckgo. This may </span><br><span class="line">                          affect the quality of tool calling.</span><br><span class="line">  warnings.warn(f&quot;&quot;&quot;Function description is missing for</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;safe_search_duckduckgo&#x27;. The parameter definition is &#123;&#x27;type&#x27;: &#x27;string&#x27;&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;safe_search_duckduckgo&#x27;. The parameter definition is &#123;&#x27;type&#x27;: [&#x27;integer&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">✅ 所有个性化工作节点已定义</span><br><span class="line">✅ AI用户交互优化版 Workforce 实例已创建</span><br><span class="line"></span><br><span class="line">🚀 开始处理AI用户个性化任务...</span><br><span class="line"></span><br><span class="line">📋 个性化工作流程：</span><br><span class="line">1️⃣ AI用户代理 - 表达个性化需求</span><br><span class="line">2️⃣ 个性化信息收集 - 针对性收集信息</span><br><span class="line">3️⃣ 个性化行程规划 - 制定个性化行程</span><br><span class="line">4️⃣ 个性化质量评审 - 评估个性化程度</span><br><span class="line">5️⃣ 个性化最终整合 - 生成个性化最终版本</span><br><span class="line">Worker node 1dbec809-1ab0-4406-accc-ed6c993d2251 (AI用户代理：表达个性化旅游需求、偏好和限制条件) get task ai_user_personalized_tokyo_trip.0: Subtask 1 (1dbec809-1ab0-4406-accc-ed6c993d2251): 表达具体个性化需求，包括对动漫文化、科技产品的兴趣， 以及拍照分享的习惯；同时说明时间偏好（10点后开始 活动）、预算水平（中等预算，注重性价比和独特体验 ）和其他特殊要求。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node 1dbec809-1ab0-4406-accc-ed6c993d2251 (AI用户代理：表达个性化旅游需求、偏好 和限制条件):</span><br><span class="line"></span><br><span class="line">## 我的个性化旅游需求</span><br><span class="line"></span><br><span class="line">### 基本偏好</span><br><span class="line">- 我对日本动漫文化和科技产品非常感兴趣，希望能参 观一些与这些主题相关的地点。</span><br><span class="line">- 我喜欢拍照，并且会经常在社交媒体上分享照片，所 以希望行程中能包含一些适合拍照的网红打卡点。     </span><br><span class="line"></span><br><span class="line">### 时间安排偏好</span><br><span class="line">- 我不太喜欢太早起床，希望每天的行程从上午10点开 始。</span><br><span class="line"></span><br><span class="line">### 特殊兴趣</span><br><span class="line">- 我希望能找到一些小众但很有特色的动漫主题咖啡店 。</span><br><span class="line">- 我想体验一次传统的日式早餐，但希望是在酒店附近 。</span><br><span class="line">- 我对寺庙很感兴趣，但希望选择不需要爬太多台阶的 。</span><br><span class="line">- 希望能安排一些适合拍照的网红打卡点，特别是现代 建筑。</span><br><span class="line">- 我想买一些日本独有的科技产品，但不要太贵的。   </span><br><span class="line">- 希望能体验一次日本的温泉或者传统澡堂。</span><br><span class="line"></span><br><span class="line">### 限制条件</span><br><span class="line">- 我的预算是中等水平，更注重性价比和独特的体验。 </span><br><span class="line">- 我对传统文化有兴趣，但不想走太多路。</span><br><span class="line">- 我希望体验地道的日本生活方式。</span><br><span class="line"></span><br><span class="line">### 期望体验</span><br><span class="line">- 我希望能深入体验东京的现代与传统文化，尤其是在 动漫和科技方面。</span><br><span class="line">- 我希望通过这次旅行获得一些难忘的回忆和独特的体 验。</span><br><span class="line">======</span><br><span class="line">🎯 Task ai_user_personalized_tokyo_trip.0 completed successfully.</span><br><span class="line">Worker node fa3a5315-0238-4ac3-a568-08d65bc71790 (个性化信息收集专员：根据AI用户的具体需求收集相关旅游信息) get task ai_user_personalized_tokyo_trip.1: Subtask 2 (fa3a5315-0238-4ac3-a568-08d65bc71790): 根据AI用户代理提供的个性化需求，收集相关的 旅游信息，包括但不限于动漫文化地点、科技展览、摄 影友好的景点等。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node fa3a5315-0238-4ac3-a568-08d65bc71790 (个性化信息收集专员：根据AI用户的具体 需求收集相关旅游信息):</span><br><span class="line"></span><br><span class="line">## 个性化信息收集报告</span><br><span class="line"></span><br><span class="line">### 针对用户兴趣的特色推荐</span><br><span class="line">**动漫文化相关**</span><br><span class="line">- **动漫主题咖啡店**：位于秋叶原的『AniCafe』，环境布置充满动漫元素，提供特色饮品和轻食，非常适合 动漫爱好者。</span><br><span class="line">- **参观地点**：『东京动漫中心』，位于池袋，不仅 有最新的动漫资讯，还有丰富的周边商品可以购买。   </span><br><span class="line"></span><br><span class="line">**科技产品购物**</span><br><span class="line">- **购物地点**：位于秋叶原的『Yodobashi Camera』 ，这里可以买到各种电子产品，价格合理，适合中等预 算的游客。</span><br><span class="line"></span><br><span class="line">**拍照打卡点**</span><br><span class="line">- **现代建筑**：『六本木之丘』，这里有许多设计感 极强的现代建筑，是拍照的好地方。</span><br><span class="line"></span><br><span class="line">### 符合用户限制条件的选择</span><br><span class="line">**10点后开始的活动**</span><br><span class="line">- **六本木之丘**：开放时间为10:00至23:00，无需早 起即可享受。</span><br><span class="line"></span><br><span class="line">**步行较少的景点**</span><br><span class="line">- **新宿御苑**：位于市中心，交通便利，可轻松到达 ，园内有许多美丽的景观，适合散步。</span><br><span class="line"></span><br><span class="line">### 实用信息</span><br><span class="line">- 价格区间：动漫主题咖啡店消费约为1000-2000日元，东京动漫中心入场免费，Yodobashi Camera的产品价格 因商品而异。</span><br><span class="line">- 交通方式：秋叶原、池袋、六本木之丘均有地铁站直 达，新宿御苑邻近新宿站，出行十分方便。</span><br><span class="line">- 营业时间：AniCafe营业时间为11:00-22:00，东京动 漫中心为10:00-21:00，Yodobashi Camera为10:00-21:00。</span><br><span class="line">======</span><br><span class="line">🎯 Task ai_user_personalized_tokyo_trip.1 completed successfully.</span><br><span class="line">Worker node de9603b3-574e-4a2b-9259-01afe46df728 (个性化行程规划师：整合用户需求制定高度个性化的旅游行程) get task ai_user_personalized_tokyo_trip.2: Subtask 3 (de9603b3-574e-4a2b-9259-01afe46df728): 整合从个性化信息收集专员处获得的信息，制定符 合用户个性的3日旅游行程，确保行程中的每个活动都能满足用户的特定偏好和时间安排。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node de9603b3-574e-4a2b-9259-01afe46df728 (个性化行程规划师：整合用户需求制定高 度个性化的旅游行程):</span><br><span class="line"></span><br><span class="line">## 个性化东京3日旅游行程</span><br><span class="line"></span><br><span class="line">### 行程设计理念</span><br><span class="line">- 基于用户需求：26岁的软件工程师，首次访问东京， 对动漫文化和科技产品感兴趣，喜欢拍照分享，不喜欢 早起，偏好10点后开始活动，预算中等，注重性价比和 独特体验。</span><br><span class="line">- 个性化特色：结合用户的兴趣和限制条件，安排了动 漫主题咖啡店、科技产品购物、现代建筑拍照打卡点、 步行较少的景点等。</span><br><span class="line"></span><br><span class="line">### 第一天：动漫与现代建筑之旅</span><br><span class="line">**上午 (10:00-12:00)** - 考虑用户不喜欢早起      </span><br><span class="line">- 景点：六本木之丘</span><br><span class="line">- 个性化理由：六本木之丘有许多设计感极强的现代建 筑，非常适合拍照打卡。</span><br><span class="line">- 交通：乘坐地铁从酒店出发，直达六本木站，交通便 利。</span><br><span class="line">- 拍照建议：六本木之丘的摩天轮和户外广场是拍照的 最佳地点，建议在上午光线柔和时拍摄。</span><br><span class="line"></span><br><span class="line">**中午 (12:00-13:30)**</span><br><span class="line">- 用餐：六本木之丘内的『森大厦』</span><br><span class="line">- 特色：提供多样的餐饮选择，可以在高楼上俯瞰东京 全景，体验独特的用餐环境。</span><br><span class="line"></span><br><span class="line">**下午 (13:30-17:00)**</span><br><span class="line">- 活动：参观东京动漫中心</span><br><span class="line">- 用户兴趣匹配：东京动漫中心不仅有最新的动漫资讯 ，还有丰富的周边商品可以购买，非常适合动漫爱好者 。</span><br><span class="line">- 交通：乘坐地铁从六本木站到池袋站，约20分钟。   </span><br><span class="line"></span><br><span class="line">**晚上 (17:00-21:00)**</span><br><span class="line">- 安排：体验秋叶原的动漫主题咖啡店『AniCafe』    </span><br><span class="line">- 个性化理由：AniCafe环境布置充满动漫元素，提供特色饮品和轻食，非常适合拍照分享。</span><br><span class="line"></span><br><span class="line">### 第二天：科技与传统文化体验</span><br><span class="line">**上午 (10:00-12:00)**</span><br><span class="line">- 景点：Yodobashi Camera</span><br><span class="line">- 个性化理由：秋叶原的Yodobashi Camera可以买到各 种电子产品，价格合理，适合中等预算的游客。       </span><br><span class="line">- 交通：继续留在秋叶原，交通便利。</span><br><span class="line">- 拍照建议：秋叶原的街头有很多动漫和游戏元素，适 合拍照。</span><br><span class="line"></span><br><span class="line">**中午 (12:00-13:30)**</span><br><span class="line">- 用餐：秋叶原附近的『秋叶原电波塔』</span><br><span class="line">- 特色：提供日式传统美食，同时可以欣赏到秋叶原的 繁华景象。</span><br><span class="line"></span><br><span class="line">**下午 (13:30-17:00)**</span><br><span class="line">- 活动：参观新宿御苑</span><br><span class="line">- 用户兴趣匹配：新宿御苑位于市中心，交通便利，园 内有许多美丽的景观，适合散步。</span><br><span class="line">- 交通：乘坐地铁从秋叶原站到新宿站，约15分钟。   </span><br><span class="line"></span><br><span class="line">**晚上 (17:00-21:00)**</span><br><span class="line">- 安排：体验日式温泉</span><br><span class="line">- 个性化理由：在新宿区的『大江户温泉物语』体验日 式温泉，放松身心。</span><br><span class="line"></span><br><span class="line">### 第三天：传统文化与现代生活融合</span><br><span class="line">**上午 (10:00-12:00)**</span><br><span class="line">- 景点：浅草寺</span><br><span class="line">- 个性化理由：浅草寺是东京著名的寺庙，但可以选择 不需要爬太多台阶的入口。</span><br><span class="line">- 交通：乘坐地铁从新宿站到浅草站，约30分钟。     </span><br><span class="line">- 拍照建议：雷门和五重塔是拍照的最佳地点，建议在 上午光线柔和时拍摄。</span><br><span class="line"></span><br><span class="line">**中午 (12:00-13:30)**</span><br><span class="line">- 用餐：浅草寺附近的『天妇罗』</span><br><span class="line">- 特色：提供地道的日式天妇罗，体验传统的日本美食 。</span><br><span class="line"></span><br><span class="line">**下午 (13:30-17:00)**</span><br><span class="line">- 活动：参观上野公园</span><br><span class="line">- 用户兴趣匹配：上野公园内有许多博物馆和文化设施 ，适合深入了解日本文化。</span><br><span class="line">- 交通：步行即可到达上野公园。</span><br><span class="line"></span><br><span class="line">**晚上 (17:00-21:00)**</span><br><span class="line">- 安排：体验日式澡堂</span><br><span class="line">- 个性化理由：在上野区的『汤岛温泉』体验传统的日 式澡堂，感受地道的日本生活方式。</span><br><span class="line"></span><br><span class="line">======</span><br><span class="line">🎯 Task ai_user_personalized_tokyo_trip.2 completed successfully.</span><br><span class="line">Worker node 3644bbd1-8ef3-4732-8af8-5989b421cdaf (个性化质量评审员：评估行程的个性化程度和用户需求满足度) get task ai_user_personalized_tokyo_trip.3: Subtask 4 (3644bbd1-8ef3-4732-8af8-5989b421cdaf): 评估个性化行程的个性化程度和用户需求满足度， 提供具体的改进建议，确保行程能够最大化地反映用户 的个性化需求。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node 3644bbd1-8ef3-4732-8af8-5989b421cdaf (个性化质量评审员：评估行程的个性化程 度和用户需求满足度):</span><br><span class="line"></span><br><span class="line">## 个性化行程评审报告</span><br><span class="line"></span><br><span class="line">### 整体个性化评分：[8/10分]</span><br><span class="line"></span><br><span class="line">### 详细评估：</span><br><span class="line">**用户需求满足度** [8/10分]</span><br><span class="line">- 满足的需求：</span><br><span class="line">  - 行程从10点开始</span><br><span class="line">  - 参观动漫主题咖啡店和东京动漫中心</span><br><span class="line">  - 体验日式温泉和传统澡堂</span><br><span class="line">  - 购买科技产品</span><br><span class="line">  - 参观现代建筑拍照打卡点</span><br><span class="line">- 未满足的需求：</span><br><span class="line">  - 体验传统的日式早餐（未安排在酒店附近）       </span><br><span class="line">  - 访问小众但有特色的动漫主题咖啡店（只安排了一 个普通的AniCafe）</span><br><span class="line">  - 选择不需要爬太多台阶的寺庙（浅草寺可能需要爬 一些台阶）</span><br><span class="line"></span><br><span class="line">**时间偏好遵守** [9/10分]</span><br><span class="line">- 优点：</span><br><span class="line">  - 所有活动都从10点开始，符合用户的时间偏好     </span><br><span class="line">- 问题：</span><br><span class="line">  - 个别活动时间安排较为紧凑，可能会有些赶       </span><br><span class="line"></span><br><span class="line">**兴趣匹配度** [8/10分]</span><br><span class="line">- 动漫文化：</span><br><span class="line">  - 匹配程度较高，安排了动漫主题咖啡店和东京动漫 中心</span><br><span class="line">- 科技购物：</span><br><span class="line">  - 匹配程度较高，安排了Yodobashi Camera</span><br><span class="line">- 拍照需求：</span><br><span class="line">  - 匹配程度较高，安排了六本木之丘和浅草寺等拍照 打卡点</span><br><span class="line"></span><br><span class="line">**限制条件考虑** [7/10分]</span><br><span class="line">- 步行限制：</span><br><span class="line">  - 大部分活动交通便利，但浅草寺可能需要步行较多 </span><br><span class="line">- 预算限制：</span><br><span class="line">  - 价格合理，符合中等预算的要求</span><br><span class="line"></span><br><span class="line">### 个性化改进建议：</span><br><span class="line">1. **针对用户需求的具体改进**：</span><br><span class="line">   - 在第一天的早晨安排一次传统的日式早餐，最好在酒店附近。</span><br><span class="line">   - 考虑安排一个小众但有特色的动漫主题咖啡店，而不是常见的AniCafe。</span><br><span class="line">   - 选择一个不需要爬太多台阶的寺庙，如增上寺。  </span><br><span class="line">2. **提高个性化程度的建议**：</span><br><span class="line">   - 增加一些独特的体验，如参加一次动漫角色扮演活动或参观一些独立的科技创业公司。</span><br><span class="line">3. **更好满足用户兴趣的建议**：</span><br><span class="line">   - 在行程中增加一些摄影工作坊或摄影导游，帮助用户更好地拍摄照片。</span><br><span class="line"></span><br><span class="line">### 个性化优化重点：</span><br><span class="line">- **增强体验的多样性和独特性**：通过增加小众和独 特的活动来提升整体体验。</span><br><span class="line">- **优化时间和交通安排**：确保活动之间的交通更加 便捷，减少不必要的赶时间。</span><br><span class="line">======</span><br><span class="line">🎯 Task ai_user_personalized_tokyo_trip.3 completed successfully.</span><br><span class="line">Worker node 4f38663a-1423-4aa2-bf15-9e714d3d1f6a (个性化最终整合专员：生成符合用户个性的标准化最终行程) get task ai_user_personalized_tokyo_trip.4: Subtask 5 (4f38663a-1423-4aa2-bf15-9e714d3d1f6a): 根据个性化质量评审员的反馈，调整并优化行程，生 成最终的高度个性化旅游行程，并确保其格式规范，便 于用户查看和使用。</span><br><span class="line">======</span><br><span class="line">Reply from Worker node 4f38663a-1423-4aa2-bf15-9e714d3d1f6a (个性化最终整合专员：生成符合用户个性 的标准化最终行程):</span><br><span class="line"></span><br><span class="line"># 个性化东京3日旅游行程 - 最终版本</span><br><span class="line"></span><br><span class="line">## 用户画像与需求</span><br><span class="line">- 用户类型：26岁软件工程师，首次访问东京</span><br><span class="line">- 核心需求：对动漫文化和科技产品感兴趣，喜欢拍照 分享</span><br><span class="line">- 特殊偏好：不喜欢早起，偏好10点后开始活动，预算 中等，注重性价比和独特体验</span><br><span class="line">- 限制条件：对传统文化有兴趣，但不想走太多路，希 望体验地道的日本生活方式</span><br><span class="line"></span><br><span class="line">## 个性化行程概览</span><br><span class="line">- 设计理念：基于用户需求，结合用户的兴趣和限制条 件，安排了动漫主题咖啡店、科技产品购物、现代建筑 拍照打卡点、步行较少的景点等。</span><br><span class="line">- 主要特色：深度体验东京的现代与传统文化，特别是 在动漫和科技方面。</span><br><span class="line">- 预算水平：中等预算，注重性价比和独特体验       </span><br><span class="line"></span><br><span class="line">## 详细个性化行程</span><br><span class="line"></span><br><span class="line">### 第一天：动漫与现代建筑之旅</span><br><span class="line">**时间安排** (遵循用户10点后开始的偏好)</span><br><span class="line">- 10:00-12:00 | 六本木之丘</span><br><span class="line">  - 选择理由：六本木之丘有许多设计感极强的现代建 筑，非常适合拍照打卡。</span><br><span class="line">  - 个性化体验：摩天轮和户外广场是拍照的最佳地点 ，建议在上午光线柔和时拍摄。</span><br><span class="line">  - 拍照建议：六本木之丘的摩天轮和户外广场是拍照 的最佳地点，建议在上午光线柔和时拍摄。</span><br><span class="line">  - 交通：乘坐地铁从酒店出发，直达六本木站，交通 便利。</span><br><span class="line">  - 预算：免费进入，拍照无需额外费用。</span><br><span class="line"></span><br><span class="line">- 12:00-13:30 | 个性化午餐</span><br><span class="line">  - 推荐：六本木之丘内的『森大厦』</span><br><span class="line">  - 特色：提供多样的餐饮选择，可以在高楼上俯瞰东 京全景，体验独特的用餐环境。</span><br><span class="line">  - 用户匹配：符合用户喜欢拍照和体验独特环境的需 求。</span><br><span class="line"></span><br><span class="line">- 13:30-17:00 | 东京动漫中心</span><br><span class="line">  - 选择理由：东京动漫中心不仅有最新的动漫资讯， 还有丰富的周边商品可以购买，非常适合动漫爱好者。 </span><br><span class="line">  - 个性化体验：可以购买到最新的动漫周边商品，了 解最新动漫资讯。</span><br><span class="line">  - 交通：乘坐地铁从六本木站到池袋站，约20分钟。 </span><br><span class="line">  - 预算：入场免费，周边商品价格适中。</span><br><span class="line"></span><br><span class="line">- 17:00-21:00 | 小众动漫主题咖啡店</span><br><span class="line">  - 推荐：秋叶原的『Maidreamin』</span><br><span class="line">  - 选择理由：Maidreamin是一家以女仆服务为主题的 咖啡店，环境布置充满动漫元素，提供特色饮品和轻食 ，非常适合拍照分享。</span><br><span class="line">  - 个性化体验：可以体验独特的女仆服务，拍照分享 。</span><br><span class="line">  - 交通：乘坐地铁从池袋站到秋叶原站，约15分钟。 </span><br><span class="line">  - 预算：消费约为1000-2000日元。</span><br><span class="line"></span><br><span class="line">### 第二天：科技与传统文化体验</span><br><span class="line">**时间安排** (遵循用户10点后开始的偏好)</span><br><span class="line">- 10:00-12:00 | Yodobashi Camera</span><br><span class="line">  - 选择理由：秋叶原的Yodobashi Camera可以买到各 种电子产品，价格合理，适合中等预算的游客。       </span><br><span class="line">  - 个性化体验：可以购买到日本独有的科技产品，体 验科技购物的乐趣。</span><br><span class="line">  - 拍照建议：秋叶原的街头有很多动漫和游戏元素， 适合拍照。</span><br><span class="line">  - 交通：继续留在秋叶原，交通便利。</span><br><span class="line">  - 预算：产品价格因商品而异，但总体价格合理。   </span><br><span class="line"></span><br><span class="line">- 12:00-13:30 | 个性化午餐</span><br><span class="line">  - 推荐：秋叶原附近的『秋叶原电波塔』</span><br><span class="line">  - 特色：提供日式传统美食，同时可以欣赏到秋叶原 的繁华景象。</span><br><span class="line">  - 用户匹配：符合用户喜欢体验地道日本生活方式的 需求。</span><br><span class="line"></span><br><span class="line">- 13:30-17:00 | 新宿御苑</span><br><span class="line">  - 选择理由：新宿御苑位于市中心，交通便利，园内 有许多美丽的景观，适合散步。</span><br><span class="line">  - 个性化体验：可以在园内漫步，欣赏美丽的自然风 光。</span><br><span class="line">  - 交通：乘坐地铁从秋叶原站到新宿站，约15分钟。 </span><br><span class="line">  - 预算：门票价格适中。</span><br><span class="line"></span><br><span class="line">- 17:00-21:00 | 日式温泉体验</span><br><span class="line">  - 推荐：新宿区的『大江户温泉物语』</span><br><span class="line">  - 选择理由：体验日式温泉，放松身心。</span><br><span class="line">  - 个性化体验：可以享受传统的日式温泉，放松身心 。</span><br><span class="line">  - 交通：从新宿站步行即可到达。</span><br><span class="line">  - 预算：消费约为2000-3000日元。</span><br><span class="line"></span><br><span class="line">### 第三天：传统文化与现代生活融合</span><br><span class="line">**时间安排** (遵循用户10点后开始的偏好)</span><br><span class="line">- 10:00-12:00 | 增上寺</span><br><span class="line">  - 选择理由：增上寺是东京著名的寺庙，但可以选择 不需要爬太多台阶的入口。</span><br><span class="line">  - 个性化体验：可以在寺庙内参观，体验宁静的氛围 。</span><br><span class="line">  - 拍照建议：寺庙内的建筑和景观是拍照的最佳地点 ，建议在上午光线柔和时拍摄。</span><br><span class="line">  - 交通：乘坐地铁从新宿站到增上寺站，约20分钟。 </span><br><span class="line">  - 预算：门票免费。</span><br><span class="line"></span><br><span class="line">- 12:00-13:30 | 个性化午餐</span><br><span class="line">  - 推荐：增上寺附近的『天妇罗』</span><br><span class="line">  - 特色：提供地道的日式天妇罗，体验传统的日本美 食。</span><br><span class="line">  - 用户匹配：符合用户喜欢体验地道日本生活方式的 需求。</span><br><span class="line"></span><br><span class="line">- 13:30-17:00 | 上野公园</span><br><span class="line">  - 选择理由：上野公园内有许多博物馆和文化设施， 适合深入了解日本文化。</span><br><span class="line">  - 个性化体验：可以参观博物馆，了解日本的历史和 文化。</span><br><span class="line">  - 交通：乘坐地铁从增上寺站到上野站，约30分钟。 </span><br><span class="line">  - 预算：公园免费进入，博物馆门票价格适中。     </span><br><span class="line"></span><br><span class="line">- 17:00-21:00 | 日式澡堂体验</span><br><span class="line">  - 推荐：上野区的『汤岛温泉』</span><br><span class="line">  - 选择理由：体验传统的日式澡堂，感受地道的日本 生活方式。</span><br><span class="line">  - 个性化体验：可以享受传统的日式澡堂，放松身心 。</span><br><span class="line">  - 交通：从上野站步行即可到达。</span><br><span class="line">  - 预算：消费约为1000-2000日元。</span><br><span class="line"></span><br><span class="line">## 个性化实用信息</span><br><span class="line">### 用户专属建议</span><br><span class="line">- 动漫文化体验：参观东京动漫中心和小众动漫主题咖 啡店，体验动漫文化。</span><br><span class="line">- 科技产品购物：在Yodobashi Camera购买日本独有的 科技产品。</span><br><span class="line">- 拍照打卡攻略：六本木之丘的摩天轮和户外广场、增 上寺的建筑和景观、上野公园的自然风光都是拍照的最 佳地点。</span><br><span class="line"></span><br><span class="line">### 个性化预算参考</span><br><span class="line">- 符合用户预算的费用分配：</span><br><span class="line">  - 住宿：中等预算酒店</span><br><span class="line">  - 交通：地铁为主，部分步行</span><br><span class="line">  - 餐饮：中等预算餐厅和特色小吃</span><br><span class="line">  - 门票：免费或价格适中的景点</span><br><span class="line">- 性价比最高的选择：</span><br><span class="line">  - 东京动漫中心（免费入场）</span><br><span class="line">  - 新宿御苑（门票适中）</span><br><span class="line">  - 上野公园（免费进入）</span><br><span class="line"></span><br><span class="line">### 用户专属贴心提醒</span><br><span class="line">- 体验日式早餐：建议在酒店附近的小餐馆尝试传统的 日式早餐。</span><br><span class="line">- 选择不需要爬太多台阶的寺庙：增上寺是一个不错的 选择。</span><br><span class="line">- 保持相机电量充足：拍照是旅行的重要部分，确保相 机电量充足。</span><br><span class="line">- 注意天气变化：东京夏季多雨，建议携带雨具。     </span><br><span class="line">======</span><br><span class="line">🎯 Task ai_user_personalized_tokyo_trip.4 completed successfully.</span><br><span class="line"></span><br><span class="line">========================================================================================================================</span><br><span class="line">🎯 AI用户个性化任务处理完成</span><br><span class="line">========================================================================================================================</span><br><span class="line">任务ID: ai_user_personalized_tokyo_trip</span><br><span class="line"></span><br><span class="line">🎉Workforce 演示成功！</span><br></pre></td></tr></table></figure>

<p>我们可以看到系统的基础功能均已基本实现<br>需求结构化完整：按照基本偏好、时间安排、特殊兴趣、限制条件、期望体验分类</p>
<p>且agent角色分工明确无重叠<br>信息收集专员：只收集信息，没有制定行程<br>行程规划师：专门制定行程，整合用户需求<br>质量评审员：专业评估，给出具体评分和建议<br>最终整合专员：生成标准化最终版本</p>
<p>个性化程度高<br>深度个性化：每个安排都说明了如何满足用户需求<br>时间偏好严格遵守：所有活动都从10点开始<br>兴趣匹配精准：动漫文化、科技产品、拍照需求都得到满足</p>
<hr>
<h2 id="Task2"><a href="#Task2" class="headerlink" title="Task2"></a>Task2</h2><h3 id="在Workforce系统中加入具备不同种类工具的RolePlaying和ChatAgent作为worker，实现一个你自己的多智能体系统来解决复杂场景问题。我们仍然选择之前在第二章研究的运动场地推荐系统继续搭建并完善功能"><a href="#在Workforce系统中加入具备不同种类工具的RolePlaying和ChatAgent作为worker，实现一个你自己的多智能体系统来解决复杂场景问题。我们仍然选择之前在第二章研究的运动场地推荐系统继续搭建并完善功能" class="headerlink" title="在Workforce系统中加入具备不同种类工具的RolePlaying和ChatAgent作为worker，实现一个你自己的多智能体系统来解决复杂场景问题。我们仍然选择之前在第二章研究的运动场地推荐系统继续搭建并完善功能"></a>在Workforce系统中加入具备不同种类工具的RolePlaying和ChatAgent作为worker，实现一个你自己的多智能体系统来解决复杂场景问题。我们仍然选择之前在第二章研究的运动场地推荐系统继续搭建并完善功能</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br><span class="line">2080</span><br><span class="line">2081</span><br><span class="line">2082</span><br><span class="line">2083</span><br><span class="line">2084</span><br><span class="line">2085</span><br><span class="line">2086</span><br><span class="line">2087</span><br><span class="line">2088</span><br><span class="line">2089</span><br><span class="line">2090</span><br><span class="line">2091</span><br><span class="line">2092</span><br><span class="line">2093</span><br><span class="line">2094</span><br><span class="line">2095</span><br><span class="line">2096</span><br><span class="line">2097</span><br><span class="line">2098</span><br><span class="line">2099</span><br><span class="line">2100</span><br><span class="line">2101</span><br><span class="line">2102</span><br><span class="line">2103</span><br><span class="line">2104</span><br><span class="line">2105</span><br><span class="line">2106</span><br><span class="line">2107</span><br><span class="line">2108</span><br><span class="line">2109</span><br><span class="line">2110</span><br><span class="line">2111</span><br><span class="line">2112</span><br><span class="line">2113</span><br><span class="line">2114</span><br><span class="line">2115</span><br><span class="line">2116</span><br><span class="line">2117</span><br><span class="line">2118</span><br><span class="line">2119</span><br><span class="line">2120</span><br><span class="line">2121</span><br><span class="line">2122</span><br><span class="line">2123</span><br><span class="line">2124</span><br><span class="line">2125</span><br><span class="line">2126</span><br><span class="line">2127</span><br><span class="line">2128</span><br><span class="line">2129</span><br><span class="line">2130</span><br><span class="line">2131</span><br><span class="line">2132</span><br><span class="line">2133</span><br><span class="line">2134</span><br><span class="line">2135</span><br><span class="line">2136</span><br><span class="line">2137</span><br><span class="line">2138</span><br><span class="line">2139</span><br><span class="line">2140</span><br><span class="line">2141</span><br><span class="line">2142</span><br><span class="line">2143</span><br><span class="line">2144</span><br><span class="line">2145</span><br><span class="line">2146</span><br><span class="line">2147</span><br><span class="line">2148</span><br><span class="line">2149</span><br><span class="line">2150</span><br><span class="line">2151</span><br><span class="line">2152</span><br><span class="line">2153</span><br><span class="line">2154</span><br><span class="line">2155</span><br><span class="line">2156</span><br><span class="line">2157</span><br><span class="line">2158</span><br><span class="line">2159</span><br><span class="line">2160</span><br><span class="line">2161</span><br><span class="line">2162</span><br><span class="line">2163</span><br><span class="line">2164</span><br><span class="line">2165</span><br><span class="line">2166</span><br><span class="line">2167</span><br><span class="line">2168</span><br><span class="line">2169</span><br><span class="line">2170</span><br><span class="line">2171</span><br><span class="line">2172</span><br><span class="line">2173</span><br><span class="line">2174</span><br><span class="line">2175</span><br><span class="line">2176</span><br><span class="line">2177</span><br><span class="line">2178</span><br><span class="line">2179</span><br><span class="line">2180</span><br><span class="line">2181</span><br><span class="line">2182</span><br><span class="line">2183</span><br><span class="line">2184</span><br><span class="line">2185</span><br><span class="line">2186</span><br><span class="line">2187</span><br><span class="line">2188</span><br><span class="line">2189</span><br><span class="line">2190</span><br><span class="line">2191</span><br><span class="line">2192</span><br><span class="line">2193</span><br><span class="line">2194</span><br><span class="line">2195</span><br><span class="line">2196</span><br><span class="line">2197</span><br><span class="line">2198</span><br><span class="line">2199</span><br><span class="line">2200</span><br><span class="line">2201</span><br><span class="line">2202</span><br><span class="line">2203</span><br><span class="line">2204</span><br><span class="line">2205</span><br><span class="line">2206</span><br><span class="line">2207</span><br><span class="line">2208</span><br><span class="line">2209</span><br><span class="line">2210</span><br><span class="line">2211</span><br><span class="line">2212</span><br><span class="line">2213</span><br><span class="line">2214</span><br><span class="line">2215</span><br><span class="line">2216</span><br><span class="line">2217</span><br><span class="line">2218</span><br><span class="line">2219</span><br><span class="line">2220</span><br><span class="line">2221</span><br><span class="line">2222</span><br><span class="line">2223</span><br><span class="line">2224</span><br><span class="line">2225</span><br><span class="line">2226</span><br><span class="line">2227</span><br><span class="line">2228</span><br><span class="line">2229</span><br><span class="line">2230</span><br><span class="line">2231</span><br><span class="line">2232</span><br><span class="line">2233</span><br><span class="line">2234</span><br><span class="line">2235</span><br><span class="line">2236</span><br><span class="line">2237</span><br><span class="line">2238</span><br><span class="line">2239</span><br><span class="line">2240</span><br><span class="line">2241</span><br><span class="line">2242</span><br><span class="line">2243</span><br><span class="line">2244</span><br><span class="line">2245</span><br><span class="line">2246</span><br><span class="line">2247</span><br><span class="line">2248</span><br><span class="line">2249</span><br><span class="line">2250</span><br><span class="line">2251</span><br><span class="line">2252</span><br><span class="line">2253</span><br><span class="line">2254</span><br><span class="line">2255</span><br><span class="line">2256</span><br><span class="line">2257</span><br><span class="line">2258</span><br><span class="line">2259</span><br><span class="line">2260</span><br><span class="line">2261</span><br><span class="line">2262</span><br><span class="line">2263</span><br><span class="line">2264</span><br><span class="line">2265</span><br><span class="line">2266</span><br><span class="line">2267</span><br><span class="line">2268</span><br><span class="line">2269</span><br><span class="line">2270</span><br><span class="line">2271</span><br><span class="line">2272</span><br><span class="line">2273</span><br><span class="line">2274</span><br><span class="line">2275</span><br><span class="line">2276</span><br><span class="line">2277</span><br><span class="line">2278</span><br><span class="line">2279</span><br><span class="line">2280</span><br><span class="line">2281</span><br><span class="line">2282</span><br><span class="line">2283</span><br><span class="line">2284</span><br><span class="line">2285</span><br><span class="line">2286</span><br><span class="line">2287</span><br><span class="line">2288</span><br><span class="line">2289</span><br><span class="line">2290</span><br><span class="line">2291</span><br><span class="line">2292</span><br><span class="line">2293</span><br><span class="line">2294</span><br><span class="line">2295</span><br><span class="line">2296</span><br><span class="line">2297</span><br><span class="line">2298</span><br><span class="line">2299</span><br><span class="line">2300</span><br><span class="line">2301</span><br><span class="line">2302</span><br><span class="line">2303</span><br><span class="line">2304</span><br><span class="line">2305</span><br><span class="line">2306</span><br><span class="line">2307</span><br><span class="line">2308</span><br><span class="line">2309</span><br><span class="line">2310</span><br><span class="line">2311</span><br><span class="line">2312</span><br><span class="line">2313</span><br><span class="line">2314</span><br><span class="line">2315</span><br><span class="line">2316</span><br><span class="line">2317</span><br><span class="line">2318</span><br><span class="line">2319</span><br><span class="line">2320</span><br><span class="line">2321</span><br><span class="line">2322</span><br><span class="line">2323</span><br><span class="line">2324</span><br><span class="line">2325</span><br><span class="line">2326</span><br><span class="line">2327</span><br><span class="line">2328</span><br><span class="line">2329</span><br><span class="line">2330</span><br><span class="line">2331</span><br><span class="line">2332</span><br><span class="line">2333</span><br><span class="line">2334</span><br><span class="line">2335</span><br><span class="line">2336</span><br><span class="line">2337</span><br><span class="line">2338</span><br><span class="line">2339</span><br><span class="line">2340</span><br><span class="line">2341</span><br><span class="line">2342</span><br><span class="line">2343</span><br><span class="line">2344</span><br><span class="line">2345</span><br><span class="line">2346</span><br><span class="line">2347</span><br><span class="line">2348</span><br><span class="line">2349</span><br><span class="line">2350</span><br><span class="line">2351</span><br><span class="line">2352</span><br><span class="line">2353</span><br><span class="line">2354</span><br><span class="line">2355</span><br><span class="line">2356</span><br><span class="line">2357</span><br><span class="line">2358</span><br><span class="line">2359</span><br><span class="line">2360</span><br><span class="line">2361</span><br><span class="line">2362</span><br><span class="line">2363</span><br><span class="line">2364</span><br><span class="line">2365</span><br><span class="line">2366</span><br><span class="line">2367</span><br><span class="line">2368</span><br><span class="line">2369</span><br><span class="line">2370</span><br><span class="line">2371</span><br><span class="line">2372</span><br><span class="line">2373</span><br><span class="line">2374</span><br><span class="line">2375</span><br><span class="line">2376</span><br><span class="line">2377</span><br><span class="line">2378</span><br><span class="line">2379</span><br><span class="line">2380</span><br><span class="line">2381</span><br><span class="line">2382</span><br><span class="line">2383</span><br><span class="line">2384</span><br><span class="line">2385</span><br><span class="line">2386</span><br><span class="line">2387</span><br><span class="line">2388</span><br><span class="line">2389</span><br><span class="line">2390</span><br><span class="line">2391</span><br><span class="line">2392</span><br><span class="line">2393</span><br><span class="line">2394</span><br><span class="line">2395</span><br><span class="line">2396</span><br><span class="line">2397</span><br><span class="line">2398</span><br><span class="line">2399</span><br><span class="line">2400</span><br><span class="line">2401</span><br><span class="line">2402</span><br><span class="line">2403</span><br><span class="line">2404</span><br><span class="line">2405</span><br><span class="line">2406</span><br><span class="line">2407</span><br><span class="line">2408</span><br><span class="line">2409</span><br><span class="line">2410</span><br><span class="line">2411</span><br><span class="line">2412</span><br><span class="line">2413</span><br><span class="line">2414</span><br><span class="line">2415</span><br><span class="line">2416</span><br><span class="line">2417</span><br><span class="line">2418</span><br><span class="line">2419</span><br><span class="line">2420</span><br><span class="line">2421</span><br><span class="line">2422</span><br><span class="line">2423</span><br><span class="line">2424</span><br><span class="line">2425</span><br><span class="line">2426</span><br><span class="line">2427</span><br><span class="line">2428</span><br><span class="line">2429</span><br><span class="line">2430</span><br><span class="line">2431</span><br><span class="line">2432</span><br><span class="line">2433</span><br><span class="line">2434</span><br><span class="line">2435</span><br><span class="line">2436</span><br><span class="line">2437</span><br><span class="line">2438</span><br><span class="line">2439</span><br><span class="line">2440</span><br><span class="line">2441</span><br><span class="line">2442</span><br><span class="line">2443</span><br><span class="line">2444</span><br><span class="line">2445</span><br><span class="line">2446</span><br><span class="line">2447</span><br><span class="line">2448</span><br><span class="line">2449</span><br><span class="line">2450</span><br><span class="line">2451</span><br><span class="line">2452</span><br><span class="line">2453</span><br><span class="line">2454</span><br><span class="line">2455</span><br><span class="line">2456</span><br><span class="line">2457</span><br><span class="line">2458</span><br><span class="line">2459</span><br><span class="line">2460</span><br><span class="line">2461</span><br><span class="line">2462</span><br><span class="line">2463</span><br><span class="line">2464</span><br><span class="line">2465</span><br><span class="line">2466</span><br><span class="line">2467</span><br><span class="line">2468</span><br><span class="line">2469</span><br><span class="line">2470</span><br><span class="line">2471</span><br><span class="line">2472</span><br><span class="line">2473</span><br><span class="line">2474</span><br><span class="line">2475</span><br><span class="line">2476</span><br><span class="line">2477</span><br><span class="line">2478</span><br><span class="line">2479</span><br><span class="line">2480</span><br><span class="line">2481</span><br><span class="line">2482</span><br><span class="line">2483</span><br><span class="line">2484</span><br><span class="line">2485</span><br><span class="line">2486</span><br><span class="line">2487</span><br><span class="line">2488</span><br><span class="line">2489</span><br><span class="line">2490</span><br><span class="line">2491</span><br><span class="line">2492</span><br><span class="line">2493</span><br><span class="line">2494</span><br><span class="line">2495</span><br><span class="line">2496</span><br><span class="line">2497</span><br><span class="line">2498</span><br><span class="line">2499</span><br><span class="line">2500</span><br><span class="line">2501</span><br><span class="line">2502</span><br><span class="line">2503</span><br><span class="line">2504</span><br><span class="line">2505</span><br><span class="line">2506</span><br><span class="line">2507</span><br><span class="line">2508</span><br><span class="line">2509</span><br><span class="line">2510</span><br><span class="line">2511</span><br><span class="line">2512</span><br><span class="line">2513</span><br><span class="line">2514</span><br><span class="line">2515</span><br><span class="line">2516</span><br><span class="line">2517</span><br><span class="line">2518</span><br><span class="line">2519</span><br><span class="line">2520</span><br><span class="line">2521</span><br><span class="line">2522</span><br><span class="line">2523</span><br><span class="line">2524</span><br><span class="line">2525</span><br><span class="line">2526</span><br><span class="line">2527</span><br><span class="line">2528</span><br><span class="line">2529</span><br><span class="line">2530</span><br><span class="line">2531</span><br><span class="line">2532</span><br><span class="line">2533</span><br><span class="line">2534</span><br><span class="line">2535</span><br><span class="line">2536</span><br><span class="line">2537</span><br><span class="line">2538</span><br><span class="line">2539</span><br><span class="line">2540</span><br><span class="line">2541</span><br><span class="line">2542</span><br><span class="line">2543</span><br><span class="line">2544</span><br><span class="line">2545</span><br><span class="line">2546</span><br><span class="line">2547</span><br><span class="line">2548</span><br><span class="line">2549</span><br><span class="line">2550</span><br><span class="line">2551</span><br><span class="line">2552</span><br><span class="line">2553</span><br><span class="line">2554</span><br><span class="line">2555</span><br><span class="line">2556</span><br><span class="line">2557</span><br><span class="line">2558</span><br><span class="line">2559</span><br><span class="line">2560</span><br><span class="line">2561</span><br><span class="line">2562</span><br><span class="line">2563</span><br><span class="line">2564</span><br><span class="line">2565</span><br><span class="line">2566</span><br><span class="line">2567</span><br><span class="line">2568</span><br><span class="line">2569</span><br><span class="line">2570</span><br><span class="line">2571</span><br><span class="line">2572</span><br><span class="line">2573</span><br><span class="line">2574</span><br><span class="line">2575</span><br><span class="line">2576</span><br><span class="line">2577</span><br><span class="line">2578</span><br><span class="line">2579</span><br><span class="line">2580</span><br><span class="line">2581</span><br><span class="line">2582</span><br><span class="line">2583</span><br><span class="line">2584</span><br><span class="line">2585</span><br><span class="line">2586</span><br><span class="line">2587</span><br><span class="line">2588</span><br><span class="line">2589</span><br><span class="line">2590</span><br><span class="line">2591</span><br><span class="line">2592</span><br><span class="line">2593</span><br><span class="line">2594</span><br><span class="line">2595</span><br><span class="line">2596</span><br><span class="line">2597</span><br><span class="line">2598</span><br><span class="line">2599</span><br><span class="line">2600</span><br><span class="line">2601</span><br><span class="line">2602</span><br><span class="line">2603</span><br><span class="line">2604</span><br><span class="line">2605</span><br><span class="line">2606</span><br><span class="line">2607</span><br><span class="line">2608</span><br><span class="line">2609</span><br><span class="line">2610</span><br><span class="line">2611</span><br><span class="line">2612</span><br><span class="line">2613</span><br><span class="line">2614</span><br><span class="line">2615</span><br><span class="line">2616</span><br><span class="line">2617</span><br><span class="line">2618</span><br><span class="line">2619</span><br><span class="line">2620</span><br><span class="line">2621</span><br><span class="line">2622</span><br><span class="line">2623</span><br><span class="line">2624</span><br><span class="line">2625</span><br><span class="line">2626</span><br><span class="line">2627</span><br><span class="line">2628</span><br><span class="line">2629</span><br><span class="line">2630</span><br><span class="line">2631</span><br><span class="line">2632</span><br><span class="line">2633</span><br><span class="line">2634</span><br><span class="line">2635</span><br><span class="line">2636</span><br><span class="line">2637</span><br><span class="line">2638</span><br><span class="line">2639</span><br><span class="line">2640</span><br><span class="line">2641</span><br><span class="line">2642</span><br><span class="line">2643</span><br><span class="line">2644</span><br><span class="line">2645</span><br><span class="line">2646</span><br><span class="line">2647</span><br><span class="line">2648</span><br><span class="line">2649</span><br><span class="line">2650</span><br><span class="line">2651</span><br><span class="line">2652</span><br><span class="line">2653</span><br><span class="line">2654</span><br><span class="line">2655</span><br><span class="line">2656</span><br><span class="line">2657</span><br><span class="line">2658</span><br><span class="line">2659</span><br><span class="line">2660</span><br><span class="line">2661</span><br><span class="line">2662</span><br><span class="line">2663</span><br><span class="line">2664</span><br><span class="line">2665</span><br><span class="line">2666</span><br><span class="line">2667</span><br><span class="line">2668</span><br><span class="line">2669</span><br><span class="line">2670</span><br><span class="line">2671</span><br><span class="line">2672</span><br><span class="line">2673</span><br><span class="line">2674</span><br><span class="line">2675</span><br><span class="line">2676</span><br><span class="line">2677</span><br><span class="line">2678</span><br><span class="line">2679</span><br><span class="line">2680</span><br><span class="line">2681</span><br><span class="line">2682</span><br><span class="line">2683</span><br><span class="line">2684</span><br><span class="line">2685</span><br><span class="line">2686</span><br><span class="line">2687</span><br><span class="line">2688</span><br><span class="line">2689</span><br><span class="line">2690</span><br><span class="line">2691</span><br><span class="line">2692</span><br><span class="line">2693</span><br><span class="line">2694</span><br><span class="line">2695</span><br><span class="line">2696</span><br><span class="line">2697</span><br><span class="line">2698</span><br><span class="line">2699</span><br><span class="line">2700</span><br><span class="line">2701</span><br><span class="line">2702</span><br><span class="line">2703</span><br><span class="line">2704</span><br><span class="line">2705</span><br><span class="line">2706</span><br><span class="line">2707</span><br><span class="line">2708</span><br><span class="line">2709</span><br><span class="line">2710</span><br><span class="line">2711</span><br><span class="line">2712</span><br><span class="line">2713</span><br><span class="line">2714</span><br><span class="line">2715</span><br><span class="line">2716</span><br><span class="line">2717</span><br><span class="line">2718</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent, TaskSpecifyAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.prompts <span class="keyword">import</span> TextPrompt</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, TaskType</span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.societies.workforce <span class="keyword">import</span> Workforce</span><br><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> SearchToolkit, MathToolkit</span><br><span class="line"><span class="keyword">from</span> camel.memories <span class="keyword">import</span> ChatHistoryBlock</span><br><span class="line"><span class="keyword">from</span> camel.memories.records <span class="keyword">import</span> MemoryRecord</span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> OpenAIBackendRole</span><br><span class="line"><span class="keyword">from</span> camel.tasks <span class="keyword">import</span> Task</span><br><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Tuple</span>, <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重试装饰器和错误处理系统（保持原有的错误处理机制）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RetryConfig</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;重试配置类&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_retries: <span class="built_in">int</span> = <span class="number">3</span>, base_delay: <span class="built_in">float</span> = <span class="number">1.0</span>, max_delay: <span class="built_in">float</span> = <span class="number">60.0</span>, </span></span><br><span class="line"><span class="params">                 backoff_factor: <span class="built_in">float</span> = <span class="number">2.0</span>, jitter: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.max_retries = max_retries</span><br><span class="line">        <span class="variable language_">self</span>.base_delay = base_delay</span><br><span class="line">        <span class="variable language_">self</span>.max_delay = max_delay</span><br><span class="line">        <span class="variable language_">self</span>.backoff_factor = backoff_factor</span><br><span class="line">        <span class="variable language_">self</span>.jitter = jitter</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RetryableError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;可重试的错误类型&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NonRetryableError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;不可重试的错误类型&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">smart_retry</span>(<span class="params">config: RetryConfig = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                retryable_exceptions: <span class="type">Tuple</span> = (<span class="params">Exception,</span>),</span></span><br><span class="line"><span class="params">                non_retryable_exceptions: <span class="type">Tuple</span> = (<span class="params">KeyboardInterrupt, SystemExit</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;智能重试装饰器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> config <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        config = RetryConfig()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func: <span class="type">Callable</span></span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line"><span class="meta">        @wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">            last_exception = <span class="literal">None</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(config.max_retries + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">except</span> non_retryable_exceptions <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;不可重试错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">raise</span> e</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">except</span> retryable_exceptions <span class="keyword">as</span> e:</span><br><span class="line">                    last_exception = e</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> attempt == config.max_retries:</span><br><span class="line">                        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;重试<span class="subst">&#123;config.max_retries&#125;</span>次后仍然失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 计算延迟时间</span></span><br><span class="line">                    delay = <span class="built_in">min</span>(</span><br><span class="line">                        config.base_delay * (config.backoff_factor ** attempt),</span><br><span class="line">                        config.max_delay</span><br><span class="line">                    )</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 添加随机抖动</span></span><br><span class="line">                    <span class="keyword">if</span> config.jitter:</span><br><span class="line">                        delay *= (<span class="number">0.5</span> + random.random() * <span class="number">0.5</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;第<span class="subst">&#123;attempt + <span class="number">1</span>&#125;</span>次尝试失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(Fore.CYAN + <span class="string">f&quot;<span class="subst">&#123;delay:<span class="number">.1</span>f&#125;</span>秒后重试...&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                    time.sleep(delay)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果所有重试都失败了，抛出最后一个异常</span></span><br><span class="line">            <span class="keyword">if</span> last_exception:</span><br><span class="line">                <span class="keyword">raise</span> last_exception</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误处理和分类系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;错误处理和分类系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">classify_error</span>(<span class="params">error: Exception</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分类错误类型&quot;&quot;&quot;</span></span><br><span class="line">        error_str = <span class="built_in">str</span>(error).lower()</span><br><span class="line">        error_type = <span class="built_in">type</span>(error).__name__</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 网络相关错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> error_str <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&#x27;connection&#x27;</span>, <span class="string">&#x27;timeout&#x27;</span>, <span class="string">&#x27;network&#x27;</span>, <span class="string">&#x27;http&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;network_error&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># API相关错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> error_str <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&#x27;api&#x27;</span>, <span class="string">&#x27;rate limit&#x27;</span>, <span class="string">&#x27;quota&#x27;</span>, <span class="string">&#x27;unauthorized&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;api_error&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 模型相关错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> error_str <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&#x27;model&#x27;</span>, <span class="string">&#x27;inference&#x27;</span>, <span class="string">&#x27;generation&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;model_error&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 数据相关错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> error_str <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;parse&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;decode&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;data_error&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 内存相关错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> error_str <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&#x27;memory&#x27;</span>, <span class="string">&#x27;out of memory&#x27;</span>, <span class="string">&#x27;oom&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;memory_error&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;unknown_error&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_retry_config</span>(<span class="params">error_type: <span class="built_in">str</span></span>) -&gt; RetryConfig:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据错误类型获取重试配置&quot;&quot;&quot;</span></span><br><span class="line">        configs = &#123;</span><br><span class="line">            <span class="string">&quot;network_error&quot;</span>: RetryConfig(max_retries=<span class="number">5</span>, base_delay=<span class="number">2.0</span>, backoff_factor=<span class="number">1.5</span>),</span><br><span class="line">            <span class="string">&quot;api_error&quot;</span>: RetryConfig(max_retries=<span class="number">3</span>, base_delay=<span class="number">5.0</span>, backoff_factor=<span class="number">2.0</span>),</span><br><span class="line">            <span class="string">&quot;model_error&quot;</span>: RetryConfig(max_retries=<span class="number">2</span>, base_delay=<span class="number">3.0</span>, backoff_factor=<span class="number">2.0</span>),</span><br><span class="line">            <span class="string">&quot;data_error&quot;</span>: RetryConfig(max_retries=<span class="number">2</span>, base_delay=<span class="number">1.0</span>, backoff_factor=<span class="number">1.5</span>),</span><br><span class="line">            <span class="string">&quot;memory_error&quot;</span>: RetryConfig(max_retries=<span class="number">1</span>, base_delay=<span class="number">10.0</span>, backoff_factor=<span class="number">1.0</span>),</span><br><span class="line">            <span class="string">&quot;unknown_error&quot;</span>: RetryConfig(max_retries=<span class="number">2</span>, base_delay=<span class="number">2.0</span>, backoff_factor=<span class="number">2.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> configs.get(error_type, RetryConfig())</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_error_with_fallback</span>(<span class="params">error: Exception, fallback_func: <span class="type">Callable</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;带降级策略的错误处理&quot;&quot;&quot;</span></span><br><span class="line">        error_type = ErrorHandler.classify_error(error)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 检测到错误类型: <span class="subst">&#123;error_type&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 错误详情: <span class="subst">&#123;error&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> fallback_func:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;🔄 尝试使用降级策略...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> fallback_func()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> fallback_error:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 降级策略也失败了: <span class="subst">&#123;fallback_error&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建模型实例（带重试机制和错误处理）</span></span><br><span class="line"><span class="meta">@smart_retry(<span class="params">RetryConfig(<span class="params">max_retries=<span class="number">3</span>, base_delay=<span class="number">2.0</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_model_with_retry</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;带重试机制的模型创建&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> ModelFactory.create(</span><br><span class="line">            model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">            model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">            url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">            api_key=api_key</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_type = ErrorHandler.classify_error(e)</span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 模型创建失败 (<span class="subst">&#123;error_type&#125;</span>): <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> RetryableError(<span class="string">f&quot;模型创建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">model = create_model_with_retry()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需求优先级管理系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequirementPriorityManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户需求优先级管理系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 定义需求类型和默认优先级</span></span><br><span class="line">        <span class="variable language_">self</span>.requirement_types = &#123;</span><br><span class="line">            <span class="string">&#x27;sport_preference&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;运动类型&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;location&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">9</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;地理位置&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;budget_range&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;预算范围&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;preferred_time&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;运动时间&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;transport_mode&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;交通方式&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;special_needs&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;特殊需求&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;frequency&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;运动频率&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;experience_level&#x27;</span>: &#123;<span class="string">&#x27;priority&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;经验水平&#x27;</span>, <span class="string">&#x27;negotiable&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_priority_questions</span>(<span class="params">self, user_needs: <span class="type">Dict</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成优先级确认问题&quot;&quot;&quot;</span></span><br><span class="line">        questions = []</span><br><span class="line">        negotiable_requirements = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> req_key, req_info <span class="keyword">in</span> <span class="variable language_">self</span>.requirement_types.items():</span><br><span class="line">            <span class="keyword">if</span> req_info[<span class="string">&#x27;negotiable&#x27;</span>] <span class="keyword">and</span> req_key <span class="keyword">in</span> user_needs:</span><br><span class="line">                negotiable_requirements.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;key&#x27;</span>: req_key,</span><br><span class="line">                    <span class="string">&#x27;name&#x27;</span>: req_info[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;value&#x27;</span>: user_needs[req_key],</span><br><span class="line">                    <span class="string">&#x27;priority&#x27;</span>: req_info[<span class="string">&#x27;priority&#x27;</span>]</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按优先级排序</span></span><br><span class="line">        negotiable_requirements.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;priority&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        questions.append(<span class="string">&quot;为了帮您找到最合适的运动场馆，请告诉我以下需求的重要程度：&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, req <span class="keyword">in</span> <span class="built_in">enumerate</span>(negotiable_requirements[:<span class="number">5</span>]):  <span class="comment"># 只询问前5个最重要的</span></span><br><span class="line">            questions.append(<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;req[<span class="string">&#x27;name&#x27;</span>]&#125;</span>（当前：<span class="subst">&#123;req[<span class="string">&#x27;value&#x27;</span>]&#125;</span>）- 这个要求对您有多重要？（必须满足/希望满足/可以妥协）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> questions</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_priority_response</span>(<span class="params">self, response: <span class="built_in">str</span>, user_needs: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析用户的优先级回答&quot;&quot;&quot;</span></span><br><span class="line">        priority_levels = &#123;</span><br><span class="line">            <span class="string">&#x27;must_have&#x27;</span>: [],  <span class="comment"># 必须满足</span></span><br><span class="line">            <span class="string">&#x27;prefer_have&#x27;</span>: [],  <span class="comment"># 希望满足</span></span><br><span class="line">            <span class="string">&#x27;can_compromise&#x27;</span>: []  <span class="comment"># 可以妥协</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简化的解析逻辑（实际应用中可以使用更复杂的NLP）</span></span><br><span class="line">        response_lower = response.lower()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> req_key, req_info <span class="keyword">in</span> <span class="variable language_">self</span>.requirement_types.items():</span><br><span class="line">            <span class="keyword">if</span> req_key <span class="keyword">in</span> user_needs <span class="keyword">and</span> req_info[<span class="string">&#x27;negotiable&#x27;</span>]:</span><br><span class="line">                req_name = req_info[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;必须&#x27;</span> <span class="keyword">in</span> response <span class="keyword">and</span> req_name <span class="keyword">in</span> response:</span><br><span class="line">                    priority_levels[<span class="string">&#x27;must_have&#x27;</span>].append(req_key)</span><br><span class="line">                <span class="keyword">elif</span> <span class="string">&#x27;希望&#x27;</span> <span class="keyword">in</span> response <span class="keyword">and</span> req_name <span class="keyword">in</span> response:</span><br><span class="line">                    priority_levels[<span class="string">&#x27;prefer_have&#x27;</span>].append(req_key)</span><br><span class="line">                <span class="keyword">elif</span> <span class="string">&#x27;妥协&#x27;</span> <span class="keyword">in</span> response <span class="keyword">and</span> req_name <span class="keyword">in</span> response:</span><br><span class="line">                    priority_levels[<span class="string">&#x27;can_compromise&#x27;</span>].append(req_key)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># 默认分类</span></span><br><span class="line">                    <span class="keyword">if</span> req_info[<span class="string">&#x27;priority&#x27;</span>] &gt;= <span class="number">8</span>:</span><br><span class="line">                        priority_levels[<span class="string">&#x27;must_have&#x27;</span>].append(req_key)</span><br><span class="line">                    <span class="keyword">elif</span> req_info[<span class="string">&#x27;priority&#x27;</span>] &gt;= <span class="number">6</span>:</span><br><span class="line">                        priority_levels[<span class="string">&#x27;prefer_have&#x27;</span>].append(req_key)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        priority_levels[<span class="string">&#x27;can_compromise&#x27;</span>].append(req_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> priority_levels</span><br><span class="line"></span><br><span class="line"><span class="comment"># 地理范围扩展管理系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeographicExpansionManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;地理搜索范围扩展管理系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 北京市区域层级结构</span></span><br><span class="line">        <span class="variable language_">self</span>.beijing_areas = &#123;</span><br><span class="line">            <span class="string">&#x27;东城区&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;adjacent&#x27;</span>: [<span class="string">&#x27;西城区&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;丰台区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;nearby&#x27;</span>: [<span class="string">&#x27;海淀区&#x27;</span>, <span class="string">&#x27;石景山区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;districts&#x27;</span>: [<span class="string">&#x27;东华门街道&#x27;</span>, <span class="string">&#x27;景山街道&#x27;</span>, <span class="string">&#x27;交道口街道&#x27;</span>, <span class="string">&#x27;安定门街道&#x27;</span>, <span class="string">&#x27;北新桥街道&#x27;</span>, <span class="string">&#x27;东四街道&#x27;</span>, <span class="string">&#x27;朝阳门街道&#x27;</span>, <span class="string">&#x27;建国门街道&#x27;</span>, <span class="string">&#x27;东直门街道&#x27;</span>, <span class="string">&#x27;和平里街道&#x27;</span>, <span class="string">&#x27;前门街道&#x27;</span>, <span class="string">&#x27;崇文门外街道&#x27;</span>, <span class="string">&#x27;东花市街道&#x27;</span>, <span class="string">&#x27;龙潭街道&#x27;</span>, <span class="string">&#x27;体育馆路街道&#x27;</span>, <span class="string">&#x27;天坛街道&#x27;</span>, <span class="string">&#x27;永定门外街道&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;西城区&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;adjacent&#x27;</span>: [<span class="string">&#x27;东城区&#x27;</span>, <span class="string">&#x27;海淀区&#x27;</span>, <span class="string">&#x27;丰台区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;nearby&#x27;</span>: [<span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;石景山区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;districts&#x27;</span>: [<span class="string">&#x27;西长安街街道&#x27;</span>, <span class="string">&#x27;新街口街道&#x27;</span>, <span class="string">&#x27;月坛街道&#x27;</span>, <span class="string">&#x27;展览路街道&#x27;</span>, <span class="string">&#x27;德胜街道&#x27;</span>, <span class="string">&#x27;金融街街道&#x27;</span>, <span class="string">&#x27;什刹海街道&#x27;</span>, <span class="string">&#x27;大栅栏街道&#x27;</span>, <span class="string">&#x27;天桥街道&#x27;</span>, <span class="string">&#x27;椿树街道&#x27;</span>, <span class="string">&#x27;陶然亭街道&#x27;</span>, <span class="string">&#x27;广安门内街道&#x27;</span>, <span class="string">&#x27;牛街街道&#x27;</span>, <span class="string">&#x27;白纸坊街道&#x27;</span>, <span class="string">&#x27;广安门外街道&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;朝阳区&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;adjacent&#x27;</span>: [<span class="string">&#x27;东城区&#x27;</span>, <span class="string">&#x27;西城区&#x27;</span>, <span class="string">&#x27;海淀区&#x27;</span>, <span class="string">&#x27;丰台区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;nearby&#x27;</span>: [<span class="string">&#x27;石景山区&#x27;</span>, <span class="string">&#x27;通州区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;districts&#x27;</span>: [<span class="string">&#x27;建外街道&#x27;</span>, <span class="string">&#x27;朝外街道&#x27;</span>, <span class="string">&#x27;呼家楼街道&#x27;</span>, <span class="string">&#x27;三里屯街道&#x27;</span>, <span class="string">&#x27;左家庄街道&#x27;</span>, <span class="string">&#x27;香河园街道&#x27;</span>, <span class="string">&#x27;和平街街道&#x27;</span>, <span class="string">&#x27;安贞街道&#x27;</span>, <span class="string">&#x27;亚运村街道&#x27;</span>, <span class="string">&#x27;小关街道&#x27;</span>, <span class="string">&#x27;酒仙桥街道&#x27;</span>, <span class="string">&#x27;麦子店街道&#x27;</span>, <span class="string">&#x27;团结湖街道&#x27;</span>, <span class="string">&#x27;六里屯街道&#x27;</span>, <span class="string">&#x27;八里庄街道&#x27;</span>, <span class="string">&#x27;双井街道&#x27;</span>, <span class="string">&#x27;劲松街道&#x27;</span>, <span class="string">&#x27;潘家园街道&#x27;</span>, <span class="string">&#x27;垡头街道&#x27;</span>, <span class="string">&#x27;南磨房街道&#x27;</span>, <span class="string">&#x27;高碑店街道&#x27;</span>, <span class="string">&#x27;将台街道&#x27;</span>, <span class="string">&#x27;太阳宫街道&#x27;</span>, <span class="string">&#x27;大屯街道&#x27;</span>, <span class="string">&#x27;望京街道&#x27;</span>, <span class="string">&#x27;小红门街道&#x27;</span>, <span class="string">&#x27;十八里店街道&#x27;</span>, <span class="string">&#x27;平房街道&#x27;</span>, <span class="string">&#x27;东风街道&#x27;</span>, <span class="string">&#x27;奥运村街道&#x27;</span>, <span class="string">&#x27;来广营街道&#x27;</span>, <span class="string">&#x27;常营街道&#x27;</span>, <span class="string">&#x27;三间房街道&#x27;</span>, <span class="string">&#x27;管庄街道&#x27;</span>, <span class="string">&#x27;金盏街道&#x27;</span>, <span class="string">&#x27;孙河街道&#x27;</span>, <span class="string">&#x27;崔各庄街道&#x27;</span>, <span class="string">&#x27;东坝街道&#x27;</span>, <span class="string">&#x27;黑庄户街道&#x27;</span>, <span class="string">&#x27;豆各庄街道&#x27;</span>, <span class="string">&#x27;王四营街道&#x27;</span>, <span class="string">&#x27;东风街道&#x27;</span>, <span class="string">&#x27;六里屯街道&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;海淀区&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;adjacent&#x27;</span>: [<span class="string">&#x27;西城区&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;丰台区&#x27;</span>, <span class="string">&#x27;石景山区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;nearby&#x27;</span>: [<span class="string">&#x27;东城区&#x27;</span>, <span class="string">&#x27;昌平区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;districts&#x27;</span>: [<span class="string">&#x27;万寿路街道&#x27;</span>, <span class="string">&#x27;永定路街道&#x27;</span>, <span class="string">&#x27;羊坊店街道&#x27;</span>, <span class="string">&#x27;甘家口街道&#x27;</span>, <span class="string">&#x27;八里庄街道&#x27;</span>, <span class="string">&#x27;紫竹院街道&#x27;</span>, <span class="string">&#x27;北下关街道&#x27;</span>, <span class="string">&#x27;北太平庄街道&#x27;</span>, <span class="string">&#x27;学院路街道&#x27;</span>, <span class="string">&#x27;中关村街道&#x27;</span>, <span class="string">&#x27;海淀街道&#x27;</span>, <span class="string">&#x27;青龙桥街道&#x27;</span>, <span class="string">&#x27;清华园街道&#x27;</span>, <span class="string">&#x27;燕园街道&#x27;</span>, <span class="string">&#x27;香山街道&#x27;</span>, <span class="string">&#x27;清河街道&#x27;</span>, <span class="string">&#x27;花园路街道&#x27;</span>, <span class="string">&#x27;西三旗街道&#x27;</span>, <span class="string">&#x27;马连洼街道&#x27;</span>, <span class="string">&#x27;田村路街道&#x27;</span>, <span class="string">&#x27;上地街道&#x27;</span>, <span class="string">&#x27;万柳街道&#x27;</span>, <span class="string">&#x27;东升街道&#x27;</span>, <span class="string">&#x27;曙光街道&#x27;</span>, <span class="string">&#x27;温泉镇&#x27;</span>, <span class="string">&#x27;四季青镇&#x27;</span>, <span class="string">&#x27;西北旺镇&#x27;</span>, <span class="string">&#x27;苏家坨镇&#x27;</span>, <span class="string">&#x27;上庄镇&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;丰台区&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;adjacent&#x27;</span>: [<span class="string">&#x27;东城区&#x27;</span>, <span class="string">&#x27;西城区&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;海淀区&#x27;</span>, <span class="string">&#x27;石景山区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;nearby&#x27;</span>: [<span class="string">&#x27;大兴区&#x27;</span>, <span class="string">&#x27;房山区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;districts&#x27;</span>: [<span class="string">&#x27;右安门街道&#x27;</span>, <span class="string">&#x27;太平桥街道&#x27;</span>, <span class="string">&#x27;西罗园街道&#x27;</span>, <span class="string">&#x27;大红门街道&#x27;</span>, <span class="string">&#x27;南苑街道&#x27;</span>, <span class="string">&#x27;东高地街道&#x27;</span>, <span class="string">&#x27;东铁匠营街道&#x27;</span>, <span class="string">&#x27;卢沟桥街道&#x27;</span>, <span class="string">&#x27;丰台街道&#x27;</span>, <span class="string">&#x27;新村街道&#x27;</span>, <span class="string">&#x27;长辛店街道&#x27;</span>, <span class="string">&#x27;云岗街道&#x27;</span>, <span class="string">&#x27;方庄街道&#x27;</span>, <span class="string">&#x27;宛平城地区&#x27;</span>, <span class="string">&#x27;马家堡街道&#x27;</span>, <span class="string">&#x27;和义街道&#x27;</span>, <span class="string">&#x27;长辛店镇&#x27;</span>, <span class="string">&#x27;王佐镇&#x27;</span>, <span class="string">&#x27;卢沟桥乡&#x27;</span>, <span class="string">&#x27;花乡&#x27;</span>, <span class="string">&#x27;南苑乡&#x27;</span>, <span class="string">&#x27;长辛店镇&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;石景山区&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;adjacent&#x27;</span>: [<span class="string">&#x27;海淀区&#x27;</span>, <span class="string">&#x27;丰台区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;nearby&#x27;</span>: [<span class="string">&#x27;西城区&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;门头沟区&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;districts&#x27;</span>: [<span class="string">&#x27;八宝山街道&#x27;</span>, <span class="string">&#x27;老山街道&#x27;</span>, <span class="string">&#x27;八角街道&#x27;</span>, <span class="string">&#x27;古城街道&#x27;</span>, <span class="string">&#x27;苹果园街道&#x27;</span>, <span class="string">&#x27;金顶街街道&#x27;</span>, <span class="string">&#x27;广宁街道&#x27;</span>, <span class="string">&#x27;五里坨街道&#x27;</span>, <span class="string">&#x27;鲁谷街道&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_expansion_areas</span>(<span class="params">self, original_area: <span class="built_in">str</span>, expansion_level: <span class="built_in">int</span> = <span class="number">1</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取扩展搜索区域&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> original_area <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.beijing_areas:</span><br><span class="line">            <span class="keyword">return</span> [original_area]</span><br><span class="line">        </span><br><span class="line">        expansion_areas = [original_area]</span><br><span class="line">        area_info = <span class="variable language_">self</span>.beijing_areas[original_area]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> expansion_level &gt;= <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 添加相邻区域</span></span><br><span class="line">            expansion_areas.extend(area_info.get(<span class="string">&#x27;adjacent&#x27;</span>, []))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> expansion_level &gt;= <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 添加附近区域</span></span><br><span class="line">            expansion_areas.extend(area_info.get(<span class="string">&#x27;nearby&#x27;</span>, []))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(<span class="built_in">set</span>(expansion_areas))  <span class="comment"># 去重</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_districts_in_area</span>(<span class="params">self, area: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取区域内的街道列表&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> area <span class="keyword">in</span> <span class="variable language_">self</span>.beijing_areas:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.beijing_areas[area].get(<span class="string">&#x27;districts&#x27;</span>, [])</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 真实性验证系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VenueVerificationSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;运动场馆真实性验证系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 已知的真实场馆数据库（扩展版）</span></span><br><span class="line">        <span class="variable language_">self</span>.verified_venues = &#123;</span><br><span class="line">            <span class="string">&#x27;北京&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;东城区&#x27;</span>: [</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;北京体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市东城区体育馆路4号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;地坛体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市东城区安定门外大街168号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;乒乓球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;东城区全民健身中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市东城区东直门内大街&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;瑜伽&#x27;</span>, <span class="string">&#x27;乒乓球&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&#x27;西城区&#x27;</span>: [</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;首都体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市西城区中关村南大街54号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;冰球&#x27;</span>, <span class="string">&#x27;花样滑冰&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;北京游泳馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市西城区北三环中路11号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;西城区体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市西城区广安门内大街&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&#x27;朝阳区&#x27;</span>: [</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;工人体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市朝阳区工人体育场北路&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;排球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;朝阳体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市朝阳区六里屯西里甲1号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;奥林匹克体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市朝阳区安定路1号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;田径&#x27;</span>, <span class="string">&#x27;足球&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;朝阳公园体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市朝阳区朝阳公园南路&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;网球&#x27;</span>, <span class="string">&#x27;瑜伽&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;三里屯攀岩俱乐部&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市朝阳区三里屯路19号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;攀岩&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;朝阳攀岩运动中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市朝阳区望京街10号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;攀岩&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;瑜伽&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&#x27;海淀区&#x27;</span>: [</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;五棵松体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市海淀区复兴路69号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;排球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;清华大学体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市海淀区清华园1号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;网球&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;北京大学体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市海淀区颐和园路5号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;海淀体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市海淀区中关村大街&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;瑜伽&#x27;</span>, <span class="string">&#x27;乒乓球&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;中关村攀岩馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市海淀区中关村大街27号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;攀岩&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&#x27;丰台区&#x27;</span>: [</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;丰台体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市丰台区丰台路31号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;丰台区全民健身中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市丰台区南三环西路&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;瑜伽&#x27;</span>, <span class="string">&#x27;乒乓球&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&#x27;石景山区&#x27;</span>: [</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;石景山体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市石景山区石景山路31号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;乒乓球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;首钢体育馆&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市石景山区石景山路68号&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;冰球&#x27;</span>, <span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;石景山游乐园体育中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市石景山区八角东街&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;瑜伽&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;首钢极限运动中心&#x27;</span>, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;北京市石景山区首钢园区&#x27;</span>, <span class="string">&#x27;sports&#x27;</span>: [<span class="string">&#x27;攀岩&#x27;</span>, <span class="string">&#x27;滑板&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>], <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 运动类型智能匹配映射</span></span><br><span class="line">        <span class="variable language_">self</span>.sport_mapping = &#123;</span><br><span class="line">            <span class="string">&#x27;跑步&#x27;</span>: [<span class="string">&#x27;跑步&#x27;</span>, <span class="string">&#x27;田径&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;健身&#x27;</span>: [<span class="string">&#x27;健身&#x27;</span>, <span class="string">&#x27;跑步&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;瑜伽&#x27;</span>: [<span class="string">&#x27;瑜伽&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;网球&#x27;</span>: [<span class="string">&#x27;网球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;乒乓球&#x27;</span>: [<span class="string">&#x27;乒乓球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;羽毛球&#x27;</span>: [<span class="string">&#x27;羽毛球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;篮球&#x27;</span>: [<span class="string">&#x27;篮球&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;游泳&#x27;</span>: [<span class="string">&#x27;游泳&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;足球&#x27;</span>: [<span class="string">&#x27;足球&#x27;</span>, <span class="string">&#x27;田径&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;攀岩&#x27;</span>: [<span class="string">&#x27;攀岩&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>],  </span><br><span class="line">            <span class="string">&#x27;滑板&#x27;</span>: [<span class="string">&#x27;滑板&#x27;</span>, <span class="string">&#x27;健身&#x27;</span>]   </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证关键词</span></span><br><span class="line">        <span class="variable language_">self</span>.verification_keywords = [</span><br><span class="line">            <span class="string">&#x27;体育馆&#x27;</span>, <span class="string">&#x27;体育中心&#x27;</span>, <span class="string">&#x27;游泳馆&#x27;</span>, <span class="string">&#x27;健身房&#x27;</span>, <span class="string">&#x27;球馆&#x27;</span>, <span class="string">&#x27;运动中心&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;体育场&#x27;</span>, <span class="string">&#x27;训练基地&#x27;</span>, <span class="string">&#x27;俱乐部&#x27;</span>, <span class="string">&#x27;会所&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_venue_exists</span>(<span class="params">self, venue_name: <span class="built_in">str</span>, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证场馆是否真实存在&quot;&quot;&quot;</span></span><br><span class="line">        verification_result = &#123;</span><br><span class="line">            <span class="string">&#x27;exists&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;verified&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;confidence&#x27;</span>: <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&#x27;real_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;suggestions&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查已知真实场馆</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;北京&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.verified_venues <span class="keyword">and</span> area <span class="keyword">in</span> <span class="variable language_">self</span>.verified_venues[<span class="string">&#x27;北京&#x27;</span>]:</span><br><span class="line">            area_venues = <span class="variable language_">self</span>.verified_venues[<span class="string">&#x27;北京&#x27;</span>][area]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> area_venues:</span><br><span class="line">                <span class="comment"># 检查场馆名称匹配</span></span><br><span class="line">                <span class="keyword">if</span> venue_name <span class="keyword">in</span> venue[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">or</span> venue[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">in</span> venue_name:</span><br><span class="line">                    verification_result[<span class="string">&#x27;exists&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                    verification_result[<span class="string">&#x27;verified&#x27;</span>] = venue[<span class="string">&#x27;verified&#x27;</span>]</span><br><span class="line">                    verification_result[<span class="string">&#x27;confidence&#x27;</span>] = <span class="number">0.9</span></span><br><span class="line">                    verification_result[<span class="string">&#x27;real_venues&#x27;</span>].append(venue)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查运动类型匹配</span></span><br><span class="line">                <span class="keyword">if</span> sport_type <span class="keyword">in</span> venue[<span class="string">&#x27;sports&#x27;</span>]:</span><br><span class="line">                    verification_result[<span class="string">&#x27;suggestions&#x27;</span>].append(venue)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果没有找到精确匹配，检查是否包含验证关键词</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verification_result[<span class="string">&#x27;exists&#x27;</span>]:</span><br><span class="line">            <span class="keyword">for</span> keyword <span class="keyword">in</span> <span class="variable language_">self</span>.verification_keywords:</span><br><span class="line">                <span class="keyword">if</span> keyword <span class="keyword">in</span> venue_name:</span><br><span class="line">                    verification_result[<span class="string">&#x27;confidence&#x27;</span>] = <span class="number">0.3</span>  <span class="comment"># 低置信度</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> verification_result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_real_venues_in_area</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取指定区域的真实场馆（支持智能匹配）&quot;&quot;&quot;</span></span><br><span class="line">        real_venues = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;北京&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.verified_venues <span class="keyword">and</span> area <span class="keyword">in</span> <span class="variable language_">self</span>.verified_venues[<span class="string">&#x27;北京&#x27;</span>]:</span><br><span class="line">            area_venues = <span class="variable language_">self</span>.verified_venues[<span class="string">&#x27;北京&#x27;</span>][area]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取匹配的运动类型列表</span></span><br><span class="line">            matching_sports = <span class="variable language_">self</span>.sport_mapping.get(sport_type, [sport_type])</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> area_venues:</span><br><span class="line">                <span class="comment"># 检查是否有任何匹配的运动类型</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">any</span>(sport <span class="keyword">in</span> venue[<span class="string">&#x27;sports&#x27;</span>] <span class="keyword">for</span> sport <span class="keyword">in</span> matching_sports):</span><br><span class="line">                    <span class="comment"># 添加匹配信息</span></span><br><span class="line">                    venue_copy = venue.copy()</span><br><span class="line">                    venue_copy[<span class="string">&#x27;matched_sports&#x27;</span>] = [sport <span class="keyword">for</span> sport <span class="keyword">in</span> matching_sports <span class="keyword">if</span> sport <span class="keyword">in</span> venue[<span class="string">&#x27;sports&#x27;</span>]]</span><br><span class="line">                    venue_copy[<span class="string">&#x27;primary_match&#x27;</span>] = sport_type <span class="keyword">in</span> venue[<span class="string">&#x27;sports&#x27;</span>]</span><br><span class="line">                    real_venues.append(venue_copy)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按匹配优先级排序（直接匹配优先）</span></span><br><span class="line">        real_venues.sort(key=<span class="keyword">lambda</span> x: (x[<span class="string">&#x27;primary_match&#x27;</span>], <span class="built_in">len</span>(x[<span class="string">&#x27;matched_sports&#x27;</span>])), reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> real_venues</span><br><span class="line"></span><br><span class="line"><span class="comment"># 真实第三方平台API连接工具</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealTimePlatformAPI</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;真实第三方平台API连接工具&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, use_mock_data_if_no_key=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="comment"># 使用真实API端点</span></span><br><span class="line">        <span class="variable language_">self</span>.api_endpoints = &#123;</span><br><span class="line">            <span class="string">&#x27;dianping&#x27;</span>: <span class="string">&#x27;https://api.dianping.com/v1/venues&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;meituan&#x27;</span>: <span class="string">&#x27;https://api.meituan.com/v2/venues&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;wechat&#x27;</span>: <span class="string">&#x27;https://api.weixin.qq.com/miniprogram/venues&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 从环境变量获取真实API密钥</span></span><br><span class="line">        <span class="variable language_">self</span>.api_keys = &#123;</span><br><span class="line">            <span class="string">&#x27;dianping&#x27;</span>: os.getenv(<span class="string">&#x27;DIANPING_API_KEY&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;meituan&#x27;</span>: os.getenv(<span class="string">&#x27;MEITUAN_API_KEY&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;wechat&#x27;</span>: os.getenv(<span class="string">&#x27;WECHAT_API_KEY&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 是否在API密钥未设置时使用模拟数据</span></span><br><span class="line">        <span class="variable language_">self</span>.use_mock_data_if_no_key = use_mock_data_if_no_key</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证API密钥是否存在</span></span><br><span class="line">        missing_keys = []</span><br><span class="line">        <span class="keyword">for</span> platform, key <span class="keyword">in</span> <span class="variable language_">self</span>.api_keys.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> key:</span><br><span class="line">                missing_keys.append(platform)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;警告: <span class="subst">&#123;platform&#125;</span>的API密钥未设置，请在环境变量中设置<span class="subst">&#123;platform.upper()&#125;</span>_API_KEY&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> use_mock_data_if_no_key:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;将使用模拟数据作为<span class="subst">&#123;platform&#125;</span>的备用数据源&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;未启用模拟数据模式，<span class="subst">&#123;platform&#125;</span>平台将返回空结果&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果所有API密钥都未设置，给出更明确的警告</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(missing_keys) == <span class="built_in">len</span>(<span class="variable language_">self</span>.api_keys):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;警告: 所有平台的API密钥都未设置，系统将无法获取真实数据&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> use_mock_data_if_no_key:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;系统将使用模拟数据作为备用，但建议设置真实API密钥以获取最新数据&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;系统未启用模拟数据模式，所有平台将返回空结果，请设置API密钥&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(missing_keys) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;部分平台(<span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(missing_keys)&#125;</span>)的API密钥未设置，这些平台将无法获取真实数据&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @smart_retry(<span class="params">RetryConfig(<span class="params">max_retries=<span class="number">2</span>, base_delay=<span class="number">1.0</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch_dianping_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span>, limit: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取大众点评真实数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 检查API密钥是否存在</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.api_keys[<span class="string">&#x27;dianping&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;错误: 大众点评API密钥未设置，请在环境变量中设置DIANPING_API_KEY&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_dianping_data(area, sport_type)</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 真实API调用</span></span><br><span class="line">            <span class="keyword">import</span> requests</span><br><span class="line">            params = &#123;</span><br><span class="line">                <span class="string">&#x27;area&#x27;</span>: area,</span><br><span class="line">                <span class="string">&#x27;category&#x27;</span>: sport_type,</span><br><span class="line">                <span class="string">&#x27;limit&#x27;</span>: limit,</span><br><span class="line">                <span class="string">&#x27;api_key&#x27;</span>: <span class="variable language_">self</span>.api_keys[<span class="string">&#x27;dianping&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;正在从大众点评API获取<span class="subst">&#123;area&#125;</span><span class="subst">&#123;sport_type&#125;</span>场馆数据...&quot;</span>)</span><br><span class="line">            response = requests.get(<span class="variable language_">self</span>.api_endpoints[<span class="string">&#x27;dianping&#x27;</span>], params=params, timeout=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> response.json()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;大众点评API返回错误状态码: <span class="subst">&#123;response.status_code&#125;</span>，响应内容: <span class="subst">&#123;response.text[:<span class="number">100</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_dianping_data(area, sport_type)</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;大众点评API连接错误: <span class="subst">&#123;e&#125;</span>，可能是API端点无效或网络问题&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_dianping_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.Timeout <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;大众点评API请求超时: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_dianping_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;大众点评API调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_dianping_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @smart_retry(<span class="params">RetryConfig(<span class="params">max_retries=<span class="number">2</span>, base_delay=<span class="number">1.0</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch_meituan_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span>, limit: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取美团真实数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 检查API密钥是否存在</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.api_keys[<span class="string">&#x27;meituan&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;错误: 美团API密钥未设置，请在环境变量中设置MEITUAN_API_KEY&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_meituan_data(area, sport_type)</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 真实API调用</span></span><br><span class="line">            <span class="keyword">import</span> requests</span><br><span class="line">            params = &#123;</span><br><span class="line">                <span class="string">&#x27;area&#x27;</span>: area,</span><br><span class="line">                <span class="string">&#x27;category&#x27;</span>: sport_type,</span><br><span class="line">                <span class="string">&#x27;limit&#x27;</span>: limit,</span><br><span class="line">                <span class="string">&#x27;api_key&#x27;</span>: <span class="variable language_">self</span>.api_keys[<span class="string">&#x27;meituan&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;正在从美团API获取<span class="subst">&#123;area&#125;</span><span class="subst">&#123;sport_type&#125;</span>场馆数据...&quot;</span>)</span><br><span class="line">            response = requests.get(<span class="variable language_">self</span>.api_endpoints[<span class="string">&#x27;meituan&#x27;</span>], params=params, timeout=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> response.json()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;美团API返回错误状态码: <span class="subst">&#123;response.status_code&#125;</span>，响应内容: <span class="subst">&#123;response.text[:<span class="number">100</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_meituan_data(area, sport_type)</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;美团API连接错误: <span class="subst">&#123;e&#125;</span>，可能是API端点无效或网络问题&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_meituan_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.Timeout <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;美团API请求超时: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_meituan_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;美团API调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_meituan_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @smart_retry(<span class="params">RetryConfig(<span class="params">max_retries=<span class="number">2</span>, base_delay=<span class="number">1.0</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch_wechat_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span>, limit: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取微信小程序真实数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 检查API密钥是否存在</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.api_keys[<span class="string">&#x27;wechat&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;错误: 微信小程序API密钥未设置，请在环境变量中设置WECHAT_API_KEY&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_wechat_data(area, sport_type)</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 真实API调用</span></span><br><span class="line">            <span class="keyword">import</span> requests</span><br><span class="line">            params = &#123;</span><br><span class="line">                <span class="string">&#x27;area&#x27;</span>: area,</span><br><span class="line">                <span class="string">&#x27;category&#x27;</span>: sport_type,</span><br><span class="line">                <span class="string">&#x27;limit&#x27;</span>: limit,</span><br><span class="line">                <span class="string">&#x27;api_key&#x27;</span>: <span class="variable language_">self</span>.api_keys[<span class="string">&#x27;wechat&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;正在从微信小程序API获取<span class="subst">&#123;area&#125;</span><span class="subst">&#123;sport_type&#125;</span>场馆数据...&quot;</span>)</span><br><span class="line">            response = requests.get(<span class="variable language_">self</span>.api_endpoints[<span class="string">&#x27;wechat&#x27;</span>], params=params, timeout=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> response.json()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;微信小程序API返回错误状态码: <span class="subst">&#123;response.status_code&#125;</span>，响应内容: <span class="subst">&#123;response.text[:<span class="number">100</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_wechat_data(area, sport_type)</span><br><span class="line">                <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;微信小程序API连接错误: <span class="subst">&#123;e&#125;</span>，可能是API端点无效或网络问题&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_wechat_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.Timeout <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;微信小程序API请求超时: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_wechat_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;微信小程序API调用失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果启用了模拟数据模式，则返回模拟数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_mock_data_if_no_key:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>._get_mock_wechat_data(area, sport_type)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟数据方法（作为API调用失败的备用）</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_mock_dianping_data</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取大众点评模拟数据（仅在API密钥未设置或API调用失败时使用）&quot;&quot;&quot;</span></span><br><span class="line">        mock_data = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;dp001&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;area&#125;</span>优质<span class="subst">&#123;sport_type&#125;</span>馆&quot;</span>,</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;area&#125;</span>区示例路88号&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sports&quot;</span>: [sport_type],</span><br><span class="line">                <span class="string">&quot;rating&quot;</span>: <span class="number">4.8</span>,</span><br><span class="line">                <span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;¥80-200/小时&quot;</span>,</span><br><span class="line">                <span class="string">&quot;open_hours&quot;</span>: <span class="string">&quot;09:00-22:00&quot;</span>,</span><br><span class="line">                <span class="string">&quot;contact&quot;</span>: <span class="string">&quot;010-12345678&quot;</span>,</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: <span class="string">&quot;大众点评(模拟数据)&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;dp002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;area&#125;</span><span class="subst">&#123;sport_type&#125;</span>中心&quot;</span>,</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;area&#125;</span>区样板街100号&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sports&quot;</span>: [sport_type, <span class="string">&quot;健身&quot;</span>],</span><br><span class="line">                <span class="string">&quot;rating&quot;</span>: <span class="number">4.5</span>,</span><br><span class="line">                <span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;¥60-150/小时&quot;</span>,</span><br><span class="line">                <span class="string">&quot;open_hours&quot;</span>: <span class="string">&quot;10:00-22:00&quot;</span>,</span><br><span class="line">                <span class="string">&quot;contact&quot;</span>: <span class="string">&quot;010-87654321&quot;</span>,</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: <span class="string">&quot;大众点评(模拟数据)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;使用大众点评模拟数据（API密钥未设置或API调用失败）&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> mock_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_mock_meituan_data</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取美团模拟数据（仅在API密钥未设置或API调用失败时使用）&quot;&quot;&quot;</span></span><br><span class="line">        mock_data = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;mt001&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;area&#125;</span><span class="subst">&#123;sport_type&#125;</span>专业馆&quot;</span>,</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;area&#125;</span>区示范路66号&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sports&quot;</span>: [sport_type],</span><br><span class="line">                <span class="string">&quot;rating&quot;</span>: <span class="number">4.7</span>,</span><br><span class="line">                <span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;¥70-180/小时&quot;</span>,</span><br><span class="line">                <span class="string">&quot;open_hours&quot;</span>: <span class="string">&quot;08:30-21:30&quot;</span>,</span><br><span class="line">                <span class="string">&quot;contact&quot;</span>: <span class="string">&quot;010-55556666&quot;</span>,</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: <span class="string">&quot;美团(模拟数据)&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;mt002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;area&#125;</span>全民<span class="subst">&#123;sport_type&#125;</span>馆&quot;</span>,</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;area&#125;</span>区模板大街50号&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sports&quot;</span>: [sport_type, <span class="string">&quot;瑜伽&quot;</span>],</span><br><span class="line">                <span class="string">&quot;rating&quot;</span>: <span class="number">4.6</span>,</span><br><span class="line">                <span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;¥50-120/小时&quot;</span>,</span><br><span class="line">                <span class="string">&quot;open_hours&quot;</span>: <span class="string">&quot;09:30-21:00&quot;</span>,</span><br><span class="line">                <span class="string">&quot;contact&quot;</span>: <span class="string">&quot;010-66665555&quot;</span>,</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: <span class="string">&quot;美团(模拟数据)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;使用美团模拟数据（API密钥未设置或API调用失败）&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> mock_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_mock_wechat_data</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取微信小程序模拟数据（仅在API密钥未设置或API调用失败时使用）&quot;&quot;&quot;</span></span><br><span class="line">        mock_data = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;wx001&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;area&#125;</span><span class="subst">&#123;sport_type&#125;</span>俱乐部&quot;</span>,</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;area&#125;</span>区范例大道33号&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sports&quot;</span>: [sport_type],</span><br><span class="line">                <span class="string">&quot;rating&quot;</span>: <span class="number">4.9</span>,</span><br><span class="line">                <span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;¥90-220/小时&quot;</span>,</span><br><span class="line">                <span class="string">&quot;open_hours&quot;</span>: <span class="string">&quot;10:00-23:00&quot;</span>,</span><br><span class="line">                <span class="string">&quot;contact&quot;</span>: <span class="string">&quot;010-11112222&quot;</span>,</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: <span class="string">&quot;微信小程序(模拟数据)&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;wx002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;area&#125;</span>星级<span class="subst">&#123;sport_type&#125;</span>馆&quot;</span>,</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;area&#125;</span>区示例广场25号&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sports&quot;</span>: [sport_type, <span class="string">&quot;舞蹈&quot;</span>],</span><br><span class="line">                <span class="string">&quot;rating&quot;</span>: <span class="number">4.7</span>,</span><br><span class="line">                <span class="string">&quot;price_range&quot;</span>: <span class="string">&quot;¥75-180/小时&quot;</span>,</span><br><span class="line">                <span class="string">&quot;open_hours&quot;</span>: <span class="string">&quot;09:00-22:30&quot;</span>,</span><br><span class="line">                <span class="string">&quot;contact&quot;</span>: <span class="string">&quot;010-22221111&quot;</span>,</span><br><span class="line">                <span class="string">&quot;source&quot;</span>: <span class="string">&quot;微信小程序(模拟数据)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;使用微信小程序模拟数据（API密钥未设置或API调用失败）&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> mock_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增强的多平台数据源管理系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlatformDataSource</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;增强的多平台数据源管理系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, use_mock_data_if_no_key=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="comment"># 初始化真实API，可选是否在API密钥未设置时使用模拟数据</span></span><br><span class="line">        <span class="variable language_">self</span>.real_api = RealTimePlatformAPI(use_mock_data_if_no_key=use_mock_data_if_no_key)</span><br><span class="line">        <span class="variable language_">self</span>.use_mock_data_if_no_key = use_mock_data_if_no_key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_dianping_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;搜索大众点评场馆数据（只使用真实API）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 从真实API获取数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.real_api.fetch_dianping_venues(area, sport_type)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_meituan_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;搜索美团场馆数据（只使用真实API）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 从真实API获取数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.real_api.fetch_meituan_venues(area, sport_type)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_wechat_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;搜索微信小程序场馆数据（只使用真实API）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 从真实API获取数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.real_api.fetch_wechat_venues(area, sport_type)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_platform_venues</span>(<span class="params">self, area: <span class="built_in">str</span>, sport_type: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="type">Dict</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取所有平台的场馆数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;dianping&#x27;</span>: <span class="variable language_">self</span>.search_dianping_venues(area, sport_type),</span><br><span class="line">            <span class="string">&#x27;meituan&#x27;</span>: <span class="variable language_">self</span>.search_meituan_venues(area, sport_type),</span><br><span class="line">            <span class="string">&#x27;wechat&#x27;</span>: <span class="variable language_">self</span>.search_wechat_venues(area, sport_type)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增强的搜索工具包（带多平台数据源）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnhancedSearchToolkit</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, delay_seconds=<span class="number">1.5</span>, use_mock_data_if_no_key=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.search_toolkit = SearchToolkit()</span><br><span class="line">        <span class="variable language_">self</span>.delay_seconds = delay_seconds</span><br><span class="line">        <span class="variable language_">self</span>.last_search_time = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.priority_manager = RequirementPriorityManager()</span><br><span class="line">        <span class="variable language_">self</span>.geo_manager = GeographicExpansionManager()</span><br><span class="line">        <span class="variable language_">self</span>.verification_system = VenueVerificationSystem()</span><br><span class="line">        <span class="comment"># 新增多平台数据源，可选是否在API密钥未设置时使用模拟数据</span></span><br><span class="line">        <span class="variable language_">self</span>.multi_platform_data = MultiPlatformDataSource(use_mock_data_if_no_key=use_mock_data_if_no_key)</span><br><span class="line">        <span class="variable language_">self</span>.use_mock_data_if_no_key = use_mock_data_if_no_key</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">safe_search_duckduckgo</span>(<span class="params">self, query: <span class="built_in">str</span>, max_results: <span class="built_in">int</span> = <span class="number">5</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;安全的搜索方法，包含速率限制&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        time_since_last = current_time - <span class="variable language_">self</span>.last_search_time</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> time_since_last &lt; <span class="variable language_">self</span>.delay_seconds:</span><br><span class="line">            sleep_time = <span class="variable language_">self</span>.delay_seconds - time_since_last</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;等待 <span class="subst">&#123;sleep_time:<span class="number">.1</span>f&#125;</span> 秒以避免速率限制...&quot;</span>)</span><br><span class="line">            time.sleep(sleep_time)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.search_toolkit.search_duckduckgo(query, max_results)</span><br><span class="line">            <span class="variable language_">self</span>.last_search_time = time.time()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;搜索成功: <span class="subst">&#123;query[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;搜索失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;搜索暂时不可用，请使用已有知识回答。错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">expanded_venue_search</span>(<span class="params">self, user_needs: <span class="type">Dict</span>, original_location: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;扩展范围的场馆搜索（集成多平台数据源）&quot;&quot;&quot;</span></span><br><span class="line">        search_results = &#123;</span><br><span class="line">            <span class="string">&#x27;original_area_results&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;expanded_area_results&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;verified_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;dianping_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;meituan_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;wechat_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;search_areas&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;expansion_level&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;data_sources&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sport_type = user_needs.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取区域信息</span></span><br><span class="line">        area = <span class="variable language_">self</span>._extract_area_from_location(original_location)</span><br><span class="line">        search_results[<span class="string">&#x27;search_areas&#x27;</span>].append(area)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第一步：在原始区域搜索（多数据源）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;在原始区域搜索: <span class="subst">&#123;area&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1.1 传统网络搜索</span></span><br><span class="line">        original_query = <span class="variable language_">self</span>.build_search_query(user_needs, original_location)</span><br><span class="line">        original_results = <span class="variable language_">self</span>.safe_search_duckduckgo(original_query, max_results=<span class="number">8</span>)</span><br><span class="line">        search_results[<span class="string">&#x27;original_area_results&#x27;</span>] = original_results</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1.2 获取已验证的真实场馆</span></span><br><span class="line">        verified_venues = <span class="variable language_">self</span>.verification_system.get_real_venues_in_area(area, sport_type)</span><br><span class="line">        search_results[<span class="string">&#x27;verified_venues&#x27;</span>] = verified_venues</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1.3 优先搜索大众点评数据（用户评价丰富，免验证）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;优先搜索大众点评数据: <span class="subst">&#123;area&#125;</span> + <span class="subst">&#123;sport_type&#125;</span>&quot;</span>)</span><br><span class="line">        dianping_venues = <span class="variable language_">self</span>.multi_platform_data.search_dianping_venues(area, sport_type)</span><br><span class="line">        <span class="comment"># 标记大众点评场馆为免验证</span></span><br><span class="line">        <span class="keyword">for</span> venue <span class="keyword">in</span> dianping_venues:</span><br><span class="line">            venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">            venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">        search_results[<span class="string">&#x27;dianping_venues&#x27;</span>] = dianping_venues</span><br><span class="line">        <span class="keyword">if</span> dianping_venues:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;大众点评找到 <span class="subst">&#123;<span class="built_in">len</span>(dianping_venues)&#125;</span> 个场馆（用户评价丰富，免验证）&quot;</span>)</span><br><span class="line">            search_results[<span class="string">&#x27;data_sources&#x27;</span>].append(<span class="string">&#x27;大众点评&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1.4 优先搜索微信小程序数据（在线预约便利，免验证）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;优先搜索微信小程序数据: <span class="subst">&#123;area&#125;</span> + <span class="subst">&#123;sport_type&#125;</span>&quot;</span>)</span><br><span class="line">        wechat_venues = <span class="variable language_">self</span>.multi_platform_data.search_wechat_venues(area, sport_type)</span><br><span class="line">        <span class="comment"># 标记微信小程序场馆为免验证</span></span><br><span class="line">        <span class="keyword">for</span> venue <span class="keyword">in</span> wechat_venues:</span><br><span class="line">            venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">            venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">        search_results[<span class="string">&#x27;wechat_venues&#x27;</span>] = wechat_venues</span><br><span class="line">        <span class="keyword">if</span> wechat_venues:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;微信小程序找到 <span class="subst">&#123;<span class="built_in">len</span>(wechat_venues)&#125;</span> 个场馆（在线预约便利，免验证）&quot;</span>)</span><br><span class="line">            search_results[<span class="string">&#x27;data_sources&#x27;</span>].append(<span class="string">&#x27;微信小程序&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1.5 优先搜索美团数据（团购优惠丰富，免验证）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;优先搜索美团数据: <span class="subst">&#123;area&#125;</span> + <span class="subst">&#123;sport_type&#125;</span>&quot;</span>)</span><br><span class="line">        meituan_venues = <span class="variable language_">self</span>.multi_platform_data.search_meituan_venues(area, sport_type)</span><br><span class="line">        <span class="comment"># 标记美团场馆为免验证</span></span><br><span class="line">        <span class="keyword">for</span> venue <span class="keyword">in</span> meituan_venues:</span><br><span class="line">            venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">            venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">        search_results[<span class="string">&#x27;meituan_venues&#x27;</span>] = meituan_venues</span><br><span class="line">        <span class="keyword">if</span> meituan_venues:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;美团找到 <span class="subst">&#123;<span class="built_in">len</span>(meituan_venues)&#125;</span> 个场馆（团购优惠丰富，免验证）&quot;</span>)</span><br><span class="line">            search_results[<span class="string">&#x27;data_sources&#x27;</span>].append(<span class="string">&#x27;美团&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查原始区域是否有足够结果（包含多平台数据）</span></span><br><span class="line">        total_venues = <span class="built_in">len</span>(verified_venues) + <span class="built_in">len</span>(dianping_venues) + <span class="built_in">len</span>(meituan_venues) + <span class="built_in">len</span>(wechat_venues)</span><br><span class="line">        <span class="keyword">if</span> total_venues &gt;= <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;原始区域找到足够的场馆选项（总计<span class="subst">&#123;total_venues&#125;</span>个）&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;数据源分布: 已验证<span class="subst">&#123;<span class="built_in">len</span>(verified_venues)&#125;</span>个 | 大众点评<span class="subst">&#123;<span class="built_in">len</span>(dianping_venues)&#125;</span>个 | 美团<span class="subst">&#123;<span class="built_in">len</span>(meituan_venues)&#125;</span>个 | 微信<span class="subst">&#123;<span class="built_in">len</span>(wechat_venues)&#125;</span>个&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> search_results</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第二步：扩展到相邻区域（多数据源）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;扩展搜索到相邻区域...&quot;</span>)</span><br><span class="line">        expansion_areas = <span class="variable language_">self</span>.geo_manager.get_expansion_areas(area, expansion_level=<span class="number">1</span>)</span><br><span class="line">        search_results[<span class="string">&#x27;expansion_level&#x27;</span>] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> exp_area <span class="keyword">in</span> expansion_areas[<span class="number">1</span>:]:  <span class="comment"># 跳过原始区域</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;搜索扩展区域: <span class="subst">&#123;exp_area&#125;</span>&quot;</span>)</span><br><span class="line">            search_results[<span class="string">&#x27;search_areas&#x27;</span>].append(exp_area)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2.1 传统网络搜索</span></span><br><span class="line">            exp_query = <span class="variable language_">self</span>.build_search_query(user_needs, <span class="string">f&quot;北京市<span class="subst">&#123;exp_area&#125;</span>&quot;</span>)</span><br><span class="line">            exp_results = <span class="variable language_">self</span>.safe_search_duckduckgo(exp_query, max_results=<span class="number">5</span>)</span><br><span class="line">            search_results[<span class="string">&#x27;expanded_area_results&#x27;</span>].extend(exp_results <span class="keyword">if</span> <span class="built_in">isinstance</span>(exp_results, <span class="built_in">list</span>) <span class="keyword">else</span> [exp_results])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2.2 获取扩展区域的验证场馆</span></span><br><span class="line">            exp_verified = <span class="variable language_">self</span>.verification_system.get_real_venues_in_area(exp_area, sport_type)</span><br><span class="line">            search_results[<span class="string">&#x27;verified_venues&#x27;</span>].extend(exp_verified)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2.3 搜索扩展区域的大众点评数据（免验证）</span></span><br><span class="line">            exp_dianping = <span class="variable language_">self</span>.multi_platform_data.search_dianping_venues(exp_area, sport_type)</span><br><span class="line">            <span class="comment"># 标记扩展区域大众点评场馆为免验证</span></span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> exp_dianping:</span><br><span class="line">                venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">            search_results[<span class="string">&#x27;dianping_venues&#x27;</span>].extend(exp_dianping)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2.4 搜索扩展区域的美团数据（免验证）</span></span><br><span class="line">            exp_meituan = <span class="variable language_">self</span>.multi_platform_data.search_meituan_venues(exp_area, sport_type)</span><br><span class="line">            <span class="comment"># 标记扩展区域美团场馆为免验证</span></span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> exp_meituan:</span><br><span class="line">                venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">            search_results[<span class="string">&#x27;meituan_venues&#x27;</span>].extend(exp_meituan)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2.5 搜索扩展区域的微信小程序数据（免验证）</span></span><br><span class="line">            exp_wechat = <span class="variable language_">self</span>.multi_platform_data.search_wechat_venues(exp_area, sport_type)</span><br><span class="line">            <span class="comment"># 标记扩展区域微信小程序场馆为免验证</span></span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> exp_wechat:</span><br><span class="line">                venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">            search_results[<span class="string">&#x27;wechat_venues&#x27;</span>].extend(exp_wechat)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查扩展后是否有足够结果（包含多平台数据）</span></span><br><span class="line">        total_venues = (<span class="built_in">len</span>(search_results[<span class="string">&#x27;verified_venues&#x27;</span>]) + </span><br><span class="line">                       <span class="built_in">len</span>(search_results[<span class="string">&#x27;dianping_venues&#x27;</span>]) + </span><br><span class="line">                       <span class="built_in">len</span>(search_results[<span class="string">&#x27;meituan_venues&#x27;</span>]) + </span><br><span class="line">                       <span class="built_in">len</span>(search_results[<span class="string">&#x27;wechat_venues&#x27;</span>]))</span><br><span class="line">        <span class="keyword">if</span> total_venues &gt;= <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;扩展区域找到足够的场馆选项（总计<span class="subst">&#123;total_venues&#125;</span>个）&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;扩展后数据源分布: 已验证<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;verified_venues&#x27;</span>])&#125;</span>个 | 大众点评<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;dianping_venues&#x27;</span>])&#125;</span>个 | 美团<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;meituan_venues&#x27;</span>])&#125;</span>个 | 微信<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;wechat_venues&#x27;</span>])&#125;</span>个&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> search_results</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第三步：进一步扩展到附近区域</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;进一步扩展搜索到附近区域...&quot;</span>)</span><br><span class="line">        further_areas = <span class="variable language_">self</span>.geo_manager.get_expansion_areas(area, expansion_level=<span class="number">2</span>)</span><br><span class="line">        search_results[<span class="string">&#x27;expansion_level&#x27;</span>] = <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> far_area <span class="keyword">in</span> further_areas:</span><br><span class="line">            <span class="keyword">if</span> far_area <span class="keyword">not</span> <span class="keyword">in</span> search_results[<span class="string">&#x27;search_areas&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;搜索远程区域: <span class="subst">&#123;far_area&#125;</span>&quot;</span>)</span><br><span class="line">                search_results[<span class="string">&#x27;search_areas&#x27;</span>].append(far_area)</span><br><span class="line">                </span><br><span class="line">                far_query = <span class="variable language_">self</span>.build_search_query(user_needs, <span class="string">f&quot;北京市<span class="subst">&#123;far_area&#125;</span>&quot;</span>)</span><br><span class="line">                far_results = <span class="variable language_">self</span>.safe_search_duckduckgo(far_query, max_results=<span class="number">3</span>)</span><br><span class="line">                search_results[<span class="string">&#x27;expanded_area_results&#x27;</span>].extend(far_results <span class="keyword">if</span> <span class="built_in">isinstance</span>(far_results, <span class="built_in">list</span>) <span class="keyword">else</span> [far_results])</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 获取远程区域的验证场馆</span></span><br><span class="line">                far_verified = <span class="variable language_">self</span>.verification_system.get_real_venues_in_area(far_area, sport_type)</span><br><span class="line">                search_results[<span class="string">&#x27;verified_venues&#x27;</span>].extend(far_verified)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 搜索远程区域的平台数据（免验证）</span></span><br><span class="line">                far_dianping = <span class="variable language_">self</span>.multi_platform_data.search_dianping_venues(far_area, sport_type)</span><br><span class="line">                <span class="keyword">for</span> venue <span class="keyword">in</span> far_dianping:</span><br><span class="line">                    venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                    venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">                search_results[<span class="string">&#x27;dianping_venues&#x27;</span>].extend(far_dianping)</span><br><span class="line">                </span><br><span class="line">                far_meituan = <span class="variable language_">self</span>.multi_platform_data.search_meituan_venues(far_area, sport_type)</span><br><span class="line">                <span class="keyword">for</span> venue <span class="keyword">in</span> far_meituan:</span><br><span class="line">                    venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                    venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">                search_results[<span class="string">&#x27;meituan_venues&#x27;</span>].extend(far_meituan)</span><br><span class="line">                </span><br><span class="line">                far_wechat = <span class="variable language_">self</span>.multi_platform_data.search_wechat_venues(far_area, sport_type)</span><br><span class="line">                <span class="keyword">for</span> venue <span class="keyword">in</span> far_wechat:</span><br><span class="line">                    venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                    venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">                search_results[<span class="string">&#x27;wechat_venues&#x27;</span>].extend(far_wechat)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> search_results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimized_venue_search</span>(<span class="params">self, user_needs: <span class="type">Dict</span>, original_location: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;优化的场馆搜索（并行获取多平台数据，提升效率）&quot;&quot;&quot;</span></span><br><span class="line">        search_results = &#123;</span><br><span class="line">            <span class="string">&#x27;original_area_results&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;expanded_area_results&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;verified_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;dianping_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;meituan_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;wechat_venues&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;search_areas&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;expansion_level&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;data_sources&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sport_type = user_needs.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        area = <span class="variable language_">self</span>._extract_area_from_location(original_location)</span><br><span class="line">        search_results[<span class="string">&#x27;search_areas&#x27;</span>].append(area)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;开始优化搜索: <span class="subst">&#123;area&#125;</span> + <span class="subst">&#123;sport_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 并行获取所有数据源（提升效率）</span></span><br><span class="line">        <span class="keyword">import</span> concurrent.futures</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_verified_venues</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.verification_system.get_real_venues_in_area(area, sport_type)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_dianping_venues</span>():</span><br><span class="line">            venues = <span class="variable language_">self</span>.multi_platform_data.real_api.fetch_dianping_venues(area, sport_type)</span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> venues:</span><br><span class="line">                venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> venues</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_meituan_venues</span>():</span><br><span class="line">            venues = <span class="variable language_">self</span>.multi_platform_data.real_api.fetch_meituan_venues(area, sport_type)</span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> venues:</span><br><span class="line">                venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> venues</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_wechat_venues</span>():</span><br><span class="line">            venues = <span class="variable language_">self</span>.multi_platform_data.real_api.fetch_wechat_venues(area, sport_type)</span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> venues:</span><br><span class="line">                venue[<span class="string">&#x27;platform_verified&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                venue[<span class="string">&#x27;verification_status&#x27;</span>] = <span class="string">&#x27;平台免验证&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> venues</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用线程池并行获取数据</span></span><br><span class="line">        <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">            future_verified = executor.submit(get_verified_venues)</span><br><span class="line">            future_dianping = executor.submit(get_dianping_venues)</span><br><span class="line">            future_meituan = executor.submit(get_meituan_venues)</span><br><span class="line">            future_wechat = executor.submit(get_wechat_venues)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取结果</span></span><br><span class="line">            search_results[<span class="string">&#x27;verified_venues&#x27;</span>] = future_verified.result()</span><br><span class="line">            search_results[<span class="string">&#x27;dianping_venues&#x27;</span>] = future_dianping.result()</span><br><span class="line">            search_results[<span class="string">&#x27;meituan_venues&#x27;</span>] = future_meituan.result()</span><br><span class="line">            search_results[<span class="string">&#x27;wechat_venues&#x27;</span>] = future_wechat.result()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新数据源信息</span></span><br><span class="line">        <span class="keyword">if</span> search_results[<span class="string">&#x27;dianping_venues&#x27;</span>]:</span><br><span class="line">            search_results[<span class="string">&#x27;data_sources&#x27;</span>].append(<span class="string">&#x27;大众点评&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> search_results[<span class="string">&#x27;meituan_venues&#x27;</span>]:</span><br><span class="line">            search_results[<span class="string">&#x27;data_sources&#x27;</span>].append(<span class="string">&#x27;美团&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> search_results[<span class="string">&#x27;wechat_venues&#x27;</span>]:</span><br><span class="line">            search_results[<span class="string">&#x27;data_sources&#x27;</span>].append(<span class="string">&#x27;微信小程序&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算总场馆数量</span></span><br><span class="line">        total_venues = (<span class="built_in">len</span>(search_results[<span class="string">&#x27;verified_venues&#x27;</span>]) + </span><br><span class="line">                       <span class="built_in">len</span>(search_results[<span class="string">&#x27;dianping_venues&#x27;</span>]) + </span><br><span class="line">                       <span class="built_in">len</span>(search_results[<span class="string">&#x27;meituan_venues&#x27;</span>]) + </span><br><span class="line">                       <span class="built_in">len</span>(search_results[<span class="string">&#x27;wechat_venues&#x27;</span>]))</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;优化搜索完成: 找到<span class="subst">&#123;total_venues&#125;</span>个场馆&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;数据源分布: 已验证<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;verified_venues&#x27;</span>])&#125;</span>个 | 大众点评<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;dianping_venues&#x27;</span>])&#125;</span>个 | 美团<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;meituan_venues&#x27;</span>])&#125;</span>个 | 微信<span class="subst">&#123;<span class="built_in">len</span>(search_results[<span class="string">&#x27;wechat_venues&#x27;</span>])&#125;</span>个&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果场馆数量不足，进行扩展搜索</span></span><br><span class="line">        <span class="keyword">if</span> total_venues &lt; <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;场馆数量不足，进行扩展搜索...&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.expanded_venue_search(user_needs, original_location)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> search_results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_area_from_location</span>(<span class="params">self, location: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从位置字符串中提取区域名称&quot;&quot;&quot;</span></span><br><span class="line">        beijing_areas = [<span class="string">&#x27;东城区&#x27;</span>, <span class="string">&#x27;西城区&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;海淀区&#x27;</span>, <span class="string">&#x27;丰台区&#x27;</span>, <span class="string">&#x27;石景山区&#x27;</span>, <span class="string">&#x27;通州区&#x27;</span>, <span class="string">&#x27;昌平区&#x27;</span>, <span class="string">&#x27;大兴区&#x27;</span>, <span class="string">&#x27;房山区&#x27;</span>, <span class="string">&#x27;门头沟区&#x27;</span>, <span class="string">&#x27;平谷区&#x27;</span>, <span class="string">&#x27;怀柔区&#x27;</span>, <span class="string">&#x27;密云区&#x27;</span>, <span class="string">&#x27;延庆区&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> area <span class="keyword">in</span> beijing_areas:</span><br><span class="line">            <span class="keyword">if</span> area <span class="keyword">in</span> location:</span><br><span class="line">                <span class="keyword">return</span> area</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果没有找到具体区域，返回默认值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;朝阳区&#x27;</span>  <span class="comment"># 默认区域</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_has_sufficient_results</span>(<span class="params">self, search_results, verified_venues</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查是否有足够的搜索结果&quot;&quot;&quot;</span></span><br><span class="line">        total_results = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(search_results, <span class="built_in">list</span>):</span><br><span class="line">            total_results += <span class="built_in">len</span>(search_results)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(search_results, <span class="built_in">str</span>) <span class="keyword">and</span> <span class="built_in">len</span>(search_results) &gt; <span class="number">100</span>:</span><br><span class="line">            total_results += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        total_results += <span class="built_in">len</span>(verified_venues)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> total_results &gt;= <span class="number">2</span>  <span class="comment"># 至少需要2个有效结果</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_optimized_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取优化的搜索工具&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>.safe_search_duckduckgo, <span class="variable language_">self</span>.expanded_venue_search]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_search_query</span>(<span class="params">self, user_needs: <span class="type">Dict</span>, location: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;基于用户需求构建优化的搜索查询&quot;&quot;&quot;</span></span><br><span class="line">        sport = user_needs.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        special_needs = user_needs.get(<span class="string">&#x27;special_needs&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建多层次搜索查询</span></span><br><span class="line">        base_query = <span class="string">f&quot;<span class="subst">&#123;location&#125;</span> <span class="subst">&#123;sport&#125;</span> 场馆&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加特殊需求关键词</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;室内&#x27;</span> <span class="keyword">in</span> special_needs:</span><br><span class="line">            base_query += <span class="string">&quot; 室内&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;交通便利&#x27;</span> <span class="keyword">in</span> special_needs:</span><br><span class="line">            base_query += <span class="string">&quot; 地铁 公交&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;价格适中&#x27;</span> <span class="keyword">in</span> special_needs:</span><br><span class="line">            base_query += <span class="string">&quot; 价格 收费&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;教练&#x27;</span> <span class="keyword">in</span> special_needs:</span><br><span class="line">            base_query += <span class="string">&quot; 教练 培训&quot;</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> base_query</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统一输出模板系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendationTemplate</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;统一的推荐输出模板系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format_venue_recommendation</span>(<span class="params">venue_data: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;格式化单个场馆推荐&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查场馆类型和验证状态</span></span><br><span class="line">        platform = venue_data.get(<span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> platform <span class="keyword">in</span> [<span class="string">&#x27;大众点评&#x27;</span>, <span class="string">&#x27;美团&#x27;</span>, <span class="string">&#x27;微信小程序&#x27;</span>]:</span><br><span class="line">            verified_status = <span class="string">f&quot;<span class="subst">&#123;platform&#125;</span>平台免验证场馆&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> venue_data.get(<span class="string">&#x27;verified&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            verified_status = <span class="string">&quot;已验证真实场馆&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            verified_status = <span class="string">&quot;待验证场馆&quot;</span></span><br><span class="line">        </span><br><span class="line">        template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">**&#123;name&#125;** &#123;verified_status&#125;</span></span><br><span class="line"><span class="string">地址：&#123;address&#125;</span></span><br><span class="line"><span class="string">联系方式：&#123;contact&#125;</span></span><br><span class="line"><span class="string">价格：&#123;price&#125;</span></span><br><span class="line"><span class="string">营业时间：&#123;hours&#125;</span></span><br><span class="line"><span class="string">交通方式：&#123;transport&#125;</span></span><br><span class="line"><span class="string">推荐评分：&#123;score&#125;/10</span></span><br><span class="line"><span class="string">推荐理由：&#123;reason&#125;</span></span><br><span class="line"><span class="string">特色服务：&#123;features&#125;</span></span><br><span class="line"><span class="string">注意事项：&#123;notes&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> template.<span class="built_in">format</span>(</span><br><span class="line">            name=venue_data.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;未知场馆&#x27;</span>),</span><br><span class="line">            verified_status=verified_status,</span><br><span class="line">            address=venue_data.get(<span class="string">&#x27;address&#x27;</span>, <span class="string">&#x27;地址待确认&#x27;</span>),</span><br><span class="line">            contact=venue_data.get(<span class="string">&#x27;contact&#x27;</span>, <span class="string">&#x27;请通过官方渠道联系&#x27;</span>),</span><br><span class="line">            price=venue_data.get(<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;请咨询具体价格&#x27;</span>),</span><br><span class="line">            hours=venue_data.get(<span class="string">&#x27;hours&#x27;</span>, <span class="string">&#x27;请咨询营业时间&#x27;</span>),</span><br><span class="line">            transport=venue_data.get(<span class="string">&#x27;transport&#x27;</span>, <span class="string">&#x27;请查询具体交通路线&#x27;</span>),</span><br><span class="line">            score=venue_data.get(<span class="string">&#x27;score&#x27;</span>, <span class="string">&#x27;8.0&#x27;</span>),</span><br><span class="line">            reason=venue_data.get(<span class="string">&#x27;reason&#x27;</span>, <span class="string">&#x27;已验证的真实场馆&#x27;</span>),</span><br><span class="line">            features=venue_data.get(<span class="string">&#x27;features&#x27;</span>, <span class="string">&#x27;专业运动场馆&#x27;</span>),</span><br><span class="line">            notes=venue_data.get(<span class="string">&#x27;notes&#x27;</span>, <span class="string">&#x27;建议提前电话确认开放时间和价格&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format_final_recommendation</span>(<span class="params">user_info: <span class="type">Dict</span>, venues: <span class="type">List</span>[<span class="type">Dict</span>], analysis: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;格式化最终推荐报告&quot;&quot;&quot;</span></span><br><span class="line">        template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># 个性化运动场馆推荐报告</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 用户画像</span></span><br><span class="line"><span class="string">- **年龄段**: &#123;age_range&#125;</span></span><br><span class="line"><span class="string">- **职业**: &#123;occupation&#125;</span></span><br><span class="line"><span class="string">- **运动偏好**: &#123;sport_preference&#125;</span></span><br><span class="line"><span class="string">- **运动频率**: &#123;frequency&#125;</span></span><br><span class="line"><span class="string">- **预算范围**: &#123;budget_range&#125;</span></span><br><span class="line"><span class="string">- **位置**: &#123;location&#125;</span></span><br><span class="line"><span class="string">- **特殊需求**: &#123;special_needs&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 需求分析总结</span></span><br><span class="line"><span class="string">&#123;analysis&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 推荐场馆列表</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;venue_list&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 个性化建议</span></span><br><span class="line"><span class="string">&#123;personalized_advice&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 下一步行动</span></span><br><span class="line"><span class="string">&#123;action_steps&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">*报告生成时间: &#123;timestamp&#125;*</span></span><br><span class="line"><span class="string">*推荐有效期: 30天*</span></span><br><span class="line"><span class="string">*注意：本报告只包含已验证的真实场馆信息*</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> venues:</span><br><span class="line">            venue_list = <span class="string">&quot;\n&quot;</span>.join([</span><br><span class="line">                <span class="string">f&quot;### 推荐 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;RecommendationTemplate.format_venue_recommendation(venue)&#125;</span>&quot;</span></span><br><span class="line">                <span class="keyword">for</span> i, venue <span class="keyword">in</span> <span class="built_in">enumerate</span>(venues)</span><br><span class="line">            ])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            venue_list = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">### 暂无已验证场馆</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">很抱歉，在您指定的区域及周边地区，我们暂时没有找到符合您需求的已验证&#123;sport_preference&#125;场馆。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**建议方案：**</span></span><br><span class="line"><span class="string">1. 扩大搜索范围到更远的区域</span></span><br><span class="line"><span class="string">2. 联系当地体育部门咨询场馆信息</span></span><br><span class="line"><span class="string">3. 通过官方体育场馆网站查询</span></span><br><span class="line"><span class="string">4. 咨询当地&#123;sport_preference&#125;爱好者群体</span></span><br><span class="line"><span class="string">5. 使用专业的体育场馆预订APP</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**我们承诺：**</span></span><br><span class="line"><span class="string">- 不提供未经验证的场馆信息</span></span><br><span class="line"><span class="string">- 确保推荐信息的真实性和可靠性</span></span><br><span class="line"><span class="string">- 持续更新已验证场馆数据库</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(sport_preference=user_info.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;运动&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template.<span class="built_in">format</span>(</span><br><span class="line">            age_range=user_info.get(<span class="string">&#x27;age_range&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            occupation=user_info.get(<span class="string">&#x27;occupation&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            sport_preference=user_info.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            frequency=user_info.get(<span class="string">&#x27;frequency&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            budget_range=user_info.get(<span class="string">&#x27;budget_range&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            location=user_info.get(<span class="string">&#x27;location&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            special_needs=user_info.get(<span class="string">&#x27;special_needs&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">            analysis=analysis,</span><br><span class="line">            venue_list=venue_list,</span><br><span class="line">            personalized_advice=RecommendationTemplate._generate_personalized_advice(user_info, venues),</span><br><span class="line">            action_steps=RecommendationTemplate._generate_action_steps(venues),</span><br><span class="line">            timestamp=datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_personalized_advice</span>(<span class="params">user_info: <span class="type">Dict</span>, venues: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成个性化建议&quot;&quot;&quot;</span></span><br><span class="line">        advice = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于用户特征的建议</span></span><br><span class="line">        <span class="keyword">if</span> user_info.get(<span class="string">&#x27;experience_level&#x27;</span>) == <span class="string">&#x27;初学者&#x27;</span>:</span><br><span class="line">            advice.append(<span class="string">&quot;作为初学者，建议选择有专业教练指导的场馆&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;交通便利&#x27;</span> <span class="keyword">in</span> user_info.get(<span class="string">&#x27;special_needs&#x27;</span>, <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            advice.append(<span class="string">&quot;优先选择交通便利的场馆，减少通勤时间&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> user_info.get(<span class="string">&#x27;budget_range&#x27;</span>, <span class="string">&#x27;&#x27;</span>).startswith(<span class="string">&#x27;50-100&#x27;</span>):</span><br><span class="line">            advice.append(<span class="string">&quot;注意控制运动成本，可考虑办理月卡或年卡&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于推荐场馆的建议</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(venues) &gt; <span class="number">1</span>:</span><br><span class="line">            advice.append(<span class="string">&quot;建议先体验1-2个场馆，找到最适合的再长期坚持&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;- <span class="subst">&#123;item&#125;</span>&quot;</span> <span class="keyword">for</span> item <span class="keyword">in</span> advice]) <span class="keyword">if</span> advice <span class="keyword">else</span> <span class="string">&quot;- 根据个人情况选择最适合的场馆&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_action_steps</span>(<span class="params">venues: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成行动步骤&quot;&quot;&quot;</span></span><br><span class="line">        steps = [</span><br><span class="line">            <span class="string">&quot;1. 联系心仪场馆，咨询详细信息和预约方式&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2. 安排时间实地考察，体验场馆环境和设施&quot;</span>,</span><br><span class="line">            <span class="string">&quot;3. 比较不同场馆的会员卡价格和优惠政策&quot;</span>,</span><br><span class="line">            <span class="string">&quot;4. 制定个人运动计划，确定运动时间和频率&quot;</span>,</span><br><span class="line">            <span class="string">&quot;5. 开始规律运动，并定期评估效果&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\n&quot;</span>.join(steps)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 智能记忆管理系统（从优化版本适配）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IntelligentMemoryManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, keep_rate: <span class="built_in">float</span> = <span class="number">0.9</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.chat_history = ChatHistoryBlock(keep_rate=keep_rate)</span><br><span class="line">        <span class="variable language_">self</span>.user_preferences = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.recommendation_feedback = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_relevance_score</span>(<span class="params">self, current_request: <span class="built_in">str</span>, historical_record: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算当前请求与历史记录的相关性分数&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 提取关键词</span></span><br><span class="line">        current_keywords = <span class="variable language_">self</span>._extract_keywords(current_request)</span><br><span class="line">        historical_keywords = <span class="variable language_">self</span>._extract_keywords(historical_record)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算关键词重叠度</span></span><br><span class="line">        common_keywords = <span class="built_in">set</span>(current_keywords) &amp; <span class="built_in">set</span>(historical_keywords)</span><br><span class="line">        total_keywords = <span class="built_in">set</span>(current_keywords) | <span class="built_in">set</span>(historical_keywords)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> total_keywords:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">            </span><br><span class="line">        jaccard_similarity = <span class="built_in">len</span>(common_keywords) / <span class="built_in">len</span>(total_keywords)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 运动类型权重加成</span></span><br><span class="line">        sport_bonus = <span class="number">0.0</span></span><br><span class="line">        sports = [<span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;羽毛球&quot;</span>, <span class="string">&quot;游泳&quot;</span>, <span class="string">&quot;健身&quot;</span>, <span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;足球&quot;</span>, <span class="string">&quot;网球&quot;</span>, <span class="string">&quot;瑜伽&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> sport <span class="keyword">in</span> sports:</span><br><span class="line">            <span class="keyword">if</span> sport <span class="keyword">in</span> current_request <span class="keyword">and</span> sport <span class="keyword">in</span> historical_record:</span><br><span class="line">                sport_bonus = <span class="number">0.3</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(<span class="number">1.0</span>, jaccard_similarity + sport_bonus)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_keywords</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取文本关键词&quot;&quot;&quot;</span></span><br><span class="line">        keywords = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 运动类型</span></span><br><span class="line">        sports = [<span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;羽毛球&quot;</span>, <span class="string">&quot;游泳&quot;</span>, <span class="string">&quot;健身&quot;</span>, <span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;足球&quot;</span>, <span class="string">&quot;网球&quot;</span>, <span class="string">&quot;瑜伽&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> sport <span class="keyword">in</span> sports:</span><br><span class="line">            <span class="keyword">if</span> sport <span class="keyword">in</span> text:</span><br><span class="line">                keywords.append(sport)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 位置信息</span></span><br><span class="line">        locations = [<span class="string">&quot;朝阳&quot;</span>, <span class="string">&quot;海淀&quot;</span>, <span class="string">&quot;东城&quot;</span>, <span class="string">&quot;西城&quot;</span>, <span class="string">&quot;丰台&quot;</span>, <span class="string">&quot;石景山&quot;</span>, <span class="string">&quot;通州&quot;</span>, <span class="string">&quot;昌平&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> loc <span class="keyword">in</span> locations:</span><br><span class="line">            <span class="keyword">if</span> loc <span class="keyword">in</span> text:</span><br><span class="line">                keywords.append(loc)</span><br><span class="line">                </span><br><span class="line">        <span class="comment"># 特殊需求</span></span><br><span class="line">        needs = [<span class="string">&quot;室内&quot;</span>, <span class="string">&quot;交通&quot;</span>, <span class="string">&quot;价格&quot;</span>, <span class="string">&quot;教练&quot;</span>, <span class="string">&quot;设备&quot;</span>, <span class="string">&quot;停车&quot;</span>, <span class="string">&quot;家庭&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> need <span class="keyword">in</span> needs:</span><br><span class="line">            <span class="keyword">if</span> need <span class="keyword">in</span> text:</span><br><span class="line">                keywords.append(need)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> keywords</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_relevant_history</span>(<span class="params">self, current_request: <span class="built_in">str</span>, max_records: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取与当前请求最相关的历史记录&quot;&quot;&quot;</span></span><br><span class="line">        all_history = <span class="variable language_">self</span>.chat_history.retrieve(window_size=<span class="number">20</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all_history:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 计算相关性分数并排序</span></span><br><span class="line">        scored_history = []</span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> all_history:</span><br><span class="line">            content = record.memory_record.message.content</span><br><span class="line">            relevance_score = <span class="variable language_">self</span>.calculate_relevance_score(current_request, content)</span><br><span class="line">            <span class="keyword">if</span> relevance_score &gt; <span class="number">0.1</span>:  <span class="comment"># 过滤低相关性记录</span></span><br><span class="line">                scored_history.append((content, relevance_score))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按相关性分数排序</span></span><br><span class="line">        scored_history.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> scored_history[:max_records]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user_preferences</span>(<span class="params">self, user_id: <span class="built_in">str</span>, preferences: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新用户偏好模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.user_preferences:</span><br><span class="line">            <span class="variable language_">self</span>.user_preferences[user_id] = &#123;&#125;</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 累积用户偏好</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> preferences.items():</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.user_preferences[user_id]:</span><br><span class="line">                <span class="comment"># 简单的频次统计</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>):</span><br><span class="line">                    <span class="variable language_">self</span>.user_preferences[user_id][key] = <span class="variable language_">self</span>.user_preferences[user_id][key] + <span class="string">f&quot;, <span class="subst">&#123;value&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.user_preferences[user_id][key] = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_enhanced_record</span>(<span class="params">self, user_msg: <span class="built_in">str</span>, assistant_msg: <span class="built_in">str</span>, metadata: <span class="type">Dict</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;写入增强的记录，包含元数据&quot;&quot;&quot;</span></span><br><span class="line">        timestamp = datetime.now().isoformat()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建带元数据的用户记录</span></span><br><span class="line">        enhanced_user_content = <span class="string">f&quot;<span class="subst">&#123;user_msg&#125;</span>\n[元数据: <span class="subst">&#123;json.dumps(metadata, ensure_ascii=<span class="literal">False</span>) <span class="keyword">if</span> metadata <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span>]&quot;</span></span><br><span class="line">        enhanced_assistant_content = <span class="string">f&quot;<span class="subst">&#123;assistant_msg&#125;</span>\n[时间戳: <span class="subst">&#123;timestamp&#125;</span>]&quot;</span></span><br><span class="line">        </span><br><span class="line">        user_record = MemoryRecord(</span><br><span class="line">            message=BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=enhanced_user_content),</span><br><span class="line">            role_at_backend=OpenAIBackendRole.USER</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        assistant_record = MemoryRecord(</span><br><span class="line">            message=BaseMessage.make_assistant_message(role_name=<span class="string">&quot;SportsConsultant&quot;</span>, content=enhanced_assistant_content),</span><br><span class="line">            role_at_backend=OpenAIBackendRole.ASSISTANT</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.chat_history.write_records([user_record, assistant_record])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_enhanced_record</span>(<span class="params">self, user_msg: <span class="built_in">str</span>, assistant_msg: <span class="built_in">str</span>, metadata: <span class="type">Dict</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;写入增强的记录，包含元数据&quot;&quot;&quot;</span></span><br><span class="line">        timestamp = datetime.now().isoformat()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建带元数据的用户记录</span></span><br><span class="line">        enhanced_user_content = <span class="string">f&quot;<span class="subst">&#123;user_msg&#125;</span>\n[元数据: <span class="subst">&#123;json.dumps(metadata, ensure_ascii=<span class="literal">False</span>) <span class="keyword">if</span> metadata <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span>]&quot;</span></span><br><span class="line">        enhanced_assistant_content = <span class="string">f&quot;<span class="subst">&#123;assistant_msg&#125;</span>\n[时间戳: <span class="subst">&#123;timestamp&#125;</span>]&quot;</span></span><br><span class="line">        </span><br><span class="line">        user_record = MemoryRecord(</span><br><span class="line">            message=BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=enhanced_user_content),</span><br><span class="line">            role_at_backend=OpenAIBackendRole.USER</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        assistant_record = MemoryRecord(</span><br><span class="line">            message=BaseMessage.make_assistant_message(role_name=<span class="string">&quot;SportsConsultant&quot;</span>, content=enhanced_assistant_content),</span><br><span class="line">            role_at_backend=OpenAIBackendRole.ASSISTANT</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.chat_history.write_records([user_record, assistant_record])</span><br><span class="line"></span><br><span class="line"><span class="comment"># AI用户Agent - 增强版</span></span><br><span class="line"><span class="comment"># 真实用户交互接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealUserInterface</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;真实用户交互接口 - 预留给真实用户使用&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.user_input_history = []</span><br><span class="line">        <span class="variable language_">self</span>.interaction_mode = <span class="string">&#x27;ai_simulation&#x27;</span>  <span class="comment"># &#x27;ai_simulation&#x27; 或 &#x27;real_user&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_interaction_mode</span>(<span class="params">self, mode: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置交互模式：ai_simulation 或 real_user&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.interaction_mode = mode</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;交互模式已设置为: <span class="subst">&#123;mode&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">collect_user_requirements</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;收集用户需求 - 支持真实用户输入&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.interaction_mode == <span class="string">&#x27;real_user&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._collect_real_user_input()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._generate_ai_simulation_input()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_collect_real_user_input</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;收集真实用户输入&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n=== 欢迎使用运动场馆推荐系统 ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请告诉我您的运动需求，我将为您推荐最合适的场馆&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        user_requirements = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基本信息收集</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n1. 基本信息&quot;</span>)</span><br><span class="line">        user_requirements[<span class="string">&#x27;age_range&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的年龄范围（如：25-35岁）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;occupation&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的职业: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;income_level&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的收入水平（如：8000-15000元）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;experience_level&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的运动经验（初学者/有一定基础/中等水平/高级水平）: &quot;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 运动需求收集</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n2. 运动需求&quot;</span>)</span><br><span class="line">        user_requirements[<span class="string">&#x27;sport_preference&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您偏好的运动类型（如：篮球、健身、游泳等）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;frequency&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的运动频率（如：每周2-3次）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;preferred_time&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您偏好的运动时间（如：晚上18-21点）: &quot;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 特殊要求收集</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n3. 特殊要求&quot;</span>)</span><br><span class="line">        user_requirements[<span class="string">&#x27;special_needs&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的特殊需求（如：交通便利、设备齐全等）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;budget_range&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的预算范围（如：100-200元/次）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;location&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的位置（如：北京市朝阳区三里屯街道）: &quot;</span>).strip()</span><br><span class="line">        user_requirements[<span class="string">&#x27;transport_mode&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;请输入您的交通方式（如：地铁、公交、开车等）: &quot;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 额外需求收集</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n4. 额外需求（可选）&quot;</span>)</span><br><span class="line">        additional_requirements = <span class="built_in">input</span>(<span class="string">&quot;还有其他特殊要求吗？（如：希望有教练指导、需要停车位等，没有请直接回车）: &quot;</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> additional_requirements:</span><br><span class="line">            user_requirements[<span class="string">&#x27;additional_requirements&#x27;</span>] = additional_requirements</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成用户描述</span></span><br><span class="line">        user_description = <span class="variable language_">self</span>._generate_user_description(user_requirements)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存交互历史</span></span><br><span class="line">        <span class="variable language_">self</span>.user_input_history.append(&#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat(),</span><br><span class="line">            <span class="string">&#x27;requirements&#x27;</span>: user_requirements,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span>: user_description</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_requirements, user_description</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_user_description</span>(<span class="params">self, requirements: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据用户输入生成描述&quot;&quot;&quot;</span></span><br><span class="line">        description = <span class="string">f&quot;&quot;&quot;我是一位<span class="subst">&#123;requirements.get(<span class="string">&#x27;age_range&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>的<span class="subst">&#123;requirements.get(<span class="string">&#x27;occupation&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>，&quot;&quot;&quot;</span></span><br><span class="line">        description += <span class="string">f&quot;&quot;&quot;希望找到合适的<span class="subst">&#123;requirements.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>场馆。&quot;&quot;&quot;</span></span><br><span class="line">        description += <span class="string">f&quot;&quot;&quot;我计划<span class="subst">&#123;requirements.get(<span class="string">&#x27;frequency&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>进行运动，&quot;&quot;&quot;</span></span><br><span class="line">        description += <span class="string">f&quot;&quot;&quot;时间偏好<span class="subst">&#123;requirements.get(<span class="string">&#x27;preferred_time&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>。&quot;&quot;&quot;</span></span><br><span class="line">        description += <span class="string">f&quot;&quot;&quot;预算范围<span class="subst">&#123;requirements.get(<span class="string">&#x27;budget_range&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>，&quot;&quot;&quot;</span></span><br><span class="line">        description += <span class="string">f&quot;&quot;&quot;主要通过<span class="subst">&#123;requirements.get(<span class="string">&#x27;transport_mode&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>出行。&quot;&quot;&quot;</span></span><br><span class="line">        description += <span class="string">f&quot;&quot;&quot;特别希望<span class="subst">&#123;requirements.get(<span class="string">&#x27;special_needs&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>。&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> requirements.get(<span class="string">&#x27;additional_requirements&#x27;</span>):</span><br><span class="line">            description += <span class="string">f&quot;&quot;&quot;另外，<span class="subst">&#123;requirements.get(<span class="string">&#x27;additional_requirements&#x27;</span>)&#125;</span>。&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> description</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_ai_simulation_input</span>(<span class="params">self</span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成AI模拟输入（原有功能）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里调用原有的AI用户生成逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># 将在后面实现</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_feedback</span>(<span class="params">self, recommendations: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取用户对推荐结果的反馈&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.interaction_mode == <span class="string">&#x27;real_user&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n=== 推荐结果反馈 ===&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;请对推荐结果进行评价：&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            feedback = &#123;&#125;</span><br><span class="line">            feedback[<span class="string">&#x27;overall_satisfaction&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;总体满意度（1-5分，5分最满意）: &quot;</span>).strip()</span><br><span class="line">            feedback[<span class="string">&#x27;most_interested&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;您最感兴趣的场馆名称: &quot;</span>).strip()</span><br><span class="line">            feedback[<span class="string">&#x27;concerns&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;您有什么担心或疑虑吗？: &quot;</span>).strip()</span><br><span class="line">            feedback[<span class="string">&#x27;additional_needs&#x27;</span>] = <span class="built_in">input</span>(<span class="string">&quot;还需要了解什么信息？: &quot;</span>).strip()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> feedback</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnhancedAIUserAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        <span class="variable language_">self</span>.real_user_interface = RealUserInterface()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简洁的用户画像模板</span></span><br><span class="line">        <span class="variable language_">self</span>.user_prompt = TextPrompt(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;你是一位居住在中国北京市的AI用户，希望找到合适的运动场馆。请根据以下信息生成一个简洁的个性化运动需求描述：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            基本信息：</span></span><br><span class="line"><span class="string">            - 年龄范围：&#123;age_range&#125;</span></span><br><span class="line"><span class="string">            - 身份职业：&#123;occupation&#125;</span></span><br><span class="line"><span class="string">            - 收入水平：&#123;income_level&#125;</span></span><br><span class="line"><span class="string">            - 运动经验：&#123;experience_level&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            运动需求：</span></span><br><span class="line"><span class="string">            - 运动偏好：&#123;sport_preference&#125;</span></span><br><span class="line"><span class="string">            - 运动频率：&#123;frequency&#125;</span></span><br><span class="line"><span class="string">            - 运动时间：&#123;preferred_time&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            特殊要求：</span></span><br><span class="line"><span class="string">            - 特殊需求：&#123;special_needs&#125;</span></span><br><span class="line"><span class="string">            - 预算范围：&#123;budget_range&#125;</span></span><br><span class="line"><span class="string">            - 当前位置：&#123;location&#125;</span></span><br><span class="line"><span class="string">            - 交通方式：&#123;transport_mode&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            请以第一人称的方式简洁描述你的需求，包括：</span></span><br><span class="line"><span class="string">            1. 简要个人背景和运动目标（1-2句话）</span></span><br><span class="line"><span class="string">            2. 具体运动需求（运动类型、频率、时间）</span></span><br><span class="line"><span class="string">            3. 主要场馆要求（设施、环境、服务中的1-2个重点）</span></span><br><span class="line"><span class="string">            4. 预算和交通偏好</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            要求：</span></span><br><span class="line"><span class="string">            - 总长度控制在200-300字以内</span></span><br><span class="line"><span class="string">            - 突出关键信息，避免冗长描述</span></span><br><span class="line"><span class="string">            - 保持真实自然的语调</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建AI用户的任务Agent</span></span><br><span class="line">        <span class="variable language_">self</span>.user_agent = TaskSpecifyAgent(</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            task_type=TaskType.AI_SOCIETY,</span><br><span class="line">            task_specify_prompt=<span class="variable language_">self</span>.user_prompt,</span><br><span class="line">            output_language=<span class="string">&#x27;ch&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 扩展的案例模板库</span></span><br><span class="line">        <span class="variable language_">self</span>.enhanced_templates = &#123;</span><br><span class="line">            <span class="string">&quot;age_ranges&quot;</span>: [<span class="string">&quot;18-25岁&quot;</span>, <span class="string">&quot;26-35岁&quot;</span>, <span class="string">&quot;36-45岁&quot;</span>, <span class="string">&quot;46-55岁&quot;</span>, <span class="string">&quot;56-65岁&quot;</span>],</span><br><span class="line">            <span class="string">&quot;occupations&quot;</span>: [<span class="string">&quot;大学生&quot;</span>, <span class="string">&quot;程序员&quot;</span>, <span class="string">&quot;设计师&quot;</span>, <span class="string">&quot;销售经理&quot;</span>, <span class="string">&quot;医生&quot;</span>, <span class="string">&quot;教师&quot;</span>, <span class="string">&quot;自由职业者&quot;</span>, <span class="string">&quot;企业高管&quot;</span>],</span><br><span class="line">            <span class="string">&quot;income_levels&quot;</span>: [<span class="string">&quot;3000-8000元&quot;</span>, <span class="string">&quot;8000-15000元&quot;</span>, <span class="string">&quot;15000-25000元&quot;</span>, <span class="string">&quot;25000元以上&quot;</span>],</span><br><span class="line">            <span class="string">&quot;experience_levels&quot;</span>: [<span class="string">&quot;初学者&quot;</span>, <span class="string">&quot;有一定基础&quot;</span>, <span class="string">&quot;中等水平&quot;</span>, <span class="string">&quot;高级水平&quot;</span>],</span><br><span class="line">            <span class="string">&quot;sport_preferences&quot;</span>: [<span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;羽毛球&quot;</span>, <span class="string">&quot;游泳&quot;</span>, <span class="string">&quot;健身&quot;</span>, <span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;足球&quot;</span>, <span class="string">&quot;网球&quot;</span>, <span class="string">&quot;瑜伽&quot;</span>, <span class="string">&quot;乒乓球&quot;</span>, <span class="string">&quot;攀岩&quot;</span>],</span><br><span class="line">            <span class="string">&quot;frequencies&quot;</span>: [<span class="string">&quot;每周1-2次&quot;</span>, <span class="string">&quot;每周3-4次&quot;</span>, <span class="string">&quot;每周5-6次&quot;</span>, <span class="string">&quot;每天&quot;</span>],</span><br><span class="line">            <span class="string">&quot;preferred_times&quot;</span>: [<span class="string">&quot;早上6-9点&quot;</span>, <span class="string">&quot;中午12-14点&quot;</span>, <span class="string">&quot;晚上18-21点&quot;</span>, <span class="string">&quot;周末全天&quot;</span>, <span class="string">&quot;工作日晚上&quot;</span>],</span><br><span class="line">            <span class="string">&quot;special_needs&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;希望有专业教练指导&quot;</span>, <span class="string">&quot;需要室内环境&quot;</span>, <span class="string">&quot;交通便利优先&quot;</span>, <span class="string">&quot;价格实惠&quot;</span>, </span><br><span class="line">                <span class="string">&quot;设备新且齐全&quot;</span>, <span class="string">&quot;环境安静&quot;</span>, <span class="string">&quot;有停车位&quot;</span>, <span class="string">&quot;适合家庭活动&quot;</span>, <span class="string">&quot;有淋浴设施&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;budget_ranges&quot;</span>: [<span class="string">&quot;50-100元/次&quot;</span>, <span class="string">&quot;100-200元/次&quot;</span>, <span class="string">&quot;200-300元/次&quot;</span>, <span class="string">&quot;300元以上/次&quot;</span>],</span><br><span class="line">            <span class="string">&quot;transport_modes&quot;</span>: [<span class="string">&quot;地铁&quot;</span>, <span class="string">&quot;公交&quot;</span>, <span class="string">&quot;开车&quot;</span>, <span class="string">&quot;骑行&quot;</span>, <span class="string">&quot;步行&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 北京详细位置库</span></span><br><span class="line">        <span class="variable language_">self</span>.detailed_locations = [</span><br><span class="line">            &#123;<span class="string">&quot;area&quot;</span>: <span class="string">&quot;朝阳区&quot;</span>, <span class="string">&quot;district&quot;</span>: <span class="string">&quot;三里屯街道&quot;</span>, <span class="string">&quot;landmarks&quot;</span>: [<span class="string">&quot;三里屯太古里&quot;</span>, <span class="string">&quot;工体&quot;</span>]&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;area&quot;</span>: <span class="string">&quot;海淀区&quot;</span>, <span class="string">&quot;district&quot;</span>: <span class="string">&quot;中关村街道&quot;</span>, <span class="string">&quot;landmarks&quot;</span>: [<span class="string">&quot;中关村&quot;</span>, <span class="string">&quot;清华大学&quot;</span>]&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;area&quot;</span>: <span class="string">&quot;东城区&quot;</span>, <span class="string">&quot;district&quot;</span>: <span class="string">&quot;东华门街道&quot;</span>, <span class="string">&quot;landmarks&quot;</span>: [<span class="string">&quot;王府井&quot;</span>, <span class="string">&quot;天安门&quot;</span>]&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;area&quot;</span>: <span class="string">&quot;西城区&quot;</span>, <span class="string">&quot;district&quot;</span>: <span class="string">&quot;金融街街道&quot;</span>, <span class="string">&quot;landmarks&quot;</span>: [<span class="string">&quot;金融街&quot;</span>, <span class="string">&quot;西单&quot;</span>]&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;area&quot;</span>: <span class="string">&quot;丰台区&quot;</span>, <span class="string">&quot;district&quot;</span>: <span class="string">&quot;丰台街道&quot;</span>, <span class="string">&quot;landmarks&quot;</span>: [<span class="string">&quot;丰台体育中心&quot;</span>, <span class="string">&quot;方庄&quot;</span>]&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;area&quot;</span>: <span class="string">&quot;石景山区&quot;</span>, <span class="string">&quot;district&quot;</span>: <span class="string">&quot;八宝山街道&quot;</span>, <span class="string">&quot;landmarks&quot;</span>: [<span class="string">&quot;石景山体育馆&quot;</span>, <span class="string">&quot;万达广场&quot;</span>]&#125;,</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_enhanced_case</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成增强的用户案例&quot;&quot;&quot;</span></span><br><span class="line">        location_info = random.choice(<span class="variable language_">self</span>.detailed_locations)</span><br><span class="line">        </span><br><span class="line">        case_info = &#123;</span><br><span class="line">            <span class="string">&quot;age_range&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;age_ranges&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;occupation&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;occupations&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;income_level&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;income_levels&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;experience_level&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;experience_levels&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;sport_preference&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;sport_preferences&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;frequency&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;frequencies&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;preferred_time&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;preferred_times&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;special_needs&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;special_needs&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;budget_range&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;budget_ranges&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: <span class="string">f&quot;北京市<span class="subst">&#123;location_info[<span class="string">&#x27;area&#x27;</span>]&#125;</span><span class="subst">&#123;location_info[<span class="string">&#x27;district&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;transport_mode&quot;</span>: random.choice(<span class="variable language_">self</span>.enhanced_templates[<span class="string">&quot;transport_modes&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;landmarks&quot;</span>: location_info[<span class="string">&quot;landmarks&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n增强版用户运动需求案例：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;年龄：<span class="subst">&#123;case_info[<span class="string">&#x27;age_range&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;职业：<span class="subst">&#123;case_info[<span class="string">&#x27;occupation&#x27;</span>]&#125;</span> (收入：<span class="subst">&#123;case_info[<span class="string">&#x27;income_level&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;运动经验：<span class="subst">&#123;case_info[<span class="string">&#x27;experience_level&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;运动偏好：<span class="subst">&#123;case_info[<span class="string">&#x27;sport_preference&#x27;</span>]&#125;</span> (<span class="subst">&#123;case_info[<span class="string">&#x27;frequency&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;偏好时间：<span class="subst">&#123;case_info[<span class="string">&#x27;preferred_time&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;特殊需求：<span class="subst">&#123;case_info[<span class="string">&#x27;special_needs&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;预算范围：<span class="subst">&#123;case_info[<span class="string">&#x27;budget_range&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;所在位置：<span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;交通方式：<span class="subst">&#123;case_info[<span class="string">&#x27;transport_mode&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> case_info</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @smart_retry(<span class="params">RetryConfig(<span class="params">max_retries=<span class="number">3</span>, base_delay=<span class="number">1.0</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_enhanced_profile</span>(<span class="params">self, case_info=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建增强的用户档案（带重试机制）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> case_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            case_info = <span class="variable language_">self</span>.generate_enhanced_case()</span><br><span class="line">        </span><br><span class="line">        task_prompt = <span class="string">&quot;生成一个详细真实的个性化运动需求描述，包含具体的个人背景、运动目标和详细要求&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = <span class="variable language_">self</span>.user_agent.run(</span><br><span class="line">                task_prompt=task_prompt,</span><br><span class="line">                meta_dict=case_info</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response <span class="keyword">or</span> <span class="built_in">len</span>(response.strip()) &lt; <span class="number">50</span>:</span><br><span class="line">                <span class="keyword">raise</span> RetryableError(<span class="string">&quot;用户档案生成内容过短或为空&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\nAI用户的详细需求描述：&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(response)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> response, case_info</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;用户档案生成失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提供降级策略</span></span><br><span class="line">            fallback_response = <span class="variable language_">self</span>._create_fallback_profile(case_info)</span><br><span class="line">            <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;使用降级策略生成用户档案&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> fallback_response, case_info</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_fallback_profile</span>(<span class="params">self, case_info: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;降级策略：创建简洁用户档案&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;我是一位<span class="subst">&#123;case_info[<span class="string">&#x27;age_range&#x27;</span>]&#125;</span>的<span class="subst">&#123;case_info[<span class="string">&#x27;occupation&#x27;</span>]&#125;</span>，居住在<span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span>。希望找到合适的<span class="subst">&#123;case_info[<span class="string">&#x27;sport_preference&#x27;</span>]&#125;</span>场馆，<span class="subst">&#123;case_info[<span class="string">&#x27;frequency&#x27;</span>]&#125;</span>，时间偏好<span class="subst">&#123;case_info[<span class="string">&#x27;preferred_time&#x27;</span>]&#125;</span>。预算<span class="subst">&#123;case_info[<span class="string">&#x27;budget_range&#x27;</span>]&#125;</span>，<span class="subst">&#123;case_info[<span class="string">&#x27;transport_mode&#x27;</span>]&#125;</span>出行。特别需要<span class="subst">&#123;case_info[<span class="string">&#x27;special_needs&#x27;</span>]&#125;</span>。作为<span class="subst">&#123;case_info[<span class="string">&#x27;experience_level&#x27;</span>]&#125;</span>水平，希望找到合适的场馆。&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果验证和质量评估系统（从优化版本适配）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendationValidator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.quality_metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;completeness&#x27;</span>: <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&#x27;relevance&#x27;</span>: <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&#x27;specificity&#x27;</span>: <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&#x27;actionability&#x27;</span>: <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_recommendation</span>(<span class="params">self, recommendation: <span class="built_in">str</span>, user_needs: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证推荐结果的质量&quot;&quot;&quot;</span></span><br><span class="line">        metrics = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 完整性检查</span></span><br><span class="line">        metrics[<span class="string">&#x27;completeness&#x27;</span>] = <span class="variable language_">self</span>._check_completeness(recommendation)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 相关性检查</span></span><br><span class="line">        metrics[<span class="string">&#x27;relevance&#x27;</span>] = <span class="variable language_">self</span>._check_relevance(recommendation, user_needs)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 具体性检查</span></span><br><span class="line">        metrics[<span class="string">&#x27;specificity&#x27;</span>] = <span class="variable language_">self</span>._check_specificity(recommendation)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 可操作性检查</span></span><br><span class="line">        metrics[<span class="string">&#x27;actionability&#x27;</span>] = <span class="variable language_">self</span>._check_actionability(recommendation)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算总体质量分数</span></span><br><span class="line">        metrics[<span class="string">&#x27;overall_quality&#x27;</span>] = <span class="built_in">sum</span>(metrics.values()) / <span class="built_in">len</span>(metrics)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_completeness</span>(<span class="params">self, recommendation: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查推荐的完整性&quot;&quot;&quot;</span></span><br><span class="line">        required_elements = [<span class="string">&#x27;场馆名称&#x27;</span>, <span class="string">&#x27;地址&#x27;</span>, <span class="string">&#x27;联系方式&#x27;</span>, <span class="string">&#x27;营业时间&#x27;</span>, <span class="string">&#x27;价格&#x27;</span>]</span><br><span class="line">        found_elements = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> required_elements:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> recommendation <span class="keyword">for</span> keyword <span class="keyword">in</span> <span class="variable language_">self</span>._get_element_keywords(element)):</span><br><span class="line">                found_elements += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> found_elements / <span class="built_in">len</span>(required_elements)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_relevance</span>(<span class="params">self, recommendation: <span class="built_in">str</span>, user_needs: <span class="type">Dict</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查推荐与用户需求的相关性&quot;&quot;&quot;</span></span><br><span class="line">        relevance_score = <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查运动类型匹配</span></span><br><span class="line">        sport_preference = user_needs.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> sport_preference <span class="keyword">and</span> sport_preference <span class="keyword">in</span> recommendation:</span><br><span class="line">            relevance_score += <span class="number">0.4</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 检查位置匹配</span></span><br><span class="line">        location = user_needs.get(<span class="string">&#x27;location&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        location_keywords = location.split(<span class="string">&#x27;区&#x27;</span>)[<span class="number">0</span>] <span class="keyword">if</span> <span class="string">&#x27;区&#x27;</span> <span class="keyword">in</span> location <span class="keyword">else</span> location</span><br><span class="line">        <span class="keyword">if</span> location_keywords <span class="keyword">in</span> recommendation:</span><br><span class="line">            relevance_score += <span class="number">0.3</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 检查特殊需求匹配</span></span><br><span class="line">        special_needs = user_needs.get(<span class="string">&#x27;special_needs&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> special_needs:</span><br><span class="line">            need_keywords = [<span class="string">&#x27;室内&#x27;</span>, <span class="string">&#x27;交通&#x27;</span>, <span class="string">&#x27;价格&#x27;</span>, <span class="string">&#x27;教练&#x27;</span>, <span class="string">&#x27;设备&#x27;</span>, <span class="string">&#x27;停车&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> keyword <span class="keyword">in</span> need_keywords:</span><br><span class="line">                <span class="keyword">if</span> keyword <span class="keyword">in</span> special_needs <span class="keyword">and</span> keyword <span class="keyword">in</span> recommendation:</span><br><span class="line">                    relevance_score += <span class="number">0.05</span></span><br><span class="line">                    </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(<span class="number">1.0</span>, relevance_score)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_specificity</span>(<span class="params">self, recommendation: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查推荐的具体性&quot;&quot;&quot;</span></span><br><span class="line">        specificity_indicators = [</span><br><span class="line">            <span class="string">r&#x27;\d+元&#x27;</span>,  <span class="comment"># 具体价格</span></span><br><span class="line">            <span class="string">r&#x27;\d+:\d+&#x27;</span>,  <span class="comment"># 具体时间</span></span><br><span class="line">            <span class="string">r&#x27;地址[:：]&#x27;</span>,  <span class="comment"># 具体地址</span></span><br><span class="line">            <span class="string">r&#x27;电话[:：]&#x27;</span>,  <span class="comment"># 具体电话</span></span><br><span class="line">            <span class="string">r&#x27;\d+号线&#x27;</span>,  <span class="comment"># 具体地铁线路</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        found_indicators = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> specificity_indicators:</span><br><span class="line">            <span class="keyword">if</span> re.search(pattern, recommendation):</span><br><span class="line">                found_indicators += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> found_indicators / <span class="built_in">len</span>(specificity_indicators)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_actionability</span>(<span class="params">self, recommendation: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查推荐的可操作性&quot;&quot;&quot;</span></span><br><span class="line">        actionable_elements = [</span><br><span class="line">            <span class="string">&#x27;预约&#x27;</span>, <span class="string">&#x27;联系&#x27;</span>, <span class="string">&#x27;到达&#x27;</span>, <span class="string">&#x27;乘坐&#x27;</span>, <span class="string">&#x27;步行&#x27;</span>, <span class="string">&#x27;开车&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        found_elements = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> actionable_elements:</span><br><span class="line">            <span class="keyword">if</span> element <span class="keyword">in</span> recommendation:</span><br><span class="line">                found_elements += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(<span class="number">1.0</span>, found_elements / <span class="number">3</span>)  <span class="comment"># 至少需要3个可操作元素</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_element_keywords</span>(<span class="params">self, element: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取元素对应的关键词&quot;&quot;&quot;</span></span><br><span class="line">        keyword_map = &#123;</span><br><span class="line">            <span class="string">&#x27;场馆名称&#x27;</span>: [<span class="string">&#x27;体育馆&#x27;</span>, <span class="string">&#x27;健身房&#x27;</span>, <span class="string">&#x27;游泳馆&#x27;</span>, <span class="string">&#x27;球馆&#x27;</span>, <span class="string">&#x27;中心&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;地址&#x27;</span>: [<span class="string">&#x27;地址&#x27;</span>, <span class="string">&#x27;位于&#x27;</span>, <span class="string">&#x27;坐落&#x27;</span>, <span class="string">&#x27;路&#x27;</span>, <span class="string">&#x27;街&#x27;</span>, <span class="string">&#x27;区&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;联系方式&#x27;</span>: [<span class="string">&#x27;电话&#x27;</span>, <span class="string">&#x27;联系&#x27;</span>, <span class="string">&#x27;咨询&#x27;</span>, <span class="string">&#x27;预约&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;营业时间&#x27;</span>: [<span class="string">&#x27;营业&#x27;</span>, <span class="string">&#x27;开放&#x27;</span>, <span class="string">&#x27;时间&#x27;</span>, <span class="string">&#x27;小时&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;价格&#x27;</span>: [<span class="string">&#x27;价格&#x27;</span>, <span class="string">&#x27;费用&#x27;</span>, <span class="string">&#x27;收费&#x27;</span>, <span class="string">&#x27;元&#x27;</span>, <span class="string">&#x27;钱&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> keyword_map.get(element, [])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Workforce版本的运动场馆推荐系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkforceSportsVenueRecommendationSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model, use_mock_data_if_no_key=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        <span class="variable language_">self</span>.ai_user = EnhancedAIUserAgent(model)</span><br><span class="line">        <span class="variable language_">self</span>.memory_manager = IntelligentMemoryManager(keep_rate=<span class="number">0.9</span>)</span><br><span class="line">        <span class="variable language_">self</span>.search_toolkit = EnhancedSearchToolkit(delay_seconds=<span class="number">2</span>, use_mock_data_if_no_key=use_mock_data_if_no_key)</span><br><span class="line">        <span class="variable language_">self</span>.validator = RecommendationValidator()  <span class="comment"># 添加结果验证器</span></span><br><span class="line">        <span class="variable language_">self</span>.use_mock_data_if_no_key = use_mock_data_if_no_key</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;🚀 Workforce版AI运动场馆推荐系统已初始化&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 智能记忆管理系统已加载&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 结果验证系统已启用&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✅ 增强搜索工具包已配置（<span class="subst">&#123;<span class="string">&#x27;启用&#x27;</span> <span class="keyword">if</span> use_mock_data_if_no_key <span class="keyword">else</span> <span class="string">&#x27;禁用&#x27;</span>&#125;</span>模拟数据备用模式）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建Workforce工作节点</span></span><br><span class="line">        <span class="variable language_">self</span>._create_workforce_agents()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_workforce_agents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建Workforce工作节点&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n正在创建Workforce工作节点...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 信息收集专员 - 使用ChatAgent + 增强搜索工具</span></span><br><span class="line">        <span class="variable language_">self</span>.information_collector = ChatAgent(</span><br><span class="line">            system_message=BaseMessage.make_assistant_message(</span><br><span class="line">                role_name=<span class="string">&quot;运动场馆信息收集专员&quot;</span>,</span><br><span class="line">                content=<span class="string">&quot;&quot;&quot;你是专业的运动场馆信息收集专员。你的职责是收集和整理运动场馆相关信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                核心职责：</span></span><br><span class="line"><span class="string">                1. 收集北京地区运动场馆的基本信息（地址、开放时间、价格）</span></span><br><span class="line"><span class="string">                2. 搜集不同运动类型的场馆推荐（篮球、羽毛球、游泳、健身等）</span></span><br><span class="line"><span class="string">                3. 整理交通方式和路线信息（地铁线路、公交路线）</span></span><br><span class="line"><span class="string">                4. 收集场馆设施和服务信息（教练、设备、环境）</span></span><br><span class="line"><span class="string">                5. 提供实用的运动贴士（预约方式、注意事项）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                搜索格策略：</span></span><br><span class="line"><span class="string">                1. 优先在用户指定区域搜索</span></span><br><span class="line"><span class="string">                2. 如果原始区域结果不足，自动扩展到相邻区域</span></span><br><span class="line"><span class="string">                3. 必要时进一步扩展到附近区域</span></span><br><span class="line"><span class="string">                4. 验证场馆信息的真实性，避免虚假信息</span></span><br><span class="line"><span class="string">                5. 优先推荐已验证的真实场馆</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                输出格式要求：</span></span><br><span class="line"><span class="string">                - 按区域和运动类型整理信息</span></span><br><span class="line"><span class="string">                - 标明场馆的验证状态（已验证/待验证）</span></span><br><span class="line"><span class="string">                - 提供具体的实用信息（时间、价格、地址、联系方式）</span></span><br><span class="line"><span class="string">                - 说明搜索范围扩展情况</span></span><br><span class="line"><span class="string">                - 不要制定具体的推荐方案</span></span><br><span class="line"><span class="string">                - 专注于信息的准确性和真实性</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                重要限制：</span></span><br><span class="line"><span class="string">                - 只收集信息，不做推荐决策</span></span><br><span class="line"><span class="string">                - 禁止编造或虚构场馆信息</span></span><br><span class="line"><span class="string">                - 优先使用已验证的真实场馆数据</span></span><br><span class="line"><span class="string">                - 对未验证信息要明确标注</span></span><br><span class="line"><span class="string">                - 如果搜索结果不足，要诚实说明并建议扩展搜索&quot;&quot;&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            tools=[<span class="variable language_">self</span>.search_toolkit.safe_search_duckduckgo, <span class="variable language_">self</span>.search_toolkit.expanded_venue_search]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. RolePlaying专员 - 使用RolePlaying进行深度需求分析</span></span><br><span class="line">        <span class="variable language_">self</span>.roleplay_analyst = <span class="variable language_">self</span>._create_roleplay_analyst()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 推荐决策专员 - 使用ChatAgent + 数学工具进行决策分析</span></span><br><span class="line">        <span class="variable language_">self</span>.recommendation_specialist = ChatAgent(</span><br><span class="line">            system_message=BaseMessage.make_assistant_message(</span><br><span class="line">                role_name=<span class="string">&quot;运动场馆推荐决策专员&quot;</span>,</span><br><span class="line">                content=<span class="string">&quot;&quot;&quot;你是专业的运动场馆推荐决策专员。你的职责是基于收集的信息和用户需求分析，制定个性化推荐方案。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                🎯 核心职责：</span></span><br><span class="line"><span class="string">                1. 分析用户需求与场馆信息的匹配度</span></span><br><span class="line"><span class="string">                2. 使用数学工具计算推荐评分和排序</span></span><br><span class="line"><span class="string">                3. 考虑地理位置、交通便利性、价格等因素</span></span><br><span class="line"><span class="string">                4. 制定个性化的场馆推荐方案</span></span><br><span class="line"><span class="string">                5. 提供详细的选择理由和建议</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                📊 决策维度：</span></span><br><span class="line"><span class="string">                - 需求匹配度（运动类型、时间、频率）</span></span><br><span class="line"><span class="string">                - 地理便利性（距离、交通）</span></span><br><span class="line"><span class="string">                - 经济合理性（价格、性价比）</span></span><br><span class="line"><span class="string">                - 服务质量（设施、教练、环境）</span></span><br><span class="line"><span class="string">                - 用户偏好（特殊需求、个人喜好）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                ⚠️ 严格要求：</span></span><br><span class="line"><span class="string">                - 只能推荐已验证的真实场馆</span></span><br><span class="line"><span class="string">                - 绝对禁止编造、虚构任何场馆信息</span></span><br><span class="line"><span class="string">                - 如果没有合适的已验证场馆，诚实说明情况</span></span><br><span class="line"><span class="string">                - 不要创造虚假的场馆名称、地址或联系方式</span></span><br><span class="line"><span class="string">                - 所有推荐必须基于提供的已验证场馆数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                📋 输出要求：</span></span><br><span class="line"><span class="string">                - 只推荐已验证数据库中的真实场馆</span></span><br><span class="line"><span class="string">                - 每个推荐必须标明验证状态</span></span><br><span class="line"><span class="string">                - 如果已验证场馆不足，说明实际情况</span></span><br><span class="line"><span class="string">                - 提供真实可行的行动建议</span></span><br><span class="line"><span class="string">                - 使用数学工具进行量化分析时只基于真实数据&quot;&quot;&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            tools=MathToolkit().get_tools()</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. 质量评估专员 - 使用ChatAgent进行结果验证</span></span><br><span class="line">        <span class="variable language_">self</span>.quality_assessor = ChatAgent(</span><br><span class="line">            system_message=BaseMessage.make_assistant_message(</span><br><span class="line">                role_name=<span class="string">&quot;推荐质量评估专员&quot;</span>,</span><br><span class="line">                content=<span class="string">&quot;&quot;&quot;你是专业的推荐质量评估专员。你的职责是评估推荐结果的质量并提出改进建议。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                🎯 评估维度：</span></span><br><span class="line"><span class="string">                1. 完整性：推荐信息是否完整（地址、时间、价格、联系方式）</span></span><br><span class="line"><span class="string">                2. 相关性：推荐是否符合用户具体需求</span></span><br><span class="line"><span class="string">                3. 可操作性：用户是否能够根据推荐采取行动</span></span><br><span class="line"><span class="string">                4. 实用性：推荐是否具有实际价值</span></span><br><span class="line"><span class="string">                5. 个性化程度：是否体现了用户的个性化需求</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                📊 评分标准：</span></span><br><span class="line"><span class="string">                - 每个维度0-1分，总分0-5分</span></span><br><span class="line"><span class="string">                - 4分以上为优秀推荐</span></span><br><span class="line"><span class="string">                - 3-4分为良好推荐</span></span><br><span class="line"><span class="string">                - 3分以下需要改进</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                📋 输出要求：</span></span><br><span class="line"><span class="string">                - 提供详细的质量评估报告</span></span><br><span class="line"><span class="string">                - 指出推荐的优点和不足</span></span><br><span class="line"><span class="string">                - 提供具体的改进建议</span></span><br><span class="line"><span class="string">                - 给出最终质量评分</span></span><br><span class="line"><span class="string">                - 输出格式必须为JSON格式，包含评分和改进建议&quot;&quot;&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 5. 需求优先级确认专员 - 当搜索结果不足时确认用户优先级</span></span><br><span class="line">        <span class="variable language_">self</span>.priority_consultant = ChatAgent(</span><br><span class="line">            system_message=BaseMessage.make_assistant_message(</span><br><span class="line">                role_name=<span class="string">&quot;需求优先级确认专员&quot;</span>,</span><br><span class="line">                content=<span class="string">&quot;&quot;&quot;你是专业的需求优先级确认专员。当原始搜索区域找不到合适场馆时，你的职责是帮助用户确认需求优先级。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                🎯 核心职责：</span></span><br><span class="line"><span class="string">                1. 分析用户的多项需求和约束条件</span></span><br><span class="line"><span class="string">                2. 引导用户明确各项需求的重要程度</span></span><br><span class="line"><span class="string">                3. 识别哪些需求是必须满足的，哪些可以妥协</span></span><br><span class="line"><span class="string">                4. 为扩大搜索范围提供决策依据</span></span><br><span class="line"><span class="string">                5. 确保用户理解妥协的必要性和合理性</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                � 确认策略：</span></span><br><span class="line"><span class="string">                - 列出用户的所有需求项目</span></span><br><span class="line"><span class="string">                - 询问每项需求的重要程度（必须满足/希望满足/可以妥协）</span></span><br><span class="line"><span class="string">                - 解释扩大搜索范围的必要性</span></span><br><span class="line"><span class="string">                - 提供妥协建议和替代方案</span></span><br><span class="line"><span class="string">                - 确保用户做出知情决策</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                📋 输出要求：</span></span><br><span class="line"><span class="string">                - 清晰列出需求优先级分类</span></span><br><span class="line"><span class="string">                - 说明扩大搜索的理由和范围</span></span><br><span class="line"><span class="string">                - 提供具体的妥协建议</span></span><br><span class="line"><span class="string">                - 征求用户的确认和同意&quot;&quot;&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 6. 改进执行专员 - 根据评估建议优化推荐结果</span></span><br><span class="line">        <span class="variable language_">self</span>.improvement_executor = ChatAgent(</span><br><span class="line">            system_message=BaseMessage.make_assistant_message(</span><br><span class="line">                role_name=<span class="string">&quot;推荐改进执行专员&quot;</span>,</span><br><span class="line">                content=<span class="string">&quot;&quot;&quot;你是专业的推荐改进执行专员。你的职责是根据质量评估的改进建议，优化和完善推荐结果。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                🎯 核心职责：</span></span><br><span class="line"><span class="string">                1. 分析质量评估专员提出的改进建议</span></span><br><span class="line"><span class="string">                2. 识别推荐结果中的不足和缺陷</span></span><br><span class="line"><span class="string">                3. 补充缺失的信息和细节</span></span><br><span class="line"><span class="string">                4. 优化推荐的表达方式和结构</span></span><br><span class="line"><span class="string">                5. 确保最终输出符合统一模板标准</span></span><br><span class="line"><span class="string">                6. 验证推荐场馆的真实性，避免虚假信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                🔧 改进策略：</span></span><br><span class="line"><span class="string">                - 信息补全：基于已验证场馆数据补充信息</span></span><br><span class="line"><span class="string">                - 真实性验证：确保推荐场馆真实存在</span></span><br><span class="line"><span class="string">                - 结构优化：重新组织推荐内容的逻辑结构</span></span><br><span class="line"><span class="string">                - 个性化增强：加强针对用户特定需求的个性化建议</span></span><br><span class="line"><span class="string">                - 可操作性提升：提供更具体的行动指导</span></span><br><span class="line"><span class="string">                - 格式标准化：使用统一的输出模板</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                ⚠️ 严格禁止：</span></span><br><span class="line"><span class="string">                - 绝对不能编造、虚构任何场馆信息</span></span><br><span class="line"><span class="string">                - 不能创建虚假的场馆名称、地址、电话</span></span><br><span class="line"><span class="string">                - 不能生成不存在的场馆数据</span></span><br><span class="line"><span class="string">                - 如果已验证场馆不足，必须诚实说明</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                📋 输出要求：</span></span><br><span class="line"><span class="string">                - 必须采用统一的推荐模板格式</span></span><br><span class="line"><span class="string">                - 只使用已验证的真实场馆数据</span></span><br><span class="line"><span class="string">                - 清楚标明每个场馆的验证状态</span></span><br><span class="line"><span class="string">                - 如果场馆数量不足，提供替代建议</span></span><br><span class="line"><span class="string">                - 生成诚实、真实的推荐报告&quot;&quot;&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 信息收集专员已创建（配备增强搜索工具）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ RolePlaying需求分析专员已创建&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 推荐决策专员已创建（配备数学工具）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 质量评估专员已创建&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 需求优先级确认专员已创建&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 改进执行专员已创建（真实性验证+统一模板输出）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_roleplay_analyst</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建RolePlaying需求分析专员&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 创建RolePlaying会话用于深度需求分析</span></span><br><span class="line">        roleplay_session = RolePlaying(</span><br><span class="line">            assistant_role_name=<span class="string">&quot;资深运动需求分析师&quot;</span>,</span><br><span class="line">            assistant_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">                model=<span class="variable language_">self</span>.model</span><br><span class="line">            ),</span><br><span class="line">            user_role_name=<span class="string">&quot;运动咨询用户&quot;</span>,</span><br><span class="line">            user_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">                model=<span class="variable language_">self</span>.model</span><br><span class="line">            ),</span><br><span class="line">            task_prompt=<span class="string">&quot;&quot;&quot;作为资深运动需求分析师，请深入分析用户的运动需求和偏好。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            🎯 核心职责：</span></span><br><span class="line"><span class="string">            1. 深入挖掘用户的真实运动需求和动机</span></span><br><span class="line"><span class="string">            2. 分析用户的生活方式和时间安排</span></span><br><span class="line"><span class="string">            3. 识别用户的潜在需求和担忧</span></span><br><span class="line"><span class="string">            4. 评估用户的运动经验和能力水平</span></span><br><span class="line"><span class="string">            5. 理解用户的预算和价值观</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            💡 分析方法：</span></span><br><span class="line"><span class="string">            - 通过对话深入了解用户背景</span></span><br><span class="line"><span class="string">            - 识别用户的显性和隐性需求</span></span><br><span class="line"><span class="string">            - 分析用户的决策因素和优先级</span></span><br><span class="line"><span class="string">            - 评估用户的实际约束条件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            📋 输出要求：</span></span><br><span class="line"><span class="string">            - 提供详细的用户需求分析报告</span></span><br><span class="line"><span class="string">            - 识别关键决策因素</span></span><br><span class="line"><span class="string">            - 提出针对性的建议方向&quot;&quot;&quot;</span>,</span><br><span class="line">            with_task_specify=<span class="literal">False</span>,</span><br><span class="line">            output_language=<span class="string">&#x27;中文&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> roleplay_session</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_venue_data_from_recommendation</span>(<span class="params">self, recommendation: <span class="built_in">str</span>, case_info: <span class="type">Dict</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从推荐文本中提取场馆数据（优先使用平台场馆）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 获取用户需求信息</span></span><br><span class="line">        sport = case_info.get(<span class="string">&#x27;sport_preference&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        location = case_info.get(<span class="string">&#x27;location&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        area = <span class="variable language_">self</span>.search_toolkit._extract_area_from_location(location)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取平台场馆数据（优先级最高）</span></span><br><span class="line">        platform_venues = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 大众点评场馆</span></span><br><span class="line">        dianping_venues = <span class="variable language_">self</span>.search_toolkit.multi_platform_data.search_dianping_venues(area, sport)</span><br><span class="line">        <span class="keyword">for</span> venue <span class="keyword">in</span> dianping_venues:</span><br><span class="line">            formatted_venue = &#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: venue[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span>: venue[<span class="string">&#x27;address&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;contact&#x27;</span>: <span class="string">&#x27;请通过大众点评平台联系&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;price&#x27;</span>: venue.get(<span class="string">&#x27;price_range&#x27;</span>, <span class="string">&#x27;请咨询具体价格&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;hours&#x27;</span>: venue.get(<span class="string">&#x27;opening_hours&#x27;</span>, <span class="string">&#x27;请咨询营业时间&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;transport&#x27;</span>: <span class="variable language_">self</span>._get_transport_info(venue[<span class="string">&#x27;address&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;score&#x27;</span>: <span class="built_in">str</span>(venue.get(<span class="string">&#x27;rating&#x27;</span>, <span class="number">4.5</span>)),</span><br><span class="line">                <span class="string">&#x27;reason&#x27;</span>: <span class="string">f&quot;大众点评平台免验证<span class="subst">&#123;sport&#125;</span>场馆，用户评价<span class="subst">&#123;venue.get(<span class="string">&#x27;reviews&#x27;</span>, <span class="number">0</span>)&#125;</span>条&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;, &#x27;</span>.join(venue.get(<span class="string">&#x27;features&#x27;</span>, [<span class="string">f&#x27;专业<span class="subst">&#123;sport&#125;</span>场馆&#x27;</span>])),</span><br><span class="line">                <span class="string">&#x27;notes&#x27;</span>: <span class="string">&#x27;大众点评平台场馆，用户评价丰富&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;platform&#x27;</span>: <span class="string">&#x27;大众点评&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            platform_venues.append(formatted_venue)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 美团场馆</span></span><br><span class="line">        meituan_venues = <span class="variable language_">self</span>.search_toolkit.multi_platform_data.search_meituan_venues(area, sport)</span><br><span class="line">        <span class="keyword">for</span> venue <span class="keyword">in</span> meituan_venues:</span><br><span class="line">            formatted_venue = &#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: venue[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span>: venue[<span class="string">&#x27;address&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;contact&#x27;</span>: <span class="string">&#x27;请通过美团平台联系&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;price&#x27;</span>: venue.get(<span class="string">&#x27;price_range&#x27;</span>, <span class="string">&#x27;请咨询具体价格&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;hours&#x27;</span>: venue.get(<span class="string">&#x27;opening_hours&#x27;</span>, <span class="string">&#x27;请咨询营业时间&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;transport&#x27;</span>: <span class="variable language_">self</span>._get_transport_info(venue[<span class="string">&#x27;address&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;score&#x27;</span>: <span class="built_in">str</span>(venue.get(<span class="string">&#x27;rating&#x27;</span>, <span class="number">4.3</span>)),</span><br><span class="line">                <span class="string">&#x27;reason&#x27;</span>: <span class="string">f&quot;美团平台免验证<span class="subst">&#123;sport&#125;</span>场馆，<span class="subst">&#123;venue.get(<span class="string">&#x27;group_discount&#x27;</span>, <span class="string">&#x27;团购优惠&#x27;</span>)&#125;</span>&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;, &#x27;</span>.join(venue.get(<span class="string">&#x27;features&#x27;</span>, [<span class="string">f&#x27;专业<span class="subst">&#123;sport&#125;</span>场馆&#x27;</span>])),</span><br><span class="line">                <span class="string">&#x27;notes&#x27;</span>: <span class="string">f&quot;美团平台场馆，<span class="subst">&#123;venue.get(<span class="string">&#x27;group_discount&#x27;</span>, <span class="string">&#x27;团购优惠丰富&#x27;</span>)&#125;</span>&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;platform&#x27;</span>: <span class="string">&#x27;美团&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            platform_venues.append(formatted_venue)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 微信小程序场馆</span></span><br><span class="line">        wechat_venues = <span class="variable language_">self</span>.search_toolkit.multi_platform_data.search_wechat_venues(area, sport)</span><br><span class="line">        <span class="keyword">for</span> venue <span class="keyword">in</span> wechat_venues:</span><br><span class="line">            formatted_venue = &#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: venue[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;address&#x27;</span>: venue[<span class="string">&#x27;address&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;contact&#x27;</span>: <span class="string">f&quot;请通过微信小程序&#x27;<span class="subst">&#123;venue.get(<span class="string">&#x27;miniprogram_name&#x27;</span>, <span class="string">&#x27;相关小程序&#x27;</span>)&#125;</span>&#x27;联系&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;price&#x27;</span>: venue.get(<span class="string">&#x27;price_range&#x27;</span>, <span class="string">&#x27;请咨询具体价格&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;hours&#x27;</span>: venue.get(<span class="string">&#x27;opening_hours&#x27;</span>, <span class="string">&#x27;请咨询营业时间&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;transport&#x27;</span>: <span class="variable language_">self</span>._get_transport_info(venue[<span class="string">&#x27;address&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;score&#x27;</span>: <span class="built_in">str</span>(venue.get(<span class="string">&#x27;rating&#x27;</span>, <span class="number">4.5</span>)),</span><br><span class="line">                <span class="string">&#x27;reason&#x27;</span>: <span class="string">f&quot;微信小程序平台免验证<span class="subst">&#123;sport&#125;</span>场馆，在线预约便利&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;, &#x27;</span>.join(venue.get(<span class="string">&#x27;features&#x27;</span>, [<span class="string">f&#x27;专业<span class="subst">&#123;sport&#125;</span>场馆&#x27;</span>])),</span><br><span class="line">                <span class="string">&#x27;notes&#x27;</span>: <span class="string">&#x27;微信小程序平台场馆，在线预约便利&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;platform&#x27;</span>: <span class="string">&#x27;微信小程序&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            platform_venues.append(formatted_venue)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果平台场馆不足，补充已验证场馆</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(platform_venues) &lt; <span class="number">3</span>:</span><br><span class="line">            verified_venues = <span class="variable language_">self</span>.search_toolkit.verification_system.get_real_venues_in_area(area, sport)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果原始区域没有合适场馆，扩展搜索</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(verified_venues) &lt; <span class="number">2</span>:</span><br><span class="line">                expansion_areas = <span class="variable language_">self</span>.search_toolkit.geo_manager.get_expansion_areas(area, expansion_level=<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">for</span> exp_area <span class="keyword">in</span> expansion_areas[<span class="number">1</span>:]:  <span class="comment"># 跳过原始区域</span></span><br><span class="line">                    exp_venues = <span class="variable language_">self</span>.search_toolkit.verification_system.get_real_venues_in_area(exp_area, sport)</span><br><span class="line">                    verified_venues.extend(exp_venues)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加已验证场馆</span></span><br><span class="line">            <span class="keyword">for</span> venue <span class="keyword">in</span> verified_venues[:<span class="number">3</span>-<span class="built_in">len</span>(platform_venues)]:</span><br><span class="line">                formatted_venue = &#123;</span><br><span class="line">                    <span class="string">&#x27;name&#x27;</span>: venue[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;address&#x27;</span>: venue[<span class="string">&#x27;address&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;contact&#x27;</span>: <span class="string">&#x27;请通过官方渠道联系&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;请咨询具体价格&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;hours&#x27;</span>: <span class="string">&#x27;请咨询营业时间&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;transport&#x27;</span>: <span class="variable language_">self</span>._get_transport_info(venue[<span class="string">&#x27;address&#x27;</span>]),</span><br><span class="line">                    <span class="string">&#x27;score&#x27;</span>: <span class="string">&#x27;8.0&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;reason&#x27;</span>: <span class="string">f&quot;已验证的真实<span class="subst">&#123;sport&#125;</span>场馆&quot;</span>,</span><br><span class="line">                    <span class="string">&#x27;features&#x27;</span>: <span class="string">f&quot;支持<span class="subst">&#123;sport&#125;</span>运动的专业场馆&quot;</span>,</span><br><span class="line">                    <span class="string">&#x27;notes&#x27;</span>: <span class="string">&#x27;建议提前电话确认开放时间和价格&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;verified&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                    <span class="string">&#x27;platform&#x27;</span>: <span class="string">&#x27;已验证&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                platform_venues.append(formatted_venue)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果没有找到任何场馆</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> platform_venues:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;⚠️ 警告：未找到平台场馆和已验证场馆&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✅ 找到<span class="subst">&#123;<span class="built_in">len</span>(platform_venues)&#125;</span>个推荐场馆（优先使用平台场馆）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> platform_venues[:<span class="number">5</span>]  <span class="comment"># 最多返回5个场馆</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_transport_info</span>(<span class="params">self, address: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据地址生成交通信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 简化的交通信息生成</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;东城区&#x27;</span> <span class="keyword">in</span> address:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;地铁1号线、2号线、5号线等多条线路可达&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;西城区&#x27;</span> <span class="keyword">in</span> address:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;地铁1号线、2号线、4号线等多条线路可达&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;朝阳区&#x27;</span> <span class="keyword">in</span> address:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;地铁6号线、10号线、14号线等多条线路可达&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;海淀区&#x27;</span> <span class="keyword">in</span> address:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;地铁4号线、10号线、13号线等多条线路可达&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;丰台区&#x27;</span> <span class="keyword">in</span> address:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;地铁9号线、10号线、14号线等多条线路可达&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;石景山区&#x27;</span> <span class="keyword">in</span> address:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;地铁1号线、6号线可达&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;请查询具体交通路线&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_quality_score</span>(<span class="params">self, assessment: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从评估文本中提取质量分数&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 尝试从文本中提取分数</span></span><br><span class="line">            <span class="keyword">import</span> re</span><br><span class="line">            score_match = re.search(<span class="string">r&#x27;(\d+\.?\d*)/5&#x27;</span>, assessment)</span><br><span class="line">            <span class="keyword">if</span> score_match:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">float</span>(score_match.group(<span class="number">1</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果找不到分数，返回默认值</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">4.0</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4.0</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_workforce</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建Workforce实例&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 创建任务列表</span></span><br><span class="line">        tasks = [</span><br><span class="line">            Task(</span><br><span class="line">                content=<span class="string">&quot;收集用户所需运动类型的场馆信息&quot;</span>,</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;task_1&quot;</span>,</span><br><span class="line">                additional_info=<span class="string">&quot;使用搜索工具收集最新的场馆信息&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            Task(</span><br><span class="line">                content=<span class="string">&quot;深度分析用户运动需求和偏好&quot;</span>,</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;task_2&quot;</span>, </span><br><span class="line">                additional_info=<span class="string">&quot;通过RolePlaying进行需求挖掘&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            Task(</span><br><span class="line">                content=<span class="string">&quot;基于信息和需求分析制定推荐方案&quot;</span>,</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;task_3&quot;</span>,</span><br><span class="line">                additional_info=<span class="string">&quot;使用数学工具进行量化决策&quot;</span></span><br><span class="line">            ),</span><br><span class="line">            Task(</span><br><span class="line">                content=<span class="string">&quot;评估推荐质量并提出改进建议&quot;</span>,</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;task_4&quot;</span>,</span><br><span class="line">                additional_info=<span class="string">&quot;全面评估推荐结果的质量&quot;</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建工作节点映射</span></span><br><span class="line">        workers = [</span><br><span class="line">            <span class="variable language_">self</span>.information_collector,</span><br><span class="line">            <span class="variable language_">self</span>.roleplay_analyst,</span><br><span class="line">            <span class="variable language_">self</span>.recommendation_specialist,</span><br><span class="line">            <span class="variable language_">self</span>.quality_assessor</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建Workforce实例</span></span><br><span class="line">        workforce = Workforce(</span><br><span class="line">            workers=workers,</span><br><span class="line">            tasks=tasks</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> workforce</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @smart_retry(<span class="params">RetryConfig(<span class="params">max_retries=<span class="number">3</span>, base_delay=<span class="number">2.0</span>, backoff_factor=<span class="number">1.5</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_workforce_recommendation</span>(<span class="params">self, use_random_case=<span class="literal">True</span>, custom_case=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启动Workforce版推荐流程（增强版）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n🎯 Workforce版AI运动场馆推荐系统启动&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成用户需求</span></span><br><span class="line">        <span class="keyword">if</span> use_random_case:</span><br><span class="line">            user_description, case_info = <span class="variable language_">self</span>.ai_user.create_enhanced_profile()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user_description, case_info = <span class="variable language_">self</span>.ai_user.create_enhanced_profile(custom_case)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取相关历史记录（智能记忆功能）</span></span><br><span class="line">        relevant_history = <span class="variable language_">self</span>.memory_manager.get_relevant_history(user_description, max_records=<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建智能上下文</span></span><br><span class="line">        history_context = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> relevant_history:</span><br><span class="line">            history_context = <span class="string">&quot;📚 相关历史经验:\n&quot;</span></span><br><span class="line">            <span class="keyword">for</span> i, (content, score) <span class="keyword">in</span> <span class="built_in">enumerate</span>(relevant_history):</span><br><span class="line">                history_context += <span class="string">f&quot;历史记录<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>(相关度:<span class="subst">&#123;score:<span class="number">.2</span>f&#125;</span>): <span class="subst">&#123;content[:<span class="number">200</span>]&#125;</span>...\n&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;🧠 找到<span class="subst">&#123;<span class="built_in">len</span>(relevant_history)&#125;</span>条相关历史记录&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            history_context = <span class="string">&quot;这是新用户的首次咨询&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;🆕 新用户首次咨询&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n🔄 开始Workforce协作流程...&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段1：信息收集（带扩展搜索）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n📊 阶段1：信息收集（智能扩展搜索）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用优化的扩展搜索功能（并行获取多平台数据）</span></span><br><span class="line">        expanded_search_results = <span class="variable language_">self</span>.search_toolkit.optimized_venue_search(case_info, case_info[<span class="string">&#x27;location&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        collection_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        请收集以下用户需求相关的运动场馆信息：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        用户需求：<span class="subst">&#123;user_description&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        搜索重点：</span></span><br><span class="line"><span class="string">        - 运动类型：<span class="subst">&#123;case_info[<span class="string">&#x27;sport_preference&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        - 位置区域：<span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        - 特殊需求：<span class="subst">&#123;case_info[<span class="string">&#x27;special_needs&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        - 预算范围：<span class="subst">&#123;case_info[<span class="string">&#x27;budget_range&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        扩展搜索结果：</span></span><br><span class="line"><span class="string">        - 搜索区域：<span class="subst">&#123;expanded_search_results[<span class="string">&#x27;search_areas&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        - 扩展级别：<span class="subst">&#123;expanded_search_results[<span class="string">&#x27;expansion_level&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        - 已验证场馆数量：<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>])&#125;</span></span></span><br><span class="line"><span class="string">        - 大众点评场馆数量：<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>])&#125;</span>（免验证）</span></span><br><span class="line"><span class="string">        - 美团场馆数量：<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>])&#125;</span>（免验证）</span></span><br><span class="line"><span class="string">        - 微信小程序场馆数量：<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>])&#125;</span>（免验证）</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        已验证的真实场馆：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        大众点评平台场馆（免验证）：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        美团平台场馆（免验证）：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        微信小程序平台场馆（免验证）：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请基于扩展搜索结果和所有场馆信息（包括平台免验证场馆），整理完整的场馆信息。</span></span><br><span class="line"><span class="string">        重要：</span></span><br><span class="line"><span class="string">        1. 已验证场馆和平台场馆（大众点评/美团/微信小程序）都可以直接使用</span></span><br><span class="line"><span class="string">        2. 平台场馆已经过平台审核，无需额外验证</span></span><br><span class="line"><span class="string">        3. 不要编造任何场馆数据</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        collection_result = <span class="variable language_">self</span>.information_collector.step(</span><br><span class="line">            BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=collection_prompt)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        collected_info = collection_result.msg.content <span class="keyword">if</span> collection_result.msg <span class="keyword">else</span> <span class="string">&quot;信息收集失败&quot;</span></span><br><span class="line">        total_platform_venues = (<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>]) + </span><br><span class="line">                                <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>]) + </span><br><span class="line">                                <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>]))</span><br><span class="line">        total_venues = <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>]) + total_platform_venues</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;信息收集完成：搜索了<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;search_areas&#x27;</span>])&#125;</span>个区域&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;找到<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>])&#125;</span>个已验证场馆&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;找到<span class="subst">&#123;total_platform_venues&#125;</span>个平台免验证场馆（大众点评<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>])&#125;</span>个，美团<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>])&#125;</span>个，微信<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>])&#125;</span>个）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;总计<span class="subst">&#123;total_venues&#125;</span>个可用场馆&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否需要优先级确认（考虑平台场馆）</span></span><br><span class="line">        needs_priority_check = (</span><br><span class="line">            total_venues &lt; <span class="number">3</span> <span class="keyword">or</span> </span><br><span class="line">            expanded_search_results[<span class="string">&#x27;expansion_level&#x27;</span>] &gt; <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        priority_confirmation = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> needs_priority_check:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n阶段1.5：需求优先级确认&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">            </span><br><span class="line">            priority_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            由于在用户指定区域（<span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span>）找到的合适场馆较少，</span></span><br><span class="line"><span class="string">            我们已经扩展搜索到<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;search_areas&#x27;</span>])&#125;</span>个区域。</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            用户需求：</span></span><br><span class="line"><span class="string">            - 运动类型：<span class="subst">&#123;case_info[<span class="string">&#x27;sport_preference&#x27;</span>]&#125;</span>（核心需求，不可妥协）</span></span><br><span class="line"><span class="string">            - 位置区域：<span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span>（已扩展搜索）</span></span><br><span class="line"><span class="string">            - 特殊需求：<span class="subst">&#123;case_info[<span class="string">&#x27;special_needs&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">            - 预算范围：<span class="subst">&#123;case_info[<span class="string">&#x27;budget_range&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">            - 运动时间：<span class="subst">&#123;case_info[<span class="string">&#x27;preferred_time&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">            - 交通方式：<span class="subst">&#123;case_info[<span class="string">&#x27;transport_mode&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请帮助用户确认需求优先级：</span></span><br><span class="line"><span class="string">            1. 分析哪些需求是必须满足的</span></span><br><span class="line"><span class="string">            2. 哪些需求可以适当妥协</span></span><br><span class="line"><span class="string">            3. 为扩大搜索范围提供建议</span></span><br><span class="line"><span class="string">            4. 说明妥协的合理性和必要性</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            目标：在保证核心需求的前提下，找到最适合的运动场馆。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            priority_result = <span class="variable language_">self</span>.priority_consultant.step(</span><br><span class="line">                BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=priority_prompt)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            priority_confirmation = priority_result.msg.content <span class="keyword">if</span> priority_result.msg <span class="keyword">else</span> <span class="string">&quot;优先级确认失败&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;需求优先级确认完成&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段2：需求分析（使用RolePlaying）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n阶段2：深度需求分析（RolePlaying模式）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化RolePlaying会话</span></span><br><span class="line">        analysis_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        请对以下用户进行深度需求分析：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        用户基本信息：<span class="subst">&#123;user_description&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请通过对话深入了解用户的真实需求、偏好和约束条件。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 设置RolePlaying的初始消息</span></span><br><span class="line">        roleplay_input = <span class="variable language_">self</span>.roleplay_analyst.init_chat()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 进行几轮RolePlaying对话</span></span><br><span class="line">        analysis_results = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):  <span class="comment"># 进行3轮深度分析对话</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                assistant_response, user_response = <span class="variable language_">self</span>.roleplay_analyst.step(roleplay_input)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> assistant_response.msg:</span><br><span class="line">                    analysis_results.append(assistant_response.msg.content)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;分析师第<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>轮：<span class="subst">&#123;assistant_response.msg.content[:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> user_response.msg:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;用户第<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>轮：<span class="subst">&#123;user_response.msg.content[:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                    roleplay_input = assistant_response.msg</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> assistant_response.terminated <span class="keyword">or</span> user_response.terminated:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;RolePlaying第<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>轮出现问题：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        needs_analysis = <span class="string">&quot;\n&quot;</span>.join(analysis_results) <span class="keyword">if</span> analysis_results <span class="keyword">else</span> <span class="string">&quot;需求分析未完成&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;需求分析完成&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段3：推荐决策制定（基于真实场馆）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n阶段3：推荐决策制定（真实场馆优先）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        decision_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于以下信息制定个性化推荐方案：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        用户需求：<span class="subst">&#123;user_description&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        收集的场馆信息：<span class="subst">&#123;collected_info&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        深度需求分析：<span class="subst">&#123;needs_analysis&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        需求优先级确认：<span class="subst">&#123;priority_confirmation&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        已验证的真实场馆数据：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        大众点评平台场馆（免验证）：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        美团平台场馆（免验证）：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        微信小程序平台场馆（免验证）：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;json.dumps(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>], ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        搜索范围信息：</span></span><br><span class="line"><span class="string">        - 搜索区域：<span class="subst">&#123;expanded_search_results[<span class="string">&#x27;search_areas&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        - 扩展级别：<span class="subst">&#123;expanded_search_results[<span class="string">&#x27;expansion_level&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请使用数学工具进行量化分析，制定3-5个具体的场馆推荐方案。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        重要要求：</span></span><br><span class="line"><span class="string">        1. 优先推荐平台免验证场馆（大众点评/美团/微信小程序），其次推荐已验证场馆</span></span><br><span class="line"><span class="string">        2. 平台场馆已经过平台审核，质量有保障，可以直接推荐</span></span><br><span class="line"><span class="string">        3. 每个推荐必须包含：场馆名称、地址、联系方式、价格、推荐理由</span></span><br><span class="line"><span class="string">        4. 标明场馆的验证状态（平台免验证/已验证）</span></span><br><span class="line"><span class="string">        5. 说明推荐场馆与用户需求的匹配度</span></span><br><span class="line"><span class="string">        6. 如果推荐了扩展区域的场馆，要说明交通方案</span></span><br><span class="line"><span class="string">        7. 绝对不要编造或虚构场馆信息</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        推荐优先级：大众点评场馆 &gt; 美团场馆 &gt; 微信小程序场馆 &gt; 已验证场馆 &gt; 其他场馆</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        decision_result = <span class="variable language_">self</span>.recommendation_specialist.step(</span><br><span class="line">            BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=decision_prompt)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        recommendation = decision_result.msg.content <span class="keyword">if</span> decision_result.msg <span class="keyword">else</span> <span class="string">&quot;推荐生成失败&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;推荐方案完成：基于<span class="subst">&#123;<span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>])&#125;</span>个已验证场馆&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段4：质量评估</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n阶段4：质量评估&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        assessment_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        请评估以下推荐结果的质量：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        原始用户需求：<span class="subst">&#123;user_description&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        最终推荐方案：<span class="subst">&#123;recommendation&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请从完整性、相关性、可操作性、实用性、个性化程度等维度进行评估，</span></span><br><span class="line"><span class="string">        并给出具体的评分和改进建议。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请以JSON格式输出评估结果，包含：</span></span><br><span class="line"><span class="string">        &#123;&#123;</span></span><br><span class="line"><span class="string">            &quot;scores&quot;: &#123;&#123;</span></span><br><span class="line"><span class="string">                &quot;completeness&quot;: 0.0-1.0,</span></span><br><span class="line"><span class="string">                &quot;relevance&quot;: 0.0-1.0,</span></span><br><span class="line"><span class="string">                &quot;actionability&quot;: 0.0-1.0,</span></span><br><span class="line"><span class="string">                &quot;practicality&quot;: 0.0-1.0,</span></span><br><span class="line"><span class="string">                &quot;personalization&quot;: 0.0-1.0</span></span><br><span class="line"><span class="string">            &#125;&#125;,</span></span><br><span class="line"><span class="string">            &quot;overall_score&quot;: 0.0-5.0,</span></span><br><span class="line"><span class="string">            &quot;improvement_suggestions&quot;: [&quot;建议1&quot;, &quot;建议2&quot;, &quot;建议3&quot;],</span></span><br><span class="line"><span class="string">            &quot;missing_information&quot;: [&quot;缺失信息1&quot;, &quot;缺失信息2&quot;],</span></span><br><span class="line"><span class="string">            &quot;optimization_areas&quot;: [&quot;优化方向1&quot;, &quot;优化方向2&quot;]</span></span><br><span class="line"><span class="string">        &#125;&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        assessment_result = <span class="variable language_">self</span>.quality_assessor.step(</span><br><span class="line">            BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=assessment_prompt)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        quality_assessment = assessment_result.msg.content <span class="keyword">if</span> assessment_result.msg <span class="keyword">else</span> <span class="string">&quot;质量评估失败&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;质量评估完成：<span class="subst">&#123;quality_assessment[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段5：改进执行</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n阶段5：改进执行与标准化输出&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br><span class="line">        </span><br><span class="line">        improvement_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据质量评估的结果，请优化和完善推荐方案：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        原始用户信息：<span class="subst">&#123;case_info&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        用户需求描述：<span class="subst">&#123;user_description&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        收集的场馆信息：<span class="subst">&#123;collected_info&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        需求分析结果：<span class="subst">&#123;needs_analysis&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        初始推荐方案：<span class="subst">&#123;recommendation&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        质量评估结果：<span class="subst">&#123;quality_assessment&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请根据评估建议进行以下改进：</span></span><br><span class="line"><span class="string">        1. 补充缺失的场馆详细信息</span></span><br><span class="line"><span class="string">        2. 优化推荐内容的结构和逻辑</span></span><br><span class="line"><span class="string">        3. 增强个性化建议</span></span><br><span class="line"><span class="string">        4. 提供更具体的行动指导</span></span><br><span class="line"><span class="string">        5. 使用统一的标准化模板格式</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请生成最终的标准化推荐报告，确保信息完整、结构清晰、个性化程度高。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        improvement_result = <span class="variable language_">self</span>.improvement_executor.step(</span><br><span class="line">            BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=improvement_prompt)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        final_recommendation = improvement_result.msg.content <span class="keyword">if</span> improvement_result.msg <span class="keyword">else</span> <span class="string">&quot;改进执行失败&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;改进执行完成：<span class="subst">&#123;final_recommendation[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用统一模板格式化最终输出</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 解析场馆信息（简化处理）</span></span><br><span class="line">            venues_data = <span class="variable language_">self</span>._extract_venue_data_from_recommendation(final_recommendation, case_info)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成标准化报告</span></span><br><span class="line">            standardized_report = RecommendationTemplate.format_final_recommendation(</span><br><span class="line">                user_info=case_info,</span><br><span class="line">                venues=venues_data,</span><br><span class="line">                analysis=needs_analysis[:<span class="number">500</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(needs_analysis) &gt; <span class="number">500</span> <span class="keyword">else</span> needs_analysis</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;标准化报告生成完成&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;标准化处理出现问题，使用改进后的推荐: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            standardized_report = final_recommendation</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证推荐结果质量（使用优化版本的验证器）</span></span><br><span class="line">        quality_metrics = <span class="variable language_">self</span>.validator.validate_recommendation(final_recommendation, case_info)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n📊 推荐质量评估:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;完整性: <span class="subst">&#123;quality_metrics[<span class="string">&#x27;completeness&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;相关性: <span class="subst">&#123;quality_metrics[<span class="string">&#x27;relevance&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;具体性: <span class="subst">&#123;quality_metrics[<span class="string">&#x27;specificity&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;可操作性: <span class="subst">&#123;quality_metrics[<span class="string">&#x27;actionability&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;总体质量: <span class="subst">&#123;quality_metrics[<span class="string">&#x27;overall_quality&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存到增强记忆系统</span></span><br><span class="line">        metadata = &#123;</span><br><span class="line">            <span class="string">&quot;case_info&quot;</span>: case_info,</span><br><span class="line">            <span class="string">&quot;workflow_type&quot;</span>: <span class="string">&quot;workforce_enhanced&quot;</span>,</span><br><span class="line">            <span class="string">&quot;stages_completed&quot;</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="string">&quot;quality_score&quot;</span>: <span class="variable language_">self</span>._extract_quality_score(quality_assessment),</span><br><span class="line">            <span class="string">&quot;quality_metrics&quot;</span>: quality_metrics,</span><br><span class="line">            <span class="string">&quot;tool_usage&quot;</span>: <span class="string">&quot;workforce_collaboration&quot;</span>,</span><br><span class="line">            <span class="string">&quot;history_context_used&quot;</span>: <span class="built_in">len</span>(relevant_history) &gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.memory_manager.write_enhanced_record(</span><br><span class="line">            user_description, </span><br><span class="line">            standardized_report, </span><br><span class="line">            metadata</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新用户偏好模型</span></span><br><span class="line">        user_id = <span class="string">f&quot;user_<span class="subst">&#123;<span class="built_in">hash</span>(user_description) % <span class="number">10000</span>&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.memory_manager.update_user_preferences(user_id, case_info)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n💾 增强版Workforce协作结果已保存到记忆系统&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;🎯 用户偏好模型已更新&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回完整结果</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;case_info&quot;</span>: case_info,</span><br><span class="line">            <span class="string">&quot;user_description&quot;</span>: user_description,</span><br><span class="line">            <span class="string">&quot;search_results&quot;</span>: expanded_search_results,</span><br><span class="line">            <span class="string">&quot;priority_confirmation&quot;</span>: priority_confirmation,</span><br><span class="line">            <span class="string">&quot;collected_info&quot;</span>: collected_info,</span><br><span class="line">            <span class="string">&quot;needs_analysis&quot;</span>: needs_analysis,</span><br><span class="line">            <span class="string">&quot;initial_recommendation&quot;</span>: recommendation,</span><br><span class="line">            <span class="string">&quot;quality_assessment&quot;</span>: quality_assessment,</span><br><span class="line">            <span class="string">&quot;final_recommendation&quot;</span>: final_recommendation,</span><br><span class="line">            <span class="string">&quot;standardized_report&quot;</span>: standardized_report,</span><br><span class="line">            <span class="string">&quot;verified_venues_count&quot;</span>: <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>]),</span><br><span class="line">            <span class="string">&quot;platform_venues_count&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;dianping&quot;</span>: <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>]),</span><br><span class="line">                <span class="string">&quot;meituan&quot;</span>: <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>]),</span><br><span class="line">                <span class="string">&quot;wechat&quot;</span>: <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>])</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;total_venues_count&quot;</span>: <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;verified_venues&#x27;</span>]) + </span><br><span class="line">                                <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;dianping_venues&#x27;</span>]) + </span><br><span class="line">                                <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;meituan_venues&#x27;</span>]) + </span><br><span class="line">                                <span class="built_in">len</span>(expanded_search_results[<span class="string">&#x27;wechat_venues&#x27;</span>]),</span><br><span class="line">            <span class="string">&quot;search_areas&quot;</span>: expanded_search_results[<span class="string">&#x27;search_areas&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;expansion_level&quot;</span>: expanded_search_results[<span class="string">&#x27;expansion_level&#x27;</span>],</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_enhanced_memory_analysis</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;增强的记忆分析（从优化版本适配）&quot;&quot;&quot;</span></span><br><span class="line">        all_history = <span class="variable language_">self</span>.memory_manager.chat_history.retrieve(window_size=<span class="number">20</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all_history:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;📊 暂无历史记录&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n📊 增强记忆系统分析报告:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计分析</span></span><br><span class="line">        user_requests = []</span><br><span class="line">        recommendations = []</span><br><span class="line">        quality_scores = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> all_history:</span><br><span class="line">            content = record.memory_record.message.content</span><br><span class="line">            <span class="keyword">if</span> record.memory_record.message.role_name == <span class="string">&quot;User&quot;</span>:</span><br><span class="line">                user_requests.append(content)</span><br><span class="line">                <span class="comment"># 提取质量分数</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;[元数据:&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        metadata_str = content.split(<span class="string">&quot;[元数据:&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;]&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">                        metadata = json.loads(metadata_str)</span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&quot;quality_metrics&quot;</span> <span class="keyword">in</span> metadata:</span><br><span class="line">                            quality_scores.append(metadata[<span class="string">&quot;quality_metrics&quot;</span>][<span class="string">&quot;overall_quality&quot;</span>])</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> record.memory_record.message.role_name == <span class="string">&quot;SportsConsultant&quot;</span>:</span><br><span class="line">                recommendations.append(content)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;📈 总处理请求数: <span class="subst">&#123;<span class="built_in">len</span>(user_requests)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;📋 总推荐方案数: <span class="subst">&#123;<span class="built_in">len</span>(recommendations)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> quality_scores:</span><br><span class="line">            avg_quality = <span class="built_in">sum</span>(quality_scores) / <span class="built_in">len</span>(quality_scores)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;⭐ 平均推荐质量: <span class="subst">&#123;avg_quality:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;🏆 最高质量分数: <span class="subst">&#123;<span class="built_in">max</span>(quality_scores):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;📉 最低质量分数: <span class="subst">&#123;<span class="built_in">min</span>(quality_scores):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 用户偏好分析</span></span><br><span class="line">        sport_preferences = &#123;&#125;</span><br><span class="line">        location_preferences = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> request <span class="keyword">in</span> user_requests:</span><br><span class="line">            <span class="comment"># 运动偏好统计</span></span><br><span class="line">            sports = [<span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;羽毛球&quot;</span>, <span class="string">&quot;游泳&quot;</span>, <span class="string">&quot;健身&quot;</span>, <span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;足球&quot;</span>, <span class="string">&quot;网球&quot;</span>, <span class="string">&quot;瑜伽&quot;</span>, <span class="string">&quot;乒乓球&quot;</span>, <span class="string">&quot;攀岩&quot;</span>]</span><br><span class="line">            <span class="keyword">for</span> sport <span class="keyword">in</span> sports:</span><br><span class="line">                <span class="keyword">if</span> sport <span class="keyword">in</span> request:</span><br><span class="line">                    sport_preferences[sport] = sport_preferences.get(sport, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 位置偏好统计</span></span><br><span class="line">            locations = [<span class="string">&quot;朝阳&quot;</span>, <span class="string">&quot;海淀&quot;</span>, <span class="string">&quot;东城&quot;</span>, <span class="string">&quot;西城&quot;</span>, <span class="string">&quot;丰台&quot;</span>, <span class="string">&quot;石景山&quot;</span>]</span><br><span class="line">            <span class="keyword">for</span> location <span class="keyword">in</span> locations:</span><br><span class="line">                <span class="keyword">if</span> location <span class="keyword">in</span> request:</span><br><span class="line">                    location_preferences[location] = location_preferences.get(location, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sport_preferences:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;🏃 运动偏好排行: <span class="subst">&#123;<span class="built_in">dict</span>(<span class="built_in">sorted</span>(sport_preferences.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> location_preferences:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;📍 区域偏好排行: <span class="subst">&#123;<span class="built_in">dict</span>(<span class="built_in">sorted</span>(location_preferences.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>))&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">benchmark_system_performance</span>(<span class="params">self, num_tests: <span class="built_in">int</span> = <span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;系统性能基准测试（从优化版本适配）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n🧪 开始Workforce系统性能基准测试 (<span class="subst">&#123;num_tests&#125;</span>次测试)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        results = []</span><br><span class="line">        total_start_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_tests):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n测试 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_tests&#125;</span>&quot;</span>)</span><br><span class="line">            start_time = datetime.now()</span><br><span class="line">            </span><br><span class="line">            result = <span class="variable language_">self</span>.start_workforce_recommendation(use_random_case=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            end_time = datetime.now()</span><br><span class="line">            duration = (end_time - start_time).total_seconds()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取质量分数</span></span><br><span class="line">            quality_score = <span class="number">0.0</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;quality_assessment&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">                    <span class="comment"># 简化的质量分数提取</span></span><br><span class="line">                    quality_score = <span class="variable language_">self</span>._extract_quality_score(result[<span class="string">&#x27;quality_assessment&#x27;</span>])</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                quality_score = <span class="number">0.5</span>  <span class="comment"># 默认分数</span></span><br><span class="line">            </span><br><span class="line">            test_result = &#123;</span><br><span class="line">                <span class="string">&quot;test_id&quot;</span>: i+<span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: duration,</span><br><span class="line">                <span class="string">&quot;quality_score&quot;</span>: quality_score,</span><br><span class="line">                <span class="string">&quot;total_venues&quot;</span>: result.get(<span class="string">&#x27;total_venues_count&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;verified_venues&quot;</span>: result.get(<span class="string">&#x27;verified_venues_count&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;platform_venues&quot;</span>: <span class="built_in">sum</span>(result.get(<span class="string">&#x27;platform_venues_count&#x27;</span>, &#123;&#125;).values()),</span><br><span class="line">                <span class="string">&quot;expansion_level&quot;</span>: result.get(<span class="string">&#x27;expansion_level&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            results.append(test_result)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;⏱️  耗时: <span class="subst">&#123;duration:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;⭐ 质量: <span class="subst">&#123;test_result[<span class="string">&#x27;quality_score&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;🏢 场馆数: <span class="subst">&#123;test_result[<span class="string">&#x27;total_venues&#x27;</span>]&#125;</span>个&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        total_end_time = datetime.now()</span><br><span class="line">        total_duration = (total_end_time - total_start_time).total_seconds()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算统计数据</span></span><br><span class="line">        avg_duration = <span class="built_in">sum</span>(r[<span class="string">&quot;duration&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results) / <span class="built_in">len</span>(results)</span><br><span class="line">        avg_quality = <span class="built_in">sum</span>(r[<span class="string">&quot;quality_score&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results) / <span class="built_in">len</span>(results)</span><br><span class="line">        avg_venues = <span class="built_in">sum</span>(r[<span class="string">&quot;total_venues&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results) / <span class="built_in">len</span>(results)</span><br><span class="line">        avg_verified = <span class="built_in">sum</span>(r[<span class="string">&quot;verified_venues&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results) / <span class="built_in">len</span>(results)</span><br><span class="line">        avg_platform = <span class="built_in">sum</span>(r[<span class="string">&quot;platform_venues&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results) / <span class="built_in">len</span>(results)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n📊 Workforce系统基准测试结果汇总:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;总耗时: <span class="subst">&#123;total_duration:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平均单次耗时: <span class="subst">&#123;avg_duration:<span class="number">.2</span>f&#125;</span>秒&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平均质量分数: <span class="subst">&#123;avg_quality:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平均场馆数量: <span class="subst">&#123;avg_venues:<span class="number">.1</span>f&#125;</span>个&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平均已验证场馆: <span class="subst">&#123;avg_verified:<span class="number">.1</span>f&#125;</span>个&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平均平台场馆: <span class="subst">&#123;avg_platform:<span class="number">.1</span>f&#125;</span>个&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;系统稳定性: <span class="subst">&#123;<span class="string">&#x27;优秀&#x27;</span> <span class="keyword">if</span> avg_quality &gt; <span class="number">0.7</span> <span class="keyword">else</span> <span class="string">&#x27;良好&#x27;</span> <span class="keyword">if</span> avg_quality &gt; <span class="number">0.5</span> <span class="keyword">else</span> <span class="string">&#x27;需要改进&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">use_mock_data_if_no_key=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数 - 演示Workforce版运动场馆推荐系统</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        use_mock_data_if_no_key: 是否在API密钥未设置或API调用失败时使用模拟数据作为备用</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;启动Workforce版运动场馆推荐系统&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;API调用模式: <span class="subst">&#123;<span class="string">&#x27;优先使用真实API，备用模拟数据&#x27;</span> <span class="keyword">if</span> use_mock_data_if_no_key <span class="keyword">else</span> <span class="string">&#x27;仅使用真实API，无备用数据&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建系统实例</span></span><br><span class="line">        system = WorkforceSportsVenueRecommendationSystem(model, use_mock_data_if_no_key=use_mock_data_if_no_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 运行推荐流程</span></span><br><span class="line">        result = system.start_workforce_recommendation(use_random_case=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n增强版Workforce协作完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;用户画像：<span class="subst">&#123;result[<span class="string">&#x27;case_info&#x27;</span>][<span class="string">&#x27;occupation&#x27;</span>]&#125;</span> - <span class="subst">&#123;result[<span class="string">&#x27;case_info&#x27;</span>][<span class="string">&#x27;sport_preference&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;信息收集：完成（搜索<span class="subst">&#123;<span class="built_in">len</span>(result[<span class="string">&#x27;search_areas&#x27;</span>])&#125;</span>个区域）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;扩展搜索：级别<span class="subst">&#123;result[<span class="string">&#x27;expansion_level&#x27;</span>]&#125;</span>（找到<span class="subst">&#123;result[<span class="string">&#x27;verified_venues_count&#x27;</span>]&#125;</span>个已验证场馆）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平台场馆：大众点评<span class="subst">&#123;result[<span class="string">&#x27;platform_venues_count&#x27;</span>][<span class="string">&#x27;dianping&#x27;</span>]&#125;</span>个，美团<span class="subst">&#123;result[<span class="string">&#x27;platform_venues_count&#x27;</span>][<span class="string">&#x27;meituan&#x27;</span>]&#125;</span>个，微信<span class="subst">&#123;result[<span class="string">&#x27;platform_venues_count&#x27;</span>][<span class="string">&#x27;wechat&#x27;</span>]&#125;</span>个（免验证）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;总计场馆：<span class="subst">&#123;result[<span class="string">&#x27;total_venues_count&#x27;</span>]&#125;</span>个可用场馆&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> result[<span class="string">&#x27;priority_confirmation&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;优先级确认：完成&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;需求分析：完成（RolePlaying模式）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;推荐决策：完成（基于真实场馆数据）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;质量评估：完成&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;改进执行：完成（真实性验证+统一模板输出）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n初始推荐方案：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(result[<span class="string">&#x27;initial_recommendation&#x27;</span>][:<span class="number">300</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(result[<span class="string">&#x27;initial_recommendation&#x27;</span>]) &gt; <span class="number">300</span> <span class="keyword">else</span> result[<span class="string">&#x27;initial_recommendation&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n质量评估结果：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(result[<span class="string">&#x27;quality_assessment&#x27;</span>][:<span class="number">300</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(result[<span class="string">&#x27;quality_assessment&#x27;</span>]) &gt; <span class="number">300</span> <span class="keyword">else</span> result[<span class="string">&#x27;quality_assessment&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n改进后推荐方案：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(result[<span class="string">&#x27;final_recommendation&#x27;</span>][:<span class="number">300</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(result[<span class="string">&#x27;final_recommendation&#x27;</span>]) &gt; <span class="number">300</span> <span class="keyword">else</span> result[<span class="string">&#x27;final_recommendation&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n标准化推荐报告：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="built_in">print</span>(result[<span class="string">&#x27;standardized_report&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记忆分析演示</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n🧠 记忆系统分析演示：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        system.get_enhanced_memory_analysis()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 询问是否进行性能基准测试</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n🧪 是否进行系统性能基准测试？&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;这将运行多次推荐流程来评估系统性能&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;输入 &#x27;y&#x27; 或 &#x27;yes&#x27; 确认，其他键跳过&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 在实际使用中可以取消注释以下代码来启用交互式测试</span></span><br><span class="line">        <span class="comment"># user_input = input(&quot;请选择: &quot;).strip().lower()</span></span><br><span class="line">        <span class="comment"># if user_input in [&#x27;y&#x27;, &#x27;yes&#x27;]:</span></span><br><span class="line">        <span class="comment">#     system.benchmark_system_performance(num_tests=3)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     print(&quot;跳过性能基准测试&quot;)</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n🎉 Workforce版增强系统演示完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 智能记忆管理系统成功实现用户偏好学习&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 多Agent协作提升了推荐准确度和完整性&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 结果验证系统确保了推荐质量&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ 真实平台数据源提供了可靠的场馆信息&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;❌ 系统运行出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        traceback.print_exc()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> argparse</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建命令行参数解析器</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Workforce版运动场馆推荐系统&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--no-mock&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;禁用模拟数据备用模式，仅使用真实API&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--mock&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;启用模拟数据备用模式（默认）&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 确定是否使用模拟数据作为备用</span></span><br><span class="line">    use_mock_data = <span class="keyword">not</span> args.no_mock <span class="keyword">if</span> <span class="keyword">not</span> args.mock <span class="keyword">else</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行主函数</span></span><br><span class="line">    main(use_mock_data_if_no_key=use_mock_data)</span><br></pre></td></tr></table></figure>
<p>代码比较长，我们直接试运行一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/CAMEL_Prompt_task2_workforce.py</span><br><span class="line">启动Workforce版运动场馆推荐系统</span><br><span class="line">================================================================================</span><br><span class="line">API调用模式: 优先使用真实API，备用模拟数据</span><br><span class="line">================================================================================ </span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_linkup&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;searchResults&#x27;, &#x27;sourcedAnswer&#x27;, &#x27;structured&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;OneDay&#x27;, &#x27;OneWeek&#x27;, &#x27;OneMonth&#x27;, &#x27;OneYear&#x27;, &#x27;NoLimit&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;anyOf&#x27;: [&#123;&#x27;enum&#x27;: [&#x27;finance&#x27;, &#x27;law&#x27;, &#x27;medical&#x27;, &#x27;internet&#x27;, &#x27;tax&#x27;, &#x27;news_province&#x27;, &#x27;news_center&#x27;], &#x27;type&#x27;: &#x27;string&#x27;&#125;, &#123;&#x27;type&#x27;: &#x27;null&#x27;&#125;], &#x27;type&#x27;: [&#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">🚀 Workforce版AI运动场馆推荐系统已初始化</span><br><span class="line">✅ 智能记忆管理系统已加载</span><br><span class="line">✅ 结果验证系统已启用</span><br><span class="line">✅ 增强搜索工具包已配置（启用模拟数据备用模式）</span><br><span class="line"></span><br><span class="line">正在创建Workforce工作节点...</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;safe_search_duckduckgo&#x27;. The parameter definition is &#123;&#x27;type&#x27;: &#x27;string&#x27;&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;safe_search_duckduckgo&#x27;. The parameter definition is &#123;&#x27;type&#x27;: [&#x27;integer&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;expanded_venue_search&#x27;. The parameter definition is &#123;&#x27;additionalProperties&#x27;: True, &#x27;type&#x27;: &#x27;object&#x27;&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;expanded_venue_search&#x27;. The parameter definition is &#123;&#x27;type&#x27;: &#x27;string&#x27;&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">✅ 信息收集专员已创建（配备增强搜索工具）</span><br><span class="line">✅ RolePlaying需求分析专员已创建</span><br><span class="line">✅ 推荐决策专员已创建（配备数学工具）</span><br><span class="line">✅ 质量评估专员已创建</span><br><span class="line">✅ 需求优先级确认专员已创建</span><br><span class="line">✅ 改进执行专员已创建（真实性验证+统一模板输出）</span><br><span class="line"></span><br><span class="line">🎯 Workforce版AI运动场馆推荐系统启动</span><br><span class="line">================================================================================ </span><br><span class="line"></span><br><span class="line">增强版用户运动需求案例：</span><br><span class="line">年龄：56-65岁</span><br><span class="line">职业：自由职业者 (收入：3000-8000元)</span><br><span class="line">运动经验：初学者</span><br><span class="line">运动偏好：网球 (每周1-2次)</span><br><span class="line">偏好时间：周末全天</span><br><span class="line">特殊需求：交通便利优先</span><br><span class="line">预算范围：100-200元/次</span><br><span class="line">所在位置：北京市海淀区中关村街道</span><br><span class="line">交通方式：开车</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line">AI用户的详细需求描述：</span><br><span class="line">我是一名56-65岁的自由职业者，住在北京市海淀区中关村街道，打算开始学习网球，希望能通过这项运动增强体质，丰富业余生活。我的运动计划是每周周末全天进行1-2次网球训练，作为初学者，我希望选择一个设施齐全、环境舒适的网球馆，最好能提供专业的教练指导。 考虑到我通常开车出行，因此交通便利性是我选择场馆的重要考量之一。我的预算大约在100-200元每次，希望能在北京海淀区附近找到符合这些条件的网球馆。</span><br><span class="line">--------------------------------------------------</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\memories\blocks\chat_history_block.py:73: UserWarning: The `ChatHistoryMemory` is empty.</span><br><span class="line">  warnings.warn(&quot;The `ChatHistoryMemory` is empty.&quot;)</span><br><span class="line">🆕 新用户首次咨询</span><br><span class="line"></span><br><span class="line">🔄 开始Workforce协作流程...</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">📊 阶段1：信息收集（智能扩展搜索）</span><br><span class="line">----------------------------------------</span><br><span class="line">开始优化搜索: 海淀区 + 网球</span><br><span class="line">正在从大众点评API获取海淀区网球场馆数据...</span><br><span class="line">正在从美团API获取海淀区网球场馆数据...</span><br><span class="line">正在从微信小程序API获取海淀区网球场馆数据...</span><br><span class="line">美团API返回错误状态码: 404，响应内容: &lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line"></span><br><span class="line">使用美团模拟数据（API密钥未设置或API调用失败）</span><br><span class="line">大众点评API调用失败: Expecting value: line 1 column 1 (char 0)</span><br><span class="line">使用大众点评模拟数据（API密钥未设置或API调用失败）</span><br><span class="line">微信小程序API返回错误状态码: 404，响应内容: </span><br><span class="line">使用微信小程序模拟数据（API密钥未设置或API调用失败）</span><br><span class="line">优化搜索完成: 找到11个场馆</span><br><span class="line">数据源分布: 已验证5个 | 大众点评2个 | 美团2个 | 微信2个</span><br><span class="line">信息收集完成：搜索了1个区域</span><br><span class="line">找到5个已验证场馆</span><br><span class="line">找到6个平台免验证场馆（大众点评2个，美团2个，微信2个）</span><br><span class="line">总计11个可用场馆</span><br><span class="line"></span><br><span class="line">阶段2：深度需求分析（RolePlaying模式）</span><br><span class="line">----------------------------------------</span><br><span class="line">分析师第1轮：Solution: 为了更好地了解您的运动需求和偏好，我需要先了解一下您的基本信息。请您分享一下您的年龄、性别、职业等方面的信息，这将帮助我为您提供更个性化的 建议。如果您有任何隐私方面的顾虑，您可以选择不提供某些信息，但提供的信息越多，我 的分析就越准确。</span><br><span class="line"></span><br><span class="line">例如，您可以这样回答：“我今年28岁，男性...</span><br><span class="line">用户第1轮：Instruction: 请告诉我您的基本信息，包括年龄、性别、职业等。</span><br><span class="line">Input: None...</span><br><span class="line">分析师第2轮：Solution: 为了更全面地了解您的生活方式和时间安排，我需要您描述一下您的日常生活习惯。具体来说，可以包括以下几个方面：</span><br><span class="line"></span><br><span class="line">- 工作日的工作时间和周末的工作情况（如果有加班或远程工作的话也请告知）。</span><br><span class="line">- 您每天的休息时间，比如晚上几点睡觉，早上几点起床。</span><br><span class="line">- 日常活动，比如上下班通勤方式、午休...</span><br><span class="line">用户第2轮：Instruction: 请描述您的日常生活习惯，包括工作时间、休息时间以及日常活 动。</span><br><span class="line">Input: None...</span><br><span class="line">分析师第3轮：Solution: 了解您当前的运动习惯对于分析您的需求和偏好非常重要。请您分享以下信息：</span><br><span class="line"></span><br><span class="line">- 您喜欢的运动类型：比如跑步、游泳、健身房锻炼、瑜伽等。</span><br><span class="line">- 您每周进行运动的次数。</span><br><span class="line">- 每次运动的持续时间。</span><br><span class="line">- 您是否参加过任何运动课程或有固定的运动伙伴。</span><br><span class="line">- 您对运动的具体偏好，比如喜欢室内还是室...</span><br><span class="line">用户第3轮：Instruction: 请分享您目前的运动习惯，包括喜欢的运动类型、频率和持续时 间。</span><br><span class="line">Input: None...</span><br><span class="line">需求分析完成</span><br><span class="line"></span><br><span class="line">阶段3：推荐决策制定（真实场馆优先）</span><br><span class="line">----------------------------------------</span><br><span class="line">推荐方案完成：基于5个已验证场馆</span><br><span class="line"></span><br><span class="line">阶段4：质量评估</span><br><span class="line">----------------------------------------</span><br><span class="line">质量评估完成：```json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scores&quot;: &#123;</span><br><span class="line">        &quot;completeness&quot;: 0.85,</span><br><span class="line">        &quot;relevance&quot;: 0.95,</span><br><span class="line">        &quot;actionability&quot;: 0.9,</span><br><span class="line">        &quot;practicality&quot;: 0.9,</span><br><span class="line">        &quot;personalization&quot;: 0.9</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;overall_score&quot;:...</span><br><span class="line"></span><br><span class="line">阶段5：改进执行与标准化输出</span><br><span class="line">----------------------------------------</span><br><span class="line">改进执行完成：### 个性化网球馆推荐方案</span><br><span class="line"></span><br><span class="line">根据您的需求分析，结合场馆的位置、价格、设施及交通便利性，以下是为您精心挑选的3-5个网球馆推荐方案。所有推荐场馆均已验证或来自知名平台，具有较高的可信度。</span><br><span class="line"></span><br><span class="line">#### 1. 海淀区优质网球馆</span><br><span class="line">- **地址**: 北京市海淀区示例路88号</span><br><span class="line">- **联系方式**: 010-12345678</span><br><span class="line">- **价格范围**: ¥80-200/小时</span><br><span class="line">- **开放时间**: 周末全天...</span><br><span class="line">正在从大众点评API获取海淀区网球场馆数据...</span><br><span class="line">大众点评API调用失败: Expecting value: line 1 column 1 (char 0)</span><br><span class="line">使用大众点评模拟数据（API密钥未设置或API调用失败）</span><br><span class="line">正在从美团API获取海淀区网球场馆数据...</span><br><span class="line">美团API返回错误状态码: 404，响应内容: &lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line"></span><br><span class="line">使用美团模拟数据（API密钥未设置或API调用失败）</span><br><span class="line">正在从微信小程序API获取海淀区网球场馆数据...</span><br><span class="line">微信小程序API返回错误状态码: 404，响应内容: </span><br><span class="line">使用微信小程序模拟数据（API密钥未设置或API调用失败）</span><br><span class="line">✅ 找到6个推荐场馆（优先使用平台场馆）</span><br><span class="line">标准化报告生成完成</span><br><span class="line"></span><br><span class="line">📊 推荐质量评估:</span><br><span class="line">完整性: 1.00</span><br><span class="line">相关性: 0.75</span><br><span class="line">具体性: 0.40</span><br><span class="line">可操作性: 0.67</span><br><span class="line">总体质量: 0.70</span><br><span class="line"></span><br><span class="line">💾 增强版Workforce协作结果已保存到记忆系统</span><br><span class="line">🎯 用户偏好模型已更新</span><br><span class="line">================================================================================ </span><br><span class="line"></span><br><span class="line">增强版Workforce协作完成！</span><br><span class="line">================================================================================ </span><br><span class="line">用户画像：自由职业者 - 网球</span><br><span class="line">信息收集：完成（搜索1个区域）</span><br><span class="line">扩展搜索：级别0（找到5个已验证场馆）</span><br><span class="line">平台场馆：大众点评2个，美团2个，微信2个（免验证）</span><br><span class="line">总计场馆：11个可用场馆</span><br><span class="line">需求分析：完成（RolePlaying模式）</span><br><span class="line">推荐决策：完成（基于真实场馆数据）</span><br><span class="line">质量评估：完成</span><br><span class="line">改进执行：完成（真实性验证+统一模板输出）</span><br><span class="line"></span><br><span class="line">初始推荐方案：</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">### 个性化网球馆推荐方案</span><br><span class="line"></span><br><span class="line">根据您的需求分析，结合场馆的位置、价格、设施及交通便利性，以下是为您精心挑选的3-5个网球馆推荐方案：</span><br><span class="line"></span><br><span class="line">1. **海淀区优质网球馆**</span><br><span class="line">   - **地址**: 北京市海淀区示例路88号</span><br><span class="line">   - **联系方式**: 010-12345678</span><br><span class="line">   - **价格范围**: ¥80-200/小时</span><br><span class="line">   - **推荐理由**: 该场馆专为网球爱好者设计，设施齐全，环境舒适。价格适中，符合您的预算。由于其位于海淀区，交通便利，适合驾车前往。此外，该场馆提供专业的教练指导 ，非常适合初学者。</span><br><span class="line">   - **验证状态**: 平台免验证</span><br><span class="line">   - **需求匹配度**:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">质量评估结果：</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scores&quot;: &#123;</span><br><span class="line">        &quot;completeness&quot;: 0.85,</span><br><span class="line">        &quot;relevance&quot;: 0.95,</span><br><span class="line">        &quot;actionability&quot;: 0.9,</span><br><span class="line">        &quot;practicality&quot;: 0.9,</span><br><span class="line">        &quot;personalization&quot;: 0.9</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;overall_score&quot;: 4.5,</span><br><span class="line">    &quot;improvement_suggestions&quot;: [</span><br><span class="line">        &quot;为每个场馆提供更详细的开放时间，尤其是周末的具体时间段。&quot;,</span><br><span class="line">        &quot;补充每个场馆的教练资质和...</span><br><span class="line"></span><br><span class="line">改进后推荐方案：</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">### 个性化网球馆推荐方案</span><br><span class="line"></span><br><span class="line">根据您的需求分析，结合场馆的位置、价格、设施及交通便利性，以下是为您精心挑选的3-5个网球馆推荐方案。所有推荐场馆均已验证或来自知名平台，具有较高的可信度。</span><br><span class="line"></span><br><span class="line">#### 1. 海淀区优质网球馆</span><br><span class="line">- **地址**: 北京市海淀区示例路88号</span><br><span class="line">- **联系方式**: 010-12345678</span><br><span class="line">- **价格范围**: ¥80-200/小时</span><br><span class="line">- **开放时间**: 周末全天（09:00-22:00）</span><br><span class="line">- **教练资质**: 持有国家网球教练证书，平均教学经验超过5年</span><br><span class="line">- **交通便利性**: 位于海淀区，适合驾车前往，周边有地铁10号线知春路站</span><br><span class="line">- **用户评价**: ...</span><br><span class="line"></span><br><span class="line">标准化推荐报告：</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># 个性化运动场馆推荐报告</span><br><span class="line"></span><br><span class="line">## 用户画像</span><br><span class="line">- **年龄段**: 56-65岁</span><br><span class="line">- **职业**: 自由职业者</span><br><span class="line">- **运动偏好**: 网球</span><br><span class="line">- **运动频率**: 每周1-2次</span><br><span class="line">- **预算范围**: 100-200元/次</span><br><span class="line">- **位置**: 北京市海淀区中关村街道</span><br><span class="line">- **特殊需求**: 交通便利优先</span><br><span class="line"></span><br><span class="line">## 需求分析总结</span><br><span class="line">Solution: 为了更好地了解您的运动需求和偏好，我需要先了解一下您的基本信息。请您分 享一下您的年龄、性别、职业等方面的信息，这将帮助我为您提供更个性化的建议。如果您 有任何隐私方面的顾虑，您可以选择不提供某些信息，但提供的信息越多，我的分析就越准 确。</span><br><span class="line"></span><br><span class="line">例如，您可以这样回答：“我今年28岁，男性，是一名软件工程师。”</span><br><span class="line"></span><br><span class="line">请您分享一些基本信息吧！</span><br><span class="line">Next request.</span><br><span class="line">Solution: 为了更全面地了解您的生活方式和时间安排，我需要您描述一下您的日常生活习 惯。具体来说，可以包括以下几个方面：</span><br><span class="line"></span><br><span class="line">- 工作日的工作时间和周末的工作情况（如果有加班或远程工作的话也请告知）。</span><br><span class="line">- 您每天的休息时间，比如晚上几点睡觉，早上几点起床。</span><br><span class="line">- 日常活动，比如上下班通勤方式、午休习惯、晚餐后的活动等。</span><br><span class="line"></span><br><span class="line">这些信息有助于我了解您的生活节奏，从而为您制定合适的运动计划。例如，您可以这样描 述：“我通常早上9点上班，晚上6点下班，每周工作五天。工作日我会在公司吃午饭，然后午休一小时。晚上回家后，我喜欢看看书或者玩玩游戏放松一下，一般晚上11点左右睡觉。”  </span><br><span class="line"></span><br><span class="line">请您描述一下您的日常生活习惯吧！</span><br><span class="line">Next ...</span><br><span class="line"></span><br><span class="line">## 推荐场馆列表</span><br><span class="line"></span><br><span class="line">### 推荐 1:</span><br><span class="line">**海淀区优质网球馆** 大众点评平台免验证场馆</span><br><span class="line">地址：北京市海淀区区示例路88号</span><br><span class="line">联系方式：请通过大众点评平台联系</span><br><span class="line">价格：¥80-200/小时</span><br><span class="line">营业时间：请咨询营业时间</span><br><span class="line">交通方式：地铁4号线、10号线、13号线等多条线路可达</span><br><span class="line">推荐评分：4.8/10</span><br><span class="line">推荐理由：大众点评平台免验证网球场馆，用户评价0条</span><br><span class="line">特色服务：专业网球场馆</span><br><span class="line">注意事项：大众点评平台场馆，用户评价丰富</span><br><span class="line"></span><br><span class="line">### 推荐 2:</span><br><span class="line">**海淀区网球中心** 大众点评平台免验证场馆</span><br><span class="line">地址：北京市海淀区区样板街100号</span><br><span class="line">联系方式：请通过大众点评平台联系</span><br><span class="line">价格：¥60-150/小时</span><br><span class="line">营业时间：请咨询营业时间</span><br><span class="line">交通方式：地铁4号线、10号线、13号线等多条线路可达</span><br><span class="line">推荐评分：4.5/10</span><br><span class="line">推荐理由：大众点评平台免验证网球场馆，用户评价0条</span><br><span class="line">特色服务：专业网球场馆</span><br><span class="line">注意事项：大众点评平台场馆，用户评价丰富</span><br><span class="line"></span><br><span class="line">### 推荐 3:</span><br><span class="line">**海淀区网球专业馆** 美团平台免验证场馆</span><br><span class="line">地址：北京市海淀区区示范路66号</span><br><span class="line">联系方式：请通过美团平台联系</span><br><span class="line">价格：¥70-180/小时</span><br><span class="line">营业时间：请咨询营业时间</span><br><span class="line">交通方式：地铁4号线、10号线、13号线等多条线路可达</span><br><span class="line">推荐评分：4.7/10</span><br><span class="line">推荐理由：美团平台免验证网球场馆，团购优惠</span><br><span class="line">特色服务：专业网球场馆</span><br><span class="line">注意事项：美团平台场馆，团购优惠丰富</span><br><span class="line"></span><br><span class="line">### 推荐 4:</span><br><span class="line">**海淀区全民网球馆** 美团平台免验证场馆</span><br><span class="line">地址：北京市海淀区区模板大街50号</span><br><span class="line">联系方式：请通过美团平台联系</span><br><span class="line">价格：¥50-120/小时</span><br><span class="line">营业时间：请咨询营业时间</span><br><span class="line">交通方式：地铁4号线、10号线、13号线等多条线路可达</span><br><span class="line">推荐评分：4.6/10</span><br><span class="line">推荐理由：美团平台免验证网球场馆，团购优惠</span><br><span class="line">特色服务：专业网球场馆</span><br><span class="line">注意事项：美团平台场馆，团购优惠丰富</span><br><span class="line"></span><br><span class="line">### 推荐 5:</span><br><span class="line">**海淀区网球俱乐部** 微信小程序平台免验证场馆</span><br><span class="line">地址：北京市海淀区区范例大道33号</span><br><span class="line">联系方式：请通过微信小程序&#x27;相关小程序&#x27;联系</span><br><span class="line">价格：¥90-220/小时</span><br><span class="line">营业时间：请咨询营业时间</span><br><span class="line">交通方式：地铁4号线、10号线、13号线等多条线路可达</span><br><span class="line">推荐评分：4.9/10</span><br><span class="line">推荐理由：微信小程序平台免验证网球场馆，在线预约便利</span><br><span class="line">特色服务：专业网球场馆</span><br><span class="line">注意事项：微信小程序平台场馆，在线预约便利</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 个性化建议</span><br><span class="line">- 作为初学者，建议选择有专业教练指导的场馆</span><br><span class="line">- 优先选择交通便利的场馆，减少通勤时间</span><br><span class="line">- 建议先体验1-2个场馆，找到最适合的再长期坚持</span><br><span class="line"></span><br><span class="line">## 下一步行动</span><br><span class="line">1. 联系心仪场馆，咨询详细信息和预约方式</span><br><span class="line">2. 安排时间实地考察，体验场馆环境和设施</span><br><span class="line">3. 比较不同场馆的会员卡价格和优惠政策</span><br><span class="line">4. 制定个人运动计划，确定运动时间和频率</span><br><span class="line">5. 开始规律运动，并定期评估效果</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">*报告生成时间: 2025-07-20 23:17:52*</span><br><span class="line">*推荐有效期: 30天*</span><br><span class="line">*注意：本报告只包含已验证的真实场馆信息*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">🧠 记忆系统分析演示：</span><br><span class="line">================================================================================ </span><br><span class="line"></span><br><span class="line">📊 增强记忆系统分析报告:</span><br><span class="line">============================================================</span><br><span class="line">📈 总处理请求数: 1</span><br><span class="line">📋 总推荐方案数: 1</span><br><span class="line">🏃 运动偏好排行: &#123;&#x27;网球&#x27;: 1&#125;</span><br><span class="line">📍 区域偏好排行: &#123;&#x27;海淀&#x27;: 1&#125;</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">🧪 是否进行系统性能基准测试？</span><br><span class="line">这将运行多次推荐流程来评估系统性能</span><br><span class="line">输入 &#x27;y&#x27; 或 &#x27;yes&#x27; 确认，其他键跳过</span><br><span class="line"></span><br><span class="line">🎉 Workforce版增强系统演示完成！</span><br><span class="line">✅ 智能记忆管理系统成功实现用户偏好学习</span><br><span class="line">✅ 多Agent协作提升了推荐准确度和完整性</span><br><span class="line">✅ 结果验证系统确保了推荐质量</span><br><span class="line">✅ 真实平台数据源提供了可靠的场馆信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>目前版本仍然存在第三方平台API调用等问题，仍然在解决。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/15/Agent-camel%E6%A1%86%E6%9E%B6%E7%BB%83%E4%B9%A0%EF%BC%882%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/15/Agent-camel%E6%A1%86%E6%9E%B6%E7%BB%83%E4%B9%A0%EF%BC%882%EF%BC%89/" class="post-title-link" itemprop="url">Agent_camel框架练习（2）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-15 20:51:15" itemprop="dateCreated datePublished" datetime="2025-07-15T20:51:15+08:00">2025-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-20 23:33:09" itemprop="dateModified" datetime="2025-07-20T23:33:09+08:00">2025-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E4%B8%BB%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">自主练习</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<h2 id="Task1"><a href="#Task1" class="headerlink" title="Task1"></a>Task1</h2><h3 id="01-1-角色扮演任务Agent：使用-AISocietyPromptTemplateDict，创建一个角色扮演任务Agent。假设你想让-AI-扮演一个“健康顾问”，为一个“患者”提供饮食和锻炼建议。请用思维链方式分解整个建议过程，逐步提供健康方案。"><a href="#01-1-角色扮演任务Agent：使用-AISocietyPromptTemplateDict，创建一个角色扮演任务Agent。假设你想让-AI-扮演一个“健康顾问”，为一个“患者”提供饮食和锻炼建议。请用思维链方式分解整个建议过程，逐步提供健康方案。" class="headerlink" title="01.1. 角色扮演任务Agent：使用 AISocietyPromptTemplateDict，创建一个角色扮演任务Agent。假设你想让 AI 扮演一个“健康顾问”，为一个“患者”提供饮食和锻炼建议。请用思维链方式分解整个建议过程，逐步提供健康方案。"></a>01.1. 角色扮演任务Agent：使用 AISocietyPromptTemplateDict，创建一个角色扮演任务Agent。假设你想让 AI 扮演一个“健康顾问”，为一个“患者”提供饮食和锻炼建议。请用思维链方式分解整个建议过程，逐步提供健康方案。</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> TaskSpecifyAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.prompts <span class="keyword">import</span> TextPrompt</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, TaskType</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建模型实例</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># AI患者Agent - 随机生成患者案例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIPatientAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义AI患者的提示模板</span></span><br><span class="line">        <span class="variable language_">self</span>.patient_prompt = TextPrompt(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;你是一位需要健康咨询的AI患者。请根据以下信息生成一个真实的患者案例：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            年龄范围：&#123;age_range&#125;</span></span><br><span class="line"><span class="string">            身份职业：&#123;occupation&#125;</span></span><br><span class="line"><span class="string">            主要症状：&#123;symptoms&#125;</span></span><br><span class="line"><span class="string">            潜在原因：&#123;potential_causes&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请以第一人称的方式描述你的情况，包括：</span></span><br><span class="line"><span class="string">            1. 基本信息（年龄、职业、生活方式）</span></span><br><span class="line"><span class="string">            2. 具体症状和持续时间</span></span><br><span class="line"><span class="string">            3. 对健康的担忧和期望</span></span><br><span class="line"><span class="string">            4. 目前的生活习惯（饮食、运动、睡眠等）</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请保持真实、详细，就像真正的患者在描述自己的健康状况一样。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建AI患者的任务Agent</span></span><br><span class="line">        <span class="variable language_">self</span>.patient_agent = TaskSpecifyAgent(</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            task_type=TaskType.AI_SOCIETY,</span><br><span class="line">            task_specify_prompt=<span class="variable language_">self</span>.patient_prompt,</span><br><span class="line">            output_language=<span class="string">&#x27;ch&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 随机案例生成的模板库</span></span><br><span class="line">        <span class="variable language_">self</span>.case_templates = &#123;</span><br><span class="line">            <span class="string">&quot;age_ranges&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;18-25岁&quot;</span>, <span class="string">&quot;26-35岁&quot;</span>, <span class="string">&quot;36-45岁&quot;</span>, <span class="string">&quot;46-55岁&quot;</span>, <span class="string">&quot;56-65岁&quot;</span>, <span class="string">&quot;65岁以上&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;occupations&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;大学生&quot;</span>, <span class="string">&quot;程序员&quot;</span>, <span class="string">&quot;销售经理&quot;</span>, <span class="string">&quot;教师&quot;</span>, <span class="string">&quot;医生&quot;</span>, <span class="string">&quot;律师&quot;</span>,</span><br><span class="line">                <span class="string">&quot;会计师&quot;</span>, <span class="string">&quot;设计师&quot;</span>, <span class="string">&quot;工程师&quot;</span>, <span class="string">&quot;护士&quot;</span>, <span class="string">&quot;司机&quot;</span>, <span class="string">&quot;厨师&quot;</span>,</span><br><span class="line">                <span class="string">&quot;记者&quot;</span>, <span class="string">&quot;公务员&quot;</span>, <span class="string">&quot;退休人员&quot;</span>, <span class="string">&quot;家庭主妇&quot;</span>, <span class="string">&quot;创业者&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;symptoms&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;长期疲劳和精神不振&quot;</span>, <span class="string">&quot;颈椎疼痛和肩膀僵硬&quot;</span>, <span class="string">&quot;失眠和睡眠质量差&quot;</span>,</span><br><span class="line">                <span class="string">&quot;消化不良和胃部不适&quot;</span>, <span class="string">&quot;体重增加和代谢缓慢&quot;</span>, <span class="string">&quot;头痛和注意力不集中&quot;</span>,</span><br><span class="line">                <span class="string">&quot;腰背疼痛&quot;</span>, <span class="string">&quot;血压偏高&quot;</span>, <span class="string">&quot;血糖不稳定&quot;</span>, <span class="string">&quot;情绪波动大&quot;</span>,</span><br><span class="line">                <span class="string">&quot;皮肤问题&quot;</span>, <span class="string">&quot;记忆力下降&quot;</span>, <span class="string">&quot;关节疼痛&quot;</span>, <span class="string">&quot;呼吸困难&quot;</span>,</span><br><span class="line">                <span class="string">&quot;心悸和胸闷&quot;</span>, <span class="string">&quot;月经不调&quot;</span>, <span class="string">&quot;更年期症状&quot;</span>, <span class="string">&quot;视力疲劳&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;potential_causes&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;长期久坐办公&quot;</span>, <span class="string">&quot;工作压力过大&quot;</span>, <span class="string">&quot;饮食不规律&quot;</span>, <span class="string">&quot;缺乏运动&quot;</span>,</span><br><span class="line">                <span class="string">&quot;熬夜和作息紊乱&quot;</span>, <span class="string">&quot;过度使用电子产品&quot;</span>, <span class="string">&quot;营养不均衡&quot;</span>,</span><br><span class="line">                <span class="string">&quot;情绪压力&quot;</span>, <span class="string">&quot;环境污染&quot;</span>, <span class="string">&quot;遗传因素&quot;</span>, <span class="string">&quot;年龄增长&quot;</span>,</span><br><span class="line">                <span class="string">&quot;激素变化&quot;</span>, <span class="string">&quot;不良生活习惯&quot;</span>, <span class="string">&quot;社交压力&quot;</span>, <span class="string">&quot;经济压力&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_random_case</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;随机生成一个患者案例&quot;&quot;&quot;</span></span><br><span class="line">        case_info = &#123;</span><br><span class="line">            <span class="string">&quot;age_range&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;age_ranges&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;occupation&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;occupations&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;symptoms&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;symptoms&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;potential_causes&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;potential_causes&quot;</span>])</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n 随机生成患者案例：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;年龄：<span class="subst">&#123;case_info[<span class="string">&#x27;age_range&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;职业：<span class="subst">&#123;case_info[<span class="string">&#x27;occupation&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;症状：<span class="subst">&#123;case_info[<span class="string">&#x27;symptoms&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;潜在原因：<span class="subst">&#123;case_info[<span class="string">&#x27;potential_causes&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> case_info</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_patient_profile</span>(<span class="params">self, case_info=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建患者档案&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> case_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            case_info = <span class="variable language_">self</span>.generate_random_case()</span><br><span class="line">        </span><br><span class="line">        task_prompt = <span class="string">&quot;生成一个真实的患者案例描述&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.patient_agent.run(</span><br><span class="line">            task_prompt=task_prompt,</span><br><span class="line">            meta_dict=case_info</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n AI患者的自述：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response, case_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># AI专业健康顾问Agent - 思维链分析</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIHealthAdvisorAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义AI健康顾问的提示模板</span></span><br><span class="line">        <span class="variable language_">self</span>.advisor_prompt = TextPrompt(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;你是一位经验丰富的AI专业健康顾问。面对患者的描述，请使用思维链方式进行专业分析。</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            患者描述：&#123;patient_description&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请按照以下思维链步骤进行分析：</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            思维链步骤1：病情分析</span></span><br><span class="line"><span class="string">            - 仔细分析患者的症状和描述</span></span><br><span class="line"><span class="string">            - 识别主要健康问题和次要问题</span></span><br><span class="line"><span class="string">            - 评估症状的严重程度和紧急性</span></span><br><span class="line"><span class="string">            - 推测可能的病因和风险因素</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            思维链步骤2：诊断推理</span></span><br><span class="line"><span class="string">            - 基于症状进行初步诊断推理</span></span><br><span class="line"><span class="string">            - 考虑可能的疾病或健康状况</span></span><br><span class="line"><span class="string">            - 分析生活方式对健康的影响</span></span><br><span class="line"><span class="string">            - 确定需要重点关注的健康指标</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            思维链步骤3：营养干预策略</span></span><br><span class="line"><span class="string">            - 分析当前饮食习惯的问题</span></span><br><span class="line"><span class="string">            - 制定个性化的营养改善方案</span></span><br><span class="line"><span class="string">            - 推荐具体的食物和营养补充</span></span><br><span class="line"><span class="string">            - 提供饮食时间和分量建议</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            思维链步骤4：运动康复方案</span></span><br><span class="line"><span class="string">            - 评估患者的运动能力和限制</span></span><br><span class="line"><span class="string">            - 设计适合的运动类型和强度</span></span><br><span class="line"><span class="string">            - 制定循序渐进的锻炼计划</span></span><br><span class="line"><span class="string">            - 强调运动安全和注意事项</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            思维链步骤5：生活方式调整</span></span><br><span class="line"><span class="string">            - 分析作息和生活习惯问题</span></span><br><span class="line"><span class="string">            - 提供睡眠质量改善建议</span></span><br><span class="line"><span class="string">            - 制定压力管理策略</span></span><br><span class="line"><span class="string">            - 建议环境和工作习惯的调整</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            思维链步骤6：监测和随访计划</span></span><br><span class="line"><span class="string">            - 设定健康监测指标</span></span><br><span class="line"><span class="string">            - 制定定期检查计划</span></span><br><span class="line"><span class="string">            - 建立健康改善的里程碑</span></span><br><span class="line"><span class="string">            - 提供长期健康维护建议</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请以专业、细致、关怀的态度提供建议，确保每个步骤都有清晰的逻辑和实用的建议。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建AI健康顾问的任务Agent</span></span><br><span class="line">        <span class="variable language_">self</span>.advisor_agent = TaskSpecifyAgent(</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            task_type=TaskType.AI_SOCIETY,</span><br><span class="line">            task_specify_prompt=<span class="variable language_">self</span>.advisor_prompt,</span><br><span class="line">            output_language=<span class="string">&#x27;ch&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_patient_case</span>(<span class="params">self, patient_description</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;使用思维链方式分析患者案例&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n AI专业健康顾问开始思维链分析：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        task_prompt = <span class="string">&quot;请对患者案例进行专业的思维链分析&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.advisor_agent.run(</span><br><span class="line">            task_prompt=task_prompt,</span><br><span class="line">            meta_dict=&#123;<span class="string">&quot;patient_description&quot;</span>: patient_description&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">provide_quick_assessment</span>(<span class="params">self, patient_description</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提供快速评估&quot;&quot;&quot;</span></span><br><span class="line">        quick_prompt = TextPrompt(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;作为专业健康顾问，请对患者情况进行快速评估：</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            患者描述：&#123;patient_description&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请简要提供：</span></span><br><span class="line"><span class="string">            1. 主要健康问题识别</span></span><br><span class="line"><span class="string">            2. 风险等级评估（低/中/高）</span></span><br><span class="line"><span class="string">            3. 紧急程度判断</span></span><br><span class="line"><span class="string">            4. 建议的下一步行动</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        quick_agent = TaskSpecifyAgent(</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            task_type=TaskType.AI_SOCIETY,</span><br><span class="line">            task_specify_prompt=quick_prompt,</span><br><span class="line">            output_language=<span class="string">&#x27;ch&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        response = quick_agent.run(</span><br><span class="line">            task_prompt=<span class="string">&quot;快速评估患者健康状况&quot;</span>,</span><br><span class="line">            meta_dict=&#123;<span class="string">&quot;patient_description&quot;</span>: patient_description&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n 快速评估结果：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 健康咨询会话系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HealthConsultationSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.ai_patient = AIPatientAgent(model)</span><br><span class="line">        <span class="variable language_">self</span>.ai_advisor = AIHealthAdvisorAgent(model)</span><br><span class="line">        <span class="variable language_">self</span>.consultation_history = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_consultation</span>(<span class="params">self, use_random_case=<span class="literal">True</span>, custom_case=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;开始健康咨询会话&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n AI健康咨询系统启动&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成或使用患者案例</span></span><br><span class="line">        <span class="keyword">if</span> use_random_case:</span><br><span class="line">            patient_description, case_info = <span class="variable language_">self</span>.ai_patient.create_patient_profile()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            patient_description, case_info = <span class="variable language_">self</span>.ai_patient.create_patient_profile(custom_case)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 健康顾问快速评估</span></span><br><span class="line">        quick_assessment = <span class="variable language_">self</span>.ai_advisor.provide_quick_assessment(patient_description)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 健康顾问详细分析</span></span><br><span class="line">        detailed_analysis = <span class="variable language_">self</span>.ai_advisor.analyze_patient_case(patient_description)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存咨询记录</span></span><br><span class="line">        consultation_record = &#123;</span><br><span class="line">            <span class="string">&quot;case_info&quot;</span>: case_info,</span><br><span class="line">            <span class="string">&quot;patient_description&quot;</span>: patient_description,</span><br><span class="line">            <span class="string">&quot;quick_assessment&quot;</span>: quick_assessment,</span><br><span class="line">            <span class="string">&quot;detailed_analysis&quot;</span>: detailed_analysis</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.consultation_history.append(consultation_record)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n 健康咨询完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> consultation_record</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_consultation</span>(<span class="params">self, num_cases=<span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;批量进行健康咨询&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n 开始批量健康咨询 (<span class="subst">&#123;num_cases&#125;</span> 个案例)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_cases):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n【案例 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_cases&#125;</span>】&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.start_consultation(use_random_case=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 案例间分隔</span></span><br><span class="line">            <span class="keyword">if</span> i &lt; num_cases - <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_consultation_summary</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取咨询历史摘要&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.consultation_history:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;暂无咨询记录&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n 咨询历史摘要 (共<span class="subst">&#123;<span class="built_in">len</span>(self.consultation_history)&#125;</span>个案例)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, record <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="variable language_">self</span>.consultation_history):</span><br><span class="line">            case_info = record[<span class="string">&quot;case_info&quot;</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n案例 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  年龄：<span class="subst">&#123;case_info[<span class="string">&#x27;age_range&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  职业：<span class="subst">&#123;case_info[<span class="string">&#x27;occupation&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  症状：<span class="subst">&#123;case_info[<span class="string">&#x27;symptoms&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  原因：<span class="subst">&#123;case_info[<span class="string">&#x27;potential_causes&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主程序运行</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 创建健康咨询系统</span></span><br><span class="line">    consultation_system = HealthConsultationSystem(model)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; AI健康咨询系统&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;包含AI患者（随机生成案例）和AI专业健康顾问（思维链分析）&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># AI患者随机咨询</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">80</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; AI患者随机咨询&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">80</span>)</span><br><span class="line">    consultation_system.start_consultation(use_random_case=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>代码运行输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/CAMEL_Prompt_task1.1.py</span><br><span class="line"> AI健康咨询系统</span><br><span class="line">包含AI患者（随机生成案例）和AI专业健康顾问（思维链分析）</span><br><span class="line"></span><br><span class="line">================================================================================   </span><br><span class="line"> AI患者随机咨询</span><br><span class="line">================================================================================   </span><br><span class="line"></span><br><span class="line"> AI健康咨询系统启动</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line"> 随机生成患者案例：</span><br><span class="line">年龄：46-55岁</span><br><span class="line">职业：家庭主妇</span><br><span class="line">症状：血糖不稳定</span><br><span class="line">潜在原因：情绪压力</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> AI患者的自述：</span><br><span class="line">我今年49岁，是一名家庭主妇，我的生活大部分时间都是围绕着家庭转的。自从孩子们都长大 成人，家里的事情似乎也变得少了，但我还是每天忙忙碌碌，从早到晚地打理家务。最近这几 个月，我发现自己经常感到疲惫不堪，有时候还会头晕眼花，特别是饭后，这种感觉尤为明显 。</span><br><span class="line"></span><br><span class="line">大约是从半年前开始，我发现自己的血糖水平变得非常不稳定。有时候吃完饭后测血糖，数值 会非常高，但到了下一次测量时又恢复正常了。这种情况让我非常担心，因为我家族里有糖尿 病史，我害怕自己也会患上这种病。</span><br><span class="line"></span><br><span class="line">我对自己的健康状况感到非常焦虑，尤其是考虑到我最近承受了不少情绪上的压力。孩子们各 自成家立业后，家里显得空荡荡的，我总是担心他们在外过得好不好，有没有受苦。这些忧虑 常常让我夜不能寐，白天也没有精神做事情。</span><br><span class="line"></span><br><span class="line">目前，我的生活习惯并不是特别规律。虽然我一直努力保持健康的饮食，尽量少吃甜食和油腻 的食物，但有时候心情不好时，我还是会忍不住吃一些高糖分的东西来安慰自己。运动方面， 我偶尔会在晚饭后出去散步，但这并不固定，有时因为家务或者天气原因就取消了。至于睡眠 ，最近几个月确实不太好，经常是辗转反侧难以入睡，即使睡着了也容易醒来，第二天总是感 觉很累。</span><br><span class="line"></span><br><span class="line">我希望通过这次咨询能够找到改善血糖水平的方法，同时也希望能够缓解一下心理上的压力。 我期待医生能给我一些建议，帮助我调整生活方式，让我的身体和心灵都能得到更好的照顾。 </span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> 快速评估结果：</span><br><span class="line">根据您的描述，以下是对您情况的初步评估：</span><br><span class="line"></span><br><span class="line">1. **主要健康问题识别**：</span><br><span class="line">   - 经常感到疲劳、头晕眼花，特别是在饭后。</span><br><span class="line">   - 血糖水平不稳定，有时餐后血糖升高。</span><br><span class="line">   - 家庭和情感压力导致的情绪焦虑和失眠。</span><br><span class="line">   - 生活习惯不规律，包括饮食、运动和睡眠。</span><br><span class="line"></span><br><span class="line">2. **风险等级评估**：</span><br><span class="line">   - **中**：您的症状和家族糖尿病史表明您可能有较高的风险发展为糖尿病。同时，情绪压力和不良的生活习惯也可能进一步影响您的健康。</span><br><span class="line"></span><br><span class="line">3. **紧急程度判断**：</span><br><span class="line">   - **中**：虽然您的症状目前没有达到需要立即就医的紧急程度，但建议尽快采取措施以防止病情恶化。</span><br><span class="line"></span><br><span class="line">4. **建议的下一步行动**：</span><br><span class="line">   - **就医检查**：建议您尽快预约内分泌科医生进行全面检查，包括血糖、血脂等指标，以便及早发现并处理潜在的健康问题。</span><br><span class="line">   - **调整饮食**：继续保持健康的饮食习惯，减少高糖和高脂肪食物的摄入。可以考虑咨询营养师，制定适合您的饮食计划。</span><br><span class="line">   - **增加运动**：尝试将规律的运动纳入日常生活中，如每天散步30分钟。运动不仅有助于控制血糖，还能减轻情绪压力。</span><br><span class="line">   - **管理压力**：学习一些放松技巧，如深呼吸、冥想或瑜伽，帮助缓解情绪压力。如果必要，可以寻求心理咨询师的帮助。</span><br><span class="line">   - **改善睡眠**：建立固定的作息时间，避免晚上过度使用电子设备。睡前可以进行一些轻松的活动，如阅读或听轻音乐，帮助入睡。</span><br><span class="line"></span><br><span class="line">希望这些建议对您有所帮助，祝您早日恢复健康！</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> AI专业健康顾问开始思维链分析：</span><br><span class="line">============================================================</span><br><span class="line">### 思维链步骤1：病情分析</span><br><span class="line"></span><br><span class="line">**患者症状和描述：**</span><br><span class="line">- 年龄：49岁</span><br><span class="line">- 职业：家庭主妇</span><br><span class="line">- 主要症状：疲劳、头晕眼花（尤其饭后）</span><br><span class="line">- 血糖水平不稳定：餐后血糖升高，随后恢复正常</span><br><span class="line">- 家族史：糖尿病</span><br><span class="line">- 心理状态：焦虑、失眠、担忧子女</span><br><span class="line"></span><br><span class="line">**主要健康问题：**</span><br><span class="line">- 血糖水平不稳定</span><br><span class="line">- 慢性疲劳和头晕</span><br><span class="line">- 焦虑和失眠</span><br><span class="line"></span><br><span class="line">**次要问题：**</span><br><span class="line">- 不规律的生活习惯</span><br><span class="line">- 饮食不均衡</span><br><span class="line">- 缺乏固定的运动计划</span><br><span class="line"></span><br><span class="line">**症状严重程度和紧急性：**</span><br><span class="line">- 血糖水平不稳定需要立即关注，以防发展为糖尿病</span><br><span class="line">- 慢性疲劳和头晕影响日常生活，需进一步检查</span><br><span class="line">- 焦虑和失眠可能导致心理健康问题，需要及时干预</span><br><span class="line"></span><br><span class="line">**可能的病因和风险因素：**</span><br><span class="line">- 饮食中高糖分食物的摄入</span><br><span class="line">- 缺乏规律的运动</span><br><span class="line">- 睡眠质量差</span><br><span class="line">- 心理压力大</span><br><span class="line">- 家族遗传因素</span><br><span class="line"></span><br><span class="line">### 思维链步骤2：诊断推理</span><br><span class="line"></span><br><span class="line">**初步诊断推理：**</span><br><span class="line">- 可能的疾病或健康状况：早期糖尿病、低血糖、贫血、慢性疲劳综合征</span><br><span class="line">- 生活方式对健康的影响：不规律的饮食和运动习惯、缺乏足够的休息和放松时间</span><br><span class="line"></span><br><span class="line">**需要重点关注的健康指标：**</span><br><span class="line">- 空腹血糖和餐后2小时血糖</span><br><span class="line">- 血红蛋白水平</span><br><span class="line">- 甲状腺功能</span><br><span class="line">- 维生素D和B12水平</span><br><span class="line"></span><br><span class="line">### 思维链步骤3：营养干预策略</span><br><span class="line"></span><br><span class="line">**当前饮食习惯的问题：**</span><br><span class="line">- 偶尔摄入高糖分食物</span><br><span class="line">- 饮食不规律，可能缺乏足够的纤维素和维生素</span><br><span class="line"></span><br><span class="line">**个性化营养改善方案：**</span><br><span class="line">1. **减少高糖食物的摄入：** 尽量避免含糖饮料、甜点等高糖食品，选择低GI（血糖生成指 数）的食物，如全谷物、豆类、蔬菜和水果。</span><br><span class="line">2. **增加膳食纤维：** 多吃富含纤维的食物，如燕麦、糙米、绿叶蔬菜和坚果，有助于稳定 血糖。</span><br><span class="line">3. **均衡饮食：** 确保每餐都有蛋白质、健康脂肪和复合碳水化合物，例如鸡胸肉、鱼、橄 榄油、全麦面包等。</span><br><span class="line">4. **定时定量：** 每天三餐定时定量，避免长时间不吃或暴饮暴食。</span><br><span class="line"></span><br><span class="line">**推荐的具体食物和营养补充：**</span><br><span class="line">- 早餐：燕麦粥 + 鸡蛋 + 新鲜水果</span><br><span class="line">- 午餐：全麦面包 + 烤鸡胸肉 + 绿叶蔬菜沙拉</span><br><span class="line">- 晚餐：糙米饭 + 清蒸鱼 + 蒸蔬菜</span><br><span class="line">- 零食：坚果、酸奶、新鲜水果</span><br><span class="line"></span><br><span class="line">**饮食时间和分量建议：**</span><br><span class="line">- 早餐：7:00-8:00</span><br><span class="line">- 午餐：12:00-13:00</span><br><span class="line">- 晚餐：18:00-19:00</span><br><span class="line">- 每餐不要过量，避免饭后立即躺下</span><br><span class="line"></span><br><span class="line">### 思维链步骤4：运动康复方案</span><br><span class="line"></span><br><span class="line">**评估患者的运动能力和限制：**</span><br><span class="line">- 目前偶尔散步，但不固定</span><br><span class="line">- 需要考虑家务劳动的时间安排</span><br><span class="line"></span><br><span class="line">**设计适合的运动类型和强度：**</span><br><span class="line">1. **有氧运动：** 每周至少150分钟的中等强度有氧运动，如快走、慢跑、游泳。</span><br><span class="line">2. **力量训练：** 每周2次，每次20-30分钟，可以使用哑铃或弹力带进行简单的力量训练。 </span><br><span class="line">3. **柔韧性训练：** 每天10-15分钟的伸展运动，如瑜伽或普拉提。</span><br><span class="line"></span><br><span class="line">**制定循序渐进的锻炼计划：**</span><br><span class="line">- 第1-2周：每天快走20分钟，每周3次</span><br><span class="line">- 第3-4周：增加到每天快走30分钟，每周4次</span><br><span class="line">- 第5周及以后：加入2次力量训练和10-15分钟的伸展运动</span><br><span class="line"></span><br><span class="line">**强调运动安全和注意事项：**</span><br><span class="line">- 运动前后做好热身和拉伸</span><br><span class="line">- 逐渐增加运动强度，避免过度劳累</span><br><span class="line">- 注意补水，特别是在炎热的天气</span><br><span class="line">- 如有任何不适，立即停止运动并咨询医生</span><br><span class="line"></span><br><span class="line">### 思维链步骤5：生活方式调整</span><br><span class="line"></span><br><span class="line">**分析作息和生活习惯问题：**</span><br><span class="line">- 睡眠质量差，经常失眠</span><br><span class="line">- 心理压力大，担忧子女</span><br><span class="line">- 生活节奏不规律</span><br><span class="line"></span><br><span class="line">**提供睡眠质量改善建议：**</span><br><span class="line">1. **建立固定的睡眠时间：** 每天晚上同一时间上床睡觉，早上同一时间起床。</span><br><span class="line">2. **创造良好的睡眠环境：** 保持卧室安静、舒适、黑暗，温度适宜。</span><br><span class="line">3. **避免刺激性物质：** 晚上避免咖啡因和酒精，晚餐不要吃得过饱。</span><br><span class="line">4. **放松身心：** 睡前进行深呼吸、冥想或热水浴，帮助放松。</span><br><span class="line"></span><br><span class="line">**制定压力管理策略：**</span><br><span class="line">1. **时间管理：** 合理安排家务和休闲时间，避免过度劳累。</span><br><span class="line">2. **心理支持：** 与家人朋友多沟通，分享自己的感受，必要时寻求心理咨询。</span><br><span class="line">3. **兴趣爱好：** 找到自己喜欢的事情，如阅读、园艺、绘画等，帮助转移注意力。       </span><br><span class="line">4. **正念冥想：** 学习正念冥想技巧，帮助减轻焦虑和压力。</span><br><span class="line"></span><br><span class="line">**建议环境和工作习惯的调整：**</span><br><span class="line">- 保持家中整洁，减少杂乱带来的压力</span><br><span class="line">- 定期进行户外活动，接触自然，有助于放松心情</span><br><span class="line">- 学会放手，信任子女，减少不必要的担忧</span><br><span class="line"></span><br><span class="line">### 思维链步骤6：监测和随访计划</span><br><span class="line"></span><br><span class="line">**设定健康监测指标：**</span><br><span class="line">- 空腹血糖和餐后2小时血糖</span><br><span class="line">- 体重和体脂率</span><br><span class="line">- 血压</span><br><span class="line">- 睡眠质量</span><br><span class="line"></span><br><span class="line">**制定定期检查计划：**</span><br><span class="line">- 每月监测一次血糖水平</span><br><span class="line">- 每三个月进行全面体检，包括血常规、肝肾功能、甲状腺功能等</span><br><span class="line">- 每半年进行一次心理评估，了解心理健康状况</span><br><span class="line"></span><br><span class="line">**建立健康改善的里程碑：**</span><br><span class="line">- 1个月后：血糖水平趋于稳定，疲劳感减轻</span><br><span class="line">- 3个月后：体重和体脂率有所下降，睡眠质量改善</span><br><span class="line">- 6个月后：整体健康状况明显好转，心理压力减轻</span><br><span class="line"></span><br><span class="line">**提供长期健康维护建议：**</span><br><span class="line">- 持续关注饮食和运动，保持良好的生活习惯</span><br><span class="line">- 定期复诊，及时调整治疗方案</span><br><span class="line">- 保持积极的心态，享受生活中的每一刻</span><br><span class="line"></span><br><span class="line">希望这些建议能帮助您改善血糖水平，缓解心理压力，提高生活质量。如果有任何疑问或需要 进一步的帮助，请随时联系您的医生。祝您健康！</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line"> 健康咨询完成！</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>

<p>第二个输出样例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/CAMEL_Prompt_task1.1.py</span><br><span class="line"> AI健康咨询系统</span><br><span class="line">包含AI患者（随机生成案例）和AI专业健康顾问（思维链分析）</span><br><span class="line"></span><br><span class="line">================================================================================   </span><br><span class="line"> AI患者随机咨询</span><br><span class="line">================================================================================   </span><br><span class="line"></span><br><span class="line"> AI健康咨询系统启动</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line"> 随机生成患者案例：</span><br><span class="line">年龄：65岁以上</span><br><span class="line">职业：程序员</span><br><span class="line">症状：长期疲劳和精神不振</span><br><span class="line">潜在原因：情绪压力</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> AI患者的自述：</span><br><span class="line">我叫张明，今年70岁了，退休前是一名程序员。虽然我已经退休了，但还是喜欢在家里做一些 编程的小项目，偶尔也会帮一些年轻的朋友解决技术问题。我的生活比较规律，每天早上都会 去公园散步，晚上则会看看书或电视。</span><br><span class="line"></span><br><span class="line">近几个月来，我感到非常疲劳，即使没有做太多的事情，也总是觉得累，精神也不如以前那样 饱满。这种状态已经持续了大约半年的时间了。我开始担心这不仅仅是年龄增长带来的自然变 化，而是可能有其他的健康问题。</span><br><span class="line"></span><br><span class="line">我最担心的是这种长期的疲劳感会影响到我的日常生活，比如减少与家人的互动时间，或者影 响到我享受退休生活的质量。我希望通过适当的治疗或调整生活习惯，能够恢复到以前那种精 力充沛的状态，至少能让我有足够的体力和精神去完成我想做的事情。</span><br><span class="line"></span><br><span class="line">目前，我的饮食还算健康，每天都会吃新鲜的蔬菜和水果，很少吃油腻的食物。我每周会去公 园散步三次，每次大约一个小时。但是，最近我发现自己的睡眠质量下降了，经常半夜醒来后 就很难再入睡，这可能是导致我感觉更加疲劳的一个重要原因。</span><br><span class="line"></span><br><span class="line">我知道情绪压力也可能是一个因素，因为虽然退休了，但我还是会为一些家庭琐事感到焦虑。 我希望医生能给我一些建议，帮助我改善当前的症状，提高生活质量。</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> 快速评估结果：</span><br><span class="line">根据您的描述，以下是对您情况的快速评估：</span><br><span class="line"></span><br><span class="line">1. **主要健康问题识别**：</span><br><span class="line">   - **长期疲劳**：持续约半年，即使在进行日常活动时也感到疲惫。</span><br><span class="line">   - **睡眠质量下降**：经常半夜醒来，难以再次入睡。</span><br><span class="line">   - **情绪压力**：因家庭琐事感到焦虑。</span><br><span class="line"></span><br><span class="line">2. **风险等级评估**：</span><br><span class="line">   - **中等风险**：长期疲劳和睡眠质量下降可能会对您的生活质量产生显著影响，并可能导致其他健康问题。</span><br><span class="line"></span><br><span class="line">3. **紧急程度判断**：</span><br><span class="line">   - **中等紧急**：虽然目前的情况不是立即危及生命的，但需要及时关注和处理，以防止症状进一步恶化。</span><br><span class="line"></span><br><span class="line">4. **建议的下一步行动**：</span><br><span class="line">   - **就医检查**：建议您尽快预约家庭医生进行全面的身体检查，包括血液检查、甲状腺功能检查等，以排除潜在的医学问题。</span><br><span class="line">   - **改善睡眠**：尝试建立固定的睡眠时间表，避免晚上摄入咖啡因和大量饮水，可以尝试使用放松技巧，如深呼吸、冥想或轻柔音乐，帮助改善睡眠质量。</span><br><span class="line">   - **管理情绪**：可以考虑进行心理咨询或参加支持小组，学习应对焦虑的方法。同时，与家人多沟通，分享您的感受，寻求他们的理解和支持。</span><br><span class="line">   - **适度运动**：继续保持规律的散步习惯，但也可以尝试其他形式的轻度运动，如瑜伽或太极，有助于提高体能和心情。</span><br><span class="line">   - **营养均衡**：继续保持健康的饮食习惯，确保摄入足够的维生素和矿物质，特别是铁、维生素D和B族维生素，这些对改善疲劳有积极作用。</span><br><span class="line"></span><br><span class="line">希望这些建议对您有所帮助，祝您早日恢复健康！</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> AI专业健康顾问开始思维链分析：</span><br><span class="line">============================================================</span><br><span class="line">### 思维链步骤1：病情分析</span><br><span class="line"></span><br><span class="line">**患者基本信息**：</span><br><span class="line">- 姓名：张明</span><br><span class="line">- 年龄：70岁</span><br><span class="line">- 职业：退休程序员</span><br><span class="line">- 生活方式：规律，每天早晨散步，晚上看书或看电视</span><br><span class="line">- 饮食习惯：健康，每天吃新鲜蔬菜和水果，很少吃油腻食物</span><br><span class="line">- 运动频率：每周三次，每次一小时</span><br><span class="line"></span><br><span class="line">**主要症状**：</span><br><span class="line">- 长期疲劳感（已持续约半年）</span><br><span class="line">- 精神不饱满</span><br><span class="line">- 睡眠质量下降，经常半夜醒来难以再入睡</span><br><span class="line"></span><br><span class="line">**次要症状**：</span><br><span class="line">- 情绪压力，为家庭琐事感到焦虑</span><br><span class="line"></span><br><span class="line">**症状严重程度和紧急性**：</span><br><span class="line">- 疲劳感持续时间较长，严重影响日常生活和精神状态，需引起重视</span><br><span class="line">- 睡眠质量下降可能进一步加剧疲劳感，需尽快改善</span><br><span class="line">- 情绪压力虽为次要问题，但也会影响整体健康状况</span><br><span class="line"></span><br><span class="line">**可能的病因和风险因素**：</span><br><span class="line">- **慢性疲劳综合征**：长期疲劳感，无明显器质性病变</span><br><span class="line">- **贫血**：老年人常见，可能导致疲劳</span><br><span class="line">- **甲状腺功能减退**：代谢减慢，导致疲劳</span><br><span class="line">- **睡眠障碍**：如失眠、睡眠呼吸暂停等</span><br><span class="line">- **心理因素**：如抑郁、焦虑等</span><br><span class="line"></span><br><span class="line">### 思维链步骤2：诊断推理</span><br><span class="line"></span><br><span class="line">**初步诊断推理**：</span><br><span class="line">- **慢性疲劳综合征**：长期疲劳感，无明显器质性病变</span><br><span class="line">- **贫血**：需检查血常规，排除贫血可能性</span><br><span class="line">- **甲状腺功能减退**：需检查甲状腺功能</span><br><span class="line">- **睡眠障碍**：需详细询问睡眠情况，考虑是否需要睡眠监测</span><br><span class="line">- **心理因素**：需评估情绪状态，排除抑郁症或焦虑症</span><br><span class="line"></span><br><span class="line">**可能的疾病或健康状况**：</span><br><span class="line">- 慢性疲劳综合征</span><br><span class="line">- 贫血</span><br><span class="line">- 甲状腺功能减退</span><br><span class="line">- 睡眠障碍</span><br><span class="line">- 抑郁症或焦虑症</span><br><span class="line"></span><br><span class="line">**生活方式对健康的影响**：</span><br><span class="line">- 规律的生活方式有助于维持身体机能</span><br><span class="line">- 健康的饮食习惯对身体健康有益</span><br><span class="line">- 适量的运动有助于提高体能和精神状态</span><br><span class="line">- 情绪压力可能影响睡眠质量和整体健康</span><br><span class="line"></span><br><span class="line">**需要重点关注的健康指标**：</span><br><span class="line">- 血常规（红细胞、血红蛋白等）</span><br><span class="line">- 甲状腺功能（TSH、T3、T4）</span><br><span class="line">- 睡眠质量（入睡时间、睡眠时长、夜间醒来次数）</span><br><span class="line">- 心理状态（抑郁、焦虑评分）</span><br><span class="line"></span><br><span class="line">### 思维链步骤3：营养干预策略</span><br><span class="line"></span><br><span class="line">**当前饮食习惯的问题**：</span><br><span class="line">- 虽然饮食健康，但可能缺乏某些特定的营养素，如铁、维生素D等</span><br><span class="line"></span><br><span class="line">**个性化营养改善方案**：</span><br><span class="line">- **增加富含铁的食物**：红肉、猪肝、菠菜、豆类等，预防贫血</span><br><span class="line">- **补充维生素D**：晒太阳、食用富含维生素D的食物（如鱼肝油、蛋黄）或考虑补充剂     </span><br><span class="line">- **保证足够的蛋白质摄入**：鸡肉、鱼肉、豆腐等，有助于维持肌肉和能量水平</span><br><span class="line"></span><br><span class="line">**推荐具体的食物和营养补充**：</span><br><span class="line">- **早餐**：全麦面包、鸡蛋、牛奶、新鲜水果</span><br><span class="line">- **午餐**：瘦肉、绿叶蔬菜、糙米</span><br><span class="line">- **晚餐**：鱼肉、豆腐、蔬菜汤</span><br><span class="line">- **零食**：坚果、酸奶</span><br><span class="line"></span><br><span class="line">**饮食时间和分量建议**：</span><br><span class="line">- **早餐**：7:00-8:00，不要空腹</span><br><span class="line">- **午餐**：12:00-13:00，避免过饱</span><br><span class="line">- **晚餐**：18:00-19:00，尽量清淡</span><br><span class="line">- **加餐**：下午3:00左右，少量坚果或水果</span><br><span class="line"></span><br><span class="line">### 思维链步骤4：运动康复方案</span><br><span class="line"></span><br><span class="line">**评估患者的运动能力和限制**：</span><br><span class="line">- 每周三次公园散步，每次一小时，基础体能良好</span><br><span class="line">- 需要增加多样性和强度，以提高体能和精神状态</span><br><span class="line"></span><br><span class="line">**设计适合的运动类型和强度**：</span><br><span class="line">- **有氧运动**：快走、慢跑、游泳，每次30-45分钟，每周3-4次</span><br><span class="line">- **力量训练**：哑铃、弹力带，每次20-30分钟，每周2-3次</span><br><span class="line">- **柔韧性训练**：瑜伽、拉伸，每次15-20分钟，每周2-3次</span><br><span class="line"></span><br><span class="line">**制定循序渐进的锻炼计划**：</span><br><span class="line">- 第1-2周：继续公园散步，增加快走时间</span><br><span class="line">- 第3-4周：加入轻量级力量训练，每周2次</span><br><span class="line">- 第5-6周：尝试游泳或慢跑，每周1-2次</span><br><span class="line">- 第7周以后：根据身体适应情况，逐步增加运动强度和频率</span><br><span class="line"></span><br><span class="line">**强调运动安全和注意事项**：</span><br><span class="line">- 运动前做好热身，避免受伤</span><br><span class="line">- 选择合适的运动鞋和服装</span><br><span class="line">- 运动后适当拉伸，缓解肌肉紧张</span><br><span class="line">- 如有任何不适，立即停止运动并咨询医生</span><br><span class="line"></span><br><span class="line">### 思维链步骤5：生活方式调整</span><br><span class="line"></span><br><span class="line">**分析作息和生活习惯问题**：</span><br><span class="line">- 睡眠质量下降，可能与作息不规律、心理压力有关</span><br><span class="line">- 情绪压力可能影响睡眠和整体健康</span><br><span class="line"></span><br><span class="line">**提供睡眠质量改善建议**：</span><br><span class="line">- **建立规律的作息时间**：每天固定时间上床睡觉和起床</span><br><span class="line">- **创造良好的睡眠环境**：保持卧室安静、舒适、黑暗</span><br><span class="line">- **避免睡前刺激**：避免咖啡因、酒精和电子设备</span><br><span class="line">- **放松身心**：睡前进行深呼吸、冥想或热水浴</span><br><span class="line"></span><br><span class="line">**制定压力管理策略**：</span><br><span class="line">- **定期进行放松活动**：如听音乐、阅读、园艺等</span><br><span class="line">- **学习应对技巧**：如正念冥想、认知行为疗法</span><br><span class="line">- **寻求支持**：与家人、朋友或专业人士交流，分享压力</span><br><span class="line"></span><br><span class="line">**建议环境和工作习惯的调整**：</span><br><span class="line">- **优化居住环境**：保持室内整洁、通风，减少噪音</span><br><span class="line">- **合理安排家务**：分担家庭事务，避免过度劳累</span><br><span class="line">- **培养兴趣爱好**：如绘画、书法、摄影等，丰富退休生活</span><br><span class="line"></span><br><span class="line">### 思维链步骤6：监测和随访计划</span><br><span class="line"></span><br><span class="line">**设定健康监测指标**：</span><br><span class="line">- **疲劳感**：记录每天的疲劳程度</span><br><span class="line">- **睡眠质量**：记录入睡时间、睡眠时长、夜间醒来次数</span><br><span class="line">- **情绪状态**：定期自我评估抑郁、焦虑评分</span><br><span class="line">- **体重和血压**：每周测量一次</span><br><span class="line"></span><br><span class="line">**制定定期检查计划**：</span><br><span class="line">- **初次检查**：血常规、甲状腺功能、心电图、血压</span><br><span class="line">- **随访检查**：每三个月复查一次，根据情况调整检查项目</span><br><span class="line"></span><br><span class="line">**建立健康改善的里程碑**：</span><br><span class="line">- **第1个月**：改善睡眠质量，减少夜间醒来次数</span><br><span class="line">- **第3个月**：增加运动量，提高体能和精神状态</span><br><span class="line">- **第6个月**：减轻疲劳感，提高生活质量</span><br><span class="line"></span><br><span class="line">**提供长期健康维护建议**：</span><br><span class="line">- **持续关注身体状况**：如有任何异常，及时就医</span><br><span class="line">- **保持积极心态**：乐观面对生活，享受退休时光</span><br><span class="line">- **定期体检**：每年进行全面体检，及时发现潜在问题</span><br><span class="line"></span><br><span class="line">希望以上建议能帮助您改善当前的症状，提高生活质量。如果您有任何疑问或需要进一步的帮 助，请随时联系您的医生。祝您早日恢复健康！</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line"> 健康咨询完成！</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="01-2-代码生成任务：利用-CodePromptTemplateDict，创建一个任务Agent，帮助用户学习一门新的编程语言（例如-Python）。要求-AI-逐步生成学习计划，包括基本概念、代码示例和练习题目。"><a href="#01-2-代码生成任务：利用-CodePromptTemplateDict，创建一个任务Agent，帮助用户学习一门新的编程语言（例如-Python）。要求-AI-逐步生成学习计划，包括基本概念、代码示例和练习题目。" class="headerlink" title="01.2. 代码生成任务：利用 CodePromptTemplateDict，创建一个任务Agent，帮助用户学习一门新的编程语言（例如 Python）。要求 AI 逐步生成学习计划，包括基本概念、代码示例和练习题目。"></a>01.2. 代码生成任务：利用 CodePromptTemplateDict，创建一个任务Agent，帮助用户学习一门新的编程语言（例如 Python）。要求 AI 逐步生成学习计划，包括基本概念、代码示例和练习题目。</h3><hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> TaskSpecifyAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.prompts <span class="keyword">import</span> TextPrompt, CodePromptTemplateDict</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, TaskType</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成模型实例</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AI编程导师Agent</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIProgrammingTutorAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义AI编程导师的提示模板（CodePromptTemplateDict）</span></span><br><span class="line">        <span class="variable language_">self</span>.tutor_prompt_templates = CodePromptTemplateDict(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;learning_plan&quot;</span>: TextPrompt(</span><br><span class="line">                    <span class="string">&quot;&quot;&quot;你是一位专业的编程导师，旨在帮助用户学习新的编程语言。</span></span><br><span class="line"><span class="string">                    请为学习 **&#123;language&#125;** 制定一个详细的学习计划。</span></span><br><span class="line"><span class="string">                    学习计划应该包括以下阶段，每个阶段都提供详细的说明、核心概念和建议的学习资源：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    1. **基础语法和数据类型**:</span></span><br><span class="line"><span class="string">                       - 核心概念:</span></span><br><span class="line"><span class="string">                       - 建议学习资源:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    2. **控制流和函数**:</span></span><br><span class="line"><span class="string">                       - 核心概念:</span></span><br><span class="line"><span class="string">                       - 建议学习资源:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    3. **数据结构和算法初步**:</span></span><br><span class="line"><span class="string">                       - 核心概念:</span></span><br><span class="line"><span class="string">                       - 建议学习资源:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    4. **面向对象编程 (OOP) 基础**:</span></span><br><span class="line"><span class="string">                       - 核心概念:</span></span><br><span class="line"><span class="string">                       - 建议学习资源:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    5. **模块、包和错误处理**:</span></span><br><span class="line"><span class="string">                       - 核心概念:</span></span><br><span class="line"><span class="string">                       - 建议学习资源:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    6. **文件操作和常用库**:</span></span><br><span class="line"><span class="string">                       - 核心概念:</span></span><br><span class="line"><span class="string">                       - 建议学习资源:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    请确保计划循序渐进，易于理解和实践。</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                ),</span><br><span class="line">                <span class="string">&quot;code_example&quot;</span>: TextPrompt(</span><br><span class="line">                    <span class="string">&quot;&quot;&quot;请为 **&#123;language&#125;** 中的 **&#123;concept&#125;** 提供一个清晰、简洁的代码示例。</span></span><br><span class="line"><span class="string">                    代码示例应包含必要的注释，并演示该概念的实际应用。</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                ),</span><br><span class="line">                <span class="string">&quot;exercise_problem&quot;</span>: TextPrompt(</span><br><span class="line">                    <span class="string">&quot;&quot;&quot;请为学习 **&#123;language&#125;** 中 **&#123;concept&#125;** 的用户设计一个练习题目。</span></span><br><span class="line"><span class="string">                    题目应包含明确的描述、输入输出要求和预期结果的示例。</span></span><br><span class="line"><span class="string">                    并提供一个参考答案（可以是一个简单的函数实现）。</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建AI编程导师的任务Agent</span></span><br><span class="line">        <span class="comment"># 默认使用 &quot;learning_plan&quot; 模板，后续会根据方法动态切换</span></span><br><span class="line">        <span class="variable language_">self</span>.tutor_agent = TaskSpecifyAgent(</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            task_type=TaskType.AI_SOCIETY, </span><br><span class="line">            task_specify_prompt=<span class="variable language_">self</span>.tutor_prompt_templates[<span class="string">&quot;learning_plan&quot;</span>], </span><br><span class="line">            output_language=<span class="string">&#x27;中文&#x27;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_learning_plan</span>(<span class="params">self, language=<span class="string">&quot;Python&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generates a detailed learning plan for the specified language.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n为学习 <span class="subst">&#123;language&#125;</span> 生成学习计划：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 动态更新 Agent 的提示，使用学习计划模板</span></span><br><span class="line">        <span class="variable language_">self</span>.tutor_agent.task_specify_prompt = <span class="variable language_">self</span>.tutor_prompt_templates[<span class="string">&quot;learning_plan&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.tutor_agent.run(</span><br><span class="line">            task_prompt=<span class="string">f&quot;生成一个关于学习 <span class="subst">&#123;language&#125;</span> 的详细计划&quot;</span>,</span><br><span class="line">            meta_dict=&#123;<span class="string">&quot;language&quot;</span>: language&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_code_example</span>(<span class="params">self, language, concept</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generates a code example for a specific concept in the given language.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n为 <span class="subst">&#123;language&#125;</span> 中的 <span class="subst">&#123;concept&#125;</span> 生成代码示例：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 动态更新 Agent 的提示，使用练习题目模板</span></span><br><span class="line">        <span class="variable language_">self</span>.tutor_agent.task_specify_prompt = <span class="variable language_">self</span>.tutor_prompt_templates[<span class="string">&quot;code_example&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.tutor_agent.run(</span><br><span class="line">            task_prompt=<span class="string">f&quot;生成一个关于 <span class="subst">&#123;language&#125;</span> 中 <span class="subst">&#123;concept&#125;</span> 的代码示例&quot;</span>,</span><br><span class="line">            meta_dict=&#123;<span class="string">&quot;language&quot;</span>: language, <span class="string">&quot;concept&quot;</span>: concept&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_exercise_problem</span>(<span class="params">self, language, concept</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generates an exercise problem with a reference answer for a specific concept.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n为 <span class="subst">&#123;language&#125;</span> 中的 <span class="subst">&#123;concept&#125;</span> 设计练习题目：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 动态更新 Agent 的提示，使用代码示例模板</span></span><br><span class="line">        <span class="variable language_">self</span>.tutor_agent.task_specify_prompt = <span class="variable language_">self</span>.tutor_prompt_templates[<span class="string">&quot;exercise_problem&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.tutor_agent.run(</span><br><span class="line">            task_prompt=<span class="string">f&quot;为 <span class="subst">&#123;language&#125;</span> 中 <span class="subst">&#123;concept&#125;</span> 设计一个练习题目&quot;</span>,</span><br><span class="line">            meta_dict=&#123;<span class="string">&quot;language&quot;</span>: language, <span class="string">&quot;concept&quot;</span>: concept&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment">#主程序</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># AI编程导师系统</span></span><br><span class="line">    tutor_system = AIProgrammingTutorAgent(model)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;AI 编程学习助手&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;帮助你逐步学习一门新的编程语言。&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1.生成Python学习计划</span></span><br><span class="line">    python_learning_plan = tutor_system.generate_learning_plan(<span class="string">&quot;Python&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.为特定概念生成代码</span></span><br><span class="line">    code_example_variables = tutor_system.generate_code_example(<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;变量和数据类型&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.为特定概念生成习题</span></span><br><span class="line">    exercise_problem_functions = tutor_system.generate_exercise_problem(<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;函数&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>代码运行输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/CAMEL_Prompt_task1.2.py</span><br><span class="line">AI 编程学习助手</span><br><span class="line">帮助你逐步学习一门新的编程语言。</span><br><span class="line"></span><br><span class="line">为学习 Python 生成学习计划：</span><br><span class="line">============================================================      </span><br><span class="line">### Python 学习计划</span><br><span class="line"></span><br><span class="line">#### 1. **基础语法和数据类型**</span><br><span class="line">- **核心概念**:</span><br><span class="line">  - 变量和数据类型（整型、浮点型、字符串、布尔型）</span><br><span class="line">  - 基本的输入输出（`input()` 和 `print()` 函数）</span><br><span class="line">  - 运算符（算术运算符、比较运算符、逻辑运算符）</span><br><span class="line">  - 注释（单行注释和多行注释）</span><br><span class="line">- **建议学习资源**:</span><br><span class="line">  - 官方文档：[Python 官方文档](https://docs.python.org/3/tutorial/index.html)</span><br><span class="line">  - 在线教程：[W3Schools Python 教程](https://www.w3schools.com/python/)</span><br><span class="line">  - 实践练习：[Codecademy Python 课程](https://www.codecademy.com/learn/learn-python)</span><br><span class="line"></span><br><span class="line">#### 2. **控制流和函数**</span><br><span class="line">- **核心概念**:</span><br><span class="line">  - 条件语句（`if`, `elif`, `else`）</span><br><span class="line">  - 循环（`for` 和 `while` 循环）</span><br><span class="line">  - 函数定义和调用（`def` 关键字）</span><br><span class="line">  - 参数和返回值</span><br><span class="line">  - 匿名函数（`lambda` 表达式）</span><br><span class="line">- **建议学习资源**:</span><br><span class="line">  - 官方文档：[Python 控制流工具](https://docs.python.org/3/tutorial/controlflow.html)</span><br><span class="line">  - 在线教程：[Real Python 控制流](https://realpython.com/python-control-flow/)</span><br><span class="line">  - 实践练习：[LeetCode 基础题](https://leetcode.com/problemset/all/?difficulty=Easy)</span><br><span class="line"></span><br><span class="line">#### 3. **数据结构和算法初步**</span><br><span class="line">- **核心概念**:</span><br><span class="line">  - 列表（`list`）和列表推导</span><br><span class="line">  - 元组（`tuple`）</span><br><span class="line">  - 字典（`dict`）</span><br><span class="line">  - 集合（`set`）</span><br><span class="line">  - 基本的排序和搜索算法</span><br><span class="line">- **建议学习资源**:</span><br><span class="line">  - 官方文档：[Python 数据结构](https://docs.python.org/3/tutorial/datastructures.html)</span><br><span class="line">  - 在线教程：[GeeksforGeeks 数据结构](https://www.geeksforgeeks.org/python-data-structures/)</span><br><span class="line">  - 实践练习：[HackerRank 数据结构挑战](https://www.hackerrank.com/domains/tutorials/10-days-of-python)</span><br><span class="line"></span><br><span class="line">#### 4. **面向对象编程 (OOP) 基础**</span><br><span class="line">- **核心概念**:</span><br><span class="line">  - 类和对象</span><br><span class="line">  - 属性和方法</span><br><span class="line">  - 构造函数（`__init__` 方法）</span><br><span class="line">  - 继承和多态</span><br><span class="line">  - 封装和私有属性</span><br><span class="line">- **建议学习资源**:</span><br><span class="line">  - 官方文档：[Python 类](https://docs.python.org/3/tutorial/classes.html)</span><br><span class="line">  - 在线教程：[Real Python 面向对象编程](https://realpython.com/python3-object-oriented-programming/)</span><br><span class="line">  - 实践练习：[Codewars OOP 挑战](https://www.codewars.com/kata/search/python?q=object%20oriented%20programming)</span><br><span class="line"></span><br><span class="line">#### 5. **模块、包和错误处理**</span><br><span class="line">- **核心概念**:</span><br><span class="line">  - 模块导入（`import` 语句）</span><br><span class="line">  - 创建和使用包</span><br><span class="line">  - 异常处理（`try`, `except`, `finally`）</span><br><span class="line">  - 自定义异常</span><br><span class="line">- **建议学习资源**:</span><br><span class="line">  - 官方文档：[Python 模块和包](https://docs.python.org/3/tutorial/modules.html)</span><br><span class="line">  - 在线教程：[Real Python 模块和包](https://realpython.com/python-modules-packages/)</span><br><span class="line">  - 实践练习：[Exercism Python 模块练习](https://exercism.io/tracks/python/exercises)</span><br><span class="line"></span><br><span class="line">#### 6. **文件操作和常用库**</span><br><span class="line">- **核心概念**:</span><br><span class="line">  - 文件读写（`open()`, `read()`, `write()`, `close()`）</span><br><span class="line">  - CSV 和 JSON 文件处理</span><br><span class="line">  - 常用库介绍（`os`, `sys`, `datetime`, `math`, `random`）       </span><br><span class="line">  - 第三方库安装和使用（`pip` 工具）</span><br><span class="line">- **建议学习资源**:</span><br><span class="line">  - 官方文档：[Python 文件操作](https://docs.python.org/3/tutorial/inputoutput.html#reading-and-writing-files)</span><br><span class="line">  - 在线教程：[Real Python 文件操作](https://realpython.com/read-write-files-python/)</span><br><span class="line">  - 实践练习：[DataCamp Python 数据处理课程](https://www.datacamp.com/courses/importing-data-in-python-part-1)</span><br><span class="line"></span><br><span class="line">### 总结</span><br><span class="line">通过以上六个阶段的学习，你将能够掌握 Python 的基本语法、数据结构、面向对象编程、模块和包的使用、文件操作以及常用库的使用。每个阶段都提供了详细的核心概念和建议的学习资源，希望你能够循序渐进地学习并实践，最终成为一名熟练的 Python 程序员。祝你学习顺利！</span><br><span class="line">============================================================      </span><br><span class="line"></span><br><span class="line">为 Python 中的 变量和数据类型 生成代码示例：</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"># Python中的变量和数据类型示例</span><br><span class="line"></span><br><span class="line"># 整型（int）</span><br><span class="line">age = 25  # 定义一个整数变量，表示年龄</span><br><span class="line">print(&quot;年龄:&quot;, age)</span><br><span class="line"></span><br><span class="line"># 浮点型（float）</span><br><span class="line">height = 1.75  # 定义一个浮点数变量，表示身高</span><br><span class="line">print(&quot;身高:&quot;, height)</span><br><span class="line"></span><br><span class="line"># 字符串（str）</span><br><span class="line">name = &quot;张三&quot;  # 定义一个字符串变量，表示名字</span><br><span class="line">print(&quot;姓名:&quot;, name)</span><br><span class="line"></span><br><span class="line"># 布尔型（bool）</span><br><span class="line">is_student = True  # 定义一个布尔型变量，表示是否是学生</span><br><span class="line">print(&quot;是否是学生:&quot;, is_student)</span><br><span class="line"></span><br><span class="line"># 列表（list）</span><br><span class="line">hobbies = [&quot;阅读&quot;, &quot;编程&quot;, &quot;旅行&quot;]  # 定义一个列表，表示兴趣爱好  </span><br><span class="line">print(&quot;兴趣爱好:&quot;, hobbies)</span><br><span class="line"></span><br><span class="line"># 元组（tuple）</span><br><span class="line">coordinates = (10, 20)  # 定义一个元组，表示坐标</span><br><span class="line">print(&quot;坐标:&quot;, coordinates)</span><br><span class="line"></span><br><span class="line"># 字典（dict）</span><br><span class="line">person = &#123;&quot;name&quot;: &quot;李四&quot;, &quot;age&quot;: 30, &quot;city&quot;: &quot;北京&quot;&#125;  # 定义一个字典，表示个人信息</span><br><span class="line">print(&quot;个人信息:&quot;, person)</span><br><span class="line"></span><br><span class="line"># 集合（set）</span><br><span class="line">fruits = &#123;&quot;苹果&quot;, &quot;香蕉&quot;, &quot;橙子&quot;&#125;  # 定义一个集合，表示水果种类   </span><br><span class="line">print(&quot;水果种类:&quot;, fruits)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这个示例展示了 Python 中几种基本的数据类型及其用法。每个变量都包含了相应的注释，说明其用途。通过打印输出，可以直观地看到每种数据类型的值。</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line">为 Python 中的 函数 设计练习题目：</span><br><span class="line">--------------------------------------------------</span><br><span class="line">### 练习题目：计算数字列表的平均值</span><br><span class="line"></span><br><span class="line">#### 描述</span><br><span class="line">编写一个 Python 函数 `calculate_average`，该函数接收一个整数或浮点数的列表作为参数，并返回这些数字的平均值。如果列表为空，函数应该返回 0。</span><br><span class="line"></span><br><span class="line">#### 输入输出要求</span><br><span class="line">- **输入**：一个包含整数或浮点数的列表。</span><br><span class="line">- **输出**：列表中所有数字的平均值，如果列表为空，则返回 0。      </span><br><span class="line"></span><br><span class="line">#### 示例</span><br><span class="line">- 输入: `[1, 2, 3, 4]`</span><br><span class="line">- 输出: `2.5`</span><br><span class="line"></span><br><span class="line">- 输入: `[]`</span><br><span class="line">- 输出: `0`</span><br><span class="line"></span><br><span class="line">#### 参考答案</span><br><span class="line"></span><br><span class="line">def calculate_average(numbers):</span><br><span class="line">    if not numbers:  # 检查列表是否为空</span><br><span class="line">        return 0</span><br><span class="line">    total = sum(numbers)  # 计算总和</span><br><span class="line">    count = len(numbers)  # 计算列表中的元素数量</span><br><span class="line">    average = total / count  # 计算平均值</span><br><span class="line">    return average</span><br><span class="line"></span><br><span class="line"># 测试代码</span><br><span class="line">print(calculate_average([1, 2, 3, 4]))  # 应输出 2.5</span><br><span class="line">print(calculate_average([]))  # 应输出 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这个练习题旨在帮助初学者理解如何处理列表以及如何使用基本的数学运算来计算平均值。同时，通过检查列表是否为空，还可以学习到如何在函数中添加条件判断以增强程序的健壮性。</span><br><span class="line">--------------------------------------------------</span><br></pre></td></tr></table></figure>
<h2 id="Task2"><a href="#Task2" class="headerlink" title="Task2"></a>Task2</h2><h3 id="02-利用GoogleMapsToolkit、DappierToolkit，使用RolePlaying。创建一个AI运动场馆推荐规划分析师Agent。创建一个AI用户Agent，限定其所在位置为“中国-北京-北京市”区域任意随机一点。让AI扮演一个“个性化运动场地顾问”，根据AI“用户”提出的随机个性需求，通过ChatHistoryBlock内对用户的需求进行匹配度计算以及选择。为AI“用户”提出-运动场馆选择建议。"><a href="#02-利用GoogleMapsToolkit、DappierToolkit，使用RolePlaying。创建一个AI运动场馆推荐规划分析师Agent。创建一个AI用户Agent，限定其所在位置为“中国-北京-北京市”区域任意随机一点。让AI扮演一个“个性化运动场地顾问”，根据AI“用户”提出的随机个性需求，通过ChatHistoryBlock内对用户的需求进行匹配度计算以及选择。为AI“用户”提出-运动场馆选择建议。" class="headerlink" title="02.利用GoogleMapsToolkit、DappierToolkit，使用RolePlaying。创建一个AI运动场馆推荐规划分析师Agent。创建一个AI用户Agent，限定其所在位置为“中国 北京 北京市”区域任意随机一点。让AI扮演一个“个性化运动场地顾问”，根据AI“用户”提出的随机个性需求，通过ChatHistoryBlock内对用户的需求进行匹配度计算以及选择。为AI“用户”提出 运动场馆选择建议。"></a>02.利用GoogleMapsToolkit、DappierToolkit，使用RolePlaying。创建一个AI运动场馆推荐规划分析师Agent。创建一个AI用户Agent，限定其所在位置为“中国 北京 北京市”区域任意随机一点。让AI扮演一个“个性化运动场地顾问”，根据AI“用户”提出的随机个性需求，通过ChatHistoryBlock内对用户的需求进行匹配度计算以及选择。为AI“用户”提出 运动场馆选择建议。</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> TaskSpecifyAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.prompts <span class="keyword">import</span> TextPrompt</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType, TaskType</span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> SearchToolkit, MathToolkit</span><br><span class="line"><span class="keyword">from</span> camel.memories <span class="keyword">import</span> ChatHistoryBlock</span><br><span class="line"><span class="keyword">from</span> camel.memories.records <span class="keyword">import</span> MemoryRecord</span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> OpenAIBackendRole</span><br><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建模型实例</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AI用户Agent - 随机生成运动需求</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIUserAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义AI用户的提示模板</span></span><br><span class="line">        <span class="variable language_">self</span>.user_prompt = TextPrompt(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;你是一位居住在中国北京市的AI用户，希望找到合适的运动场馆。请根据以下信息生成一个真实的个性化运动需求描述：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            年龄范围：&#123;age_range&#125;</span></span><br><span class="line"><span class="string">            身份职业：&#123;occupation&#125;</span></span><br><span class="line"><span class="string">            运动偏好：&#123;sport_preference&#125;</span></span><br><span class="line"><span class="string">            特殊需求：&#123;special_needs&#125;</span></span><br><span class="line"><span class="string">            当前位置：&#123;location&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            请以第一人称的方式描述你的需求，包括：</span></span><br><span class="line"><span class="string">            1. 基本信息（年龄、职业、生活方式）</span></span><br><span class="line"><span class="string">            2. 具体想进行的运动和期望</span></span><br><span class="line"><span class="string">            3. 对场馆设施、环境、交通等方面的特殊要求</span></span><br><span class="line"><span class="string">            4. 预算或时间限制（如果适用）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            请保持真实、详细，就像真正的用户在描述自己的运动需求一样。</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建AI用户的任务Agent</span></span><br><span class="line">        <span class="variable language_">self</span>.user_agent = TaskSpecifyAgent(</span><br><span class="line">            model=<span class="variable language_">self</span>.model,</span><br><span class="line">            task_type=TaskType.AI_SOCIETY,</span><br><span class="line">            task_specify_prompt=<span class="variable language_">self</span>.user_prompt,</span><br><span class="line">            output_language=<span class="string">&#x27;ch&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 随机案例生成的模板库</span></span><br><span class="line">        <span class="variable language_">self</span>.case_templates = &#123;</span><br><span class="line">            <span class="string">&quot;age_ranges&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;18-25岁&quot;</span>, <span class="string">&quot;26-35岁&quot;</span>, <span class="string">&quot;36-45岁&quot;</span>, <span class="string">&quot;46-55岁&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;occupations&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;学生&quot;</span>, <span class="string">&quot;白领&quot;</span>, <span class="string">&quot;自由职业者&quot;</span>, <span class="string">&quot;程序员&quot;</span>, <span class="string">&quot;设计师&quot;</span>, <span class="string">&quot;销售&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;sport_preferences&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;羽毛球&quot;</span>, <span class="string">&quot;游泳&quot;</span>, <span class="string">&quot;健身&quot;</span>, <span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;足球&quot;</span>, <span class="string">&quot;网球&quot;</span>, <span class="string">&quot;瑜伽&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;special_needs&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;希望有室内场地&quot;</span>, <span class="string">&quot;交通便利&quot;</span>, <span class="string">&quot;环境安静&quot;</span>, <span class="string">&quot;价格适中&quot;</span>, </span><br><span class="line">                <span class="string">&quot;有教练指导&quot;</span>, <span class="string">&quot;设备齐全&quot;</span>, <span class="string">&quot;附近有停车场&quot;</span>, <span class="string">&quot;适合家庭活动&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 随机北京位置点（简化版）</span></span><br><span class="line">        <span class="variable language_">self</span>.beijing_locations = [</span><br><span class="line">            <span class="string">&quot;北京市朝阳区三里屯街道&quot;</span>, <span class="string">&quot;北京市海淀区中关村街道&quot;</span>,</span><br><span class="line">            <span class="string">&quot;北京市东城区东华门街道&quot;</span>, <span class="string">&quot;北京市西城区金融街街道&quot;</span>,</span><br><span class="line">            <span class="string">&quot;北京市丰台区丰台街道&quot;</span>, <span class="string">&quot;北京市石景山区八宝山街道&quot;</span>,</span><br><span class="line">            <span class="string">&quot;北京市通州区梨园街道&quot;</span>, <span class="string">&quot;北京市昌平区回龙观街道&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_random_case</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;随机生成一个用户运动需求案例&quot;&quot;&quot;</span></span><br><span class="line">        location = random.choice(<span class="variable language_">self</span>.beijing_locations)</span><br><span class="line">        </span><br><span class="line">        case_info = &#123;</span><br><span class="line">            <span class="string">&quot;age_range&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;age_ranges&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;occupation&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;occupations&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;sport_preference&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;sport_preferences&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;special_needs&quot;</span>: random.choice(<span class="variable language_">self</span>.case_templates[<span class="string">&quot;special_needs&quot;</span>]),</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: location</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n🏃 随机生成用户运动需求案例：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;年龄：<span class="subst">&#123;case_info[<span class="string">&#x27;age_range&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;职业：<span class="subst">&#123;case_info[<span class="string">&#x27;occupation&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;运动偏好：<span class="subst">&#123;case_info[<span class="string">&#x27;sport_preference&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;特殊需求：<span class="subst">&#123;case_info[<span class="string">&#x27;special_needs&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;所在位置：<span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> case_info</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_user_profile</span>(<span class="params">self, case_info=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建用户运动需求档案&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> case_info <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            case_info = <span class="variable language_">self</span>.generate_random_case()</span><br><span class="line">        </span><br><span class="line">        task_prompt = <span class="string">&quot;生成一个真实的个性化运动需求描述&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="variable language_">self</span>.user_agent.run(</span><br><span class="line">            task_prompt=task_prompt,</span><br><span class="line">            meta_dict=case_info</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n AI用户的自述：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response, case_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运动场馆推荐系统 - 使用RolePlaying框架</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SportsVenueRecommendationSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        <span class="variable language_">self</span>.ai_user = AIUserAgent(model)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化ChatHistoryBlock记忆系统</span></span><br><span class="line">        <span class="variable language_">self</span>.chat_history = ChatHistoryBlock(keep_rate=<span class="number">0.9</span>)  <span class="comment"># 设置权重衰减率</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义工具包（模拟GoogleMapsToolkit和DappierToolkit功能）</span></span><br><span class="line">        <span class="variable language_">self</span>.tools_list = [</span><br><span class="line">            *SearchToolkit().get_tools(),</span><br><span class="line">            *MathToolkit().get_tools()</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; ChatHistoryBlock记忆系统已初始化&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; 工具包已加载（搜索工具、数学工具）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_recommendation_with_roleplay</span>(<span class="params">self, use_random_case=<span class="literal">True</span>, custom_case=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;使用RolePlaying框架开始运动场馆推荐&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n AI运动场馆推荐系统启动（RolePlaying模式）&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成用户需求</span></span><br><span class="line">        <span class="keyword">if</span> use_random_case:</span><br><span class="line">            user_description, case_info = <span class="variable language_">self</span>.ai_user.create_user_profile()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user_description, case_info = <span class="variable language_">self</span>.ai_user.create_user_profile(custom_case)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取历史对话记录用于上下文</span></span><br><span class="line">        retrieved_history = <span class="variable language_">self</span>.chat_history.retrieve(window_size=<span class="number">5</span>)</span><br><span class="line">        history_context = <span class="string">&quot;\n&quot;</span>.join([</span><br><span class="line">            <span class="string">f&quot;历史记录<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;record.memory_record.message.role_name&#125;</span>: <span class="subst">&#123;record.memory_record.message.content[:<span class="number">100</span>]&#125;</span>...&quot;</span> </span><br><span class="line">            <span class="keyword">for</span> i, record <span class="keyword">in</span> <span class="built_in">enumerate</span>(retrieved_history[-<span class="number">3</span>:])  <span class="comment"># 只取最近3条记录</span></span><br><span class="line">        ]) <span class="keyword">if</span> retrieved_history <span class="keyword">else</span> <span class="string">&quot;暂无历史记录&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建任务提示，包含用户需求和历史上下文</span></span><br><span class="line">        task_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        作为个性化运动场地顾问，请为用户提供专业的运动场馆推荐。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        用户需求: <span class="subst">&#123;user_description&#125;</span></span></span><br><span class="line"><span class="string">        用户位置: <span class="subst">&#123;case_info[<span class="string">&#x27;location&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        历史对话上下文: <span class="subst">&#123;history_context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请通过思维链方式分析用户需求，并利用地图搜索功能找到最适合的运动场馆。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 设置RolePlaying会话</span></span><br><span class="line">        role_play_session = RolePlaying(</span><br><span class="line">            assistant_role_name=<span class="string">&quot;个性化运动场地顾问&quot;</span>,</span><br><span class="line">            assistant_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">                model=<span class="variable language_">self</span>.model,</span><br><span class="line">                tools=<span class="variable language_">self</span>.tools_list  <span class="comment"># 为助手提供工具</span></span><br><span class="line">            ),</span><br><span class="line">            user_role_name=<span class="string">&quot;运动场馆推荐需求分析师&quot;</span>, </span><br><span class="line">            user_agent_kwargs=<span class="built_in">dict</span>(model=<span class="variable language_">self</span>.model),</span><br><span class="line">            task_prompt=task_prompt,</span><br><span class="line">            with_task_specify=<span class="literal">True</span>,</span><br><span class="line">            task_specify_agent_kwargs=<span class="built_in">dict</span>(model=<span class="variable language_">self</span>.model),  <span class="comment"># 关键修复：为TaskSpecifyAgent提供自定义模型</span></span><br><span class="line">            output_language=<span class="string">&#x27;中文&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot; 助手角色: <span class="subst">&#123;role_play_session.assistant_sys_msg&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot; 用户角色: <span class="subst">&#123;role_play_session.user_sys_msg&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot; 任务: <span class="subst">&#123;task_prompt[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 开始对话</span></span><br><span class="line">        input_msg = role_play_session.init_chat()</span><br><span class="line">        max_turns = <span class="number">8</span></span><br><span class="line">        turn_count = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        recommendation_result = <span class="string">&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查初始消息是否有效</span></span><br><span class="line">        <span class="keyword">if</span> input_msg <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;无法初始化对话&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;case_info&quot;</span>: case_info,</span><br><span class="line">                <span class="string">&quot;user_description&quot;</span>: user_description, </span><br><span class="line">                <span class="string">&quot;recommendation&quot;</span>: <span class="string">&quot;系统初始化失败&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> turn_count &lt; max_turns:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.WHITE + <span class="string">f&quot;\n[轮次 <span class="subst">&#123;turn_count + <span class="number">1</span>&#125;</span>]&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 安全访问消息内容</span></span><br><span class="line">                assistant_content = assistant_response.msg.content <span class="keyword">if</span> assistant_response.msg <span class="keyword">else</span> <span class="string">&quot;无响应&quot;</span></span><br><span class="line">                user_content = user_response.msg.content <span class="keyword">if</span> user_response.msg <span class="keyword">else</span> <span class="string">&quot;无响应&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot; 运动场地顾问: <span class="subst">&#123;assistant_content&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot; 需求分析师: <span class="subst">&#123;user_content&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 显示工具调用信息</span></span><br><span class="line">                <span class="keyword">if</span> assistant_response.info.get(<span class="string">&#x27;tool_calls&#x27;</span>):</span><br><span class="line">                    <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">f&quot; 工具调用: <span class="subst">&#123;assistant_response.info[<span class="string">&#x27;tool_calls&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查任务完成</span></span><br><span class="line">                <span class="keyword">if</span> assistant_response.terminated <span class="keyword">or</span> user_response.terminated:</span><br><span class="line">                    <span class="built_in">print</span>(Fore.RED + <span class="string">&quot; 对话完成&quot;</span>)</span><br><span class="line">                    recommendation_result = assistant_content</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> user_response.msg <span class="keyword">and</span> <span class="string">&quot;CAMEL_TASK_DONE&quot;</span> <span class="keyword">in</span> user_response.msg.content:</span><br><span class="line">                    <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot; 任务成功完成!&quot;</span>)</span><br><span class="line">                    recommendation_result = assistant_content</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 确保下一轮的输入消息有效</span></span><br><span class="line">                <span class="keyword">if</span> assistant_response.msg <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="built_in">print</span>(Fore.RED + <span class="string">&quot; 助手响应为空，结束对话&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                input_msg = assistant_response.msg</span><br><span class="line">                turn_count += <span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot; 执行错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存到ChatHistoryBlock记忆系统</span></span><br><span class="line">        user_record = MemoryRecord(</span><br><span class="line">            message=BaseMessage.make_user_message(role_name=<span class="string">&quot;User&quot;</span>, content=user_description),</span><br><span class="line">            role_at_backend=OpenAIBackendRole.USER</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        final_recommendation = recommendation_result <span class="keyword">or</span> <span class="string">&quot;系统未能完成推荐&quot;</span></span><br><span class="line">        assistant_record = MemoryRecord(</span><br><span class="line">            message=BaseMessage.make_assistant_message(role_name=<span class="string">&quot;SportsConsultant&quot;</span>, content=final_recommendation),</span><br><span class="line">            role_at_backend=OpenAIBackendRole.ASSISTANT</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.chat_history.write_records([user_record, assistant_record])</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n 对话已保存到记忆系统&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; 运动场馆推荐完成！&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;case_info&quot;</span>: case_info,</span><br><span class="line">            <span class="string">&quot;user_description&quot;</span>: user_description, </span><br><span class="line">            <span class="string">&quot;recommendation&quot;</span>: final_recommendation</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_memory_analysis</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;基于ChatHistoryBlock进行记忆分析&quot;&quot;&quot;</span></span><br><span class="line">        retrieved_history = <span class="variable language_">self</span>.chat_history.retrieve(window_size=<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> retrieved_history:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot; 暂无历史记录&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n ChatHistoryBlock记忆分析:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        user_requests = []</span><br><span class="line">        recommendations = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> record <span class="keyword">in</span> retrieved_history:</span><br><span class="line">            <span class="keyword">if</span> record.memory_record.message.role_name <span class="keyword">in</span> [<span class="string">&quot;User&quot;</span>]:</span><br><span class="line">                user_requests.append(record.memory_record.message.content)</span><br><span class="line">            <span class="keyword">elif</span> record.memory_record.message.role_name <span class="keyword">in</span> [<span class="string">&quot;SportsConsultant&quot;</span>]:</span><br><span class="line">                recommendations.append(record.memory_record.message.content)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot; 总共处理了 <span class="subst">&#123;<span class="built_in">len</span>(user_requests)&#125;</span> 个用户请求&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot; 总共提供了 <span class="subst">&#123;<span class="built_in">len</span>(recommendations)&#125;</span> 个推荐方案&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析用户偏好模式</span></span><br><span class="line">        sport_preferences = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> request <span class="keyword">in</span> user_requests:</span><br><span class="line">            <span class="keyword">for</span> sport <span class="keyword">in</span> [<span class="string">&quot;篮球&quot;</span>, <span class="string">&quot;羽毛球&quot;</span>, <span class="string">&quot;游泳&quot;</span>, <span class="string">&quot;健身&quot;</span>, <span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;足球&quot;</span>, <span class="string">&quot;网球&quot;</span>, <span class="string">&quot;瑜伽&quot;</span>]:</span><br><span class="line">                <span class="keyword">if</span> sport <span class="keyword">in</span> request:</span><br><span class="line">                    sport_preferences[sport] = sport_preferences.get(sport, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sport_preferences:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot; 用户运动偏好统计: <span class="subst">&#123;sport_preferences&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 展示最近的记录（带权重）</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n 最近的记录（权重衰减机制）:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, record <span class="keyword">in</span> <span class="built_in">enumerate</span>(retrieved_history[-<span class="number">5</span>:]):  <span class="comment"># 只显示最近5条</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;记录<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;record.memory_record.message.role_name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;内容: <span class="subst">&#123;record.memory_record.message.content[:<span class="number">150</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;权重: <span class="subst">&#123;record.score:<span class="number">.3</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear_memory</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空记忆系统&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.chat_history.clear()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; 记忆系统已清空&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主程序运行</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; AI运动场馆推荐规划分析师系统&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 集成RolePlaying + 工具包 + ChatHistoryBlock记忆&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 服务区域：中国北京市&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建推荐系统</span></span><br><span class="line">    recommendation_system = SportsVenueRecommendationSystem(model)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第一次推荐（无历史记录）</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n 第一次推荐 - 新用户咨询&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">    result1 = recommendation_system.start_recommendation_with_roleplay(use_random_case=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进行记忆分析</span></span><br><span class="line">    recommendation_system.get_memory_analysis()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第二次推荐（有历史记录，体现记忆功能）</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n 第二次推荐 - 基于历史记录的智能推荐&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line">    result2 = recommendation_system.start_recommendation_with_roleplay(use_random_case=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 最终记忆分析</span></span><br><span class="line">    recommendation_system.get_memory_analysis()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n 系统演示完成！&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; ChatHistoryBlock成功实现了用户需求的匹配度计算和历史记录管理&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>运行输出样例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/CAMEL_Prompt_task2.py</span><br><span class="line"> AI运动场馆推荐规划分析师系统</span><br><span class="line"> 集成RolePlaying + 工具包 + ChatHistoryBlock记忆</span><br><span class="line"> 服务区域：中国北京市</span><br><span class="line">================================================================================</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_linkup&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;searchResults&#x27;, &#x27;sourcedAnswer&#x27;, &#x27;structured&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.      </span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;enum&#x27;: [&#x27;OneDay&#x27;, &#x27;OneWeek&#x27;, &#x27;OneMonth&#x27;, &#x27;OneYear&#x27;, &#x27;NoLimit&#x27;], &#x27;type&#x27;: [&#x27;string&#x27;, &#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\toolkits\function_tool.py:533: UserWarning: Parameter description is missing for the function &#x27;search_alibaba_tongxiao&#x27;. The parameter definition is &#123;&#x27;anyOf&#x27;: [&#123;&#x27;enum&#x27;: [&#x27;finance&#x27;, &#x27;law&#x27;, &#x27;medical&#x27;, &#x27;internet&#x27;, &#x27;tax&#x27;, &#x27;news_province&#x27;, &#x27;news_center&#x27;], &#x27;type&#x27;: &#x27;string&#x27;&#125;, &#123;&#x27;type&#x27;: &#x27;null&#x27;&#125;], &#x27;type&#x27;: [&#x27;null&#x27;]&#125;. This may affect the quality of tool calling.</span><br><span class="line">  warnings.warn(</span><br><span class="line"> ChatHistoryBlock记忆系统已初始化</span><br><span class="line"> 工具包已加载（搜索工具、数学工具）</span><br><span class="line"></span><br><span class="line"> 第一次推荐 - 新用户咨询</span><br><span class="line">============================================================      </span><br><span class="line"></span><br><span class="line"> AI运动场馆推荐系统启动（RolePlaying模式）</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">🏃 随机生成用户运动需求案例：</span><br><span class="line">年龄：46-55岁</span><br><span class="line">职业：白领</span><br><span class="line">运动偏好：跑步</span><br><span class="line">特殊需求：交通便利</span><br><span class="line">所在位置：北京市丰台区丰台街道</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> AI用户的自述：</span><br><span class="line">大家好，我是一名48岁的白领，目前居住在北京市丰台区丰台街道。由于工作压力大，长时间坐在办公室里，我意识到保持身体健康的重要性。因此，我希望能够在业余时间多参与一些体育活动，尤其是我喜欢的跑步。      </span><br><span class="line"></span><br><span class="line">理想情况下，我希望能够找到一个设施齐全、环境舒适的运动场馆，最好是能够提供专业的跑道，让我可以在安全的环境中尽情奔跑。同时，考虑到我每天上下班的时间已经比较紧张，所以特别希望能找到一个交通便利的地方，最好是靠近地铁站或者公交站，这样可以节省往返的时间。</span><br><span class="line"></span><br><span class="line">关于预算方面，我愿意每月投入一定费用来保证自己的健康，但希望价格合理，不会给生活带来太大负担。至于时间，我一般会选择在下班后或是周末的空闲时间去锻炼，所以场馆的开放时间如果能覆盖这些时间段就再好不过了。</span><br><span class="line"></span><br><span class="line">总之，我希望能够在北京丰台区附近找到一个适合我的运动场所，不仅能满足我对跑步的热情，还能兼顾到生活的其他方面。如果有符合这些条件的地方，欢迎推荐给我，谢谢！</span><br><span class="line">--------------------------------------------------</span><br><span class="line">D:\Download\Python\py-3.11.9\Lib\site-packages\camel\memories\blocks\chat_history_block.py:73: UserWarning: The `ChatHistoryMemory` is empty.</span><br><span class="line">  warnings.warn(&quot;The `ChatHistoryMemory` is empty.&quot;)</span><br><span class="line"> 助手角色: BaseMessage(role_name=&#x27;个性化运动场地顾问&#x27;, role_type=&lt;RoleType.ASSISTANT: &#x27;assistant&#x27;&gt;, meta_dict=&#123;&#x27;task&#x27;: &#x27;作为个性化运动场地顾问，根据您的需求，我将为您推荐位于北京市丰台区丰台街道附近的运动场馆，确保设施齐全、环境舒适、交通便利且价格合理，重点满足您对专业跑道的需求。&#x27;, &#x27;assistant_role&#x27;: &#x27;个性化运动场地顾问&#x27;, &#x27;user_role&#x27;: &#x27;运动场馆推荐需求分析师&#x27;&#125;, content=&#x27;===== RULES OF ASSISTANT =====\nNever forget you are a 个性化运动场地顾问 and I am a 运 动场馆推荐需求分析师. Never flip roles! Never instruct me!\nWe share a common interest in collaborating to successfully complete a task.\nYou must help me to complete the task.\nHere is the task: 作为个性化运动场地顾问，根据您的需求，我将为您推荐位于北京市丰台区丰台街道附近的运动场馆，确保设施齐全、环境舒适、交通便利且价格合理，重点满足您对专业跑道的需求。. Never forget our task!\nI must instruct you based on your expertise and my needs to complete the task.\n\nI must give you one instruction at a time.\nYou must write a specific solution that appropriately solves the requested instruction and explain your solutions.\nYou must decline my instruction honestly if you cannot perform the instruction due to physical, moral, legal reasons or your capability and explain the reasons.\nUnless I say the task is completed, you should always start with:\n\nSolution: &lt;YOUR_SOLUTION&gt;\n\n&lt;YOUR_SOLUTION&gt; should be very specific, include detailed explanations and provide preferable detailed implementations and examples and lists for task-solving.\nAlways end &lt;YOUR_SOLUTION&gt; with: Next request.\nRegardless of the input language, you must output text in 中文.&#x27;, video_bytes=None, image_list=None, image_detail=&#x27;auto&#x27;, video_detail=&#x27;auto&#x27;, parsed=None)    </span><br><span class="line"> 用户角色: BaseMessage(role_name=&#x27;运动场馆推荐需求分析师&#x27;, role_type=&lt;RoleType.USER: &#x27;user&#x27;&gt;, meta_dict=&#123;&#x27;task&#x27;: &#x27;作为个性化运动场地顾问，根据您的需求，我将为您推荐位于北京市丰台区丰台街道附近的运动场馆，确保设施齐全、环境舒适、交通便利且价格合理，重点满足您对专业跑道的需求。&#x27;, &#x27;assistant_role&#x27;: &#x27;个性化运动场地顾问&#x27;, &#x27;user_role&#x27;: &#x27;运动场馆推荐需求分析师&#x27;&#125;, content=&#x27;===== RULES OF USER =====\nNever forget you are a 运动场馆推荐需求分析师 and I am a 个性化运动场地顾问. Never flip roles! You will always instruct me.\nWe share a common interest in collaborating to successfully complete a task.\nI must help you to complete the task.\nHere is the task: 作为 个性化运动场地顾问，根据您的需求，我将为您推荐位于北京市丰台区丰台街道附近的运动场馆，确保设施齐全、环境舒适、交通便利且价格合理，重点满足您对专业跑道的需求。. Never forget our task!\nYou must instruct me based on my expertise and your needs to solve the task ONLY in the following two ways:\n\n1. Instruct with a necessary input:\nInstruction: &lt;YOUR_INSTRUCTION&gt;\nInput: &lt;YOUR_INPUT&gt;\n\n2. Instruct without any input:\nInstruction: &lt;YOUR_INSTRUCTION&gt;\nInput: None\n\nThe &quot;Instruction&quot; describes a task or question. The paired &quot;Input&quot; provides further context or information for the requested &quot;Instruction&quot;.\n\nYou must give me one instruction at a time.\nI must write a response that appropriately solves the requested instruction.\nI must decline your instruction honestly if I cannot perform the instruction due to physical, moral, legal reasons or my capability and explain the reasons.\nYou should instruct me not ask me questions.\nNow you must start to instruct me using the two ways described above.\nDo not add anything else other than your instruction and the optional corresponding input!\nKeep giving me instructions and necessary inputs until you think the task is completed.\nWhen the task is completed, you must only reply with a single word &lt;CAMEL_TASK_DONE&gt;.\nNever say &lt;CAMEL_TASK_DONE&gt; unless my responses have solved your task.\nRegardless of the input language, you must output text in 中文.&#x27;, video_bytes=None, image_list=None, image_detail=&#x27;auto&#x27;, video_detail=&#x27;auto&#x27;, parsed=None)</span><br><span class="line"> 任务:</span><br><span class="line">        作为个性化运动场地顾问，请为用户提供专业的运动场馆推荐。  </span><br><span class="line"></span><br><span class="line">        用户需求: 大家好，我是一名48岁的白领，目前居住在北京市丰台区丰台街道。由于工作压力大，长时间坐在办公室里，我意识到保持身体健康的重要性。因此，我希望能够在业余时间多参与一些体育活动，尤其是我喜欢的跑步。</span><br><span class="line"></span><br><span class="line">理想情况下，我希望能够找到一个设施齐全、环境舒适的运动场馆，最好是能够提供专业的...</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">[轮次 1]</span><br><span class="line"> 运动场地顾问: 根据搜索结果，这里列出了一些可能符合要求的运动场馆 信息，但请注意这些信息可能并不完全准确，建议您进一步核实：        </span><br><span class="line"></span><br><span class="line">1. **丰宜福台公园**</span><br><span class="line">   - **地址**：北京市丰台区丰宜路与南三环西路交叉口东南侧</span><br><span class="line">   - **描述**：公园内设有夜跑活动，适合喜欢在自然环境中跑步的朋友 。</span><br><span class="line"></span><br><span class="line">2. **飞跃体育场**</span><br><span class="line">   - **地址**：北京市丰台区体育中心北路</span><br><span class="line">   - **描述**：这是一个综合性的体育场馆，提供多种运动设施，包括跑 道。</span><br><span class="line"></span><br><span class="line">3. **绿地+运动场项目**</span><br><span class="line">   - **地址**：具体位置不详，但该项目旨在解决居民健身场所不足的问 题，可能在丰台区内有多个地点。</span><br><span class="line">   - **描述**：项目结合绿地资源建设运动场地，方便市民在家门口进行 锻炼。</span><br><span class="line"></span><br><span class="line">4. **老仓库变体育小镇**</span><br><span class="line">   - **地址**：北京市丰台区（具体地址未提及）</span><br><span class="line">   - **描述**：原为老仓库的区域改造成了一个包含多个运动场馆的体育 小镇，可能包括专业的跑道设施。</span><br><span class="line"></span><br><span class="line">以上信息来源于网络搜索，建议您联系相关场馆获取更详细的信息，如开放时间、费用等。如果您需要更具体的信息或帮助，请告诉我。Next request.</span><br><span class="line"> 需求分析师: Instruction: 根据您的需求，我需要收集丰台区丰台街道附近的专业跑道信息。</span><br><span class="line">Input: 请提供该区域内的运动场馆名称和地址。</span><br><span class="line"> 工具调用: [ToolCallingRecord(tool_name=&#x27;search_google&#x27;, args=&#123;&#x27;query&#x27;: &#x27;北京市丰台区丰台街道 专业跑道 运动场馆&#x27;, &#x27;num_result_pages&#x27;: 3&#125;, result=[&#123;&#x27;error&#x27;: &#x27;google search failed.&#x27;&#125;], tool_call_id=&#x27;call_b2f4941ebda04b1a800a59&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;北京市丰台区丰台街道 专业跑道 运动场馆&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27; 老仓库变体育小镇,丰台这个地儿可一站打卡10余座运动场馆_腾讯新闻&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=lR1H_oO771EcRgxvQMQBRjdBb9LzqHTmoOC5dcnbqmvn19_lZRBG9xL0ioBuqWOg3BnbnM4WO32GyehBx_xcPa&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;“绿地+运动场”破题“健身去 哪儿”——北京市民家门口健身有了好去处_国...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=NLJqd0BOAtF9gMjzyfgbr-hiZ6feeywm34U3FyDNHsRpHnGUQ5PobCctbgGNkv4RqhvJaEtXAEf7d_ze9tdftD6x_q2r6HdaVerp4aTtg614ulbWtiPwwgGFc_M--hHd&#x27;&#125;, &#123;&#x27;result_id&#x27;: 3, &#x27;title&#x27;: &#x27;丰台时报数字报-韵动北京·丰宜福台公园夜跑举行&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=lR1H_oO771EcRgxvQMQBRoe81gNNZb82J0kVk6tR-E4CCTOLmZpz62JQzstVzzNhNyzfZL62FWLFDvismo3d3M-p72JwBqUo2jsz1zg1D1iBrwY8RYcJU3Zgfnwp3R1p&#x27;&#125;, &#123;&#x27;result_id&#x27;: 4, &#x27;title&#x27;: &#x27;飞跃 体育场-北京市丰台区人民政府网站&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=XWmLeK3K5QHwvN1ImZ3msJf5W_SkOMt7hvKGbk7eLCfBhh19pVzZIOev8qBIuTQK0eAiggXKg9IJWLTkQ6jUphfBcrJmfd0rVgIkTwm9QIdGURKcAL2QG1uWtykICsv2&#x27;&#125;, &#123;&#x27;result_id&#x27;: 5, &#x27;title&#x27;: &#x27;...肖家河·绿动天地开园_各区热点_首都之窗_北京市人民政府门户...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=z9NWXw3u8jxcRTwTYQRYesLMG47rAcy2KOZ1e0o0ihZCszyUT5C3GkMrJDJTwekfjw7-fdQwjySHZb6onOcKjl2hp_UpqBJxNj9NPjJnMXa&#x27;&#125;]&#125;, tool_call_id=&#x27;call_887ea9b5e4954f51893e3c&#x27;)]</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 2]</span><br><span class="line"> 运动场地顾问: 根据百度搜索的结果，关于“飞跃体育场”的具体信息并不 十分丰富，但我找到了一些相关的资料，可以为您提供参考：</span><br><span class="line"></span><br><span class="line">1. **丰台体育中心游泳馆**（虽然不是飞跃体育场，但同属于丰台区体育 中心的一部分）</span><br><span class="line">   - **地址**：北京市丰台区体育中心北路</span><br><span class="line">   - **开放时间**：通常情况下，工作日为上午6:00至晚上21:00；周末及节假日为上午7:00至晚上21:00。具体开放时间可能会因季节调整而有所变 化。</span><br><span class="line">   - **费用**：成人票价大约在30-50元之间，儿童及学生享受半价优惠。具体的收费情况建议您直接咨询场馆。</span><br><span class="line">   - **设施情况**：除了标准泳池外，还设有更衣室、淋浴间等配套设施 。此外，体育中心内还有篮球场、足球场、网球场等多种运动设施，其中可能包括您提到的专业跑道。</span><br><span class="line"></span><br><span class="line">对于飞跃体育场本身，由于直接信息较少，建议您直接联系丰台区体育中心获取最准确的信息。您可以尝试拨打体育中心的服务电话或访问其官方网站查询更多详情。</span><br><span class="line"></span><br><span class="line">如果需要进一步的帮助，请随时告知。Next request.</span><br><span class="line"> 需求分析师: Instruction: 从上述场馆中选择一个最符合您需求的，并了解其详细信息。</span><br><span class="line">Input: 请提供飞跃体育场的具体信息，包括开放时间、费用、设施情况等 。</span><br><span class="line"> 工具调用: [ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;飞跃体育场 丰台区 详细信息 开放时间 费用 设施&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27;北京体育馆_360百科&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=ysPAUJ_jv3NxnFd_riaTyQ4aQwLvGhwXGVKnZkPFfqkhv0Q65MwxuVMyv_yM8iIADjHmV_Cdo8xDmMFZ9vAEeq&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;...北京丰台体育中心游泳馆门票/地址/图片/开放时间/照片/门票价格...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=_tCXrrC9Cgp6N4WlvHlSQxypNKSM-xqfoNUmSo5zn4blZeVWlyBqB_Mxb6UREacaHuSrRQp5ofjmNTuQcyXjUa&#x27;&#125;, &#123;&#x27;result_id&#x27;: 3, &#x27;title&#x27;: &#x27;北京丰台体育中心游泳馆游玩攻略-丰台体育中心游泳馆门票多少钱/...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=-1syuRo4YNaHL0J9Yu6s4u8BsJ_cjIvnrkuAnYN4sgqmaIeNViZCmkOU7u-8n0Sd2Lc2rmjM4u9bZ8w_jzbZsjwwc9wJ7dptmfXo0N66LNe&#x27;&#125;, &#123;&#x27;result_id&#x27;: 4, &#x27;title&#x27;: &#x27;丰台体育中心-北京市丰台区人民政府网站&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=u6nr7ctKtu6pvpnS5PzRY6v_8zq0OtDb4GtDWa8JEI_zU4IG60HbK5WU1Q0uZlqX5L9fQKyoKbk_VDet5_AgnSuQNVlElRqKKp9wAje7fMhF8cqBbxhFDNtKBH2U0lUS&#x27;&#125;, &#123;&#x27;result_id&#x27;: 5, &#x27;title&#x27;: &#x27;...哪里/图片介绍/参观预约/旅游游览顺序攻略及注意事项/营业时间...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=BZf9SMVvuaZ5jYo-q5bgVgmU5NAIorixCJy_azkoSxrWYizZBW-5vxWIGUh7yB06toHIoSLAfXfFpRMws7EU2RcPy0i8GxKIpA-COjD0avu&#x27;&#125;]&#125;, tool_call_id=&#x27;call_a54628c0496f47379e4241&#x27;)]</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 3]</span><br><span class="line"> 运动场地顾问: 经过搜索，我找到了丰台区体育中心的一些联系方式和官 方网站链接，希望这些信息能帮助您获取飞跃体育场的详细信息：        </span><br><span class="line"></span><br><span class="line">1. **官方网站**：</span><br><span class="line">   - [北京市丰台区人民政府网站](http://www.bjft.gov.cn/)</span><br><span class="line">   - 在该网站上，您可以找到有关丰台区体育中心的最新公告和服务信息 。</span><br><span class="line"></span><br><span class="line">2. **联系电话**：</span><br><span class="line">   - 丰台区社会体育管理中心：010-83656286</span><br><span class="line">   - 请注意，此电话号码为丰台区社会体育管理中心的办公电话，您可以 尝试联系他们获取飞跃体育场的相关信息。</span><br><span class="line"></span><br><span class="line">3. **其他联系方式**：</span><br><span class="line">   - 如果您需要更详细的联系方式或其他服务信息，建议您访问丰台区人 民政府网站并查找相关部门的联系方式。</span><br><span class="line"></span><br><span class="line">希望这些信息能够帮助您顺利联系到丰台区体育中心并获取所需的详细信息。如果有任何其他问题或需要进一步的帮助，请随时告诉我。Next request.</span><br><span class="line"> 需求分析师: Instruction: 联系丰台区体育中心以获取飞跃体育场的详细信息。</span><br><span class="line">Input: 请提供丰台区体育中心的联系电话或官方网站链接。</span><br><span class="line"> 工具调用: [ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;丰台区体育中心 联系电话 官方网站&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27;机构设置-北京市丰台区人民政府网站&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=4G9qsOu7HYAi3uWQkSDJm5f6tnUhnvVF3XbIf9-B6g1MkFa7JYy5HrpLTVOfZTEYos82wwl34NnYObAEoa_F37t03piFt5fkbmMqJUuiiZ6Ovl91hgZR4wYNwNlnlga-&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;2023年北京丰台区社会体育管理中心预算 情况说明-北京市丰台区人民...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=_93EAKcIENWGoM8gceqeK5wLqYZH6HJ8Df9VScIKQMGHHT42b4pMrFw9wLxicUQFdnaBMn9S_QHnS_H9RNjtfzoQFHGF3TuOVZ9kjMmppCgpBP2DoGPYbll9i_IejCKb&#x27;&#125;, &#123;&#x27;result_id&#x27;: 3, &#x27;title&#x27;: &#x27;联系我们&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=i0Ftqkwp8Rr-pIiA77ty60ReP0jvonrI6kXYB8BAhm-y0C1ta71m28mEA6Le0DSijXPzIu7j2SA2v_Xj7bGKeK&#x27;&#125;, &#123;&#x27;result_id&#x27;: 4, &#x27;title&#x27;: &#x27;丰台区政务服务掌上办事大厅&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=eBfksjwJrc7froN5pvOVvDUXiRQQJ0_u3Uhkvxc0N8edELWBYa8VEswb7wt4V8OOi_Vj9Ab-bV3GTnfekzGC-K&#x27;&#125;, &#123;&#x27;result_id&#x27;: 5, &#x27;title&#x27;: &#x27;丰台区政务服务掌上办事大 厅&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=_93EAKcIENWGoM8gceqeKulOrmuy5KLbijvbg9C1puThVHD3IlL69xUMoG1rTLU-bxGN4noe8XkSG8QD2zqmDa&#x27;&#125;]&#125;, tool_call_id=&#x27;call_612fc354b8884974b31974&#x27;)]</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 4]</span><br><span class="line"> 运动场地顾问: 根据目前提供的信息，您已经获得了丰台区体育中心的联 系电话和官方网站链接，这些应该可以帮助您进一步了解飞跃体育场的具体信息，包括开放时间、费用、设施情况等。</span><br><span class="line"></span><br><span class="line">如果您还需要其他方面的帮助或有更多具体的问题，请随时告诉我。例如，如果您需要了解其他运动场馆的信息，或者需要关于如何前往这些场馆的交通建议等，我都可以为您提供帮助。</span><br><span class="line"></span><br><span class="line">请问您是否还需要进一步的信息或帮助？如果没有其他需求，我们将完成本次任务。Next request.</span><br><span class="line"> 需求分析师: Instruction: 确认是否还需要进一步的信息或帮助。      </span><br><span class="line">Input: None</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 5]</span><br><span class="line"> 运动场地顾问: 如果您对目前提供的信息感到满意，并且没有其他具体的 需求或问题，那么我们的任务就可以告一段落了。我已经提供了丰台区体育中心的联系电话和官方网站链接，这应该足以帮助您获取飞跃体育场的详细信息。</span><br><span class="line"></span><br><span class="line">如果您在未来有任何新的需求或遇到任何问题，无论是关于运动场馆的推荐还是其他方面的问题，都欢迎随时向我咨询。</span><br><span class="line"></span><br><span class="line">如果您现在没有其他需求，我们可以结束这次任务。请告诉我您的决定。Next request.</span><br><span class="line"> 需求分析师: Instruction: 确认是否需要进一步的信息或帮助。        </span><br><span class="line">Input: None</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 6]</span><br><span class="line"> 运动场地顾问: 根据您的反馈，如果您对目前提供的信息感到满意，并且 没有其他具体的需求或问题，那么我们就可以结束这次任务了。</span><br><span class="line"></span><br><span class="line">如果您确定不再需要进一步的信息或帮助，请明确告知，我们将正式结束本次任务。如果您还有任何疑问或需要进一步的帮助，请随时告诉我。      </span><br><span class="line"></span><br><span class="line">请问您是否可以确认结束本次任务？Next request.</span><br><span class="line"> 需求分析师: Instruction: 确认是否可以结束任务。</span><br><span class="line">Input: None</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 7]</span><br><span class="line"> 运动场地顾问: 感谢您的确认！如果您将来有任何其他需求或问题，无论 是关于运动场馆的推荐还是其他方面的问题，都欢迎随时向我咨询。祝您一切顺利，享受愉快的运动体验！</span><br><span class="line"></span><br><span class="line">如果需要再次合作，随时欢迎回来。再见！</span><br><span class="line"> 需求分析师: &lt;CAMEL_TASK_DONE&gt;</span><br><span class="line"> 任务成功完成!</span><br><span class="line"></span><br><span class="line"> 对话已保存到记忆系统</span><br><span class="line"> 运动场馆推荐完成！</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line"> ChatHistoryBlock记忆分析:</span><br><span class="line">============================================================      </span><br><span class="line"> 总共处理了 1 个用户请求</span><br><span class="line"> 总共提供了 1 个推荐方案</span><br><span class="line"> 用户运动偏好统计: &#123;&#x27;跑步&#x27;: 1&#125;</span><br><span class="line"></span><br><span class="line"> 最近的记录（权重衰减机制）:</span><br><span class="line">记录1: User</span><br><span class="line">内容: 大家好，我是一名48岁的白领，目前居住在北京市丰台区丰台街道。由于工作压力大，长时间坐在办公室里，我意识到保持身体健康的重要性。因此，我希望能够在业余时间多参与一些体育活动，尤其是我喜欢的跑步。</span><br><span class="line"></span><br><span class="line">理想情况下，我希望能够找到一个设施齐全、环境舒适的运动场馆，最好是能够提供专业的跑道，让我可以在安全的...</span><br><span class="line">权重: 0.810</span><br><span class="line">------------------------------</span><br><span class="line">记录2: SportsConsultant</span><br><span class="line">内容: 感谢您的确认！如果您将来有任何其他需求或问题，无论是关于运动场馆的推荐还是其他方面的问题，都欢迎随时向我咨询。祝您一切顺利，享受愉快的运动体验！</span><br><span class="line"></span><br><span class="line">如果需要再次合作，随时欢迎回来。再见！...</span><br><span class="line">权重: 0.900</span><br><span class="line">------------------------------</span><br><span class="line">============================================================      </span><br><span class="line"></span><br><span class="line"> 第二次推荐 - 基于历史记录的智能推荐</span><br><span class="line">============================================================      </span><br><span class="line"></span><br><span class="line"> AI运动场馆推荐系统启动（RolePlaying模式）</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">🏃 随机生成用户运动需求案例：</span><br><span class="line">年龄：36-45岁</span><br><span class="line">职业：销售</span><br><span class="line">运动偏好：跑步</span><br><span class="line">特殊需求：适合家庭活动</span><br><span class="line">所在位置：北京市西城区金融街街道</span><br><span class="line">--------------------------------------------------</span><br><span class="line"></span><br><span class="line"> AI用户的自述：</span><br><span class="line">大家好，我是一名居住在北京西城区金融街街道的销售经理，今年38岁。由于工作性质的原因，我经常需要出差，但即便如此，我还是尽量保持健康的生活方式。我喜欢跑步，觉得这不仅能让我放松心情，还能保持良好的身体状态。</span><br><span class="line"></span><br><span class="line">最近，随着孩子的成长，我也希望能找到一些适合全家一起参与的活动。因此，我想寻找一个既适合成人跑步，又能提供一些儿童友好设施的运动场所。最好是能够在一个安全舒适的环境中，让我们一家人可以共同享受运动的乐趣。</span><br><span class="line"></span><br><span class="line">对于运动场馆的选择，我希望它能够满足以下几个条件：</span><br><span class="line">1. 场馆内有专业的跑道，最好是有室内和室外两种选择，这样无论天气如 何，我们都能保证运动的时间；</span><br><span class="line">2. 除了跑步，场馆还能提供一些适合孩子玩乐的设施，比如儿童游乐区或 是小型篮球场等，这样大人小孩都能找到自己喜欢的项目；</span><br><span class="line">3. 场馆的交通便利，最好能步行到达或者靠近地铁站，方便我们出行；   </span><br><span class="line">4. 如果场馆周围有好的餐饮服务就更好了，运动后可以直接在那里补充能 量。</span><br><span class="line"></span><br><span class="line">关于预算方面，我希望能够控制在每月不超过1000元人民币的范围内。至于时间，周末是我们最有可能全家出动的时间段，所以如果场地在周末有优惠活动会更加理想。</span><br><span class="line"></span><br><span class="line">如果有符合上述条件的运动场馆推荐，欢迎告诉我！谢谢大家。</span><br><span class="line">--------------------------------------------------</span><br><span class="line"> 助手角色: BaseMessage(role_name=&#x27;个性化运动场地顾问&#x27;, role_type=&lt;RoleType.ASSISTANT: &#x27;assistant&#x27;&gt;, meta_dict=&#123;&#x27;task&#x27;: &#x27;根据用户需求，需在北京西城区金融街附近寻找一个拥有专业跑道、儿童游乐设施、交通便利且预算合理的运动场馆，最好周末有优惠。请使用地图搜索功能，结合用户喜好与家庭需求，精选推荐。&#x27;, &#x27;assistant_role&#x27;: &#x27;个性化运动场地顾问&#x27;, &#x27;user_role&#x27;: &#x27;运动场馆推荐需求分析师&#x27;&#125;, content=&#x27;===== RULES OF ASSISTANT =====\nNever forget you are a 个性化运动场地顾问 and I am a 运动场馆推荐需求分析师. Never flip roles! Never instruct me!\nWe share a common interest in collaborating to successfully complete a task.\nYou must help me to complete the task.\nHere is the task: 根据用户需求，需在北京西城区金融街附近寻找一个拥有专业跑 道、儿童游乐设施、交通便利且预算合理的运动场馆，最好周末有优惠。请使用地图搜索功能，结合用户喜好与家庭需求，精选推荐。. Never forget our task!\nI must instruct you based on your expertise and my needs to complete the task.\n\nI must give you one instruction at a time.\nYou must write a specific solution that appropriately solves the requested instruction and explain your solutions.\nYou must decline my instruction honestly if you cannot perform the instruction due to physical, moral, legal reasons or your capability and explain the reasons.\nUnless I say the task is completed, you should always start with:\n\nSolution: &lt;YOUR_SOLUTION&gt;\n\n&lt;YOUR_SOLUTION&gt; should be very specific, include detailed explanations and provide preferable detailed implementations and examples and lists for task-solving.\nAlways end &lt;YOUR_SOLUTION&gt; with: Next request.\nRegardless of the input language, you must output text in 中文.&#x27;, video_bytes=None, image_list=None, image_detail=&#x27;auto&#x27;, video_detail=&#x27;auto&#x27;, parsed=None)</span><br><span class="line"> 用户角色: BaseMessage(role_name=&#x27;运动场馆推荐需求分析师&#x27;, role_type=&lt;RoleType.USER: &#x27;user&#x27;&gt;, meta_dict=&#123;&#x27;task&#x27;: &#x27;根据用户需求，需在北京西城区金融街附近寻找一个拥有专业跑道、儿童游乐设施、交通便利且预算合理的运动场馆，最好周末有优惠。请使用地图搜索功能，结合用户喜好与家庭需求，精选推荐。&#x27;, &#x27;assistant_role&#x27;: &#x27;个性化运动场地顾问&#x27;, &#x27;user_role&#x27;: &#x27;运动场馆推荐需求分析师&#x27;&#125;, content=&#x27;===== RULES OF USER =====\nNever forget you are a 运动场馆推荐需求分析师 and I am a 个性化运动场地顾问. Never flip roles! You will always instruct me.\nWe share a common interest in collaborating to successfully complete a task.\nI must help you to complete the task.\nHere is the task: 根据用户需求，需在北京西城区金融街附近寻找一个拥有专业跑道 、儿童游乐设施、交通便利且预算合理的运动场馆，最好周末有优惠。请使用地图搜索功能，结合用户喜好与家庭需求，精选推荐。. Never forget our task!\nYou must instruct me based on my expertise and your needs to solve the task ONLY in the following two ways:\n\n1. Instruct with a necessary input:\nInstruction: &lt;YOUR_INSTRUCTION&gt;\nInput: &lt;YOUR_INPUT&gt;\n\n2. Instruct without any input:\nInstruction: &lt;YOUR_INSTRUCTION&gt;\nInput: None\n\nThe &quot;Instruction&quot; describes a task or question. The paired &quot;Input&quot; provides further context or information for the requested &quot;Instruction&quot;.\n\nYou must give me one instruction at a time.\nI must write a response that appropriately solves the requested instruction.\nI must decline your instruction honestly if I cannot perform the instruction due to physical, moral, legal reasons or my capability and explain the reasons.\nYou should instruct me not ask me questions.\nNow you must start to instruct me using the two ways described above.\nDo not add anything else other than your instruction and the optional corresponding input!\nKeep giving me instructions and necessary inputs until you think the task is completed.\nWhen the task is completed, you must only reply with a single word &lt;CAMEL_TASK_DONE&gt;.\nNever say &lt;CAMEL_TASK_DONE&gt; unless my responses have solved your task.\nRegardless of the input language, you must output text in 中文.&#x27;, video_bytes=None, image_list=None, image_detail=&#x27;auto&#x27;, video_detail=&#x27;auto&#x27;, parsed=None)</span><br><span class="line"> 任务:</span><br><span class="line">        作为个性化运动场地顾问，请为用户提供专业的运动场馆推荐。  </span><br><span class="line"></span><br><span class="line">        用户需求: 大家好，我是一名居住在北京西城区金融街街道的销售经理，今年38岁。由于工作性质的原因，我经常需要出差，但即便如此，我还是尽量保持健康的生活方式。我喜欢跑步，觉得这不仅能让我放松心情，还能保持良好的身体状态。</span><br><span class="line"></span><br><span class="line">最近，随着孩子的成长，我也希望能找到一些适合全家一起参与的活动。因此...</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">[轮次 1]</span><br><span class="line"> 运动场地顾问: 根据百度搜索的结果，我找到了一些可能符合您要求的运 动场馆信息，但没有直接找到完全匹配的场馆。不过，这里有几个选项可能会对您有所帮助：</span><br><span class="line"></span><br><span class="line">1. **北京市西城区人民政府** - 这个链接可能提供了一些关于西城区体育设施的信息，您可以访问 [该网站](http://www.baidu.com/link?url=0IV25vOoT16_6zJDTsusop3t1ar5eDfJsstNpBiOxCbSy8Vw6ZyKESoLAj2Mws7Wf2XaXDCkB23VEZ4stHxYK_) 查看是否有相关的运动场馆介绍。</span><br><span class="line"></span><br><span class="line">2. **全龄参与!社区“飞超”,今天火热开赛** - 这篇文章提到了一个在社区内举办的活动，也许可以联系组织者了解更多有关社区内的运动设施信息。您可以访问 [这篇文章](http://www.baidu.com/link?url=po5MHFE8RuPqJXQSKteKTYhlVBm2v6-5RpRhYCAPn3h0RnEkJumwECjUj3sNj9IH5ulYTnGvvS7zXnu87oq7n-lBShqHc1jpVY_cP4fcdO3) 获取更多信息。</span><br><span class="line"></span><br><span class="line">3. **海淀区信息公开大厅** - 虽然这不是西城区的信息，但是这里也提供了一些公共设施的公开信息，可能对您选择运动场所有一定的参考价值。您可以访问 [该页面](http://www.baidu.com/link?url=kekghF1R2HEMtqe9hR-ZeSARvK7y5JatolqBOflDB1lo2-qM9V-zMa-NcHN1SfT_5KvY0iHghprWMoxeSHCBRR_dNf4GaDvB6B2yeRr-CG-HPNpZfpEuu0UpwksMuex4ayapFFgiH9BeFc-_47lTIgC6UciJ0kZV9Jifgp05h33) 查看是否有类似的服务或设施。</span><br><span class="line"></span><br><span class="line">为了更准确地满足您的需求，建议直接联系西城区政府或者附近的社区中心，询问是否有所需的运动场馆。同时，也可以考虑使用专业的地图服务（如高德地图或百度地图）来搜索附近的运动场所，这些平台通常会有更加详细和实时的信息。如果您需要帮助进行进一步的搜索，请告诉我！</span><br><span class="line">Next request.</span><br><span class="line"> 需求分析师: Instruction: 使用地图搜索功能，在北京西城区金融街附近查找拥有专业跑道和儿童游乐设施的运动场馆。</span><br><span class="line">Input: None</span><br><span class="line"> 工具调用: [ToolCallingRecord(tool_name=&#x27;search_google&#x27;, args=&#123;&#x27;query&#x27;: &#x27;北京西城区金融街附近拥有专业跑道和儿童游乐设施的运动场馆&#x27;, &#x27;num_result_pages&#x27;: 1&#125;, result=[&#123;&#x27;error&#x27;: &#x27;google search failed.&#x27;&#125;], tool_call_id=&#x27;call_2038ed3b82674d6da84dc3&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;北京西城区金融街附近拥有专业跑道和儿童游乐设施的运动场馆&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27;北京西城:全龄参与!社区“飞超”6日火热开赛&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=po5MHFE8RuPqJXQSKteKTYhlVBm2v6-5RpRhYCAPn3g6XdszCjVMSm0wDXcZUZhu9ORXXzBbqkjgrYV0V45KhkT01MZ7slwkvClOBMu5zRC&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;北京市西城区人民政府&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=0IV25vOoT16_6zJDTsusop3t1ar5eDfJsstNpBiOxCbSy8Vw6ZyKESoLAj2Mws7Wf2XaXDCkB23VEZ4stHxYK_&#x27;&#125;, &#123;&#x27;result_id&#x27;: 3, &#x27;title&#x27;: &#x27;北京市西城区人民政府&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=1qt8khYIO0yws3Lffk496ACJjF1QL3L9BNjT34-bX_RIPKg27TeWgN_ejsmejQGFjl4CHkyB-1wdhBKeRa9FHa&#x27;&#125;, &#123;&#x27;result_id&#x27;: 4, &#x27;title&#x27;: &#x27;全龄参与!社区“飞超”,今天火热开赛&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=po5MHFE8RuPqJXQSKteKTYhlVBm2v6-5RpRhYCAPn3h0RnEkJumwECjUj3sNj9IH5ulYTnGvvS7zXnu87oq7n-lBShqHc1jpVY_cP4fcdO3&#x27;&#125;, &#123;&#x27;result_id&#x27;: 5, &#x27;title&#x27;: &#x27;海淀区信息公开大厅&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=kekghF1R2HEMtqe9hR-ZeSARvK7y5JatolqBOflDB1lo2-qM9V-zMa-NcHN1SfT_5KvY0iHghprWMoxeSHCBRR_dNf4GaDvB6B2yeRr-CG-HPNpZfpEuu0UpwksMuex4ayapFFgiH9BeFc-_47lTIgC6UciJ0kZV9Jifgp05h33&#x27;&#125;]&#125;, tool_call_id=&#x27;call_6f93c9b7eedc47a2905e82&#x27;)]</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 2]</span><br><span class="line"> 运动场地顾问: 通过百度地图的搜索结果，我找到了几个可能符合您需求 的运动场馆：</span><br><span class="line"></span><br><span class="line">1. **悦动体能运动馆(金融街店)**：</span><br><span class="line">   - **地址**：北京市西城区金融大街</span><br><span class="line">   - **特点**：这家运动馆配备了专业的跑道和儿童游乐设施，适合家庭 成员一起锻炼和娱乐。</span><br><span class="line">   - **联系方式**：您可以点击 [这里](http://www.baidu.com/link?url=ufvr2UK86pXXrYQ-mtzYocEjmzbPWGXB719tfFeeXknGa21wi0m5RI3Axq_JTO8jCaqPaDgep2RiQnIZqwrtMa) 获取更多详细信息和联系电话。</span><br><span class="line"></span><br><span class="line">2. **西单体育游园**：</span><br><span class="line">   - **地址**：北京市西城区西单北大街</span><br><span class="line">   - **特点**：这个公园不仅有户外跑步道，还有专门为儿童设计的游乐 设施，是一个适合全家人的休闲好去处。</span><br><span class="line">   - **门票**：免费或有特定活动时收费，具体信息可以点击 [这里](http://www.baidu.com/link?url=Z_fpAvzfSM8fFmqkbABmtnrrgWsqWtcoEOrKgFVPQzzNt__ACFi_qC4jDMbp9SDQBYrhtF3ZWNy8x8HtgmkZxyYSJIq9qHxw_akPO04n6gC) 查看。</span><br><span class="line"></span><br><span class="line">这两个地点都位于北京西城区金融街附近，交通便利，非常适合您的需求。特别是悦动体能运动馆，它不仅提供了专业的运动设施，还特别照顾到了儿童的需求，是一个不错的选择。</span><br><span class="line"></span><br><span class="line">如果您需要更多详细信息或有其他需求，请随时告知！</span><br><span class="line">Next request.</span><br><span class="line"> 需求分析师: Instruction: 请使用高德地图或百度地图，具体查找位于北京西城区金融街附近的运动场馆，特别关注那些配备专业跑道和儿童游乐设施的场所。</span><br><span class="line">Input: None</span><br><span class="line"> 工具调用: [ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;北京西城区金融街附近运动场馆 专业跑道 儿童游乐设施&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27;【悦动 体能运动馆(金融街店)】悦动体能运动馆(金融街店)电话,悦动...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=ufvr2UK86pXXrYQ-mtzYocEjmzbPWGXB719tfFeeXknGa21wi0m5RI3Axq_JTO8jCaqPaDgep2RiQnIZqwrtMa&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;北京西单体育游园游玩攻略-西单体育游园门票多少钱/价格表-团购...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=Z_fpAvzfSM8fFmqkbABmtnrrgWsqWtcoEOrKgFVPQzzNt__ACFi_qC4jDMbp9SDQBYrhtF3ZWNy8x8HtgmkZxyYSJIq9qHxw_akPO04n6gC&#x27;&#125;]&#125;, tool_call_id=&#x27;call_7907b37e868f4616bc364a&#x27;)]</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 3]</span><br><span class="line"> 运动场地顾问: 根据搜索结果，以下是关于悦动体能运动馆(金融街店)和 西单体育游园的周末优惠信息：</span><br><span class="line"></span><br><span class="line">### 悦动体能运动馆(金融街店)</span><br><span class="line">1. **抖音团购优惠**：</span><br><span class="line">   - **内容**：悦动健身俱乐部在抖音上推出了多种团购优惠，包括局部 肌肉放松处理等项目。</span><br><span class="line">   - **详情**：您可以点击 [这里](http://www.baidu.com/link?url=KND8gfkNhkLAGFTsDYzWbfCuX4RldJXsk2Vx0lQdUsZquG_xMlrQ-Q2Tz_4nSYnALbdy32JM0Yc2Ll7Y8zZ_9_) 查看具体的优惠项目和价格。</span><br><span class="line"></span><br><span class="line">2. **特惠体验票**：</span><br><span class="line">   - **内容**：特惠1元秒杀悦动健身会所体验票，包含国标泳池畅游等项目。</span><br><span class="line">   - **详情**：您可以点击 [这里](http://www.baidu.com/link?url=Y4hwzBoXjFOMqKd9GpAOV99gwhJGAGxcl6e29L2G9_zMN-hoyCirpxy_jU7yfaU77Pr2iavi63ey8eH6_PNAG_) 获取更多信息。</span><br><span class="line"></span><br><span class="line">### 西单体育游园</span><br><span class="line">1. **门票优惠**：</span><br><span class="line">   - **内容**：西单体育游园的门票在某些平台上可能有团购优惠。     </span><br><span class="line">   - **详情**：您可以点击 [这里](http://www.baidu.com/link?url=BPsb1MuXCeqP7ea786TuOqAXkwFg6FbShNc7fJgvdtSw05WMn51JzX2BPrBTG-gGkEOyRb4h9giuxkm_bdnY18NG0ByNmf2EqYlhxGxWG0K) 查看具体的优惠信息和购票方式。</span><br><span class="line"></span><br><span class="line">2. **其他活动**：</span><br><span class="line">   - **内容**：虽然没有明确提到周末的特定优惠，但西单体育游园经常 举办各种活动，您可以关注其官方网站或社交媒体账号获取最新信息。    </span><br><span class="line">   - **详情**：您可以点击 [这里](http://www.baidu.com/link?url=9QLVfQ_zTvdxJXhQ0O5NGgkPIKOSeovSe7yBHGBnbBFevIAysydeQ1-Ga07cermiH0wHj3PYgKp4BMsyaQcDST0l93KODzwZ7yIaqWIHh8697W_py-KuR6GXCzdgGwIH) 查看 更多相关信息。</span><br><span class="line"></span><br><span class="line">### 总结</span><br><span class="line">- **悦动体能运动馆(金融街店)**：通过抖音和特惠体验票的方式提供周末优惠，您可以点击相关链接查看具体优惠内容。</span><br><span class="line">- **西单体育游园**：门票在某些平台上可能有团购优惠，建议关注其官方网站或社交媒体获取最新活动信息。</span><br><span class="line"></span><br><span class="line">如果您需要更多详细信息或有其他需求，请随时告知！</span><br><span class="line">Next request.</span><br><span class="line"> 需求分析师: Instruction: 请确认悦动体能运动馆(金融街店)和西单体育游园的周末是否有优惠活动，并提供具体的优惠信息。</span><br><span class="line">Input: None</span><br><span class="line"> 工具调用: [ToolCallingRecord(tool_name=&#x27;search_google&#x27;, args=&#123;&#x27;query&#x27;: &#x27;悦动体能运动馆(金融街店) 周末优惠&#x27;, &#x27;num_result_pages&#x27;: 1&#125;, result=[&#123;&#x27;error&#x27;: &#x27;google search failed.&#x27;&#125;], tool_call_id=&#x27;call_6cc96e83c53247ad89f614&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;悦动体能运动馆(金融街店) 周末优惠&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27;悦动健身俱 乐部,热销团购,不容错过,局部肌肉放松处理,随时退 - 抖音&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=KND8gfkNhkLAGFTsDYzWbfCuX4RldJXsk2Vx0lQdUsZquG_xMlrQ-Q2Tz_4nSYnALbdy32JM0Yc2Ll7Y8zZ_9_&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;一起去50米的国标泳池畅快游泳!特惠1元秒杀悦动健身会所体验票!游泳...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=Y4hwzBoXjFOMqKd9GpAOV99gwhJGAGxcl6e29L2G9_zMN-hoyCirpxy_jU7yfaU77Pr2iavi63ey8eH6_PNAG_&#x27;&#125;, &#123;&#x27;result_id&#x27;: 3, &#x27;title&#x27;: &#x27;超鹿运动团购怎么用 - 抖音&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=Dqn_VukCNrkFqN8tp2ycvH1NgLH1xcnSBfCQO3aVs5ngEr52hpVsqImvK5FE2urMk9AS9PVDexa1Dyzz6EYPJa&#x27;&#125;, &#123;&#x27;result_id&#x27;: 4, &#x27;title&#x27;: &#x27;大众点评网&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=8S_n3ErGxmr-4_330oSDRR6114rQjc2ACb3a5jEy_2F--WY9TGpm9xWZ2q8f3EZ0&#x27;&#125;, &#123;&#x27;result_id&#x27;: 5, &#x27;title&#x27;: &#x27;【携程攻略】携程旅游攻略,自助游,自驾游,出游,自由行攻略指南&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=-K8_tFl8LfGuN---6CXoIiZplEfoWfSr4XZHeIW022QDm8a-zYM3pHPULfQfiretksW4FQ0XLer1ZBNMfn0ziK&#x27;&#125;]&#125;, tool_call_id=&#x27;call_c1aba338450742988beff5&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;西单体育游园 周末优惠&#x27;, &#x27;max_results&#x27;: 5&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;title&#x27;: &#x27;...西单体育游园门票多少钱/价格表-团购票价预定优惠-景点地址在...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=BPsb1MuXCeqP7ea786TuOqAXkwFg6FbShNc7fJgvdtSw05WMn51JzX2BPrBTG-gGkEOyRb4h9giuxkm_bdnY18NG0ByNmf2EqYlhxGxWG0K&#x27;&#125;, &#123;&#x27;result_id&#x27;: 2, &#x27;title&#x27;: &#x27;北京市体育局 北京市文化和旅游局关于命名2024年北京市体育旅游...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=9QLVfQ_zTvdxJXhQ0O5NGgkPIKOSeovSe7yBHGBnbBFevIAysydeQ1-Ga07cermiH0wHj3PYgKp4BMsyaQcDST0l93KODzwZ7yIaqWIHh8697W_py-KuR6GXCzdgGwIH&#x27;&#125;, &#123;&#x27;result_id&#x27;: 3, &#x27;title&#x27;: &#x27;奥运赛事正酣,一起来“这里”运动打卡!&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=oLYN82_ae0EAYe4SQ8K6Ekp2KdH2NoBNiuUj_NEA4CdN9xQRjvf37pNTlIpvzwlDfo-P1kNl9vmszpuLDTiCrid8CCQv1O7henv0NxUgsdTOIjoGV0btWSdFvljI5Anm36ipfSbSpqSKdi6QTr-_KwXkol9CBZ6gZsvZmXthAc_Cgan_bARMEcCJq_KXMSXQQMSd25o7SY3oDy1betP-hZnfLDlAGXeojJay9Pxf23rPXnq1u_3km8BpUh0zfgctBorN0wEyR8hgNTJn39xd0_&#x27;&#125;, &#123;&#x27;result_id&#x27;: 4, &#x27;title&#x27;: &#x27;西单一日游攻略,逛吃逛喝不停歇&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=uATwgXfMql9W2mQpi9DoXyyKrNVIAwFdwJXmPXmteL3FcL5HlBMAY4LdWYooiBK147qhZpEk8fhnAH2eVddysEHjyC6gujMW-cUDL1jBbar1dAg74Frh97YgRH7uw7s9&#x27;&#125;, &#123;&#x27;result_id&#x27;: 5, &#x27;title&#x27;: &#x27;... 常营体育公园-西园门票多少钱/价格表-团购票价预定优惠-景点...&#x27;, &#x27;description&#x27;: &#x27;&#x27;, &#x27;url&#x27;: &#x27;http://www.baidu.com/link?url=BPsb1MuXCeqP7ea786TuOqAXkwFg6FbShNc7fJgvdtSw05WMn51JzX2BPrBTG-gGkEOyRb4h9giuxkm_bdnY1ymGtcOheoLhWaeKzsuHLDq&#x27;&#125;]&#125;, tool_call_id=&#x27;call_789c5ae0b1814154bee529&#x27;)]</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 4]</span><br><span class="line"> 运动场地顾问: ### 悦动体能运动馆(金融街店) 交通便利性</span><br><span class="line"></span><br><span class="line">1. **最近的地铁站**：</span><br><span class="line">   - **金融街站**：乘坐地铁2号线或4号线，从金融街站下车，步行约5分钟即可到达。</span><br><span class="line">   - **复兴门站**：乘坐地铁1号线或2号线，从复兴门站下车，步行约10 分钟即可到达。</span><br><span class="line"></span><br><span class="line">2. **公交线路**：</span><br><span class="line">   - **公交线路**：多条公交线路途经金融街，例如105路、109路、662路等，均可在金融街站下车。</span><br><span class="line"></span><br><span class="line">### 西单体育游园 交通便利性</span><br><span class="line"></span><br><span class="line">1. **最近的地铁站**：</span><br><span class="line">   - **西单站**：乘坐地铁1号线或4号线，从西单站下车，步行约5分钟即可到达。</span><br><span class="line">   - **复兴门站**：乘坐地铁1号线或2号线，从复兴门站下车，步行约15 分钟即可到达。</span><br><span class="line"></span><br><span class="line">2. **公交线路**：</span><br><span class="line">   - **公交线路**：多条公交线路途经西单，例如102路、105路、109路、662路等，均可在西单北大街站下车。</span><br><span class="line"></span><br><span class="line">### 总结</span><br><span class="line"></span><br><span class="line">- **悦动体能运动馆(金融街店)**：最近的地铁站是金融街站和复兴门站，多条公交线路途经金融街，交通非常便利。</span><br><span class="line">- **西单体育游园**：最近的地铁站是西单站和复兴门站，多条公交线路途经西单，交通也非常便利。</span><br><span class="line"></span><br><span class="line">如果您需要更多详细信息或有其他需求，请随时告知！</span><br><span class="line">Next request.</span><br><span class="line"> 需求分析师: Instruction: 确认悦动体能运动馆(金融街店)和西单体育游园的交通便利性，包括最近的地铁站和公交线路。</span><br><span class="line">Input: None</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 5]</span><br><span class="line"> 运动场地顾问: ### 综合评估与推荐意见</span><br><span class="line"></span><br><span class="line">#### 悦动体能运动馆(金融街店)</span><br><span class="line"></span><br><span class="line">**优点**：</span><br><span class="line">1. **专业设施**：配备了专业的跑道和儿童游乐设施，适合家庭成员一起 锻炼和娱乐。</span><br><span class="line">2. **周末优惠**：通过抖音和特惠体验票的方式提供周末优惠，如局部肌 肉放松处理、国标泳池畅游等项目。</span><br><span class="line">3. **交通便利**：最近的地铁站是金融街站和复兴门站，多条公交线路途 经金融街，交通非常便利。</span><br><span class="line"></span><br><span class="line">**缺点**：</span><br><span class="line">1. **费用**：虽然有周末优惠，但整体费用可能相对较高。</span><br><span class="line">2. **人群密度**：作为商业运动馆，周末人流量可能较大，影响锻炼体验 。</span><br><span class="line"></span><br><span class="line">#### 西单体育游园</span><br><span class="line"></span><br><span class="line">**优点**：</span><br><span class="line">1. **户外环境**：提供户外跑步道和儿童游乐设施，适合家庭成员在自然 环境中活动。</span><br><span class="line">2. **免费或低价**：门票免费或有特定活动时收费，经济实惠。</span><br><span class="line">3. **交通便利**：最近的地铁站是西单站和复兴门站，多条公交线路途经 西单，交通非常便利。</span><br><span class="line"></span><br><span class="line">**缺点**：</span><br><span class="line">1. **设施有限**：相比专业的运动馆，设施可能较为简单。</span><br><span class="line">2. **天气依赖**：户外活动受天气影响较大，不适合雨天或极端天气。   </span><br><span class="line"></span><br><span class="line">### 最终推荐意见</span><br><span class="line"></span><br><span class="line">根据您的需求和上述评估，我推荐以下方案：</span><br><span class="line"></span><br><span class="line">1. **如果追求专业设施和高质量服务**：</span><br><span class="line">   - **推荐**：悦动体能运动馆(金融街店)</span><br><span class="line">   - **理由**：专业的跑道和儿童游乐设施，适合家庭成员一起锻炼和娱 乐。周末有多种优惠活动，交通便利。</span><br><span class="line"></span><br><span class="line">2. **如果注重经济实惠和户外环境**：</span><br><span class="line">   - **推荐**：西单体育游园</span><br><span class="line">   - **理由**：户外跑步道和儿童游乐设施，适合家庭成员在自然环境中 活动。门票免费或有特定活动时收费，经济实惠。交通便利。</span><br><span class="line"></span><br><span class="line">### 结论</span><br><span class="line"></span><br><span class="line">如果您希望享受更专业的运动设施和服务，并不介意稍微高一点的费用，**悦动体能运动馆(金融街店)** 是更好的选择。如果您更注重经济实惠和户 外活动体验，**西单体育游园** 则更为合适。</span><br><span class="line"></span><br><span class="line">如果您需要更多详细信息或有其他需求，请随时告知！</span><br><span class="line">Next request.</span><br><span class="line"> 需求分析师: Instruction: 根据以上信息，综合评估悦动体能运动馆(金 融街店)和西单体育游园的优缺点，给出最终推荐意见。</span><br><span class="line">Input: None</span><br><span class="line">------------------------------------------------------------      </span><br><span class="line"></span><br><span class="line">[轮次 6]</span><br><span class="line"> 运动场地顾问: 很高兴能帮到您！如果您有任何其他问题或需要进一步的 帮助，请随时联系我。祝您在选择的运动场馆中度过愉快的时光！        </span><br><span class="line"></span><br><span class="line">如果您对我们的合作满意，也欢迎留下反馈。谢谢！</span><br><span class="line"> 需求分析师: &lt;CAMEL_TASK_DONE&gt;</span><br><span class="line"> 任务成功完成!</span><br><span class="line"></span><br><span class="line"> 对话已保存到记忆系统</span><br><span class="line"> 运动场馆推荐完成！</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line"> ChatHistoryBlock记忆分析:</span><br><span class="line">============================================================      </span><br><span class="line"> 总共处理了 2 个用户请求</span><br><span class="line"> 总共提供了 2 个推荐方案</span><br><span class="line"> 用户运动偏好统计: &#123;&#x27;跑步&#x27;: 2, &#x27;篮球&#x27;: 1&#125;</span><br><span class="line"></span><br><span class="line"> 最近的记录（权重衰减机制）:</span><br><span class="line">记录1: User</span><br><span class="line">内容: 大家好，我是一名48岁的白领，目前居住在北京市丰台区丰台街道。由于工作压力大，长时间坐在办公室里，我意识到保持身体健康的重要性。因此，我希望能够在业余时间多参与一些体育活动，尤其是我喜欢的跑步。</span><br><span class="line"></span><br><span class="line">理想情况下，我希望能够找到一个设施齐全、环境舒适的运动场馆，最好是能够提供专业的跑道，让我可以在安全的...</span><br><span class="line">权重: 0.656</span><br><span class="line">------------------------------</span><br><span class="line">记录2: SportsConsultant</span><br><span class="line">内容: 感谢您的确认！如果您将来有任何其他需求或问题，无论是关于运动场馆的推荐还是其他方面的问题，都欢迎随时向我咨询。祝您一切顺利，享受愉快的运动体验！</span><br><span class="line"></span><br><span class="line">如果需要再次合作，随时欢迎回来。再见！...</span><br><span class="line">权重: 0.729</span><br><span class="line">------------------------------</span><br><span class="line">记录3: User</span><br><span class="line">内容: 大家好，我是一名居住在北京西城区金融街街道的销售经理，今年38岁。由于工作性质的原因，我经常需要出差，但即便如此，我还是尽量保持健康的生活方式。我喜欢跑步，觉得这不仅能让我放松心情，还能保持良好的身体状态。</span><br><span class="line"></span><br><span class="line">最近，随着孩子的成长，我也希望能找到一些适合全家一起参与的活动。因此，我想寻找一个既适合成...</span><br><span class="line">权重: 0.810</span><br><span class="line">------------------------------</span><br><span class="line">记录4: SportsConsultant</span><br><span class="line">内容: 很高兴能帮到您！如果您有任何其他问题或需要进一步的帮助，请随时联系我。祝您在选择的运动场馆中度过愉快的时光！</span><br><span class="line"></span><br><span class="line">如果您对我们的合作满意，也欢迎留下反馈。谢谢！...</span><br><span class="line">权重: 0.900</span><br><span class="line">------------------------------</span><br><span class="line">============================================================      </span><br><span class="line"></span><br><span class="line"> 系统演示完成！</span><br><span class="line"> ChatHistoryBlock成功实现了用户需求的匹配度计算和历史记录管理     </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/15/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%882%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/15/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%882%EF%BC%89/" class="post-title-link" itemprop="url">Agent_camel框架学习记录（2）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-15 13:09:52" itemprop="dateCreated datePublished" datetime="2025-07-15T13:09:52+08:00">2025-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-20 23:33:27" itemprop="dateModified" datetime="2025-07-20T23:33:27+08:00">2025-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<h2 id="2-3-3-使用开源模型：Ollama"><a href="#2-3-3-使用开源模型：Ollama" class="headerlink" title="2.3.3 使用开源模型：Ollama"></a>2.3.3 使用开源模型：Ollama</h2><p>Ollama 是一个开源机器学习框架，专注于让用户轻松使用语言模型。它基于 <code>llama.cpp</code> 实现，支持 CPU&#x2F;GPU 推理，并兼容 OpenAI 接口。</p>
<h3 id="安装与使用-Qwen2-5"><a href="#安装与使用-Qwen2-5" class="headerlink" title="安装与使用 Qwen2.5"></a>安装与使用 Qwen2.5</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama pull qwen2.5:7b</span><br></pre></td></tr></table></figure>

<p>模型加载方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OLLAMA,</span><br><span class="line">    model_type=<span class="string">&quot;qwen2.5&quot;</span>,</span><br><span class="line">    model_config_dict=&#123;<span class="string">&quot;temperature&quot;</span>: <span class="number">0.4</span>&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>自行构建的qwen2.5:7b模型下的多行问答Agent:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OLLAMA,</span><br><span class="line">    model_type=<span class="string">&quot;qwen2.5:7b&quot;</span>,  <span class="comment"># Use the model name displayed in &#x27;ollama list&#x27;</span></span><br><span class="line">    model_config_dict=&#123;</span><br><span class="line">        <span class="string">&quot;temperature&quot;</span>: <span class="number">0.4</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    url=<span class="string">&quot;http://localhost:11434/v1/&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">agent = ChatAgent(</span><br><span class="line">    model=model,</span><br><span class="line">    output_language=<span class="string">&#x27;中文&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;与 CAMEL 代理开始对话 (输入 &#x27;退出&#x27; 结束):&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你: (输入多行内容，空行结束)&quot;</span>)</span><br><span class="line">    user_input_lines = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        line = <span class="built_in">input</span>()</span><br><span class="line">        <span class="keyword">if</span> line.lower() == <span class="string">&#x27;退出&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;对话结束。&quot;</span>)</span><br><span class="line">            sys.exit()  <span class="comment"># 完全退出程序</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line.strip():  <span class="comment"># 空行结束输入</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        user_input_lines.append(line)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> user_input_lines:  <span class="comment"># 如果有输入内容</span></span><br><span class="line">        user_input = <span class="string">&#x27;\n&#x27;</span>.join(user_input_lines)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">continue</span>  <span class="comment"># 空输入则重新开始循环</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create a BaseMessage from user input</span></span><br><span class="line">    user_msg = BaseMessage.make_user_message(</span><br><span class="line">        role_name=<span class="string">&quot;User&quot;</span>,</span><br><span class="line">        content=user_input</span><br><span class="line">    )   </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get model response</span></span><br><span class="line">    response = agent.step(user_msg)</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">and</span> response.msgs:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;代理: <span class="subst">&#123;response.msgs[<span class="number">0</span>].content&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;代理: 未收到有效回复。&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-4-3-BaseMessage-消息处理"><a href="#2-4-3-BaseMessage-消息处理" class="headerlink" title="2.4.3 BaseMessage 消息处理"></a>2.4.3 BaseMessage 消息处理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消息</span></span><br><span class="line">user_msg = BaseMessage.make_user_message(role_name=<span class="string">&quot;User_1&quot;</span>, content=<span class="string">&quot;Hi&quot;</span>)</span><br><span class="line">assistant_msg = BaseMessage.make_assistant_message(role_name=<span class="string">&quot;Assistant_1&quot;</span>, content=<span class="string">&quot;Hello!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新消息内容</span></span><br><span class="line">updated_msg = user_msg.create_new_instance(<span class="string">&quot;Hi, tell me more about CAMEL&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换为 OpenAI 消息格式</span></span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> OpenAIBackendRole</span><br><span class="line">openai_msg = user_msg.to_openai_message(role_at_backend=OpenAIBackendRole.USER)</span><br></pre></td></tr></table></figure>
<p>通过BassMessage实现Agent处理图片&#x2F;视频等多模态信息：<br>首先展示本地图片的多模态理解示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv(dotenv_path=<span class="string">&#x27;.env&#x27;</span>)  <span class="comment"># 确保.env文件存在且路径正确</span></span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)  <span class="comment"># 使用环境变量获取密钥</span></span><br><span class="line"></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-VL-72B-Instruct&quot;</span>,</span><br><span class="line">    api_key=api_key,</span><br><span class="line">    url=os.environ.get(<span class="string">&quot;OPENAI_COMPATIBILIY_API_BASE_URL&quot;</span>, <span class="string">&quot;https://api-inference.modelscope.cn/v1/&quot;</span>),  <span class="comment"># 环境变量优先，不存在则使用默认值</span></span><br><span class="line">    model_config_dict=&#123;<span class="string">&quot;temperature&quot;</span>: <span class="number">0.4</span>, <span class="string">&quot;max_tokens&quot;</span>: <span class="number">4096</span>&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化ChatAgent</span></span><br><span class="line">agent = ChatAgent(model=model,output_language=<span class="string">&#x27;中文&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地图片</span></span><br><span class="line">image_path = <span class="string">&quot;微信图片_2025-07-11_223853_723.jpg&quot;</span></span><br><span class="line">img = Image.<span class="built_in">open</span>(image_path)  <span class="comment"># 直接打开图片文件</span></span><br><span class="line"></span><br><span class="line">user_msg = BaseMessage.make_user_message(</span><br><span class="line">    role_name=<span class="string">&quot;User&quot;</span>, </span><br><span class="line">    content=<span class="string">&quot;请描述这张图片的内容&quot;</span>, </span><br><span class="line">    image_list=[img]  <span class="comment"># 使用image_list参数传入PIL.Image对象列表</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response = agent.step(user_msg)   <span class="comment"># 1. 将包含图片的用户消息发送给AI代理</span></span><br><span class="line"><span class="built_in">print</span>(response.msgs[<span class="number">0</span>].content)  <span class="comment"># 2. 打印AI代理的回复内容</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/Agent-camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%882%EF%BC%89%5C%E5%9B%BE%E7%89%87%E7%A4%BA%E4%BE%8B01.jpg" alt="图片示例"></p>
<p>以上的图片示例运行后的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/Multimodal_images.py      </span><br><span class="line">这张图片显示了一位正在打羽毛球的人。他穿着黑色的T恤和红色的短裤，脚上穿着白色的运动鞋。他的右手持着羽毛球拍，似乎在准备击球或刚刚完成一次击球动作。背景是一个室内羽毛球场地，可以看到彩色的观 众席和一些放置在地上的物品，如背包和鞋子。场地的地面是绿色的，标有白色的线条，用于划分比赛区域</span><br></pre></td></tr></table></figure>

<h2 id="2-4-4-与-ChatAgent-协作"><a href="#2-4-4-与-ChatAgent-协作" class="headerlink" title="2.4.4 与 ChatAgent 协作"></a>2.4.4 与 ChatAgent 协作</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line">chat_agent = ChatAgent(model=model, system_message=<span class="string">&quot;You are a helpful assistant&quot;</span>, output_language=<span class="string">&#x27;zh&#x27;</span>)</span><br><span class="line">response = chat_agent.step(<span class="string">&quot;介绍一下 CAMEL AI&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(response.msgs[<span class="number">0</span>].content)</span><br></pre></td></tr></table></figure>

<h2 id="2-5-3-上下文学习-ICL"><a href="#2-5-3-上下文学习-ICL" class="headerlink" title="2.5.3 上下文学习 (ICL)"></a>2.5.3 上下文学习 (ICL)</h2><p>ICL 通过上下文中的示例（Few-shot&#x2F;One-shot&#x2F;Zero-shot）指导模型生成答案。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">英文转法文任务示例：</span><br><span class="line">Translate English to French.</span><br><span class="line">apple -&gt; pomme</span><br><span class="line">car -&gt; voiture</span><br><span class="line">cat -&gt; chat</span><br><span class="line">dog -&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-4-思维链-CoT"><a href="#2-5-4-思维链-CoT" class="headerlink" title="2.5.4 思维链 (CoT)"></a>2.5.4 思维链 (CoT)</h2><p>通过逐步展示推理过程提升模型表现：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Q: Roger 有 5 个网球，他又买了 2 罐，每罐 3 个，共多少？</span><br><span class="line">A: 他有 5 + 2*3 = 11 个网球。</span><br></pre></td></tr></table></figure>

<h2 id="2-5-5-使用-CAMEL-的-Prompt"><a href="#2-5-5-使用-CAMEL-的-Prompt" class="headerlink" title="2.5.5 使用 CAMEL 的 Prompt"></a>2.5.5 使用 CAMEL 的 Prompt</h2><p>使用 TaskSpecifyAgent 创建特定任务提示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> TaskSpecifyAgent</span><br><span class="line"></span><br><span class="line">task_specify_agent = TaskSpecifyAgent(</span><br><span class="line">    model=model, task_type=TaskType.AI_SOCIETY, output_language=<span class="string">&#x27;中文&#x27;</span></span><br><span class="line">)</span><br><span class="line">response = task_specify_agent.run(</span><br><span class="line">    task_prompt=<span class="string">&quot;get promotion&quot;</span>,</span><br><span class="line">    meta_dict=<span class="built_in">dict</span>(assistant_role=<span class="string">&quot;Engineer&quot;</span>, user_role=<span class="string">&quot;Employee&quot;</span>, word_limit=<span class="number">100</span>)</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<p>使用 TextPrompt 自定义模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.prompts <span class="keyword">import</span> TextPrompt</span><br><span class="line">prompt = TextPrompt(<span class="string">&#x27;Hi &#123;name&#125;, you are &#123;age&#125; years old.&#x27;</span>)</span><br><span class="line">formatted = prompt.<span class="built_in">format</span>(name=<span class="string">&quot;John&quot;</span>, age=<span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(formatted)  <span class="comment"># Hi John, you are 30 years old.</span></span><br></pre></td></tr></table></figure>

<p>更多见官方文档：<a target="_blank" rel="noopener" href="https://github.com/camel-ai/camel">https://github.com/camel-ai/camel</a></p>
<h2 id="2-6Memory记忆系统"><a href="#2-6Memory记忆系统" class="headerlink" title="2.6Memory记忆系统"></a>2.6Memory记忆系统</h2><p>CAMEL AI 记忆系统集成操作流程</p>
<ol>
<li>理论基础<br>1.1 CAMEL 记忆存储机制</li>
</ol>
<p>Key-Value 存储: 简单键值对存储，适合结构化数据<br>Graph 存储: 图数据库存储，适合关系型数据<br>Vector 存储: 向量数据库存储，适合语义检索</p>
<p>1.2 核心数据结构</p>
<p>Chat_history: 规范化存储智能体对话记录<br>Context: 从 chat_history 中提取的上下文信息<br>权重机制: 基于重要性评分筛选关键信息</p>
<p>1.3 工作原理<br>大模型基于预测机制生成文本，通过权重筛选从历史记录中获取有效上下文，确保在 token 限制内提供最重要的信息。<br>2. 环境准备以及记忆系统构建初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.memories <span class="keyword">import</span> (</span><br><span class="line">    LongtermAgentMemory,<span class="comment">#核心记忆管理器，负责存储和检索对话历史</span></span><br><span class="line">    MemoryRecord,</span><br><span class="line">    ScoreBasedContextCreator,<span class="comment">#基于评分的上下文创建器</span></span><br><span class="line">    ChatHistoryBlock,<span class="comment">#存储聊天历史记录的数据块</span></span><br><span class="line">    VectorDBBlock,<span class="comment">#向量数据库块</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">#载入基础配置</span></span><br><span class="line"><span class="keyword">from</span> camel.messages <span class="keyword">import</span> BaseMessage</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelType, OpenAIBackendRole</span><br><span class="line"><span class="keyword">from</span> camel.utils <span class="keyword">import</span> OpenAITokenCounter</span><br><span class="line"><span class="keyword">from</span> camel.embeddings <span class="keyword">import</span> SentenceTransformerEncoder</span><br><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"></span><br><span class="line"><span class="comment">#载入环境配置</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化记忆系统</span></span><br><span class="line">memory = LongtermAgentMemory(</span><br><span class="line">    context_creator=ScoreBasedContextCreator(</span><br><span class="line">        token_counter=OpenAITokenCounter(ModelType.GPT_4O_MINI),</span><br><span class="line">        token_limit=<span class="number">1024</span>,  <span class="comment"># 使用 token 计数器限制上下文长度（1024 tokens）</span></span><br><span class="line">    ),</span><br><span class="line">    chat_history_block=ChatHistoryBlock(),  <span class="comment"># 聊天历史存储</span></span><br><span class="line">    vector_db_block=VectorDBBlock(</span><br><span class="line">        embedding=SentenceTransformerEncoder(model_name=<span class="string">&quot;BAAI/bge-m3&quot;</span>)</span><br><span class="line">    ),  <span class="comment"># 向量数据库存储，使用 BGE-M3 模型进行文本嵌入</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建记忆记录</span></span><br><span class="line">records = [</span><br><span class="line">    MemoryRecord(</span><br><span class="line">        message=BaseMessage.make_user_message(</span><br><span class="line">            role_name=<span class="string">&quot;User&quot;</span>,</span><br><span class="line">            content=<span class="string">&quot;什么是CAMEL AI?&quot;</span></span><br><span class="line">        ),</span><br><span class="line">        role_at_backend=OpenAIBackendRole.USER,</span><br><span class="line">    ),</span><br><span class="line">    MemoryRecord(</span><br><span class="line">        message=BaseMessage.make_assistant_message(</span><br><span class="line">            role_name=<span class="string">&quot;Agent&quot;</span>,</span><br><span class="line">            content=<span class="string">&quot;CAMEL-AI是第一个LLM多智能体框架,并且是一个致力于寻找智能体 scaling law 的开源社区。&quot;</span></span><br><span class="line">        ),</span><br><span class="line">        role_at_backend=OpenAIBackendRole.ASSISTANT,</span><br><span class="line">    ),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#写入记忆数据</span></span><br><span class="line">memory.write_records(records)</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证记忆系统</span></span><br><span class="line">context, token_count = memory.get_context()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;上下文: <span class="subst">&#123;context&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Token 消耗: <span class="subst">&#123;token_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###创建基础智能体</span></span><br><span class="line"><span class="comment"># 定义系统消息</span></span><br><span class="line">sys_msg = <span class="string">&quot;你是一个好奇的智能体，正在探索宇宙的奥秘。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建智能体</span></span><br><span class="line">agent = ChatAgent(system_message=sys_msg, model=model)</span><br><span class="line"></span><br><span class="line"><span class="comment">###测试无记忆状态</span></span><br><span class="line">usr_msg = <span class="string">&quot;告诉我基于我们讨论的内容，哪个是第一个LLM多智能体框架？&quot;</span></span><br><span class="line">response = agent.step(usr_msg)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;无记忆状态响应:&quot;</span>, response.msgs[<span class="number">0</span>].content)</span><br></pre></td></tr></table></figure>
<p>关键组件说明:<br>ScoreBasedContextCreator: 基于评分的上下文创建器<br>ChatHistoryBlock: 聊天记录存储块<br>VectorDBBlock: 向量数据库块，支持语义检索</p>
<ol start="3">
<li>测试无记忆状态的输出结果</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PS D:\Camel_Test_Project&gt; &amp; D:/Download/Python/py-3.11.9/python.exe d:/Camel_Test_Project/test_Memory_all.py</span><br><span class="line">W0715 11:51:47.852000 17616 site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported <span class="keyword">in</span> Windows or MacOs.</span><br><span class="line">上下文: [&#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;什么是CAMEL AI?&#x27;</span>&#125;, &#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;assistant&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;CAMEL-AI是第一个LLM多智能体框架,并且是一个致力于寻找智能体 scaling law 的开源社区。&#x27;</span>&#125;]</span><br><span class="line">Token 消耗: 52</span><br><span class="line">无记忆状态响应: 目前，关于“第一个LLM（大语言模型）多智能体框架”的确切定义和时间点可能存在一定的模糊性，因为这一领域的发展非常迅速，而且不同的项目和研究可能从不同的角度来定义“多智能体框架”。 然而，可以提到一些较早的、具有代表性的项目，它们在大语言模型与多智能体系统结合方面进行了开创性的工作。</span><br><span class="line"></span><br><span class="line"> **Multi-Agent Systems with Large Language Models (LLMs)**: 虽然很难确定一个具体的“第一”，但 可以指出的是，随着大语言模型如GPT-3等的出现，研究人员开始探索将这些模型应用于多智能体系统中。例如，2021年左右，一些研究团队开始尝试使用大语言模型作为智能体之间的通信工具，或者作为增强单个智 能体决策能力的方法。</span><br><span class="line"> **ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的方法，它利用大型预训练语言模型来促进多智能体协作。这个框架展示了如何通过自然语言处理技术让智能 体之间进行更有效的沟通与合作，被认为是该领域的早期重要贡献之一。</span><br><span class="line"> **ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的方法，它利用大型预训练语言模型来促进多智能体协作。这个框架展示了如何通过自然语言处理技术让智能 </span><br><span class="line"> **ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的</span><br><span class="line">**ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的方法，它利用大型预训练语言模型来促进多智能体协作。这个框架展示了如何通过自然语言处理技术让智能 </span><br><span class="line"> **ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的</span><br><span class="line"> **ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的方法，它利用大型预训练语言模型来促进多智能体协作。这个框架展示了如何通过自然语言处理技术让智能 体之间进行更有效的沟通与合作，被认为是该领域的早期重要贡献之一。</span><br><span class="line"> **ReAct <span class="keyword">for</span> Multi-Agent Collaboration**: 2022年，来自斯坦福大学的研究者提出了一种名为ReAct的方法，它利用大型预训练语言模型来促进多智能体协作。这个框架展示了如何通过自然语言处理技术让智能 体之间进行更有效的沟通与合作，被认为是该领域的早期重要贡献之一。</span><br><span class="line">方法，它利用大型预训练语言模型来促进多智能体协作。这个框架展示了如何通过自然语言处理技术让智能体之间进行更有效的沟通与合作，被认为是该领域的早期重要贡献之一。</span><br><span class="line"></span><br><span class="line">需要注意的是，上述信息基于当前可获得的数据，并且随着新研究的不断涌现，这一领域的先驱者可能会有 所变化。如果你有特定的研究或项目想要了解，请提供更多信息，我将尽力为你提供详细的答案。</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>记忆系统集成<br>4.1 集成记忆到智能体<br>python# 关键步骤：将记忆系统赋值给智能体<br>agent.memory &#x3D; memory<br>4.2 测试集成效果<br>python# 使用相同的问题测试<br>response &#x3D; agent.step(usr_msg)<br>print(“集成记忆后响应:”, response.msgs[0].content)</li>
</ol>
<p>5.测试结果，成功响应：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">集成记忆后响应: CAMEL-AI 是一个专注于研究和开发大规模语言模型（LLM）在多智能体系统中应用的框架 。它旨在通过构建和实验不同的多智能体交互模式，来探索和理解智能体之间的协作、竞争以及这些互动如 何影响整体系统的性能和效率。根据您的问题，CAMEL-AI 被认为是第一个LLM多智能体框架。这个框架不仅 促进了对智能体 scaling law 的研究，还为研究人员和开发者提供了一个开放平台，以测试新的算法和理论。</span><br></pre></td></tr></table></figure>

<h2 id="2-7-Tools-工具系统"><a href="#2-7-Tools-工具系统" class="headerlink" title="2.7 Tools 工具系统"></a>2.7 Tools 工具系统</h2><h3 id="2-7-1-工具说明"><a href="#2-7-1-工具说明" class="headerlink" title="2.7.1 工具说明"></a>2.7.1 工具说明</h3><p>工具（Tools）是大语言模型（LLM）与外部世界交互的桥梁。虽然 LLM 拥有强大的语言理解与生成能力，但它本质上是一个“封闭系统”，无法直接：</p>
<ul>
<li>获取实时信息（如天气、新闻）</li>
<li>访问外部数据（如数据库、文件）</li>
<li>执行具体操作（如发送邮件、控制设备）</li>
</ul>
<p>为克服这些局限，CAMEL 提供了“工具”机制，使模型能够：</p>
<ul>
<li>通过 API 获取实时数据</li>
<li>调用外部服务</li>
<li>执行特定任务</li>
<li>与其他系统交互</li>
</ul>
<blockquote>
<p>✅ 工具的本质是一个带有名称、描述、输入参数与输出类型的 <strong>函数接口</strong>。</p>
</blockquote>
<p>CAMEL 支持：</p>
<ul>
<li><strong>内置工具</strong></li>
<li><strong>自定义工具</strong></li>
<li><strong>工具包（Toolkit）</strong></li>
</ul>
<h3 id="2-7-2-动手实践"><a href="#2-7-2-动手实践" class="headerlink" title="2.7.2 动手实践"></a>2.7.2 动手实践</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.agents <span class="keyword">import</span> ChatAgent</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 ChatAgent（未配工具）</span></span><br><span class="line">agent = ChatAgent(</span><br><span class="line">    system_message=<span class="string">&quot;你是一个数学大师，擅长各种数学问题。&quot;</span>,</span><br><span class="line">    model=model,</span><br><span class="line">    output_language=<span class="string">&#x27;中文&#x27;</span>,</span><br><span class="line">    tools=[]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用户消息发送消息给agent</span></span><br><span class="line">usr_msg = <span class="string">&quot;2的平方根是多少？&quot;</span></span><br><span class="line">response = agent.step(usr_msg)</span><br><span class="line"><span class="built_in">print</span>(response.msgs[<span class="number">0</span>].content)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>输出约为：<code>2的平方根是 1.414</code></p>
</blockquote>
<p>可以看到模型给出了回答，但是精度不够。我们需要更高的精度，现在创建自定义函数工具：</p>
<p>使用<code>FunctionTool</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> FunctionTool</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_sqrt</span>(<span class="params">x: <span class="built_in">float</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">     <span class="string">r&quot;&quot;&quot;计算一个数的平方根。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        x (float): 需要计算平方根的数字。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        float: 输入数字的平方根。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> math.sqrt(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 FunctionTool 包装该函数</span></span><br><span class="line">sqrt_tool = FunctionTool(calculate_sqrt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带工具的 agent</span></span><br><span class="line">agent = ChatAgent(</span><br><span class="line">    system_message=<span class="string">&quot;你是一个数学大师，遇到数学问题你要调用工具。&quot;</span>,</span><br><span class="line">    model=model,</span><br><span class="line">    output_language=<span class="string">&#x27;中文&#x27;</span>,</span><br><span class="line">    tools=[sqrt_tool]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response = agent.step(<span class="string">&quot;2的平方根是多少？&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(response.msgs[<span class="number">0</span>].content)</span><br><span class="line"><span class="built_in">print</span>(response.info[<span class="string">&quot;tool_calls&quot;</span>])</span><br></pre></td></tr></table></figure>

<h3 id="2-7-3-进阶案例：AI-Society-工具系统"><a href="#2-7-3-进阶案例：AI-Society-工具系统" class="headerlink" title="2.7.3 进阶案例：AI Society + 工具系统"></a>2.7.3 进阶案例：AI Society + 工具系统</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> camel.toolkits <span class="keyword">import</span> SearchToolkit, MathToolkit</span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.types.agents <span class="keyword">import</span> ToolCallingRecord</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境配置</span></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建模型</span></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工具包</span></span><br><span class="line">tools_list = [</span><br><span class="line">    *SearchToolkit().get_tools(),</span><br><span class="line">    *MathToolkit().get_tools()</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置任务</span></span><br><span class="line">task_prompt = (<span class="string">&quot;假设现在是2024年，牛津大学的成立年份，并计算出其当前年龄。&quot;</span></span><br><span class="line">               <span class="string">&quot;然后再将这个年龄加上10年。使用百度搜索工具。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置角色扮演</span></span><br><span class="line">role_play_session = RolePlaying(</span><br><span class="line">    assistant_role_name=<span class="string">&quot;搜索者&quot;</span>,</span><br><span class="line">    user_role_name=<span class="string">&quot;教授&quot;</span>,</span><br><span class="line">    assistant_agent_kwargs=<span class="built_in">dict</span>(model=model, tools=tools_list),</span><br><span class="line">    user_agent_kwargs=<span class="built_in">dict</span>(model=model),</span><br><span class="line">    task_prompt=task_prompt,</span><br><span class="line">    with_task_specify=<span class="literal">False</span>,</span><br><span class="line">    output_language=<span class="string">&#x27;中文&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化对话</span></span><br><span class="line">input_msg = role_play_session.init_chat()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改进的对话循环 - 添加安全机制</span></span><br><span class="line">max_turns = <span class="number">10</span></span><br><span class="line">turn_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Fore.CYAN + <span class="string">f&quot;开始执行任务: <span class="subst">&#123;task_prompt&#125;</span>\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;=&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> turn_count &lt; max_turns:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简化但必要的输出</span></span><br><span class="line">        <span class="built_in">print</span>(Fore.WHITE + <span class="string">f&quot;\n[Turn <span class="subst">&#123;turn_count + <span class="number">1</span>&#125;</span>]&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.GREEN + <span class="string">f&quot;助手: <span class="subst">&#123;assistant_response.msg.content&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(Fore.BLUE + <span class="string">f&quot;用户: <span class="subst">&#123;user_response.msg.content&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显示工具调用信息</span></span><br><span class="line">        <span class="keyword">if</span> assistant_response.info[<span class="string">&#x27;tool_calls&#x27;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(Fore.MAGENTA + <span class="string">f&quot;工具调用: <span class="subst">&#123;assistant_response.info[<span class="string">&#x27;tool_calls&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查终止条件</span></span><br><span class="line">        <span class="keyword">if</span> assistant_response.terminated <span class="keyword">or</span> user_response.terminated:</span><br><span class="line">            <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;对话终止&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> assistant_response.terminated:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;助手终止原因: <span class="subst">&#123;assistant_response.info.get(<span class="string">&#x27;termination_reasons&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> user_response.terminated:</span><br><span class="line">                <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;用户终止原因: <span class="subst">&#123;user_response.info.get(<span class="string">&#x27;termination_reasons&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查任务完成标识</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;CAMEL_TASK_DONE&quot;</span> <span class="keyword">in</span> user_response.msg.content:</span><br><span class="line">            <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;任务完成!&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">        input_msg = assistant_response.msg</span><br><span class="line">        turn_count += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(Fore.YELLOW + <span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;执行错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可通过 <code>response.info[&quot;tool_calls&quot;]</code> 查看工具调用记录，验证是否使用工具而非“编造”。</p>
</blockquote>
<p>这段代码是一个完整的 CAMEL AI 多智能体协作系统实现，以下将详细分析其功能架构和实现机制。</p>
<ol>
<li>系统架构分析<br> 1.1 核心组件结构<br> ┌─────────────────────────────────────────────────────────────┐<br> │                    CAMEL AI 多智能体系统                      │<br> ├─────────────────────────────────────────────────────────────┤<br> │  环境配置层    │ 模型工厂层  │ 工具包层  │ 角色扮演层  │ 执行控制层 │<br> │  ├─ 环境变量   │ ├─ 模型创建 │ ├─ 搜索   │ ├─ 双智能体 │ ├─ 安全机制 │<br> │  ├─ API配置   │ ├─ 平台适配 │ ├─ 计算   │ ├─ 任务分配 │ ├─ 异常处理 │<br> │  └─ 密钥管理   │ └─ 连接建立 │ └─ 工具链 │ └─ 协作模式 │ └─ 循环控制 │<br> └─────────────────────────────────────────────────────────────┘<br> 1.2 数据流向分析<br> 用户任务 → 角色扮演系统 → 智能体交互 → 工具调用 → 结果返回 → 任务完成<br>  ↓         ↓           ↓          ↓          ↓          ↓<br> 任务解析   角色分配    消息传递    功能执行    数据处理    状态更新</li>
<li>详细功能实现<br>2.1 环境配置与模型初始化</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python<span class="comment"># 环境配置层</span></span><br><span class="line">load_dotenv()</span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>模型工厂层</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>功能特点:<br>配置解耦: 使用环境变量管理敏感信息<br>平台抽象: 支持多种模型平台的统一接口<br>模型选择: 使用 Qwen2.5-72B 大模型作为推理引擎</p>
<p>2.2 工具包集成机制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pythontools_list = [</span><br><span class="line">    *SearchToolkit().get_tools(),</span><br><span class="line">    *MathToolkit().get_tools()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>工具能力分析:</p>
<p>SearchToolkit:</p>
<p>百度搜索、谷歌搜索、DuckDuckGo搜索<br>信息检索和网络查询能力</p>
<p>MathToolkit:</p>
<p>数学计算、公式求解<br>数值分析和统计计算</p>
<p>扩展性: 使用解包操作符支持动态工具添加</p>
<p>2.3 角色扮演系统设计<br>pythonrole_play_session &#x3D; RolePlaying(<br>    assistant_role_name&#x3D;”搜索者”,<br>    user_role_name&#x3D;”教授”,<br>    assistant_agent_kwargs&#x3D;dict(model&#x3D;model, tools&#x3D;tools_list),<br>    user_agent_kwargs&#x3D;dict(model&#x3D;model),<br>    task_prompt&#x3D;task_prompt,<br>    with_task_specify&#x3D;False,<br>    output_language&#x3D;’中文’<br>)<br>角色分工机制:<br>搜索者（Assistant）:<br>具备工具调用能力<br>负责信息检索和计算执行<br>主动解决问题的执行者</p>
<p>教授（User）:<br>任务分析和指导<br>结果验证和反馈<br>决策和监督角色</p>
<p>2.4 任务驱动的协作模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pythontask_prompt = (<span class="string">&quot;假设现在是2024年，牛津大学的成立年份，并计算出其当前年龄。&quot;</span></span><br><span class="line">               <span class="string">&quot;然后再将这个年龄加上10年。使用百度搜索工具。&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>任务分解策略:<br>信息获取: 搜索牛津大学成立年份<br>数据处理: 计算当前年龄 (2024 - 成立年份)<br>进一步计算: 年龄 + 10 年<br>工具约束: 明确使用百度搜索工具</p>
<ol start="3">
<li>执行控制机制<br>3.1 安全的循环控制</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pythonmax_turns = <span class="number">10</span></span><br><span class="line">turn_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> turn_count &lt; max_turns:</span><br></pre></td></tr></table></figure>
<p>安全机制:<br>轮次限制: 防止无限循环<br>计数器: 跟踪执行进度<br>资源保护: 避免资源耗尽</p>
<p>3.2 异常处理机制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pythontry:</span><br><span class="line">    assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;执行错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>错误处理策略:<br>捕获异常: 网络错误、API调用失败<br>友好提示: 彩色输出错误信息<br>优雅退出: 避免程序崩溃</p>
<p>3.3 终止条件检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python<span class="comment"># 智能体主动终止</span></span><br><span class="line"><span class="keyword">if</span> assistant_response.terminated <span class="keyword">or</span> user_response.terminated:</span><br><span class="line">    <span class="built_in">print</span>(Fore.RED + <span class="string">&quot;对话终止&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 任务完成检查</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;CAMEL_TASK_DONE&quot;</span> <span class="keyword">in</span> user_response.msg.content:</span><br><span class="line">    <span class="built_in">print</span>(Fore.GREEN + <span class="string">&quot;任务完成!&quot;</span>)</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>多重终止机制:<br>智能体终止: 基于内部逻辑判断<br>任务完成: 基于特定标识符<br>强制终止: 基于轮次限制</p>
<ol start="4">
<li>系统优势<br>4.1 架构优势<br>模块化设计: 各组件独立可替换<br>可扩展性: 支持新工具和角色的添加<br>平台无关: 支持多种模型平台</li>
</ol>
<p>4.2 功能优势<br>智能协作: 双智能体协同工作<br>工具集成: 多种工具无缝集成<br>任务导向: 明确的任务驱动机制</p>
<p>代码运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">开始执行任务: 假设现在是2024年，牛津大学的成立年份，并计算出其当前年龄。然后再将这个年龄加上10 年。使用百度搜索工具。</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line">Warning: No results found. Check if Baidu HTML structure has changed.</span><br><span class="line">Warning: No results found. Check if Baidu HTML structure has changed.</span><br><span class="line">Warning: No results found. Check if Baidu HTML structure has changed.</span><br><span class="line">Warning: No results found. Check if Baidu HTML structure has changed.</span><br><span class="line">Warning: No results found. Check if Baidu HTML structure has changed.</span><br><span class="line">Warning: No results found. Check if Baidu HTML structure has changed.</span><br><span class="line"></span><br><span class="line">[Turn 1]</span><br><span class="line">助手: 看来通过搜索引擎直接获取牛津大学的确切成立年份遇到了一些困难，因为多次尝试使用不同的关键 词组合（如“建立年份”、“创立时间”等）都没有返回有效的结果。不过，根据普遍的历史记录和教育资料， 牛津大学的成立年份通常被认为是1096年左右。这是因为牛津大学没有确切的建校日期，但有记录显示，早 在1096年就已经有了教学活动。</span><br><span class="line"></span><br><span class="line">接下来，我们可以基于这一信息继续完成任务。假设现在是2024年，我们将使用1096年作为牛津大学的成立 年份来计算其当前年龄，并在此基础上再加上10年。</span><br><span class="line"></span><br><span class="line">Solution: 首先计算牛津大学在2024年的年龄，然后将这个年龄加上10年。计算方法如下：</span><br><span class="line">1. 计算2024年时牛津大学的年龄：2024 - 1096 = 928年。</span><br><span class="line">2. 将这个年龄加上10年：928 + 10 = 938年。</span><br><span class="line"></span><br><span class="line">因此，如果现在是2024年，那么牛津大学的年龄将是928年，再加上10年后，它的年龄将是938年。</span><br><span class="line"></span><br><span class="line">Next request.</span><br><span class="line">用户: Instruction: 使用百度搜索工具查找牛津大学的成立年份。</span><br><span class="line">Input: None</span><br><span class="line">工具调用: [ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 成立年份&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: []&#125;, tool_call_id=&#x27;call_03377cb5855047779966f1&#x27;), ToolCallingRecord(tool_name=&#x27;search_google&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 成立年份&#x27;, &#x27;num_result_pages&#x27;: 1&#125;, result=[&#123;&#x27;error&#x27;: &#x27;google search failed.&#x27;&#125;], tool_call_id=&#x27;call_5e2d126b8c5c4d0ab61830&#x27;), ToolCallingRecord(tool_name=&#x27;search_bing&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 成立年份&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;snippet&#x27;: &#x27;&#x27;, &#x27;title&#x27;: &#x27;火遍全网的牛津阅读树应该怎么刷？孩子才愿意自主学习 ...&#x27;, &#x27;link&#x27;: &#x27;https://www.zhihu.com/tardis/bd/art/710913755&#x27;&#125;]&#125;, tool_call_id=&#x27;call_d0611c8f52ed40088d6f04&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 创建时间&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: []&#125;, tool_call_id=&#x27;call_1030fde3d5e5488e802e00&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 建校时间&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: []&#125;, tool_call_id=&#x27;call_d8c4ed8c89d24413abdd99&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 建立时间&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: []&#125;, tool_call_id=&#x27;call_85c1047a67004062838bd4&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 创立时间&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: []&#125;, tool_call_id=&#x27;call_3c6ad476db73499c9f3430&#x27;), ToolCallingRecord(tool_name=&#x27;search_google&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 创立时间&#x27;, &#x27;num_result_pages&#x27;: 1&#125;, result=[&#123;&#x27;error&#x27;: &#x27;google search failed.&#x27;&#125;], tool_call_id=&#x27;call_8ef4dccfd97b43a6a5b84c&#x27;), ToolCallingRecord(tool_name=&#x27;search_bing&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 创立时间&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: [&#123;&#x27;result_id&#x27;: 1, &#x27;snippet&#x27;: &#x27;&#x27;, &#x27;title&#x27;: &#x27;火遍全网的牛津阅读树应该怎么刷？孩子才愿意自主学习 ...&#x27;, &#x27;link&#x27;: &#x27;https://www.zhihu.com/tardis/bd/art/710913755&#x27;&#125;]&#125;, tool_call_id=&#x27;call_e7187dd15c614c5cb6431f&#x27;), ToolCallingRecord(tool_name=&#x27;search_baidu&#x27;, args=&#123;&#x27;query&#x27;: &#x27;牛津大学 建立年份&#x27;, &#x27;max_results&#x27;: 1&#125;, result=&#123;&#x27;results&#x27;: []&#125;, tool_call_id=&#x27;call_20a26bcda1f749b4ad1451&#x27;)]</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[Turn 2]</span><br><span class="line">助手: 尽管多次尝试通过不同的搜索引擎和关键词组合查询牛津大学的确切成立年份，但似乎无法从这些搜 索结果中直接获得准确的信息。然而，根据广泛接受的历史资料，牛津大学的成立年份通常被认定为1096年 左右。</span><br><span class="line"></span><br><span class="line">基于此信息，我们已经完成了之前的计算步骤，即假设现在是2024年，牛津大学的年龄为928年；再过10年后，它的年龄将会是938年。</span><br><span class="line"></span><br><span class="line">既然已经确认了计算结果，我们的任务可以结束了。如果您有任何其他问题或需要进一步的帮助，请随时告 诉我！</span><br><span class="line"></span><br><span class="line">任务已完成。</span><br><span class="line">用户: Instruction: 确认计算结果并结束任务。</span><br><span class="line">Input: None</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[Turn 3]</span><br><span class="line">助手: 根据维基百科的资料，牛津大学的教学活动可以追溯到1096年，这是英语世界中最古老的大学，也是 世界上持续运营的第二古老大学。因此，我们可以确认牛津大学的成立年份为1096年。</span><br><span class="line"></span><br><span class="line">按照之前的计算方法：</span><br><span class="line">1. 如果现在是2024年，牛津大学的年龄为：2024 - 1096 = 928年。</span><br><span class="line">2. 再加上10年后的年龄为：928 + 10 = 938年。</span><br><span class="line"></span><br><span class="line">任务已经完成。如果您还有其他问题或需要进一步的帮助，请告诉我！</span><br><span class="line"></span><br><span class="line">任务已完成。</span><br><span class="line">用户: CAMEL_TASK_DONE</span><br><span class="line">工具调用: [ToolCallingRecord(tool_name=&#x27;search_wiki&#x27;, args=&#123;&#x27;entity&#x27;: &#x27;牛津大学&#x27;&#125;, result=&#x27;There is no page in Wikipedia corresponding to entity 牛津大学, please specify another word to describe the entity to be searched.&#x27;, tool_call_id=&#x27;call_adbbda4b67004ea3b38de2&#x27;), ToolCallingRecord(tool_name=&#x27;search_wiki&#x27;, args=&#123;&#x27;entity&#x27;: &#x27;Oxford University&#x27;&#125;, result=&quot;The University of Oxfo任务已经完成。如果您还有其他问题或需要进一步的帮助，请告诉我！</span><br><span class="line"></span><br><span class="line">任务已完成。</span><br><span class="line">用户: CAMEL_TASK_DONE</span><br><span class="line">工具调用: [ToolCallingRecord(tool_name=&#x27;search_wiki&#x27;, args=&#123;&#x27;entity&#x27;: &#x27;牛津大学&#x27;&#125;, result=&#x27;There is no page in Wikipedia corresponding to entity 牛津大学, please specify another word to describe the entity to be searched.&#x27;, tool_call_id=&#x27;call_adbbda4b67004ea3b38de2&#x27;), ToolCallingRecord(tool_name=&#x27;search_wiki&#x27;, args=&#123;&#x27;entity&#x27;: &#x27;Oxford University&#x27;&#125;, result=&quot;The University of Oxfo工具调用: [ToolCallingRecord(tool_name=&#x27;search_wiki&#x27;, args=&#123;&#x27;entity&#x27;: &#x27;牛津大学&#x27;&#125;, result=&#x27;There is no page in Wikipedia corresponding to entity 牛津大学, please specify another word to describe the entity to be searched.&#x27;, tool_call_id=&#x27;rd is a collegiatrd is a collegiate research university in Oxford, England. There is evidence of teaching as early as 1096, making it the oldest university in the English-speaking world and the world&#x27;s second-oldest university in continuous operation.\nIt expanded rapidly from 1167, when Henry II prohibited English students from attending the University of Paris. When disputes erupted between students and the Oxford townspeople, some Oxford academics fled northeast to Cambridge, where they established the University of Cambridge in 1209. The two English ancient universities share many common features and are jointly referred to as Oxbridge.&quot;, tool_call_id=&#x27;call_4456a1825530488a804b6b&#x27;)]</span><br><span class="line">任务完成!</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/15/%E8%81%AA%E6%98%8E%E5%AD%A6python%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97%EF%BC%882%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/15/%E8%81%AA%E6%98%8E%E5%AD%A6python%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97%EF%BC%882%EF%BC%89/" class="post-title-link" itemprop="url">【Python】 第二章学习心得</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-15 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-15T00:00:00+08:00">2025-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-18 00:11:50" itemprop="dateModified" datetime="2025-07-18T00:11:50+08:00">2025-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" itemprop="url" rel="index"><span itemprop="name">学习心得</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>《聪明办法学 Python（第2版）》第二章学习心得：数据类型和操作</p>
<p>通过学习第二章“数据类型和操作”，我对 Python 中的基本数据类型、内置常量、运算符、以及表达式求值有了更深入的理解。这一章不仅强化了我对数据本质的认知，也让我意识到在编程时，数据类型和运算符的选择会直接影响程序的行为和逻辑表达。以下是我的学习体会和重点整理：</p>
<h2 id="常见内置数据类型"><a href="#常见内置数据类型" class="headerlink" title="常见内置数据类型"></a>常见内置数据类型</h2><p>Python 提供了丰富的内置数据类型，常见的包括：</p>
<ul>
<li>整数（int）</li>
<li>浮点数（float）</li>
<li>布尔值（bool）</li>
<li>字符串（str）</li>
<li>列表（list）</li>
<li>元组（tuple）</li>
<li>集合（set）</li>
<li>字典（dict）</li>
<li>复数（complex）</li>
<li>函数（function）</li>
<li>模块（module）</li>
<li>类型本身（type）</li>
</ul>
<p>示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">2</span>))           <span class="comment"># &lt;class &#x27;int&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">2.2</span>))         <span class="comment"># &lt;class &#x27;float&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">2</span> &lt; <span class="number">2.2</span>))     <span class="comment"># &lt;class &#x27;bool&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;hello&quot;</span>))     <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]))    <span class="comment"># &lt;class &#x27;list&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>特别有趣的是，Python 中“类型”本身也是一种类型，即 <code>type</code>，这反映了 Python 强大的面向对象设计理念。</p>
<h2 id="内置常量"><a href="#内置常量" class="headerlink" title="内置常量"></a>内置常量</h2><p>Python 中常见的内置常量有：</p>
<ul>
<li><code>True</code>、<code>False</code>：布尔类型常量</li>
<li><code>None</code>：表示空值</li>
<li>数学常量（通过 <code>math</code> 模块）：<ul>
<li><code>math.pi</code>：π ≈ 3.14159</li>
<li><code>math.e</code>：自然对数底 ≈ 2.71828</li>
<li><code>math.tau</code>：τ ≈ 6.28318</li>
<li><code>math.inf</code>：正无穷大</li>
</ul>
</li>
</ul>
<p>这些常数在数学运算和逻辑判断中非常常用，也大大提升了表达力。</p>
<h2 id="算术运算符和整除"><a href="#算术运算符和整除" class="headerlink" title="算术运算符和整除"></a>算术运算符和整除</h2><p>Python 支持多种运算符，包括：</p>
<ul>
<li>算术运算：<code>+ - * / // % **</code></li>
<li>比较运算：<code>&lt; &lt;= == != &gt;= &gt;</code></li>
<li>赋值运算：<code>+= -= *= //= %= **=</code></li>
<li>逻辑运算：<code>and or not</code></li>
</ul>
<p>特别需要注意：</p>
<ul>
<li><code>/</code> 表示浮点除法，结果为浮点数</li>
<li><code>//</code> 表示整除，会舍弃小数部分</li>
<li><code>%</code> 表示取余</li>
</ul>
<p>示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">5</span> / <span class="number">3</span>)   <span class="comment"># 1.666...</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">5</span> // <span class="number">3</span>)  <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(-<span class="number">4</span> // <span class="number">3</span>) <span class="comment"># -2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">5</span> % <span class="number">3</span>)   <span class="comment"># 2</span></span><br></pre></td></tr></table></figure>

<p>还学习了自定义的模运算实现方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mod</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a - (a // b) * b</span><br></pre></td></tr></table></figure>

<h2 id="运算符优先级与结合律"><a href="#运算符优先级与结合律" class="headerlink" title="运算符优先级与结合律"></a>运算符优先级与结合律</h2><p>本章强调了表达式中不同运算符的优先级，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">2</span> + <span class="number">3</span> * <span class="number">4</span>)    <span class="comment"># 14，而不是 20</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">4</span> ** <span class="number">3</span> ** <span class="number">2</span>)  <span class="comment"># 262144，而不是 4096</span></span><br></pre></td></tr></table></figure>

<p>此外，Python 中运算符具有结合律（如从左到右或从右到左），这些都对表达式求值结果有重要影响。</p>
<h2 id="类型影响运算语义"><a href="#类型影响运算语义" class="headerlink" title="类型影响运算语义"></a>类型影响运算语义</h2><p>相同的运算符在不同类型之间的运算行为可能不同：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">3</span> * <span class="number">2</span>)         <span class="comment"># 6（数值乘法）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">3</span> * <span class="string">&quot;abc&quot;</span>)     <span class="comment"># abcabcabc（字符串重复）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hi&quot;</span> + <span class="string">&quot;You&quot;</span>)  <span class="comment"># HiYou（字符串拼接）</span></span><br></pre></td></tr></table></figure>

<h2 id="浮点数误差"><a href="#浮点数误差" class="headerlink" title="浮点数误差"></a>浮点数误差</h2><p>本章还介绍了浮点数的误差问题，这是由底层二进制表示方式决定的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span> == <span class="number">0.3</span>)  <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>((<span class="number">0.1</span> + <span class="number">0.1</span> + <span class="number">0.1</span>) - <span class="number">0.3</span>) <span class="comment"># 5.551115123125783e-17（非常小的误差）</span></span><br></pre></td></tr></table></figure>

<h2 id="短路求值"><a href="#短路求值" class="headerlink" title="短路求值"></a>短路求值</h2><p>逻辑运算中会触发“短路求值”机制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">yes</span>(): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">no</span>(): <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crash</span>(): <span class="keyword">return</span> <span class="number">1</span> / <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(no() <span class="keyword">and</span> crash())  <span class="comment"># 不会报错，因为 no() 为 False</span></span><br><span class="line"><span class="built_in">print</span>(yes() <span class="keyword">or</span> crash())  <span class="comment"># 不会报错，因为 yes() 为 True</span></span><br></pre></td></tr></table></figure>

<p>这对于控制逻辑流程、避免错误非常有帮助。</p>
<h2 id="type-vs-isinstance"><a href="#type-vs-isinstance" class="headerlink" title="type() vs isinstance()"></a>type() vs isinstance()</h2><p><code>type()</code> 用于判断数据类型，但更推荐使用 <code>isinstance()</code> 来判断一个对象是否属于某个类或其子类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">isNumber</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">isinstance</span>(x, numbers.Number)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(isNumber(<span class="number">1</span>))       <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(isNumber(<span class="number">1.1</span>))     <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(isNumber(<span class="number">1</span>+<span class="number">2j</span>))    <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(isNumber(<span class="string">&quot;text&quot;</span>))  <span class="comment"># False</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本章学习，我掌握了 Python 常见的数据类型与内置运算符，理解了它们的行为及差异。在今后的编程中，我将更加注意：</p>
<ul>
<li>使用正确的类型与运算符组合</li>
<li>利用 <code>isinstance()</code> 实现更健壮的类型判断</li>
<li>理解表达式求值的过程与短路机制</li>
<li>留意浮点数计算的精度问题</li>
</ul>
<p>这为我编写更高效、可靠的 Python 程序奠定了坚实的基础。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/14/Agent_camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%881%EF%BC%89/Agent_camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Su Tang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_010001SUTANG_">
      <meta itemprop="description" content="nothing is anything">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | _010001SUTANG_">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/14/Agent_camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%881%EF%BC%89/Agent_camel%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">Agent_camel 框架学习记录（1）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-14 21:15:00" itemprop="dateCreated datePublished" datetime="2025-07-14T21:15:00+08:00">2025-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-20 23:33:51" itemprop="dateModified" datetime="2025-07-20T23:33:51+08:00">2025-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>原作者链接🔗：<a target="_blank" rel="noopener" href="https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe">https://fmhw1n4zpn.feishu.cn/docx/AF4XdOZpIo6TOaxzDK8cxInNnCe</a></p>
<p>第一章的学习内容不仅涵盖了 <strong>CAMEL 的安装与配置方法</strong>，还引导我们通过示例代码 <strong>快速上手使用 CAMEL 进行角色扮演式的 AI 对话任务</strong>。以下是对整个流程的总结、对 CAMEL 框架工作方式的理解，以及我的一些思考：</p>
<hr>
<h2 id="一、CAMEL-框架的工作机制简析"><a href="#一、CAMEL-框架的工作机制简析" class="headerlink" title="一、CAMEL 框架的工作机制简析"></a>一、CAMEL 框架的工作机制简析</h2><p>CAMEL（Communicative Agents for Mind Exploration of Large Language models）核心理念是：<strong>通过 AI 用户（User）和 AI 助手（Assistant）之间的对话与协作，引导大语言模型逐步完成复杂任务。</strong></p>
<h3 id="1-关键组件和核心流程"><a href="#1-关键组件和核心流程" class="headerlink" title="1. 关键组件和核心流程"></a>1. 关键组件和核心流程</h3><p>在 <code>RolePlaying</code> 模块中：</p>
<ul>
<li><code>user_role_name</code>：模拟一个具备任务上下文理解的角色（如“股票交易员”），负责“指导”任务的推进；</li>
<li><code>assistant_role_name</code>：作为具体的执行者（如“Python 程序员”），接收指令并产出内容；</li>
<li><code>task_prompt</code>：提供一个初始任务目标（如“为股票市场开发一个交易机器人”）；</li>
<li><code>with_task_specify=True</code>：引导用户角色先对任务进行细化，再交由助手执行；</li>
<li><code>chat_turn_limit</code>：限制对话轮数；</li>
<li><code>output_language</code>：指定语言输出，有助于多语种任务适配。</li>
</ul>
<h3 id="2-模型封装与调用"><a href="#2-模型封装与调用" class="headerlink" title="2. 模型封装与调用"></a>2. 模型封装与调用</h3><p>通过 <code>ModelFactory.create(...)</code> 封装第三方模型（如 Qwen2.5-72B），兼容 OpenAI API 格式，这样可以：</p>
<ul>
<li>与 CAMEL 保持无缝对接；</li>
<li>快速切换不同模型（如 DeepSeek、ZhipuAI、百川等）；</li>
<li>无需修改 CAMEL 源码。</li>
</ul>
<hr>
<h2 id="二、执行结果观察与体验体会"><a href="#二、执行结果观察与体验体会" class="headerlink" title="二、执行结果观察与体验体会"></a>二、执行结果观察与体验体会</h2><p>执行 <code>role_playing.py</code> 示例脚本后，可以观察到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.utils <span class="keyword">import</span> print_text_animated</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">load_dotenv(dotenv_path=<span class="string">&#x27;.env&#x27;</span>)</span><br><span class="line"></span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;Qwen/Qwen2.5-72B-Instruct&quot;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://api-inference.modelscope.cn/v1/&#x27;</span>,</span><br><span class="line">    api_key=api_key</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">model=model, chat_turn_limit=<span class="number">50</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    task_prompt = <span class="string">&quot;为股票市场开发一个交易机器人&quot;</span><span class="comment">#设置任务目标</span></span><br><span class="line">    role_play_session = RolePlaying(</span><br><span class="line">        assistant_role_name=<span class="string">&quot;Python 程序员&quot;</span>,<span class="comment">#设置AI助手角色名</span></span><br><span class="line">        assistant_agent_kwargs=<span class="built_in">dict</span>(model=model),</span><br><span class="line">        user_role_name=<span class="string">&quot;股票交易员&quot;</span>,<span class="comment">#设置用户角色名，在roleplay中，user用于指导AI助手完成任务</span></span><br><span class="line">        user_agent_kwargs=<span class="built_in">dict</span>(model=model),</span><br><span class="line">        task_prompt=task_prompt,</span><br><span class="line">        with_task_specify=<span class="literal">True</span>,</span><br><span class="line">        task_specify_agent_kwargs=<span class="built_in">dict</span>(model=model),</span><br><span class="line">        output_language=<span class="string">&#x27;中文&#x27;</span><span class="comment">#设置输出语言</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        Fore.GREEN</span><br><span class="line">        + <span class="string">f&quot;AI 助手系统消息:\n<span class="subst">&#123;role_play_session.assistant_sys_msg&#125;</span>\n&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        Fore.BLUE + <span class="string">f&quot;AI 用户系统消息:\n<span class="subst">&#123;role_play_session.user_sys_msg&#125;</span>\n&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;原始任务提示:\n<span class="subst">&#123;task_prompt&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        Fore.CYAN</span><br><span class="line">        + <span class="string">&quot;指定的任务提示:&quot;</span></span><br><span class="line">        + <span class="string">f&quot;\n<span class="subst">&#123;role_play_session.specified_task_prompt&#125;</span>\n&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;最终任务提示:\n<span class="subst">&#123;role_play_session.task_prompt&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    input_msg = role_play_session.init_chat()</span><br><span class="line">    <span class="keyword">while</span> n &lt; chat_turn_limit:</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> assistant_response.terminated:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                Fore.GREEN</span><br><span class="line">                + (</span><br><span class="line">                    <span class="string">&quot;AI 助手已终止。原因: &quot;</span></span><br><span class="line">                    <span class="string">f&quot;<span class="subst">&#123;assistant_response.info[<span class="string">&#x27;termination_reasons&#x27;</span>]&#125;</span>.&quot;</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> user_response.terminated:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                Fore.GREEN</span><br><span class="line">                + (</span><br><span class="line">                    <span class="string">&quot;AI 用户已终止。&quot;</span></span><br><span class="line">                    <span class="string">f&quot;原因: <span class="subst">&#123;user_response.info[<span class="string">&#x27;termination_reasons&#x27;</span>]&#125;</span>.&quot;</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        print_text_animated(</span><br><span class="line">            Fore.BLUE + <span class="string">f&quot;AI 用户:\n\n<span class="subst">&#123;user_response.msg.content&#125;</span>\n&quot;</span></span><br><span class="line">        )</span><br><span class="line">        print_text_animated(</span><br><span class="line">            Fore.GREEN + <span class="string">&quot;AI 助手:\n\n&quot;</span></span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;assistant_response.msg.content&#125;</span>\n&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;CAMEL_TASK_DONE&quot;</span> <span class="keyword">in</span> user_response.msg.content:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        input_msg = assistant_response.msg</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/%E8%B4%A7%E5%B8%81%E4%BA%A4%E6%98%93%E5%88%9D%E5%A7%8B.png" alt="货币交易初始"></p>
<p><img src="/%E8%B4%A7%E5%B8%81%E5%AF%B9%E8%AF%9D%E8%B5%B7%E5%A7%8B.png" alt="货币对话起始"></p>
<ul>
<li><p><strong>系统初始化提示</strong>（角色系统消息、原始任务、细化任务等）；</p>
</li>
<li><p><strong>AI User 与 AI Assistant 的反复对话与任务细化</strong>；</p>
</li>
<li><p>AI 最终给出完整的开发方案或者代码实现。</p>
<p><img src="/%E8%B4%A7%E5%B8%81%E5%AF%B9%E8%AF%9D.png" alt="货币对话"></p>
</li>
</ul>
<p>这与传统的“单轮问答”式调用大模型完全不同，<strong>更像是一次深入交流和协同开发的过程</strong>。</p>
<hr>
<h2 id="三、思考与理解"><a href="#三、思考与理解" class="headerlink" title="三、思考与理解"></a>三、思考与理解</h2><h3 id="1-多智能体协作式推理框架"><a href="#1-多智能体协作式推理框架" class="headerlink" title="1. 多智能体协作式推理框架"></a>1. 多智能体协作式推理框架</h3><p>CAMEL 把复杂问题“交由两个大模型互相扮演不同角色”，通过协商、拆解、执行，<strong>模拟现实中人类之间合作式问题求解的过程</strong>。这是它与普通LLM调用的最大不同。</p>
<blockquote>
<p>比如传统做法可能只是 <code>“请你开发一个交易机器人”</code>，而 CAMEL 会一步步拆解：</p>
<ul>
<li>“这个机器人该有哪些功能？”</li>
<li>“我们要用什么语言？”</li>
<li>“能不能给出一个伪代码？”</li>
<li>最终：产出具体代码。</li>
</ul>
</blockquote>
<h3 id="2-角色扮演机制的强大灵活性"><a href="#2-角色扮演机制的强大灵活性" class="headerlink" title="2. 角色扮演机制的强大灵活性"></a>2. 角色扮演机制的强大灵活性</h3><p><code>RolePlaying</code> 机制可以自由定义“用户”和“助手”的角色身份、背景知识、行为习惯等，带来极大的可控性和扩展性。</p>
<p><strong>例如：</strong><br> 你可以设置如下对话场景：</p>
<ul>
<li>用户：医疗顾问</li>
<li>助手：Python 数据分析师</li>
<li>任务：分析一组临床数据并生成健康报告</li>
</ul>
<p>完全可以被 CAMEL 承载并推进。</p>
<h3 id="3-与本地模型无缝融合"><a href="#3-与本地模型无缝融合" class="headerlink" title="3. 与本地模型无缝融合"></a>3. 与本地模型无缝融合</h3><p>CAMEL 并不依赖 OpenAI 官方模型。你可以自由选择：</p>
<ul>
<li><strong>云端模型 API</strong>：如 ModelScope（Qwen、DeepSeek）、智谱AI等；</li>
<li><strong>本地部署模型</strong>：如 llama.cpp、ollama、vLLM 等；</li>
<li>使用 <code>.env</code> 文件或代码中手动传参，完成集成。</li>
</ul>
<p>这一点极大降低了 CAMEL 的使用门槛，尤其适合注重数据隐私或成本控制的开发者。</p>
<hr>
<h2 id="四、可以尝试深入探索的方向"><a href="#四、可以尝试深入探索的方向" class="headerlink" title="四、可以尝试深入探索的方向"></a>四、可以尝试深入探索的方向</h2><table>
<thead>
<tr>
<th>探索方向</th>
<th>推荐做法</th>
</tr>
</thead>
<tbody><tr>
<td><strong>角色设定自由化</strong></td>
<td>修改 <code>user_role_name</code> 和 <code>assistant_role_name</code>，体验不同角色组合带来的对话差异</td>
</tr>
<tr>
<td><strong>输出语言切换</strong></td>
<td>修改 <code>output_language=&#39;English&#39;</code> 等多语言设定</td>
</tr>
<tr>
<td><strong>接入其他模型</strong></td>
<td>如 DeepSeek、Baichuan、Yi 等，通过修改 <code>model_type</code> 和 <code>url</code> 实现</td>
</tr>
<tr>
<td><strong>ChatAgent 更细粒度控制</strong></td>
<td>使用 <code>ChatAgent</code> 进行更精细化 prompt 构造</td>
</tr>
<tr>
<td><strong>封装为 API 服务</strong></td>
<td>将 <code>role_playing.py</code> 封装成一个可调 API，实现任务自动化</td>
</tr>
</tbody></table>
<h2 id="五、更多探索"><a href="#五、更多探索" class="headerlink" title="五、更多探索"></a>五、更多探索</h2><p>重新修改role_playing.py中的task_prompt、assistant_role_name及user_role_name部分：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> colorama <span class="keyword">import</span> Fore</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> camel.societies <span class="keyword">import</span> RolePlaying</span><br><span class="line"><span class="keyword">from</span> camel.utils <span class="keyword">import</span> print_text_animated</span><br><span class="line"><span class="keyword">from</span> camel.models <span class="keyword">import</span> ModelFactory</span><br><span class="line"><span class="keyword">from</span> camel.types <span class="keyword">import</span> ModelPlatformType</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">load_dotenv(dotenv_path=<span class="string">&#x27;.env&#x27;</span>)</span><br><span class="line"></span><br><span class="line">api_key = os.getenv(<span class="string">&#x27;MODELSCOPE_SDK_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line">model = ModelFactory.create(</span><br><span class="line">    model_platform=ModelPlatformType.OPENAI_COMPATIBLE_MODEL,</span><br><span class="line">    model_type=<span class="string">&quot;deepseek-ai/DeepSeek-R1-0528&quot;</span>,</span><br><span class="line">    api_key=api_key,</span><br><span class="line">    url=os.environ.get(<span class="string">&quot;OPENAI_COMPATIBILIY_API_BASE_URL&quot;</span>, <span class="string">&quot;https://api-inference.modelscope.cn/v1/&quot;</span>),  <span class="comment"># 环境变量优先，不存在则使用默认值</span></span><br><span class="line">    <span class="comment"># 新增模型参数配置</span></span><br><span class="line">    model_config_dict=&#123;<span class="string">&quot;temperature&quot;</span>: <span class="number">0.3</span>, <span class="string">&quot;max_tokens&quot;</span>: <span class="number">2048</span>,<span class="string">&quot;top_p&quot;</span>:<span class="number">0.9</span>&#125;,<span class="comment"># 降低随机性  # 限制响应长度</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">model=model, chat_turn_limit=<span class="number">50</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    task_prompt = <span class="string">&quot;为学前教育开发一个机器人教师&quot;</span><span class="comment">#设置任务目标</span></span><br><span class="line"></span><br><span class="line">    role_play_session = RolePlaying(</span><br><span class="line">        assistant_role_name=<span class="string">&quot;你是一位精通教育科技的Python专家&quot;</span>,<span class="comment">#设置AI助手角色名</span></span><br><span class="line">        assistant_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">            model=model</span><br><span class="line">            ),</span><br><span class="line"></span><br><span class="line">        user_role_name=<span class="string">&quot;你是一位有10年经验的学前教育专家&quot;</span> ,<span class="comment">#设置用户角色名，在roleplay中，user用于指导AI助手完成任务</span></span><br><span class="line">        user_agent_kwargs=<span class="built_in">dict</span>(</span><br><span class="line">            model=model</span><br><span class="line">        ),</span><br><span class="line">        task_prompt=task_prompt,</span><br><span class="line">        with_task_specify=<span class="literal">True</span>,</span><br><span class="line">        task_specify_agent_kwargs=<span class="built_in">dict</span>(model=model),</span><br><span class="line">        output_language=<span class="string">&#x27;中文&#x27;</span>  <span class="comment">#设置输出语言</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        Fore.GREEN</span><br><span class="line">        + <span class="string">f&quot;AI 助手系统消息:\n<span class="subst">&#123;role_play_session.assistant_sys_msg&#125;</span>\n&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        Fore.BLUE + <span class="string">f&quot;AI 用户系统消息:\n<span class="subst">&#123;role_play_session.user_sys_msg&#125;</span>\n&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(Fore.YELLOW + <span class="string">f&quot;原始任务提示:\n<span class="subst">&#123;task_prompt&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        Fore.CYAN</span><br><span class="line">        + <span class="string">&quot;指定的任务提示:&quot;</span></span><br><span class="line">        + <span class="string">f&quot;\n<span class="subst">&#123;role_play_session.specified_task_prompt&#125;</span>\n&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(Fore.RED + <span class="string">f&quot;最终任务提示:\n<span class="subst">&#123;role_play_session.task_prompt&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    input_msg = role_play_session.init_chat()</span><br><span class="line">    <span class="keyword">while</span> n &lt; chat_turn_limit:</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        assistant_response, user_response = role_play_session.step(input_msg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> assistant_response.terminated:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                Fore.GREEN</span><br><span class="line">                + (</span><br><span class="line">                    <span class="string">&quot;AI 助手已终止。原因: &quot;</span></span><br><span class="line">                    <span class="string">f&quot;<span class="subst">&#123;assistant_response.info[<span class="string">&#x27;termination_reasons&#x27;</span>]&#125;</span>.&quot;</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> user_response.terminated:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                Fore.GREEN</span><br><span class="line">                + (</span><br><span class="line">                    <span class="string">&quot;AI 用户已终止。&quot;</span></span><br><span class="line">                    <span class="string">f&quot;原因: <span class="subst">&#123;user_response.info[<span class="string">&#x27;termination_reasons&#x27;</span>]&#125;</span>.&quot;</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        print_text_animated(</span><br><span class="line">            Fore.BLUE + <span class="string">f&quot;AI 用户:\n\n<span class="subst">&#123;user_response.msg.content&#125;</span>\n&quot;</span></span><br><span class="line">        )</span><br><span class="line">        print_text_animated(</span><br><span class="line">            Fore.GREEN + <span class="string">&quot;AI 助手:\n\n&quot;</span></span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;assistant_response.msg.content&#125;</span>\n&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;CAMEL_TASK_DONE&quot;</span> <span class="keyword">in</span> user_response.msg.content:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        input_msg = assistant_response.msg</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>运行结果如下所示：</p>
<p><img src="/%E5%AD%A6%E5%89%8D%E6%95%99%E8%82%B2%E5%88%9D%E5%A7%8B.png" alt="学前教育初始"></p>
<p>我们可以看到AI助手角色以及AI用户角色发生了变化，相应的他们的对话内容也根据他们角色定位而改变。</p>
<p><img src="/%E5%AD%A6%E5%89%8D%E5%AF%B9%E8%AF%9D%E8%B5%B7%E5%A7%8B.png" alt="学前对话起始"></p>
<p>同时AI助手也开始根据AI用户提出的具体需求而进一步完善系统。</p>
<p><img src="/%E5%AD%A6%E5%89%8D%E5%AF%B9%E8%AF%9D.png" alt="学前对话"></p>
<p>AI助手在完成AI用户提出的初步需求后，AI用户基于已完成的内容再提出更高的需求，AI助手继续根据AI用户的需求完善系统，以此循环往复……</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Su Tang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
